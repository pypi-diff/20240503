# Comparing `tmp/skypilot_nightly-1.0.0.dev20240501.tar.gz` & `tmp/skypilot_nightly-1.0.0.dev20240502.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "skypilot_nightly-1.0.0.dev20240501.tar", last modified: Wed May  1 10:39:00 2024, max compression
+gzip compressed data, was "skypilot_nightly-1.0.0.dev20240502.tar", last modified: Thu May  2 10:38:07 2024, max compression
```

## Comparing `skypilot_nightly-1.0.0.dev20240501.tar` & `skypilot_nightly-1.0.0.dev20240502.tar`

### file list

```diff
@@ -1,338 +1,338 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.944574 skypilot_nightly-1.0.0.dev20240501/
--rw-r--r--   0 runner    (1001) docker     (127)    12170 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    18140 2024-05-01 10:39:00.940575 skypilot_nightly-1.0.0.dev20240501/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)    12079 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/README.md
--rw-r--r--   0 runner    (1001) docker     (127)      640 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-01 10:39:00.944574 skypilot_nightly-1.0.0.dev20240501/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (127)    12055 2024-05-01 10:38:58.000000 skypilot_nightly-1.0.0.dev20240501/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.876574 skypilot_nightly-1.0.0.dev20240501/sky/
--rw-r--r--   0 runner    (1001) docker     (127)     5588 2024-05-01 10:39:00.000000 skypilot_nightly-1.0.0.dev20240501/sky/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.880574 skypilot_nightly-1.0.0.dev20240501/sky/adaptors/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/adaptors/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     6863 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/adaptors/aws.py
--rw-r--r--   0 runner    (1001) docker     (127)     2291 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/adaptors/azure.py
--rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/adaptors/cloudflare.py
--rw-r--r--   0 runner    (1001) docker     (127)     2354 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/adaptors/common.py
--rw-r--r--   0 runner    (1001) docker     (127)      239 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/adaptors/cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)      468 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/adaptors/docker.py
--rw-r--r--   0 runner    (1001) docker     (127)     3097 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/adaptors/gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)     4906 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/adaptors/ibm.py
--rw-r--r--   0 runner    (1001) docker     (127)     3875 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/adaptors/kubernetes.py
--rw-r--r--   0 runner    (1001) docker     (127)     1480 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/adaptors/oci.py
--rw-r--r--   0 runner    (1001) docker     (127)      225 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/adaptors/runpod.py
--rw-r--r--   0 runner    (1001) docker     (127)     2129 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/adaptors/vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)    21410 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/authentication.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.880574 skypilot_nightly-1.0.0.dev20240501/sky/backends/
--rw-r--r--   0 runner    (1001) docker     (127)      536 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/backends/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     5932 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/backends/backend.py
--rw-r--r--   0 runner    (1001) docker     (127)   118820 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/backends/backend_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)   223223 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/backends/cloud_vm_ray_backend.py
--rw-r--r--   0 runner    (1001) docker     (127)     8358 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/backends/docker_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    16741 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/backends/local_docker_backend.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.880574 skypilot_nightly-1.0.0.dev20240501/sky/backends/monkey_patches/
--rw-r--r--   0 runner    (1001) docker     (127)     3450 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/backends/monkey_patches/monkey_patch_ray_up.py
--rw-r--r--   0 runner    (1001) docker     (127)     7297 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/backends/wheel_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.880574 skypilot_nightly-1.0.0.dev20240501/sky/benchmark/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/benchmark/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     8723 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/benchmark/benchmark_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    26440 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/benchmark/benchmark_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     5908 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/check.py
--rw-r--r--   0 runner    (1001) docker     (127)   186846 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/cli.py
--rw-r--r--   0 runner    (1001) docker     (127)    11806 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/cloud_stores.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.884574 skypilot_nightly-1.0.0.dev20240501/sky/clouds/
--rw-r--r--   0 runner    (1001) docker     (127)     1310 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    43129 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/aws.py
--rw-r--r--   0 runner    (1001) docker     (127)    31006 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/azure.py
--rw-r--r--   0 runner    (1001) docker     (127)    30820 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)      955 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/cloud_registry.py
--rw-r--r--   0 runner    (1001) docker     (127)    12036 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)    12647 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/fluidstack.py
--rw-r--r--   0 runner    (1001) docker     (127)    46901 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)    21044 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/ibm.py
--rw-r--r--   0 runner    (1001) docker     (127)    17186 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/kubernetes.py
--rw-r--r--   0 runner    (1001) docker     (127)    12157 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/lambda_cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)    25299 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/oci.py
--rw-r--r--   0 runner    (1001) docker     (127)    10561 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/paperspace.py
--rw-r--r--   0 runner    (1001) docker     (127)    11166 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/runpod.py
--rw-r--r--   0 runner    (1001) docker     (127)    15546 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/scp.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.888574 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/
--rw-r--r--   0 runner    (1001) docker     (127)    12771 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    12550 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/aws_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     7289 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/azure_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)    26837 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/common.py
--rw-r--r--   0 runner    (1001) docker     (127)     1793 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      411 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)     4335 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/cudo_catalog.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.888574 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/data_fetchers/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/data_fetchers/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    22424 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
--rw-r--r--   0 runner    (1001) docker     (127)    11477 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
--rw-r--r--   0 runner    (1001) docker     (127)     5072 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)     3895 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py
--rw-r--r--   0 runner    (1001) docker     (127)    22243 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)     4297 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)    21462 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)     5038 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/fluidstack_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)    24120 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/gcp_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4472 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/ibm_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4240 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/kubernetes_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     5082 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/lambda_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/oci_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     3768 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/paperspace_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4184 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/runpod_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     5174 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/scp_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4391 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/vsphere_catalog.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.892574 skypilot_nightly-1.0.0.dev20240501/sky/clouds/utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     6968 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/utils/gcp_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     9991 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/utils/lambda_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     4482 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/utils/oci_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    15781 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/utils/scp_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    11969 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/clouds/vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)    32991 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/core.py
--rw-r--r--   0 runner    (1001) docker     (127)     2529 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/dag.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.892574 skypilot_nightly-1.0.0.dev20240501/sky/data/
--rw-r--r--   0 runner    (1001) docker     (127)      184 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/data/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7346 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/data/data_transfer.py
--rw-r--r--   0 runner    (1001) docker     (127)    21664 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/data/data_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     8226 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/data/mounting_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)   118872 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/data/storage.py
--rw-r--r--   0 runner    (1001) docker     (127)     6867 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/data/storage_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     8213 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/exceptions.py
--rw-r--r--   0 runner    (1001) docker     (127)    24916 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/execution.py
--rw-r--r--   0 runner    (1001) docker     (127)    28681 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/global_user_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    54101 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/optimizer.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.892574 skypilot_nightly-1.0.0.dev20240501/sky/provision/
--rw-r--r--   0 runner    (1001) docker     (127)     4907 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.892574 skypilot_nightly-1.0.0.dev20240501/sky/provision/aws/
--rw-r--r--   0 runner    (1001) docker     (127)      782 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/aws/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    22092 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/aws/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    36603 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/aws/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     3238 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/aws/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.896574 skypilot_nightly-1.0.0.dev20240501/sky/provision/azure/
--rw-r--r--   0 runner    (1001) docker     (127)      199 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/azure/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4398 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/azure/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     8561 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/common.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.896574 skypilot_nightly-1.0.0.dev20240501/sky/provision/cudo/
--rw-r--r--   0 runner    (1001) docker     (127)      676 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/cudo/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      327 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/cudo/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      696 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/cudo/cudo_machine_type.py
--rw-r--r--   0 runner    (1001) docker     (127)     4046 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/cudo/cudo_wrapper.py
--rw-r--r--   0 runner    (1001) docker     (127)     8202 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/cudo/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    16782 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/docker_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.896574 skypilot_nightly-1.0.0.dev20240501/sky/provision/fluidstack/
--rw-r--r--   0 runner    (1001) docker     (127)      592 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/fluidstack/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      326 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/fluidstack/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     8262 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/fluidstack/fluidstack_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    14870 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/fluidstack/instance.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.896574 skypilot_nightly-1.0.0.dev20240501/sky/provision/gcp/
--rw-r--r--   0 runner    (1001) docker     (127)      579 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/gcp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    32964 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/gcp/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     7234 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/gcp/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    24482 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/gcp/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    59069 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/gcp/instance_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    22258 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/instance_setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.896574 skypilot_nightly-1.0.0.dev20240501/sky/provision/kubernetes/
--rw-r--r--   0 runner    (1001) docker     (127)      653 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/kubernetes/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    17388 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/kubernetes/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    32523 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/kubernetes/instance.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.900574 skypilot_nightly-1.0.0.dev20240501/sky/provision/kubernetes/manifests/
--rw-r--r--   0 runner    (1001) docker     (127)      229 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/kubernetes/manifests/smarter-device-manager-configmap.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     1939 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     9457 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/kubernetes/network.py
--rw-r--r--   0 runner    (1001) docker     (127)     8635 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/kubernetes/network_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    54541 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/kubernetes/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2103 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/logging.py
--rw-r--r--   0 runner    (1001) docker     (127)     4013 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/metadata_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.900574 skypilot_nightly-1.0.0.dev20240501/sky/provision/paperspace/
--rw-r--r--   0 runner    (1001) docker     (127)      598 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/paperspace/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1541 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/paperspace/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      553 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/paperspace/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    11985 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/paperspace/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     9428 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/paperspace/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    25255 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/provisioner.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.900574 skypilot_nightly-1.0.0.dev20240501/sky/provision/runpod/
--rw-r--r--   0 runner    (1001) docker     (127)      502 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/runpod/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      321 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/runpod/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     7849 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/runpod/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     4648 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/runpod/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.900574 skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/
--rw-r--r--   0 runner    (1001) docker     (127)      788 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.904574 skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/common/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/common/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4167 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/common/cls_api_client.py
--rw-r--r--   0 runner    (1001) docker     (127)    14096 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/common/cls_api_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)      481 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/common/custom_script.py
--rw-r--r--   0 runner    (1001) docker     (127)      303 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/common/id_generator.py
--rw-r--r--   0 runner    (1001) docker     (127)      914 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/common/metadata_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1817 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/common/service_manager.py
--rw-r--r--   0 runner    (1001) docker     (127)      544 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/common/service_manager_factory.py
--rw-r--r--   0 runner    (1001) docker     (127)      795 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/common/ssl_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)     2932 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/common/vapiconnect.py
--rw-r--r--   0 runner    (1001) docker     (127)    17877 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/common/vim_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      504 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    24476 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    15151 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/vsphere_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    61936 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/resources.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.904574 skypilot_nightly-1.0.0.dev20240501/sky/serve/
--rw-r--r--   0 runner    (1001) docker     (127)     1661 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/serve/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    30137 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/serve/autoscalers.py
--rw-r--r--   0 runner    (1001) docker     (127)     3732 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/serve/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)     7571 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/serve/controller.py
--rw-r--r--   0 runner    (1001) docker     (127)    28185 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/serve/core.py
--rw-r--r--   0 runner    (1001) docker     (127)     4689 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/serve/load_balancer.py
--rw-r--r--   0 runner    (1001) docker     (127)     2047 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/serve/load_balancing_policies.py
--rw-r--r--   0 runner    (1001) docker     (127)    55738 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/serve/replica_managers.py
--rw-r--r--   0 runner    (1001) docker     (127)    18830 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/serve/serve_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    36837 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/serve/serve_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    10931 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/serve/service.py
--rw-r--r--   0 runner    (1001) docker     (127)    13803 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/serve/service_spec.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.904574 skypilot_nightly-1.0.0.dev20240501/sky/setup_files/
--rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/setup_files/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    12055 2024-05-01 10:38:58.000000 skypilot_nightly-1.0.0.dev20240501/sky/setup_files/setup.py
--rw-r--r--   0 runner    (1001) docker     (127)     4000 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/sky_logging.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.908574 skypilot_nightly-1.0.0.dev20240501/sky/skylet/
--rw-r--r--   0 runner    (1001) docker     (127)    12381 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1963 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/attempt_skylet.py
--rw-r--r--   0 runner    (1001) docker     (127)     4293 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/autostop_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)     1887 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/configs.py
--rw-r--r--   0 runner    (1001) docker     (127)     9964 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    11564 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/events.py
--rw-r--r--   0 runner    (1001) docker     (127)    35167 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/job_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)    18788 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/log_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)     4292 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/log_lib.pyi
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.908574 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.908574 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/azure/
--rw-r--r--   0 runner    (1001) docker     (127)       97 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/azure/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4344 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/azure/azure-config-template.json
--rw-r--r--   0 runner    (1001) docker     (127)    10901 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/azure/azure-vm-template.json
--rw-r--r--   0 runner    (1001) docker     (127)     6203 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/azure/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    18812 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/azure/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)    16355 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/command_runner.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.912574 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/ibm/
--rw-r--r--   0 runner    (1001) docker     (127)       94 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/ibm/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    38280 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/ibm/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)     1292 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/ibm/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    34630 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/ibm/vpc_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.912574 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/lambda_cloud/
--rw-r--r--   0 runner    (1001) docker     (127)      112 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/lambda_cloud/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    13992 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/lambda_cloud/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.912574 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/oci/
--rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/oci/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    20492 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/oci/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)    17202 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/oci/query_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)      508 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/oci/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.912574 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/scp/
--rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/scp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4683 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/scp/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    22411 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/scp/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.912574 skypilot_nightly-1.0.0.dev20240501/sky/skylet/ray_patches/
--rw-r--r--   0 runner    (1001) docker     (127)     2761 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/ray_patches/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/ray_patches/autoscaler.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      349 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/ray_patches/cli.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      224 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/ray_patches/command_runner.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      531 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/ray_patches/log_monitor.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      658 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      289 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/ray_patches/updater.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      565 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/ray_patches/worker.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)     1144 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/skylet.py
--rw-r--r--   0 runner    (1001) docker     (127)     1348 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skylet/subprocess_daemon.py
--rw-r--r--   0 runner    (1001) docker     (127)     5586 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/skypilot_config.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.916574 skypilot_nightly-1.0.0.dev20240501/sky/spot/
--rw-r--r--   0 runner    (1001) docker     (127)     1561 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/spot/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1117 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/spot/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    25830 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/spot/controller.py
--rw-r--r--   0 runner    (1001) docker     (127)    13078 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/spot/core.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.916574 skypilot_nightly-1.0.0.dev20240501/sky/spot/dashboard/
--rw-r--r--   0 runner    (1001) docker     (127)     2294 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/spot/dashboard/dashboard.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.916574 skypilot_nightly-1.0.0.dev20240501/sky/spot/dashboard/static/
--rw-r--r--   0 runner    (1001) docker     (127)    15086 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/spot/dashboard/static/favicon.ico
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.916574 skypilot_nightly-1.0.0.dev20240501/sky/spot/dashboard/templates/
--rw-r--r--   0 runner    (1001) docker     (127)     6247 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/spot/dashboard/templates/index.html
--rw-r--r--   0 runner    (1001) docker     (127)    25656 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/spot/recovery_strategy.py
--rw-r--r--   0 runner    (1001) docker     (127)    22487 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/spot/spot_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    31559 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/spot/spot_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1457 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/status_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)    47239 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/task.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.920574 skypilot_nightly-1.0.0.dev20240501/sky/templates/
--rw-r--r--   0 runner    (1001) docker     (127)     7295 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/templates/aws-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     9037 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/templates/azure-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3435 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/templates/cudo-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3465 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/templates/fluidstack-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     8879 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/templates/gcp-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     6607 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/templates/ibm-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1095 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/templates/kubernetes-ingress.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)      376 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/templates/kubernetes-loadbalancer.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     2547 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/templates/kubernetes-port-forward-proxy-command.sh.j2
--rw-r--r--   0 runner    (1001) docker     (127)    10858 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/templates/kubernetes-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     2747 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/templates/kubernetes-ssh-jump.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     5676 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/templates/lambda-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1185 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/templates/local-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     6970 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/templates/oci-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3898 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/templates/paperspace-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3496 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/templates/runpod-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     5546 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/templates/scp-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1148 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/templates/sky-serve-controller.yaml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1218 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/templates/spot-controller.yaml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3474 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/templates/vsphere-ray.yml.j2
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.920574 skypilot_nightly-1.0.0.dev20240501/sky/usage/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/usage/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      590 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/usage/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    17601 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/usage/usage_lib.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.924574 skypilot_nightly-1.0.0.dev20240501/sky/utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     3798 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/accelerator_registry.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.924574 skypilot_nightly-1.0.0.dev20240501/sky/utils/cli_utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/cli_utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    11032 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/cli_utils/status_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      849 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/cluster_yaml_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    18805 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/command_runner.py
--rw-r--r--   0 runner    (1001) docker     (127)     3485 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/command_runner.pyi
--rw-r--r--   0 runner    (1001) docker     (127)    22547 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/common_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    28619 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/controller_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     6260 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/dag_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2786 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/db_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      852 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/env_options.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.924574 skypilot_nightly-1.0.0.dev20240501/sky/utils/kubernetes/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/kubernetes/__init__.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     9667 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/kubernetes/create_cluster.sh
--rwxr-xr-x   0 runner    (1001) docker     (127)      927 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/kubernetes/delete_cluster.sh
--rw-r--r--   0 runner    (1001) docker     (127)     3187 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/kubernetes/generate_kind_config.py
--rw-r--r--   0 runner    (1001) docker     (127)     6960 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/kubernetes/gpu_labeler.py
--rw-r--r--   0 runner    (1001) docker     (127)     1186 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     3812 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     6560 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py
--rw-r--r--   0 runner    (1001) docker     (127)     1173 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/kubernetes_enums.py
--rw-r--r--   0 runner    (1001) docker     (127)     8139 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/log_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     5540 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/resources_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1581 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/rich_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    19133 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/schemas.py
--rw-r--r--   0 runner    (1001) docker     (127)     6509 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/subprocess_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     3936 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/timeline.py
--rw-r--r--   0 runner    (1001) docker     (127)     3264 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/ux_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      701 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/sky/utils/validator.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.932574 skypilot_nightly-1.0.0.dev20240501/skypilot_nightly.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)    18140 2024-05-01 10:39:00.000000 skypilot_nightly-1.0.0.dev20240501/skypilot_nightly.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     9308 2024-05-01 10:39:00.000000 skypilot_nightly-1.0.0.dev20240501/skypilot_nightly.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-01 10:39:00.000000 skypilot_nightly-1.0.0.dev20240501/skypilot_nightly.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)       36 2024-05-01 10:39:00.000000 skypilot_nightly-1.0.0.dev20240501/skypilot_nightly.egg-info/entry_points.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2270 2024-05-01 10:39:00.000000 skypilot_nightly-1.0.0.dev20240501/skypilot_nightly.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (127)        4 2024-05-01 10:39:00.000000 skypilot_nightly-1.0.0.dev20240501/skypilot_nightly.egg-info/top_level.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-01 10:39:00.928574 skypilot_nightly-1.0.0.dev20240501/tests/
--rw-r--r--   0 runner    (1001) docker     (127)      171 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/tests/test_api.py
--rw-r--r--   0 runner    (1001) docker     (127)     3618 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/tests/test_cli.py
--rw-r--r--   0 runner    (1001) docker     (127)     9599 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/tests/test_config.py
--rw-r--r--   0 runner    (1001) docker     (127)      267 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/tests/test_global_user_state.py
--rw-r--r--   0 runner    (1001) docker     (127)     8789 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/tests/test_jobs.py
--rw-r--r--   0 runner    (1001) docker     (127)     3718 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/tests/test_list_accelerators.py
--rw-r--r--   0 runner    (1001) docker     (127)    27759 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/tests/test_optimizer_dryruns.py
--rw-r--r--   0 runner    (1001) docker     (127)     6996 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/tests/test_optimizer_random_dag.py
--rw-r--r--   0 runner    (1001) docker     (127)     1102 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/tests/test_serve_autoscaler.py
--rw-r--r--   0 runner    (1001) docker     (127)   212228 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/tests/test_smoke.py
--rw-r--r--   0 runner    (1001) docker     (127)    17581 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/tests/test_spot_serve.py
--rw-r--r--   0 runner    (1001) docker     (127)     4048 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/tests/test_storage.py
--rw-r--r--   0 runner    (1001) docker     (127)     1070 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/tests/test_wheels.py
--rw-r--r--   0 runner    (1001) docker     (127)     3915 2024-05-01 10:38:56.000000 skypilot_nightly-1.0.0.dev20240501/tests/test_yaml_parser.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.265781 skypilot_nightly-1.0.0.dev20240502/
+-rw-r--r--   0 runner    (1001) docker     (127)    12170 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    18140 2024-05-02 10:38:07.265781 skypilot_nightly-1.0.0.dev20240502/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)    12079 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/README.md
+-rw-r--r--   0 runner    (1001) docker     (127)      640 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-02 10:38:07.265781 skypilot_nightly-1.0.0.dev20240502/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (127)    12055 2024-05-02 10:38:04.000000 skypilot_nightly-1.0.0.dev20240502/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.205781 skypilot_nightly-1.0.0.dev20240502/sky/
+-rw-r--r--   0 runner    (1001) docker     (127)     5588 2024-05-02 10:38:07.000000 skypilot_nightly-1.0.0.dev20240502/sky/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.205781 skypilot_nightly-1.0.0.dev20240502/sky/adaptors/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/adaptors/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6863 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/adaptors/aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2291 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/adaptors/azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/adaptors/cloudflare.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2354 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/adaptors/common.py
+-rw-r--r--   0 runner    (1001) docker     (127)      239 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/adaptors/cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)      468 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/adaptors/docker.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3097 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/adaptors/gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4906 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/adaptors/ibm.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3875 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/adaptors/kubernetes.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1480 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/adaptors/oci.py
+-rw-r--r--   0 runner    (1001) docker     (127)      225 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/adaptors/runpod.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2129 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/adaptors/vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21410 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/authentication.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.209781 skypilot_nightly-1.0.0.dev20240502/sky/backends/
+-rw-r--r--   0 runner    (1001) docker     (127)      536 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/backends/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5932 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/backends/backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)   119254 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/backends/backend_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)   223223 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/backends/cloud_vm_ray_backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8358 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/backends/docker_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16741 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/backends/local_docker_backend.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.209781 skypilot_nightly-1.0.0.dev20240502/sky/backends/monkey_patches/
+-rw-r--r--   0 runner    (1001) docker     (127)     3450 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/backends/monkey_patches/monkey_patch_ray_up.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7297 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/backends/wheel_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.209781 skypilot_nightly-1.0.0.dev20240502/sky/benchmark/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/benchmark/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8723 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/benchmark/benchmark_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26440 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/benchmark/benchmark_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5908 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/check.py
+-rw-r--r--   0 runner    (1001) docker     (127)   186846 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/cli.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11806 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/cloud_stores.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.213781 skypilot_nightly-1.0.0.dev20240502/sky/clouds/
+-rw-r--r--   0 runner    (1001) docker     (127)     1310 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    44034 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)    31006 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)    31670 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)      955 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/cloud_registry.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12036 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12647 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/fluidstack.py
+-rw-r--r--   0 runner    (1001) docker     (127)    47961 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21044 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/ibm.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18717 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/kubernetes.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12157 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/lambda_cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25299 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/oci.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10561 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/paperspace.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11166 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/runpod.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15546 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/scp.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.213781 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/
+-rw-r--r--   0 runner    (1001) docker     (127)    12771 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12550 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/aws_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7289 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/azure_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26837 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/common.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1793 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      411 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4335 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/cudo_catalog.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.217781 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/data_fetchers/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/data_fetchers/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22424 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11477 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5072 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3895 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22243 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4297 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21462 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5038 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/fluidstack_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24120 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/gcp_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4472 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/ibm_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4240 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/kubernetes_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5082 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/lambda_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/oci_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3768 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/paperspace_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4184 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/runpod_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5174 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/scp_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4391 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/vsphere_catalog.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.217781 skypilot_nightly-1.0.0.dev20240502/sky/clouds/utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6968 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/utils/gcp_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9991 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/utils/lambda_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4482 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/utils/oci_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15781 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/utils/scp_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11969 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/clouds/vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32991 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/core.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2529 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/dag.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.217781 skypilot_nightly-1.0.0.dev20240502/sky/data/
+-rw-r--r--   0 runner    (1001) docker     (127)      184 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/data/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7346 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/data/data_transfer.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21664 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/data/data_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8226 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/data/mounting_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)   118872 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/data/storage.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6867 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/data/storage_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8213 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/exceptions.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24916 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/execution.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28681 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/global_user_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    54101 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/optimizer.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.221781 skypilot_nightly-1.0.0.dev20240502/sky/provision/
+-rw-r--r--   0 runner    (1001) docker     (127)     4907 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.221781 skypilot_nightly-1.0.0.dev20240502/sky/provision/aws/
+-rw-r--r--   0 runner    (1001) docker     (127)      782 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/aws/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22092 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/aws/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    36603 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/aws/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3238 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/aws/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.221781 skypilot_nightly-1.0.0.dev20240502/sky/provision/azure/
+-rw-r--r--   0 runner    (1001) docker     (127)      199 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/azure/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4398 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/azure/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8561 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/common.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.221781 skypilot_nightly-1.0.0.dev20240502/sky/provision/cudo/
+-rw-r--r--   0 runner    (1001) docker     (127)      676 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/cudo/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      327 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/cudo/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      696 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/cudo/cudo_machine_type.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4046 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/cudo/cudo_wrapper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8202 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/cudo/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16782 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/docker_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.221781 skypilot_nightly-1.0.0.dev20240502/sky/provision/fluidstack/
+-rw-r--r--   0 runner    (1001) docker     (127)      592 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/fluidstack/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      326 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/fluidstack/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8262 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/fluidstack/fluidstack_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14870 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/fluidstack/instance.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.225781 skypilot_nightly-1.0.0.dev20240502/sky/provision/gcp/
+-rw-r--r--   0 runner    (1001) docker     (127)      579 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/gcp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32964 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/gcp/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7234 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/gcp/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24482 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/gcp/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    59069 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/gcp/instance_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22258 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/instance_setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.225781 skypilot_nightly-1.0.0.dev20240502/sky/provision/kubernetes/
+-rw-r--r--   0 runner    (1001) docker     (127)      653 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/kubernetes/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17388 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/kubernetes/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32841 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/kubernetes/instance.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.225781 skypilot_nightly-1.0.0.dev20240502/sky/provision/kubernetes/manifests/
+-rw-r--r--   0 runner    (1001) docker     (127)      229 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/kubernetes/manifests/smarter-device-manager-configmap.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     1939 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)    10501 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/kubernetes/network.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9035 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/kubernetes/network_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    55170 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/kubernetes/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2103 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/logging.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4013 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/metadata_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.225781 skypilot_nightly-1.0.0.dev20240502/sky/provision/paperspace/
+-rw-r--r--   0 runner    (1001) docker     (127)      598 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/paperspace/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1541 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/paperspace/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      553 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/paperspace/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11985 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/paperspace/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9428 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/paperspace/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25255 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/provisioner.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.225781 skypilot_nightly-1.0.0.dev20240502/sky/provision/runpod/
+-rw-r--r--   0 runner    (1001) docker     (127)      502 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/runpod/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      321 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/runpod/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7849 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/runpod/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4648 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/runpod/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.225781 skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/
+-rw-r--r--   0 runner    (1001) docker     (127)      788 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.229781 skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/common/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/common/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4167 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/common/cls_api_client.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14096 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/common/cls_api_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)      481 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/common/custom_script.py
+-rw-r--r--   0 runner    (1001) docker     (127)      303 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/common/id_generator.py
+-rw-r--r--   0 runner    (1001) docker     (127)      914 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/common/metadata_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1817 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/common/service_manager.py
+-rw-r--r--   0 runner    (1001) docker     (127)      544 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/common/service_manager_factory.py
+-rw-r--r--   0 runner    (1001) docker     (127)      795 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/common/ssl_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2932 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/common/vapiconnect.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17877 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/common/vim_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      504 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24476 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15151 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/vsphere_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    64485 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/resources.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.229781 skypilot_nightly-1.0.0.dev20240502/sky/serve/
+-rw-r--r--   0 runner    (1001) docker     (127)     1661 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/serve/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    30137 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/serve/autoscalers.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3732 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/serve/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7571 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/serve/controller.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28185 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/serve/core.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4689 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/serve/load_balancer.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2047 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/serve/load_balancing_policies.py
+-rw-r--r--   0 runner    (1001) docker     (127)    55738 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/serve/replica_managers.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18830 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/serve/serve_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    36837 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/serve/serve_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10931 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/serve/service.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13803 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/serve/service_spec.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.229781 skypilot_nightly-1.0.0.dev20240502/sky/setup_files/
+-rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/setup_files/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    12055 2024-05-02 10:38:04.000000 skypilot_nightly-1.0.0.dev20240502/sky/setup_files/setup.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4000 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/sky_logging.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.233781 skypilot_nightly-1.0.0.dev20240502/sky/skylet/
+-rw-r--r--   0 runner    (1001) docker     (127)    12381 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1963 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/attempt_skylet.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4293 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/autostop_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1887 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/configs.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9964 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11564 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/events.py
+-rw-r--r--   0 runner    (1001) docker     (127)    35167 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/job_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18788 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/log_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4292 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/log_lib.pyi
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.233781 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.233781 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/azure/
+-rw-r--r--   0 runner    (1001) docker     (127)       97 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/azure/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4344 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/azure/azure-config-template.json
+-rw-r--r--   0 runner    (1001) docker     (127)    10901 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/azure/azure-vm-template.json
+-rw-r--r--   0 runner    (1001) docker     (127)     6203 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/azure/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18812 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/azure/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16355 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/command_runner.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.233781 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/ibm/
+-rw-r--r--   0 runner    (1001) docker     (127)       94 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/ibm/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    38280 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/ibm/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1292 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/ibm/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    34630 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/ibm/vpc_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.233781 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/lambda_cloud/
+-rw-r--r--   0 runner    (1001) docker     (127)      112 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/lambda_cloud/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13992 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/lambda_cloud/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.237781 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/oci/
+-rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/oci/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20492 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/oci/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17202 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/oci/query_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)      508 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/oci/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.237781 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/scp/
+-rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/scp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4683 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/scp/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22411 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/scp/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.237781 skypilot_nightly-1.0.0.dev20240502/sky/skylet/ray_patches/
+-rw-r--r--   0 runner    (1001) docker     (127)     2761 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/ray_patches/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/ray_patches/autoscaler.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      349 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/ray_patches/cli.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      224 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/ray_patches/command_runner.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      531 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/ray_patches/log_monitor.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      658 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      289 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/ray_patches/updater.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      565 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/ray_patches/worker.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)     1144 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/skylet.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1348 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skylet/subprocess_daemon.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5586 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/skypilot_config.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.237781 skypilot_nightly-1.0.0.dev20240502/sky/spot/
+-rw-r--r--   0 runner    (1001) docker     (127)     1561 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/spot/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1117 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/spot/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25830 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/spot/controller.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13078 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/spot/core.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.237781 skypilot_nightly-1.0.0.dev20240502/sky/spot/dashboard/
+-rw-r--r--   0 runner    (1001) docker     (127)     2294 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/spot/dashboard/dashboard.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.237781 skypilot_nightly-1.0.0.dev20240502/sky/spot/dashboard/static/
+-rw-r--r--   0 runner    (1001) docker     (127)    15086 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/spot/dashboard/static/favicon.ico
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.241781 skypilot_nightly-1.0.0.dev20240502/sky/spot/dashboard/templates/
+-rw-r--r--   0 runner    (1001) docker     (127)     6247 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/spot/dashboard/templates/index.html
+-rw-r--r--   0 runner    (1001) docker     (127)    25656 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/spot/recovery_strategy.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22487 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/spot/spot_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    31559 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/spot/spot_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1457 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/status_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)    47239 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/task.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.241781 skypilot_nightly-1.0.0.dev20240502/sky/templates/
+-rw-r--r--   0 runner    (1001) docker     (127)     7320 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/templates/aws-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     9037 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/templates/azure-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3435 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/templates/cudo-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3465 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/templates/fluidstack-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     8880 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/templates/gcp-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     6607 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/templates/ibm-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1095 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/templates/kubernetes-ingress.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)      376 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/templates/kubernetes-loadbalancer.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     2547 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/templates/kubernetes-port-forward-proxy-command.sh.j2
+-rw-r--r--   0 runner    (1001) docker     (127)    11034 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/templates/kubernetes-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     2747 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/templates/kubernetes-ssh-jump.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     5676 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/templates/lambda-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1185 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/templates/local-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     6970 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/templates/oci-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3898 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/templates/paperspace-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3496 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/templates/runpod-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     5546 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/templates/scp-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1148 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/templates/sky-serve-controller.yaml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1218 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/templates/spot-controller.yaml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3474 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/templates/vsphere-ray.yml.j2
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.241781 skypilot_nightly-1.0.0.dev20240502/sky/usage/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/usage/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      590 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/usage/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17601 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/usage/usage_lib.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.245781 skypilot_nightly-1.0.0.dev20240502/sky/utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3798 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/accelerator_registry.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.245781 skypilot_nightly-1.0.0.dev20240502/sky/utils/cli_utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/cli_utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11032 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/cli_utils/status_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      849 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/cluster_yaml_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18805 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/command_runner.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3485 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/command_runner.pyi
+-rw-r--r--   0 runner    (1001) docker     (127)    22547 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/common_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28619 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/controller_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6260 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/dag_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2786 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/db_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      852 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/env_options.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.249781 skypilot_nightly-1.0.0.dev20240502/sky/utils/kubernetes/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/kubernetes/__init__.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     9667 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/kubernetes/create_cluster.sh
+-rwxr-xr-x   0 runner    (1001) docker     (127)      927 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/kubernetes/delete_cluster.sh
+-rw-r--r--   0 runner    (1001) docker     (127)     3187 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/kubernetes/generate_kind_config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6960 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/kubernetes/gpu_labeler.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1186 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     3812 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     6560 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1193 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/kubernetes_enums.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8139 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/log_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5540 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/resources_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1581 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/rich_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20167 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/schemas.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6509 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/subprocess_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3936 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/timeline.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3264 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/ux_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      701 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/sky/utils/validator.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.253781 skypilot_nightly-1.0.0.dev20240502/skypilot_nightly.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)    18140 2024-05-02 10:38:07.000000 skypilot_nightly-1.0.0.dev20240502/skypilot_nightly.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     9308 2024-05-02 10:38:07.000000 skypilot_nightly-1.0.0.dev20240502/skypilot_nightly.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-02 10:38:07.000000 skypilot_nightly-1.0.0.dev20240502/skypilot_nightly.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       36 2024-05-02 10:38:07.000000 skypilot_nightly-1.0.0.dev20240502/skypilot_nightly.egg-info/entry_points.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2270 2024-05-02 10:38:07.000000 skypilot_nightly-1.0.0.dev20240502/skypilot_nightly.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        4 2024-05-02 10:38:07.000000 skypilot_nightly-1.0.0.dev20240502/skypilot_nightly.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 10:38:07.249781 skypilot_nightly-1.0.0.dev20240502/tests/
+-rw-r--r--   0 runner    (1001) docker     (127)      171 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/tests/test_api.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3618 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/tests/test_cli.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9592 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/tests/test_config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      267 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/tests/test_global_user_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8789 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/tests/test_jobs.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3718 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/tests/test_list_accelerators.py
+-rw-r--r--   0 runner    (1001) docker     (127)    27759 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/tests/test_optimizer_dryruns.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6996 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/tests/test_optimizer_random_dag.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1102 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/tests/test_serve_autoscaler.py
+-rw-r--r--   0 runner    (1001) docker     (127)   215427 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/tests/test_smoke.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17581 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/tests/test_spot_serve.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4048 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/tests/test_storage.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1070 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/tests/test_wheels.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3915 2024-05-02 10:38:02.000000 skypilot_nightly-1.0.0.dev20240502/tests/test_yaml_parser.py
```

### Comparing `skypilot_nightly-1.0.0.dev20240501/LICENSE` & `skypilot_nightly-1.0.0.dev20240502/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/MANIFEST.in` & `skypilot_nightly-1.0.0.dev20240502/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/PKG-INFO` & `skypilot_nightly-1.0.0.dev20240502/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot-nightly
-Version: 1.0.0.dev20240501
+Version: 1.0.0.dev20240502
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
```

### Comparing `skypilot_nightly-1.0.0.dev20240501/README.md` & `skypilot_nightly-1.0.0.dev20240502/README.md`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/pyproject.toml` & `skypilot_nightly-1.0.0.dev20240502/pyproject.toml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/setup.py` & `skypilot_nightly-1.0.0.dev20240502/setup.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/__init__.py` & `skypilot_nightly-1.0.0.dev20240502/sky/__init__.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,15 +1,15 @@
 """The SkyPilot package."""
 import os
 import subprocess
 from typing import Optional
 import urllib.request
 
 # Replaced with the current commit when building the wheels.
-_SKYPILOT_COMMIT_SHA = '78b95b3b91aefdc5e2d75c51822ae44c7056cdd7'
+_SKYPILOT_COMMIT_SHA = 'd27e0ff83c56983920a655fbeaddc96b2758752e'
 
 
 def _get_git_commit():
     if 'SKYPILOT_COMMIT_SHA' not in _SKYPILOT_COMMIT_SHA:
         # This is a release build, so we don't need to get the commit hash from
         # git, as it's already been set.
         return _SKYPILOT_COMMIT_SHA
@@ -31,15 +31,15 @@
             commit_hash += '-dirty'
         return commit_hash
     except Exception:  # pylint: disable=broad-except
         return _SKYPILOT_COMMIT_SHA
 
 
 __commit__ = _get_git_commit()
-__version__ = '1.0.0.dev20240501'
+__version__ = '1.0.0.dev20240502'
 __root_dir__ = os.path.dirname(os.path.abspath(__file__))
 
 
 # ---------------------- Proxy Configuration ---------------------- #
 def _set_http_proxy_env_vars() -> None:
     urllib_proxies = dict(urllib.request.getproxies())
```

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/adaptors/aws.py` & `skypilot_nightly-1.0.0.dev20240502/sky/adaptors/aws.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/adaptors/azure.py` & `skypilot_nightly-1.0.0.dev20240502/sky/adaptors/azure.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/adaptors/cloudflare.py` & `skypilot_nightly-1.0.0.dev20240502/sky/adaptors/cloudflare.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/adaptors/common.py` & `skypilot_nightly-1.0.0.dev20240502/sky/adaptors/common.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/adaptors/gcp.py` & `skypilot_nightly-1.0.0.dev20240502/sky/adaptors/gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/adaptors/ibm.py` & `skypilot_nightly-1.0.0.dev20240502/sky/adaptors/ibm.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/adaptors/kubernetes.py` & `skypilot_nightly-1.0.0.dev20240502/sky/adaptors/kubernetes.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/adaptors/oci.py` & `skypilot_nightly-1.0.0.dev20240502/sky/adaptors/oci.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/adaptors/vsphere.py` & `skypilot_nightly-1.0.0.dev20240502/sky/adaptors/vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/authentication.py` & `skypilot_nightly-1.0.0.dev20240502/sky/authentication.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/backends/__init__.py` & `skypilot_nightly-1.0.0.dev20240502/sky/backends/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/backends/backend.py` & `skypilot_nightly-1.0.0.dev20240502/sky/backends/backend.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/backends/backend_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/backends/backend_utils.py`

 * *Files 2% similar despite different names*

```diff
@@ -2230,5198 +2230,5225 @@
 00008b50: 616e 645f 636f 6e66 6967 5b72 6567 696f  and_config[regio
 00008b60: 6e5f 6e61 6d65 5d0a 2020 2020 6c6f 6767  n_name].    logg
 00008b70: 6572 2e64 6562 7567 2866 2755 7369 6e67  er.debug(f'Using
 00008b80: 2073 7368 5f70 726f 7879 5f63 6f6d 6d61   ssh_proxy_comma
 00008b90: 6e64 3a20 7b73 7368 5f70 726f 7879 5f63  nd: {ssh_proxy_c
 00008ba0: 6f6d 6d61 6e64 2172 7d27 290a 0a20 2020  ommand!r}')..   
 00008bb0: 2023 2055 7365 722d 7375 7070 6c69 6564   # User-supplied
-00008bc0: 2069 6e73 7461 6e63 6520 7461 6773 2e0a   instance tags..
-00008bd0: 2020 2020 696e 7374 616e 6365 5f74 6167      instance_tag
-00008be0: 7320 3d20 7b7d 0a20 2020 2069 6e73 7461  s = {}.    insta
-00008bf0: 6e63 655f 7461 6773 203d 2073 6b79 7069  nce_tags = skypi
-00008c00: 6c6f 745f 636f 6e66 6967 2e67 6574 5f6e  lot_config.get_n
-00008c10: 6573 7465 6428 0a20 2020 2020 2020 2028  ested(.        (
-00008c20: 7374 7228 636c 6f75 6429 2e6c 6f77 6572  str(cloud).lower
-00008c30: 2829 2c20 2769 6e73 7461 6e63 655f 7461  (), 'instance_ta
-00008c40: 6773 2729 2c20 7b7d 290a 2020 2020 2320  gs'), {}).    # 
-00008c50: 696e 7374 616e 6365 5f74 6167 7320 6973  instance_tags is
-00008c60: 2061 2064 6963 742c 2077 6869 6368 2069   a dict, which i
-00008c70: 7320 6775 6172 616e 7465 6564 2062 7920  s guaranteed by 
-00008c80: 7468 6520 7479 7065 2063 6865 636b 2069  the type check i
-00008c90: 6e0a 2020 2020 2320 7363 6865 6d61 732e  n.    # schemas.
-00008ca0: 7079 0a20 2020 2061 7373 6572 7420 6973  py.    assert is
-00008cb0: 696e 7374 616e 6365 2869 6e73 7461 6e63  instance(instanc
-00008cc0: 655f 7461 6773 2c20 6469 6374 292c 2069  e_tags, dict), i
-00008cd0: 6e73 7461 6e63 655f 7461 6773 0a0a 2020  nstance_tags..  
-00008ce0: 2020 2320 4475 6d70 2074 6865 2052 6179    # Dump the Ray
-00008cf0: 2070 6f72 7473 2074 6f20 6120 6669 6c65   ports to a file
-00008d00: 2066 6f72 2052 6179 206a 6f62 2073 7562   for Ray job sub
-00008d10: 6d69 7373 696f 6e0a 2020 2020 6475 6d70  mission.    dump
-00008d20: 5f70 6f72 745f 636f 6d6d 616e 6420 3d20  _port_command = 
-00008d30: 280a 2020 2020 2020 2020 6627 7b63 6f6e  (.        f'{con
-00008d40: 7374 616e 7473 2e53 4b59 5f50 5954 484f  stants.SKY_PYTHO
-00008d50: 4e5f 434d 447d 202d 6320 5c27 696d 706f  N_CMD} -c \'impo
-00008d60: 7274 206a 736f 6e2c 206f 733b 206a 736f  rt json, os; jso
-00008d70: 6e2e 6475 6d70 287b 636f 6e73 7461 6e74  n.dump({constant
-00008d80: 732e 534b 595f 5245 4d4f 5445 5f52 4159  s.SKY_REMOTE_RAY
-00008d90: 5f50 4f52 545f 4449 4354 5f53 5452 7d2c  _PORT_DICT_STR},
-00008da0: 2027 0a20 2020 2020 2020 2066 276f 7065   '.        f'ope
-00008db0: 6e28 6f73 2e70 6174 682e 6578 7061 6e64  n(os.path.expand
-00008dc0: 7573 6572 2822 7b63 6f6e 7374 616e 7473  user("{constants
-00008dd0: 2e53 4b59 5f52 454d 4f54 455f 5241 595f  .SKY_REMOTE_RAY_
-00008de0: 504f 5254 5f46 494c 457d 2229 2c20 2277  PORT_FILE}"), "w
-00008df0: 222c 2065 6e63 6f64 696e 673d 2275 7466  ", encoding="utf
-00008e00: 2d38 2229 295c 2727 0a20 2020 2029 0a0a  -8"))\''.    )..
-00008e10: 2020 2020 2320 5573 6520 6120 746d 7020      # Use a tmp 
-00008e20: 6669 6c65 2070 6174 6820 746f 2061 766f  file path to avo
-00008e30: 6964 2069 6e63 6f6d 706c 6574 6520 5941  id incomplete YA
-00008e40: 4d4c 2066 696c 6520 6265 696e 6720 7265  ML file being re
-00008e50: 2d75 7365 6420 696e 2074 6865 0a20 2020  -used in the.   
-00008e60: 2023 2066 7574 7572 652e 0a20 2020 2074   # future..    t
-00008e70: 6d70 5f79 616d 6c5f 7061 7468 203d 2079  mp_yaml_path = y
-00008e80: 616d 6c5f 7061 7468 202b 2027 2e74 6d70  aml_path + '.tmp
-00008e90: 270a 2020 2020 636f 6d6d 6f6e 5f75 7469  '.    common_uti
-00008ea0: 6c73 2e66 696c 6c5f 7465 6d70 6c61 7465  ls.fill_template
-00008eb0: 280a 2020 2020 2020 2020 636c 7573 7465  (.        cluste
-00008ec0: 725f 636f 6e66 6967 5f74 656d 706c 6174  r_config_templat
-00008ed0: 652c 0a20 2020 2020 2020 2064 6963 7428  e,.        dict(
-00008ee0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-00008ef0: 6f75 7263 6573 5f76 6172 732c 0a20 2020  ources_vars,.   
-00008f00: 2020 2020 2020 2020 202a 2a7b 0a20 2020           **{.   
-00008f10: 2020 2020 2020 2020 2020 2020 2027 636c               'cl
-00008f20: 7573 7465 725f 6e61 6d65 5f6f 6e5f 636c  uster_name_on_cl
-00008f30: 6f75 6427 3a20 636c 7573 7465 725f 6e61  oud': cluster_na
-00008f40: 6d65 5f6f 6e5f 636c 6f75 642c 0a20 2020  me_on_cloud,.   
-00008f50: 2020 2020 2020 2020 2020 2020 2027 6e75               'nu
-00008f60: 6d5f 6e6f 6465 7327 3a20 6e75 6d5f 6e6f  m_nodes': num_no
-00008f70: 6465 732c 0a20 2020 2020 2020 2020 2020  des,.           
-00008f80: 2020 2020 2027 6469 736b 5f73 697a 6527       'disk_size'
-00008f90: 3a20 746f 5f70 726f 7669 7369 6f6e 2e64  : to_provision.d
-00008fa0: 6973 6b5f 7369 7a65 2c0a 2020 2020 2020  isk_size,.      
-00008fb0: 2020 2020 2020 2020 2020 2320 4966 2074            # If t
-00008fc0: 6865 2063 7572 7265 6e74 2063 6f64 6520  he current code 
-00008fd0: 6973 2072 756e 2062 7920 636f 6e74 726f  is run by contro
-00008fe0: 6c6c 6572 2c20 7072 6f70 6167 6174 6520  ller, propagate 
-00008ff0: 7468 6520 7265 616c 0a20 2020 2020 2020  the real.       
-00009000: 2020 2020 2020 2020 2023 2063 616c 6c69           # calli
-00009010: 6e67 2075 7365 7220 7768 6963 6820 7368  ng user which sh
-00009020: 6f75 6c64 2776 6520 6265 656e 2070 6173  ould've been pas
-00009030: 7365 6420 696e 2061 7320 7468 650a 2020  sed in as the.  
-00009040: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00009050: 534b 5950 494c 4f54 5f55 5345 5220 656e  SKYPILOT_USER en
-00009060: 7620 7661 7220 2873 6565 0a20 2020 2020  v var (see.     
-00009070: 2020 2020 2020 2020 2020 2023 2063 6f6e             # con
-00009080: 7472 6f6c 6c65 725f 7574 696c 732e 7368  troller_utils.sh
-00009090: 6172 6564 5f63 6f6e 7472 6f6c 6c65 725f  ared_controller_
-000090a0: 7661 7273 5f74 6f5f 6669 6c6c 2829 2e0a  vars_to_fill()..
-000090b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000090c0: 2775 7365 7227 3a20 636f 6d6d 6f6e 5f75  'user': common_u
-000090d0: 7469 6c73 2e67 6574 5f63 6c65 616e 6564  tils.get_cleaned
-000090e0: 5f75 7365 726e 616d 6528 0a20 2020 2020  _username(.     
-000090f0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00009100: 732e 656e 7669 726f 6e2e 6765 7428 636f  s.environ.get(co
-00009110: 6e73 7461 6e74 732e 5553 4552 5f45 4e56  nstants.USER_ENV
-00009120: 5f56 4152 2c20 2727 2929 2c0a 0a20 2020  _VAR, '')),..   
-00009130: 2020 2020 2020 2020 2020 2020 2023 204e               # N
-00009140: 6574 776f 726b 696e 6720 636f 6e66 6967  etworking config
-00009150: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00009160: 2020 2775 7365 5f69 6e74 6572 6e61 6c5f    'use_internal_
-00009170: 6970 7327 3a20 736b 7970 696c 6f74 5f63  ips': skypilot_c
-00009180: 6f6e 6669 672e 6765 745f 6e65 7374 6564  onfig.get_nested
-00009190: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000091a0: 2020 2020 2020 2873 7472 2863 6c6f 7564        (str(cloud
-000091b0: 292e 6c6f 7765 7228 292c 2027 7573 655f  ).lower(), 'use_
-000091c0: 696e 7465 726e 616c 5f69 7073 2729 2c20  internal_ips'), 
-000091d0: 4661 6c73 6529 2c0a 2020 2020 2020 2020  False),.        
-000091e0: 2020 2020 2020 2020 2773 7368 5f70 726f          'ssh_pro
-000091f0: 7879 5f63 6f6d 6d61 6e64 273a 2073 7368  xy_command': ssh
-00009200: 5f70 726f 7879 5f63 6f6d 6d61 6e64 2c0a  _proxy_command,.
-00009210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009220: 2776 7063 5f6e 616d 6527 3a20 736b 7970  'vpc_name': skyp
-00009230: 696c 6f74 5f63 6f6e 6669 672e 6765 745f  ilot_config.get_
-00009240: 6e65 7374 6564 280a 2020 2020 2020 2020  nested(.        
-00009250: 2020 2020 2020 2020 2020 2020 2873 7472              (str
-00009260: 2863 6c6f 7564 292e 6c6f 7765 7228 292c  (cloud).lower(),
-00009270: 2027 7670 635f 6e61 6d65 2729 2c20 4e6f   'vpc_name'), No
-00009280: 6e65 292c 0a0a 2020 2020 2020 2020 2020  ne),..          
-00009290: 2020 2020 2020 2320 5573 6572 2d73 7570        # User-sup
-000092a0: 706c 6965 6420 696e 7374 616e 6365 2074  plied instance t
-000092b0: 6167 732e 0a20 2020 2020 2020 2020 2020  ags..           
-000092c0: 2020 2020 2027 696e 7374 616e 6365 5f74       'instance_t
-000092d0: 6167 7327 3a20 696e 7374 616e 6365 5f74  ags': instance_t
-000092e0: 6167 732c 0a20 2020 2020 2020 2020 2020  ags,.           
-000092f0: 2020 2020 2023 2054 6865 2072 6573 6572       # The reser
-00009300: 7661 7469 6f6e 2070 6f6f 6c73 2074 6861  vation pools tha
-00009310: 7420 7370 6563 6966 6965 6420 6279 2074  t specified by t
-00009320: 6865 2075 7365 722e 2054 6869 7320 6973  he user. This is
-00009330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009340: 2023 2063 7572 7265 6e74 6c79 206f 6e6c   # currently onl
-00009350: 7920 7573 6564 2062 7920 4743 502e 0a20  y used by GCP.. 
-00009360: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00009370: 7370 6563 6966 6963 5f72 6573 6572 7661  specific_reserva
-00009380: 7469 6f6e 7327 3a20 7370 6563 6966 6963  tions': specific
-00009390: 5f72 6573 6572 7661 7469 6f6e 732c 0a0a  _reservations,..
-000093a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000093b0: 2320 436f 6e64 6120 7365 7475 700a 2020  # Conda setup.  
-000093c0: 2020 2020 2020 2020 2020 2020 2020 2763                'c
-000093d0: 6f6e 6461 5f69 6e73 7461 6c6c 6174 696f  onda_installatio
-000093e0: 6e5f 636f 6d6d 616e 6473 273a 0a20 2020  n_commands':.   
-000093f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009400: 2063 6f6e 7374 616e 7473 2e43 4f4e 4441   constants.CONDA
-00009410: 5f49 4e53 5441 4c4c 4154 494f 4e5f 434f  _INSTALLATION_CO
-00009420: 4d4d 414e 4453 2c0a 2020 2020 2020 2020  MMANDS,.        
-00009430: 2020 2020 2020 2020 2320 5765 2073 686f          # We sho
-00009440: 756c 6420 6e6f 7420 7573 6520 602e 666f  uld not use `.fo
-00009450: 726d 6174 602c 2061 7320 6974 2063 6f6e  rmat`, as it con
-00009460: 7461 696e 7320 277b 7d27 2061 7320 7468  tains '{}' as th
-00009470: 6520 6261 7368 0a20 2020 2020 2020 2020  e bash.         
-00009480: 2020 2020 2020 2023 2073 796e 7461 782e         # syntax.
-00009490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000094a0: 2027 7261 795f 736b 7970 696c 6f74 5f69   'ray_skypilot_i
-000094b0: 6e73 7461 6c6c 6174 696f 6e5f 636f 6d6d  nstallation_comm
-000094c0: 616e 6473 273a 0a20 2020 2020 2020 2020  ands':.         
-000094d0: 2020 2020 2020 2020 2020 2028 636f 6e73             (cons
-000094e0: 7461 6e74 732e 5241 595f 534b 5950 494c  tants.RAY_SKYPIL
-000094f0: 4f54 5f49 4e53 5441 4c4c 4154 494f 4e5f  OT_INSTALLATION_
-00009500: 434f 4d4d 414e 4453 2e72 6570 6c61 6365  COMMANDS.replace
-00009510: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00009520: 2020 2020 2020 2020 2020 277b 736b 795f            '{sky_
-00009530: 7768 6565 6c5f 6861 7368 7d27 2c0a 2020  wheel_hash}',.  
-00009540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009550: 2020 2020 2020 7768 6565 6c5f 6861 7368        wheel_hash
-00009560: 292e 7265 706c 6163 6528 277b 636c 6f75  ).replace('{clou
-00009570: 647d 272c 0a20 2020 2020 2020 2020 2020  d}',.           
-00009580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000095a0: 2073 7472 2863 6c6f 7564 292e 6c6f 7765   str(cloud).lowe
-000095b0: 7228 2929 292c 0a0a 2020 2020 2020 2020  r())),..        
-000095c0: 2020 2020 2020 2020 2320 506f 7274 206f          # Port o
-000095d0: 6620 5261 7920 2847 4353 2073 6572 7665  f Ray (GCS serve
-000095e0: 7229 2e0a 2020 2020 2020 2020 2020 2020  r)..            
-000095f0: 2020 2020 2320 5261 7927 7320 6465 6661      # Ray's defa
-00009600: 756c 7420 706f 7274 2036 3337 3920 6973  ult port 6379 is
-00009610: 2063 6f6e 666c 6963 7465 6420 7769 7468   conflicted with
-00009620: 2052 6564 6973 2e0a 2020 2020 2020 2020   Redis..        
-00009630: 2020 2020 2020 2020 2772 6179 5f70 6f72          'ray_por
-00009640: 7427 3a20 636f 6e73 7461 6e74 732e 534b  t': constants.SK
-00009650: 595f 5245 4d4f 5445 5f52 4159 5f50 4f52  Y_REMOTE_RAY_POR
-00009660: 542c 0a20 2020 2020 2020 2020 2020 2020  T,.             
-00009670: 2020 2027 7261 795f 6461 7368 626f 6172     'ray_dashboar
-00009680: 645f 706f 7274 273a 2063 6f6e 7374 616e  d_port': constan
-00009690: 7473 2e53 4b59 5f52 454d 4f54 455f 5241  ts.SKY_REMOTE_RA
-000096a0: 595f 4441 5348 424f 4152 445f 504f 5254  Y_DASHBOARD_PORT
-000096b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000096c0: 2020 2772 6179 5f74 656d 705f 6469 7227    'ray_temp_dir'
-000096d0: 3a20 636f 6e73 7461 6e74 732e 534b 595f  : constants.SKY_
-000096e0: 5245 4d4f 5445 5f52 4159 5f54 454d 5044  REMOTE_RAY_TEMPD
-000096f0: 4952 2c0a 2020 2020 2020 2020 2020 2020  IR,.            
-00009700: 2020 2020 2764 756d 705f 706f 7274 5f63      'dump_port_c
-00009710: 6f6d 6d61 6e64 273a 2064 756d 705f 706f  ommand': dump_po
-00009720: 7274 5f63 6f6d 6d61 6e64 2c0a 2020 2020  rt_command,.    
-00009730: 2020 2020 2020 2020 2020 2020 2320 536b              # Sk
-00009740: 792d 696e 7465 726e 616c 2063 6f6e 7374  y-internal const
-00009750: 616e 7473 2e0a 2020 2020 2020 2020 2020  ants..          
-00009760: 2020 2020 2020 2773 6b79 5f72 6179 5f63        'sky_ray_c
-00009770: 6d64 273a 2063 6f6e 7374 616e 7473 2e53  md': constants.S
-00009780: 4b59 5f52 4159 5f43 4d44 2c0a 2020 2020  KY_RAY_CMD,.    
-00009790: 2020 2020 2020 2020 2020 2020 2773 6b79              'sky
-000097a0: 5f70 6970 5f63 6d64 273a 2063 6f6e 7374  _pip_cmd': const
-000097b0: 616e 7473 2e53 4b59 5f50 4950 5f43 4d44  ants.SKY_PIP_CMD
-000097c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000097d0: 2020 2772 6179 5f76 6572 7369 6f6e 273a    'ray_version':
-000097e0: 2063 6f6e 7374 616e 7473 2e53 4b59 5f52   constants.SKY_R
-000097f0: 454d 4f54 455f 5241 595f 5645 5253 494f  EMOTE_RAY_VERSIO
-00009800: 4e2c 0a20 2020 2020 2020 2020 2020 2020  N,.             
-00009810: 2020 2023 2043 6f6d 6d61 6e64 2066 6f72     # Command for
-00009820: 2077 6169 7469 6e67 2072 6179 2063 6c75   waiting ray clu
-00009830: 7374 6572 2074 6f20 6265 2072 6561 6479  ster to be ready
-00009840: 206f 6e20 6865 6164 2e0a 2020 2020 2020   on head..      
-00009850: 2020 2020 2020 2020 2020 2772 6179 5f68            'ray_h
-00009860: 6561 645f 7761 6974 5f69 6e69 7469 616c  ead_wait_initial
-00009870: 697a 6564 5f63 6f6d 6d61 6e64 273a 0a20  ized_command':. 
-00009880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009890: 2020 2069 6e73 7461 6e63 655f 7365 7475     instance_setu
-000098a0: 702e 5241 595f 4845 4144 5f57 4149 545f  p.RAY_HEAD_WAIT_
-000098b0: 494e 4954 4941 4c49 5a45 445f 434f 4d4d  INITIALIZED_COMM
-000098c0: 414e 442c 0a0a 2020 2020 2020 2020 2020  AND,..          
-000098d0: 2020 2020 2020 2320 436c 6f75 6420 6372        # Cloud cr
-000098e0: 6564 656e 7469 616c 7320 666f 7220 636c  edentials for cl
-000098f0: 6f75 6420 7374 6f72 6167 652e 0a20 2020  oud storage..   
-00009900: 2020 2020 2020 2020 2020 2020 2027 6372               'cr
-00009910: 6564 656e 7469 616c 7327 3a20 6372 6564  edentials': cred
-00009920: 656e 7469 616c 732c 0a20 2020 2020 2020  entials,.       
-00009930: 2020 2020 2020 2020 2023 2053 6b79 2072           # Sky r
-00009940: 656d 6f74 6520 7574 696c 732e 0a20 2020  emote utils..   
-00009950: 2020 2020 2020 2020 2020 2020 2027 736b               'sk
-00009960: 795f 7265 6d6f 7465 5f70 6174 6827 3a20  y_remote_path': 
-00009970: 534b 595f 5245 4d4f 5445 5f50 4154 482c  SKY_REMOTE_PATH,
-00009980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009990: 2027 736b 795f 6c6f 6361 6c5f 7061 7468   'sky_local_path
-000099a0: 273a 2073 7472 286c 6f63 616c 5f77 6865  ': str(local_whe
-000099b0: 656c 5f70 6174 6829 2c0a 2020 2020 2020  el_path),.      
-000099c0: 2020 2020 2020 2020 2020 2320 4164 6420            # Add 
-000099d0: 7961 6d6c 2066 696c 6520 7061 7468 2074  yaml file path t
-000099e0: 6f20 7468 6520 7465 6d70 6c61 7465 2076  o the template v
-000099f0: 6172 6961 626c 6573 2e0a 2020 2020 2020  ariables..      
-00009a00: 2020 2020 2020 2020 2020 2773 6b79 5f72            'sky_r
-00009a10: 6179 5f79 616d 6c5f 7265 6d6f 7465 5f70  ay_yaml_remote_p
-00009a20: 6174 6827 3a0a 2020 2020 2020 2020 2020  ath':.          
-00009a30: 2020 2020 2020 2020 2020 636c 7573 7465            cluste
-00009a40: 725f 7961 6d6c 5f75 7469 6c73 2e53 4b59  r_yaml_utils.SKY
-00009a50: 5f43 4c55 5354 4552 5f59 414d 4c5f 5245  _CLUSTER_YAML_RE
-00009a60: 4d4f 5445 5f50 4154 482c 0a20 2020 2020  MOTE_PATH,.     
-00009a70: 2020 2020 2020 2020 2020 2027 736b 795f             'sky_
-00009a80: 7261 795f 7961 6d6c 5f6c 6f63 616c 5f70  ray_yaml_local_p
-00009a90: 6174 6827 3a20 746d 705f 7961 6d6c 5f70  ath': tmp_yaml_p
-00009aa0: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
-00009ab0: 2020 2020 2027 736b 795f 7665 7273 696f       'sky_versio
-00009ac0: 6e27 3a20 7374 7228 7665 7273 696f 6e2e  n': str(version.
-00009ad0: 7061 7273 6528 736b 792e 5f5f 7665 7273  parse(sky.__vers
-00009ae0: 696f 6e5f 5f29 292c 0a20 2020 2020 2020  ion__)),.       
-00009af0: 2020 2020 2020 2020 2027 736b 795f 7768           'sky_wh
-00009b00: 6565 6c5f 6861 7368 273a 2077 6865 656c  eel_hash': wheel
-00009b10: 5f68 6173 682c 0a20 2020 2020 2020 2020  _hash,.         
-00009b20: 2020 2020 2020 2023 2041 7574 6865 6e74         # Authent
-00009b30: 6963 6174 696f 6e20 286f 7074 696f 6e61  ication (optiona
-00009b40: 6c29 2e0a 2020 2020 2020 2020 2020 2020  l)..            
-00009b50: 2020 2020 2a2a 6175 7468 5f63 6f6e 6669      **auth_confi
-00009b60: 672c 0a20 2020 2020 2020 2020 2020 207d  g,.            }
-00009b70: 292c 0a20 2020 2020 2020 206f 7574 7075  ),.        outpu
-00009b80: 745f 7061 7468 3d74 6d70 5f79 616d 6c5f  t_path=tmp_yaml_
-00009b90: 7061 7468 290a 2020 2020 636f 6e66 6967  path).    config
-00009ba0: 5f64 6963 745b 2763 6c75 7374 6572 5f6e  _dict['cluster_n
-00009bb0: 616d 6527 5d20 3d20 636c 7573 7465 725f  ame'] = cluster_
-00009bc0: 6e61 6d65 0a20 2020 2063 6f6e 6669 675f  name.    config_
-00009bd0: 6469 6374 5b27 7261 7927 5d20 3d20 7961  dict['ray'] = ya
-00009be0: 6d6c 5f70 6174 680a 2020 2020 6966 2064  ml_path.    if d
-00009bf0: 7279 7275 6e3a 0a20 2020 2020 2020 2023  ryrun:.        #
-00009c00: 2049 6620 6472 7972 756e 2c20 7265 7475   If dryrun, retu
-00009c10: 726e 2074 6865 2075 6e66 696e 6973 6865  rn the unfinishe
-00009c20: 6420 746d 7020 7961 6d6c 2070 6174 682e  d tmp yaml path.
-00009c30: 0a20 2020 2020 2020 2063 6f6e 6669 675f  .        config_
-00009c40: 6469 6374 5b27 7261 7927 5d20 3d20 746d  dict['ray'] = tm
-00009c50: 705f 7961 6d6c 5f70 6174 680a 2020 2020  p_yaml_path.    
-00009c60: 2020 2020 7265 7475 726e 2063 6f6e 6669      return confi
-00009c70: 675f 6469 6374 0a20 2020 205f 6164 645f  g_dict.    _add_
-00009c80: 6175 7468 5f74 6f5f 636c 7573 7465 725f  auth_to_cluster_
-00009c90: 636f 6e66 6967 2863 6c6f 7564 2c20 746d  config(cloud, tm
-00009ca0: 705f 7961 6d6c 5f70 6174 6829 0a0a 2020  p_yaml_path)..  
-00009cb0: 2020 2320 4164 6420 6b75 6265 726e 6574    # Add kubernet
-00009cc0: 6573 2063 6f6e 6669 6720 6669 656c 6473  es config fields
-00009cd0: 2066 726f 6d20 7e2f 2e73 6b79 2f63 6f6e   from ~/.sky/con
-00009ce0: 6669 670a 2020 2020 6966 2069 7369 6e73  fig.    if isins
-00009cf0: 7461 6e63 6528 636c 6f75 642c 2063 6c6f  tance(cloud, clo
-00009d00: 7564 732e 4b75 6265 726e 6574 6573 293a  uds.Kubernetes):
-00009d10: 0a20 2020 2020 2020 206b 7562 6572 6e65  .        kuberne
-00009d20: 7465 735f 7574 696c 732e 636f 6d62 696e  tes_utils.combin
-00009d30: 655f 706f 645f 636f 6e66 6967 5f66 6965  e_pod_config_fie
-00009d40: 6c64 7328 746d 705f 7961 6d6c 5f70 6174  lds(tmp_yaml_pat
-00009d50: 6829 0a20 2020 2020 2020 206b 7562 6572  h).        kuber
-00009d60: 6e65 7465 735f 7574 696c 732e 636f 6d62  netes_utils.comb
-00009d70: 696e 655f 6d65 7461 6461 7461 5f66 6965  ine_metadata_fie
-00009d80: 6c64 7328 746d 705f 7961 6d6c 5f70 6174  lds(tmp_yaml_pat
-00009d90: 6829 0a0a 2020 2020 2320 5265 7374 6f72  h)..    # Restor
-00009da0: 6520 7468 6520 6f6c 6420 7961 6d6c 2063  e the old yaml c
-00009db0: 6f6e 7465 6e74 2066 6f72 2062 6163 6b77  ontent for backw
-00009dc0: 6172 6420 636f 6d70 6174 6962 696c 6974  ard compatibilit
-00009dd0: 792e 0a20 2020 2069 6620 6f73 2e70 6174  y..    if os.pat
-00009de0: 682e 6578 6973 7473 2879 616d 6c5f 7061  h.exists(yaml_pa
-00009df0: 7468 2920 616e 6420 6b65 6570 5f6c 6175  th) and keep_lau
-00009e00: 6e63 685f 6669 656c 6473 5f69 6e5f 6578  nch_fields_in_ex
-00009e10: 6973 7469 6e67 5f63 6f6e 6669 673a 0a20  isting_config:. 
-00009e20: 2020 2020 2020 2077 6974 6820 6f70 656e         with open
-00009e30: 2879 616d 6c5f 7061 7468 2c20 2772 272c  (yaml_path, 'r',
-00009e40: 2065 6e63 6f64 696e 673d 2775 7466 2d38   encoding='utf-8
-00009e50: 2729 2061 7320 663a 0a20 2020 2020 2020  ') as f:.       
-00009e60: 2020 2020 206f 6c64 5f79 616d 6c5f 636f       old_yaml_co
-00009e70: 6e74 656e 7420 3d20 662e 7265 6164 2829  ntent = f.read()
-00009e80: 0a20 2020 2020 2020 2077 6974 6820 6f70  .        with op
-00009e90: 656e 2874 6d70 5f79 616d 6c5f 7061 7468  en(tmp_yaml_path
-00009ea0: 2c20 2772 272c 2065 6e63 6f64 696e 673d  , 'r', encoding=
-00009eb0: 2775 7466 2d38 2729 2061 7320 663a 0a20  'utf-8') as f:. 
-00009ec0: 2020 2020 2020 2020 2020 206e 6577 5f79             new_y
-00009ed0: 616d 6c5f 636f 6e74 656e 7420 3d20 662e  aml_content = f.
-00009ee0: 7265 6164 2829 0a20 2020 2020 2020 2072  read().        r
-00009ef0: 6573 746f 7265 645f 7961 6d6c 5f63 6f6e  estored_yaml_con
-00009f00: 7465 6e74 203d 205f 7265 706c 6163 655f  tent = _replace_
-00009f10: 7961 6d6c 5f64 6963 7473 280a 2020 2020  yaml_dicts(.    
-00009f20: 2020 2020 2020 2020 6e65 775f 7961 6d6c          new_yaml
-00009f30: 5f63 6f6e 7465 6e74 2c20 6f6c 645f 7961  _content, old_ya
-00009f40: 6d6c 5f63 6f6e 7465 6e74 2c0a 2020 2020  ml_content,.    
-00009f50: 2020 2020 2020 2020 5f52 4159 5f59 414d          _RAY_YAM
-00009f60: 4c5f 4b45 5953 5f54 4f5f 5245 5354 4f52  L_KEYS_TO_RESTOR
-00009f70: 455f 464f 525f 4241 434b 5f43 4f4d 5041  E_FOR_BACK_COMPA
-00009f80: 5449 4249 4c49 5459 2c0a 2020 2020 2020  TIBILITY,.      
-00009f90: 2020 2020 2020 5f52 4159 5f59 414d 4c5f        _RAY_YAML_
-00009fa0: 4b45 5953 5f54 4f5f 5245 5354 4f52 455f  KEYS_TO_RESTORE_
-00009fb0: 4558 4345 5054 494f 4e53 290a 2020 2020  EXCEPTIONS).    
-00009fc0: 2020 2020 7769 7468 206f 7065 6e28 746d      with open(tm
-00009fd0: 705f 7961 6d6c 5f70 6174 682c 2027 7727  p_yaml_path, 'w'
-00009fe0: 2c20 656e 636f 6469 6e67 3d27 7574 662d  , encoding='utf-
-00009ff0: 3827 2920 6173 2066 3a0a 2020 2020 2020  8') as f:.      
-0000a000: 2020 2020 2020 662e 7772 6974 6528 7265        f.write(re
-0000a010: 7374 6f72 6564 5f79 616d 6c5f 636f 6e74  stored_yaml_cont
-0000a020: 656e 7429 0a0a 2020 2020 636f 6e66 6967  ent)..    config
-0000a030: 5f64 6963 745b 2763 6c75 7374 6572 5f6e  _dict['cluster_n
-0000a040: 616d 655f 6f6e 5f63 6c6f 7564 275d 203d  ame_on_cloud'] =
-0000a050: 2063 6c75 7374 6572 5f6e 616d 655f 6f6e   cluster_name_on
-0000a060: 5f63 6c6f 7564 0a0a 2020 2020 2320 4f70  _cloud..    # Op
-0000a070: 7469 6d69 7a61 7469 6f6e 3a20 636f 7079  timization: copy
-0000a080: 2074 6865 2063 6f6e 7465 6e74 7320 6f66   the contents of
-0000a090: 2073 6f75 7263 6520 6669 6c65 7320 696e   source files in
-0000a0a0: 2066 696c 655f 6d6f 756e 7473 2074 6f20   file_mounts to 
-0000a0b0: 610a 2020 2020 2320 7370 6563 6961 6c20  a.    # special 
-0000a0c0: 6469 722c 2061 6e64 2075 706c 6f61 6420  dir, and upload 
-0000a0d0: 7468 6174 2061 7320 7468 6520 6f6e 6c79  that as the only
-0000a0e0: 2066 696c 655f 6d6f 756e 7420 696e 7374   file_mount inst
-0000a0f0: 6561 642e 2044 656c 6179 0a20 2020 2023  ead. Delay.    #
-0000a100: 2063 616c 6c69 6e67 2074 6869 7320 6f70   calling this op
-0000a110: 7469 6d69 7a61 7469 6f6e 2075 6e74 696c  timization until
-0000a120: 206e 6f77 2c20 7768 656e 2061 6c6c 2073   now, when all s
-0000a130: 6f75 7263 6520 6669 6c65 7320 6861 7665  ource files have
-0000a140: 2062 6565 6e0a 2020 2020 2320 7772 6974   been.    # writ
-0000a150: 7465 6e20 616e 6420 7468 6569 7220 636f  ten and their co
-0000a160: 6e74 656e 7473 2066 696e 616c 697a 6564  ntents finalized
-0000a170: 2e0a 2020 2020 230a 2020 2020 2320 4e6f  ..    #.    # No
-0000a180: 7465 2074 6861 7420 7468 6520 7261 7920  te that the ray 
-0000a190: 7961 6d6c 2066 696c 6520 7769 6c6c 2062  yaml file will b
-0000a1a0: 6520 636f 7069 6564 2069 6e74 6f20 7468  e copied into th
-0000a1b0: 6174 2073 7065 6369 616c 2064 6972 2028  at special dir (
-0000a1c0: 692e 652e 2c0a 2020 2020 2320 7570 6c6f  i.e.,.    # uplo
-0000a1d0: 6164 6564 2061 7320 7061 7274 206f 6620  aded as part of 
-0000a1e0: 7468 6520 6669 6c65 5f6d 6f75 6e74 7329  the file_mounts)
-0000a1f0: 2c20 736f 2074 6865 2072 6573 746f 7265  , so the restore
-0000a200: 2066 6f72 2062 6163 6b77 6172 640a 2020   for backward.  
-0000a210: 2020 2320 636f 6d70 6174 6962 696c 6974    # compatibilit
-0000a220: 7920 7368 6f75 6c64 2067 6f20 6265 666f  y should go befo
-0000a230: 7265 2074 6869 7320 6361 6c6c 2e0a 2020  re this call..  
-0000a240: 2020 5f6f 7074 696d 697a 655f 6669 6c65    _optimize_file
-0000a250: 5f6d 6f75 6e74 7328 746d 705f 7961 6d6c  _mounts(tmp_yaml
-0000a260: 5f70 6174 6829 0a0a 2020 2020 2320 5265  _path)..    # Re
-0000a270: 6e61 6d65 2074 6865 2074 6d70 2066 696c  name the tmp fil
-0000a280: 6520 746f 2074 6865 2066 696e 616c 2059  e to the final Y
-0000a290: 414d 4c20 7061 7468 2e0a 2020 2020 6f73  AML path..    os
-0000a2a0: 2e72 656e 616d 6528 746d 705f 7961 6d6c  .rename(tmp_yaml
-0000a2b0: 5f70 6174 682c 2079 616d 6c5f 7061 7468  _path, yaml_path
-0000a2c0: 290a 2020 2020 7573 6167 655f 6c69 622e  ).    usage_lib.
-0000a2d0: 6d65 7373 6167 6573 2e75 7361 6765 2e75  messages.usage.u
-0000a2e0: 7064 6174 655f 7261 795f 7961 6d6c 2879  pdate_ray_yaml(y
-0000a2f0: 616d 6c5f 7061 7468 290a 2020 2020 7265  aml_path).    re
-0000a300: 7475 726e 2063 6f6e 6669 675f 6469 6374  turn config_dict
-0000a310: 0a0a 0a64 6566 205f 6164 645f 6175 7468  ...def _add_auth
-0000a320: 5f74 6f5f 636c 7573 7465 725f 636f 6e66  _to_cluster_conf
-0000a330: 6967 2863 6c6f 7564 3a20 636c 6f75 6473  ig(cloud: clouds
-0000a340: 2e43 6c6f 7564 2c20 636c 7573 7465 725f  .Cloud, cluster_
-0000a350: 636f 6e66 6967 5f66 696c 653a 2073 7472  config_file: str
-0000a360: 293a 0a20 2020 2022 2222 4164 6473 2053  ):.    """Adds S
-0000a370: 5348 206b 6579 2069 6e66 6f20 746f 2074  SH key info to t
-0000a380: 6865 2063 6c75 7374 6572 2063 6f6e 6669  he cluster confi
-0000a390: 672e 0a0a 2020 2020 5468 6973 2066 756e  g...    This fun
-0000a3a0: 6374 696f 6e27 7320 6f75 7470 7574 2072  ction's output r
-0000a3b0: 656d 6f76 6573 2063 6f6d 6d65 6e74 7320  emoves comments 
-0000a3c0: 696e 636c 7564 6564 2069 6e20 7468 6520  included in the 
-0000a3d0: 6a69 6e6a 6132 2074 656d 706c 6174 652e  jinja2 template.
-0000a3e0: 0a20 2020 2022 2222 0a20 2020 2063 6f6e  .    """.    con
-0000a3f0: 6669 6720 3d20 636f 6d6d 6f6e 5f75 7469  fig = common_uti
-0000a400: 6c73 2e72 6561 645f 7961 6d6c 2863 6c75  ls.read_yaml(clu
-0000a410: 7374 6572 5f63 6f6e 6669 675f 6669 6c65  ster_config_file
-0000a420: 290a 2020 2020 2320 4368 6563 6b20 7468  ).    # Check th
-0000a430: 6520 6176 6169 6c61 6269 6c69 7479 206f  e availability o
-0000a440: 6620 7468 6520 636c 6f75 6420 7479 7065  f the cloud type
-0000a450: 2e0a 2020 2020 6966 2069 7369 6e73 7461  ..    if isinsta
-0000a460: 6e63 6528 636c 6f75 642c 2028 636c 6f75  nce(cloud, (clou
-0000a470: 6473 2e41 5753 2c20 636c 6f75 6473 2e4f  ds.AWS, clouds.O
-0000a480: 4349 2c20 636c 6f75 6473 2e53 4350 2c20  CI, clouds.SCP, 
-0000a490: 636c 6f75 6473 2e56 7370 6865 7265 2c0a  clouds.Vsphere,.
-0000a4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a4b0: 2020 2020 2020 2020 2020 636c 6f75 6473            clouds
-0000a4c0: 2e43 7564 6f2c 2063 6c6f 7564 732e 5061  .Cudo, clouds.Pa
-0000a4d0: 7065 7273 7061 6365 2929 3a0a 2020 2020  perspace)):.    
-0000a4e0: 2020 2020 636f 6e66 6967 203d 2061 7574      config = aut
-0000a4f0: 682e 636f 6e66 6967 7572 655f 7373 685f  h.configure_ssh_
-0000a500: 696e 666f 2863 6f6e 6669 6729 0a20 2020  info(config).   
-0000a510: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
-0000a520: 2863 6c6f 7564 2c20 636c 6f75 6473 2e47  (cloud, clouds.G
-0000a530: 4350 293a 0a20 2020 2020 2020 2063 6f6e  CP):.        con
-0000a540: 6669 6720 3d20 6175 7468 2e73 6574 7570  fig = auth.setup
-0000a550: 5f67 6370 5f61 7574 6865 6e74 6963 6174  _gcp_authenticat
-0000a560: 696f 6e28 636f 6e66 6967 290a 2020 2020  ion(config).    
-0000a570: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-0000a580: 636c 6f75 642c 2063 6c6f 7564 732e 417a  cloud, clouds.Az
-0000a590: 7572 6529 3a0a 2020 2020 2020 2020 636f  ure):.        co
-0000a5a0: 6e66 6967 203d 2061 7574 682e 7365 7475  nfig = auth.setu
-0000a5b0: 705f 617a 7572 655f 6175 7468 656e 7469  p_azure_authenti
-0000a5c0: 6361 7469 6f6e 2863 6f6e 6669 6729 0a20  cation(config). 
-0000a5d0: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
-0000a5e0: 6365 2863 6c6f 7564 2c20 636c 6f75 6473  ce(cloud, clouds
-0000a5f0: 2e4c 616d 6264 6129 3a0a 2020 2020 2020  .Lambda):.      
-0000a600: 2020 636f 6e66 6967 203d 2061 7574 682e    config = auth.
-0000a610: 7365 7475 705f 6c61 6d62 6461 5f61 7574  setup_lambda_aut
-0000a620: 6865 6e74 6963 6174 696f 6e28 636f 6e66  hentication(conf
-0000a630: 6967 290a 2020 2020 656c 6966 2069 7369  ig).    elif isi
-0000a640: 6e73 7461 6e63 6528 636c 6f75 642c 2063  nstance(cloud, c
-0000a650: 6c6f 7564 732e 4b75 6265 726e 6574 6573  louds.Kubernetes
-0000a660: 293a 0a20 2020 2020 2020 2063 6f6e 6669  ):.        confi
-0000a670: 6720 3d20 6175 7468 2e73 6574 7570 5f6b  g = auth.setup_k
-0000a680: 7562 6572 6e65 7465 735f 6175 7468 656e  ubernetes_authen
-0000a690: 7469 6361 7469 6f6e 2863 6f6e 6669 6729  tication(config)
-0000a6a0: 0a20 2020 2065 6c69 6620 6973 696e 7374  .    elif isinst
-0000a6b0: 616e 6365 2863 6c6f 7564 2c20 636c 6f75  ance(cloud, clou
-0000a6c0: 6473 2e49 424d 293a 0a20 2020 2020 2020  ds.IBM):.       
-0000a6d0: 2063 6f6e 6669 6720 3d20 6175 7468 2e73   config = auth.s
-0000a6e0: 6574 7570 5f69 626d 5f61 7574 6865 6e74  etup_ibm_authent
-0000a6f0: 6963 6174 696f 6e28 636f 6e66 6967 290a  ication(config).
-0000a700: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-0000a710: 6e63 6528 636c 6f75 642c 2063 6c6f 7564  nce(cloud, cloud
-0000a720: 732e 5275 6e50 6f64 293a 0a20 2020 2020  s.RunPod):.     
-0000a730: 2020 2063 6f6e 6669 6720 3d20 6175 7468     config = auth
-0000a740: 2e73 6574 7570 5f72 756e 706f 645f 6175  .setup_runpod_au
-0000a750: 7468 656e 7469 6361 7469 6f6e 2863 6f6e  thentication(con
-0000a760: 6669 6729 0a20 2020 2065 6c69 6620 6973  fig).    elif is
-0000a770: 696e 7374 616e 6365 2863 6c6f 7564 2c20  instance(cloud, 
-0000a780: 636c 6f75 6473 2e46 6c75 6964 7374 6163  clouds.Fluidstac
-0000a790: 6b29 3a0a 2020 2020 2020 2020 636f 6e66  k):.        conf
-0000a7a0: 6967 203d 2061 7574 682e 7365 7475 705f  ig = auth.setup_
-0000a7b0: 666c 7569 6473 7461 636b 5f61 7574 6865  fluidstack_authe
-0000a7c0: 6e74 6963 6174 696f 6e28 636f 6e66 6967  ntication(config
-0000a7d0: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
-0000a7e0: 2020 2020 6173 7365 7274 2046 616c 7365      assert False
-0000a7f0: 2c20 636c 6f75 640a 2020 2020 636f 6d6d  , cloud.    comm
-0000a800: 6f6e 5f75 7469 6c73 2e64 756d 705f 7961  on_utils.dump_ya
-0000a810: 6d6c 2863 6c75 7374 6572 5f63 6f6e 6669  ml(cluster_confi
-0000a820: 675f 6669 6c65 2c20 636f 6e66 6967 290a  g_file, config).
-0000a830: 0a0a 6465 6620 6765 745f 7275 6e5f 7469  ..def get_run_ti
-0000a840: 6d65 7374 616d 7028 2920 2d3e 2073 7472  mestamp() -> str
-0000a850: 3a0a 2020 2020 7265 7475 726e 2027 736b  :.    return 'sk
-0000a860: 792d 2720 2b20 6461 7465 7469 6d65 2e6e  y-' + datetime.n
-0000a870: 6f77 2829 2e73 7472 6674 696d 6528 2725  ow().strftime('%
-0000a880: 592d 256d 2d25 642d 2548 2d25 4d2d 2553  Y-%m-%d-%H-%M-%S
-0000a890: 2d25 6627 290a 0a0a 6465 6620 6765 745f  -%f')...def get_
-0000a8a0: 7469 6d65 7374 616d 705f 6672 6f6d 5f72  timestamp_from_r
-0000a8b0: 756e 5f74 696d 6573 7461 6d70 2872 756e  un_timestamp(run
-0000a8c0: 5f74 696d 6573 7461 6d70 3a20 7374 7229  _timestamp: str)
-0000a8d0: 202d 3e20 666c 6f61 743a 0a20 2020 2072   -> float:.    r
-0000a8e0: 6574 7572 6e20 6461 7465 7469 6d65 2e73  eturn datetime.s
-0000a8f0: 7472 7074 696d 6528 0a20 2020 2020 2020  trptime(.       
-0000a900: 2072 756e 5f74 696d 6573 7461 6d70 2e70   run_timestamp.p
-0000a910: 6172 7469 7469 6f6e 2827 2d27 295b 325d  artition('-')[2]
-0000a920: 2c20 2725 592d 256d 2d25 642d 2548 2d25  , '%Y-%m-%d-%H-%
-0000a930: 4d2d 2553 2d25 6627 292e 7469 6d65 7374  M-%S-%f').timest
-0000a940: 616d 7028 290a 0a0a 6465 6620 5f63 6f75  amp()...def _cou
-0000a950: 6e74 5f68 6561 6c74 6879 5f6e 6f64 6573  nt_healthy_nodes
-0000a960: 5f66 726f 6d5f 7261 7928 6f75 7470 7574  _from_ray(output
-0000a970: 3a20 7374 722c 0a20 2020 2020 2020 2020  : str,.         
-0000a980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a990: 2020 2020 2020 2020 2069 735f 6c6f 6361           is_loca
-0000a9a0: 6c5f 636c 6f75 643a 2062 6f6f 6c20 3d20  l_cloud: bool = 
-0000a9b0: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
-0000a9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a9d0: 2020 2020 2020 2029 202d 3e20 5475 706c         ) -> Tupl
-0000a9e0: 655b 696e 742c 2069 6e74 5d3a 0a20 2020  e[int, int]:.   
-0000a9f0: 2022 2222 436f 756e 7420 7468 6520 6e75   """Count the nu
-0000aa00: 6d62 6572 206f 6620 6865 616c 7468 7920  mber of healthy 
-0000aa10: 6e6f 6465 7320 6672 6f6d 2074 6865 206f  nodes from the o
-0000aa20: 7574 7075 7420 6f66 2060 7261 7920 7374  utput of `ray st
-0000aa30: 6174 7573 602e 2222 220a 0a20 2020 2064  atus`."""..    d
-0000aa40: 6566 2067 6574 5f72 6561 6479 5f6e 6f64  ef get_ready_nod
-0000aa50: 6573 5f63 6f75 6e74 7328 7061 7474 6572  es_counts(patter
-0000aa60: 6e2c 206f 7574 7075 7429 3a0a 2020 2020  n, output):.    
-0000aa70: 2020 2020 7265 7375 6c74 203d 2070 6174      result = pat
-0000aa80: 7465 726e 2e66 696e 6461 6c6c 286f 7574  tern.findall(out
-0000aa90: 7075 7429 0a20 2020 2020 2020 2069 6620  put).        if 
-0000aaa0: 6e6f 7420 7265 7375 6c74 3a0a 2020 2020  not result:.    
-0000aab0: 2020 2020 2020 2020 7265 7475 726e 2030          return 0
-0000aac0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0000aad0: 6c65 6e28 7265 7375 6c74 2920 3d3d 2031  len(result) == 1
-0000aae0: 2c20 7265 7375 6c74 0a20 2020 2020 2020  , result.       
-0000aaf0: 2072 6574 7572 6e20 696e 7428 7265 7375   return int(resu
-0000ab00: 6c74 5b30 5d29 0a0a 2020 2020 2320 4368  lt[0])..    # Ch
-0000ab10: 6563 6b20 6966 2074 6865 2072 6179 2063  eck if the ray c
-0000ab20: 6c75 7374 6572 2069 7320 7374 6172 7465  luster is starte
-0000ab30: 6420 7769 7468 2072 6179 2061 7574 6f73  d with ray autos
-0000ab40: 6361 6c65 722e 2049 6e20 6e65 770a 2020  caler. In new.  
-0000ab50: 2020 2320 7072 6f76 6973 696f 6e65 7220    # provisioner 
-0000ab60: 2823 3137 3032 2920 616e 6420 6c6f 6361  (#1702) and loca
-0000ab70: 6c20 6d6f 6465 2c20 7765 2073 7461 7274  l mode, we start
-0000ab80: 6564 2074 6865 2072 6179 2063 6c75 7374  ed the ray clust
-0000ab90: 6572 2077 6974 686f 7574 2072 6179 0a20  er without ray. 
-0000aba0: 2020 2023 2061 7574 6f73 6361 6c65 722e     # autoscaler.
-0000abb0: 0a20 2020 2023 2049 6620 7261 7920 636c  .    # If ray cl
-0000abc0: 7573 7465 7220 6973 2073 7461 7274 6564  uster is started
-0000abd0: 2077 6974 6820 7261 7920 6175 746f 7363   with ray autosc
-0000abe0: 616c 6572 2c20 7468 6520 6f75 7470 7574  aler, the output
-0000abf0: 2077 696c 6c20 6265 3a0a 2020 2020 2320   will be:.    # 
-0000ac00: 2031 2072 6179 2e68 6561 642e 6465 6661   1 ray.head.defa
-0000ac10: 756c 740a 2020 2020 2320 202e 2e2e 0a20  ult.    #  .... 
-0000ac20: 2020 2023 2054 4f44 4f28 7a68 7775 293a     # TODO(zhwu):
-0000ac30: 206f 6e63 6520 7765 2064 6570 7265 6361   once we depreca
-0000ac40: 7465 2074 6865 206f 6c64 2070 726f 7669  te the old provi
-0000ac50: 7369 6f6e 6572 2c20 7765 2063 616e 2072  sioner, we can r
-0000ac60: 656d 6f76 6520 7468 6973 0a20 2020 2023  emove this.    #
-0000ac70: 2063 6865 636b 2e0a 2020 2020 7261 795f   check..    ray_
-0000ac80: 6175 746f 7363 616c 6572 5f68 6561 6420  autoscaler_head 
-0000ac90: 3d20 6765 745f 7265 6164 795f 6e6f 6465  = get_ready_node
-0000aca0: 735f 636f 756e 7473 285f 4c41 554e 4348  s_counts(_LAUNCH
-0000acb0: 4544 5f48 4541 445f 5041 5454 4552 4e2c  ED_HEAD_PATTERN,
-0000acc0: 206f 7574 7075 7429 0a20 2020 2069 735f   output).    is_
-0000acd0: 6c6f 6361 6c5f 7261 795f 636c 7573 7465  local_ray_cluste
-0000ace0: 7220 3d20 7261 795f 6175 746f 7363 616c  r = ray_autoscal
-0000acf0: 6572 5f68 6561 6420 3d3d 2030 0a0a 2020  er_head == 0..  
-0000ad00: 2020 6966 2069 735f 6c6f 6361 6c5f 7261    if is_local_ra
-0000ad10: 795f 636c 7573 7465 7220 6f72 2069 735f  y_cluster or is_
-0000ad20: 6c6f 6361 6c5f 636c 6f75 643a 0a20 2020  local_cloud:.   
-0000ad30: 2020 2020 2023 2052 6179 2063 6c75 7374       # Ray clust
-0000ad40: 6572 2069 7320 6c61 756e 6368 6564 2077  er is launched w
-0000ad50: 6974 6820 6e65 7720 7072 6f76 6973 696f  ith new provisio
-0000ad60: 6e65 720a 2020 2020 2020 2020 2320 466f  ner.        # Fo
-0000ad70: 7220 6e65 7720 7072 6f76 6973 696f 6e65  r new provisione
-0000ad80: 7220 616e 6420 6c6f 6361 6c20 6d6f 6465  r and local mode
-0000ad90: 2c20 7468 6520 6f75 7470 7574 2077 696c  , the output wil
-0000ada0: 6c20 6265 3a0a 2020 2020 2020 2020 2320  l be:.        # 
-0000adb0: 2031 206e 6f64 655f 7878 7878 0a20 2020   1 node_xxxx.   
-0000adc0: 2020 2020 2023 2020 3120 6e6f 6465 5f78       #  1 node_x
-0000add0: 7878 780a 2020 2020 2020 2020 7265 6164  xxx.        read
-0000ade0: 795f 6865 6164 203d 2030 0a20 2020 2020  y_head = 0.     
-0000adf0: 2020 2072 6561 6479 5f77 6f72 6b65 7273     ready_workers
-0000ae00: 203d 205f 4c41 554e 4348 4544 5f4c 4f43   = _LAUNCHED_LOC
-0000ae10: 414c 5f57 4f52 4b45 525f 5041 5454 4552  AL_WORKER_PATTER
-0000ae20: 4e2e 6669 6e64 616c 6c28 6f75 7470 7574  N.findall(output
-0000ae30: 290a 2020 2020 2020 2020 7265 6164 795f  ).        ready_
-0000ae40: 776f 726b 6572 7320 3d20 6c65 6e28 7265  workers = len(re
-0000ae50: 6164 795f 776f 726b 6572 7329 0a20 2020  ady_workers).   
-0000ae60: 2020 2020 2069 6620 6973 5f6c 6f63 616c       if is_local
-0000ae70: 5f72 6179 5f63 6c75 7374 6572 3a0a 2020  _ray_cluster:.  
-0000ae80: 2020 2020 2020 2020 2020 7265 6164 795f            ready_
-0000ae90: 6865 6164 203d 2031 0a20 2020 2020 2020  head = 1.       
-0000aea0: 2020 2020 2072 6561 6479 5f77 6f72 6b65       ready_worke
-0000aeb0: 7273 202d 3d20 310a 2020 2020 2020 2020  rs -= 1.        
-0000aec0: 7265 7475 726e 2072 6561 6479 5f68 6561  return ready_hea
-0000aed0: 642c 2072 6561 6479 5f77 6f72 6b65 7273  d, ready_workers
-0000aee0: 0a0a 2020 2020 2320 436f 756e 7420 6e75  ..    # Count nu
-0000aef0: 6d62 6572 206f 6620 6e6f 6465 7320 6279  mber of nodes by
-0000af00: 2070 6172 7369 6e67 2074 6865 206f 7574   parsing the out
-0000af10: 7075 7420 6f66 2060 7261 7920 7374 6174  put of `ray stat
-0000af20: 7573 602e 2054 6865 206f 7574 7075 740a  us`. The output.
-0000af30: 2020 2020 2320 6c6f 6f6b 7320 6c69 6b65      # looks like
-0000af40: 3a0a 2020 2020 2320 2020 3120 7261 792e  :.    #   1 ray.
-0000af50: 6865 6164 2e64 6566 6175 6c74 0a20 2020  head.default.   
-0000af60: 2023 2020 2032 2072 6179 2e77 6f72 6b65   #   2 ray.worke
-0000af70: 722e 6465 6661 756c 740a 2020 2020 7265  r.default.    re
-0000af80: 6164 795f 6865 6164 203d 2072 6179 5f61  ady_head = ray_a
-0000af90: 7574 6f73 6361 6c65 725f 6865 6164 0a20  utoscaler_head. 
-0000afa0: 2020 2072 6561 6479 5f77 6f72 6b65 7273     ready_workers
-0000afb0: 203d 2067 6574 5f72 6561 6479 5f6e 6f64   = get_ready_nod
-0000afc0: 6573 5f63 6f75 6e74 7328 5f4c 4155 4e43  es_counts(_LAUNC
-0000afd0: 4845 445f 574f 524b 4552 5f50 4154 5445  HED_WORKER_PATTE
-0000afe0: 524e 2c20 6f75 7470 7574 290a 2020 2020  RN, output).    
-0000aff0: 7265 6164 795f 7265 7365 7276 6564 5f77  ready_reserved_w
-0000b000: 6f72 6b65 7273 203d 2067 6574 5f72 6561  orkers = get_rea
-0000b010: 6479 5f6e 6f64 6573 5f63 6f75 6e74 7328  dy_nodes_counts(
-0000b020: 0a20 2020 2020 2020 205f 4c41 554e 4348  .        _LAUNCH
-0000b030: 4544 5f52 4553 4552 5645 445f 574f 524b  ED_RESERVED_WORK
-0000b040: 4552 5f50 4154 5445 524e 2c20 6f75 7470  ER_PATTERN, outp
-0000b050: 7574 290a 2020 2020 7265 6164 795f 776f  ut).    ready_wo
-0000b060: 726b 6572 7320 2b3d 2072 6561 6479 5f72  rkers += ready_r
-0000b070: 6573 6572 7665 645f 776f 726b 6572 730a  eserved_workers.
-0000b080: 2020 2020 6173 7365 7274 2072 6561 6479      assert ready
-0000b090: 5f68 6561 6420 3c3d 2031 2c20 6627 2368  _head <= 1, f'#h
-0000b0a0: 6561 6420 6e6f 6465 2073 686f 756c 6420  ead node should 
-0000b0b0: 6265 203c 3d31 2028 476f 7420 7b72 6561  be <=1 (Got {rea
-0000b0c0: 6479 5f68 6561 647d 292e 270a 2020 2020  dy_head}).'.    
-0000b0d0: 7265 7475 726e 2072 6561 6479 5f68 6561  return ready_hea
-0000b0e0: 642c 2072 6561 6479 5f77 6f72 6b65 7273  d, ready_workers
-0000b0f0: 0a0a 0a64 6566 2067 6574 5f64 6f63 6b65  ...def get_docke
-0000b100: 725f 7573 6572 2869 703a 2073 7472 2c20  r_user(ip: str, 
-0000b110: 636c 7573 7465 725f 636f 6e66 6967 5f66  cluster_config_f
-0000b120: 696c 653a 2073 7472 2920 2d3e 2073 7472  ile: str) -> str
-0000b130: 3a0a 2020 2020 2222 2246 696e 6420 646f  :.    """Find do
-0000b140: 636b 6572 2063 6f6e 7461 696e 6572 2075  cker container u
-0000b150: 7365 726e 616d 652e 2222 220a 2020 2020  sername.""".    
-0000b160: 7373 685f 6372 6564 656e 7469 616c 7320  ssh_credentials 
-0000b170: 3d20 7373 685f 6372 6564 656e 7469 616c  = ssh_credential
-0000b180: 5f66 726f 6d5f 7961 6d6c 2863 6c75 7374  _from_yaml(clust
-0000b190: 6572 5f63 6f6e 6669 675f 6669 6c65 290a  er_config_file).
-0000b1a0: 2020 2020 7275 6e6e 6572 203d 2063 6f6d      runner = com
-0000b1b0: 6d61 6e64 5f72 756e 6e65 722e 5353 4843  mand_runner.SSHC
-0000b1c0: 6f6d 6d61 6e64 5275 6e6e 6572 2869 702c  ommandRunner(ip,
-0000b1d0: 2070 6f72 743d 3232 2c20 2a2a 7373 685f   port=22, **ssh_
-0000b1e0: 6372 6564 656e 7469 616c 7329 0a20 2020  credentials).   
-0000b1f0: 2063 6f6e 7461 696e 6572 5f6e 616d 6520   container_name 
-0000b200: 3d20 636f 6e73 7461 6e74 732e 4445 4641  = constants.DEFA
-0000b210: 554c 545f 444f 434b 4552 5f43 4f4e 5441  ULT_DOCKER_CONTA
-0000b220: 494e 4552 5f4e 414d 450a 2020 2020 7768  INER_NAME.    wh
-0000b230: 6f61 6d69 5f72 6574 7572 6e63 6f64 652c  oami_returncode,
-0000b240: 2077 686f 616d 695f 7374 646f 7574 2c20   whoami_stdout, 
-0000b250: 7768 6f61 6d69 5f73 7464 6572 7220 3d20  whoami_stderr = 
-0000b260: 7275 6e6e 6572 2e72 756e 280a 2020 2020  runner.run(.    
-0000b270: 2020 2020 6627 7375 646f 2064 6f63 6b65      f'sudo docke
-0000b280: 7220 6578 6563 207b 636f 6e74 6169 6e65  r exec {containe
-0000b290: 725f 6e61 6d65 7d20 7768 6f61 6d69 272c  r_name} whoami',
-0000b2a0: 0a20 2020 2020 2020 2073 7472 6561 6d5f  .        stream_
-0000b2b0: 6c6f 6773 3d46 616c 7365 2c0a 2020 2020  logs=False,.    
-0000b2c0: 2020 2020 7265 7175 6972 655f 6f75 7470      require_outp
-0000b2d0: 7574 733d 5472 7565 290a 2020 2020 6173  uts=True).    as
-0000b2e0: 7365 7274 2077 686f 616d 695f 7265 7475  sert whoami_retu
-0000b2f0: 726e 636f 6465 203d 3d20 302c 2028 0a20  rncode == 0, (. 
-0000b300: 2020 2020 2020 2066 2746 6169 6c65 6420         f'Failed 
-0000b310: 746f 2067 6574 2064 6f63 6b65 7220 636f  to get docker co
-0000b320: 6e74 6169 6e65 7220 7573 6572 2e20 5265  ntainer user. Re
-0000b330: 7475 726e 2027 0a20 2020 2020 2020 2066  turn '.        f
-0000b340: 2763 6f64 653a 207b 7768 6f61 6d69 5f72  'code: {whoami_r
-0000b350: 6574 7572 6e63 6f64 657d 2c20 4572 726f  eturncode}, Erro
-0000b360: 723a 207b 7768 6f61 6d69 5f73 7464 6572  r: {whoami_stder
-0000b370: 727d 2729 0a20 2020 2064 6f63 6b65 725f  r}').    docker_
-0000b380: 7573 6572 203d 2077 686f 616d 695f 7374  user = whoami_st
-0000b390: 646f 7574 2e73 7472 6970 2829 0a20 2020  dout.strip().   
-0000b3a0: 206c 6f67 6765 722e 6465 6275 6728 6627   logger.debug(f'
-0000b3b0: 446f 636b 6572 2063 6f6e 7461 696e 6572  Docker container
-0000b3c0: 2075 7365 723a 207b 646f 636b 6572 5f75   user: {docker_u
-0000b3d0: 7365 727d 2729 0a20 2020 2072 6574 7572  ser}').    retur
-0000b3e0: 6e20 646f 636b 6572 5f75 7365 720a 0a0a  n docker_user...
-0000b3f0: 4074 696d 656c 696e 652e 6576 656e 740a  @timeline.event.
-0000b400: 6465 6620 7761 6974 5f75 6e74 696c 5f72  def wait_until_r
-0000b410: 6179 5f63 6c75 7374 6572 5f72 6561 6479  ay_cluster_ready
-0000b420: 280a 2020 2020 636c 7573 7465 725f 636f  (.    cluster_co
-0000b430: 6e66 6967 5f66 696c 653a 2073 7472 2c0a  nfig_file: str,.
-0000b440: 2020 2020 6e75 6d5f 6e6f 6465 733a 2069      num_nodes: i
-0000b450: 6e74 2c0a 2020 2020 6c6f 675f 7061 7468  nt,.    log_path
-0000b460: 3a20 7374 722c 0a20 2020 2069 735f 6c6f  : str,.    is_lo
-0000b470: 6361 6c5f 636c 6f75 643a 2062 6f6f 6c20  cal_cloud: bool 
-0000b480: 3d20 4661 6c73 652c 0a20 2020 206e 6f64  = False,.    nod
-0000b490: 6573 5f6c 6175 6e63 6869 6e67 5f70 726f  es_launching_pro
-0000b4a0: 6772 6573 735f 7469 6d65 6f75 743a 204f  gress_timeout: O
-0000b4b0: 7074 696f 6e61 6c5b 696e 745d 203d 204e  ptional[int] = N
-0000b4c0: 6f6e 652c 0a29 202d 3e20 5475 706c 655b  one,.) -> Tuple[
-0000b4d0: 626f 6f6c 2c20 4f70 7469 6f6e 616c 5b73  bool, Optional[s
-0000b4e0: 7472 5d5d 3a0a 2020 2020 2222 2257 6169  tr]]:.    """Wai
-0000b4f0: 7420 756e 7469 6c20 7468 6520 7261 7920  t until the ray 
-0000b500: 636c 7573 7465 7220 6973 2073 6574 2075  cluster is set u
-0000b510: 7020 6f6e 2056 4d73 206f 7220 696e 2063  p on VMs or in c
-0000b520: 6f6e 7461 696e 6572 732e 0a0a 2020 2020  ontainers...    
-0000b530: 5265 7475 726e 733a 2020 7768 6574 6865  Returns:  whethe
-0000b540: 7220 7468 6520 656e 7469 7265 2072 6179  r the entire ray
-0000b550: 2063 6c75 7374 6572 2069 7320 7265 6164   cluster is read
-0000b560: 792c 2061 6e64 2064 6f63 6b65 7220 7573  y, and docker us
-0000b570: 6572 6e61 6d65 0a20 2020 2069 6620 6c61  ername.    if la
-0000b580: 756e 6368 6564 2077 6974 6820 646f 636b  unched with dock
-0000b590: 6572 2e0a 2020 2020 2222 220a 2020 2020  er..    """.    
-0000b5a0: 2320 4d61 6e75 616c 6c79 2066 6574 6368  # Manually fetch
-0000b5b0: 696e 6720 6865 6164 2069 7020 696e 7374  ing head ip inst
-0000b5c0: 6561 6420 6f66 2075 7369 6e67 2060 7261  ead of using `ra
-0000b5d0: 7920 6578 6563 6020 746f 2061 766f 6964  y exec` to avoid
-0000b5e0: 2074 6865 2062 7567 0a20 2020 2023 2074   the bug.    # t
-0000b5f0: 6861 7420 6072 6179 2065 7865 6360 2066  hat `ray exec` f
-0000b600: 6169 6c73 2074 6f20 636f 6e6e 6563 7420  ails to connect 
-0000b610: 746f 2074 6865 2068 6561 6420 6e6f 6465  to the head node
-0000b620: 2061 6674 6572 2073 6f6d 6520 776f 726b   after some work
-0000b630: 6572 730a 2020 2020 2320 6c61 756e 6368  ers.    # launch
-0000b640: 6564 2065 7370 6563 6961 6c6c 7920 666f  ed especially fo
-0000b650: 7220 417a 7572 652e 0a20 2020 2074 7279  r Azure..    try
-0000b660: 3a0a 2020 2020 2020 2020 6865 6164 5f69  :.        head_i
-0000b670: 7020 3d20 5f71 7565 7279 5f68 6561 645f  p = _query_head_
-0000b680: 6970 5f77 6974 685f 7265 7472 6965 7328  ip_with_retries(
-0000b690: 0a20 2020 2020 2020 2020 2020 2063 6c75  .            clu
-0000b6a0: 7374 6572 5f63 6f6e 6669 675f 6669 6c65  ster_config_file
-0000b6b0: 2c20 6d61 785f 6174 7465 6d70 7473 3d57  , max_attempts=W
-0000b6c0: 4149 545f 4845 4144 5f4e 4f44 455f 4950  AIT_HEAD_NODE_IP
-0000b6d0: 5f4d 4158 5f41 5454 454d 5054 5329 0a20  _MAX_ATTEMPTS). 
-0000b6e0: 2020 2065 7863 6570 7420 6578 6365 7074     except except
-0000b6f0: 696f 6e73 2e46 6574 6368 4950 4572 726f  ions.FetchIPErro
-0000b700: 7220 6173 2065 3a0a 2020 2020 2020 2020  r as e:.        
-0000b710: 6c6f 6767 6572 2e65 7272 6f72 2863 6f6d  logger.error(com
-0000b720: 6d6f 6e5f 7574 696c 732e 666f 726d 6174  mon_utils.format
-0000b730: 5f65 7863 6570 7469 6f6e 2865 2929 0a20  _exception(e)). 
-0000b740: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
-0000b750: 6c73 652c 204e 6f6e 6520 2023 2066 6169  lse, None  # fai
-0000b760: 6c65 640a 0a20 2020 2063 6f6e 6669 6720  led..    config 
-0000b770: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e72  = common_utils.r
-0000b780: 6561 645f 7961 6d6c 2863 6c75 7374 6572  ead_yaml(cluster
-0000b790: 5f63 6f6e 6669 675f 6669 6c65 290a 0a20  _config_file).. 
-0000b7a0: 2020 2064 6f63 6b65 725f 7573 6572 203d     docker_user =
-0000b7b0: 204e 6f6e 650a 2020 2020 6966 2027 646f   None.    if 'do
-0000b7c0: 636b 6572 2720 696e 2063 6f6e 6669 673a  cker' in config:
-0000b7d0: 0a20 2020 2020 2020 2064 6f63 6b65 725f  .        docker_
-0000b7e0: 7573 6572 203d 2067 6574 5f64 6f63 6b65  user = get_docke
-0000b7f0: 725f 7573 6572 2868 6561 645f 6970 2c20  r_user(head_ip, 
-0000b800: 636c 7573 7465 725f 636f 6e66 6967 5f66  cluster_config_f
-0000b810: 696c 6529 0a0a 2020 2020 6966 206e 756d  ile)..    if num
-0000b820: 5f6e 6f64 6573 203c 3d20 313a 0a20 2020  _nodes <= 1:.   
-0000b830: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
-0000b840: 2c20 646f 636b 6572 5f75 7365 720a 0a20  , docker_user.. 
-0000b850: 2020 2073 7368 5f63 7265 6465 6e74 6961     ssh_credentia
-0000b860: 6c73 203d 2073 7368 5f63 7265 6465 6e74  ls = ssh_credent
-0000b870: 6961 6c5f 6672 6f6d 5f79 616d 6c28 636c  ial_from_yaml(cl
-0000b880: 7573 7465 725f 636f 6e66 6967 5f66 696c  uster_config_fil
-0000b890: 652c 2064 6f63 6b65 725f 7573 6572 290a  e, docker_user).
-0000b8a0: 2020 2020 6c61 7374 5f6e 6f64 6573 5f73      last_nodes_s
-0000b8b0: 6f5f 6661 7220 3d20 300a 2020 2020 7374  o_far = 0.    st
-0000b8c0: 6172 7420 3d20 7469 6d65 2e74 696d 6528  art = time.time(
-0000b8d0: 290a 2020 2020 7275 6e6e 6572 203d 2063  ).    runner = c
-0000b8e0: 6f6d 6d61 6e64 5f72 756e 6e65 722e 5353  ommand_runner.SS
-0000b8f0: 4843 6f6d 6d61 6e64 5275 6e6e 6572 2868  HCommandRunner(h
-0000b900: 6561 645f 6970 2c0a 2020 2020 2020 2020  ead_ip,.        
-0000b910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b930: 2020 2020 2070 6f72 743d 3232 2c0a 2020       port=22,.  
-0000b940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b960: 2020 2020 2020 2020 2020 202a 2a73 7368             **ssh
-0000b970: 5f63 7265 6465 6e74 6961 6c73 290a 2020  _credentials).  
-0000b980: 2020 7769 7468 2072 6963 685f 7574 696c    with rich_util
-0000b990: 732e 7361 6665 5f73 7461 7475 7328 0a20  s.safe_status(. 
-0000b9a0: 2020 2020 2020 2020 2020 2027 5b62 6f6c             '[bol
-0000b9b0: 6420 6379 616e 5d57 6169 7469 6e67 2066  d cyan]Waiting f
-0000b9c0: 6f72 2077 6f72 6b65 7273 2e2e 2e27 2920  or workers...') 
-0000b9d0: 6173 2077 6f72 6b65 725f 7374 6174 7573  as worker_status
-0000b9e0: 3a0a 2020 2020 2020 2020 7768 696c 6520  :.        while 
-0000b9f0: 5472 7565 3a0a 2020 2020 2020 2020 2020  True:.          
-0000ba00: 2020 7263 2c20 6f75 7470 7574 2c20 7374    rc, output, st
-0000ba10: 6465 7272 203d 2072 756e 6e65 722e 7275  derr = runner.ru
-0000ba20: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-0000ba30: 2020 2069 6e73 7461 6e63 655f 7365 7475     instance_setu
-0000ba40: 702e 5241 595f 5354 4154 5553 5f57 4954  p.RAY_STATUS_WIT
-0000ba50: 485f 534b 595f 5241 595f 504f 5254 5f43  H_SKY_RAY_PORT_C
-0000ba60: 4f4d 4d41 4e44 2c0a 2020 2020 2020 2020  OMMAND,.        
-0000ba70: 2020 2020 2020 2020 6c6f 675f 7061 7468          log_path
-0000ba80: 3d6c 6f67 5f70 6174 682c 0a20 2020 2020  =log_path,.     
-0000ba90: 2020 2020 2020 2020 2020 2073 7472 6561             strea
-0000baa0: 6d5f 6c6f 6773 3d46 616c 7365 2c0a 2020  m_logs=False,.  
-0000bab0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0000bac0: 7175 6972 655f 6f75 7470 7574 733d 5472  quire_outputs=Tr
-0000bad0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-0000bae0: 2020 2020 7365 7061 7261 7465 5f73 7464      separate_std
-0000baf0: 6572 723d 5472 7565 290a 2020 2020 2020  err=True).      
-0000bb00: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
-0000bb10: 5f75 7469 6c73 2e68 616e 646c 655f 7265  _utils.handle_re
-0000bb20: 7475 726e 636f 6465 280a 2020 2020 2020  turncode(.      
-0000bb30: 2020 2020 2020 2020 2020 7263 2c20 696e            rc, in
-0000bb40: 7374 616e 6365 5f73 6574 7570 2e52 4159  stance_setup.RAY
-0000bb50: 5f53 5441 5455 535f 5749 5448 5f53 4b59  _STATUS_WITH_SKY
-0000bb60: 5f52 4159 5f50 4f52 545f 434f 4d4d 414e  _RAY_PORT_COMMAN
-0000bb70: 442c 0a20 2020 2020 2020 2020 2020 2020  D,.             
-0000bb80: 2020 2027 4661 696c 6564 2074 6f20 7275     'Failed to ru
-0000bb90: 6e20 7261 7920 7374 6174 7573 206f 6e20  n ray status on 
-0000bba0: 6865 6164 206e 6f64 652e 272c 2073 7464  head node.', std
-0000bbb0: 6572 7229 0a20 2020 2020 2020 2020 2020  err).           
-0000bbc0: 206c 6f67 6765 722e 6465 6275 6728 6f75   logger.debug(ou
-0000bbd0: 7470 7574 290a 0a20 2020 2020 2020 2020  tput)..         
-0000bbe0: 2020 2072 6561 6479 5f68 6561 642c 2072     ready_head, r
-0000bbf0: 6561 6479 5f77 6f72 6b65 7273 203d 205f  eady_workers = _
-0000bc00: 636f 756e 745f 6865 616c 7468 795f 6e6f  count_healthy_no
-0000bc10: 6465 735f 6672 6f6d 5f72 6179 280a 2020  des_from_ray(.  
-0000bc20: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
-0000bc30: 7470 7574 2c20 6973 5f6c 6f63 616c 5f63  tput, is_local_c
-0000bc40: 6c6f 7564 3d69 735f 6c6f 6361 6c5f 636c  loud=is_local_cl
-0000bc50: 6f75 6429 0a0a 2020 2020 2020 2020 2020  oud)..          
-0000bc60: 2020 776f 726b 6572 5f73 7461 7475 732e    worker_status.
-0000bc70: 7570 6461 7465 2827 5b62 6f6c 6420 6379  update('[bold cy
-0000bc80: 616e 5d27 0a20 2020 2020 2020 2020 2020  an]'.           
-0000bc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bca0: 2020 2020 2020 6627 7b72 6561 6479 5f77        f'{ready_w
-0000bcb0: 6f72 6b65 7273 7d20 6f75 7420 6f66 207b  orkers} out of {
-0000bcc0: 6e75 6d5f 6e6f 6465 7320 2d20 317d 2027  num_nodes - 1} '
-0000bcd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bcf0: 2020 2777 6f72 6b65 7273 2072 6561 6479    'workers ready
-0000bd00: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
-0000bd10: 2320 496e 2074 6865 206c 6f63 616c 2063  # In the local c
-0000bd20: 6173 652c 2072 6561 6479 5f68 6561 643d  ase, ready_head=
-0000bd30: 3020 616e 6420 7265 6164 795f 776f 726b  0 and ready_work
-0000bd40: 6572 733d 6e75 6d5f 6e6f 6465 732e 2054  ers=num_nodes. T
-0000bd50: 6869 730a 2020 2020 2020 2020 2020 2020  his.            
-0000bd60: 2320 6973 2062 6563 6175 7365 2074 6865  # is because the
-0000bd70: 7265 2069 7320 6e6f 206d 6174 6368 696e  re is no matchin
-0000bd80: 6720 7265 6765 7820 666f 7220 5f4c 4155  g regex for _LAU
-0000bd90: 4e43 4845 445f 4845 4144 5f50 4154 5445  NCHED_HEAD_PATTE
-0000bda0: 524e 2e0a 2020 2020 2020 2020 2020 2020  RN..            
-0000bdb0: 6966 2072 6561 6479 5f68 6561 6420 2b20  if ready_head + 
-0000bdc0: 7265 6164 795f 776f 726b 6572 7320 3d3d  ready_workers ==
-0000bdd0: 206e 756d 5f6e 6f64 6573 3a0a 2020 2020   num_nodes:.    
-0000bde0: 2020 2020 2020 2020 2020 2020 2320 416c              # Al
-0000bdf0: 6c20 6e6f 6465 7320 6172 6520 7570 2e0a  l nodes are up..
-0000be00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000be10: 6272 6561 6b0a 0a20 2020 2020 2020 2020  break..         
-0000be20: 2020 2023 2050 656e 6469 6e67 2077 6f72     # Pending wor
-0000be30: 6b65 7273 2074 6861 7420 6861 7665 2062  kers that have b
-0000be40: 6565 6e20 6c61 756e 6368 6564 2062 7920  een launched by 
-0000be50: 7261 7920 7570 2e0a 2020 2020 2020 2020  ray up..        
-0000be60: 2020 2020 666f 756e 645f 6970 7320 3d20      found_ips = 
-0000be70: 5f4c 4155 4e43 4849 4e47 5f49 505f 5041  _LAUNCHING_IP_PA
-0000be80: 5454 4552 4e2e 6669 6e64 616c 6c28 6f75  TTERN.findall(ou
-0000be90: 7470 7574 290a 2020 2020 2020 2020 2020  tput).          
-0000bea0: 2020 7065 6e64 696e 675f 776f 726b 6572    pending_worker
-0000beb0: 7320 3d20 6c65 6e28 666f 756e 645f 6970  s = len(found_ip
-0000bec0: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
-0000bed0: 2320 544f 444f 287a 6877 7529 3a20 4861  # TODO(zhwu): Ha
-0000bee0: 6e64 6c65 2074 6865 2063 6173 6520 7768  ndle the case wh
-0000bef0: 6572 6520 7468 6520 666f 6c6c 6f77 696e  ere the followin
-0000bf00: 6720 6f63 6375 7273 2c20 7768 6572 6520  g occurs, where 
-0000bf10: 7261 790a 2020 2020 2020 2020 2020 2020  ray.            
-0000bf20: 2320 636c 7573 7465 7220 6973 206e 6f74  # cluster is not
-0000bf30: 2063 6f72 7265 6374 6c79 2073 7461 7274   correctly start
-0000bf40: 6564 206f 6e20 7468 6520 636c 7573 7465  ed on the cluste
-0000bf50: 722e 0a20 2020 2020 2020 2020 2020 2023  r..            #
-0000bf60: 2050 656e 6469 6e67 3a0a 2020 2020 2020   Pending:.      
-0000bf70: 2020 2020 2020 2320 2031 3732 2e33 312e        #  172.31.
-0000bf80: 392e 3132 313a 2072 6179 2e77 6f72 6b65  9.121: ray.worke
-0000bf90: 722e 6465 6661 756c 742c 2075 6e69 6e69  r.default, unini
-0000bfa0: 7469 616c 697a 6564 0a20 2020 2020 2020  tialized.       
-0000bfb0: 2020 2020 206e 6f64 6573 5f73 6f5f 6661       nodes_so_fa
-0000bfc0: 7220 3d20 7265 6164 795f 6865 6164 202b  r = ready_head +
-0000bfd0: 2072 6561 6479 5f77 6f72 6b65 7273 202b   ready_workers +
-0000bfe0: 2070 656e 6469 6e67 5f77 6f72 6b65 7273   pending_workers
-0000bff0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000c000: 4368 6563 6b20 7468 6520 6e75 6d62 6572  Check the number
-0000c010: 206f 6620 6e6f 6465 7320 7468 6174 2061   of nodes that a
-0000c020: 7265 2066 6574 6368 6564 2e20 5469 6d65  re fetched. Time
-0000c030: 6f75 7420 6966 206e 6f20 6e65 770a 2020  out if no new.  
-0000c040: 2020 2020 2020 2020 2020 2320 6e6f 6465            # node
-0000c050: 7320 6665 7463 6865 6420 696e 2061 2077  s fetched in a w
-0000c060: 6869 6c65 2028 6e6f 6465 735f 6c61 756e  hile (nodes_laun
-0000c070: 6368 696e 675f 7072 6f67 7265 7373 5f74  ching_progress_t
-0000c080: 696d 656f 7574 292c 0a20 2020 2020 2020  imeout),.       
-0000c090: 2020 2020 2023 2074 686f 7567 6820 6e75       # though nu
-0000c0a0: 6d62 6572 206f 6620 6e6f 6465 735f 736f  mber of nodes_so
-0000c0b0: 5f66 6172 2069 7320 7374 696c 6c20 6e6f  _far is still no
-0000c0c0: 7420 6173 2065 7870 6563 7465 642e 0a20  t as expected.. 
-0000c0d0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-0000c0e0: 6465 735f 736f 5f66 6172 203e 206c 6173  des_so_far > las
-0000c0f0: 745f 6e6f 6465 735f 736f 5f66 6172 3a0a  t_nodes_so_far:.
-0000c100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c110: 2320 5265 7365 7420 7468 6520 7374 6172  # Reset the star
-0000c120: 7420 7469 6d65 2069 6620 7468 6520 6e75  t time if the nu
-0000c130: 6d62 6572 206f 6620 6c61 756e 6368 696e  mber of launchin
-0000c140: 6720 6e6f 6465 730a 2020 2020 2020 2020  g nodes.        
-0000c150: 2020 2020 2020 2020 2320 6368 616e 6765          # change
-0000c160: 732c 2069 2e65 2e20 6e65 7720 6e6f 6465  s, i.e. new node
-0000c170: 7320 6172 6520 6c61 756e 6368 6564 2e0a  s are launched..
-0000c180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c190: 6c6f 6767 6572 2e64 6562 7567 2827 5265  logger.debug('Re
-0000c1a0: 7365 7420 7374 6172 7420 7469 6d65 2c20  set start time, 
-0000c1b0: 6173 206e 6577 206e 6f64 6573 2061 7265  as new nodes are
-0000c1c0: 206c 6175 6e63 6865 642e 2027 0a20 2020   launched. '.   
-0000c1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c1e0: 2020 2020 2020 2020 2020 6627 287b 6c61            f'({la
-0000c1f0: 7374 5f6e 6f64 6573 5f73 6f5f 6661 727d  st_nodes_so_far}
-0000c200: 202d 3e20 7b6e 6f64 6573 5f73 6f5f 6661   -> {nodes_so_fa
-0000c210: 727d 2927 290a 2020 2020 2020 2020 2020  r})').          
-0000c220: 2020 2020 2020 7374 6172 7420 3d20 7469        start = ti
-0000c230: 6d65 2e74 696d 6528 290a 2020 2020 2020  me.time().      
-0000c240: 2020 2020 2020 2020 2020 6c61 7374 5f6e            last_n
-0000c250: 6f64 6573 5f73 6f5f 6661 7220 3d20 6e6f  odes_so_far = no
-0000c260: 6465 735f 736f 5f66 6172 0a20 2020 2020  des_so_far.     
-0000c270: 2020 2020 2020 2065 6c69 6620 286e 6f64         elif (nod
-0000c280: 6573 5f6c 6175 6e63 6869 6e67 5f70 726f  es_launching_pro
-0000c290: 6772 6573 735f 7469 6d65 6f75 7420 6973  gress_timeout is
-0000c2a0: 206e 6f74 204e 6f6e 6520 616e 640a 2020   not None and.  
-0000c2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c2c0: 7469 6d65 2e74 696d 6528 2920 2d20 7374  time.time() - st
-0000c2d0: 6172 7420 3e20 6e6f 6465 735f 6c61 756e  art > nodes_laun
-0000c2e0: 6368 696e 675f 7072 6f67 7265 7373 5f74  ching_progress_t
-0000c2f0: 696d 656f 7574 2061 6e64 0a20 2020 2020  imeout and.     
-0000c300: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-0000c310: 6573 5f73 6f5f 6661 7220 213d 206e 756d  es_so_far != num
-0000c320: 5f6e 6f64 6573 293a 0a20 2020 2020 2020  _nodes):.       
-0000c330: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-0000c340: 6572 726f 7228 0a20 2020 2020 2020 2020  error(.         
-0000c350: 2020 2020 2020 2020 2020 2027 5469 6d65             'Time
-0000c360: 6420 6f75 743a 2077 6169 7465 6420 666f  d out: waited fo
-0000c370: 7220 6d6f 7265 2074 6861 6e20 270a 2020  r more than '.  
+00008bc0: 2067 6c6f 6261 6c20 696e 7374 616e 6365   global instance
+00008bd0: 2074 6167 7320 6672 6f6d 207e 2f2e 736b   tags from ~/.sk
+00008be0: 792f 636f 6e66 6967 2e79 616d 6c2e 0a20  y/config.yaml.. 
+00008bf0: 2020 206c 6162 656c 7320 3d20 736b 7970     labels = skyp
+00008c00: 696c 6f74 5f63 6f6e 6669 672e 6765 745f  ilot_config.get_
+00008c10: 6e65 7374 6564 2828 7374 7228 636c 6f75  nested((str(clou
+00008c20: 6429 2e6c 6f77 6572 2829 2c20 276c 6162  d).lower(), 'lab
+00008c30: 656c 7327 292c 207b 7d29 0a20 2020 2023  els'), {}).    #
+00008c40: 2044 6570 7265 6361 7465 643a 2069 6e73   Deprecated: ins
+00008c50: 7461 6e63 655f 7461 6773 2068 6176 6520  tance_tags have 
+00008c60: 6265 656e 2072 6570 6c61 6365 6420 6279  been replaced by
+00008c70: 206c 6162 656c 732e 2046 6f72 2062 6163   labels. For bac
+00008c80: 6b77 6172 640a 2020 2020 2320 636f 6d70  kward.    # comp
+00008c90: 6174 6962 696c 6974 792c 2077 6520 7375  atibility, we su
+00008ca0: 7070 6f72 7420 7468 656d 2061 6e64 2074  pport them and t
+00008cb0: 6865 2073 6368 656d 6120 616c 6c6f 7773  he schema allows
+00008cc0: 2074 6865 6d20 6f6e 6c79 2069 660a 2020   them only if.  
+00008cd0: 2020 2320 606c 6162 656c 7360 2061 7265    # `labels` are
+00008ce0: 206e 6f74 2073 7065 6369 6669 6564 2e20   not specified. 
+00008cf0: 5468 6973 2073 686f 756c 6420 6265 2072  This should be r
+00008d00: 656d 6f76 6564 2061 6674 6572 2030 2e37  emoved after 0.7
+00008d10: 2e30 2e0a 2020 2020 6c61 6265 6c73 203d  .0..    labels =
+00008d20: 2073 6b79 7069 6c6f 745f 636f 6e66 6967   skypilot_config
+00008d30: 2e67 6574 5f6e 6573 7465 6428 2873 7472  .get_nested((str
+00008d40: 2863 6c6f 7564 292e 6c6f 7765 7228 292c  (cloud).lower(),
+00008d50: 2027 696e 7374 616e 6365 5f74 6167 7327   'instance_tags'
+00008d60: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00008d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008d80: 2020 2020 2020 2020 2020 206c 6162 656c             label
+00008d90: 7329 0a20 2020 2023 206c 6162 656c 7320  s).    # labels 
+00008da0: 6973 2061 2064 6963 742c 2077 6869 6368  is a dict, which
+00008db0: 2069 7320 6775 6172 616e 7465 6564 2062   is guaranteed b
+00008dc0: 7920 7468 6520 7479 7065 2063 6865 636b  y the type check
+00008dd0: 2069 6e0a 2020 2020 2320 7363 6865 6d61   in.    # schema
+00008de0: 732e 7079 0a20 2020 2061 7373 6572 7420  s.py.    assert 
+00008df0: 6973 696e 7374 616e 6365 286c 6162 656c  isinstance(label
+00008e00: 732c 2064 6963 7429 2c20 6c61 6265 6c73  s, dict), labels
+00008e10: 0a0a 2020 2020 2320 4765 7420 6c61 6265  ..    # Get labe
+00008e20: 6c73 2066 726f 6d20 7265 736f 7572 6365  ls from resource
+00008e30: 7320 616e 6420 6f76 6572 7269 6465 2066  s and override f
+00008e40: 726f 6d20 7468 6520 6c61 6265 6c73 2074  rom the labels t
+00008e50: 6f5f 7072 6f76 6973 696f 6e2e 0a20 2020  o_provision..   
+00008e60: 2069 6620 746f 5f70 726f 7669 7369 6f6e   if to_provision
+00008e70: 2e6c 6162 656c 733a 0a20 2020 2020 2020  .labels:.       
+00008e80: 206c 6162 656c 732e 7570 6461 7465 2874   labels.update(t
+00008e90: 6f5f 7072 6f76 6973 696f 6e2e 6c61 6265  o_provision.labe
+00008ea0: 6c73 290a 0a20 2020 2023 2044 756d 7020  ls)..    # Dump 
+00008eb0: 7468 6520 5261 7920 706f 7274 7320 746f  the Ray ports to
+00008ec0: 2061 2066 696c 6520 666f 7220 5261 7920   a file for Ray 
+00008ed0: 6a6f 6220 7375 626d 6973 7369 6f6e 0a20  job submission. 
+00008ee0: 2020 2064 756d 705f 706f 7274 5f63 6f6d     dump_port_com
+00008ef0: 6d61 6e64 203d 2028 0a20 2020 2020 2020  mand = (.       
+00008f00: 2066 277b 636f 6e73 7461 6e74 732e 534b   f'{constants.SK
+00008f10: 595f 5059 5448 4f4e 5f43 4d44 7d20 2d63  Y_PYTHON_CMD} -c
+00008f20: 205c 2769 6d70 6f72 7420 6a73 6f6e 2c20   \'import json, 
+00008f30: 6f73 3b20 6a73 6f6e 2e64 756d 7028 7b63  os; json.dump({c
+00008f40: 6f6e 7374 616e 7473 2e53 4b59 5f52 454d  onstants.SKY_REM
+00008f50: 4f54 455f 5241 595f 504f 5254 5f44 4943  OTE_RAY_PORT_DIC
+00008f60: 545f 5354 527d 2c20 270a 2020 2020 2020  T_STR}, '.      
+00008f70: 2020 6627 6f70 656e 286f 732e 7061 7468    f'open(os.path
+00008f80: 2e65 7870 616e 6475 7365 7228 227b 636f  .expanduser("{co
+00008f90: 6e73 7461 6e74 732e 534b 595f 5245 4d4f  nstants.SKY_REMO
+00008fa0: 5445 5f52 4159 5f50 4f52 545f 4649 4c45  TE_RAY_PORT_FILE
+00008fb0: 7d22 292c 2022 7722 2c20 656e 636f 6469  }"), "w", encodi
+00008fc0: 6e67 3d22 7574 662d 3822 2929 5c27 270a  ng="utf-8"))\''.
+00008fd0: 2020 2020 290a 0a20 2020 2023 2055 7365      )..    # Use
+00008fe0: 2061 2074 6d70 2066 696c 6520 7061 7468   a tmp file path
+00008ff0: 2074 6f20 6176 6f69 6420 696e 636f 6d70   to avoid incomp
+00009000: 6c65 7465 2059 414d 4c20 6669 6c65 2062  lete YAML file b
+00009010: 6569 6e67 2072 652d 7573 6564 2069 6e20  eing re-used in 
+00009020: 7468 650a 2020 2020 2320 6675 7475 7265  the.    # future
+00009030: 2e0a 2020 2020 746d 705f 7961 6d6c 5f70  ..    tmp_yaml_p
+00009040: 6174 6820 3d20 7961 6d6c 5f70 6174 6820  ath = yaml_path 
+00009050: 2b20 272e 746d 7027 0a20 2020 2063 6f6d  + '.tmp'.    com
+00009060: 6d6f 6e5f 7574 696c 732e 6669 6c6c 5f74  mon_utils.fill_t
+00009070: 656d 706c 6174 6528 0a20 2020 2020 2020  emplate(.       
+00009080: 2063 6c75 7374 6572 5f63 6f6e 6669 675f   cluster_config_
+00009090: 7465 6d70 6c61 7465 2c0a 2020 2020 2020  template,.      
+000090a0: 2020 6469 6374 280a 2020 2020 2020 2020    dict(.        
+000090b0: 2020 2020 7265 736f 7572 6365 735f 7661      resources_va
+000090c0: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
+000090d0: 2a2a 7b0a 2020 2020 2020 2020 2020 2020  **{.            
+000090e0: 2020 2020 2763 6c75 7374 6572 5f6e 616d      'cluster_nam
+000090f0: 655f 6f6e 5f63 6c6f 7564 273a 2063 6c75  e_on_cloud': clu
+00009100: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
+00009110: 7564 2c0a 2020 2020 2020 2020 2020 2020  ud,.            
+00009120: 2020 2020 276e 756d 5f6e 6f64 6573 273a      'num_nodes':
+00009130: 206e 756d 5f6e 6f64 6573 2c0a 2020 2020   num_nodes,.    
+00009140: 2020 2020 2020 2020 2020 2020 2764 6973              'dis
+00009150: 6b5f 7369 7a65 273a 2074 6f5f 7072 6f76  k_size': to_prov
+00009160: 6973 696f 6e2e 6469 736b 5f73 697a 652c  ision.disk_size,
+00009170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009180: 2023 2049 6620 7468 6520 6375 7272 656e   # If the curren
+00009190: 7420 636f 6465 2069 7320 7275 6e20 6279  t code is run by
+000091a0: 2063 6f6e 7472 6f6c 6c65 722c 2070 726f   controller, pro
+000091b0: 7061 6761 7465 2074 6865 2072 6561 6c0a  pagate the real.
+000091c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000091d0: 2320 6361 6c6c 696e 6720 7573 6572 2077  # calling user w
+000091e0: 6869 6368 2073 686f 756c 6427 7665 2062  hich should've b
+000091f0: 6565 6e20 7061 7373 6564 2069 6e20 6173  een passed in as
+00009200: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
+00009210: 2020 2020 2023 2053 4b59 5049 4c4f 545f       # SKYPILOT_
+00009220: 5553 4552 2065 6e76 2076 6172 2028 7365  USER env var (se
+00009230: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00009240: 2020 2320 636f 6e74 726f 6c6c 6572 5f75    # controller_u
+00009250: 7469 6c73 2e73 6861 7265 645f 636f 6e74  tils.shared_cont
+00009260: 726f 6c6c 6572 5f76 6172 735f 746f 5f66  roller_vars_to_f
+00009270: 696c 6c28 292e 0a20 2020 2020 2020 2020  ill()..         
+00009280: 2020 2020 2020 2027 7573 6572 273a 2063         'user': c
+00009290: 6f6d 6d6f 6e5f 7574 696c 732e 6765 745f  ommon_utils.get_
+000092a0: 636c 6561 6e65 645f 7573 6572 6e61 6d65  cleaned_username
+000092b0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000092c0: 2020 2020 2020 6f73 2e65 6e76 6972 6f6e        os.environ
+000092d0: 2e67 6574 2863 6f6e 7374 616e 7473 2e55  .get(constants.U
+000092e0: 5345 525f 454e 565f 5641 522c 2027 2729  SER_ENV_VAR, '')
+000092f0: 292c 0a0a 2020 2020 2020 2020 2020 2020  ),..            
+00009300: 2020 2020 2320 4e65 7477 6f72 6b69 6e67      # Networking
+00009310: 2063 6f6e 6669 6773 0a20 2020 2020 2020   configs.       
+00009320: 2020 2020 2020 2020 2027 7573 655f 696e           'use_in
+00009330: 7465 726e 616c 5f69 7073 273a 2073 6b79  ternal_ips': sky
+00009340: 7069 6c6f 745f 636f 6e66 6967 2e67 6574  pilot_config.get
+00009350: 5f6e 6573 7465 6428 0a20 2020 2020 2020  _nested(.       
+00009360: 2020 2020 2020 2020 2020 2020 2028 7374               (st
+00009370: 7228 636c 6f75 6429 2e6c 6f77 6572 2829  r(cloud).lower()
+00009380: 2c20 2775 7365 5f69 6e74 6572 6e61 6c5f  , 'use_internal_
+00009390: 6970 7327 292c 2046 616c 7365 292c 0a20  ips'), False),. 
+000093a0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+000093b0: 7373 685f 7072 6f78 795f 636f 6d6d 616e  ssh_proxy_comman
+000093c0: 6427 3a20 7373 685f 7072 6f78 795f 636f  d': ssh_proxy_co
+000093d0: 6d6d 616e 642c 0a20 2020 2020 2020 2020  mmand,.         
+000093e0: 2020 2020 2020 2027 7670 635f 6e61 6d65         'vpc_name
+000093f0: 273a 2073 6b79 7069 6c6f 745f 636f 6e66  ': skypilot_conf
+00009400: 6967 2e67 6574 5f6e 6573 7465 6428 0a20  ig.get_nested(. 
+00009410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009420: 2020 2028 7374 7228 636c 6f75 6429 2e6c     (str(cloud).l
+00009430: 6f77 6572 2829 2c20 2776 7063 5f6e 616d  ower(), 'vpc_nam
+00009440: 6527 292c 204e 6f6e 6529 2c0a 0a20 2020  e'), None),..   
+00009450: 2020 2020 2020 2020 2020 2020 2023 2055               # U
+00009460: 7365 722d 7375 7070 6c69 6564 206c 6162  ser-supplied lab
+00009470: 656c 732e 0a20 2020 2020 2020 2020 2020  els..           
+00009480: 2020 2020 2027 6c61 6265 6c73 273a 206c       'labels': l
+00009490: 6162 656c 732c 0a20 2020 2020 2020 2020  abels,.         
+000094a0: 2020 2020 2020 2023 2054 6865 2072 6573         # The res
+000094b0: 6572 7661 7469 6f6e 2070 6f6f 6c73 2074  ervation pools t
+000094c0: 6861 7420 7370 6563 6966 6965 6420 6279  hat specified by
+000094d0: 2074 6865 2075 7365 722e 2054 6869 7320   the user. This 
+000094e0: 6973 0a20 2020 2020 2020 2020 2020 2020  is.             
+000094f0: 2020 2023 2063 7572 7265 6e74 6c79 206f     # currently o
+00009500: 6e6c 7920 7573 6564 2062 7920 4743 502e  nly used by GCP.
+00009510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009520: 2027 7370 6563 6966 6963 5f72 6573 6572   'specific_reser
+00009530: 7661 7469 6f6e 7327 3a20 7370 6563 6966  vations': specif
+00009540: 6963 5f72 6573 6572 7661 7469 6f6e 732c  ic_reservations,
+00009550: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00009560: 2020 2320 436f 6e64 6120 7365 7475 700a    # Conda setup.
+00009570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009580: 2763 6f6e 6461 5f69 6e73 7461 6c6c 6174  'conda_installat
+00009590: 696f 6e5f 636f 6d6d 616e 6473 273a 0a20  ion_commands':. 
+000095a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000095b0: 2020 2063 6f6e 7374 616e 7473 2e43 4f4e     constants.CON
+000095c0: 4441 5f49 4e53 5441 4c4c 4154 494f 4e5f  DA_INSTALLATION_
+000095d0: 434f 4d4d 414e 4453 2c0a 2020 2020 2020  COMMANDS,.      
+000095e0: 2020 2020 2020 2020 2020 2320 5765 2073            # We s
+000095f0: 686f 756c 6420 6e6f 7420 7573 6520 602e  hould not use `.
+00009600: 666f 726d 6174 602c 2061 7320 6974 2063  format`, as it c
+00009610: 6f6e 7461 696e 7320 277b 7d27 2061 7320  ontains '{}' as 
+00009620: 7468 6520 6261 7368 0a20 2020 2020 2020  the bash.       
+00009630: 2020 2020 2020 2020 2023 2073 796e 7461           # synta
+00009640: 782e 0a20 2020 2020 2020 2020 2020 2020  x..             
+00009650: 2020 2027 7261 795f 736b 7970 696c 6f74     'ray_skypilot
+00009660: 5f69 6e73 7461 6c6c 6174 696f 6e5f 636f  _installation_co
+00009670: 6d6d 616e 6473 273a 0a20 2020 2020 2020  mmands':.       
+00009680: 2020 2020 2020 2020 2020 2020 2028 636f               (co
+00009690: 6e73 7461 6e74 732e 5241 595f 534b 5950  nstants.RAY_SKYP
+000096a0: 494c 4f54 5f49 4e53 5441 4c4c 4154 494f  ILOT_INSTALLATIO
+000096b0: 4e5f 434f 4d4d 414e 4453 2e72 6570 6c61  N_COMMANDS.repla
+000096c0: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
+000096d0: 2020 2020 2020 2020 2020 2020 277b 736b              '{sk
+000096e0: 795f 7768 6565 6c5f 6861 7368 7d27 2c0a  y_wheel_hash}',.
+000096f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009700: 2020 2020 2020 2020 7768 6565 6c5f 6861          wheel_ha
+00009710: 7368 292e 7265 706c 6163 6528 277b 636c  sh).replace('{cl
+00009720: 6f75 647d 272c 0a20 2020 2020 2020 2020  oud}',.         
+00009730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009750: 2020 2073 7472 2863 6c6f 7564 292e 6c6f     str(cloud).lo
+00009760: 7765 7228 2929 292c 0a0a 2020 2020 2020  wer())),..      
+00009770: 2020 2020 2020 2020 2020 2320 506f 7274            # Port
+00009780: 206f 6620 5261 7920 2847 4353 2073 6572   of Ray (GCS ser
+00009790: 7665 7229 2e0a 2020 2020 2020 2020 2020  ver)..          
+000097a0: 2020 2020 2020 2320 5261 7927 7320 6465        # Ray's de
+000097b0: 6661 756c 7420 706f 7274 2036 3337 3920  fault port 6379 
+000097c0: 6973 2063 6f6e 666c 6963 7465 6420 7769  is conflicted wi
+000097d0: 7468 2052 6564 6973 2e0a 2020 2020 2020  th Redis..      
+000097e0: 2020 2020 2020 2020 2020 2772 6179 5f70            'ray_p
+000097f0: 6f72 7427 3a20 636f 6e73 7461 6e74 732e  ort': constants.
+00009800: 534b 595f 5245 4d4f 5445 5f52 4159 5f50  SKY_REMOTE_RAY_P
+00009810: 4f52 542c 0a20 2020 2020 2020 2020 2020  ORT,.           
+00009820: 2020 2020 2027 7261 795f 6461 7368 626f       'ray_dashbo
+00009830: 6172 645f 706f 7274 273a 2063 6f6e 7374  ard_port': const
+00009840: 616e 7473 2e53 4b59 5f52 454d 4f54 455f  ants.SKY_REMOTE_
+00009850: 5241 595f 4441 5348 424f 4152 445f 504f  RAY_DASHBOARD_PO
+00009860: 5254 2c0a 2020 2020 2020 2020 2020 2020  RT,.            
+00009870: 2020 2020 2772 6179 5f74 656d 705f 6469      'ray_temp_di
+00009880: 7227 3a20 636f 6e73 7461 6e74 732e 534b  r': constants.SK
+00009890: 595f 5245 4d4f 5445 5f52 4159 5f54 454d  Y_REMOTE_RAY_TEM
+000098a0: 5044 4952 2c0a 2020 2020 2020 2020 2020  PDIR,.          
+000098b0: 2020 2020 2020 2764 756d 705f 706f 7274        'dump_port
+000098c0: 5f63 6f6d 6d61 6e64 273a 2064 756d 705f  _command': dump_
+000098d0: 706f 7274 5f63 6f6d 6d61 6e64 2c0a 2020  port_command,.  
+000098e0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000098f0: 536b 792d 696e 7465 726e 616c 2063 6f6e  Sky-internal con
+00009900: 7374 616e 7473 2e0a 2020 2020 2020 2020  stants..        
+00009910: 2020 2020 2020 2020 2773 6b79 5f72 6179          'sky_ray
+00009920: 5f63 6d64 273a 2063 6f6e 7374 616e 7473  _cmd': constants
+00009930: 2e53 4b59 5f52 4159 5f43 4d44 2c0a 2020  .SKY_RAY_CMD,.  
+00009940: 2020 2020 2020 2020 2020 2020 2020 2773                's
+00009950: 6b79 5f70 6970 5f63 6d64 273a 2063 6f6e  ky_pip_cmd': con
+00009960: 7374 616e 7473 2e53 4b59 5f50 4950 5f43  stants.SKY_PIP_C
+00009970: 4d44 2c0a 2020 2020 2020 2020 2020 2020  MD,.            
+00009980: 2020 2020 2772 6179 5f76 6572 7369 6f6e      'ray_version
+00009990: 273a 2063 6f6e 7374 616e 7473 2e53 4b59  ': constants.SKY
+000099a0: 5f52 454d 4f54 455f 5241 595f 5645 5253  _REMOTE_RAY_VERS
+000099b0: 494f 4e2c 0a20 2020 2020 2020 2020 2020  ION,.           
+000099c0: 2020 2020 2023 2043 6f6d 6d61 6e64 2066       # Command f
+000099d0: 6f72 2077 6169 7469 6e67 2072 6179 2063  or waiting ray c
+000099e0: 6c75 7374 6572 2074 6f20 6265 2072 6561  luster to be rea
+000099f0: 6479 206f 6e20 6865 6164 2e0a 2020 2020  dy on head..    
+00009a00: 2020 2020 2020 2020 2020 2020 2772 6179              'ray
+00009a10: 5f68 6561 645f 7761 6974 5f69 6e69 7469  _head_wait_initi
+00009a20: 616c 697a 6564 5f63 6f6d 6d61 6e64 273a  alized_command':
+00009a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009a40: 2020 2020 2069 6e73 7461 6e63 655f 7365       instance_se
+00009a50: 7475 702e 5241 595f 4845 4144 5f57 4149  tup.RAY_HEAD_WAI
+00009a60: 545f 494e 4954 4941 4c49 5a45 445f 434f  T_INITIALIZED_CO
+00009a70: 4d4d 414e 442c 0a0a 2020 2020 2020 2020  MMAND,..        
+00009a80: 2020 2020 2020 2020 2320 436c 6f75 6420          # Cloud 
+00009a90: 6372 6564 656e 7469 616c 7320 666f 7220  credentials for 
+00009aa0: 636c 6f75 6420 7374 6f72 6167 652e 0a20  cloud storage.. 
+00009ab0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00009ac0: 6372 6564 656e 7469 616c 7327 3a20 6372  credentials': cr
+00009ad0: 6564 656e 7469 616c 732c 0a20 2020 2020  edentials,.     
+00009ae0: 2020 2020 2020 2020 2020 2023 2053 6b79             # Sky
+00009af0: 2072 656d 6f74 6520 7574 696c 732e 0a20   remote utils.. 
+00009b00: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00009b10: 736b 795f 7265 6d6f 7465 5f70 6174 6827  sky_remote_path'
+00009b20: 3a20 534b 595f 5245 4d4f 5445 5f50 4154  : SKY_REMOTE_PAT
+00009b30: 482c 0a20 2020 2020 2020 2020 2020 2020  H,.             
+00009b40: 2020 2027 736b 795f 6c6f 6361 6c5f 7061     'sky_local_pa
+00009b50: 7468 273a 2073 7472 286c 6f63 616c 5f77  th': str(local_w
+00009b60: 6865 656c 5f70 6174 6829 2c0a 2020 2020  heel_path),.    
+00009b70: 2020 2020 2020 2020 2020 2020 2320 4164              # Ad
+00009b80: 6420 7961 6d6c 2066 696c 6520 7061 7468  d yaml file path
+00009b90: 2074 6f20 7468 6520 7465 6d70 6c61 7465   to the template
+00009ba0: 2076 6172 6961 626c 6573 2e0a 2020 2020   variables..    
+00009bb0: 2020 2020 2020 2020 2020 2020 2773 6b79              'sky
+00009bc0: 5f72 6179 5f79 616d 6c5f 7265 6d6f 7465  _ray_yaml_remote
+00009bd0: 5f70 6174 6827 3a0a 2020 2020 2020 2020  _path':.        
+00009be0: 2020 2020 2020 2020 2020 2020 636c 7573              clus
+00009bf0: 7465 725f 7961 6d6c 5f75 7469 6c73 2e53  ter_yaml_utils.S
+00009c00: 4b59 5f43 4c55 5354 4552 5f59 414d 4c5f  KY_CLUSTER_YAML_
+00009c10: 5245 4d4f 5445 5f50 4154 482c 0a20 2020  REMOTE_PATH,.   
+00009c20: 2020 2020 2020 2020 2020 2020 2027 736b               'sk
+00009c30: 795f 7261 795f 7961 6d6c 5f6c 6f63 616c  y_ray_yaml_local
+00009c40: 5f70 6174 6827 3a20 746d 705f 7961 6d6c  _path': tmp_yaml
+00009c50: 5f70 6174 682c 0a20 2020 2020 2020 2020  _path,.         
+00009c60: 2020 2020 2020 2027 736b 795f 7665 7273         'sky_vers
+00009c70: 696f 6e27 3a20 7374 7228 7665 7273 696f  ion': str(versio
+00009c80: 6e2e 7061 7273 6528 736b 792e 5f5f 7665  n.parse(sky.__ve
+00009c90: 7273 696f 6e5f 5f29 292c 0a20 2020 2020  rsion__)),.     
+00009ca0: 2020 2020 2020 2020 2020 2027 736b 795f             'sky_
+00009cb0: 7768 6565 6c5f 6861 7368 273a 2077 6865  wheel_hash': whe
+00009cc0: 656c 5f68 6173 682c 0a20 2020 2020 2020  el_hash,.       
+00009cd0: 2020 2020 2020 2020 2023 2041 7574 6865           # Authe
+00009ce0: 6e74 6963 6174 696f 6e20 286f 7074 696f  ntication (optio
+00009cf0: 6e61 6c29 2e0a 2020 2020 2020 2020 2020  nal)..          
+00009d00: 2020 2020 2020 2a2a 6175 7468 5f63 6f6e        **auth_con
+00009d10: 6669 672c 0a20 2020 2020 2020 2020 2020  fig,.           
+00009d20: 207d 292c 0a20 2020 2020 2020 206f 7574   }),.        out
+00009d30: 7075 745f 7061 7468 3d74 6d70 5f79 616d  put_path=tmp_yam
+00009d40: 6c5f 7061 7468 290a 2020 2020 636f 6e66  l_path).    conf
+00009d50: 6967 5f64 6963 745b 2763 6c75 7374 6572  ig_dict['cluster
+00009d60: 5f6e 616d 6527 5d20 3d20 636c 7573 7465  _name'] = cluste
+00009d70: 725f 6e61 6d65 0a20 2020 2063 6f6e 6669  r_name.    confi
+00009d80: 675f 6469 6374 5b27 7261 7927 5d20 3d20  g_dict['ray'] = 
+00009d90: 7961 6d6c 5f70 6174 680a 2020 2020 6966  yaml_path.    if
+00009da0: 2064 7279 7275 6e3a 0a20 2020 2020 2020   dryrun:.       
+00009db0: 2023 2049 6620 6472 7972 756e 2c20 7265   # If dryrun, re
+00009dc0: 7475 726e 2074 6865 2075 6e66 696e 6973  turn the unfinis
+00009dd0: 6865 6420 746d 7020 7961 6d6c 2070 6174  hed tmp yaml pat
+00009de0: 682e 0a20 2020 2020 2020 2063 6f6e 6669  h..        confi
+00009df0: 675f 6469 6374 5b27 7261 7927 5d20 3d20  g_dict['ray'] = 
+00009e00: 746d 705f 7961 6d6c 5f70 6174 680a 2020  tmp_yaml_path.  
+00009e10: 2020 2020 2020 7265 7475 726e 2063 6f6e        return con
+00009e20: 6669 675f 6469 6374 0a20 2020 205f 6164  fig_dict.    _ad
+00009e30: 645f 6175 7468 5f74 6f5f 636c 7573 7465  d_auth_to_cluste
+00009e40: 725f 636f 6e66 6967 2863 6c6f 7564 2c20  r_config(cloud, 
+00009e50: 746d 705f 7961 6d6c 5f70 6174 6829 0a0a  tmp_yaml_path)..
+00009e60: 2020 2020 2320 4164 6420 6b75 6265 726e      # Add kubern
+00009e70: 6574 6573 2063 6f6e 6669 6720 6669 656c  etes config fiel
+00009e80: 6473 2066 726f 6d20 7e2f 2e73 6b79 2f63  ds from ~/.sky/c
+00009e90: 6f6e 6669 670a 2020 2020 6966 2069 7369  onfig.    if isi
+00009ea0: 6e73 7461 6e63 6528 636c 6f75 642c 2063  nstance(cloud, c
+00009eb0: 6c6f 7564 732e 4b75 6265 726e 6574 6573  louds.Kubernetes
+00009ec0: 293a 0a20 2020 2020 2020 206b 7562 6572  ):.        kuber
+00009ed0: 6e65 7465 735f 7574 696c 732e 636f 6d62  netes_utils.comb
+00009ee0: 696e 655f 706f 645f 636f 6e66 6967 5f66  ine_pod_config_f
+00009ef0: 6965 6c64 7328 746d 705f 7961 6d6c 5f70  ields(tmp_yaml_p
+00009f00: 6174 6829 0a20 2020 2020 2020 206b 7562  ath).        kub
+00009f10: 6572 6e65 7465 735f 7574 696c 732e 636f  ernetes_utils.co
+00009f20: 6d62 696e 655f 6d65 7461 6461 7461 5f66  mbine_metadata_f
+00009f30: 6965 6c64 7328 746d 705f 7961 6d6c 5f70  ields(tmp_yaml_p
+00009f40: 6174 6829 0a0a 2020 2020 2320 5265 7374  ath)..    # Rest
+00009f50: 6f72 6520 7468 6520 6f6c 6420 7961 6d6c  ore the old yaml
+00009f60: 2063 6f6e 7465 6e74 2066 6f72 2062 6163   content for bac
+00009f70: 6b77 6172 6420 636f 6d70 6174 6962 696c  kward compatibil
+00009f80: 6974 792e 0a20 2020 2069 6620 6f73 2e70  ity..    if os.p
+00009f90: 6174 682e 6578 6973 7473 2879 616d 6c5f  ath.exists(yaml_
+00009fa0: 7061 7468 2920 616e 6420 6b65 6570 5f6c  path) and keep_l
+00009fb0: 6175 6e63 685f 6669 656c 6473 5f69 6e5f  aunch_fields_in_
+00009fc0: 6578 6973 7469 6e67 5f63 6f6e 6669 673a  existing_config:
+00009fd0: 0a20 2020 2020 2020 2077 6974 6820 6f70  .        with op
+00009fe0: 656e 2879 616d 6c5f 7061 7468 2c20 2772  en(yaml_path, 'r
+00009ff0: 272c 2065 6e63 6f64 696e 673d 2775 7466  ', encoding='utf
+0000a000: 2d38 2729 2061 7320 663a 0a20 2020 2020  -8') as f:.     
+0000a010: 2020 2020 2020 206f 6c64 5f79 616d 6c5f         old_yaml_
+0000a020: 636f 6e74 656e 7420 3d20 662e 7265 6164  content = f.read
+0000a030: 2829 0a20 2020 2020 2020 2077 6974 6820  ().        with 
+0000a040: 6f70 656e 2874 6d70 5f79 616d 6c5f 7061  open(tmp_yaml_pa
+0000a050: 7468 2c20 2772 272c 2065 6e63 6f64 696e  th, 'r', encodin
+0000a060: 673d 2775 7466 2d38 2729 2061 7320 663a  g='utf-8') as f:
+0000a070: 0a20 2020 2020 2020 2020 2020 206e 6577  .            new
+0000a080: 5f79 616d 6c5f 636f 6e74 656e 7420 3d20  _yaml_content = 
+0000a090: 662e 7265 6164 2829 0a20 2020 2020 2020  f.read().       
+0000a0a0: 2072 6573 746f 7265 645f 7961 6d6c 5f63   restored_yaml_c
+0000a0b0: 6f6e 7465 6e74 203d 205f 7265 706c 6163  ontent = _replac
+0000a0c0: 655f 7961 6d6c 5f64 6963 7473 280a 2020  e_yaml_dicts(.  
+0000a0d0: 2020 2020 2020 2020 2020 6e65 775f 7961            new_ya
+0000a0e0: 6d6c 5f63 6f6e 7465 6e74 2c20 6f6c 645f  ml_content, old_
+0000a0f0: 7961 6d6c 5f63 6f6e 7465 6e74 2c0a 2020  yaml_content,.  
+0000a100: 2020 2020 2020 2020 2020 5f52 4159 5f59            _RAY_Y
+0000a110: 414d 4c5f 4b45 5953 5f54 4f5f 5245 5354  AML_KEYS_TO_REST
+0000a120: 4f52 455f 464f 525f 4241 434b 5f43 4f4d  ORE_FOR_BACK_COM
+0000a130: 5041 5449 4249 4c49 5459 2c0a 2020 2020  PATIBILITY,.    
+0000a140: 2020 2020 2020 2020 5f52 4159 5f59 414d          _RAY_YAM
+0000a150: 4c5f 4b45 5953 5f54 4f5f 5245 5354 4f52  L_KEYS_TO_RESTOR
+0000a160: 455f 4558 4345 5054 494f 4e53 290a 2020  E_EXCEPTIONS).  
+0000a170: 2020 2020 2020 7769 7468 206f 7065 6e28        with open(
+0000a180: 746d 705f 7961 6d6c 5f70 6174 682c 2027  tmp_yaml_path, '
+0000a190: 7727 2c20 656e 636f 6469 6e67 3d27 7574  w', encoding='ut
+0000a1a0: 662d 3827 2920 6173 2066 3a0a 2020 2020  f-8') as f:.    
+0000a1b0: 2020 2020 2020 2020 662e 7772 6974 6528          f.write(
+0000a1c0: 7265 7374 6f72 6564 5f79 616d 6c5f 636f  restored_yaml_co
+0000a1d0: 6e74 656e 7429 0a0a 2020 2020 636f 6e66  ntent)..    conf
+0000a1e0: 6967 5f64 6963 745b 2763 6c75 7374 6572  ig_dict['cluster
+0000a1f0: 5f6e 616d 655f 6f6e 5f63 6c6f 7564 275d  _name_on_cloud']
+0000a200: 203d 2063 6c75 7374 6572 5f6e 616d 655f   = cluster_name_
+0000a210: 6f6e 5f63 6c6f 7564 0a0a 2020 2020 2320  on_cloud..    # 
+0000a220: 4f70 7469 6d69 7a61 7469 6f6e 3a20 636f  Optimization: co
+0000a230: 7079 2074 6865 2063 6f6e 7465 6e74 7320  py the contents 
+0000a240: 6f66 2073 6f75 7263 6520 6669 6c65 7320  of source files 
+0000a250: 696e 2066 696c 655f 6d6f 756e 7473 2074  in file_mounts t
+0000a260: 6f20 610a 2020 2020 2320 7370 6563 6961  o a.    # specia
+0000a270: 6c20 6469 722c 2061 6e64 2075 706c 6f61  l dir, and uploa
+0000a280: 6420 7468 6174 2061 7320 7468 6520 6f6e  d that as the on
+0000a290: 6c79 2066 696c 655f 6d6f 756e 7420 696e  ly file_mount in
+0000a2a0: 7374 6561 642e 2044 656c 6179 0a20 2020  stead. Delay.   
+0000a2b0: 2023 2063 616c 6c69 6e67 2074 6869 7320   # calling this 
+0000a2c0: 6f70 7469 6d69 7a61 7469 6f6e 2075 6e74  optimization unt
+0000a2d0: 696c 206e 6f77 2c20 7768 656e 2061 6c6c  il now, when all
+0000a2e0: 2073 6f75 7263 6520 6669 6c65 7320 6861   source files ha
+0000a2f0: 7665 2062 6565 6e0a 2020 2020 2320 7772  ve been.    # wr
+0000a300: 6974 7465 6e20 616e 6420 7468 6569 7220  itten and their 
+0000a310: 636f 6e74 656e 7473 2066 696e 616c 697a  contents finaliz
+0000a320: 6564 2e0a 2020 2020 230a 2020 2020 2320  ed..    #.    # 
+0000a330: 4e6f 7465 2074 6861 7420 7468 6520 7261  Note that the ra
+0000a340: 7920 7961 6d6c 2066 696c 6520 7769 6c6c  y yaml file will
+0000a350: 2062 6520 636f 7069 6564 2069 6e74 6f20   be copied into 
+0000a360: 7468 6174 2073 7065 6369 616c 2064 6972  that special dir
+0000a370: 2028 692e 652e 2c0a 2020 2020 2320 7570   (i.e.,.    # up
+0000a380: 6c6f 6164 6564 2061 7320 7061 7274 206f  loaded as part o
+0000a390: 6620 7468 6520 6669 6c65 5f6d 6f75 6e74  f the file_mount
+0000a3a0: 7329 2c20 736f 2074 6865 2072 6573 746f  s), so the resto
+0000a3b0: 7265 2066 6f72 2062 6163 6b77 6172 640a  re for backward.
+0000a3c0: 2020 2020 2320 636f 6d70 6174 6962 696c      # compatibil
+0000a3d0: 6974 7920 7368 6f75 6c64 2067 6f20 6265  ity should go be
+0000a3e0: 666f 7265 2074 6869 7320 6361 6c6c 2e0a  fore this call..
+0000a3f0: 2020 2020 5f6f 7074 696d 697a 655f 6669      _optimize_fi
+0000a400: 6c65 5f6d 6f75 6e74 7328 746d 705f 7961  le_mounts(tmp_ya
+0000a410: 6d6c 5f70 6174 6829 0a0a 2020 2020 2320  ml_path)..    # 
+0000a420: 5265 6e61 6d65 2074 6865 2074 6d70 2066  Rename the tmp f
+0000a430: 696c 6520 746f 2074 6865 2066 696e 616c  ile to the final
+0000a440: 2059 414d 4c20 7061 7468 2e0a 2020 2020   YAML path..    
+0000a450: 6f73 2e72 656e 616d 6528 746d 705f 7961  os.rename(tmp_ya
+0000a460: 6d6c 5f70 6174 682c 2079 616d 6c5f 7061  ml_path, yaml_pa
+0000a470: 7468 290a 2020 2020 7573 6167 655f 6c69  th).    usage_li
+0000a480: 622e 6d65 7373 6167 6573 2e75 7361 6765  b.messages.usage
+0000a490: 2e75 7064 6174 655f 7261 795f 7961 6d6c  .update_ray_yaml
+0000a4a0: 2879 616d 6c5f 7061 7468 290a 2020 2020  (yaml_path).    
+0000a4b0: 7265 7475 726e 2063 6f6e 6669 675f 6469  return config_di
+0000a4c0: 6374 0a0a 0a64 6566 205f 6164 645f 6175  ct...def _add_au
+0000a4d0: 7468 5f74 6f5f 636c 7573 7465 725f 636f  th_to_cluster_co
+0000a4e0: 6e66 6967 2863 6c6f 7564 3a20 636c 6f75  nfig(cloud: clou
+0000a4f0: 6473 2e43 6c6f 7564 2c20 636c 7573 7465  ds.Cloud, cluste
+0000a500: 725f 636f 6e66 6967 5f66 696c 653a 2073  r_config_file: s
+0000a510: 7472 293a 0a20 2020 2022 2222 4164 6473  tr):.    """Adds
+0000a520: 2053 5348 206b 6579 2069 6e66 6f20 746f   SSH key info to
+0000a530: 2074 6865 2063 6c75 7374 6572 2063 6f6e   the cluster con
+0000a540: 6669 672e 0a0a 2020 2020 5468 6973 2066  fig...    This f
+0000a550: 756e 6374 696f 6e27 7320 6f75 7470 7574  unction's output
+0000a560: 2072 656d 6f76 6573 2063 6f6d 6d65 6e74   removes comment
+0000a570: 7320 696e 636c 7564 6564 2069 6e20 7468  s included in th
+0000a580: 6520 6a69 6e6a 6132 2074 656d 706c 6174  e jinja2 templat
+0000a590: 652e 0a20 2020 2022 2222 0a20 2020 2063  e..    """.    c
+0000a5a0: 6f6e 6669 6720 3d20 636f 6d6d 6f6e 5f75  onfig = common_u
+0000a5b0: 7469 6c73 2e72 6561 645f 7961 6d6c 2863  tils.read_yaml(c
+0000a5c0: 6c75 7374 6572 5f63 6f6e 6669 675f 6669  luster_config_fi
+0000a5d0: 6c65 290a 2020 2020 2320 4368 6563 6b20  le).    # Check 
+0000a5e0: 7468 6520 6176 6169 6c61 6269 6c69 7479  the availability
+0000a5f0: 206f 6620 7468 6520 636c 6f75 6420 7479   of the cloud ty
+0000a600: 7065 2e0a 2020 2020 6966 2069 7369 6e73  pe..    if isins
+0000a610: 7461 6e63 6528 636c 6f75 642c 2028 636c  tance(cloud, (cl
+0000a620: 6f75 6473 2e41 5753 2c20 636c 6f75 6473  ouds.AWS, clouds
+0000a630: 2e4f 4349 2c20 636c 6f75 6473 2e53 4350  .OCI, clouds.SCP
+0000a640: 2c20 636c 6f75 6473 2e56 7370 6865 7265  , clouds.Vsphere
+0000a650: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a660: 2020 2020 2020 2020 2020 2020 636c 6f75              clou
+0000a670: 6473 2e43 7564 6f2c 2063 6c6f 7564 732e  ds.Cudo, clouds.
+0000a680: 5061 7065 7273 7061 6365 2929 3a0a 2020  Paperspace)):.  
+0000a690: 2020 2020 2020 636f 6e66 6967 203d 2061        config = a
+0000a6a0: 7574 682e 636f 6e66 6967 7572 655f 7373  uth.configure_ss
+0000a6b0: 685f 696e 666f 2863 6f6e 6669 6729 0a20  h_info(config). 
+0000a6c0: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
+0000a6d0: 6365 2863 6c6f 7564 2c20 636c 6f75 6473  ce(cloud, clouds
+0000a6e0: 2e47 4350 293a 0a20 2020 2020 2020 2063  .GCP):.        c
+0000a6f0: 6f6e 6669 6720 3d20 6175 7468 2e73 6574  onfig = auth.set
+0000a700: 7570 5f67 6370 5f61 7574 6865 6e74 6963  up_gcp_authentic
+0000a710: 6174 696f 6e28 636f 6e66 6967 290a 2020  ation(config).  
+0000a720: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+0000a730: 6528 636c 6f75 642c 2063 6c6f 7564 732e  e(cloud, clouds.
+0000a740: 417a 7572 6529 3a0a 2020 2020 2020 2020  Azure):.        
+0000a750: 636f 6e66 6967 203d 2061 7574 682e 7365  config = auth.se
+0000a760: 7475 705f 617a 7572 655f 6175 7468 656e  tup_azure_authen
+0000a770: 7469 6361 7469 6f6e 2863 6f6e 6669 6729  tication(config)
+0000a780: 0a20 2020 2065 6c69 6620 6973 696e 7374  .    elif isinst
+0000a790: 616e 6365 2863 6c6f 7564 2c20 636c 6f75  ance(cloud, clou
+0000a7a0: 6473 2e4c 616d 6264 6129 3a0a 2020 2020  ds.Lambda):.    
+0000a7b0: 2020 2020 636f 6e66 6967 203d 2061 7574      config = aut
+0000a7c0: 682e 7365 7475 705f 6c61 6d62 6461 5f61  h.setup_lambda_a
+0000a7d0: 7574 6865 6e74 6963 6174 696f 6e28 636f  uthentication(co
+0000a7e0: 6e66 6967 290a 2020 2020 656c 6966 2069  nfig).    elif i
+0000a7f0: 7369 6e73 7461 6e63 6528 636c 6f75 642c  sinstance(cloud,
+0000a800: 2063 6c6f 7564 732e 4b75 6265 726e 6574   clouds.Kubernet
+0000a810: 6573 293a 0a20 2020 2020 2020 2063 6f6e  es):.        con
+0000a820: 6669 6720 3d20 6175 7468 2e73 6574 7570  fig = auth.setup
+0000a830: 5f6b 7562 6572 6e65 7465 735f 6175 7468  _kubernetes_auth
+0000a840: 656e 7469 6361 7469 6f6e 2863 6f6e 6669  entication(confi
+0000a850: 6729 0a20 2020 2065 6c69 6620 6973 696e  g).    elif isin
+0000a860: 7374 616e 6365 2863 6c6f 7564 2c20 636c  stance(cloud, cl
+0000a870: 6f75 6473 2e49 424d 293a 0a20 2020 2020  ouds.IBM):.     
+0000a880: 2020 2063 6f6e 6669 6720 3d20 6175 7468     config = auth
+0000a890: 2e73 6574 7570 5f69 626d 5f61 7574 6865  .setup_ibm_authe
+0000a8a0: 6e74 6963 6174 696f 6e28 636f 6e66 6967  ntication(config
+0000a8b0: 290a 2020 2020 656c 6966 2069 7369 6e73  ).    elif isins
+0000a8c0: 7461 6e63 6528 636c 6f75 642c 2063 6c6f  tance(cloud, clo
+0000a8d0: 7564 732e 5275 6e50 6f64 293a 0a20 2020  uds.RunPod):.   
+0000a8e0: 2020 2020 2063 6f6e 6669 6720 3d20 6175       config = au
+0000a8f0: 7468 2e73 6574 7570 5f72 756e 706f 645f  th.setup_runpod_
+0000a900: 6175 7468 656e 7469 6361 7469 6f6e 2863  authentication(c
+0000a910: 6f6e 6669 6729 0a20 2020 2065 6c69 6620  onfig).    elif 
+0000a920: 6973 696e 7374 616e 6365 2863 6c6f 7564  isinstance(cloud
+0000a930: 2c20 636c 6f75 6473 2e46 6c75 6964 7374  , clouds.Fluidst
+0000a940: 6163 6b29 3a0a 2020 2020 2020 2020 636f  ack):.        co
+0000a950: 6e66 6967 203d 2061 7574 682e 7365 7475  nfig = auth.setu
+0000a960: 705f 666c 7569 6473 7461 636b 5f61 7574  p_fluidstack_aut
+0000a970: 6865 6e74 6963 6174 696f 6e28 636f 6e66  hentication(conf
+0000a980: 6967 290a 2020 2020 656c 7365 3a0a 2020  ig).    else:.  
+0000a990: 2020 2020 2020 6173 7365 7274 2046 616c        assert Fal
+0000a9a0: 7365 2c20 636c 6f75 640a 2020 2020 636f  se, cloud.    co
+0000a9b0: 6d6d 6f6e 5f75 7469 6c73 2e64 756d 705f  mmon_utils.dump_
+0000a9c0: 7961 6d6c 2863 6c75 7374 6572 5f63 6f6e  yaml(cluster_con
+0000a9d0: 6669 675f 6669 6c65 2c20 636f 6e66 6967  fig_file, config
+0000a9e0: 290a 0a0a 6465 6620 6765 745f 7275 6e5f  )...def get_run_
+0000a9f0: 7469 6d65 7374 616d 7028 2920 2d3e 2073  timestamp() -> s
+0000aa00: 7472 3a0a 2020 2020 7265 7475 726e 2027  tr:.    return '
+0000aa10: 736b 792d 2720 2b20 6461 7465 7469 6d65  sky-' + datetime
+0000aa20: 2e6e 6f77 2829 2e73 7472 6674 696d 6528  .now().strftime(
+0000aa30: 2725 592d 256d 2d25 642d 2548 2d25 4d2d  '%Y-%m-%d-%H-%M-
+0000aa40: 2553 2d25 6627 290a 0a0a 6465 6620 6765  %S-%f')...def ge
+0000aa50: 745f 7469 6d65 7374 616d 705f 6672 6f6d  t_timestamp_from
+0000aa60: 5f72 756e 5f74 696d 6573 7461 6d70 2872  _run_timestamp(r
+0000aa70: 756e 5f74 696d 6573 7461 6d70 3a20 7374  un_timestamp: st
+0000aa80: 7229 202d 3e20 666c 6f61 743a 0a20 2020  r) -> float:.   
+0000aa90: 2072 6574 7572 6e20 6461 7465 7469 6d65   return datetime
+0000aaa0: 2e73 7472 7074 696d 6528 0a20 2020 2020  .strptime(.     
+0000aab0: 2020 2072 756e 5f74 696d 6573 7461 6d70     run_timestamp
+0000aac0: 2e70 6172 7469 7469 6f6e 2827 2d27 295b  .partition('-')[
+0000aad0: 325d 2c20 2725 592d 256d 2d25 642d 2548  2], '%Y-%m-%d-%H
+0000aae0: 2d25 4d2d 2553 2d25 6627 292e 7469 6d65  -%M-%S-%f').time
+0000aaf0: 7374 616d 7028 290a 0a0a 6465 6620 5f63  stamp()...def _c
+0000ab00: 6f75 6e74 5f68 6561 6c74 6879 5f6e 6f64  ount_healthy_nod
+0000ab10: 6573 5f66 726f 6d5f 7261 7928 6f75 7470  es_from_ray(outp
+0000ab20: 7574 3a20 7374 722c 0a20 2020 2020 2020  ut: str,.       
+0000ab30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ab40: 2020 2020 2020 2020 2020 2069 735f 6c6f             is_lo
+0000ab50: 6361 6c5f 636c 6f75 643a 2062 6f6f 6c20  cal_cloud: bool 
+0000ab60: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+0000ab70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ab80: 2020 2020 2020 2020 2029 202d 3e20 5475           ) -> Tu
+0000ab90: 706c 655b 696e 742c 2069 6e74 5d3a 0a20  ple[int, int]:. 
+0000aba0: 2020 2022 2222 436f 756e 7420 7468 6520     """Count the 
+0000abb0: 6e75 6d62 6572 206f 6620 6865 616c 7468  number of health
+0000abc0: 7920 6e6f 6465 7320 6672 6f6d 2074 6865  y nodes from the
+0000abd0: 206f 7574 7075 7420 6f66 2060 7261 7920   output of `ray 
+0000abe0: 7374 6174 7573 602e 2222 220a 0a20 2020  status`."""..   
+0000abf0: 2064 6566 2067 6574 5f72 6561 6479 5f6e   def get_ready_n
+0000ac00: 6f64 6573 5f63 6f75 6e74 7328 7061 7474  odes_counts(patt
+0000ac10: 6572 6e2c 206f 7574 7075 7429 3a0a 2020  ern, output):.  
+0000ac20: 2020 2020 2020 7265 7375 6c74 203d 2070        result = p
+0000ac30: 6174 7465 726e 2e66 696e 6461 6c6c 286f  attern.findall(o
+0000ac40: 7574 7075 7429 0a20 2020 2020 2020 2069  utput).        i
+0000ac50: 6620 6e6f 7420 7265 7375 6c74 3a0a 2020  f not result:.  
+0000ac60: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000ac70: 2030 0a20 2020 2020 2020 2061 7373 6572   0.        asser
+0000ac80: 7420 6c65 6e28 7265 7375 6c74 2920 3d3d  t len(result) ==
+0000ac90: 2031 2c20 7265 7375 6c74 0a20 2020 2020   1, result.     
+0000aca0: 2020 2072 6574 7572 6e20 696e 7428 7265     return int(re
+0000acb0: 7375 6c74 5b30 5d29 0a0a 2020 2020 2320  sult[0])..    # 
+0000acc0: 4368 6563 6b20 6966 2074 6865 2072 6179  Check if the ray
+0000acd0: 2063 6c75 7374 6572 2069 7320 7374 6172   cluster is star
+0000ace0: 7465 6420 7769 7468 2072 6179 2061 7574  ted with ray aut
+0000acf0: 6f73 6361 6c65 722e 2049 6e20 6e65 770a  oscaler. In new.
+0000ad00: 2020 2020 2320 7072 6f76 6973 696f 6e65      # provisione
+0000ad10: 7220 2823 3137 3032 2920 616e 6420 6c6f  r (#1702) and lo
+0000ad20: 6361 6c20 6d6f 6465 2c20 7765 2073 7461  cal mode, we sta
+0000ad30: 7274 6564 2074 6865 2072 6179 2063 6c75  rted the ray clu
+0000ad40: 7374 6572 2077 6974 686f 7574 2072 6179  ster without ray
+0000ad50: 0a20 2020 2023 2061 7574 6f73 6361 6c65  .    # autoscale
+0000ad60: 722e 0a20 2020 2023 2049 6620 7261 7920  r..    # If ray 
+0000ad70: 636c 7573 7465 7220 6973 2073 7461 7274  cluster is start
+0000ad80: 6564 2077 6974 6820 7261 7920 6175 746f  ed with ray auto
+0000ad90: 7363 616c 6572 2c20 7468 6520 6f75 7470  scaler, the outp
+0000ada0: 7574 2077 696c 6c20 6265 3a0a 2020 2020  ut will be:.    
+0000adb0: 2320 2031 2072 6179 2e68 6561 642e 6465  #  1 ray.head.de
+0000adc0: 6661 756c 740a 2020 2020 2320 202e 2e2e  fault.    #  ...
+0000add0: 0a20 2020 2023 2054 4f44 4f28 7a68 7775  .    # TODO(zhwu
+0000ade0: 293a 206f 6e63 6520 7765 2064 6570 7265  ): once we depre
+0000adf0: 6361 7465 2074 6865 206f 6c64 2070 726f  cate the old pro
+0000ae00: 7669 7369 6f6e 6572 2c20 7765 2063 616e  visioner, we can
+0000ae10: 2072 656d 6f76 6520 7468 6973 0a20 2020   remove this.   
+0000ae20: 2023 2063 6865 636b 2e0a 2020 2020 7261   # check..    ra
+0000ae30: 795f 6175 746f 7363 616c 6572 5f68 6561  y_autoscaler_hea
+0000ae40: 6420 3d20 6765 745f 7265 6164 795f 6e6f  d = get_ready_no
+0000ae50: 6465 735f 636f 756e 7473 285f 4c41 554e  des_counts(_LAUN
+0000ae60: 4348 4544 5f48 4541 445f 5041 5454 4552  CHED_HEAD_PATTER
+0000ae70: 4e2c 206f 7574 7075 7429 0a20 2020 2069  N, output).    i
+0000ae80: 735f 6c6f 6361 6c5f 7261 795f 636c 7573  s_local_ray_clus
+0000ae90: 7465 7220 3d20 7261 795f 6175 746f 7363  ter = ray_autosc
+0000aea0: 616c 6572 5f68 6561 6420 3d3d 2030 0a0a  aler_head == 0..
+0000aeb0: 2020 2020 6966 2069 735f 6c6f 6361 6c5f      if is_local_
+0000aec0: 7261 795f 636c 7573 7465 7220 6f72 2069  ray_cluster or i
+0000aed0: 735f 6c6f 6361 6c5f 636c 6f75 643a 0a20  s_local_cloud:. 
+0000aee0: 2020 2020 2020 2023 2052 6179 2063 6c75         # Ray clu
+0000aef0: 7374 6572 2069 7320 6c61 756e 6368 6564  ster is launched
+0000af00: 2077 6974 6820 6e65 7720 7072 6f76 6973   with new provis
+0000af10: 696f 6e65 720a 2020 2020 2020 2020 2320  ioner.        # 
+0000af20: 466f 7220 6e65 7720 7072 6f76 6973 696f  For new provisio
+0000af30: 6e65 7220 616e 6420 6c6f 6361 6c20 6d6f  ner and local mo
+0000af40: 6465 2c20 7468 6520 6f75 7470 7574 2077  de, the output w
+0000af50: 696c 6c20 6265 3a0a 2020 2020 2020 2020  ill be:.        
+0000af60: 2320 2031 206e 6f64 655f 7878 7878 0a20  #  1 node_xxxx. 
+0000af70: 2020 2020 2020 2023 2020 3120 6e6f 6465         #  1 node
+0000af80: 5f78 7878 780a 2020 2020 2020 2020 7265  _xxxx.        re
+0000af90: 6164 795f 6865 6164 203d 2030 0a20 2020  ady_head = 0.   
+0000afa0: 2020 2020 2072 6561 6479 5f77 6f72 6b65       ready_worke
+0000afb0: 7273 203d 205f 4c41 554e 4348 4544 5f4c  rs = _LAUNCHED_L
+0000afc0: 4f43 414c 5f57 4f52 4b45 525f 5041 5454  OCAL_WORKER_PATT
+0000afd0: 4552 4e2e 6669 6e64 616c 6c28 6f75 7470  ERN.findall(outp
+0000afe0: 7574 290a 2020 2020 2020 2020 7265 6164  ut).        read
+0000aff0: 795f 776f 726b 6572 7320 3d20 6c65 6e28  y_workers = len(
+0000b000: 7265 6164 795f 776f 726b 6572 7329 0a20  ready_workers). 
+0000b010: 2020 2020 2020 2069 6620 6973 5f6c 6f63         if is_loc
+0000b020: 616c 5f72 6179 5f63 6c75 7374 6572 3a0a  al_ray_cluster:.
+0000b030: 2020 2020 2020 2020 2020 2020 7265 6164              read
+0000b040: 795f 6865 6164 203d 2031 0a20 2020 2020  y_head = 1.     
+0000b050: 2020 2020 2020 2072 6561 6479 5f77 6f72         ready_wor
+0000b060: 6b65 7273 202d 3d20 310a 2020 2020 2020  kers -= 1.      
+0000b070: 2020 7265 7475 726e 2072 6561 6479 5f68    return ready_h
+0000b080: 6561 642c 2072 6561 6479 5f77 6f72 6b65  ead, ready_worke
+0000b090: 7273 0a0a 2020 2020 2320 436f 756e 7420  rs..    # Count 
+0000b0a0: 6e75 6d62 6572 206f 6620 6e6f 6465 7320  number of nodes 
+0000b0b0: 6279 2070 6172 7369 6e67 2074 6865 206f  by parsing the o
+0000b0c0: 7574 7075 7420 6f66 2060 7261 7920 7374  utput of `ray st
+0000b0d0: 6174 7573 602e 2054 6865 206f 7574 7075  atus`. The outpu
+0000b0e0: 740a 2020 2020 2320 6c6f 6f6b 7320 6c69  t.    # looks li
+0000b0f0: 6b65 3a0a 2020 2020 2320 2020 3120 7261  ke:.    #   1 ra
+0000b100: 792e 6865 6164 2e64 6566 6175 6c74 0a20  y.head.default. 
+0000b110: 2020 2023 2020 2032 2072 6179 2e77 6f72     #   2 ray.wor
+0000b120: 6b65 722e 6465 6661 756c 740a 2020 2020  ker.default.    
+0000b130: 7265 6164 795f 6865 6164 203d 2072 6179  ready_head = ray
+0000b140: 5f61 7574 6f73 6361 6c65 725f 6865 6164  _autoscaler_head
+0000b150: 0a20 2020 2072 6561 6479 5f77 6f72 6b65  .    ready_worke
+0000b160: 7273 203d 2067 6574 5f72 6561 6479 5f6e  rs = get_ready_n
+0000b170: 6f64 6573 5f63 6f75 6e74 7328 5f4c 4155  odes_counts(_LAU
+0000b180: 4e43 4845 445f 574f 524b 4552 5f50 4154  NCHED_WORKER_PAT
+0000b190: 5445 524e 2c20 6f75 7470 7574 290a 2020  TERN, output).  
+0000b1a0: 2020 7265 6164 795f 7265 7365 7276 6564    ready_reserved
+0000b1b0: 5f77 6f72 6b65 7273 203d 2067 6574 5f72  _workers = get_r
+0000b1c0: 6561 6479 5f6e 6f64 6573 5f63 6f75 6e74  eady_nodes_count
+0000b1d0: 7328 0a20 2020 2020 2020 205f 4c41 554e  s(.        _LAUN
+0000b1e0: 4348 4544 5f52 4553 4552 5645 445f 574f  CHED_RESERVED_WO
+0000b1f0: 524b 4552 5f50 4154 5445 524e 2c20 6f75  RKER_PATTERN, ou
+0000b200: 7470 7574 290a 2020 2020 7265 6164 795f  tput).    ready_
+0000b210: 776f 726b 6572 7320 2b3d 2072 6561 6479  workers += ready
+0000b220: 5f72 6573 6572 7665 645f 776f 726b 6572  _reserved_worker
+0000b230: 730a 2020 2020 6173 7365 7274 2072 6561  s.    assert rea
+0000b240: 6479 5f68 6561 6420 3c3d 2031 2c20 6627  dy_head <= 1, f'
+0000b250: 2368 6561 6420 6e6f 6465 2073 686f 756c  #head node shoul
+0000b260: 6420 6265 203c 3d31 2028 476f 7420 7b72  d be <=1 (Got {r
+0000b270: 6561 6479 5f68 6561 647d 292e 270a 2020  eady_head}).'.  
+0000b280: 2020 7265 7475 726e 2072 6561 6479 5f68    return ready_h
+0000b290: 6561 642c 2072 6561 6479 5f77 6f72 6b65  ead, ready_worke
+0000b2a0: 7273 0a0a 0a64 6566 2067 6574 5f64 6f63  rs...def get_doc
+0000b2b0: 6b65 725f 7573 6572 2869 703a 2073 7472  ker_user(ip: str
+0000b2c0: 2c20 636c 7573 7465 725f 636f 6e66 6967  , cluster_config
+0000b2d0: 5f66 696c 653a 2073 7472 2920 2d3e 2073  _file: str) -> s
+0000b2e0: 7472 3a0a 2020 2020 2222 2246 696e 6420  tr:.    """Find 
+0000b2f0: 646f 636b 6572 2063 6f6e 7461 696e 6572  docker container
+0000b300: 2075 7365 726e 616d 652e 2222 220a 2020   username.""".  
+0000b310: 2020 7373 685f 6372 6564 656e 7469 616c    ssh_credential
+0000b320: 7320 3d20 7373 685f 6372 6564 656e 7469  s = ssh_credenti
+0000b330: 616c 5f66 726f 6d5f 7961 6d6c 2863 6c75  al_from_yaml(clu
+0000b340: 7374 6572 5f63 6f6e 6669 675f 6669 6c65  ster_config_file
+0000b350: 290a 2020 2020 7275 6e6e 6572 203d 2063  ).    runner = c
+0000b360: 6f6d 6d61 6e64 5f72 756e 6e65 722e 5353  ommand_runner.SS
+0000b370: 4843 6f6d 6d61 6e64 5275 6e6e 6572 2869  HCommandRunner(i
+0000b380: 702c 2070 6f72 743d 3232 2c20 2a2a 7373  p, port=22, **ss
+0000b390: 685f 6372 6564 656e 7469 616c 7329 0a20  h_credentials). 
+0000b3a0: 2020 2063 6f6e 7461 696e 6572 5f6e 616d     container_nam
+0000b3b0: 6520 3d20 636f 6e73 7461 6e74 732e 4445  e = constants.DE
+0000b3c0: 4641 554c 545f 444f 434b 4552 5f43 4f4e  FAULT_DOCKER_CON
+0000b3d0: 5441 494e 4552 5f4e 414d 450a 2020 2020  TAINER_NAME.    
+0000b3e0: 7768 6f61 6d69 5f72 6574 7572 6e63 6f64  whoami_returncod
+0000b3f0: 652c 2077 686f 616d 695f 7374 646f 7574  e, whoami_stdout
+0000b400: 2c20 7768 6f61 6d69 5f73 7464 6572 7220  , whoami_stderr 
+0000b410: 3d20 7275 6e6e 6572 2e72 756e 280a 2020  = runner.run(.  
+0000b420: 2020 2020 2020 6627 7375 646f 2064 6f63        f'sudo doc
+0000b430: 6b65 7220 6578 6563 207b 636f 6e74 6169  ker exec {contai
+0000b440: 6e65 725f 6e61 6d65 7d20 7768 6f61 6d69  ner_name} whoami
+0000b450: 272c 0a20 2020 2020 2020 2073 7472 6561  ',.        strea
+0000b460: 6d5f 6c6f 6773 3d46 616c 7365 2c0a 2020  m_logs=False,.  
+0000b470: 2020 2020 2020 7265 7175 6972 655f 6f75        require_ou
+0000b480: 7470 7574 733d 5472 7565 290a 2020 2020  tputs=True).    
+0000b490: 6173 7365 7274 2077 686f 616d 695f 7265  assert whoami_re
+0000b4a0: 7475 726e 636f 6465 203d 3d20 302c 2028  turncode == 0, (
+0000b4b0: 0a20 2020 2020 2020 2066 2746 6169 6c65  .        f'Faile
+0000b4c0: 6420 746f 2067 6574 2064 6f63 6b65 7220  d to get docker 
+0000b4d0: 636f 6e74 6169 6e65 7220 7573 6572 2e20  container user. 
+0000b4e0: 5265 7475 726e 2027 0a20 2020 2020 2020  Return '.       
+0000b4f0: 2066 2763 6f64 653a 207b 7768 6f61 6d69   f'code: {whoami
+0000b500: 5f72 6574 7572 6e63 6f64 657d 2c20 4572  _returncode}, Er
+0000b510: 726f 723a 207b 7768 6f61 6d69 5f73 7464  ror: {whoami_std
+0000b520: 6572 727d 2729 0a20 2020 2064 6f63 6b65  err}').    docke
+0000b530: 725f 7573 6572 203d 2077 686f 616d 695f  r_user = whoami_
+0000b540: 7374 646f 7574 2e73 7472 6970 2829 0a20  stdout.strip(). 
+0000b550: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+0000b560: 6627 446f 636b 6572 2063 6f6e 7461 696e  f'Docker contain
+0000b570: 6572 2075 7365 723a 207b 646f 636b 6572  er user: {docker
+0000b580: 5f75 7365 727d 2729 0a20 2020 2072 6574  _user}').    ret
+0000b590: 7572 6e20 646f 636b 6572 5f75 7365 720a  urn docker_user.
+0000b5a0: 0a0a 4074 696d 656c 696e 652e 6576 656e  ..@timeline.even
+0000b5b0: 740a 6465 6620 7761 6974 5f75 6e74 696c  t.def wait_until
+0000b5c0: 5f72 6179 5f63 6c75 7374 6572 5f72 6561  _ray_cluster_rea
+0000b5d0: 6479 280a 2020 2020 636c 7573 7465 725f  dy(.    cluster_
+0000b5e0: 636f 6e66 6967 5f66 696c 653a 2073 7472  config_file: str
+0000b5f0: 2c0a 2020 2020 6e75 6d5f 6e6f 6465 733a  ,.    num_nodes:
+0000b600: 2069 6e74 2c0a 2020 2020 6c6f 675f 7061   int,.    log_pa
+0000b610: 7468 3a20 7374 722c 0a20 2020 2069 735f  th: str,.    is_
+0000b620: 6c6f 6361 6c5f 636c 6f75 643a 2062 6f6f  local_cloud: boo
+0000b630: 6c20 3d20 4661 6c73 652c 0a20 2020 206e  l = False,.    n
+0000b640: 6f64 6573 5f6c 6175 6e63 6869 6e67 5f70  odes_launching_p
+0000b650: 726f 6772 6573 735f 7469 6d65 6f75 743a  rogress_timeout:
+0000b660: 204f 7074 696f 6e61 6c5b 696e 745d 203d   Optional[int] =
+0000b670: 204e 6f6e 652c 0a29 202d 3e20 5475 706c   None,.) -> Tupl
+0000b680: 655b 626f 6f6c 2c20 4f70 7469 6f6e 616c  e[bool, Optional
+0000b690: 5b73 7472 5d5d 3a0a 2020 2020 2222 2257  [str]]:.    """W
+0000b6a0: 6169 7420 756e 7469 6c20 7468 6520 7261  ait until the ra
+0000b6b0: 7920 636c 7573 7465 7220 6973 2073 6574  y cluster is set
+0000b6c0: 2075 7020 6f6e 2056 4d73 206f 7220 696e   up on VMs or in
+0000b6d0: 2063 6f6e 7461 696e 6572 732e 0a0a 2020   containers...  
+0000b6e0: 2020 5265 7475 726e 733a 2020 7768 6574    Returns:  whet
+0000b6f0: 6865 7220 7468 6520 656e 7469 7265 2072  her the entire r
+0000b700: 6179 2063 6c75 7374 6572 2069 7320 7265  ay cluster is re
+0000b710: 6164 792c 2061 6e64 2064 6f63 6b65 7220  ady, and docker 
+0000b720: 7573 6572 6e61 6d65 0a20 2020 2069 6620  username.    if 
+0000b730: 6c61 756e 6368 6564 2077 6974 6820 646f  launched with do
+0000b740: 636b 6572 2e0a 2020 2020 2222 220a 2020  cker..    """.  
+0000b750: 2020 2320 4d61 6e75 616c 6c79 2066 6574    # Manually fet
+0000b760: 6368 696e 6720 6865 6164 2069 7020 696e  ching head ip in
+0000b770: 7374 6561 6420 6f66 2075 7369 6e67 2060  stead of using `
+0000b780: 7261 7920 6578 6563 6020 746f 2061 766f  ray exec` to avo
+0000b790: 6964 2074 6865 2062 7567 0a20 2020 2023  id the bug.    #
+0000b7a0: 2074 6861 7420 6072 6179 2065 7865 6360   that `ray exec`
+0000b7b0: 2066 6169 6c73 2074 6f20 636f 6e6e 6563   fails to connec
+0000b7c0: 7420 746f 2074 6865 2068 6561 6420 6e6f  t to the head no
+0000b7d0: 6465 2061 6674 6572 2073 6f6d 6520 776f  de after some wo
+0000b7e0: 726b 6572 730a 2020 2020 2320 6c61 756e  rkers.    # laun
+0000b7f0: 6368 6564 2065 7370 6563 6961 6c6c 7920  ched especially 
+0000b800: 666f 7220 417a 7572 652e 0a20 2020 2074  for Azure..    t
+0000b810: 7279 3a0a 2020 2020 2020 2020 6865 6164  ry:.        head
+0000b820: 5f69 7020 3d20 5f71 7565 7279 5f68 6561  _ip = _query_hea
+0000b830: 645f 6970 5f77 6974 685f 7265 7472 6965  d_ip_with_retrie
+0000b840: 7328 0a20 2020 2020 2020 2020 2020 2063  s(.            c
+0000b850: 6c75 7374 6572 5f63 6f6e 6669 675f 6669  luster_config_fi
+0000b860: 6c65 2c20 6d61 785f 6174 7465 6d70 7473  le, max_attempts
+0000b870: 3d57 4149 545f 4845 4144 5f4e 4f44 455f  =WAIT_HEAD_NODE_
+0000b880: 4950 5f4d 4158 5f41 5454 454d 5054 5329  IP_MAX_ATTEMPTS)
+0000b890: 0a20 2020 2065 7863 6570 7420 6578 6365  .    except exce
+0000b8a0: 7074 696f 6e73 2e46 6574 6368 4950 4572  ptions.FetchIPEr
+0000b8b0: 726f 7220 6173 2065 3a0a 2020 2020 2020  ror as e:.      
+0000b8c0: 2020 6c6f 6767 6572 2e65 7272 6f72 2863    logger.error(c
+0000b8d0: 6f6d 6d6f 6e5f 7574 696c 732e 666f 726d  ommon_utils.form
+0000b8e0: 6174 5f65 7863 6570 7469 6f6e 2865 2929  at_exception(e))
+0000b8f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000b900: 4661 6c73 652c 204e 6f6e 6520 2023 2066  False, None  # f
+0000b910: 6169 6c65 640a 0a20 2020 2063 6f6e 6669  ailed..    confi
+0000b920: 6720 3d20 636f 6d6d 6f6e 5f75 7469 6c73  g = common_utils
+0000b930: 2e72 6561 645f 7961 6d6c 2863 6c75 7374  .read_yaml(clust
+0000b940: 6572 5f63 6f6e 6669 675f 6669 6c65 290a  er_config_file).
+0000b950: 0a20 2020 2064 6f63 6b65 725f 7573 6572  .    docker_user
+0000b960: 203d 204e 6f6e 650a 2020 2020 6966 2027   = None.    if '
+0000b970: 646f 636b 6572 2720 696e 2063 6f6e 6669  docker' in confi
+0000b980: 673a 0a20 2020 2020 2020 2064 6f63 6b65  g:.        docke
+0000b990: 725f 7573 6572 203d 2067 6574 5f64 6f63  r_user = get_doc
+0000b9a0: 6b65 725f 7573 6572 2868 6561 645f 6970  ker_user(head_ip
+0000b9b0: 2c20 636c 7573 7465 725f 636f 6e66 6967  , cluster_config
+0000b9c0: 5f66 696c 6529 0a0a 2020 2020 6966 206e  _file)..    if n
+0000b9d0: 756d 5f6e 6f64 6573 203c 3d20 313a 0a20  um_nodes <= 1:. 
+0000b9e0: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
+0000b9f0: 7565 2c20 646f 636b 6572 5f75 7365 720a  ue, docker_user.
+0000ba00: 0a20 2020 2073 7368 5f63 7265 6465 6e74  .    ssh_credent
+0000ba10: 6961 6c73 203d 2073 7368 5f63 7265 6465  ials = ssh_crede
+0000ba20: 6e74 6961 6c5f 6672 6f6d 5f79 616d 6c28  ntial_from_yaml(
+0000ba30: 636c 7573 7465 725f 636f 6e66 6967 5f66  cluster_config_f
+0000ba40: 696c 652c 2064 6f63 6b65 725f 7573 6572  ile, docker_user
+0000ba50: 290a 2020 2020 6c61 7374 5f6e 6f64 6573  ).    last_nodes
+0000ba60: 5f73 6f5f 6661 7220 3d20 300a 2020 2020  _so_far = 0.    
+0000ba70: 7374 6172 7420 3d20 7469 6d65 2e74 696d  start = time.tim
+0000ba80: 6528 290a 2020 2020 7275 6e6e 6572 203d  e().    runner =
+0000ba90: 2063 6f6d 6d61 6e64 5f72 756e 6e65 722e   command_runner.
+0000baa0: 5353 4843 6f6d 6d61 6e64 5275 6e6e 6572  SSHCommandRunner
+0000bab0: 2868 6561 645f 6970 2c0a 2020 2020 2020  (head_ip,.      
+0000bac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bae0: 2020 2020 2020 2070 6f72 743d 3232 2c0a         port=22,.
+0000baf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bb10: 2020 2020 2020 2020 2020 2020 202a 2a73               **s
+0000bb20: 7368 5f63 7265 6465 6e74 6961 6c73 290a  sh_credentials).
+0000bb30: 2020 2020 7769 7468 2072 6963 685f 7574      with rich_ut
+0000bb40: 696c 732e 7361 6665 5f73 7461 7475 7328  ils.safe_status(
+0000bb50: 0a20 2020 2020 2020 2020 2020 2027 5b62  .            '[b
+0000bb60: 6f6c 6420 6379 616e 5d57 6169 7469 6e67  old cyan]Waiting
+0000bb70: 2066 6f72 2077 6f72 6b65 7273 2e2e 2e27   for workers...'
+0000bb80: 2920 6173 2077 6f72 6b65 725f 7374 6174  ) as worker_stat
+0000bb90: 7573 3a0a 2020 2020 2020 2020 7768 696c  us:.        whil
+0000bba0: 6520 5472 7565 3a0a 2020 2020 2020 2020  e True:.        
+0000bbb0: 2020 2020 7263 2c20 6f75 7470 7574 2c20      rc, output, 
+0000bbc0: 7374 6465 7272 203d 2072 756e 6e65 722e  stderr = runner.
+0000bbd0: 7275 6e28 0a20 2020 2020 2020 2020 2020  run(.           
+0000bbe0: 2020 2020 2069 6e73 7461 6e63 655f 7365       instance_se
+0000bbf0: 7475 702e 5241 595f 5354 4154 5553 5f57  tup.RAY_STATUS_W
+0000bc00: 4954 485f 534b 595f 5241 595f 504f 5254  ITH_SKY_RAY_PORT
+0000bc10: 5f43 4f4d 4d41 4e44 2c0a 2020 2020 2020  _COMMAND,.      
+0000bc20: 2020 2020 2020 2020 2020 6c6f 675f 7061            log_pa
+0000bc30: 7468 3d6c 6f67 5f70 6174 682c 0a20 2020  th=log_path,.   
+0000bc40: 2020 2020 2020 2020 2020 2020 2073 7472               str
+0000bc50: 6561 6d5f 6c6f 6773 3d46 616c 7365 2c0a  eam_logs=False,.
+0000bc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bc70: 7265 7175 6972 655f 6f75 7470 7574 733d  require_outputs=
+0000bc80: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+0000bc90: 2020 2020 2020 7365 7061 7261 7465 5f73        separate_s
+0000bca0: 7464 6572 723d 5472 7565 290a 2020 2020  tderr=True).    
+0000bcb0: 2020 2020 2020 2020 7375 6270 726f 6365          subproce
+0000bcc0: 7373 5f75 7469 6c73 2e68 616e 646c 655f  ss_utils.handle_
+0000bcd0: 7265 7475 726e 636f 6465 280a 2020 2020  returncode(.    
+0000bce0: 2020 2020 2020 2020 2020 2020 7263 2c20              rc, 
+0000bcf0: 696e 7374 616e 6365 5f73 6574 7570 2e52  instance_setup.R
+0000bd00: 4159 5f53 5441 5455 535f 5749 5448 5f53  AY_STATUS_WITH_S
+0000bd10: 4b59 5f52 4159 5f50 4f52 545f 434f 4d4d  KY_RAY_PORT_COMM
+0000bd20: 414e 442c 0a20 2020 2020 2020 2020 2020  AND,.           
+0000bd30: 2020 2020 2027 4661 696c 6564 2074 6f20       'Failed to 
+0000bd40: 7275 6e20 7261 7920 7374 6174 7573 206f  run ray status o
+0000bd50: 6e20 6865 6164 206e 6f64 652e 272c 2073  n head node.', s
+0000bd60: 7464 6572 7229 0a20 2020 2020 2020 2020  tderr).         
+0000bd70: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+0000bd80: 6f75 7470 7574 290a 0a20 2020 2020 2020  output)..       
+0000bd90: 2020 2020 2072 6561 6479 5f68 6561 642c       ready_head,
+0000bda0: 2072 6561 6479 5f77 6f72 6b65 7273 203d   ready_workers =
+0000bdb0: 205f 636f 756e 745f 6865 616c 7468 795f   _count_healthy_
+0000bdc0: 6e6f 6465 735f 6672 6f6d 5f72 6179 280a  nodes_from_ray(.
+0000bdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bde0: 6f75 7470 7574 2c20 6973 5f6c 6f63 616c  output, is_local
+0000bdf0: 5f63 6c6f 7564 3d69 735f 6c6f 6361 6c5f  _cloud=is_local_
+0000be00: 636c 6f75 6429 0a0a 2020 2020 2020 2020  cloud)..        
+0000be10: 2020 2020 776f 726b 6572 5f73 7461 7475      worker_statu
+0000be20: 732e 7570 6461 7465 2827 5b62 6f6c 6420  s.update('[bold 
+0000be30: 6379 616e 5d27 0a20 2020 2020 2020 2020  cyan]'.         
+0000be40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000be50: 2020 2020 2020 2020 6627 7b72 6561 6479          f'{ready
+0000be60: 5f77 6f72 6b65 7273 7d20 6f75 7420 6f66  _workers} out of
+0000be70: 207b 6e75 6d5f 6e6f 6465 7320 2d20 317d   {num_nodes - 1}
+0000be80: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0000be90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bea0: 2020 2020 2777 6f72 6b65 7273 2072 6561      'workers rea
+0000beb0: 6479 2729 0a0a 2020 2020 2020 2020 2020  dy')..          
+0000bec0: 2020 2320 496e 2074 6865 206c 6f63 616c    # In the local
+0000bed0: 2063 6173 652c 2072 6561 6479 5f68 6561   case, ready_hea
+0000bee0: 643d 3020 616e 6420 7265 6164 795f 776f  d=0 and ready_wo
+0000bef0: 726b 6572 733d 6e75 6d5f 6e6f 6465 732e  rkers=num_nodes.
+0000bf00: 2054 6869 730a 2020 2020 2020 2020 2020   This.          
+0000bf10: 2020 2320 6973 2062 6563 6175 7365 2074    # is because t
+0000bf20: 6865 7265 2069 7320 6e6f 206d 6174 6368  here is no match
+0000bf30: 696e 6720 7265 6765 7820 666f 7220 5f4c  ing regex for _L
+0000bf40: 4155 4e43 4845 445f 4845 4144 5f50 4154  AUNCHED_HEAD_PAT
+0000bf50: 5445 524e 2e0a 2020 2020 2020 2020 2020  TERN..          
+0000bf60: 2020 6966 2072 6561 6479 5f68 6561 6420    if ready_head 
+0000bf70: 2b20 7265 6164 795f 776f 726b 6572 7320  + ready_workers 
+0000bf80: 3d3d 206e 756d 5f6e 6f64 6573 3a0a 2020  == num_nodes:.  
+0000bf90: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000bfa0: 416c 6c20 6e6f 6465 7320 6172 6520 7570  All nodes are up
+0000bfb0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000bfc0: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
+0000bfd0: 2020 2020 2023 2050 656e 6469 6e67 2077       # Pending w
+0000bfe0: 6f72 6b65 7273 2074 6861 7420 6861 7665  orkers that have
+0000bff0: 2062 6565 6e20 6c61 756e 6368 6564 2062   been launched b
+0000c000: 7920 7261 7920 7570 2e0a 2020 2020 2020  y ray up..      
+0000c010: 2020 2020 2020 666f 756e 645f 6970 7320        found_ips 
+0000c020: 3d20 5f4c 4155 4e43 4849 4e47 5f49 505f  = _LAUNCHING_IP_
+0000c030: 5041 5454 4552 4e2e 6669 6e64 616c 6c28  PATTERN.findall(
+0000c040: 6f75 7470 7574 290a 2020 2020 2020 2020  output).        
+0000c050: 2020 2020 7065 6e64 696e 675f 776f 726b      pending_work
+0000c060: 6572 7320 3d20 6c65 6e28 666f 756e 645f  ers = len(found_
+0000c070: 6970 7329 0a0a 2020 2020 2020 2020 2020  ips)..          
+0000c080: 2020 2320 544f 444f 287a 6877 7529 3a20    # TODO(zhwu): 
+0000c090: 4861 6e64 6c65 2074 6865 2063 6173 6520  Handle the case 
+0000c0a0: 7768 6572 6520 7468 6520 666f 6c6c 6f77  where the follow
+0000c0b0: 696e 6720 6f63 6375 7273 2c20 7768 6572  ing occurs, wher
+0000c0c0: 6520 7261 790a 2020 2020 2020 2020 2020  e ray.          
+0000c0d0: 2020 2320 636c 7573 7465 7220 6973 206e    # cluster is n
+0000c0e0: 6f74 2063 6f72 7265 6374 6c79 2073 7461  ot correctly sta
+0000c0f0: 7274 6564 206f 6e20 7468 6520 636c 7573  rted on the clus
+0000c100: 7465 722e 0a20 2020 2020 2020 2020 2020  ter..           
+0000c110: 2023 2050 656e 6469 6e67 3a0a 2020 2020   # Pending:.    
+0000c120: 2020 2020 2020 2020 2320 2031 3732 2e33          #  172.3
+0000c130: 312e 392e 3132 313a 2072 6179 2e77 6f72  1.9.121: ray.wor
+0000c140: 6b65 722e 6465 6661 756c 742c 2075 6e69  ker.default, uni
+0000c150: 6e69 7469 616c 697a 6564 0a20 2020 2020  nitialized.     
+0000c160: 2020 2020 2020 206e 6f64 6573 5f73 6f5f         nodes_so_
+0000c170: 6661 7220 3d20 7265 6164 795f 6865 6164  far = ready_head
+0000c180: 202b 2072 6561 6479 5f77 6f72 6b65 7273   + ready_workers
+0000c190: 202b 2070 656e 6469 6e67 5f77 6f72 6b65   + pending_worke
+0000c1a0: 7273 0a0a 2020 2020 2020 2020 2020 2020  rs..            
+0000c1b0: 2320 4368 6563 6b20 7468 6520 6e75 6d62  # Check the numb
+0000c1c0: 6572 206f 6620 6e6f 6465 7320 7468 6174  er of nodes that
+0000c1d0: 2061 7265 2066 6574 6368 6564 2e20 5469   are fetched. Ti
+0000c1e0: 6d65 6f75 7420 6966 206e 6f20 6e65 770a  meout if no new.
+0000c1f0: 2020 2020 2020 2020 2020 2020 2320 6e6f              # no
+0000c200: 6465 7320 6665 7463 6865 6420 696e 2061  des fetched in a
+0000c210: 2077 6869 6c65 2028 6e6f 6465 735f 6c61   while (nodes_la
+0000c220: 756e 6368 696e 675f 7072 6f67 7265 7373  unching_progress
+0000c230: 5f74 696d 656f 7574 292c 0a20 2020 2020  _timeout),.     
+0000c240: 2020 2020 2020 2023 2074 686f 7567 6820         # though 
+0000c250: 6e75 6d62 6572 206f 6620 6e6f 6465 735f  number of nodes_
+0000c260: 736f 5f66 6172 2069 7320 7374 696c 6c20  so_far is still 
+0000c270: 6e6f 7420 6173 2065 7870 6563 7465 642e  not as expected.
+0000c280: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000c290: 6e6f 6465 735f 736f 5f66 6172 203e 206c  nodes_so_far > l
+0000c2a0: 6173 745f 6e6f 6465 735f 736f 5f66 6172  ast_nodes_so_far
+0000c2b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000c2c0: 2020 2320 5265 7365 7420 7468 6520 7374    # Reset the st
+0000c2d0: 6172 7420 7469 6d65 2069 6620 7468 6520  art time if the 
+0000c2e0: 6e75 6d62 6572 206f 6620 6c61 756e 6368  number of launch
+0000c2f0: 696e 6720 6e6f 6465 730a 2020 2020 2020  ing nodes.      
+0000c300: 2020 2020 2020 2020 2020 2320 6368 616e            # chan
+0000c310: 6765 732c 2069 2e65 2e20 6e65 7720 6e6f  ges, i.e. new no
+0000c320: 6465 7320 6172 6520 6c61 756e 6368 6564  des are launched
+0000c330: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000c340: 2020 6c6f 6767 6572 2e64 6562 7567 2827    logger.debug('
+0000c350: 5265 7365 7420 7374 6172 7420 7469 6d65  Reset start time
+0000c360: 2c20 6173 206e 6577 206e 6f64 6573 2061  , as new nodes a
+0000c370: 7265 206c 6175 6e63 6865 642e 2027 0a20  re launched. '. 
 0000c380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c390: 2020 6627 7b6e 6f64 6573 5f6c 6175 6e63    f'{nodes_launc
-0000c3a0: 6869 6e67 5f70 726f 6772 6573 735f 7469  hing_progress_ti
-0000c3b0: 6d65 6f75 747d 2073 6563 6f6e 6473 2066  meout} seconds f
-0000c3c0: 6f72 206e 6577 2027 0a20 2020 2020 2020  or new '.       
-0000c3d0: 2020 2020 2020 2020 2020 2020 2027 776f               'wo
-0000c3e0: 726b 6572 7320 746f 2062 6520 7072 6f76  rkers to be prov
-0000c3f0: 6973 696f 6e65 642c 2062 7574 206e 6f20  isioned, but no 
-0000c400: 7072 6f67 7265 7373 2e27 290a 2020 2020  progress.').    
-0000c410: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000c420: 726e 2046 616c 7365 2c20 4e6f 6e65 2020  rn False, None  
-0000c430: 2320 6661 696c 6564 0a0a 2020 2020 2020  # failed..      
-0000c440: 2020 2020 2020 6966 2027 286e 6f20 7065        if '(no pe
-0000c450: 6e64 696e 6720 6e6f 6465 7329 2720 696e  nding nodes)' in
-0000c460: 206f 7574 7075 7420 616e 6420 2728 6e6f   output and '(no
-0000c470: 2066 6169 6c75 7265 7329 2720 696e 206f   failures)' in o
-0000c480: 7574 7075 743a 0a20 2020 2020 2020 2020  utput:.         
-0000c490: 2020 2020 2020 2023 2042 7567 2069 6e20         # Bug in 
-0000c4a0: 7261 7920 6175 746f 7363 616c 6572 3a20  ray autoscaler: 
-0000c4b0: 652e 672e 2c20 6f6e 2047 4350 2c20 6966  e.g., on GCP, if
-0000c4c0: 2072 6571 7565 7374 696e 6720 3220 6e6f   requesting 2 no
-0000c4d0: 6465 730a 2020 2020 2020 2020 2020 2020  des.            
-0000c4e0: 2020 2020 2320 7468 6174 2047 4350 2063      # that GCP c
-0000c4f0: 616e 2073 6174 6973 6679 206f 6e6c 7920  an satisfy only 
-0000c500: 6279 2068 616c 662c 2074 6865 2077 6f72  by half, the wor
-0000c510: 6b65 7220 6e6f 6465 2077 6f75 6c64 2062  ker node would b
-0000c520: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0000c530: 2020 2320 666f 7267 6f74 7465 6e2e 2054    # forgotten. T
-0000c540: 6865 2063 6f72 7265 6374 2062 6568 6176  he correct behav
-0000c550: 696f 7220 7368 6f75 6c64 2062 6520 666f  ior should be fo
-0000c560: 7220 6974 2074 6f20 6572 726f 7220 6f75  r it to error ou
-0000c570: 742e 0a20 2020 2020 2020 2020 2020 2020  t..             
-0000c580: 2020 206c 6f67 6765 722e 6572 726f 7228     logger.error(
-0000c590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c5a0: 2020 2020 2027 4661 696c 6564 2074 6f20       'Failed to 
-0000c5b0: 6c61 756e 6368 206d 756c 7469 706c 6520  launch multiple 
-0000c5c0: 6e6f 6465 7320 6f6e 2027 0a20 2020 2020  nodes on '.     
-0000c5d0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0000c5e0: 4743 5020 6475 6520 746f 2061 206e 6f6e  GCP due to a non
-0000c5f0: 6465 7465 726d 696e 6973 7469 6320 6275  deterministic bu
-0000c600: 6720 696e 2072 6179 2061 7574 6f73 6361  g in ray autosca
-0000c610: 6c65 722e 2729 0a20 2020 2020 2020 2020  ler.').         
-0000c620: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
-0000c630: 6c73 652c 204e 6f6e 6520 2023 2066 6169  lse, None  # fai
-0000c640: 6c65 640a 2020 2020 2020 2020 2020 2020  led.            
-0000c650: 7469 6d65 2e73 6c65 6570 2831 3029 0a20  time.sleep(10). 
-0000c660: 2020 2072 6574 7572 6e20 5472 7565 2c20     return True, 
-0000c670: 646f 636b 6572 5f75 7365 7220 2023 2073  docker_user  # s
-0000c680: 7563 6365 7373 0a0a 0a64 6566 2073 7368  uccess...def ssh
-0000c690: 5f63 7265 6465 6e74 6961 6c5f 6672 6f6d  _credential_from
-0000c6a0: 5f79 616d 6c28 0a20 2020 2063 6c75 7374  _yaml(.    clust
-0000c6b0: 6572 5f79 616d 6c3a 2073 7472 2c0a 2020  er_yaml: str,.  
-0000c6c0: 2020 646f 636b 6572 5f75 7365 723a 204f    docker_user: O
-0000c6d0: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
-0000c6e0: 6f6e 652c 0a20 2020 2073 7368 5f75 7365  one,.    ssh_use
-0000c6f0: 723a 204f 7074 696f 6e61 6c5b 7374 725d  r: Optional[str]
-0000c700: 203d 204e 6f6e 652c 0a29 202d 3e20 4469   = None,.) -> Di
-0000c710: 6374 5b73 7472 2c20 416e 795d 3a0a 2020  ct[str, Any]:.  
-0000c720: 2020 2222 2252 6574 7572 6e73 2073 7368    """Returns ssh
-0000c730: 5f75 7365 722c 2073 7368 5f70 7269 7661  _user, ssh_priva
-0000c740: 7465 5f6b 6579 2061 6e64 2073 7368 5f63  te_key and ssh_c
-0000c750: 6f6e 7472 6f6c 206e 616d 652e 0a0a 2020  ontrol name...  
-0000c760: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-0000c770: 636c 7573 7465 725f 7961 6d6c 3a20 7061  cluster_yaml: pa
-0000c780: 7468 2074 6f20 7468 6520 636c 7573 7465  th to the cluste
-0000c790: 7220 7961 6d6c 2e0a 2020 2020 2020 2020  r yaml..        
-0000c7a0: 646f 636b 6572 5f75 7365 723a 2077 6865  docker_user: whe
-0000c7b0: 6e20 7573 696e 6720 6375 7374 6f6d 2064  n using custom d
-0000c7c0: 6f63 6b65 7220 696d 6167 652c 2075 7365  ocker image, use
-0000c7d0: 2074 6869 7320 7573 6572 2074 6f20 7373   this user to ss
-0000c7e0: 6820 696e 746f 0a20 2020 2020 2020 2020  h into.         
-0000c7f0: 2020 2074 6865 2064 6f63 6b65 7220 636f     the docker co
-0000c800: 6e74 6169 6e65 722e 0a20 2020 2020 2020  ntainer..       
-0000c810: 2073 7368 5f75 7365 723a 206f 7665 7272   ssh_user: overr
-0000c820: 6964 6520 7468 6520 7373 685f 7573 6572  ide the ssh_user
-0000c830: 2069 6e20 7468 6520 636c 7573 7465 7220   in the cluster 
-0000c840: 7961 6d6c 2e0a 2020 2020 2222 220a 2020  yaml..    """.  
-0000c850: 2020 636f 6e66 6967 203d 2063 6f6d 6d6f    config = commo
-0000c860: 6e5f 7574 696c 732e 7265 6164 5f79 616d  n_utils.read_yam
-0000c870: 6c28 636c 7573 7465 725f 7961 6d6c 290a  l(cluster_yaml).
-0000c880: 2020 2020 6175 7468 5f73 6563 7469 6f6e      auth_section
-0000c890: 203d 2063 6f6e 6669 675b 2761 7574 6827   = config['auth'
-0000c8a0: 5d0a 2020 2020 6966 2073 7368 5f75 7365  ].    if ssh_use
-0000c8b0: 7220 6973 204e 6f6e 653a 0a20 2020 2020  r is None:.     
-0000c8c0: 2020 2073 7368 5f75 7365 7220 3d20 6175     ssh_user = au
-0000c8d0: 7468 5f73 6563 7469 6f6e 5b27 7373 685f  th_section['ssh_
-0000c8e0: 7573 6572 275d 2e73 7472 6970 2829 0a20  user'].strip(). 
-0000c8f0: 2020 2073 7368 5f70 7269 7661 7465 5f6b     ssh_private_k
-0000c900: 6579 203d 2061 7574 685f 7365 6374 696f  ey = auth_sectio
-0000c910: 6e2e 6765 7428 2773 7368 5f70 7269 7661  n.get('ssh_priva
-0000c920: 7465 5f6b 6579 2729 0a20 2020 2073 7368  te_key').    ssh
-0000c930: 5f63 6f6e 7472 6f6c 5f6e 616d 6520 3d20  _control_name = 
-0000c940: 636f 6e66 6967 2e67 6574 2827 636c 7573  config.get('clus
-0000c950: 7465 725f 6e61 6d65 272c 2027 5f5f 6465  ter_name', '__de
-0000c960: 6661 756c 745f 5f27 290a 2020 2020 7373  fault__').    ss
-0000c970: 685f 7072 6f78 795f 636f 6d6d 616e 6420  h_proxy_command 
-0000c980: 3d20 6175 7468 5f73 6563 7469 6f6e 2e67  = auth_section.g
-0000c990: 6574 2827 7373 685f 7072 6f78 795f 636f  et('ssh_proxy_co
-0000c9a0: 6d6d 616e 6427 290a 2020 2020 6372 6564  mmand').    cred
-0000c9b0: 656e 7469 616c 7320 3d20 7b0a 2020 2020  entials = {.    
-0000c9c0: 2020 2020 2773 7368 5f75 7365 7227 3a20      'ssh_user': 
-0000c9d0: 7373 685f 7573 6572 2c0a 2020 2020 2020  ssh_user,.      
-0000c9e0: 2020 2773 7368 5f70 7269 7661 7465 5f6b    'ssh_private_k
-0000c9f0: 6579 273a 2073 7368 5f70 7269 7661 7465  ey': ssh_private
-0000ca00: 5f6b 6579 2c0a 2020 2020 2020 2020 2773  _key,.        's
-0000ca10: 7368 5f63 6f6e 7472 6f6c 5f6e 616d 6527  sh_control_name'
-0000ca20: 3a20 7373 685f 636f 6e74 726f 6c5f 6e61  : ssh_control_na
-0000ca30: 6d65 2c0a 2020 2020 2020 2020 2773 7368  me,.        'ssh
-0000ca40: 5f70 726f 7879 5f63 6f6d 6d61 6e64 273a  _proxy_command':
-0000ca50: 2073 7368 5f70 726f 7879 5f63 6f6d 6d61   ssh_proxy_comma
-0000ca60: 6e64 2c0a 2020 2020 7d0a 2020 2020 6966  nd,.    }.    if
-0000ca70: 2064 6f63 6b65 725f 7573 6572 2069 7320   docker_user is 
-0000ca80: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0000ca90: 2020 6372 6564 656e 7469 616c 735b 2764    credentials['d
-0000caa0: 6f63 6b65 725f 7573 6572 275d 203d 2064  ocker_user'] = d
-0000cab0: 6f63 6b65 725f 7573 6572 0a20 2020 2073  ocker_user.    s
-0000cac0: 7368 5f70 726f 7669 6465 725f 6d6f 6475  sh_provider_modu
-0000cad0: 6c65 203d 2063 6f6e 6669 675b 2770 726f  le = config['pro
-0000cae0: 7669 6465 7227 5d5b 276d 6f64 756c 6527  vider']['module'
-0000caf0: 5d0a 2020 2020 2320 4966 2077 6520 6172  ].    # If we ar
-0000cb00: 6520 7275 6e6e 696e 6720 7373 6820 636f  e running ssh co
-0000cb10: 6d6d 616e 6420 6f6e 206b 7562 6572 6e65  mmand on kuberne
-0000cb20: 7465 7320 6e6f 6465 2e0a 2020 2020 6966  tes node..    if
-0000cb30: 2027 6b75 6265 726e 6574 6573 2720 696e   'kubernetes' in
-0000cb40: 2073 7368 5f70 726f 7669 6465 725f 6d6f   ssh_provider_mo
-0000cb50: 6475 6c65 3a0a 2020 2020 2020 2020 6372  dule:.        cr
-0000cb60: 6564 656e 7469 616c 735b 2764 6973 6162  edentials['disab
-0000cb70: 6c65 5f63 6f6e 7472 6f6c 5f6d 6173 7465  le_control_maste
-0000cb80: 7227 5d20 3d20 5472 7565 0a20 2020 2072  r'] = True.    r
-0000cb90: 6574 7572 6e20 6372 6564 656e 7469 616c  eturn credential
-0000cba0: 730a 0a0a 6465 6620 7061 7261 6c6c 656c  s...def parallel
-0000cbb0: 5f64 6174 615f 7472 616e 7366 6572 5f74  _data_transfer_t
-0000cbc0: 6f5f 6e6f 6465 7328 0a20 2020 2072 756e  o_nodes(.    run
-0000cbd0: 6e65 7273 3a20 4c69 7374 5b63 6f6d 6d61  ners: List[comma
-0000cbe0: 6e64 5f72 756e 6e65 722e 5353 4843 6f6d  nd_runner.SSHCom
-0000cbf0: 6d61 6e64 5275 6e6e 6572 5d2c 0a20 2020  mandRunner],.   
-0000cc00: 2073 6f75 7263 653a 204f 7074 696f 6e61   source: Optiona
-0000cc10: 6c5b 7374 725d 2c0a 2020 2020 7461 7267  l[str],.    targ
-0000cc20: 6574 3a20 7374 722c 0a20 2020 2063 6d64  et: str,.    cmd
-0000cc30: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d2c  : Optional[str],
-0000cc40: 0a20 2020 2072 756e 5f72 7379 6e63 3a20  .    run_rsync: 
-0000cc50: 626f 6f6c 2c0a 2020 2020 2a2c 0a20 2020  bool,.    *,.   
-0000cc60: 2061 6374 696f 6e5f 6d65 7373 6167 653a   action_message:
-0000cc70: 2073 7472 2c0a 2020 2020 2320 4164 7661   str,.    # Adva
-0000cc80: 6e63 6564 206f 7074 696f 6e73 2e0a 2020  nced options..  
-0000cc90: 2020 6c6f 675f 7061 7468 3a20 7374 7220    log_path: str 
-0000cca0: 3d20 6f73 2e64 6576 6e75 6c6c 2c0a 2020  = os.devnull,.  
-0000ccb0: 2020 7374 7265 616d 5f6c 6f67 733a 2062    stream_logs: b
-0000ccc0: 6f6f 6c20 3d20 4661 6c73 652c 0a29 3a0a  ool = False,.):.
-0000ccd0: 2020 2020 2222 2252 756e 7320 6120 636f      """Runs a co
-0000cce0: 6d6d 616e 6420 6f6e 2061 6c6c 206e 6f64  mmand on all nod
-0000ccf0: 6573 2061 6e64 206f 7074 696f 6e61 6c6c  es and optionall
-0000cd00: 7920 7275 6e73 2072 7379 6e63 2066 726f  y runs rsync fro
-0000cd10: 6d20 7372 632d 3e64 7374 2e0a 0a20 2020  m src->dst...   
-0000cd20: 2041 7267 733a 0a20 2020 2020 2020 2072   Args:.        r
-0000cd30: 756e 6e65 7273 3a20 4120 6c69 7374 206f  unners: A list o
-0000cd40: 6620 5353 4843 6f6d 6d61 6e64 5275 6e6e  f SSHCommandRunn
-0000cd50: 6572 206f 626a 6563 7473 2074 6861 7420  er objects that 
-0000cd60: 7265 7072 6573 656e 7420 6d75 6c74 6970  represent multip
-0000cd70: 6c65 206e 6f64 6573 2e0a 2020 2020 2020  le nodes..      
-0000cd80: 2020 736f 7572 6365 3a20 4f70 7469 6f6e    source: Option
-0000cd90: 616c 5b73 7472 5d3b 2053 6f75 7263 6520  al[str]; Source 
-0000cda0: 666f 7220 7273 796e 6320 6f6e 206c 6f63  for rsync on loc
-0000cdb0: 616c 206e 6f64 650a 2020 2020 2020 2020  al node.        
-0000cdc0: 7461 7267 6574 3a20 7374 723b 2044 6573  target: str; Des
-0000cdd0: 7469 6e61 7469 6f6e 206f 6e20 7265 6d6f  tination on remo
-0000cde0: 7465 206e 6f64 6520 666f 7220 7273 796e  te node for rsyn
-0000cdf0: 630a 2020 2020 2020 2020 636d 643a 2073  c.        cmd: s
-0000ce00: 7472 3b20 436f 6d6d 616e 6420 746f 2062  tr; Command to b
-0000ce10: 6520 6578 6563 7574 6564 206f 6e20 616c  e executed on al
-0000ce20: 6c20 6e6f 6465 730a 2020 2020 2020 2020  l nodes.        
-0000ce30: 6163 7469 6f6e 5f6d 6573 7361 6765 3a20  action_message: 
-0000ce40: 7374 723b 204d 6573 7361 6765 2074 6f20  str; Message to 
-0000ce50: 6265 2070 7269 6e74 6564 2077 6869 6c65  be printed while
-0000ce60: 2074 6865 2063 6f6d 6d61 6e64 2072 756e   the command run
-0000ce70: 730a 2020 2020 2020 2020 6c6f 675f 7061  s.        log_pa
-0000ce80: 7468 3a20 7374 723b 2050 6174 6820 746f  th: str; Path to
-0000ce90: 2074 6865 206c 6f67 2066 696c 650a 2020   the log file.  
-0000cea0: 2020 2020 2020 7374 7265 616d 5f6c 6f67        stream_log
-0000ceb0: 733a 2062 6f6f 6c3b 2057 6865 7468 6572  s: bool; Whether
-0000cec0: 2074 6f20 7374 7265 616d 206c 6f67 7320   to stream logs 
-0000ced0: 746f 2073 7464 6f75 740a 2020 2020 2222  to stdout.    ""
-0000cee0: 220a 2020 2020 666f 7265 203d 2063 6f6c  ".    fore = col
-0000cef0: 6f72 616d 612e 466f 7265 0a20 2020 2073  orama.Fore.    s
-0000cf00: 7479 6c65 203d 2063 6f6c 6f72 616d 612e  tyle = colorama.
-0000cf10: 5374 796c 650a 0a20 2020 206f 7269 6769  Style..    origi
-0000cf20: 6e5f 736f 7572 6365 203d 2073 6f75 7263  n_source = sourc
-0000cf30: 650a 0a20 2020 2064 6566 205f 7379 6e63  e..    def _sync
-0000cf40: 5f6e 6f64 6528 7275 6e6e 6572 3a20 2763  _node(runner: 'c
-0000cf50: 6f6d 6d61 6e64 5f72 756e 6e65 722e 5353  ommand_runner.SS
-0000cf60: 4843 6f6d 6d61 6e64 5275 6e6e 6572 2729  HCommandRunner')
-0000cf70: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0000cf80: 2020 6966 2063 6d64 2069 7320 6e6f 7420    if cmd is not 
-0000cf90: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0000cfa0: 2020 7263 2c20 7374 646f 7574 2c20 7374    rc, stdout, st
-0000cfb0: 6465 7272 203d 2072 756e 6e65 722e 7275  derr = runner.ru
-0000cfc0: 6e28 636d 642c 0a20 2020 2020 2020 2020  n(cmd,.         
-0000cfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cff0: 2020 206c 6f67 5f70 6174 683d 6c6f 675f     log_path=log_
-0000d000: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
-0000d010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d030: 2020 7374 7265 616d 5f6c 6f67 733d 7374    stream_logs=st
-0000d040: 7265 616d 5f6c 6f67 732c 0a20 2020 2020  ream_logs,.     
-0000d050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d070: 2020 2020 2020 2072 6571 7569 7265 5f6f         require_o
-0000d080: 7574 7075 7473 3d54 7275 6529 0a20 2020  utputs=True).   
-0000d090: 2020 2020 2020 2020 2065 7272 5f6d 7367           err_msg
-0000d0a0: 203d 2028 2746 6169 6c65 6420 746f 2072   = ('Failed to r
-0000d0b0: 756e 2063 6f6d 6d61 6e64 2062 6566 6f72  un command befor
-0000d0c0: 6520 7273 796e 6320 270a 2020 2020 2020  e rsync '.      
-0000d0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d0e0: 2066 277b 6f72 6967 696e 5f73 6f75 7263   f'{origin_sourc
-0000d0f0: 657d 202d 3e20 7b74 6172 6765 747d 2e20  e} -> {target}. 
-0000d100: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0000d110: 2020 2020 2020 2020 2027 456e 7375 7265           'Ensure
-0000d120: 2074 6861 7420 7468 6520 6e65 7477 6f72   that the networ
-0000d130: 6b20 6973 2073 7461 626c 652c 2074 6865  k is stable, the
-0000d140: 6e20 7265 7472 792e 2729 0a20 2020 2020  n retry.').     
-0000d150: 2020 2020 2020 2069 6620 6c6f 675f 7061         if log_pa
-0000d160: 7468 2021 3d20 6f73 2e64 6576 6e75 6c6c  th != os.devnull
-0000d170: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000d180: 2020 6572 725f 6d73 6720 2b3d 2066 2720    err_msg += f' 
-0000d190: 5365 6520 6c6f 6773 2069 6e20 7b6c 6f67  See logs in {log
-0000d1a0: 5f70 6174 687d 270a 2020 2020 2020 2020  _path}'.        
-0000d1b0: 2020 2020 7375 6270 726f 6365 7373 5f75      subprocess_u
-0000d1c0: 7469 6c73 2e68 616e 646c 655f 7265 7475  tils.handle_retu
-0000d1d0: 726e 636f 6465 2872 632c 0a20 2020 2020  rncode(rc,.     
-0000d1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d200: 2020 2020 2020 2020 2020 636d 642c 0a20            cmd,. 
+0000c390: 2020 2020 2020 2020 2020 2020 6627 287b              f'({
+0000c3a0: 6c61 7374 5f6e 6f64 6573 5f73 6f5f 6661  last_nodes_so_fa
+0000c3b0: 727d 202d 3e20 7b6e 6f64 6573 5f73 6f5f  r} -> {nodes_so_
+0000c3c0: 6661 727d 2927 290a 2020 2020 2020 2020  far})').        
+0000c3d0: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
+0000c3e0: 7469 6d65 2e74 696d 6528 290a 2020 2020  time.time().    
+0000c3f0: 2020 2020 2020 2020 2020 2020 6c61 7374              last
+0000c400: 5f6e 6f64 6573 5f73 6f5f 6661 7220 3d20  _nodes_so_far = 
+0000c410: 6e6f 6465 735f 736f 5f66 6172 0a20 2020  nodes_so_far.   
+0000c420: 2020 2020 2020 2020 2065 6c69 6620 286e           elif (n
+0000c430: 6f64 6573 5f6c 6175 6e63 6869 6e67 5f70  odes_launching_p
+0000c440: 726f 6772 6573 735f 7469 6d65 6f75 7420  rogress_timeout 
+0000c450: 6973 206e 6f74 204e 6f6e 6520 616e 640a  is not None and.
+0000c460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c470: 2020 7469 6d65 2e74 696d 6528 2920 2d20    time.time() - 
+0000c480: 7374 6172 7420 3e20 6e6f 6465 735f 6c61  start > nodes_la
+0000c490: 756e 6368 696e 675f 7072 6f67 7265 7373  unching_progress
+0000c4a0: 5f74 696d 656f 7574 2061 6e64 0a20 2020  _timeout and.   
+0000c4b0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0000c4c0: 6f64 6573 5f73 6f5f 6661 7220 213d 206e  odes_so_far != n
+0000c4d0: 756d 5f6e 6f64 6573 293a 0a20 2020 2020  um_nodes):.     
+0000c4e0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+0000c4f0: 722e 6572 726f 7228 0a20 2020 2020 2020  r.error(.       
+0000c500: 2020 2020 2020 2020 2020 2020 2027 5469               'Ti
+0000c510: 6d65 6420 6f75 743a 2077 6169 7465 6420  med out: waited 
+0000c520: 666f 7220 6d6f 7265 2074 6861 6e20 270a  for more than '.
+0000c530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c540: 2020 2020 6627 7b6e 6f64 6573 5f6c 6175      f'{nodes_lau
+0000c550: 6e63 6869 6e67 5f70 726f 6772 6573 735f  nching_progress_
+0000c560: 7469 6d65 6f75 747d 2073 6563 6f6e 6473  timeout} seconds
+0000c570: 2066 6f72 206e 6577 2027 0a20 2020 2020   for new '.     
+0000c580: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0000c590: 776f 726b 6572 7320 746f 2062 6520 7072  workers to be pr
+0000c5a0: 6f76 6973 696f 6e65 642c 2062 7574 206e  ovisioned, but n
+0000c5b0: 6f20 7072 6f67 7265 7373 2e27 290a 2020  o progress.').  
+0000c5c0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000c5d0: 7475 726e 2046 616c 7365 2c20 4e6f 6e65  turn False, None
+0000c5e0: 2020 2320 6661 696c 6564 0a0a 2020 2020    # failed..    
+0000c5f0: 2020 2020 2020 2020 6966 2027 286e 6f20          if '(no 
+0000c600: 7065 6e64 696e 6720 6e6f 6465 7329 2720  pending nodes)' 
+0000c610: 696e 206f 7574 7075 7420 616e 6420 2728  in output and '(
+0000c620: 6e6f 2066 6169 6c75 7265 7329 2720 696e  no failures)' in
+0000c630: 206f 7574 7075 743a 0a20 2020 2020 2020   output:.       
+0000c640: 2020 2020 2020 2020 2023 2042 7567 2069           # Bug i
+0000c650: 6e20 7261 7920 6175 746f 7363 616c 6572  n ray autoscaler
+0000c660: 3a20 652e 672e 2c20 6f6e 2047 4350 2c20  : e.g., on GCP, 
+0000c670: 6966 2072 6571 7565 7374 696e 6720 3220  if requesting 2 
+0000c680: 6e6f 6465 730a 2020 2020 2020 2020 2020  nodes.          
+0000c690: 2020 2020 2020 2320 7468 6174 2047 4350        # that GCP
+0000c6a0: 2063 616e 2073 6174 6973 6679 206f 6e6c   can satisfy onl
+0000c6b0: 7920 6279 2068 616c 662c 2074 6865 2077  y by half, the w
+0000c6c0: 6f72 6b65 7220 6e6f 6465 2077 6f75 6c64  orker node would
+0000c6d0: 2062 650a 2020 2020 2020 2020 2020 2020   be.            
+0000c6e0: 2020 2020 2320 666f 7267 6f74 7465 6e2e      # forgotten.
+0000c6f0: 2054 6865 2063 6f72 7265 6374 2062 6568   The correct beh
+0000c700: 6176 696f 7220 7368 6f75 6c64 2062 6520  avior should be 
+0000c710: 666f 7220 6974 2074 6f20 6572 726f 7220  for it to error 
+0000c720: 6f75 742e 0a20 2020 2020 2020 2020 2020  out..           
+0000c730: 2020 2020 206c 6f67 6765 722e 6572 726f       logger.erro
+0000c740: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0000c750: 2020 2020 2020 2027 4661 696c 6564 2074         'Failed t
+0000c760: 6f20 6c61 756e 6368 206d 756c 7469 706c  o launch multipl
+0000c770: 6520 6e6f 6465 7320 6f6e 2027 0a20 2020  e nodes on '.   
+0000c780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c790: 2027 4743 5020 6475 6520 746f 2061 206e   'GCP due to a n
+0000c7a0: 6f6e 6465 7465 726d 696e 6973 7469 6320  ondeterministic 
+0000c7b0: 6275 6720 696e 2072 6179 2061 7574 6f73  bug in ray autos
+0000c7c0: 6361 6c65 722e 2729 0a20 2020 2020 2020  caler.').       
+0000c7d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000c7e0: 4661 6c73 652c 204e 6f6e 6520 2023 2066  False, None  # f
+0000c7f0: 6169 6c65 640a 2020 2020 2020 2020 2020  ailed.          
+0000c800: 2020 7469 6d65 2e73 6c65 6570 2831 3029    time.sleep(10)
+0000c810: 0a20 2020 2072 6574 7572 6e20 5472 7565  .    return True
+0000c820: 2c20 646f 636b 6572 5f75 7365 7220 2023  , docker_user  #
+0000c830: 2073 7563 6365 7373 0a0a 0a64 6566 2073   success...def s
+0000c840: 7368 5f63 7265 6465 6e74 6961 6c5f 6672  sh_credential_fr
+0000c850: 6f6d 5f79 616d 6c28 0a20 2020 2063 6c75  om_yaml(.    clu
+0000c860: 7374 6572 5f79 616d 6c3a 2073 7472 2c0a  ster_yaml: str,.
+0000c870: 2020 2020 646f 636b 6572 5f75 7365 723a      docker_user:
+0000c880: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
+0000c890: 204e 6f6e 652c 0a20 2020 2073 7368 5f75   None,.    ssh_u
+0000c8a0: 7365 723a 204f 7074 696f 6e61 6c5b 7374  ser: Optional[st
+0000c8b0: 725d 203d 204e 6f6e 652c 0a29 202d 3e20  r] = None,.) -> 
+0000c8c0: 4469 6374 5b73 7472 2c20 416e 795d 3a0a  Dict[str, Any]:.
+0000c8d0: 2020 2020 2222 2252 6574 7572 6e73 2073      """Returns s
+0000c8e0: 7368 5f75 7365 722c 2073 7368 5f70 7269  sh_user, ssh_pri
+0000c8f0: 7661 7465 5f6b 6579 2061 6e64 2073 7368  vate_key and ssh
+0000c900: 5f63 6f6e 7472 6f6c 206e 616d 652e 0a0a  _control name...
+0000c910: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+0000c920: 2020 636c 7573 7465 725f 7961 6d6c 3a20    cluster_yaml: 
+0000c930: 7061 7468 2074 6f20 7468 6520 636c 7573  path to the clus
+0000c940: 7465 7220 7961 6d6c 2e0a 2020 2020 2020  ter yaml..      
+0000c950: 2020 646f 636b 6572 5f75 7365 723a 2077    docker_user: w
+0000c960: 6865 6e20 7573 696e 6720 6375 7374 6f6d  hen using custom
+0000c970: 2064 6f63 6b65 7220 696d 6167 652c 2075   docker image, u
+0000c980: 7365 2074 6869 7320 7573 6572 2074 6f20  se this user to 
+0000c990: 7373 6820 696e 746f 0a20 2020 2020 2020  ssh into.       
+0000c9a0: 2020 2020 2074 6865 2064 6f63 6b65 7220       the docker 
+0000c9b0: 636f 6e74 6169 6e65 722e 0a20 2020 2020  container..     
+0000c9c0: 2020 2073 7368 5f75 7365 723a 206f 7665     ssh_user: ove
+0000c9d0: 7272 6964 6520 7468 6520 7373 685f 7573  rride the ssh_us
+0000c9e0: 6572 2069 6e20 7468 6520 636c 7573 7465  er in the cluste
+0000c9f0: 7220 7961 6d6c 2e0a 2020 2020 2222 220a  r yaml..    """.
+0000ca00: 2020 2020 636f 6e66 6967 203d 2063 6f6d      config = com
+0000ca10: 6d6f 6e5f 7574 696c 732e 7265 6164 5f79  mon_utils.read_y
+0000ca20: 616d 6c28 636c 7573 7465 725f 7961 6d6c  aml(cluster_yaml
+0000ca30: 290a 2020 2020 6175 7468 5f73 6563 7469  ).    auth_secti
+0000ca40: 6f6e 203d 2063 6f6e 6669 675b 2761 7574  on = config['aut
+0000ca50: 6827 5d0a 2020 2020 6966 2073 7368 5f75  h'].    if ssh_u
+0000ca60: 7365 7220 6973 204e 6f6e 653a 0a20 2020  ser is None:.   
+0000ca70: 2020 2020 2073 7368 5f75 7365 7220 3d20       ssh_user = 
+0000ca80: 6175 7468 5f73 6563 7469 6f6e 5b27 7373  auth_section['ss
+0000ca90: 685f 7573 6572 275d 2e73 7472 6970 2829  h_user'].strip()
+0000caa0: 0a20 2020 2073 7368 5f70 7269 7661 7465  .    ssh_private
+0000cab0: 5f6b 6579 203d 2061 7574 685f 7365 6374  _key = auth_sect
+0000cac0: 696f 6e2e 6765 7428 2773 7368 5f70 7269  ion.get('ssh_pri
+0000cad0: 7661 7465 5f6b 6579 2729 0a20 2020 2073  vate_key').    s
+0000cae0: 7368 5f63 6f6e 7472 6f6c 5f6e 616d 6520  sh_control_name 
+0000caf0: 3d20 636f 6e66 6967 2e67 6574 2827 636c  = config.get('cl
+0000cb00: 7573 7465 725f 6e61 6d65 272c 2027 5f5f  uster_name', '__
+0000cb10: 6465 6661 756c 745f 5f27 290a 2020 2020  default__').    
+0000cb20: 7373 685f 7072 6f78 795f 636f 6d6d 616e  ssh_proxy_comman
+0000cb30: 6420 3d20 6175 7468 5f73 6563 7469 6f6e  d = auth_section
+0000cb40: 2e67 6574 2827 7373 685f 7072 6f78 795f  .get('ssh_proxy_
+0000cb50: 636f 6d6d 616e 6427 290a 2020 2020 6372  command').    cr
+0000cb60: 6564 656e 7469 616c 7320 3d20 7b0a 2020  edentials = {.  
+0000cb70: 2020 2020 2020 2773 7368 5f75 7365 7227        'ssh_user'
+0000cb80: 3a20 7373 685f 7573 6572 2c0a 2020 2020  : ssh_user,.    
+0000cb90: 2020 2020 2773 7368 5f70 7269 7661 7465      'ssh_private
+0000cba0: 5f6b 6579 273a 2073 7368 5f70 7269 7661  _key': ssh_priva
+0000cbb0: 7465 5f6b 6579 2c0a 2020 2020 2020 2020  te_key,.        
+0000cbc0: 2773 7368 5f63 6f6e 7472 6f6c 5f6e 616d  'ssh_control_nam
+0000cbd0: 6527 3a20 7373 685f 636f 6e74 726f 6c5f  e': ssh_control_
+0000cbe0: 6e61 6d65 2c0a 2020 2020 2020 2020 2773  name,.        's
+0000cbf0: 7368 5f70 726f 7879 5f63 6f6d 6d61 6e64  sh_proxy_command
+0000cc00: 273a 2073 7368 5f70 726f 7879 5f63 6f6d  ': ssh_proxy_com
+0000cc10: 6d61 6e64 2c0a 2020 2020 7d0a 2020 2020  mand,.    }.    
+0000cc20: 6966 2064 6f63 6b65 725f 7573 6572 2069  if docker_user i
+0000cc30: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0000cc40: 2020 2020 6372 6564 656e 7469 616c 735b      credentials[
+0000cc50: 2764 6f63 6b65 725f 7573 6572 275d 203d  'docker_user'] =
+0000cc60: 2064 6f63 6b65 725f 7573 6572 0a20 2020   docker_user.   
+0000cc70: 2073 7368 5f70 726f 7669 6465 725f 6d6f   ssh_provider_mo
+0000cc80: 6475 6c65 203d 2063 6f6e 6669 675b 2770  dule = config['p
+0000cc90: 726f 7669 6465 7227 5d5b 276d 6f64 756c  rovider']['modul
+0000cca0: 6527 5d0a 2020 2020 2320 4966 2077 6520  e'].    # If we 
+0000ccb0: 6172 6520 7275 6e6e 696e 6720 7373 6820  are running ssh 
+0000ccc0: 636f 6d6d 616e 6420 6f6e 206b 7562 6572  command on kuber
+0000ccd0: 6e65 7465 7320 6e6f 6465 2e0a 2020 2020  netes node..    
+0000cce0: 6966 2027 6b75 6265 726e 6574 6573 2720  if 'kubernetes' 
+0000ccf0: 696e 2073 7368 5f70 726f 7669 6465 725f  in ssh_provider_
+0000cd00: 6d6f 6475 6c65 3a0a 2020 2020 2020 2020  module:.        
+0000cd10: 6372 6564 656e 7469 616c 735b 2764 6973  credentials['dis
+0000cd20: 6162 6c65 5f63 6f6e 7472 6f6c 5f6d 6173  able_control_mas
+0000cd30: 7465 7227 5d20 3d20 5472 7565 0a20 2020  ter'] = True.   
+0000cd40: 2072 6574 7572 6e20 6372 6564 656e 7469   return credenti
+0000cd50: 616c 730a 0a0a 6465 6620 7061 7261 6c6c  als...def parall
+0000cd60: 656c 5f64 6174 615f 7472 616e 7366 6572  el_data_transfer
+0000cd70: 5f74 6f5f 6e6f 6465 7328 0a20 2020 2072  _to_nodes(.    r
+0000cd80: 756e 6e65 7273 3a20 4c69 7374 5b63 6f6d  unners: List[com
+0000cd90: 6d61 6e64 5f72 756e 6e65 722e 5353 4843  mand_runner.SSHC
+0000cda0: 6f6d 6d61 6e64 5275 6e6e 6572 5d2c 0a20  ommandRunner],. 
+0000cdb0: 2020 2073 6f75 7263 653a 204f 7074 696f     source: Optio
+0000cdc0: 6e61 6c5b 7374 725d 2c0a 2020 2020 7461  nal[str],.    ta
+0000cdd0: 7267 6574 3a20 7374 722c 0a20 2020 2063  rget: str,.    c
+0000cde0: 6d64 3a20 4f70 7469 6f6e 616c 5b73 7472  md: Optional[str
+0000cdf0: 5d2c 0a20 2020 2072 756e 5f72 7379 6e63  ],.    run_rsync
+0000ce00: 3a20 626f 6f6c 2c0a 2020 2020 2a2c 0a20  : bool,.    *,. 
+0000ce10: 2020 2061 6374 696f 6e5f 6d65 7373 6167     action_messag
+0000ce20: 653a 2073 7472 2c0a 2020 2020 2320 4164  e: str,.    # Ad
+0000ce30: 7661 6e63 6564 206f 7074 696f 6e73 2e0a  vanced options..
+0000ce40: 2020 2020 6c6f 675f 7061 7468 3a20 7374      log_path: st
+0000ce50: 7220 3d20 6f73 2e64 6576 6e75 6c6c 2c0a  r = os.devnull,.
+0000ce60: 2020 2020 7374 7265 616d 5f6c 6f67 733a      stream_logs:
+0000ce70: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a29   bool = False,.)
+0000ce80: 3a0a 2020 2020 2222 2252 756e 7320 6120  :.    """Runs a 
+0000ce90: 636f 6d6d 616e 6420 6f6e 2061 6c6c 206e  command on all n
+0000cea0: 6f64 6573 2061 6e64 206f 7074 696f 6e61  odes and optiona
+0000ceb0: 6c6c 7920 7275 6e73 2072 7379 6e63 2066  lly runs rsync f
+0000cec0: 726f 6d20 7372 632d 3e64 7374 2e0a 0a20  rom src->dst... 
+0000ced0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+0000cee0: 2072 756e 6e65 7273 3a20 4120 6c69 7374   runners: A list
+0000cef0: 206f 6620 5353 4843 6f6d 6d61 6e64 5275   of SSHCommandRu
+0000cf00: 6e6e 6572 206f 626a 6563 7473 2074 6861  nner objects tha
+0000cf10: 7420 7265 7072 6573 656e 7420 6d75 6c74  t represent mult
+0000cf20: 6970 6c65 206e 6f64 6573 2e0a 2020 2020  iple nodes..    
+0000cf30: 2020 2020 736f 7572 6365 3a20 4f70 7469      source: Opti
+0000cf40: 6f6e 616c 5b73 7472 5d3b 2053 6f75 7263  onal[str]; Sourc
+0000cf50: 6520 666f 7220 7273 796e 6320 6f6e 206c  e for rsync on l
+0000cf60: 6f63 616c 206e 6f64 650a 2020 2020 2020  ocal node.      
+0000cf70: 2020 7461 7267 6574 3a20 7374 723b 2044    target: str; D
+0000cf80: 6573 7469 6e61 7469 6f6e 206f 6e20 7265  estination on re
+0000cf90: 6d6f 7465 206e 6f64 6520 666f 7220 7273  mote node for rs
+0000cfa0: 796e 630a 2020 2020 2020 2020 636d 643a  ync.        cmd:
+0000cfb0: 2073 7472 3b20 436f 6d6d 616e 6420 746f   str; Command to
+0000cfc0: 2062 6520 6578 6563 7574 6564 206f 6e20   be executed on 
+0000cfd0: 616c 6c20 6e6f 6465 730a 2020 2020 2020  all nodes.      
+0000cfe0: 2020 6163 7469 6f6e 5f6d 6573 7361 6765    action_message
+0000cff0: 3a20 7374 723b 204d 6573 7361 6765 2074  : str; Message t
+0000d000: 6f20 6265 2070 7269 6e74 6564 2077 6869  o be printed whi
+0000d010: 6c65 2074 6865 2063 6f6d 6d61 6e64 2072  le the command r
+0000d020: 756e 730a 2020 2020 2020 2020 6c6f 675f  uns.        log_
+0000d030: 7061 7468 3a20 7374 723b 2050 6174 6820  path: str; Path 
+0000d040: 746f 2074 6865 206c 6f67 2066 696c 650a  to the log file.
+0000d050: 2020 2020 2020 2020 7374 7265 616d 5f6c          stream_l
+0000d060: 6f67 733a 2062 6f6f 6c3b 2057 6865 7468  ogs: bool; Wheth
+0000d070: 6572 2074 6f20 7374 7265 616d 206c 6f67  er to stream log
+0000d080: 7320 746f 2073 7464 6f75 740a 2020 2020  s to stdout.    
+0000d090: 2222 220a 2020 2020 666f 7265 203d 2063  """.    fore = c
+0000d0a0: 6f6c 6f72 616d 612e 466f 7265 0a20 2020  olorama.Fore.   
+0000d0b0: 2073 7479 6c65 203d 2063 6f6c 6f72 616d   style = coloram
+0000d0c0: 612e 5374 796c 650a 0a20 2020 206f 7269  a.Style..    ori
+0000d0d0: 6769 6e5f 736f 7572 6365 203d 2073 6f75  gin_source = sou
+0000d0e0: 7263 650a 0a20 2020 2064 6566 205f 7379  rce..    def _sy
+0000d0f0: 6e63 5f6e 6f64 6528 7275 6e6e 6572 3a20  nc_node(runner: 
+0000d100: 2763 6f6d 6d61 6e64 5f72 756e 6e65 722e  'command_runner.
+0000d110: 5353 4843 6f6d 6d61 6e64 5275 6e6e 6572  SSHCommandRunner
+0000d120: 2729 202d 3e20 4e6f 6e65 3a0a 2020 2020  ') -> None:.    
+0000d130: 2020 2020 6966 2063 6d64 2069 7320 6e6f      if cmd is no
+0000d140: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0000d150: 2020 2020 7263 2c20 7374 646f 7574 2c20      rc, stdout, 
+0000d160: 7374 6465 7272 203d 2072 756e 6e65 722e  stderr = runner.
+0000d170: 7275 6e28 636d 642c 0a20 2020 2020 2020  run(cmd,.       
+0000d180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d1a0: 2020 2020 206c 6f67 5f70 6174 683d 6c6f       log_path=lo
+0000d1b0: 675f 7061 7468 2c0a 2020 2020 2020 2020  g_path,.        
+0000d1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d1e0: 2020 2020 7374 7265 616d 5f6c 6f67 733d      stream_logs=
+0000d1f0: 7374 7265 616d 5f6c 6f67 732c 0a20 2020  stream_logs,.   
+0000d200: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0000d210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d230: 2020 2020 2020 2020 2020 2020 2020 6572                er
-0000d240: 725f 6d73 672c 0a20 2020 2020 2020 2020  r_msg,.         
-0000d250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d270: 2020 2020 2020 7374 6465 7272 3d73 7464        stderr=std
-0000d280: 6f75 7420 2b20 7374 6465 7272 290a 0a20  out + stderr).. 
-0000d290: 2020 2020 2020 2069 6620 7275 6e5f 7273         if run_rs
-0000d2a0: 796e 633a 0a20 2020 2020 2020 2020 2020  ync:.           
-0000d2b0: 2061 7373 6572 7420 736f 7572 6365 2069   assert source i
-0000d2c0: 7320 6e6f 7420 4e6f 6e65 0a20 2020 2020  s not None.     
-0000d2d0: 2020 2020 2020 2023 2054 4f44 4f28 7a68         # TODO(zh
-0000d2e0: 7775 293a 204f 7074 696d 697a 6520 666f  wu): Optimize fo
-0000d2f0: 7220 6c61 7267 6520 616d 6f75 6e74 206f  r large amount o
-0000d300: 6620 6669 6c65 732e 0a20 2020 2020 2020  f files..       
-0000d310: 2020 2020 2023 207a 6970 202f 2074 7261       # zip / tra
-0000d320: 6e73 6665 7220 2f20 756e 7a69 700a 2020  nsfer / unzip.  
-0000d330: 2020 2020 2020 2020 2020 7275 6e6e 6572            runner
-0000d340: 2e72 7379 6e63 280a 2020 2020 2020 2020  .rsync(.        
-0000d350: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
-0000d360: 6f75 7263 652c 0a20 2020 2020 2020 2020  ource,.         
-0000d370: 2020 2020 2020 2074 6172 6765 743d 7461         target=ta
-0000d380: 7267 6574 2c0a 2020 2020 2020 2020 2020  rget,.          
-0000d390: 2020 2020 2020 7570 3d54 7275 652c 0a20        up=True,. 
-0000d3a0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0000d3b0: 6f67 5f70 6174 683d 6c6f 675f 7061 7468  og_path=log_path
-0000d3c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000d3d0: 2020 7374 7265 616d 5f6c 6f67 733d 7374    stream_logs=st
-0000d3e0: 7265 616d 5f6c 6f67 732c 0a20 2020 2020  ream_logs,.     
-0000d3f0: 2020 2020 2020 2029 0a0a 2020 2020 6e75         )..    nu
-0000d400: 6d5f 6e6f 6465 7320 3d20 6c65 6e28 7275  m_nodes = len(ru
-0000d410: 6e6e 6572 7329 0a20 2020 2070 6c75 7261  nners).    plura
-0000d420: 6c20 3d20 2773 2720 6966 206e 756d 5f6e  l = 's' if num_n
-0000d430: 6f64 6573 203e 2031 2065 6c73 6520 2727  odes > 1 else ''
-0000d440: 0a20 2020 206d 6573 7361 6765 203d 2028  .    message = (
-0000d450: 6627 7b66 6f72 652e 4359 414e 7d7b 6163  f'{fore.CYAN}{ac
-0000d460: 7469 6f6e 5f6d 6573 7361 6765 7d20 2874  tion_message} (t
-0000d470: 6f20 7b6e 756d 5f6e 6f64 6573 7d20 6e6f  o {num_nodes} no
-0000d480: 6465 7b70 6c75 7261 6c7d 2927 0a20 2020  de{plural})'.   
-0000d490: 2020 2020 2020 2020 2020 2020 6627 3a20              f': 
-0000d4a0: 7b73 7479 6c65 2e42 5249 4748 547d 7b6f  {style.BRIGHT}{o
-0000d4b0: 7269 6769 6e5f 736f 7572 6365 7d7b 7374  rigin_source}{st
-0000d4c0: 796c 652e 5245 5345 545f 414c 4c7d 202d  yle.RESET_ALL} -
-0000d4d0: 3e20 270a 2020 2020 2020 2020 2020 2020  > '.            
-0000d4e0: 2020 2066 277b 7374 796c 652e 4252 4947     f'{style.BRIG
-0000d4f0: 4854 7d7b 7461 7267 6574 7d7b 7374 796c  HT}{target}{styl
-0000d500: 652e 5245 5345 545f 414c 4c7d 2729 0a20  e.RESET_ALL}'). 
-0000d510: 2020 206c 6f67 6765 722e 696e 666f 286d     logger.info(m
-0000d520: 6573 7361 6765 290a 2020 2020 7769 7468  essage).    with
-0000d530: 2072 6963 685f 7574 696c 732e 7361 6665   rich_utils.safe
-0000d540: 5f73 7461 7475 7328 6627 5b62 6f6c 6420  _status(f'[bold 
-0000d550: 6379 616e 5d7b 6163 7469 6f6e 5f6d 6573  cyan]{action_mes
-0000d560: 7361 6765 7d5b 2f5d 2729 3a0a 2020 2020  sage}[/]'):.    
-0000d570: 2020 2020 7375 6270 726f 6365 7373 5f75      subprocess_u
-0000d580: 7469 6c73 2e72 756e 5f69 6e5f 7061 7261  tils.run_in_para
-0000d590: 6c6c 656c 285f 7379 6e63 5f6e 6f64 652c  llel(_sync_node,
-0000d5a0: 2072 756e 6e65 7273 290a 0a0a 6465 6620   runners)...def 
-0000d5b0: 6368 6563 6b5f 6c6f 6361 6c5f 6770 7573  check_local_gpus
-0000d5c0: 2829 202d 3e20 626f 6f6c 3a0a 2020 2020  () -> bool:.    
-0000d5d0: 2222 2243 6865 636b 7320 6966 2047 5055  """Checks if GPU
-0000d5e0: 7320 6172 6520 6176 6169 6c61 626c 6520  s are available 
-0000d5f0: 6c6f 6361 6c6c 792e 0a0a 2020 2020 5265  locally...    Re
-0000d600: 7475 726e 7320 7768 6574 6865 7220 4750  turns whether GP
-0000d610: 5573 2061 7265 2061 7661 696c 6162 6c65  Us are available
-0000d620: 206f 6e20 7468 6520 6c6f 6361 6c20 6d61   on the local ma
-0000d630: 6368 696e 6520 6279 2063 6865 636b 696e  chine by checkin
-0000d640: 670a 2020 2020 6966 206e 7669 6469 612d  g.    if nvidia-
-0000d650: 736d 6920 6973 2069 6e73 7461 6c6c 6564  smi is installed
-0000d660: 2061 6e64 2072 6574 7572 6e73 207a 6572   and returns zer
-0000d670: 6f20 7265 7475 726e 2063 6f64 652e 0a0a  o return code...
-0000d680: 2020 2020 5265 7475 726e 7320 5472 7565      Returns True
-0000d690: 2069 6620 6e76 6964 6961 2d73 6d69 2069   if nvidia-smi i
-0000d6a0: 7320 696e 7374 616c 6c65 6420 616e 6420  s installed and 
-0000d6b0: 7265 7475 726e 7320 7a65 726f 2072 6574  returns zero ret
-0000d6c0: 7572 6e20 636f 6465 2c0a 2020 2020 4661  urn code,.    Fa
-0000d6d0: 6c73 6520 6966 206e 6f74 2e0a 2020 2020  lse if not..    
-0000d6e0: 2222 220a 2020 2020 6973 5f66 756e 6374  """.    is_funct
-0000d6f0: 696f 6e61 6c20 3d20 4661 6c73 650a 2020  ional = False.  
-0000d700: 2020 696e 7374 616c 6c61 7469 6f6e 5f63    installation_c
-0000d710: 6865 636b 203d 2073 7562 7072 6f63 6573  heck = subproces
-0000d720: 732e 7275 6e28 5b27 7768 6963 6827 2c20  s.run(['which', 
-0000d730: 276e 7669 6469 612d 736d 6927 5d2c 0a20  'nvidia-smi'],. 
-0000d740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d760: 2020 2020 2020 2073 7464 6f75 743d 7375         stdout=su
-0000d770: 6270 726f 6365 7373 2e44 4556 4e55 4c4c  bprocess.DEVNULL
-0000d780: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000d790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d7a0: 2020 2020 2020 2020 2020 7374 6465 7272            stderr
-0000d7b0: 3d73 7562 7072 6f63 6573 732e 4445 564e  =subprocess.DEVN
-0000d7c0: 554c 4c2c 0a20 2020 2020 2020 2020 2020  ULL,.           
-0000d7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d7e0: 2020 2020 2020 2020 2020 2020 2063 6865               che
-0000d7f0: 636b 3d46 616c 7365 290a 2020 2020 6973  ck=False).    is
-0000d800: 5f69 6e73 7461 6c6c 6564 203d 2069 6e73  _installed = ins
-0000d810: 7461 6c6c 6174 696f 6e5f 6368 6563 6b2e  tallation_check.
-0000d820: 7265 7475 726e 636f 6465 203d 3d20 300a  returncode == 0.
-0000d830: 2020 2020 6966 2069 735f 696e 7374 616c      if is_instal
-0000d840: 6c65 643a 0a20 2020 2020 2020 2065 7865  led:.        exe
-0000d850: 6375 7469 6f6e 5f63 6865 636b 203d 2073  cution_check = s
-0000d860: 7562 7072 6f63 6573 732e 7275 6e28 5b27  ubprocess.run(['
-0000d870: 6e76 6964 6961 2d73 6d69 275d 2c0a 2020  nvidia-smi'],.  
-0000d880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d8a0: 2020 2020 2020 2073 7464 6f75 743d 7375         stdout=su
-0000d8b0: 6270 726f 6365 7373 2e44 4556 4e55 4c4c  bprocess.DEVNULL
-0000d8c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000d8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d8e0: 2020 2020 2020 2020 2020 2073 7464 6572             stder
-0000d8f0: 723d 7375 6270 726f 6365 7373 2e44 4556  r=subprocess.DEV
-0000d900: 4e55 4c4c 2c0a 2020 2020 2020 2020 2020  NULL,.          
-0000d910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d920: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0000d930: 6865 636b 3d46 616c 7365 290a 2020 2020  heck=False).    
-0000d940: 2020 2020 6973 5f66 756e 6374 696f 6e61      is_functiona
-0000d950: 6c20 3d20 6578 6563 7574 696f 6e5f 6368  l = execution_ch
-0000d960: 6563 6b2e 7265 7475 726e 636f 6465 203d  eck.returncode =
-0000d970: 3d20 300a 2020 2020 7265 7475 726e 2069  = 0.    return i
-0000d980: 735f 6675 6e63 7469 6f6e 616c 0a0a 0a64  s_functional...d
-0000d990: 6566 2067 656e 6572 6174 655f 636c 7573  ef generate_clus
-0000d9a0: 7465 725f 6e61 6d65 2829 3a0a 2020 2020  ter_name():.    
-0000d9b0: 2320 544f 444f 3a20 6368 616e 6765 2074  # TODO: change t
-0000d9c0: 6869 7320 4944 2066 6f72 6d61 7474 696e  his ID formattin
-0000d9d0: 6720 746f 2073 6f6d 6574 6869 6e67 206d  g to something m
-0000d9e0: 6f72 6520 706c 6561 7361 6e74 2e0a 2020  ore pleasant..  
-0000d9f0: 2020 2320 5573 6572 206e 616d 6520 6973    # User name is
-0000da00: 2068 656c 7066 756c 2069 6e20 6e6f 6e2d   helpful in non-
-0000da10: 6973 6f6c 6174 6564 2061 6363 6f75 6e74  isolated account
-0000da20: 732c 2065 2e67 2e2c 2047 4350 2c20 417a  s, e.g., GCP, Az
-0000da30: 7572 652e 0a20 2020 2072 6574 7572 6e20  ure..    return 
-0000da40: 6627 736b 792d 7b75 7569 642e 7575 6964  f'sky-{uuid.uuid
-0000da50: 3428 292e 6865 785b 3a34 5d7d 2d7b 636f  4().hex[:4]}-{co
-0000da60: 6d6d 6f6e 5f75 7469 6c73 2e67 6574 5f63  mmon_utils.get_c
-0000da70: 6c65 616e 6564 5f75 7365 726e 616d 6528  leaned_username(
-0000da80: 297d 270a 0a0a 6465 6620 5f71 7565 7279  )}'...def _query
-0000da90: 5f68 6561 645f 6970 5f77 6974 685f 7265  _head_ip_with_re
-0000daa0: 7472 6965 7328 636c 7573 7465 725f 7961  tries(cluster_ya
-0000dab0: 6d6c 3a20 7374 722c 0a20 2020 2020 2020  ml: str,.       
+0000d220: 2020 2020 2020 2020 2072 6571 7569 7265           require
+0000d230: 5f6f 7574 7075 7473 3d54 7275 6529 0a20  _outputs=True). 
+0000d240: 2020 2020 2020 2020 2020 2065 7272 5f6d             err_m
+0000d250: 7367 203d 2028 2746 6169 6c65 6420 746f  sg = ('Failed to
+0000d260: 2072 756e 2063 6f6d 6d61 6e64 2062 6566   run command bef
+0000d270: 6f72 6520 7273 796e 6320 270a 2020 2020  ore rsync '.    
+0000d280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d290: 2020 2066 277b 6f72 6967 696e 5f73 6f75     f'{origin_sou
+0000d2a0: 7263 657d 202d 3e20 7b74 6172 6765 747d  rce} -> {target}
+0000d2b0: 2e20 270a 2020 2020 2020 2020 2020 2020  . '.            
+0000d2c0: 2020 2020 2020 2020 2020 2027 456e 7375             'Ensu
+0000d2d0: 7265 2074 6861 7420 7468 6520 6e65 7477  re that the netw
+0000d2e0: 6f72 6b20 6973 2073 7461 626c 652c 2074  ork is stable, t
+0000d2f0: 6865 6e20 7265 7472 792e 2729 0a20 2020  hen retry.').   
+0000d300: 2020 2020 2020 2020 2069 6620 6c6f 675f           if log_
+0000d310: 7061 7468 2021 3d20 6f73 2e64 6576 6e75  path != os.devnu
+0000d320: 6c6c 3a0a 2020 2020 2020 2020 2020 2020  ll:.            
+0000d330: 2020 2020 6572 725f 6d73 6720 2b3d 2066      err_msg += f
+0000d340: 2720 5365 6520 6c6f 6773 2069 6e20 7b6c  ' See logs in {l
+0000d350: 6f67 5f70 6174 687d 270a 2020 2020 2020  og_path}'.      
+0000d360: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
+0000d370: 5f75 7469 6c73 2e68 616e 646c 655f 7265  _utils.handle_re
+0000d380: 7475 726e 636f 6465 2872 632c 0a20 2020  turncode(rc,.   
+0000d390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d3b0: 2020 2020 2020 2020 2020 2020 636d 642c              cmd,
+0000d3c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d3f0: 6572 725f 6d73 672c 0a20 2020 2020 2020  err_msg,.       
+0000d400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d420: 2020 2020 2020 2020 7374 6465 7272 3d73          stderr=s
+0000d430: 7464 6f75 7420 2b20 7374 6465 7272 290a  tdout + stderr).
+0000d440: 0a20 2020 2020 2020 2069 6620 7275 6e5f  .        if run_
+0000d450: 7273 796e 633a 0a20 2020 2020 2020 2020  rsync:.         
+0000d460: 2020 2061 7373 6572 7420 736f 7572 6365     assert source
+0000d470: 2069 7320 6e6f 7420 4e6f 6e65 0a20 2020   is not None.   
+0000d480: 2020 2020 2020 2020 2023 2054 4f44 4f28           # TODO(
+0000d490: 7a68 7775 293a 204f 7074 696d 697a 6520  zhwu): Optimize 
+0000d4a0: 666f 7220 6c61 7267 6520 616d 6f75 6e74  for large amount
+0000d4b0: 206f 6620 6669 6c65 732e 0a20 2020 2020   of files..     
+0000d4c0: 2020 2020 2020 2023 207a 6970 202f 2074         # zip / t
+0000d4d0: 7261 6e73 6665 7220 2f20 756e 7a69 700a  ransfer / unzip.
+0000d4e0: 2020 2020 2020 2020 2020 2020 7275 6e6e              runn
+0000d4f0: 6572 2e72 7379 6e63 280a 2020 2020 2020  er.rsync(.      
+0000d500: 2020 2020 2020 2020 2020 736f 7572 6365            source
+0000d510: 3d73 6f75 7263 652c 0a20 2020 2020 2020  =source,.       
+0000d520: 2020 2020 2020 2020 2074 6172 6765 743d           target=
+0000d530: 7461 7267 6574 2c0a 2020 2020 2020 2020  target,.        
+0000d540: 2020 2020 2020 2020 7570 3d54 7275 652c          up=True,
+0000d550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d560: 206c 6f67 5f70 6174 683d 6c6f 675f 7061   log_path=log_pa
+0000d570: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+0000d580: 2020 2020 7374 7265 616d 5f6c 6f67 733d      stream_logs=
+0000d590: 7374 7265 616d 5f6c 6f67 732c 0a20 2020  stream_logs,.   
+0000d5a0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+0000d5b0: 6e75 6d5f 6e6f 6465 7320 3d20 6c65 6e28  num_nodes = len(
+0000d5c0: 7275 6e6e 6572 7329 0a20 2020 2070 6c75  runners).    plu
+0000d5d0: 7261 6c20 3d20 2773 2720 6966 206e 756d  ral = 's' if num
+0000d5e0: 5f6e 6f64 6573 203e 2031 2065 6c73 6520  _nodes > 1 else 
+0000d5f0: 2727 0a20 2020 206d 6573 7361 6765 203d  ''.    message =
+0000d600: 2028 6627 7b66 6f72 652e 4359 414e 7d7b   (f'{fore.CYAN}{
+0000d610: 6163 7469 6f6e 5f6d 6573 7361 6765 7d20  action_message} 
+0000d620: 2874 6f20 7b6e 756d 5f6e 6f64 6573 7d20  (to {num_nodes} 
+0000d630: 6e6f 6465 7b70 6c75 7261 6c7d 2927 0a20  node{plural})'. 
+0000d640: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0000d650: 3a20 7b73 7479 6c65 2e42 5249 4748 547d  : {style.BRIGHT}
+0000d660: 7b6f 7269 6769 6e5f 736f 7572 6365 7d7b  {origin_source}{
+0000d670: 7374 796c 652e 5245 5345 545f 414c 4c7d  style.RESET_ALL}
+0000d680: 202d 3e20 270a 2020 2020 2020 2020 2020   -> '.          
+0000d690: 2020 2020 2066 277b 7374 796c 652e 4252       f'{style.BR
+0000d6a0: 4947 4854 7d7b 7461 7267 6574 7d7b 7374  IGHT}{target}{st
+0000d6b0: 796c 652e 5245 5345 545f 414c 4c7d 2729  yle.RESET_ALL}')
+0000d6c0: 0a20 2020 206c 6f67 6765 722e 696e 666f  .    logger.info
+0000d6d0: 286d 6573 7361 6765 290a 2020 2020 7769  (message).    wi
+0000d6e0: 7468 2072 6963 685f 7574 696c 732e 7361  th rich_utils.sa
+0000d6f0: 6665 5f73 7461 7475 7328 6627 5b62 6f6c  fe_status(f'[bol
+0000d700: 6420 6379 616e 5d7b 6163 7469 6f6e 5f6d  d cyan]{action_m
+0000d710: 6573 7361 6765 7d5b 2f5d 2729 3a0a 2020  essage}[/]'):.  
+0000d720: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
+0000d730: 5f75 7469 6c73 2e72 756e 5f69 6e5f 7061  _utils.run_in_pa
+0000d740: 7261 6c6c 656c 285f 7379 6e63 5f6e 6f64  rallel(_sync_nod
+0000d750: 652c 2072 756e 6e65 7273 290a 0a0a 6465  e, runners)...de
+0000d760: 6620 6368 6563 6b5f 6c6f 6361 6c5f 6770  f check_local_gp
+0000d770: 7573 2829 202d 3e20 626f 6f6c 3a0a 2020  us() -> bool:.  
+0000d780: 2020 2222 2243 6865 636b 7320 6966 2047    """Checks if G
+0000d790: 5055 7320 6172 6520 6176 6169 6c61 626c  PUs are availabl
+0000d7a0: 6520 6c6f 6361 6c6c 792e 0a0a 2020 2020  e locally...    
+0000d7b0: 5265 7475 726e 7320 7768 6574 6865 7220  Returns whether 
+0000d7c0: 4750 5573 2061 7265 2061 7661 696c 6162  GPUs are availab
+0000d7d0: 6c65 206f 6e20 7468 6520 6c6f 6361 6c20  le on the local 
+0000d7e0: 6d61 6368 696e 6520 6279 2063 6865 636b  machine by check
+0000d7f0: 696e 670a 2020 2020 6966 206e 7669 6469  ing.    if nvidi
+0000d800: 612d 736d 6920 6973 2069 6e73 7461 6c6c  a-smi is install
+0000d810: 6564 2061 6e64 2072 6574 7572 6e73 207a  ed and returns z
+0000d820: 6572 6f20 7265 7475 726e 2063 6f64 652e  ero return code.
+0000d830: 0a0a 2020 2020 5265 7475 726e 7320 5472  ..    Returns Tr
+0000d840: 7565 2069 6620 6e76 6964 6961 2d73 6d69  ue if nvidia-smi
+0000d850: 2069 7320 696e 7374 616c 6c65 6420 616e   is installed an
+0000d860: 6420 7265 7475 726e 7320 7a65 726f 2072  d returns zero r
+0000d870: 6574 7572 6e20 636f 6465 2c0a 2020 2020  eturn code,.    
+0000d880: 4661 6c73 6520 6966 206e 6f74 2e0a 2020  False if not..  
+0000d890: 2020 2222 220a 2020 2020 6973 5f66 756e    """.    is_fun
+0000d8a0: 6374 696f 6e61 6c20 3d20 4661 6c73 650a  ctional = False.
+0000d8b0: 2020 2020 696e 7374 616c 6c61 7469 6f6e      installation
+0000d8c0: 5f63 6865 636b 203d 2073 7562 7072 6f63  _check = subproc
+0000d8d0: 6573 732e 7275 6e28 5b27 7768 6963 6827  ess.run(['which'
+0000d8e0: 2c20 276e 7669 6469 612d 736d 6927 5d2c  , 'nvidia-smi'],
+0000d8f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d910: 2020 2020 2020 2020 2073 7464 6f75 743d           stdout=
+0000d920: 7375 6270 726f 6365 7373 2e44 4556 4e55  subprocess.DEVNU
+0000d930: 4c4c 2c0a 2020 2020 2020 2020 2020 2020  LL,.            
+0000d940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d950: 2020 2020 2020 2020 2020 2020 7374 6465              stde
+0000d960: 7272 3d73 7562 7072 6f63 6573 732e 4445  rr=subprocess.DE
+0000d970: 564e 554c 4c2c 0a20 2020 2020 2020 2020  VNULL,.         
+0000d980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d990: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000d9a0: 6865 636b 3d46 616c 7365 290a 2020 2020  heck=False).    
+0000d9b0: 6973 5f69 6e73 7461 6c6c 6564 203d 2069  is_installed = i
+0000d9c0: 6e73 7461 6c6c 6174 696f 6e5f 6368 6563  nstallation_chec
+0000d9d0: 6b2e 7265 7475 726e 636f 6465 203d 3d20  k.returncode == 
+0000d9e0: 300a 2020 2020 6966 2069 735f 696e 7374  0.    if is_inst
+0000d9f0: 616c 6c65 643a 0a20 2020 2020 2020 2065  alled:.        e
+0000da00: 7865 6375 7469 6f6e 5f63 6865 636b 203d  xecution_check =
+0000da10: 2073 7562 7072 6f63 6573 732e 7275 6e28   subprocess.run(
+0000da20: 5b27 6e76 6964 6961 2d73 6d69 275d 2c0a  ['nvidia-smi'],.
+0000da30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000da40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000da50: 2020 2020 2020 2020 2073 7464 6f75 743d           stdout=
+0000da60: 7375 6270 726f 6365 7373 2e44 4556 4e55  subprocess.DEVNU
+0000da70: 4c4c 2c0a 2020 2020 2020 2020 2020 2020  LL,.            
+0000da80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000da90: 2020 2020 2020 2020 2020 2020 2073 7464               std
+0000daa0: 6572 723d 7375 6270 726f 6365 7373 2e44  err=subprocess.D
+0000dab0: 4556 4e55 4c4c 2c0a 2020 2020 2020 2020  EVNULL,.        
 0000dac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dad0: 2020 2020 2020 2020 206d 6178 5f61 7474           max_att
-0000dae0: 656d 7074 733a 2069 6e74 203d 2031 2920  empts: int = 1) 
-0000daf0: 2d3e 2073 7472 3a0a 2020 2020 2222 2252  -> str:.    """R
-0000db00: 6574 7572 6e73 2074 6865 2049 5020 6f66  eturns the IP of
-0000db10: 2074 6865 2068 6561 6420 6e6f 6465 2062   the head node b
-0000db20: 7920 7175 6572 7969 6e67 2074 6865 2063  y querying the c
-0000db30: 6c6f 7564 2e0a 0a20 2020 2052 6169 7365  loud...    Raise
-0000db40: 733a 0a20 2020 2020 2065 7863 6570 7469  s:.      excepti
-0000db50: 6f6e 732e 4665 7463 6849 5045 7272 6f72  ons.FetchIPError
-0000db60: 3a20 6966 2077 6520 6661 696c 6564 2074  : if we failed t
-0000db70: 6f20 6765 7420 7468 6520 6865 6164 2049  o get the head I
-0000db80: 502e 0a20 2020 2022 2222 0a20 2020 2062  P..    """.    b
-0000db90: 6163 6b6f 6666 203d 2063 6f6d 6d6f 6e5f  ackoff = common_
-0000dba0: 7574 696c 732e 4261 636b 6f66 6628 696e  utils.Backoff(in
-0000dbb0: 6974 6961 6c5f 6261 636b 6f66 663d 352c  itial_backoff=5,
-0000dbc0: 206d 6178 5f62 6163 6b6f 6666 5f66 6163   max_backoff_fac
-0000dbd0: 746f 723d 3529 0a20 2020 2066 6f72 2069  tor=5).    for i
-0000dbe0: 2069 6e20 7261 6e67 6528 6d61 785f 6174   in range(max_at
-0000dbf0: 7465 6d70 7473 293a 0a20 2020 2020 2020  tempts):.       
-0000dc00: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0000dc10: 2020 6675 6c6c 5f63 6c75 7374 6572 5f79    full_cluster_y
-0000dc20: 616d 6c20 3d20 7374 7228 7061 7468 6c69  aml = str(pathli
-0000dc30: 622e 5061 7468 2863 6c75 7374 6572 5f79  b.Path(cluster_y
-0000dc40: 616d 6c29 2e65 7870 616e 6475 7365 7228  aml).expanduser(
-0000dc50: 2929 0a20 2020 2020 2020 2020 2020 206f  )).            o
-0000dc60: 7574 203d 2073 7562 7072 6f63 6573 735f  ut = subprocess_
-0000dc70: 7574 696c 732e 7275 6e28 0a20 2020 2020  utils.run(.     
-0000dc80: 2020 2020 2020 2020 2020 2066 2772 6179             f'ray
-0000dc90: 2067 6574 2d68 6561 642d 6970 207b 6675   get-head-ip {fu
-0000dca0: 6c6c 5f63 6c75 7374 6572 5f79 616d 6c21  ll_cluster_yaml!
-0000dcb0: 727d 272c 0a20 2020 2020 2020 2020 2020  r}',.           
-0000dcc0: 2020 2020 2073 7464 6f75 743d 7375 6270       stdout=subp
-0000dcd0: 726f 6365 7373 2e50 4950 452c 0a20 2020  rocess.PIPE,.   
-0000dce0: 2020 2020 2020 2020 2020 2020 2073 7464               std
-0000dcf0: 6572 723d 7375 6270 726f 6365 7373 2e44  err=subprocess.D
-0000dd00: 4556 4e55 4c4c 292e 7374 646f 7574 2e64  EVNULL).stdout.d
-0000dd10: 6563 6f64 6528 292e 7374 7269 7028 290a  ecode().strip().
-0000dd20: 2020 2020 2020 2020 2020 2020 6865 6164              head
-0000dd30: 5f69 705f 6c69 7374 203d 2072 652e 6669  _ip_list = re.fi
-0000dd40: 6e64 616c 6c28 4950 5f41 4444 525f 5245  ndall(IP_ADDR_RE
-0000dd50: 4745 582c 206f 7574 290a 2020 2020 2020  GEX, out).      
-0000dd60: 2020 2020 2020 6966 206c 656e 2868 6561        if len(hea
-0000dd70: 645f 6970 5f6c 6973 7429 203e 2031 3a0a  d_ip_list) > 1:.
-0000dd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dd90: 2320 5468 6973 2063 6f75 6c64 2062 6520  # This could be 
-0000dda0: 7472 6967 6765 7265 6420 6966 2065 2e67  triggered if e.g
-0000ddb0: 2e2c 2073 6f6d 6520 6c6f 6767 696e 6720  ., some logging 
-0000ddc0: 6973 2061 6464 6564 2069 6e0a 2020 2020  is added in.    
-0000ddd0: 2020 2020 2020 2020 2020 2020 2320 736b              # sk
-0000dde0: 7970 696c 6f74 5f63 6f6e 6669 672c 2061  ypilot_config, a
-0000ddf0: 206d 6f64 756c 6520 7468 6174 2068 6173   module that has
-0000de00: 2073 6f6d 6520 636f 6465 2065 7865 6375   some code execu
-0000de10: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
-0000de20: 2020 2020 2320 7768 656e 6576 6572 2060      # whenever `
-0000de30: 736b 7960 2069 7320 696d 706f 7274 6564  sky` is imported
-0000de40: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000de50: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
-0000de60: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000de70: 2020 2020 2020 2744 6574 6563 7465 6420        'Detected 
-0000de80: 6d6f 7265 2074 6861 6e20 3120 4950 2066  more than 1 IP f
-0000de90: 726f 6d20 7468 6520 6f75 7470 7574 206f  rom the output o
-0000dea0: 6620 270a 2020 2020 2020 2020 2020 2020  f '.            
-0000deb0: 2020 2020 2020 2020 2774 6865 2060 7261          'the `ra
-0000dec0: 7920 6765 742d 6865 6164 2d69 7060 2063  y get-head-ip` c
-0000ded0: 6f6d 6d61 6e64 2e20 5468 6973 2063 6f75  ommand. This cou
-0000dee0: 6c64 2027 0a20 2020 2020 2020 2020 2020  ld '.           
-0000def0: 2020 2020 2020 2020 2027 6861 7070 656e           'happen
-0000df00: 2069 6620 7468 6572 6520 6973 2065 7874   if there is ext
-0000df10: 7261 206f 7574 7075 7420 6672 6f6d 2069  ra output from i
-0000df20: 742c 2027 0a20 2020 2020 2020 2020 2020  t, '.           
-0000df30: 2020 2020 2020 2020 2027 7768 6963 6820           'which 
-0000df40: 7368 6f75 6c64 2062 6520 696e 7370 6563  should be inspec
-0000df50: 7465 6420 6265 6c6f 772e 5c6e 5072 6f63  ted below.\nProc
-0000df60: 6565 6469 6e67 2077 6974 6820 270a 2020  eeding with '.  
-0000df70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000df80: 2020 6627 7468 6520 6c61 7374 2064 6574    f'the last det
-0000df90: 6563 7465 6420 4950 2028 7b68 6561 645f  ected IP ({head_
-0000dfa0: 6970 5f6c 6973 745b 2d31 5d7d 2920 6173  ip_list[-1]}) as
-0000dfb0: 2068 6561 6420 4950 2e27 0a20 2020 2020   head IP.'.     
-0000dfc0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000dfd0: 275c 6e3d 3d20 4f75 7470 7574 203d 3d5c  '\n== Output ==\
-0000dfe0: 6e7b 6f75 747d 270a 2020 2020 2020 2020  n{out}'.        
-0000dff0: 2020 2020 2020 2020 2020 2020 6627 5c6e              f'\n
-0000e000: 3d3d 204f 7574 7075 7420 656e 6473 203d  == Output ends =
-0000e010: 3d27 290a 2020 2020 2020 2020 2020 2020  =').            
-0000e020: 2020 2020 6865 6164 5f69 705f 6c69 7374      head_ip_list
-0000e030: 203d 2068 6561 645f 6970 5f6c 6973 745b   = head_ip_list[
-0000e040: 2d31 3a5d 0a20 2020 2020 2020 2020 2020  -1:].           
-0000e050: 2061 7373 6572 7420 3120 3d3d 206c 656e   assert 1 == len
-0000e060: 2868 6561 645f 6970 5f6c 6973 7429 2c20  (head_ip_list), 
-0000e070: 286f 7574 2c20 6865 6164 5f69 705f 6c69  (out, head_ip_li
-0000e080: 7374 290a 2020 2020 2020 2020 2020 2020  st).            
-0000e090: 6865 6164 5f69 7020 3d20 6865 6164 5f69  head_ip = head_i
-0000e0a0: 705f 6c69 7374 5b30 5d0a 2020 2020 2020  p_list[0].      
-0000e0b0: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
-0000e0c0: 2020 2020 6578 6365 7074 2073 7562 7072      except subpr
-0000e0d0: 6f63 6573 732e 4361 6c6c 6564 5072 6f63  ocess.CalledProc
-0000e0e0: 6573 7345 7272 6f72 2061 7320 653a 0a20  essError as e:. 
-0000e0f0: 2020 2020 2020 2020 2020 2069 6620 6920             if i 
-0000e100: 3d3d 206d 6178 5f61 7474 656d 7074 7320  == max_attempts 
-0000e110: 2d20 313a 0a20 2020 2020 2020 2020 2020  - 1:.           
-0000e120: 2020 2020 2072 6169 7365 2065 7863 6570       raise excep
-0000e130: 7469 6f6e 732e 4665 7463 6849 5045 7272  tions.FetchIPErr
-0000e140: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-0000e150: 2020 2020 2020 2020 7265 6173 6f6e 3d65          reason=e
-0000e160: 7863 6570 7469 6f6e 732e 4665 7463 6849  xceptions.FetchI
-0000e170: 5045 7272 6f72 2e52 6561 736f 6e2e 4845  PError.Reason.HE
-0000e180: 4144 2920 6672 6f6d 2065 0a20 2020 2020  AD) from e.     
-0000e190: 2020 2020 2020 2023 2052 6574 7279 2069         # Retry i
-0000e1a0: 6620 7468 6520 636c 7573 7465 7220 6973  f the cluster is
-0000e1b0: 206e 6f74 2075 7020 7965 742e 0a20 2020   not up yet..   
-0000e1c0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-0000e1d0: 6465 6275 6728 2752 6574 7279 696e 6720  debug('Retrying 
-0000e1e0: 746f 2067 6574 2068 6561 6420 6970 2e27  to get head ip.'
-0000e1f0: 290a 2020 2020 2020 2020 2020 2020 7469  ).            ti
-0000e200: 6d65 2e73 6c65 6570 2862 6163 6b6f 6666  me.sleep(backoff
-0000e210: 2e63 7572 7265 6e74 5f62 6163 6b6f 6666  .current_backoff
-0000e220: 2829 290a 2020 2020 7265 7475 726e 2068  ()).    return h
-0000e230: 6561 645f 6970 0a0a 0a40 7469 6d65 6c69  ead_ip...@timeli
-0000e240: 6e65 2e65 7665 6e74 0a64 6566 2067 6574  ne.event.def get
-0000e250: 5f6e 6f64 655f 6970 7328 636c 7573 7465  _node_ips(cluste
-0000e260: 725f 7961 6d6c 3a20 7374 722c 0a20 2020  r_yaml: str,.   
-0000e270: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-0000e280: 7065 6374 6564 5f6e 756d 5f6e 6f64 6573  pected_num_nodes
-0000e290: 3a20 696e 742c 0a20 2020 2020 2020 2020  : int,.         
-0000e2a0: 2020 2020 2020 2020 6865 6164 5f69 705f          head_ip_
-0000e2b0: 6d61 785f 6174 7465 6d70 7473 3a20 696e  max_attempts: in
-0000e2c0: 7420 3d20 312c 0a20 2020 2020 2020 2020  t = 1,.         
-0000e2d0: 2020 2020 2020 2020 776f 726b 6572 5f69          worker_i
-0000e2e0: 705f 6d61 785f 6174 7465 6d70 7473 3a20  p_max_attempts: 
-0000e2f0: 696e 7420 3d20 312c 0a20 2020 2020 2020  int = 1,.       
-0000e300: 2020 2020 2020 2020 2020 6765 745f 696e            get_in
-0000e310: 7465 726e 616c 5f69 7073 3a20 626f 6f6c  ternal_ips: bool
-0000e320: 203d 2046 616c 7365 2920 2d3e 204c 6973   = False) -> Lis
-0000e330: 745b 7374 725d 3a0a 2020 2020 2222 2252  t[str]:.    """R
-0000e340: 6574 7572 6e73 2074 6865 2049 5073 206f  eturns the IPs o
-0000e350: 6620 616c 6c20 6e6f 6465 7320 696e 2074  f all nodes in t
-0000e360: 6865 2063 6c75 7374 6572 2c20 7769 7468  he cluster, with
-0000e370: 2068 6561 6420 6e6f 6465 2061 7420 6672   head node at fr
-0000e380: 6f6e 742e 0a0a 2020 2020 4172 6773 3a0a  ont...    Args:.
-0000e390: 2020 2020 2020 2020 636c 7573 7465 725f          cluster_
-0000e3a0: 7961 6d6c 3a20 5061 7468 2074 6f20 7468  yaml: Path to th
-0000e3b0: 6520 636c 7573 7465 7220 7961 6d6c 2e0a  e cluster yaml..
-0000e3c0: 2020 2020 2020 2020 6578 7065 6374 6564          expected
-0000e3d0: 5f6e 756d 5f6e 6f64 6573 3a20 4578 7065  _num_nodes: Expe
-0000e3e0: 6374 6564 206e 756d 6265 7220 6f66 206e  cted number of n
-0000e3f0: 6f64 6573 2069 6e20 7468 6520 636c 7573  odes in the clus
-0000e400: 7465 722e 0a20 2020 2020 2020 2068 6561  ter..        hea
-0000e410: 645f 6970 5f6d 6178 5f61 7474 656d 7074  d_ip_max_attempt
-0000e420: 733a 204d 6178 2061 7474 656d 7074 7320  s: Max attempts 
-0000e430: 746f 2067 6574 2068 6561 6420 6970 2e0a  to get head ip..
-0000e440: 2020 2020 2020 2020 776f 726b 6572 5f69          worker_i
-0000e450: 705f 6d61 785f 6174 7465 6d70 7473 3a20  p_max_attempts: 
-0000e460: 4d61 7820 6174 7465 6d70 7473 2074 6f20  Max attempts to 
-0000e470: 6765 7420 776f 726b 6572 2069 7073 2e0a  get worker ips..
-0000e480: 2020 2020 2020 2020 6765 745f 696e 7465          get_inte
-0000e490: 726e 616c 5f69 7073 3a20 5768 6574 6865  rnal_ips: Whethe
-0000e4a0: 7220 746f 2067 6574 2069 6e74 6572 6e61  r to get interna
-0000e4b0: 6c20 4950 732e 2057 6865 6e20 4661 6c73  l IPs. When Fals
-0000e4c0: 652c 2069 7420 6973 2073 7469 6c6c 0a20  e, it is still. 
-0000e4d0: 2020 2020 2020 2020 2020 2070 6f73 7369             possi
-0000e4e0: 626c 6520 746f 2067 6574 2069 6e74 6572  ble to get inter
-0000e4f0: 6e61 6c20 4950 7320 6966 2074 6865 2063  nal IPs if the c
-0000e500: 6c75 7374 6572 2064 6f65 7320 6e6f 7420  luster does not 
-0000e510: 6861 7665 2065 7874 6572 6e61 6c0a 2020  have external.  
-0000e520: 2020 2020 2020 2020 2020 4950 732e 0a0a            IPs...
-0000e530: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
-0000e540: 2020 2020 6578 6365 7074 696f 6e73 2e46      exceptions.F
-0000e550: 6574 6368 4950 4572 726f 723a 2069 6620  etchIPError: if 
-0000e560: 7765 2066 6169 6c65 6420 746f 2067 6574  we failed to get
-0000e570: 2074 6865 2049 5073 2e20 652e 7265 6173   the IPs. e.reas
-0000e580: 6f6e 2069 730a 2020 2020 2020 2020 2020  on is.          
-0000e590: 2020 4845 4144 206f 7220 574f 524b 4552    HEAD or WORKER
-0000e5a0: 2e0a 2020 2020 2222 220a 2020 2020 7261  ..    """.    ra
-0000e5b0: 795f 636f 6e66 6967 203d 2063 6f6d 6d6f  y_config = commo
-0000e5c0: 6e5f 7574 696c 732e 7265 6164 5f79 616d  n_utils.read_yam
-0000e5d0: 6c28 636c 7573 7465 725f 7961 6d6c 290a  l(cluster_yaml).
-0000e5e0: 2020 2020 2320 5573 6520 7468 6520 6e65      # Use the ne
-0000e5f0: 7720 7072 6f76 6973 696f 6e65 7220 666f  w provisioner fo
-0000e600: 7220 4157 532e 0a20 2020 2070 726f 7669  r AWS..    provi
-0000e610: 6465 725f 6e61 6d65 203d 2063 6c75 7374  der_name = clust
-0000e620: 6572 5f79 616d 6c5f 7574 696c 732e 6765  er_yaml_utils.ge
-0000e630: 745f 7072 6f76 6964 6572 5f6e 616d 6528  t_provider_name(
-0000e640: 7261 795f 636f 6e66 6967 290a 2020 2020  ray_config).    
-0000e650: 636c 6f75 6420 3d20 636c 6f75 645f 7265  cloud = cloud_re
-0000e660: 6769 7374 7279 2e43 4c4f 5544 5f52 4547  gistry.CLOUD_REG
-0000e670: 4953 5452 592e 6672 6f6d 5f73 7472 2870  ISTRY.from_str(p
-0000e680: 726f 7669 6465 725f 6e61 6d65 290a 2020  rovider_name).  
-0000e690: 2020 6173 7365 7274 2063 6c6f 7564 2069    assert cloud i
-0000e6a0: 7320 6e6f 7420 4e6f 6e65 2c20 7072 6f76  s not None, prov
-0000e6b0: 6964 6572 5f6e 616d 650a 0a20 2020 2069  ider_name..    i
-0000e6c0: 6620 636c 6f75 642e 5052 4f56 4953 494f  f cloud.PROVISIO
-0000e6d0: 4e45 525f 5645 5253 494f 4e20 3e3d 2063  NER_VERSION >= c
-0000e6e0: 6c6f 7564 732e 5072 6f76 6973 696f 6e65  louds.Provisione
-0000e6f0: 7256 6572 7369 6f6e 2e53 4b59 5049 4c4f  rVersion.SKYPILO
-0000e700: 543a 0a20 2020 2020 2020 2074 7279 3a0a  T:.        try:.
-0000e710: 2020 2020 2020 2020 2020 2020 6d65 7461              meta
-0000e720: 6461 7461 203d 2070 726f 7669 7369 6f6e  data = provision
-0000e730: 5f6c 6962 2e67 6574 5f63 6c75 7374 6572  _lib.get_cluster
-0000e740: 5f69 6e66 6f28 0a20 2020 2020 2020 2020  _info(.         
-0000e750: 2020 2020 2020 2070 726f 7669 6465 725f         provider_
-0000e760: 6e61 6d65 2c20 7261 795f 636f 6e66 6967  name, ray_config
-0000e770: 5b27 7072 6f76 6964 6572 275d 2e67 6574  ['provider'].get
-0000e780: 2827 7265 6769 6f6e 2729 2c0a 2020 2020  ('region'),.    
-0000e790: 2020 2020 2020 2020 2020 2020 7261 795f              ray_
-0000e7a0: 636f 6e66 6967 5b27 636c 7573 7465 725f  config['cluster_
-0000e7b0: 6e61 6d65 275d 2c20 7261 795f 636f 6e66  name'], ray_conf
-0000e7c0: 6967 5b27 7072 6f76 6964 6572 275d 290a  ig['provider']).
-0000e7d0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-0000e7e0: 7863 6570 7469 6f6e 2061 7320 653a 2020  xception as e:  
-0000e7f0: 2320 7079 6c69 6e74 3a20 6469 7361 626c  # pylint: disabl
-0000e800: 653d 6272 6f61 642d 6578 6365 7074 0a20  e=broad-except. 
-0000e810: 2020 2020 2020 2020 2020 2023 2054 6869             # Thi
-0000e820: 7320 636f 756c 6420 6861 7070 656e 2077  s could happen w
-0000e830: 6865 6e20 7468 6520 564d 2069 7320 6e6f  hen the VM is no
-0000e840: 7420 6675 6c6c 7920 6c61 756e 6368 6564  t fully launched
-0000e850: 2c20 616e 6420 6120 7573 6572 0a20 2020  , and a user.   
-0000e860: 2020 2020 2020 2020 2023 2069 7320 7472           # is tr
-0000e870: 7969 6e67 2074 6f20 7465 726d 696e 6174  ying to terminat
-0000e880: 6520 6974 2077 6974 6820 6073 6b79 2064  e it with `sky d
-0000e890: 6f77 6e60 2e0a 2020 2020 2020 2020 2020  own`..          
-0000e8a0: 2020 6c6f 6767 6572 2e64 6562 7567 280a    logger.debug(.
-0000e8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e8c0: 2746 6169 6c65 6420 746f 2067 6574 2063  'Failed to get c
-0000e8d0: 6c75 7374 6572 2069 6e66 6f20 666f 7220  luster info for 
-0000e8e0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0000e8f0: 2020 6627 7b72 6179 5f63 6f6e 6669 675b    f'{ray_config[
-0000e900: 2263 6c75 7374 6572 5f6e 616d 6522 5d7d  "cluster_name"]}
-0000e910: 2066 726f 6d20 7468 6520 6e65 7720 7072   from the new pr
-0000e920: 6f76 6973 696f 6e65 7220 270a 2020 2020  ovisioner '.    
-0000e930: 2020 2020 2020 2020 2020 2020 6627 7769              f'wi
-0000e940: 7468 207b 636f 6d6d 6f6e 5f75 7469 6c73  th {common_utils
-0000e950: 2e66 6f72 6d61 745f 6578 6365 7074 696f  .format_exceptio
-0000e960: 6e28 6529 7d2e 2729 0a20 2020 2020 2020  n(e)}.').       
-0000e970: 2020 2020 2072 6169 7365 2065 7863 6570       raise excep
-0000e980: 7469 6f6e 732e 4665 7463 6849 5045 7272  tions.FetchIPErr
-0000e990: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-0000e9a0: 2020 2020 6578 6365 7074 696f 6e73 2e46      exceptions.F
-0000e9b0: 6574 6368 4950 4572 726f 722e 5265 6173  etchIPError.Reas
-0000e9c0: 6f6e 2e48 4541 4429 2066 726f 6d20 650a  on.HEAD) from e.
-0000e9d0: 2020 2020 2020 2020 6966 206c 656e 286d          if len(m
-0000e9e0: 6574 6164 6174 612e 696e 7374 616e 6365  etadata.instance
-0000e9f0: 7329 203c 2065 7870 6563 7465 645f 6e75  s) < expected_nu
-0000ea00: 6d5f 6e6f 6465 733a 0a20 2020 2020 2020  m_nodes:.       
-0000ea10: 2020 2020 2023 2053 696d 756c 6174 6520       # Simulate 
-0000ea20: 7468 6520 6578 6365 7074 696f 6e20 7768  the exception wh
-0000ea30: 656e 2052 6179 2068 6561 6420 6e6f 6465  en Ray head node
-0000ea40: 2069 7320 6e6f 7420 7570 2e0a 2020 2020   is not up..    
-0000ea50: 2020 2020 2020 2020 7261 6973 6520 6578          raise ex
-0000ea60: 6365 7074 696f 6e73 2e46 6574 6368 4950  ceptions.FetchIP
-0000ea70: 4572 726f 7228 6578 6365 7074 696f 6e73  Error(exceptions
-0000ea80: 2e46 6574 6368 4950 4572 726f 722e 5265  .FetchIPError.Re
-0000ea90: 6173 6f6e 2e48 4541 4429 0a20 2020 2020  ason.HEAD).     
-0000eaa0: 2020 2072 6574 7572 6e20 6d65 7461 6461     return metada
-0000eab0: 7461 2e67 6574 5f66 6561 7369 626c 655f  ta.get_feasible_
-0000eac0: 6970 7328 6765 745f 696e 7465 726e 616c  ips(get_internal
-0000ead0: 5f69 7073 290a 0a20 2020 2069 6620 6765  _ips)..    if ge
-0000eae0: 745f 696e 7465 726e 616c 5f69 7073 3a0a  t_internal_ips:.
-0000eaf0: 2020 2020 2020 2020 7769 7468 2074 656d          with tem
-0000eb00: 7066 696c 652e 4e61 6d65 6454 656d 706f  pfile.NamedTempo
-0000eb10: 7261 7279 4669 6c65 286d 6f64 653d 2777  raryFile(mode='w
-0000eb20: 272c 2064 656c 6574 653d 4661 6c73 6529  ', delete=False)
-0000eb30: 2061 7320 663a 0a20 2020 2020 2020 2020   as f:.         
-0000eb40: 2020 2072 6179 5f63 6f6e 6669 675b 2770     ray_config['p
-0000eb50: 726f 7669 6465 7227 5d5b 2775 7365 5f69  rovider']['use_i
-0000eb60: 6e74 6572 6e61 6c5f 6970 7327 5d20 3d20  nternal_ips'] = 
-0000eb70: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-0000eb80: 2079 616d 6c2e 6475 6d70 2872 6179 5f63   yaml.dump(ray_c
-0000eb90: 6f6e 6669 672c 2066 290a 2020 2020 2020  onfig, f).      
-0000eba0: 2020 2020 2020 636c 7573 7465 725f 7961        cluster_ya
-0000ebb0: 6d6c 203d 2066 2e6e 616d 650a 0a20 2020  ml = f.name..   
-0000ebc0: 2023 2043 6865 636b 2074 6865 206e 6574   # Check the net
-0000ebd0: 776f 726b 2063 6f6e 6e65 6374 696f 6e20  work connection 
-0000ebe0: 6669 7273 7420 746f 2061 766f 6964 206c  first to avoid l
-0000ebf0: 6f6e 6720 6861 6e67 696e 6720 7469 6d65  ong hanging time
-0000ec00: 2066 6f72 0a20 2020 2023 2072 6179 2067   for.    # ray g
-0000ec10: 6574 2d68 6561 642d 6970 2062 656c 6f77  et-head-ip below
-0000ec20: 2c20 6966 2061 206c 6f6e 672d 6c61 7374  , if a long-last
-0000ec30: 696e 6720 6e65 7477 6f72 6b20 636f 6e6e  ing network conn
-0000ec40: 6563 7469 6f6e 2066 6169 6c75 7265 0a20  ection failure. 
-0000ec50: 2020 2023 2068 6170 7065 6e73 2e0a 2020     # happens..  
-0000ec60: 2020 6368 6563 6b5f 6e65 7477 6f72 6b5f    check_network_
-0000ec70: 636f 6e6e 6563 7469 6f6e 2829 0a20 2020  connection().   
-0000ec80: 2068 6561 645f 6970 203d 205f 7175 6572   head_ip = _quer
-0000ec90: 795f 6865 6164 5f69 705f 7769 7468 5f72  y_head_ip_with_r
-0000eca0: 6574 7269 6573 2863 6c75 7374 6572 5f79  etries(cluster_y
-0000ecb0: 616d 6c2c 0a20 2020 2020 2020 2020 2020  aml,.           
-0000ecc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ecd0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0000ece0: 6178 5f61 7474 656d 7074 733d 6865 6164  ax_attempts=head
-0000ecf0: 5f69 705f 6d61 785f 6174 7465 6d70 7473  _ip_max_attempts
-0000ed00: 290a 2020 2020 6865 6164 5f69 705f 6c69  ).    head_ip_li
-0000ed10: 7374 203d 205b 6865 6164 5f69 705d 0a20  st = [head_ip]. 
-0000ed20: 2020 2069 6620 6578 7065 6374 6564 5f6e     if expected_n
-0000ed30: 756d 5f6e 6f64 6573 203e 2031 3a0a 2020  um_nodes > 1:.  
-0000ed40: 2020 2020 2020 6261 636b 6f66 6620 3d20        backoff = 
-0000ed50: 636f 6d6d 6f6e 5f75 7469 6c73 2e42 6163  common_utils.Bac
-0000ed60: 6b6f 6666 2869 6e69 7469 616c 5f62 6163  koff(initial_bac
-0000ed70: 6b6f 6666 3d35 2c20 6d61 785f 6261 636b  koff=5, max_back
-0000ed80: 6f66 665f 6661 6374 6f72 3d35 290a 0a20  off_factor=5).. 
-0000ed90: 2020 2020 2020 2066 6f72 2072 6574 7279         for retry
-0000eda0: 5f63 6e74 2069 6e20 7261 6e67 6528 776f  _cnt in range(wo
-0000edb0: 726b 6572 5f69 705f 6d61 785f 6174 7465  rker_ip_max_atte
-0000edc0: 6d70 7473 293a 0a20 2020 2020 2020 2020  mpts):.         
-0000edd0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0000ede0: 2020 2020 2020 2020 6675 6c6c 5f63 6c75          full_clu
-0000edf0: 7374 6572 5f79 616d 6c20 3d20 7374 7228  ster_yaml = str(
-0000ee00: 7061 7468 6c69 622e 5061 7468 2863 6c75  pathlib.Path(clu
-0000ee10: 7374 6572 5f79 616d 6c29 2e65 7870 616e  ster_yaml).expan
-0000ee20: 6475 7365 7228 2929 0a20 2020 2020 2020  duser()).       
-0000ee30: 2020 2020 2020 2020 2070 726f 6320 3d20           proc = 
-0000ee40: 7375 6270 726f 6365 7373 5f75 7469 6c73  subprocess_utils
-0000ee50: 2e72 756e 280a 2020 2020 2020 2020 2020  .run(.          
-0000ee60: 2020 2020 2020 2020 2020 6627 7261 7920            f'ray 
-0000ee70: 6765 742d 776f 726b 6572 2d69 7073 207b  get-worker-ips {
-0000ee80: 6675 6c6c 5f63 6c75 7374 6572 5f79 616d  full_cluster_yam
-0000ee90: 6c21 727d 272c 0a20 2020 2020 2020 2020  l!r}',.         
-0000eea0: 2020 2020 2020 2020 2020 2073 7464 6f75             stdou
-0000eeb0: 743d 7375 6270 726f 6365 7373 2e50 4950  t=subprocess.PIP
-0000eec0: 452c 0a20 2020 2020 2020 2020 2020 2020  E,.             
-0000eed0: 2020 2020 2020 2073 7464 6572 723d 7375         stderr=su
-0000eee0: 6270 726f 6365 7373 2e50 4950 4529 0a20  bprocess.PIPE). 
-0000eef0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-0000ef00: 7574 203d 2070 726f 632e 7374 646f 7574  ut = proc.stdout
-0000ef10: 2e64 6563 6f64 6528 290a 2020 2020 2020  .decode().      
-0000ef20: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-0000ef30: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0000ef40: 7074 2073 7562 7072 6f63 6573 732e 4361  pt subprocess.Ca
-0000ef50: 6c6c 6564 5072 6f63 6573 7345 7272 6f72  lledProcessError
-0000ef60: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-0000ef70: 2020 2020 2020 2069 6620 7265 7472 795f         if retry_
-0000ef80: 636e 7420 3d3d 2077 6f72 6b65 725f 6970  cnt == worker_ip
-0000ef90: 5f6d 6178 5f61 7474 656d 7074 7320 2d20  _max_attempts - 
-0000efa0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-0000efb0: 2020 2020 2020 2072 6169 7365 2065 7863         raise exc
-0000efc0: 6570 7469 6f6e 732e 4665 7463 6849 5045  eptions.FetchIPE
-0000efd0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-0000efe0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-0000eff0: 6365 7074 696f 6e73 2e46 6574 6368 4950  ceptions.FetchIP
-0000f000: 4572 726f 722e 5265 6173 6f6e 2e57 4f52  Error.Reason.WOR
-0000f010: 4b45 5229 2066 726f 6d20 650a 2020 2020  KER) from e.    
-0000f020: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
-0000f030: 7472 7920 6966 2074 6865 2073 7368 2069  try if the ssh i
-0000f040: 7320 6e6f 7420 7265 6164 7920 666f 7220  s not ready for 
-0000f050: 7468 6520 776f 726b 6572 7320 7965 742e  the workers yet.
-0000f060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f070: 2062 6163 6b6f 6666 5f74 696d 6520 3d20   backoff_time = 
-0000f080: 6261 636b 6f66 662e 6375 7272 656e 745f  backoff.current_
-0000f090: 6261 636b 6f66 6628 290a 2020 2020 2020  backoff().      
-0000f0a0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-0000f0b0: 2e64 6562 7567 2827 5265 7472 7969 6e67  .debug('Retrying
-0000f0c0: 2074 6f20 6765 7420 776f 726b 6572 2069   to get worker i
-0000f0d0: 7020 270a 2020 2020 2020 2020 2020 2020  p '.            
-0000f0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f0f0: 2066 275b 7b72 6574 7279 5f63 6e74 7d2f   f'[{retry_cnt}/
-0000f100: 7b77 6f72 6b65 725f 6970 5f6d 6178 5f61  {worker_ip_max_a
-0000f110: 7474 656d 7074 737d 5d20 696e 2027 0a20  ttempts}] in '. 
-0000f120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f130: 2020 2020 2020 2020 2020 2020 6627 7b62              f'{b
-0000f140: 6163 6b6f 6666 5f74 696d 657d 2073 6563  ackoff_time} sec
-0000f150: 6f6e 6473 2e27 290a 2020 2020 2020 2020  onds.').        
-0000f160: 2020 2020 2020 2020 7469 6d65 2e73 6c65          time.sle
-0000f170: 6570 2862 6163 6b6f 6666 5f74 696d 6529  ep(backoff_time)
-0000f180: 0a20 2020 2020 2020 2077 6f72 6b65 725f  .        worker_
-0000f190: 6970 7320 3d20 7265 2e66 696e 6461 6c6c  ips = re.findall
-0000f1a0: 2849 505f 4144 4452 5f52 4547 4558 2c20  (IP_ADDR_REGEX, 
-0000f1b0: 6f75 7429 0a20 2020 2020 2020 2069 6620  out).        if 
-0000f1c0: 6c65 6e28 776f 726b 6572 5f69 7073 2920  len(worker_ips) 
-0000f1d0: 213d 2065 7870 6563 7465 645f 6e75 6d5f  != expected_num_
-0000f1e0: 6e6f 6465 7320 2d20 313a 0a20 2020 2020  nodes - 1:.     
-0000f1f0: 2020 2020 2020 206e 203d 2065 7870 6563         n = expec
-0000f200: 7465 645f 6e75 6d5f 6e6f 6465 7320 2d20  ted_num_nodes - 
-0000f210: 310a 2020 2020 2020 2020 2020 2020 6966  1.            if
-0000f220: 206c 656e 2877 6f72 6b65 725f 6970 7329   len(worker_ips)
-0000f230: 203e 206e 3a0a 2020 2020 2020 2020 2020   > n:.          
-0000f240: 2020 2020 2020 2320 5468 6973 2063 6f75        # This cou
-0000f250: 6c64 2062 6520 7472 6967 6765 7265 6420  ld be triggered 
-0000f260: 6966 2065 2e67 2e2c 2073 6f6d 6520 6c6f  if e.g., some lo
-0000f270: 6767 696e 6720 6973 2061 6464 6564 2069  gging is added i
-0000f280: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-0000f290: 2020 2320 736b 7970 696c 6f74 5f63 6f6e    # skypilot_con
-0000f2a0: 6669 672c 2061 206d 6f64 756c 6520 7468  fig, a module th
-0000f2b0: 6174 2068 6173 2073 6f6d 6520 636f 6465  at has some code
-0000f2c0: 2065 7865 6375 7465 6420 7768 656e 6576   executed whenev
-0000f2d0: 6572 0a20 2020 2020 2020 2020 2020 2020  er.             
-0000f2e0: 2020 2023 2060 736b 7960 2069 7320 696d     # `sky` is im
-0000f2f0: 706f 7274 6564 2e0a 2020 2020 2020 2020  ported..        
-0000f300: 2020 2020 2020 2020 6c6f 6767 6572 2e77          logger.w
-0000f310: 6172 6e69 6e67 280a 2020 2020 2020 2020  arning(.        
-0000f320: 2020 2020 2020 2020 2020 2020 6627 4578              f'Ex
-0000f330: 7065 6374 6564 207b 6e7d 2077 6f72 6b65  pected {n} worke
-0000f340: 7220 4950 2873 293b 2066 6f75 6e64 2027  r IP(s); found '
-0000f350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f360: 2020 2020 2066 277b 6c65 6e28 776f 726b       f'{len(work
-0000f370: 6572 5f69 7073 297d 3a20 7b77 6f72 6b65  er_ips)}: {worke
-0000f380: 725f 6970 737d 270a 2020 2020 2020 2020  r_ips}'.        
-0000f390: 2020 2020 2020 2020 2020 2020 275c 6e54              '\nT
-0000f3a0: 6869 7320 636f 756c 6420 6861 7070 656e  his could happen
-0000f3b0: 2069 6620 7468 6572 6520 6973 2065 7874   if there is ext
-0000f3c0: 7261 206f 7574 7075 7420 6672 6f6d 2027  ra output from '
-0000f3d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f3e0: 2020 2020 2027 6072 6179 2067 6574 2d77       '`ray get-w
-0000f3f0: 6f72 6b65 722d 6970 7360 2c20 7768 6963  orker-ips`, whic
-0000f400: 6820 7368 6f75 6c64 2062 6520 696e 7370  h should be insp
-0000f410: 6563 7465 6420 6265 6c6f 772e 270a 2020  ected below.'.  
-0000f420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f430: 2020 6627 5c6e 3d3d 204f 7574 7075 7420    f'\n== Output 
-0000f440: 3d3d 5c6e 7b6f 7574 7d27 0a20 2020 2020  ==\n{out}'.     
-0000f450: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000f460: 275c 6e3d 3d20 4f75 7470 7574 2065 6e64  '\n== Output end
-0000f470: 7320 3d3d 2729 0a20 2020 2020 2020 2020  s ==').         
-0000f480: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
-0000f490: 726e 696e 6728 6627 5c6e 5072 6f63 6565  rning(f'\nProcee
-0000f4a0: 6469 6e67 2077 6974 6820 7468 6520 6c61  ding with the la
-0000f4b0: 7374 207b 6e7d 2027 0a20 2020 2020 2020  st {n} '.       
-0000f4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f4d0: 2020 2020 2020 2020 6627 6465 7465 6374          f'detect
-0000f4e0: 6564 2049 5028 7329 3a20 7b77 6f72 6b65  ed IP(s): {worke
-0000f4f0: 725f 6970 735b 2d6e 3a5d 7d2e 2729 0a20  r_ips[-n:]}.'). 
-0000f500: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0000f510: 6f72 6b65 725f 6970 7320 3d20 776f 726b  orker_ips = work
-0000f520: 6572 5f69 7073 5b2d 6e3a 5d0a 2020 2020  er_ips[-n:].    
-0000f530: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000f540: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0000f550: 6973 6520 6578 6365 7074 696f 6e73 2e46  ise exceptions.F
-0000f560: 6574 6368 4950 4572 726f 7228 0a20 2020  etchIPError(.   
-0000f570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f580: 2065 7863 6570 7469 6f6e 732e 4665 7463   exceptions.Fetc
-0000f590: 6849 5045 7272 6f72 2e52 6561 736f 6e2e  hIPError.Reason.
-0000f5a0: 574f 524b 4552 290a 2020 2020 656c 7365  WORKER).    else
-0000f5b0: 3a0a 2020 2020 2020 2020 776f 726b 6572  :.        worker
-0000f5c0: 5f69 7073 203d 205b 5d0a 2020 2020 7265  _ips = [].    re
-0000f5d0: 7475 726e 2068 6561 645f 6970 5f6c 6973  turn head_ip_lis
-0000f5e0: 7420 2b20 776f 726b 6572 5f69 7073 0a0a  t + worker_ips..
-0000f5f0: 0a64 6566 2063 6865 636b 5f6e 6574 776f  .def check_netwo
-0000f600: 726b 5f63 6f6e 6e65 6374 696f 6e28 293a  rk_connection():
-0000f610: 0a20 2020 2023 2054 6f6c 6572 6174 6520  .    # Tolerate 
-0000f620: 3320 7265 7472 6965 7320 6173 2069 7420  3 retries as it 
-0000f630: 6973 206f 6273 6572 7665 6420 7468 6174  is observed that
-0000f640: 2063 6f6e 6e65 6374 696f 6e73 2063 616e   connections can
-0000f650: 2066 6169 6c2e 0a20 2020 2061 6461 7074   fail..    adapt
-0000f660: 6572 203d 2061 6461 7074 6572 732e 4854  er = adapters.HT
-0000f670: 5450 4164 6170 7465 7228 6d61 785f 7265  TPAdapter(max_re
-0000f680: 7472 6965 733d 7265 7472 795f 6c69 622e  tries=retry_lib.
-0000f690: 5265 7472 7928 746f 7461 6c3d 3329 290a  Retry(total=3)).
-0000f6a0: 2020 2020 6874 7470 203d 2072 6571 7565      http = reque
-0000f6b0: 7374 732e 5365 7373 696f 6e28 290a 2020  sts.Session().  
-0000f6c0: 2020 6874 7470 2e6d 6f75 6e74 2827 6874    http.mount('ht
-0000f6d0: 7470 733a 2f2f 272c 2061 6461 7074 6572  tps://', adapter
-0000f6e0: 290a 2020 2020 6874 7470 2e6d 6f75 6e74  ).    http.mount
-0000f6f0: 2827 6874 7470 3a2f 2f27 2c20 6164 6170  ('http://', adap
-0000f700: 7465 7229 0a20 2020 2066 6f72 2069 2c20  ter).    for i, 
-0000f710: 6970 2069 6e20 656e 756d 6572 6174 6528  ip in enumerate(
-0000f720: 5f54 4553 545f 4950 5f4c 4953 5429 3a0a  _TEST_IP_LIST):.
-0000f730: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0000f740: 2020 2020 2020 2020 2068 7474 702e 6865           http.he
-0000f750: 6164 2869 702c 2074 696d 656f 7574 3d33  ad(ip, timeout=3
-0000f760: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-0000f770: 7475 726e 0a20 2020 2020 2020 2065 7863  turn.        exc
-0000f780: 6570 7420 2872 6571 7565 7374 732e 5469  ept (requests.Ti
-0000f790: 6d65 6f75 742c 2072 6571 7565 7374 732e  meout, requests.
-0000f7a0: 6578 6365 7074 696f 6e73 2e43 6f6e 6e65  exceptions.Conne
-0000f7b0: 6374 696f 6e45 7272 6f72 2920 6173 2065  ctionError) as e
-0000f7c0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-0000f7d0: 2069 203d 3d20 6c65 6e28 5f54 4553 545f   i == len(_TEST_
-0000f7e0: 4950 5f4c 4953 5429 202d 2031 3a0a 2020  IP_LIST) - 1:.  
-0000f7f0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0000f800: 6973 6520 6578 6365 7074 696f 6e73 2e4e  ise exceptions.N
-0000f810: 6574 776f 726b 4572 726f 7228 2743 6f75  etworkError('Cou
-0000f820: 6c64 206e 6f74 2072 6566 7265 7368 2074  ld not refresh t
-0000f830: 6865 2063 6c75 7374 6572 2e20 270a 2020  he cluster. '.  
-0000f840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f860: 2020 2020 2020 2020 2020 2020 274e 6574              'Net
-0000f870: 776f 726b 2073 6565 6d73 2064 6f77 6e2e  work seems down.
-0000f880: 2729 2066 726f 6d20 650a 0a0a 6465 6620  ') from e...def 
-0000f890: 6368 6563 6b5f 6f77 6e65 725f 6964 656e  check_owner_iden
-0000f8a0: 7469 7479 2863 6c75 7374 6572 5f6e 616d  tity(cluster_nam
-0000f8b0: 653a 2073 7472 2920 2d3e 204e 6f6e 653a  e: str) -> None:
-0000f8c0: 0a20 2020 2022 2222 4368 6563 6b20 6966  .    """Check if
-0000f8d0: 2063 7572 7265 6e74 2075 7365 7220 6973   current user is
-0000f8e0: 2074 6865 2073 616d 6520 6173 2074 6865   the same as the
-0000f8f0: 2075 7365 7220 7768 6f20 6372 6561 7465   user who create
-0000f900: 6420 7468 6520 636c 7573 7465 722e 0a0a  d the cluster...
-0000f910: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
-0000f920: 2020 2020 6578 6365 7074 696f 6e73 2e43      exceptions.C
-0000f930: 6c75 7374 6572 4f77 6e65 7249 6465 6e74  lusterOwnerIdent
-0000f940: 6974 794d 6973 6d61 7463 6845 7272 6f72  ityMismatchError
-0000f950: 3a20 6966 2074 6865 2063 7572 7265 6e74  : if the current
-0000f960: 2075 7365 7220 6973 0a20 2020 2020 2020   user is.       
-0000f970: 2020 206e 6f74 2074 6865 2073 616d 6520     not the same 
-0000f980: 6173 2074 6865 2075 7365 7220 7768 6f20  as the user who 
-0000f990: 6372 6561 7465 6420 7468 6520 636c 7573  created the clus
-0000f9a0: 7465 722e 0a20 2020 2020 2020 2065 7863  ter..        exc
-0000f9b0: 6570 7469 6f6e 732e 436c 6f75 6455 7365  eptions.CloudUse
-0000f9c0: 7249 6465 6e74 6974 7945 7272 6f72 3a20  rIdentityError: 
-0000f9d0: 6966 2077 6520 6661 696c 2074 6f20 6765  if we fail to ge
-0000f9e0: 7420 7468 6520 6375 7272 656e 7420 7573  t the current us
-0000f9f0: 6572 0a20 2020 2020 2020 2020 2069 6465  er.          ide
-0000fa00: 6e74 6974 792e 0a20 2020 2022 2222 0a20  ntity..    """. 
-0000fa10: 2020 2069 6620 656e 765f 6f70 7469 6f6e     if env_option
-0000fa20: 732e 4f70 7469 6f6e 732e 534b 4950 5f43  s.Options.SKIP_C
-0000fa30: 4c4f 5544 5f49 4445 4e54 4954 595f 4348  LOUD_IDENTITY_CH
-0000fa40: 4543 4b2e 6765 7428 293a 0a20 2020 2020  ECK.get():.     
-0000fa50: 2020 2072 6574 7572 6e0a 2020 2020 7265     return.    re
-0000fa60: 636f 7264 203d 2067 6c6f 6261 6c5f 7573  cord = global_us
-0000fa70: 6572 5f73 7461 7465 2e67 6574 5f63 6c75  er_state.get_clu
-0000fa80: 7374 6572 5f66 726f 6d5f 6e61 6d65 2863  ster_from_name(c
-0000fa90: 6c75 7374 6572 5f6e 616d 6529 0a20 2020  luster_name).   
-0000faa0: 2069 6620 7265 636f 7264 2069 7320 4e6f   if record is No
-0000fab0: 6e65 3a0a 2020 2020 2020 2020 7265 7475  ne:.        retu
-0000fac0: 726e 0a20 2020 2068 616e 646c 6520 3d20  rn.    handle = 
-0000fad0: 7265 636f 7264 5b27 6861 6e64 6c65 275d  record['handle']
-0000fae0: 0a20 2020 2069 6620 6e6f 7420 6973 696e  .    if not isin
-0000faf0: 7374 616e 6365 2868 616e 646c 652c 2062  stance(handle, b
-0000fb00: 6163 6b65 6e64 732e 436c 6f75 6456 6d52  ackends.CloudVmR
-0000fb10: 6179 5265 736f 7572 6365 4861 6e64 6c65  ayResourceHandle
-0000fb20: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-0000fb30: 6e0a 0a20 2020 2063 6c6f 7564 203d 2068  n..    cloud = h
-0000fb40: 616e 646c 652e 6c61 756e 6368 6564 5f72  andle.launched_r
-0000fb50: 6573 6f75 7263 6573 2e63 6c6f 7564 0a20  esources.cloud. 
-0000fb60: 2020 2063 7572 7265 6e74 5f75 7365 725f     current_user_
-0000fb70: 6964 656e 7469 7479 203d 2063 6c6f 7564  identity = cloud
-0000fb80: 2e67 6574 5f63 7572 7265 6e74 5f75 7365  .get_current_use
-0000fb90: 725f 6964 656e 7469 7479 2829 0a20 2020  r_identity().   
-0000fba0: 206f 776e 6572 5f69 6465 6e74 6974 7920   owner_identity 
-0000fbb0: 3d20 7265 636f 7264 5b27 6f77 6e65 7227  = record['owner'
-0000fbc0: 5d0a 2020 2020 6966 2063 7572 7265 6e74  ].    if current
-0000fbd0: 5f75 7365 725f 6964 656e 7469 7479 2069  _user_identity i
-0000fbe0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0000fbf0: 2320 536b 6970 2074 6865 2063 6865 636b  # Skip the check
-0000fc00: 2069 6620 7468 6520 636c 6f75 6420 646f   if the cloud do
-0000fc10: 6573 206e 6f74 2073 7570 706f 7274 2075  es not support u
-0000fc20: 7365 7220 6964 656e 7469 7479 2e0a 2020  ser identity..  
-0000fc30: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-0000fc40: 2023 2054 6865 2075 7365 7220 6964 656e   # The user iden
-0000fc50: 7469 7479 2063 616e 2062 6520 4e6f 6e65  tity can be None
-0000fc60: 2c20 6966 2074 6865 2063 6c75 7374 6572  , if the cluster
-0000fc70: 2069 7320 6372 6561 7465 6420 6279 2061   is created by a
-0000fc80: 6e20 6f6c 6465 720a 2020 2020 2320 7665  n older.    # ve
-0000fc90: 7273 696f 6e20 6f66 2053 6b79 5069 6c6f  rsion of SkyPilo
-0000fca0: 742e 2049 6e20 7468 6174 2063 6173 652c  t. In that case,
-0000fcb0: 2077 6520 7365 7420 7468 6520 7573 6572   we set the user
-0000fcc0: 2069 6465 6e74 6974 7920 746f 2074 6865   identity to the
-0000fcd0: 0a20 2020 2023 2063 7572 7265 6e74 206f  .    # current o
-0000fce0: 6e65 2e0a 2020 2020 2320 4e4f 5445 3a20  ne..    # NOTE: 
-0000fcf0: 6120 7573 6572 2077 686f 2075 7067 7261  a user who upgra
-0000fd00: 6465 7320 536b 7950 696c 6f74 2061 6e64  des SkyPilot and
-0000fd10: 2073 7769 7463 6865 7320 746f 2061 206e   switches to a n
-0000fd20: 6577 2063 6c6f 7564 2069 6465 6e74 6974  ew cloud identit
-0000fd30: 790a 2020 2020 2320 696d 6d65 6469 6174  y.    # immediat
-0000fd40: 656c 7920 7769 7468 6f75 7420 6073 6b79  ely without `sky
-0000fd50: 2073 7461 7475 7320 2d2d 7265 6672 6573   status --refres
-0000fd60: 6860 2066 6972 7374 2c20 7769 6c6c 2063  h` first, will c
-0000fd70: 6175 7365 2061 206c 6561 6b61 6765 0a20  ause a leakage. 
-0000fd80: 2020 2023 206f 6620 7468 6520 6578 6973     # of the exis
-0000fd90: 7469 6e67 2063 6c75 7374 6572 2e20 5765  ting cluster. We
-0000fda0: 2064 6565 6d20 7468 6973 2061 6e20 6163   deem this an ac
-0000fdb0: 6365 7074 6162 6c65 2074 7261 6465 6f66  ceptable tradeof
-0000fdc0: 6620 6d61 696e 6c79 0a20 2020 2023 2062  f mainly.    # b
-0000fdd0: 6563 6175 7365 206d 756c 7469 2d69 6465  ecause multi-ide
-0000fde0: 6e74 6974 7920 6973 206e 6f74 2063 6f6d  ntity is not com
-0000fdf0: 6d6f 6e20 2861 7420 6c65 6173 7420 6174  mon (at least at
-0000fe00: 2074 6865 206d 6f6d 656e 7429 2e0a 2020   the moment)..  
-0000fe10: 2020 6966 206f 776e 6572 5f69 6465 6e74    if owner_ident
-0000fe20: 6974 7920 6973 204e 6f6e 653a 0a20 2020  ity is None:.   
-0000fe30: 2020 2020 2067 6c6f 6261 6c5f 7573 6572       global_user
-0000fe40: 5f73 7461 7465 2e73 6574 5f6f 776e 6572  _state.set_owner
-0000fe50: 5f69 6465 6e74 6974 795f 666f 725f 636c  _identity_for_cl
-0000fe60: 7573 7465 7228 0a20 2020 2020 2020 2020  uster(.         
-0000fe70: 2020 2063 6c75 7374 6572 5f6e 616d 652c     cluster_name,
-0000fe80: 2063 7572 7265 6e74 5f75 7365 725f 6964   current_user_id
-0000fe90: 656e 7469 7479 290a 2020 2020 656c 7365  entity).    else
-0000fea0: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
-0000feb0: 2069 7369 6e73 7461 6e63 6528 6f77 6e65   isinstance(owne
-0000fec0: 725f 6964 656e 7469 7479 2c20 6c69 7374  r_identity, list
-0000fed0: 290a 2020 2020 2020 2020 2320 4974 2069  ).        # It i
-0000fee0: 7320 4f4b 2069 6620 7468 6520 6f77 6e65  s OK if the owne
-0000fef0: 7220 6964 656e 7469 7479 2069 7320 7368  r identity is sh
-0000ff00: 6f72 7465 722c 2077 6869 6368 2077 696c  orter, which wil
-0000ff10: 6c20 6861 7070 656e 2077 6865 6e0a 2020  l happen when.  
-0000ff20: 2020 2020 2020 2320 7468 6520 636c 7573        # the clus
-0000ff30: 7465 7220 6973 206c 6175 6e63 6865 6420  ter is launched 
-0000ff40: 6265 666f 7265 2023 3138 3038 2e20 496e  before #1808. In
-0000ff50: 2074 6861 7420 6361 7365 2c20 7765 206f   that case, we o
-0000ff60: 6e6c 7920 6368 6563 6b0a 2020 2020 2020  nly check.      
-0000ff70: 2020 2320 7468 6520 7361 6d65 206c 656e    # the same len
-0000ff80: 6774 6820 287a 6970 2077 696c 6c20 7374  gth (zip will st
-0000ff90: 6f70 2061 7420 7468 6520 7368 6f72 7465  op at the shorte
-0000ffa0: 7220 6f6e 6529 2e0a 2020 2020 2020 2020  r one)..        
-0000ffb0: 666f 7220 692c 2028 6f77 6e65 722c 0a20  for i, (owner,. 
-0000ffc0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0000ffd0: 7572 7265 6e74 2920 696e 2065 6e75 6d65  urrent) in enume
-0000ffe0: 7261 7465 287a 6970 286f 776e 6572 5f69  rate(zip(owner_i
-0000fff0: 6465 6e74 6974 792c 0a20 2020 2020 2020  dentity,.       
-00010000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010020: 2020 2063 7572 7265 6e74 5f75 7365 725f     current_user_
-00010030: 6964 656e 7469 7479 2929 3a0a 2020 2020  identity)):.    
-00010040: 2020 2020 2020 2020 2320 436c 6561 6e20          # Clean 
-00010050: 7570 2074 6865 206f 776e 6572 2069 6465  up the owner ide
-00010060: 6e74 6979 2066 6f72 2074 6865 2062 6163  ntiy for the bac
-00010070: 6b73 6c61 7368 2061 6e64 206e 6577 6c69  kslash and newli
-00010080: 6e65 732c 2063 6175 7365 640a 2020 2020  nes, caused.    
-00010090: 2020 2020 2020 2020 2320 6279 2074 6865          # by the
-000100a0: 2063 6c6f 7564 2043 4c49 206f 7574 7075   cloud CLI outpu
-000100b0: 742c 2065 2e67 2e20 6763 6c6f 7564 2e0a  t, e.g. gcloud..
-000100c0: 2020 2020 2020 2020 2020 2020 6f77 6e65              owne
-000100d0: 7220 3d20 6f77 6e65 722e 7265 706c 6163  r = owner.replac
-000100e0: 6528 275c 6e27 2c20 2727 292e 7265 706c  e('\n', '').repl
-000100f0: 6163 6528 275c 5c27 2c20 2727 290a 2020  ace('\\', '').  
-00010100: 2020 2020 2020 2020 2020 6966 206f 776e            if own
-00010110: 6572 203d 3d20 6375 7272 656e 743a 0a20  er == current:. 
-00010120: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00010130: 6620 6920 213d 2030 3a0a 2020 2020 2020  f i != 0:.      
-00010140: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00010150: 6767 6572 2e77 6172 6e69 6e67 280a 2020  gger.warning(.  
-00010160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010170: 2020 2020 2020 6627 5468 6520 636c 7573        f'The clus
-00010180: 7465 7220 7761 7320 6f77 6e65 6420 6279  ter was owned by
-00010190: 207b 6f77 6e65 725f 6964 656e 7469 7479   {owner_identity
-000101a0: 7d2c 2062 7574 2027 0a20 2020 2020 2020  }, but '.       
+0000dad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dae0: 2063 6865 636b 3d46 616c 7365 290a 2020   check=False).  
+0000daf0: 2020 2020 2020 6973 5f66 756e 6374 696f        is_functio
+0000db00: 6e61 6c20 3d20 6578 6563 7574 696f 6e5f  nal = execution_
+0000db10: 6368 6563 6b2e 7265 7475 726e 636f 6465  check.returncode
+0000db20: 203d 3d20 300a 2020 2020 7265 7475 726e   == 0.    return
+0000db30: 2069 735f 6675 6e63 7469 6f6e 616c 0a0a   is_functional..
+0000db40: 0a64 6566 2067 656e 6572 6174 655f 636c  .def generate_cl
+0000db50: 7573 7465 725f 6e61 6d65 2829 3a0a 2020  uster_name():.  
+0000db60: 2020 2320 544f 444f 3a20 6368 616e 6765    # TODO: change
+0000db70: 2074 6869 7320 4944 2066 6f72 6d61 7474   this ID formatt
+0000db80: 696e 6720 746f 2073 6f6d 6574 6869 6e67  ing to something
+0000db90: 206d 6f72 6520 706c 6561 7361 6e74 2e0a   more pleasant..
+0000dba0: 2020 2020 2320 5573 6572 206e 616d 6520      # User name 
+0000dbb0: 6973 2068 656c 7066 756c 2069 6e20 6e6f  is helpful in no
+0000dbc0: 6e2d 6973 6f6c 6174 6564 2061 6363 6f75  n-isolated accou
+0000dbd0: 6e74 732c 2065 2e67 2e2c 2047 4350 2c20  nts, e.g., GCP, 
+0000dbe0: 417a 7572 652e 0a20 2020 2072 6574 7572  Azure..    retur
+0000dbf0: 6e20 6627 736b 792d 7b75 7569 642e 7575  n f'sky-{uuid.uu
+0000dc00: 6964 3428 292e 6865 785b 3a34 5d7d 2d7b  id4().hex[:4]}-{
+0000dc10: 636f 6d6d 6f6e 5f75 7469 6c73 2e67 6574  common_utils.get
+0000dc20: 5f63 6c65 616e 6564 5f75 7365 726e 616d  _cleaned_usernam
+0000dc30: 6528 297d 270a 0a0a 6465 6620 5f71 7565  e()}'...def _que
+0000dc40: 7279 5f68 6561 645f 6970 5f77 6974 685f  ry_head_ip_with_
+0000dc50: 7265 7472 6965 7328 636c 7573 7465 725f  retries(cluster_
+0000dc60: 7961 6d6c 3a20 7374 722c 0a20 2020 2020  yaml: str,.     
+0000dc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dc80: 2020 2020 2020 2020 2020 206d 6178 5f61             max_a
+0000dc90: 7474 656d 7074 733a 2069 6e74 203d 2031  ttempts: int = 1
+0000dca0: 2920 2d3e 2073 7472 3a0a 2020 2020 2222  ) -> str:.    ""
+0000dcb0: 2252 6574 7572 6e73 2074 6865 2049 5020  "Returns the IP 
+0000dcc0: 6f66 2074 6865 2068 6561 6420 6e6f 6465  of the head node
+0000dcd0: 2062 7920 7175 6572 7969 6e67 2074 6865   by querying the
+0000dce0: 2063 6c6f 7564 2e0a 0a20 2020 2052 6169   cloud...    Rai
+0000dcf0: 7365 733a 0a20 2020 2020 2065 7863 6570  ses:.      excep
+0000dd00: 7469 6f6e 732e 4665 7463 6849 5045 7272  tions.FetchIPErr
+0000dd10: 6f72 3a20 6966 2077 6520 6661 696c 6564  or: if we failed
+0000dd20: 2074 6f20 6765 7420 7468 6520 6865 6164   to get the head
+0000dd30: 2049 502e 0a20 2020 2022 2222 0a20 2020   IP..    """.   
+0000dd40: 2062 6163 6b6f 6666 203d 2063 6f6d 6d6f   backoff = commo
+0000dd50: 6e5f 7574 696c 732e 4261 636b 6f66 6628  n_utils.Backoff(
+0000dd60: 696e 6974 6961 6c5f 6261 636b 6f66 663d  initial_backoff=
+0000dd70: 352c 206d 6178 5f62 6163 6b6f 6666 5f66  5, max_backoff_f
+0000dd80: 6163 746f 723d 3529 0a20 2020 2066 6f72  actor=5).    for
+0000dd90: 2069 2069 6e20 7261 6e67 6528 6d61 785f   i in range(max_
+0000dda0: 6174 7465 6d70 7473 293a 0a20 2020 2020  attempts):.     
+0000ddb0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0000ddc0: 2020 2020 6675 6c6c 5f63 6c75 7374 6572      full_cluster
+0000ddd0: 5f79 616d 6c20 3d20 7374 7228 7061 7468  _yaml = str(path
+0000dde0: 6c69 622e 5061 7468 2863 6c75 7374 6572  lib.Path(cluster
+0000ddf0: 5f79 616d 6c29 2e65 7870 616e 6475 7365  _yaml).expanduse
+0000de00: 7228 2929 0a20 2020 2020 2020 2020 2020  r()).           
+0000de10: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
+0000de20: 735f 7574 696c 732e 7275 6e28 0a20 2020  s_utils.run(.   
+0000de30: 2020 2020 2020 2020 2020 2020 2066 2772               f'r
+0000de40: 6179 2067 6574 2d68 6561 642d 6970 207b  ay get-head-ip {
+0000de50: 6675 6c6c 5f63 6c75 7374 6572 5f79 616d  full_cluster_yam
+0000de60: 6c21 727d 272c 0a20 2020 2020 2020 2020  l!r}',.         
+0000de70: 2020 2020 2020 2073 7464 6f75 743d 7375         stdout=su
+0000de80: 6270 726f 6365 7373 2e50 4950 452c 0a20  bprocess.PIPE,. 
+0000de90: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000dea0: 7464 6572 723d 7375 6270 726f 6365 7373  tderr=subprocess
+0000deb0: 2e44 4556 4e55 4c4c 292e 7374 646f 7574  .DEVNULL).stdout
+0000dec0: 2e64 6563 6f64 6528 292e 7374 7269 7028  .decode().strip(
+0000ded0: 290a 2020 2020 2020 2020 2020 2020 6865  ).            he
+0000dee0: 6164 5f69 705f 6c69 7374 203d 2072 652e  ad_ip_list = re.
+0000def0: 6669 6e64 616c 6c28 4950 5f41 4444 525f  findall(IP_ADDR_
+0000df00: 5245 4745 582c 206f 7574 290a 2020 2020  REGEX, out).    
+0000df10: 2020 2020 2020 2020 6966 206c 656e 2868          if len(h
+0000df20: 6561 645f 6970 5f6c 6973 7429 203e 2031  ead_ip_list) > 1
+0000df30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000df40: 2020 2320 5468 6973 2063 6f75 6c64 2062    # This could b
+0000df50: 6520 7472 6967 6765 7265 6420 6966 2065  e triggered if e
+0000df60: 2e67 2e2c 2073 6f6d 6520 6c6f 6767 696e  .g., some loggin
+0000df70: 6720 6973 2061 6464 6564 2069 6e0a 2020  g is added in.  
+0000df80: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000df90: 736b 7970 696c 6f74 5f63 6f6e 6669 672c  skypilot_config,
+0000dfa0: 2061 206d 6f64 756c 6520 7468 6174 2068   a module that h
+0000dfb0: 6173 2073 6f6d 6520 636f 6465 2065 7865  as some code exe
+0000dfc0: 6375 7465 640a 2020 2020 2020 2020 2020  cuted.          
+0000dfd0: 2020 2020 2020 2320 7768 656e 6576 6572        # whenever
+0000dfe0: 2060 736b 7960 2069 7320 696d 706f 7274   `sky` is import
+0000dff0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+0000e000: 2020 2020 6c6f 6767 6572 2e77 6172 6e69      logger.warni
+0000e010: 6e67 280a 2020 2020 2020 2020 2020 2020  ng(.            
+0000e020: 2020 2020 2020 2020 2744 6574 6563 7465          'Detecte
+0000e030: 6420 6d6f 7265 2074 6861 6e20 3120 4950  d more than 1 IP
+0000e040: 2066 726f 6d20 7468 6520 6f75 7470 7574   from the output
+0000e050: 206f 6620 270a 2020 2020 2020 2020 2020   of '.          
+0000e060: 2020 2020 2020 2020 2020 2774 6865 2060            'the `
+0000e070: 7261 7920 6765 742d 6865 6164 2d69 7060  ray get-head-ip`
+0000e080: 2063 6f6d 6d61 6e64 2e20 5468 6973 2063   command. This c
+0000e090: 6f75 6c64 2027 0a20 2020 2020 2020 2020  ould '.         
+0000e0a0: 2020 2020 2020 2020 2020 2027 6861 7070             'happ
+0000e0b0: 656e 2069 6620 7468 6572 6520 6973 2065  en if there is e
+0000e0c0: 7874 7261 206f 7574 7075 7420 6672 6f6d  xtra output from
+0000e0d0: 2069 742c 2027 0a20 2020 2020 2020 2020   it, '.         
+0000e0e0: 2020 2020 2020 2020 2020 2027 7768 6963             'whic
+0000e0f0: 6820 7368 6f75 6c64 2062 6520 696e 7370  h should be insp
+0000e100: 6563 7465 6420 6265 6c6f 772e 5c6e 5072  ected below.\nPr
+0000e110: 6f63 6565 6469 6e67 2077 6974 6820 270a  oceeding with '.
+0000e120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e130: 2020 2020 6627 7468 6520 6c61 7374 2064      f'the last d
+0000e140: 6574 6563 7465 6420 4950 2028 7b68 6561  etected IP ({hea
+0000e150: 645f 6970 5f6c 6973 745b 2d31 5d7d 2920  d_ip_list[-1]}) 
+0000e160: 6173 2068 6561 6420 4950 2e27 0a20 2020  as head IP.'.   
+0000e170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e180: 2066 275c 6e3d 3d20 4f75 7470 7574 203d   f'\n== Output =
+0000e190: 3d5c 6e7b 6f75 747d 270a 2020 2020 2020  =\n{out}'.      
+0000e1a0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0000e1b0: 5c6e 3d3d 204f 7574 7075 7420 656e 6473  \n== Output ends
+0000e1c0: 203d 3d27 290a 2020 2020 2020 2020 2020   ==').          
+0000e1d0: 2020 2020 2020 6865 6164 5f69 705f 6c69        head_ip_li
+0000e1e0: 7374 203d 2068 6561 645f 6970 5f6c 6973  st = head_ip_lis
+0000e1f0: 745b 2d31 3a5d 0a20 2020 2020 2020 2020  t[-1:].         
+0000e200: 2020 2061 7373 6572 7420 3120 3d3d 206c     assert 1 == l
+0000e210: 656e 2868 6561 645f 6970 5f6c 6973 7429  en(head_ip_list)
+0000e220: 2c20 286f 7574 2c20 6865 6164 5f69 705f  , (out, head_ip_
+0000e230: 6c69 7374 290a 2020 2020 2020 2020 2020  list).          
+0000e240: 2020 6865 6164 5f69 7020 3d20 6865 6164    head_ip = head
+0000e250: 5f69 705f 6c69 7374 5b30 5d0a 2020 2020  _ip_list[0].    
+0000e260: 2020 2020 2020 2020 6272 6561 6b0a 2020          break.  
+0000e270: 2020 2020 2020 6578 6365 7074 2073 7562        except sub
+0000e280: 7072 6f63 6573 732e 4361 6c6c 6564 5072  process.CalledPr
+0000e290: 6f63 6573 7345 7272 6f72 2061 7320 653a  ocessError as e:
+0000e2a0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000e2b0: 6920 3d3d 206d 6178 5f61 7474 656d 7074  i == max_attempt
+0000e2c0: 7320 2d20 313a 0a20 2020 2020 2020 2020  s - 1:.         
+0000e2d0: 2020 2020 2020 2072 6169 7365 2065 7863         raise exc
+0000e2e0: 6570 7469 6f6e 732e 4665 7463 6849 5045  eptions.FetchIPE
+0000e2f0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+0000e300: 2020 2020 2020 2020 2020 7265 6173 6f6e            reason
+0000e310: 3d65 7863 6570 7469 6f6e 732e 4665 7463  =exceptions.Fetc
+0000e320: 6849 5045 7272 6f72 2e52 6561 736f 6e2e  hIPError.Reason.
+0000e330: 4845 4144 2920 6672 6f6d 2065 0a20 2020  HEAD) from e.   
+0000e340: 2020 2020 2020 2020 2023 2052 6574 7279           # Retry
+0000e350: 2069 6620 7468 6520 636c 7573 7465 7220   if the cluster 
+0000e360: 6973 206e 6f74 2075 7020 7965 742e 0a20  is not up yet.. 
+0000e370: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+0000e380: 722e 6465 6275 6728 2752 6574 7279 696e  r.debug('Retryin
+0000e390: 6720 746f 2067 6574 2068 6561 6420 6970  g to get head ip
+0000e3a0: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
+0000e3b0: 7469 6d65 2e73 6c65 6570 2862 6163 6b6f  time.sleep(backo
+0000e3c0: 6666 2e63 7572 7265 6e74 5f62 6163 6b6f  ff.current_backo
+0000e3d0: 6666 2829 290a 2020 2020 7265 7475 726e  ff()).    return
+0000e3e0: 2068 6561 645f 6970 0a0a 0a40 7469 6d65   head_ip...@time
+0000e3f0: 6c69 6e65 2e65 7665 6e74 0a64 6566 2067  line.event.def g
+0000e400: 6574 5f6e 6f64 655f 6970 7328 636c 7573  et_node_ips(clus
+0000e410: 7465 725f 7961 6d6c 3a20 7374 722c 0a20  ter_yaml: str,. 
+0000e420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e430: 6578 7065 6374 6564 5f6e 756d 5f6e 6f64  expected_num_nod
+0000e440: 6573 3a20 696e 742c 0a20 2020 2020 2020  es: int,.       
+0000e450: 2020 2020 2020 2020 2020 6865 6164 5f69            head_i
+0000e460: 705f 6d61 785f 6174 7465 6d70 7473 3a20  p_max_attempts: 
+0000e470: 696e 7420 3d20 312c 0a20 2020 2020 2020  int = 1,.       
+0000e480: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+0000e490: 5f69 705f 6d61 785f 6174 7465 6d70 7473  _ip_max_attempts
+0000e4a0: 3a20 696e 7420 3d20 312c 0a20 2020 2020  : int = 1,.     
+0000e4b0: 2020 2020 2020 2020 2020 2020 6765 745f              get_
+0000e4c0: 696e 7465 726e 616c 5f69 7073 3a20 626f  internal_ips: bo
+0000e4d0: 6f6c 203d 2046 616c 7365 2920 2d3e 204c  ol = False) -> L
+0000e4e0: 6973 745b 7374 725d 3a0a 2020 2020 2222  ist[str]:.    ""
+0000e4f0: 2252 6574 7572 6e73 2074 6865 2049 5073  "Returns the IPs
+0000e500: 206f 6620 616c 6c20 6e6f 6465 7320 696e   of all nodes in
+0000e510: 2074 6865 2063 6c75 7374 6572 2c20 7769   the cluster, wi
+0000e520: 7468 2068 6561 6420 6e6f 6465 2061 7420  th head node at 
+0000e530: 6672 6f6e 742e 0a0a 2020 2020 4172 6773  front...    Args
+0000e540: 3a0a 2020 2020 2020 2020 636c 7573 7465  :.        cluste
+0000e550: 725f 7961 6d6c 3a20 5061 7468 2074 6f20  r_yaml: Path to 
+0000e560: 7468 6520 636c 7573 7465 7220 7961 6d6c  the cluster yaml
+0000e570: 2e0a 2020 2020 2020 2020 6578 7065 6374  ..        expect
+0000e580: 6564 5f6e 756d 5f6e 6f64 6573 3a20 4578  ed_num_nodes: Ex
+0000e590: 7065 6374 6564 206e 756d 6265 7220 6f66  pected number of
+0000e5a0: 206e 6f64 6573 2069 6e20 7468 6520 636c   nodes in the cl
+0000e5b0: 7573 7465 722e 0a20 2020 2020 2020 2068  uster..        h
+0000e5c0: 6561 645f 6970 5f6d 6178 5f61 7474 656d  ead_ip_max_attem
+0000e5d0: 7074 733a 204d 6178 2061 7474 656d 7074  pts: Max attempt
+0000e5e0: 7320 746f 2067 6574 2068 6561 6420 6970  s to get head ip
+0000e5f0: 2e0a 2020 2020 2020 2020 776f 726b 6572  ..        worker
+0000e600: 5f69 705f 6d61 785f 6174 7465 6d70 7473  _ip_max_attempts
+0000e610: 3a20 4d61 7820 6174 7465 6d70 7473 2074  : Max attempts t
+0000e620: 6f20 6765 7420 776f 726b 6572 2069 7073  o get worker ips
+0000e630: 2e0a 2020 2020 2020 2020 6765 745f 696e  ..        get_in
+0000e640: 7465 726e 616c 5f69 7073 3a20 5768 6574  ternal_ips: Whet
+0000e650: 6865 7220 746f 2067 6574 2069 6e74 6572  her to get inter
+0000e660: 6e61 6c20 4950 732e 2057 6865 6e20 4661  nal IPs. When Fa
+0000e670: 6c73 652c 2069 7420 6973 2073 7469 6c6c  lse, it is still
+0000e680: 0a20 2020 2020 2020 2020 2020 2070 6f73  .            pos
+0000e690: 7369 626c 6520 746f 2067 6574 2069 6e74  sible to get int
+0000e6a0: 6572 6e61 6c20 4950 7320 6966 2074 6865  ernal IPs if the
+0000e6b0: 2063 6c75 7374 6572 2064 6f65 7320 6e6f   cluster does no
+0000e6c0: 7420 6861 7665 2065 7874 6572 6e61 6c0a  t have external.
+0000e6d0: 2020 2020 2020 2020 2020 2020 4950 732e              IPs.
+0000e6e0: 0a0a 2020 2020 5261 6973 6573 3a0a 2020  ..    Raises:.  
+0000e6f0: 2020 2020 2020 6578 6365 7074 696f 6e73        exceptions
+0000e700: 2e46 6574 6368 4950 4572 726f 723a 2069  .FetchIPError: i
+0000e710: 6620 7765 2066 6169 6c65 6420 746f 2067  f we failed to g
+0000e720: 6574 2074 6865 2049 5073 2e20 652e 7265  et the IPs. e.re
+0000e730: 6173 6f6e 2069 730a 2020 2020 2020 2020  ason is.        
+0000e740: 2020 2020 4845 4144 206f 7220 574f 524b      HEAD or WORK
+0000e750: 4552 2e0a 2020 2020 2222 220a 2020 2020  ER..    """.    
+0000e760: 7261 795f 636f 6e66 6967 203d 2063 6f6d  ray_config = com
+0000e770: 6d6f 6e5f 7574 696c 732e 7265 6164 5f79  mon_utils.read_y
+0000e780: 616d 6c28 636c 7573 7465 725f 7961 6d6c  aml(cluster_yaml
+0000e790: 290a 2020 2020 2320 5573 6520 7468 6520  ).    # Use the 
+0000e7a0: 6e65 7720 7072 6f76 6973 696f 6e65 7220  new provisioner 
+0000e7b0: 666f 7220 4157 532e 0a20 2020 2070 726f  for AWS..    pro
+0000e7c0: 7669 6465 725f 6e61 6d65 203d 2063 6c75  vider_name = clu
+0000e7d0: 7374 6572 5f79 616d 6c5f 7574 696c 732e  ster_yaml_utils.
+0000e7e0: 6765 745f 7072 6f76 6964 6572 5f6e 616d  get_provider_nam
+0000e7f0: 6528 7261 795f 636f 6e66 6967 290a 2020  e(ray_config).  
+0000e800: 2020 636c 6f75 6420 3d20 636c 6f75 645f    cloud = cloud_
+0000e810: 7265 6769 7374 7279 2e43 4c4f 5544 5f52  registry.CLOUD_R
+0000e820: 4547 4953 5452 592e 6672 6f6d 5f73 7472  EGISTRY.from_str
+0000e830: 2870 726f 7669 6465 725f 6e61 6d65 290a  (provider_name).
+0000e840: 2020 2020 6173 7365 7274 2063 6c6f 7564      assert cloud
+0000e850: 2069 7320 6e6f 7420 4e6f 6e65 2c20 7072   is not None, pr
+0000e860: 6f76 6964 6572 5f6e 616d 650a 0a20 2020  ovider_name..   
+0000e870: 2069 6620 636c 6f75 642e 5052 4f56 4953   if cloud.PROVIS
+0000e880: 494f 4e45 525f 5645 5253 494f 4e20 3e3d  IONER_VERSION >=
+0000e890: 2063 6c6f 7564 732e 5072 6f76 6973 696f   clouds.Provisio
+0000e8a0: 6e65 7256 6572 7369 6f6e 2e53 4b59 5049  nerVersion.SKYPI
+0000e8b0: 4c4f 543a 0a20 2020 2020 2020 2074 7279  LOT:.        try
+0000e8c0: 3a0a 2020 2020 2020 2020 2020 2020 6d65  :.            me
+0000e8d0: 7461 6461 7461 203d 2070 726f 7669 7369  tadata = provisi
+0000e8e0: 6f6e 5f6c 6962 2e67 6574 5f63 6c75 7374  on_lib.get_clust
+0000e8f0: 6572 5f69 6e66 6f28 0a20 2020 2020 2020  er_info(.       
+0000e900: 2020 2020 2020 2020 2070 726f 7669 6465           provide
+0000e910: 725f 6e61 6d65 2c20 7261 795f 636f 6e66  r_name, ray_conf
+0000e920: 6967 5b27 7072 6f76 6964 6572 275d 2e67  ig['provider'].g
+0000e930: 6574 2827 7265 6769 6f6e 2729 2c0a 2020  et('region'),.  
+0000e940: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0000e950: 795f 636f 6e66 6967 5b27 636c 7573 7465  y_config['cluste
+0000e960: 725f 6e61 6d65 275d 2c20 7261 795f 636f  r_name'], ray_co
+0000e970: 6e66 6967 5b27 7072 6f76 6964 6572 275d  nfig['provider']
+0000e980: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+0000e990: 2045 7863 6570 7469 6f6e 2061 7320 653a   Exception as e:
+0000e9a0: 2020 2320 7079 6c69 6e74 3a20 6469 7361    # pylint: disa
+0000e9b0: 626c 653d 6272 6f61 642d 6578 6365 7074  ble=broad-except
+0000e9c0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+0000e9d0: 6869 7320 636f 756c 6420 6861 7070 656e  his could happen
+0000e9e0: 2077 6865 6e20 7468 6520 564d 2069 7320   when the VM is 
+0000e9f0: 6e6f 7420 6675 6c6c 7920 6c61 756e 6368  not fully launch
+0000ea00: 6564 2c20 616e 6420 6120 7573 6572 0a20  ed, and a user. 
+0000ea10: 2020 2020 2020 2020 2020 2023 2069 7320             # is 
+0000ea20: 7472 7969 6e67 2074 6f20 7465 726d 696e  trying to termin
+0000ea30: 6174 6520 6974 2077 6974 6820 6073 6b79  ate it with `sky
+0000ea40: 2064 6f77 6e60 2e0a 2020 2020 2020 2020   down`..        
+0000ea50: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
+0000ea60: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000ea70: 2020 2746 6169 6c65 6420 746f 2067 6574    'Failed to get
+0000ea80: 2063 6c75 7374 6572 2069 6e66 6f20 666f   cluster info fo
+0000ea90: 7220 270a 2020 2020 2020 2020 2020 2020  r '.            
+0000eaa0: 2020 2020 6627 7b72 6179 5f63 6f6e 6669      f'{ray_confi
+0000eab0: 675b 2263 6c75 7374 6572 5f6e 616d 6522  g["cluster_name"
+0000eac0: 5d7d 2066 726f 6d20 7468 6520 6e65 7720  ]} from the new 
+0000ead0: 7072 6f76 6973 696f 6e65 7220 270a 2020  provisioner '.  
+0000eae0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0000eaf0: 7769 7468 207b 636f 6d6d 6f6e 5f75 7469  with {common_uti
+0000eb00: 6c73 2e66 6f72 6d61 745f 6578 6365 7074  ls.format_except
+0000eb10: 696f 6e28 6529 7d2e 2729 0a20 2020 2020  ion(e)}.').     
+0000eb20: 2020 2020 2020 2072 6169 7365 2065 7863         raise exc
+0000eb30: 6570 7469 6f6e 732e 4665 7463 6849 5045  eptions.FetchIPE
+0000eb40: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+0000eb50: 2020 2020 2020 6578 6365 7074 696f 6e73        exceptions
+0000eb60: 2e46 6574 6368 4950 4572 726f 722e 5265  .FetchIPError.Re
+0000eb70: 6173 6f6e 2e48 4541 4429 2066 726f 6d20  ason.HEAD) from 
+0000eb80: 650a 2020 2020 2020 2020 6966 206c 656e  e.        if len
+0000eb90: 286d 6574 6164 6174 612e 696e 7374 616e  (metadata.instan
+0000eba0: 6365 7329 203c 2065 7870 6563 7465 645f  ces) < expected_
+0000ebb0: 6e75 6d5f 6e6f 6465 733a 0a20 2020 2020  num_nodes:.     
+0000ebc0: 2020 2020 2020 2023 2053 696d 756c 6174         # Simulat
+0000ebd0: 6520 7468 6520 6578 6365 7074 696f 6e20  e the exception 
+0000ebe0: 7768 656e 2052 6179 2068 6561 6420 6e6f  when Ray head no
+0000ebf0: 6465 2069 7320 6e6f 7420 7570 2e0a 2020  de is not up..  
+0000ec00: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000ec10: 6578 6365 7074 696f 6e73 2e46 6574 6368  exceptions.Fetch
+0000ec20: 4950 4572 726f 7228 6578 6365 7074 696f  IPError(exceptio
+0000ec30: 6e73 2e46 6574 6368 4950 4572 726f 722e  ns.FetchIPError.
+0000ec40: 5265 6173 6f6e 2e48 4541 4429 0a20 2020  Reason.HEAD).   
+0000ec50: 2020 2020 2072 6574 7572 6e20 6d65 7461       return meta
+0000ec60: 6461 7461 2e67 6574 5f66 6561 7369 626c  data.get_feasibl
+0000ec70: 655f 6970 7328 6765 745f 696e 7465 726e  e_ips(get_intern
+0000ec80: 616c 5f69 7073 290a 0a20 2020 2069 6620  al_ips)..    if 
+0000ec90: 6765 745f 696e 7465 726e 616c 5f69 7073  get_internal_ips
+0000eca0: 3a0a 2020 2020 2020 2020 7769 7468 2074  :.        with t
+0000ecb0: 656d 7066 696c 652e 4e61 6d65 6454 656d  empfile.NamedTem
+0000ecc0: 706f 7261 7279 4669 6c65 286d 6f64 653d  poraryFile(mode=
+0000ecd0: 2777 272c 2064 656c 6574 653d 4661 6c73  'w', delete=Fals
+0000ece0: 6529 2061 7320 663a 0a20 2020 2020 2020  e) as f:.       
+0000ecf0: 2020 2020 2072 6179 5f63 6f6e 6669 675b       ray_config[
+0000ed00: 2770 726f 7669 6465 7227 5d5b 2775 7365  'provider']['use
+0000ed10: 5f69 6e74 6572 6e61 6c5f 6970 7327 5d20  _internal_ips'] 
+0000ed20: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
+0000ed30: 2020 2079 616d 6c2e 6475 6d70 2872 6179     yaml.dump(ray
+0000ed40: 5f63 6f6e 6669 672c 2066 290a 2020 2020  _config, f).    
+0000ed50: 2020 2020 2020 2020 636c 7573 7465 725f          cluster_
+0000ed60: 7961 6d6c 203d 2066 2e6e 616d 650a 0a20  yaml = f.name.. 
+0000ed70: 2020 2023 2043 6865 636b 2074 6865 206e     # Check the n
+0000ed80: 6574 776f 726b 2063 6f6e 6e65 6374 696f  etwork connectio
+0000ed90: 6e20 6669 7273 7420 746f 2061 766f 6964  n first to avoid
+0000eda0: 206c 6f6e 6720 6861 6e67 696e 6720 7469   long hanging ti
+0000edb0: 6d65 2066 6f72 0a20 2020 2023 2072 6179  me for.    # ray
+0000edc0: 2067 6574 2d68 6561 642d 6970 2062 656c   get-head-ip bel
+0000edd0: 6f77 2c20 6966 2061 206c 6f6e 672d 6c61  ow, if a long-la
+0000ede0: 7374 696e 6720 6e65 7477 6f72 6b20 636f  sting network co
+0000edf0: 6e6e 6563 7469 6f6e 2066 6169 6c75 7265  nnection failure
+0000ee00: 0a20 2020 2023 2068 6170 7065 6e73 2e0a  .    # happens..
+0000ee10: 2020 2020 6368 6563 6b5f 6e65 7477 6f72      check_networ
+0000ee20: 6b5f 636f 6e6e 6563 7469 6f6e 2829 0a20  k_connection(). 
+0000ee30: 2020 2068 6561 645f 6970 203d 205f 7175     head_ip = _qu
+0000ee40: 6572 795f 6865 6164 5f69 705f 7769 7468  ery_head_ip_with
+0000ee50: 5f72 6574 7269 6573 2863 6c75 7374 6572  _retries(cluster
+0000ee60: 5f79 616d 6c2c 0a20 2020 2020 2020 2020  _yaml,.         
+0000ee70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee90: 206d 6178 5f61 7474 656d 7074 733d 6865   max_attempts=he
+0000eea0: 6164 5f69 705f 6d61 785f 6174 7465 6d70  ad_ip_max_attemp
+0000eeb0: 7473 290a 2020 2020 6865 6164 5f69 705f  ts).    head_ip_
+0000eec0: 6c69 7374 203d 205b 6865 6164 5f69 705d  list = [head_ip]
+0000eed0: 0a20 2020 2069 6620 6578 7065 6374 6564  .    if expected
+0000eee0: 5f6e 756d 5f6e 6f64 6573 203e 2031 3a0a  _num_nodes > 1:.
+0000eef0: 2020 2020 2020 2020 6261 636b 6f66 6620          backoff 
+0000ef00: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e42  = common_utils.B
+0000ef10: 6163 6b6f 6666 2869 6e69 7469 616c 5f62  ackoff(initial_b
+0000ef20: 6163 6b6f 6666 3d35 2c20 6d61 785f 6261  ackoff=5, max_ba
+0000ef30: 636b 6f66 665f 6661 6374 6f72 3d35 290a  ckoff_factor=5).
+0000ef40: 0a20 2020 2020 2020 2066 6f72 2072 6574  .        for ret
+0000ef50: 7279 5f63 6e74 2069 6e20 7261 6e67 6528  ry_cnt in range(
+0000ef60: 776f 726b 6572 5f69 705f 6d61 785f 6174  worker_ip_max_at
+0000ef70: 7465 6d70 7473 293a 0a20 2020 2020 2020  tempts):.       
+0000ef80: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0000ef90: 2020 2020 2020 2020 2020 6675 6c6c 5f63            full_c
+0000efa0: 6c75 7374 6572 5f79 616d 6c20 3d20 7374  luster_yaml = st
+0000efb0: 7228 7061 7468 6c69 622e 5061 7468 2863  r(pathlib.Path(c
+0000efc0: 6c75 7374 6572 5f79 616d 6c29 2e65 7870  luster_yaml).exp
+0000efd0: 616e 6475 7365 7228 2929 0a20 2020 2020  anduser()).     
+0000efe0: 2020 2020 2020 2020 2020 2070 726f 6320             proc 
+0000eff0: 3d20 7375 6270 726f 6365 7373 5f75 7469  = subprocess_uti
+0000f000: 6c73 2e72 756e 280a 2020 2020 2020 2020  ls.run(.        
+0000f010: 2020 2020 2020 2020 2020 2020 6627 7261              f'ra
+0000f020: 7920 6765 742d 776f 726b 6572 2d69 7073  y get-worker-ips
+0000f030: 207b 6675 6c6c 5f63 6c75 7374 6572 5f79   {full_cluster_y
+0000f040: 616d 6c21 727d 272c 0a20 2020 2020 2020  aml!r}',.       
+0000f050: 2020 2020 2020 2020 2020 2020 2073 7464               std
+0000f060: 6f75 743d 7375 6270 726f 6365 7373 2e50  out=subprocess.P
+0000f070: 4950 452c 0a20 2020 2020 2020 2020 2020  IPE,.           
+0000f080: 2020 2020 2020 2020 2073 7464 6572 723d           stderr=
+0000f090: 7375 6270 726f 6365 7373 2e50 4950 4529  subprocess.PIPE)
+0000f0a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f0b0: 206f 7574 203d 2070 726f 632e 7374 646f   out = proc.stdo
+0000f0c0: 7574 2e64 6563 6f64 6528 290a 2020 2020  ut.decode().    
+0000f0d0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+0000f0e0: 6b0a 2020 2020 2020 2020 2020 2020 6578  k.            ex
+0000f0f0: 6365 7074 2073 7562 7072 6f63 6573 732e  cept subprocess.
+0000f100: 4361 6c6c 6564 5072 6f63 6573 7345 7272  CalledProcessErr
+0000f110: 6f72 2061 7320 653a 0a20 2020 2020 2020  or as e:.       
+0000f120: 2020 2020 2020 2020 2069 6620 7265 7472           if retr
+0000f130: 795f 636e 7420 3d3d 2077 6f72 6b65 725f  y_cnt == worker_
+0000f140: 6970 5f6d 6178 5f61 7474 656d 7074 7320  ip_max_attempts 
+0000f150: 2d20 313a 0a20 2020 2020 2020 2020 2020  - 1:.           
+0000f160: 2020 2020 2020 2020 2072 6169 7365 2065           raise e
+0000f170: 7863 6570 7469 6f6e 732e 4665 7463 6849  xceptions.FetchI
+0000f180: 5045 7272 6f72 280a 2020 2020 2020 2020  PError(.        
+0000f190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f1a0: 6578 6365 7074 696f 6e73 2e46 6574 6368  exceptions.Fetch
+0000f1b0: 4950 4572 726f 722e 5265 6173 6f6e 2e57  IPError.Reason.W
+0000f1c0: 4f52 4b45 5229 2066 726f 6d20 650a 2020  ORKER) from e.  
+0000f1d0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000f1e0: 5265 7472 7920 6966 2074 6865 2073 7368  Retry if the ssh
+0000f1f0: 2069 7320 6e6f 7420 7265 6164 7920 666f   is not ready fo
+0000f200: 7220 7468 6520 776f 726b 6572 7320 7965  r the workers ye
+0000f210: 742e 0a20 2020 2020 2020 2020 2020 2020  t..             
+0000f220: 2020 2062 6163 6b6f 6666 5f74 696d 6520     backoff_time 
+0000f230: 3d20 6261 636b 6f66 662e 6375 7272 656e  = backoff.curren
+0000f240: 745f 6261 636b 6f66 6628 290a 2020 2020  t_backoff().    
+0000f250: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0000f260: 6572 2e64 6562 7567 2827 5265 7472 7969  er.debug('Retryi
+0000f270: 6e67 2074 6f20 6765 7420 776f 726b 6572  ng to get worker
+0000f280: 2069 7020 270a 2020 2020 2020 2020 2020   ip '.          
+0000f290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f2a0: 2020 2066 275b 7b72 6574 7279 5f63 6e74     f'[{retry_cnt
+0000f2b0: 7d2f 7b77 6f72 6b65 725f 6970 5f6d 6178  }/{worker_ip_max
+0000f2c0: 5f61 7474 656d 7074 737d 5d20 696e 2027  _attempts}] in '
+0000f2d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f2e0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0000f2f0: 7b62 6163 6b6f 6666 5f74 696d 657d 2073  {backoff_time} s
+0000f300: 6563 6f6e 6473 2e27 290a 2020 2020 2020  econds.').      
+0000f310: 2020 2020 2020 2020 2020 7469 6d65 2e73            time.s
+0000f320: 6c65 6570 2862 6163 6b6f 6666 5f74 696d  leep(backoff_tim
+0000f330: 6529 0a20 2020 2020 2020 2077 6f72 6b65  e).        worke
+0000f340: 725f 6970 7320 3d20 7265 2e66 696e 6461  r_ips = re.finda
+0000f350: 6c6c 2849 505f 4144 4452 5f52 4547 4558  ll(IP_ADDR_REGEX
+0000f360: 2c20 6f75 7429 0a20 2020 2020 2020 2069  , out).        i
+0000f370: 6620 6c65 6e28 776f 726b 6572 5f69 7073  f len(worker_ips
+0000f380: 2920 213d 2065 7870 6563 7465 645f 6e75  ) != expected_nu
+0000f390: 6d5f 6e6f 6465 7320 2d20 313a 0a20 2020  m_nodes - 1:.   
+0000f3a0: 2020 2020 2020 2020 206e 203d 2065 7870           n = exp
+0000f3b0: 6563 7465 645f 6e75 6d5f 6e6f 6465 7320  ected_num_nodes 
+0000f3c0: 2d20 310a 2020 2020 2020 2020 2020 2020  - 1.            
+0000f3d0: 6966 206c 656e 2877 6f72 6b65 725f 6970  if len(worker_ip
+0000f3e0: 7329 203e 206e 3a0a 2020 2020 2020 2020  s) > n:.        
+0000f3f0: 2020 2020 2020 2020 2320 5468 6973 2063          # This c
+0000f400: 6f75 6c64 2062 6520 7472 6967 6765 7265  ould be triggere
+0000f410: 6420 6966 2065 2e67 2e2c 2073 6f6d 6520  d if e.g., some 
+0000f420: 6c6f 6767 696e 6720 6973 2061 6464 6564  logging is added
+0000f430: 2069 6e0a 2020 2020 2020 2020 2020 2020   in.            
+0000f440: 2020 2020 2320 736b 7970 696c 6f74 5f63      # skypilot_c
+0000f450: 6f6e 6669 672c 2061 206d 6f64 756c 6520  onfig, a module 
+0000f460: 7468 6174 2068 6173 2073 6f6d 6520 636f  that has some co
+0000f470: 6465 2065 7865 6375 7465 6420 7768 656e  de executed when
+0000f480: 6576 6572 0a20 2020 2020 2020 2020 2020  ever.           
+0000f490: 2020 2020 2023 2060 736b 7960 2069 7320       # `sky` is 
+0000f4a0: 696d 706f 7274 6564 2e0a 2020 2020 2020  imported..      
+0000f4b0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+0000f4c0: 2e77 6172 6e69 6e67 280a 2020 2020 2020  .warning(.      
+0000f4d0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0000f4e0: 4578 7065 6374 6564 207b 6e7d 2077 6f72  Expected {n} wor
+0000f4f0: 6b65 7220 4950 2873 293b 2066 6f75 6e64  ker IP(s); found
+0000f500: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0000f510: 2020 2020 2020 2066 277b 6c65 6e28 776f         f'{len(wo
+0000f520: 726b 6572 5f69 7073 297d 3a20 7b77 6f72  rker_ips)}: {wor
+0000f530: 6b65 725f 6970 737d 270a 2020 2020 2020  ker_ips}'.      
+0000f540: 2020 2020 2020 2020 2020 2020 2020 275c                '\
+0000f550: 6e54 6869 7320 636f 756c 6420 6861 7070  nThis could happ
+0000f560: 656e 2069 6620 7468 6572 6520 6973 2065  en if there is e
+0000f570: 7874 7261 206f 7574 7075 7420 6672 6f6d  xtra output from
+0000f580: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0000f590: 2020 2020 2020 2027 6072 6179 2067 6574         '`ray get
+0000f5a0: 2d77 6f72 6b65 722d 6970 7360 2c20 7768  -worker-ips`, wh
+0000f5b0: 6963 6820 7368 6f75 6c64 2062 6520 696e  ich should be in
+0000f5c0: 7370 6563 7465 6420 6265 6c6f 772e 270a  spected below.'.
+0000f5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f5e0: 2020 2020 6627 5c6e 3d3d 204f 7574 7075      f'\n== Outpu
+0000f5f0: 7420 3d3d 5c6e 7b6f 7574 7d27 0a20 2020  t ==\n{out}'.   
+0000f600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f610: 2066 275c 6e3d 3d20 4f75 7470 7574 2065   f'\n== Output e
+0000f620: 6e64 7320 3d3d 2729 0a20 2020 2020 2020  nds ==').       
+0000f630: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+0000f640: 7761 726e 696e 6728 6627 5c6e 5072 6f63  warning(f'\nProc
+0000f650: 6565 6469 6e67 2077 6974 6820 7468 6520  eeding with the 
+0000f660: 6c61 7374 207b 6e7d 2027 0a20 2020 2020  last {n} '.     
+0000f670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f680: 2020 2020 2020 2020 2020 6627 6465 7465            f'dete
+0000f690: 6374 6564 2049 5028 7329 3a20 7b77 6f72  cted IP(s): {wor
+0000f6a0: 6b65 725f 6970 735b 2d6e 3a5d 7d2e 2729  ker_ips[-n:]}.')
+0000f6b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f6c0: 2077 6f72 6b65 725f 6970 7320 3d20 776f   worker_ips = wo
+0000f6d0: 726b 6572 5f69 7073 5b2d 6e3a 5d0a 2020  rker_ips[-n:].  
+0000f6e0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0000f6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f700: 7261 6973 6520 6578 6365 7074 696f 6e73  raise exceptions
+0000f710: 2e46 6574 6368 4950 4572 726f 7228 0a20  .FetchIPError(. 
+0000f720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f730: 2020 2065 7863 6570 7469 6f6e 732e 4665     exceptions.Fe
+0000f740: 7463 6849 5045 7272 6f72 2e52 6561 736f  tchIPError.Reaso
+0000f750: 6e2e 574f 524b 4552 290a 2020 2020 656c  n.WORKER).    el
+0000f760: 7365 3a0a 2020 2020 2020 2020 776f 726b  se:.        work
+0000f770: 6572 5f69 7073 203d 205b 5d0a 2020 2020  er_ips = [].    
+0000f780: 7265 7475 726e 2068 6561 645f 6970 5f6c  return head_ip_l
+0000f790: 6973 7420 2b20 776f 726b 6572 5f69 7073  ist + worker_ips
+0000f7a0: 0a0a 0a64 6566 2063 6865 636b 5f6e 6574  ...def check_net
+0000f7b0: 776f 726b 5f63 6f6e 6e65 6374 696f 6e28  work_connection(
+0000f7c0: 293a 0a20 2020 2023 2054 6f6c 6572 6174  ):.    # Tolerat
+0000f7d0: 6520 3320 7265 7472 6965 7320 6173 2069  e 3 retries as i
+0000f7e0: 7420 6973 206f 6273 6572 7665 6420 7468  t is observed th
+0000f7f0: 6174 2063 6f6e 6e65 6374 696f 6e73 2063  at connections c
+0000f800: 616e 2066 6169 6c2e 0a20 2020 2061 6461  an fail..    ada
+0000f810: 7074 6572 203d 2061 6461 7074 6572 732e  pter = adapters.
+0000f820: 4854 5450 4164 6170 7465 7228 6d61 785f  HTTPAdapter(max_
+0000f830: 7265 7472 6965 733d 7265 7472 795f 6c69  retries=retry_li
+0000f840: 622e 5265 7472 7928 746f 7461 6c3d 3329  b.Retry(total=3)
+0000f850: 290a 2020 2020 6874 7470 203d 2072 6571  ).    http = req
+0000f860: 7565 7374 732e 5365 7373 696f 6e28 290a  uests.Session().
+0000f870: 2020 2020 6874 7470 2e6d 6f75 6e74 2827      http.mount('
+0000f880: 6874 7470 733a 2f2f 272c 2061 6461 7074  https://', adapt
+0000f890: 6572 290a 2020 2020 6874 7470 2e6d 6f75  er).    http.mou
+0000f8a0: 6e74 2827 6874 7470 3a2f 2f27 2c20 6164  nt('http://', ad
+0000f8b0: 6170 7465 7229 0a20 2020 2066 6f72 2069  apter).    for i
+0000f8c0: 2c20 6970 2069 6e20 656e 756d 6572 6174  , ip in enumerat
+0000f8d0: 6528 5f54 4553 545f 4950 5f4c 4953 5429  e(_TEST_IP_LIST)
+0000f8e0: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
+0000f8f0: 2020 2020 2020 2020 2020 2068 7474 702e             http.
+0000f900: 6865 6164 2869 702c 2074 696d 656f 7574  head(ip, timeout
+0000f910: 3d33 290a 2020 2020 2020 2020 2020 2020  =3).            
+0000f920: 7265 7475 726e 0a20 2020 2020 2020 2065  return.        e
+0000f930: 7863 6570 7420 2872 6571 7565 7374 732e  xcept (requests.
+0000f940: 5469 6d65 6f75 742c 2072 6571 7565 7374  Timeout, request
+0000f950: 732e 6578 6365 7074 696f 6e73 2e43 6f6e  s.exceptions.Con
+0000f960: 6e65 6374 696f 6e45 7272 6f72 2920 6173  nectionError) as
+0000f970: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+0000f980: 6966 2069 203d 3d20 6c65 6e28 5f54 4553  if i == len(_TES
+0000f990: 545f 4950 5f4c 4953 5429 202d 2031 3a0a  T_IP_LIST) - 1:.
+0000f9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f9b0: 7261 6973 6520 6578 6365 7074 696f 6e73  raise exceptions
+0000f9c0: 2e4e 6574 776f 726b 4572 726f 7228 2743  .NetworkError('C
+0000f9d0: 6f75 6c64 206e 6f74 2072 6566 7265 7368  ould not refresh
+0000f9e0: 2074 6865 2063 6c75 7374 6572 2e20 270a   the cluster. '.
+0000f9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fa10: 2020 2020 2020 2020 2020 2020 2020 274e                'N
+0000fa20: 6574 776f 726b 2073 6565 6d73 2064 6f77  etwork seems dow
+0000fa30: 6e2e 2729 2066 726f 6d20 650a 0a0a 6465  n.') from e...de
+0000fa40: 6620 6368 6563 6b5f 6f77 6e65 725f 6964  f check_owner_id
+0000fa50: 656e 7469 7479 2863 6c75 7374 6572 5f6e  entity(cluster_n
+0000fa60: 616d 653a 2073 7472 2920 2d3e 204e 6f6e  ame: str) -> Non
+0000fa70: 653a 0a20 2020 2022 2222 4368 6563 6b20  e:.    """Check 
+0000fa80: 6966 2063 7572 7265 6e74 2075 7365 7220  if current user 
+0000fa90: 6973 2074 6865 2073 616d 6520 6173 2074  is the same as t
+0000faa0: 6865 2075 7365 7220 7768 6f20 6372 6561  he user who crea
+0000fab0: 7465 6420 7468 6520 636c 7573 7465 722e  ted the cluster.
+0000fac0: 0a0a 2020 2020 5261 6973 6573 3a0a 2020  ..    Raises:.  
+0000fad0: 2020 2020 2020 6578 6365 7074 696f 6e73        exceptions
+0000fae0: 2e43 6c75 7374 6572 4f77 6e65 7249 6465  .ClusterOwnerIde
+0000faf0: 6e74 6974 794d 6973 6d61 7463 6845 7272  ntityMismatchErr
+0000fb00: 6f72 3a20 6966 2074 6865 2063 7572 7265  or: if the curre
+0000fb10: 6e74 2075 7365 7220 6973 0a20 2020 2020  nt user is.     
+0000fb20: 2020 2020 206e 6f74 2074 6865 2073 616d       not the sam
+0000fb30: 6520 6173 2074 6865 2075 7365 7220 7768  e as the user wh
+0000fb40: 6f20 6372 6561 7465 6420 7468 6520 636c  o created the cl
+0000fb50: 7573 7465 722e 0a20 2020 2020 2020 2065  uster..        e
+0000fb60: 7863 6570 7469 6f6e 732e 436c 6f75 6455  xceptions.CloudU
+0000fb70: 7365 7249 6465 6e74 6974 7945 7272 6f72  serIdentityError
+0000fb80: 3a20 6966 2077 6520 6661 696c 2074 6f20  : if we fail to 
+0000fb90: 6765 7420 7468 6520 6375 7272 656e 7420  get the current 
+0000fba0: 7573 6572 0a20 2020 2020 2020 2020 2069  user.          i
+0000fbb0: 6465 6e74 6974 792e 0a20 2020 2022 2222  dentity..    """
+0000fbc0: 0a20 2020 2069 6620 656e 765f 6f70 7469  .    if env_opti
+0000fbd0: 6f6e 732e 4f70 7469 6f6e 732e 534b 4950  ons.Options.SKIP
+0000fbe0: 5f43 4c4f 5544 5f49 4445 4e54 4954 595f  _CLOUD_IDENTITY_
+0000fbf0: 4348 4543 4b2e 6765 7428 293a 0a20 2020  CHECK.get():.   
+0000fc00: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+0000fc10: 7265 636f 7264 203d 2067 6c6f 6261 6c5f  record = global_
+0000fc20: 7573 6572 5f73 7461 7465 2e67 6574 5f63  user_state.get_c
+0000fc30: 6c75 7374 6572 5f66 726f 6d5f 6e61 6d65  luster_from_name
+0000fc40: 2863 6c75 7374 6572 5f6e 616d 6529 0a20  (cluster_name). 
+0000fc50: 2020 2069 6620 7265 636f 7264 2069 7320     if record is 
+0000fc60: 4e6f 6e65 3a0a 2020 2020 2020 2020 7265  None:.        re
+0000fc70: 7475 726e 0a20 2020 2068 616e 646c 6520  turn.    handle 
+0000fc80: 3d20 7265 636f 7264 5b27 6861 6e64 6c65  = record['handle
+0000fc90: 275d 0a20 2020 2069 6620 6e6f 7420 6973  '].    if not is
+0000fca0: 696e 7374 616e 6365 2868 616e 646c 652c  instance(handle,
+0000fcb0: 2062 6163 6b65 6e64 732e 436c 6f75 6456   backends.CloudV
+0000fcc0: 6d52 6179 5265 736f 7572 6365 4861 6e64  mRayResourceHand
+0000fcd0: 6c65 293a 0a20 2020 2020 2020 2072 6574  le):.        ret
+0000fce0: 7572 6e0a 0a20 2020 2063 6c6f 7564 203d  urn..    cloud =
+0000fcf0: 2068 616e 646c 652e 6c61 756e 6368 6564   handle.launched
+0000fd00: 5f72 6573 6f75 7263 6573 2e63 6c6f 7564  _resources.cloud
+0000fd10: 0a20 2020 2063 7572 7265 6e74 5f75 7365  .    current_use
+0000fd20: 725f 6964 656e 7469 7479 203d 2063 6c6f  r_identity = clo
+0000fd30: 7564 2e67 6574 5f63 7572 7265 6e74 5f75  ud.get_current_u
+0000fd40: 7365 725f 6964 656e 7469 7479 2829 0a20  ser_identity(). 
+0000fd50: 2020 206f 776e 6572 5f69 6465 6e74 6974     owner_identit
+0000fd60: 7920 3d20 7265 636f 7264 5b27 6f77 6e65  y = record['owne
+0000fd70: 7227 5d0a 2020 2020 6966 2063 7572 7265  r'].    if curre
+0000fd80: 6e74 5f75 7365 725f 6964 656e 7469 7479  nt_user_identity
+0000fd90: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0000fda0: 2020 2320 536b 6970 2074 6865 2063 6865    # Skip the che
+0000fdb0: 636b 2069 6620 7468 6520 636c 6f75 6420  ck if the cloud 
+0000fdc0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+0000fdd0: 2075 7365 7220 6964 656e 7469 7479 2e0a   user identity..
+0000fde0: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
+0000fdf0: 2020 2023 2054 6865 2075 7365 7220 6964     # The user id
+0000fe00: 656e 7469 7479 2063 616e 2062 6520 4e6f  entity can be No
+0000fe10: 6e65 2c20 6966 2074 6865 2063 6c75 7374  ne, if the clust
+0000fe20: 6572 2069 7320 6372 6561 7465 6420 6279  er is created by
+0000fe30: 2061 6e20 6f6c 6465 720a 2020 2020 2320   an older.    # 
+0000fe40: 7665 7273 696f 6e20 6f66 2053 6b79 5069  version of SkyPi
+0000fe50: 6c6f 742e 2049 6e20 7468 6174 2063 6173  lot. In that cas
+0000fe60: 652c 2077 6520 7365 7420 7468 6520 7573  e, we set the us
+0000fe70: 6572 2069 6465 6e74 6974 7920 746f 2074  er identity to t
+0000fe80: 6865 0a20 2020 2023 2063 7572 7265 6e74  he.    # current
+0000fe90: 206f 6e65 2e0a 2020 2020 2320 4e4f 5445   one..    # NOTE
+0000fea0: 3a20 6120 7573 6572 2077 686f 2075 7067  : a user who upg
+0000feb0: 7261 6465 7320 536b 7950 696c 6f74 2061  rades SkyPilot a
+0000fec0: 6e64 2073 7769 7463 6865 7320 746f 2061  nd switches to a
+0000fed0: 206e 6577 2063 6c6f 7564 2069 6465 6e74   new cloud ident
+0000fee0: 6974 790a 2020 2020 2320 696d 6d65 6469  ity.    # immedi
+0000fef0: 6174 656c 7920 7769 7468 6f75 7420 6073  ately without `s
+0000ff00: 6b79 2073 7461 7475 7320 2d2d 7265 6672  ky status --refr
+0000ff10: 6573 6860 2066 6972 7374 2c20 7769 6c6c  esh` first, will
+0000ff20: 2063 6175 7365 2061 206c 6561 6b61 6765   cause a leakage
+0000ff30: 0a20 2020 2023 206f 6620 7468 6520 6578  .    # of the ex
+0000ff40: 6973 7469 6e67 2063 6c75 7374 6572 2e20  isting cluster. 
+0000ff50: 5765 2064 6565 6d20 7468 6973 2061 6e20  We deem this an 
+0000ff60: 6163 6365 7074 6162 6c65 2074 7261 6465  acceptable trade
+0000ff70: 6f66 6620 6d61 696e 6c79 0a20 2020 2023  off mainly.    #
+0000ff80: 2062 6563 6175 7365 206d 756c 7469 2d69   because multi-i
+0000ff90: 6465 6e74 6974 7920 6973 206e 6f74 2063  dentity is not c
+0000ffa0: 6f6d 6d6f 6e20 2861 7420 6c65 6173 7420  ommon (at least 
+0000ffb0: 6174 2074 6865 206d 6f6d 656e 7429 2e0a  at the moment)..
+0000ffc0: 2020 2020 6966 206f 776e 6572 5f69 6465      if owner_ide
+0000ffd0: 6e74 6974 7920 6973 204e 6f6e 653a 0a20  ntity is None:. 
+0000ffe0: 2020 2020 2020 2067 6c6f 6261 6c5f 7573         global_us
+0000fff0: 6572 5f73 7461 7465 2e73 6574 5f6f 776e  er_state.set_own
+00010000: 6572 5f69 6465 6e74 6974 795f 666f 725f  er_identity_for_
+00010010: 636c 7573 7465 7228 0a20 2020 2020 2020  cluster(.       
+00010020: 2020 2020 2063 6c75 7374 6572 5f6e 616d       cluster_nam
+00010030: 652c 2063 7572 7265 6e74 5f75 7365 725f  e, current_user_
+00010040: 6964 656e 7469 7479 290a 2020 2020 656c  identity).    el
+00010050: 7365 3a0a 2020 2020 2020 2020 6173 7365  se:.        asse
+00010060: 7274 2069 7369 6e73 7461 6e63 6528 6f77  rt isinstance(ow
+00010070: 6e65 725f 6964 656e 7469 7479 2c20 6c69  ner_identity, li
+00010080: 7374 290a 2020 2020 2020 2020 2320 4974  st).        # It
+00010090: 2069 7320 4f4b 2069 6620 7468 6520 6f77   is OK if the ow
+000100a0: 6e65 7220 6964 656e 7469 7479 2069 7320  ner identity is 
+000100b0: 7368 6f72 7465 722c 2077 6869 6368 2077  shorter, which w
+000100c0: 696c 6c20 6861 7070 656e 2077 6865 6e0a  ill happen when.
+000100d0: 2020 2020 2020 2020 2320 7468 6520 636c          # the cl
+000100e0: 7573 7465 7220 6973 206c 6175 6e63 6865  uster is launche
+000100f0: 6420 6265 666f 7265 2023 3138 3038 2e20  d before #1808. 
+00010100: 496e 2074 6861 7420 6361 7365 2c20 7765  In that case, we
+00010110: 206f 6e6c 7920 6368 6563 6b0a 2020 2020   only check.    
+00010120: 2020 2020 2320 7468 6520 7361 6d65 206c      # the same l
+00010130: 656e 6774 6820 287a 6970 2077 696c 6c20  ength (zip will 
+00010140: 7374 6f70 2061 7420 7468 6520 7368 6f72  stop at the shor
+00010150: 7465 7220 6f6e 6529 2e0a 2020 2020 2020  ter one)..      
+00010160: 2020 666f 7220 692c 2028 6f77 6e65 722c    for i, (owner,
+00010170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010180: 2063 7572 7265 6e74 2920 696e 2065 6e75   current) in enu
+00010190: 6d65 7261 7465 287a 6970 286f 776e 6572  merate(zip(owner
+000101a0: 5f69 6465 6e74 6974 792c 0a20 2020 2020  _identity,.     
 000101b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000101c0: 2066 2761 206e 6577 2069 6465 6e74 6974   f'a new identit
-000101d0: 7920 7b63 7572 7265 6e74 5f75 7365 725f  y {current_user_
-000101e0: 6964 656e 7469 7479 7d20 6973 2061 6374  identity} is act
-000101f0: 6976 6174 6564 2e20 5765 2073 7469 6c6c  ivated. We still
-00010200: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00010210: 2020 2020 2020 2020 2020 2027 616c 6c6f             'allo
-00010220: 7720 7468 6520 6f70 6572 6174 696f 6e20  w the operation 
-00010230: 6173 2074 6865 2074 776f 2069 6465 6e74  as the two ident
-00010240: 6974 6965 7320 6172 6520 6c69 6b65 6c79  ities are likely
-00010250: 2074 6f20 6861 7665 2027 0a20 2020 2020   to have '.     
-00010260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010270: 2020 2027 7468 6520 7361 6d65 2061 6363     'the same acc
-00010280: 6573 7320 746f 2074 6865 2063 6c75 7374  ess to the clust
-00010290: 6572 2e20 506c 6561 7365 2062 6520 6177  er. Please be aw
-000102a0: 6172 6520 7468 6174 2074 6869 7320 6361  are that this ca
-000102b0: 6e20 270a 2020 2020 2020 2020 2020 2020  n '.            
-000102c0: 2020 2020 2020 2020 2020 2020 2763 6175              'cau
-000102d0: 7365 2075 6e65 7870 6563 7465 6420 636c  se unexpected cl
-000102e0: 7573 7465 7220 6c65 616b 6167 6520 6966  uster leakage if
-000102f0: 2074 6865 2074 776f 2069 6465 6e74 6974   the two identit
-00010300: 6965 7320 6172 6520 6e6f 7420 270a 2020  ies are not '.  
+000101c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000101d0: 2020 2020 2063 7572 7265 6e74 5f75 7365       current_use
+000101e0: 725f 6964 656e 7469 7479 2929 3a0a 2020  r_identity)):.  
+000101f0: 2020 2020 2020 2020 2020 2320 436c 6561            # Clea
+00010200: 6e20 7570 2074 6865 206f 776e 6572 2069  n up the owner i
+00010210: 6465 6e74 6979 2066 6f72 2074 6865 2062  dentiy for the b
+00010220: 6163 6b73 6c61 7368 2061 6e64 206e 6577  ackslash and new
+00010230: 6c69 6e65 732c 2063 6175 7365 640a 2020  lines, caused.  
+00010240: 2020 2020 2020 2020 2020 2320 6279 2074            # by t
+00010250: 6865 2063 6c6f 7564 2043 4c49 206f 7574  he cloud CLI out
+00010260: 7075 742c 2065 2e67 2e20 6763 6c6f 7564  put, e.g. gcloud
+00010270: 2e0a 2020 2020 2020 2020 2020 2020 6f77  ..            ow
+00010280: 6e65 7220 3d20 6f77 6e65 722e 7265 706c  ner = owner.repl
+00010290: 6163 6528 275c 6e27 2c20 2727 292e 7265  ace('\n', '').re
+000102a0: 706c 6163 6528 275c 5c27 2c20 2727 290a  place('\\', '').
+000102b0: 2020 2020 2020 2020 2020 2020 6966 206f              if o
+000102c0: 776e 6572 203d 3d20 6375 7272 656e 743a  wner == current:
+000102d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000102e0: 2069 6620 6920 213d 2030 3a0a 2020 2020   if i != 0:.    
+000102f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010300: 6c6f 6767 6572 2e77 6172 6e69 6e67 280a  logger.warning(.
 00010310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010320: 2020 2020 2020 2761 6374 7561 6c6c 7920        'actually 
-00010330: 6571 7569 7661 6c65 6e74 2028 652e 672e  equivalent (e.g.
-00010340: 2c20 6265 6c6f 6e67 2074 6f20 7468 6520  , belong to the 
-00010350: 7361 6d65 2070 6572 736f 6e29 2e27 0a20  same person).'. 
+00010320: 2020 2020 2020 2020 6627 5468 6520 636c          f'The cl
+00010330: 7573 7465 7220 7761 7320 6f77 6e65 6420  uster was owned 
+00010340: 6279 207b 6f77 6e65 725f 6964 656e 7469  by {owner_identi
+00010350: 7479 7d2c 2062 7574 2027 0a20 2020 2020  ty}, but '.     
 00010360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010370: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00010380: 2020 2020 2069 6620 6920 213d 2030 206f       if i != 0 o
-00010390: 7220 6c65 6e28 6f77 6e65 725f 6964 656e  r len(owner_iden
-000103a0: 7469 7479 2920 213d 206c 656e 2863 7572  tity) != len(cur
-000103b0: 7265 6e74 5f75 7365 725f 6964 656e 7469  rent_user_identi
-000103c0: 7479 293a 0a20 2020 2020 2020 2020 2020  ty):.           
-000103d0: 2020 2020 2020 2020 2023 2057 6520 7570           # We up
-000103e0: 6461 7465 2074 6865 206f 776e 6572 206f  date the owner o
-000103f0: 6620 6120 636c 7573 7465 722c 2077 6865  f a cluster, whe
-00010400: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
-00010410: 2020 2020 2020 2023 2031 2e20 5468 6520         # 1. The 
-00010420: 7374 7269 6374 6573 7420 6964 656e 7474  strictest identt
-00010430: 7920 2869 2e65 2e20 7468 6520 6669 7273  y (i.e. the firs
-00010440: 7420 6f6e 6529 2064 6f65 7320 6e6f 740a  t one) does not.
-00010450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010460: 2020 2020 2320 6d61 7463 682c 2062 7574      # match, but
-00010470: 2074 6865 206c 6174 7465 7220 6f6e 6573   the latter ones
-00010480: 206d 6174 6368 2e0a 2020 2020 2020 2020   match..        
-00010490: 2020 2020 2020 2020 2020 2020 2320 322e              # 2.
-000104a0: 2054 6865 206c 656e 6774 6820 6f66 2074   The length of t
-000104b0: 6865 2074 776f 2069 6465 6e74 6974 6965  he two identitie
-000104c0: 7320 6172 6520 6469 6666 6572 656e 742c  s are different,
-000104d0: 2077 6869 6368 0a20 2020 2020 2020 2020   which.         
-000104e0: 2020 2020 2020 2020 2020 2023 2077 696c             # wil
-000104f0: 6c20 6f6e 6c79 2068 6170 7065 6e20 7768  l only happen wh
-00010500: 656e 2074 6865 2063 6c75 7374 6572 2069  en the cluster i
-00010510: 7320 6c61 756e 6368 6564 2062 6566 6f72  s launched befor
-00010520: 6520 2331 3830 382e 0a20 2020 2020 2020  e #1808..       
-00010530: 2020 2020 2020 2020 2020 2020 2023 2055               # U
-00010540: 7064 6174 6520 7468 6520 7573 6572 2069  pdate the user i
-00010550: 6465 6e74 6974 7920 746f 2061 766f 6964  dentity to avoid
-00010560: 2073 686f 7769 6e67 2074 6865 2077 6172   showing the war
-00010570: 6e69 6e67 2061 626f 7665 0a20 2020 2020  ning above.     
-00010580: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00010590: 2061 6761 696e 2e0a 2020 2020 2020 2020   again..        
-000105a0: 2020 2020 2020 2020 2020 2020 676c 6f62              glob
-000105b0: 616c 5f75 7365 725f 7374 6174 652e 7365  al_user_state.se
-000105c0: 745f 6f77 6e65 725f 6964 656e 7469 7479  t_owner_identity
-000105d0: 5f66 6f72 5f63 6c75 7374 6572 280a 2020  _for_cluster(.  
-000105e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105f0: 2020 2020 2020 636c 7573 7465 725f 6e61        cluster_na
-00010600: 6d65 2c20 6375 7272 656e 745f 7573 6572  me, current_user
-00010610: 5f69 6465 6e74 6974 7929 0a20 2020 2020  _identity).     
-00010620: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00010630: 6e20 2023 2054 6865 2075 7365 7220 6964  n  # The user id
-00010640: 656e 7469 7479 206d 6174 6368 6573 2e0a  entity matches..
-00010650: 2020 2020 2020 2020 7769 7468 2075 785f          with ux_
-00010660: 7574 696c 732e 7072 696e 745f 6578 6365  utils.print_exce
-00010670: 7074 696f 6e5f 6e6f 5f74 7261 6365 6261  ption_no_traceba
-00010680: 636b 2829 3a0a 2020 2020 2020 2020 2020  ck():.          
-00010690: 2020 7261 6973 6520 6578 6365 7074 696f    raise exceptio
-000106a0: 6e73 2e43 6c75 7374 6572 4f77 6e65 7249  ns.ClusterOwnerI
-000106b0: 6465 6e74 6974 794d 6973 6d61 7463 6845  dentityMismatchE
-000106c0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-000106d0: 2020 2020 2020 6627 7b63 6c75 7374 6572        f'{cluster
-000106e0: 5f6e 616d 6521 727d 2028 7b63 6c6f 7564  _name!r} ({cloud
-000106f0: 7d29 2069 7320 6f77 6e65 6420 6279 2061  }) is owned by a
-00010700: 6363 6f75 6e74 2027 0a20 2020 2020 2020  ccount '.       
-00010710: 2020 2020 2020 2020 2066 277b 6f77 6e65           f'{owne
-00010720: 725f 6964 656e 7469 7479 2172 7d2c 2062  r_identity!r}, b
-00010730: 7574 2074 6865 2061 6374 6976 6174 6564  ut the activated
-00010740: 2061 6363 6f75 6e74 2027 0a20 2020 2020   account '.     
-00010750: 2020 2020 2020 2020 2020 2066 2769 7320             f'is 
-00010760: 7b63 7572 7265 6e74 5f75 7365 725f 6964  {current_user_id
-00010770: 656e 7469 7479 2172 7d2e 2729 0a0a 0a64  entity!r}.')...d
-00010780: 6566 2074 6167 5f66 696c 7465 725f 666f  ef tag_filter_fo
-00010790: 725f 636c 7573 7465 7228 636c 7573 7465  r_cluster(cluste
-000107a0: 725f 6e61 6d65 3a20 7374 7229 202d 3e20  r_name: str) -> 
-000107b0: 4469 6374 5b73 7472 2c20 7374 725d 3a0a  Dict[str, str]:.
-000107c0: 2020 2020 2222 2252 6574 7572 6e73 2061      """Returns a
-000107d0: 2074 6167 2066 696c 7465 7220 666f 7220   tag filter for 
-000107e0: 7468 6520 636c 7573 7465 722e 2222 220a  the cluster.""".
-000107f0: 2020 2020 7265 7475 726e 207b 0a20 2020      return {.   
-00010800: 2020 2020 2027 7261 792d 636c 7573 7465       'ray-cluste
-00010810: 722d 6e61 6d65 273a 2063 6c75 7374 6572  r-name': cluster
-00010820: 5f6e 616d 652c 0a20 2020 207d 0a0a 0a64  _name,.    }...d
-00010830: 6566 205f 7175 6572 795f 636c 7573 7465  ef _query_cluste
-00010840: 725f 7374 6174 7573 5f76 6961 5f63 6c6f  r_status_via_clo
-00010850: 7564 5f61 7069 280a 2020 2020 6861 6e64  ud_api(.    hand
-00010860: 6c65 3a20 2763 6c6f 7564 5f76 6d5f 7261  le: 'cloud_vm_ra
-00010870: 795f 6261 636b 656e 642e 436c 6f75 6456  y_backend.CloudV
-00010880: 6d52 6179 5265 736f 7572 6365 4861 6e64  mRayResourceHand
-00010890: 6c65 270a 2920 2d3e 204c 6973 745b 7374  le'.) -> List[st
-000108a0: 6174 7573 5f6c 6962 2e43 6c75 7374 6572  atus_lib.Cluster
-000108b0: 5374 6174 7573 5d3a 0a20 2020 2022 2222  Status]:.    """
-000108c0: 5265 7475 726e 7320 7468 6520 7374 6174  Returns the stat
-000108d0: 7573 206f 6620 7468 6520 636c 7573 7465  us of the cluste
-000108e0: 722e 0a0a 2020 2020 5261 6973 6573 3a0a  r...    Raises:.
-000108f0: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
-00010900: 6e73 2e43 6c75 7374 6572 5374 6174 7573  ns.ClusterStatus
-00010910: 4665 7463 6869 6e67 4572 726f 723a 2074  FetchingError: t
-00010920: 6865 2063 6c75 7374 6572 2073 7461 7475  he cluster statu
-00010930: 7320 6361 6e6e 6f74 2062 650a 2020 2020  s cannot be.    
-00010940: 2020 2020 2020 6665 7463 6865 6420 6672        fetched fr
-00010950: 6f6d 2074 6865 2063 6c6f 7564 2070 726f  om the cloud pro
-00010960: 7669 6465 722e 0a20 2020 2022 2222 0a20  vider..    """. 
-00010970: 2020 2063 6c75 7374 6572 5f6e 616d 655f     cluster_name_
-00010980: 6f6e 5f63 6c6f 7564 203d 2068 616e 646c  on_cloud = handl
-00010990: 652e 636c 7573 7465 725f 6e61 6d65 5f6f  e.cluster_name_o
-000109a0: 6e5f 636c 6f75 640a 2020 2020 636c 7573  n_cloud.    clus
-000109b0: 7465 725f 6e61 6d65 5f69 6e5f 6869 6e74  ter_name_in_hint
-000109c0: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
-000109d0: 636c 7573 7465 725f 6e61 6d65 5f69 6e5f  cluster_name_in_
-000109e0: 6869 6e74 280a 2020 2020 2020 2020 6861  hint(.        ha
-000109f0: 6e64 6c65 2e63 6c75 7374 6572 5f6e 616d  ndle.cluster_nam
-00010a00: 652c 2063 6c75 7374 6572 5f6e 616d 655f  e, cluster_name_
-00010a10: 6f6e 5f63 6c6f 7564 290a 2020 2020 2320  on_cloud).    # 
-00010a20: 5573 6520 7265 6769 6f6e 2061 6e64 207a  Use region and z
-00010a30: 6f6e 6520 6672 6f6d 2074 6865 2063 6c75  one from the clu
-00010a40: 7374 6572 2063 6f6e 6669 672c 2069 6e73  ster config, ins
-00010a50: 7465 6164 206f 6620 7468 650a 2020 2020  tead of the.    
-00010a60: 2320 6861 6e64 6c65 2e6c 6175 6e63 6865  # handle.launche
-00010a70: 645f 7265 736f 7572 6365 732c 2062 6563  d_resources, bec
-00010a80: 6175 7365 2074 6865 206c 6174 7465 7220  ause the latter 
-00010a90: 6d61 7920 6e6f 7420 6265 2073 6574 0a20  may not be set. 
-00010aa0: 2020 2023 2063 6f72 7265 6374 6c79 2079     # correctly y
-00010ab0: 6574 2e0a 2020 2020 7261 795f 636f 6e66  et..    ray_conf
-00010ac0: 6967 203d 2063 6f6d 6d6f 6e5f 7574 696c  ig = common_util
-00010ad0: 732e 7265 6164 5f79 616d 6c28 6861 6e64  s.read_yaml(hand
-00010ae0: 6c65 2e63 6c75 7374 6572 5f79 616d 6c29  le.cluster_yaml)
-00010af0: 0a20 2020 2070 726f 7669 6465 725f 636f  .    provider_co
-00010b00: 6e66 6967 203d 2072 6179 5f63 6f6e 6669  nfig = ray_confi
-00010b10: 675b 2770 726f 7669 6465 7227 5d0a 0a20  g['provider'].. 
-00010b20: 2020 2023 2051 7565 7279 2074 6865 2063     # Query the c
-00010b30: 6c6f 7564 2070 726f 7669 6465 722e 0a20  loud provider.. 
-00010b40: 2020 2023 2054 4f44 4f28 7375 7175 6172     # TODO(suquar
-00010b50: 6b29 3a20 6d6f 7665 2069 6d70 6c65 6d65  k): move impleme
-00010b60: 6e74 6174 696f 6e73 206f 6620 6d6f 7265  ntations of more
-00010b70: 2063 6c6f 7564 7320 6865 7265 0a20 2020   clouds here.   
-00010b80: 2063 6c6f 7564 203d 2068 616e 646c 652e   cloud = handle.
-00010b90: 6c61 756e 6368 6564 5f72 6573 6f75 7263  launched_resourc
-00010ba0: 6573 2e63 6c6f 7564 0a20 2020 2061 7373  es.cloud.    ass
-00010bb0: 6572 7420 636c 6f75 6420 6973 206e 6f74  ert cloud is not
-00010bc0: 204e 6f6e 652c 2068 616e 646c 650a 2020   None, handle.  
-00010bd0: 2020 6966 2063 6c6f 7564 2e53 5441 5455    if cloud.STATU
-00010be0: 535f 5645 5253 494f 4e20 3e3d 2063 6c6f  S_VERSION >= clo
-00010bf0: 7564 732e 5374 6174 7573 5665 7273 696f  uds.StatusVersio
-00010c00: 6e2e 534b 5950 494c 4f54 3a0a 2020 2020  n.SKYPILOT:.    
-00010c10: 2020 2020 636c 6f75 645f 6e61 6d65 203d      cloud_name =
-00010c20: 2072 6570 7228 6861 6e64 6c65 2e6c 6175   repr(handle.lau
-00010c30: 6e63 6865 645f 7265 736f 7572 6365 732e  nched_resources.
-00010c40: 636c 6f75 6429 0a20 2020 2020 2020 2074  cloud).        t
-00010c50: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00010c60: 6e6f 6465 5f73 7461 7475 735f 6469 6374  node_status_dict
-00010c70: 203d 2070 726f 7669 7369 6f6e 5f6c 6962   = provision_lib
-00010c80: 2e71 7565 7279 5f69 6e73 7461 6e63 6573  .query_instances
-00010c90: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00010ca0: 2020 636c 6f75 645f 6e61 6d65 2c20 636c    cloud_name, cl
-00010cb0: 7573 7465 725f 6e61 6d65 5f6f 6e5f 636c  uster_name_on_cl
-00010cc0: 6f75 642c 2070 726f 7669 6465 725f 636f  oud, provider_co
-00010cd0: 6e66 6967 290a 2020 2020 2020 2020 2020  nfig).          
-00010ce0: 2020 6c6f 6767 6572 2e64 6562 7567 2866    logger.debug(f
-00010cf0: 2751 7565 7279 696e 6720 7b63 6c6f 7564  'Querying {cloud
-00010d00: 5f6e 616d 657d 2063 6c75 7374 6572 2027  _name} cluster '
-00010d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010d20: 2020 2020 2020 2020 2020 6627 7b63 6c75            f'{clu
-00010d30: 7374 6572 5f6e 616d 655f 696e 5f68 696e  ster_name_in_hin
-00010d40: 747d 2027 0a20 2020 2020 2020 2020 2020  t} '.           
-00010d50: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00010d60: 7374 6174 7573 3a5c 6e7b 7070 7269 6e74  status:\n{pprint
-00010d70: 2e70 666f 726d 6174 286e 6f64 655f 7374  .pformat(node_st
-00010d80: 6174 7573 5f64 6963 7429 7d27 290a 2020  atus_dict)}').  
-00010d90: 2020 2020 2020 2020 2020 6e6f 6465 5f73            node_s
-00010da0: 7461 7475 7365 7320 3d20 6c69 7374 286e  tatuses = list(n
-00010db0: 6f64 655f 7374 6174 7573 5f64 6963 742e  ode_status_dict.
-00010dc0: 7661 6c75 6573 2829 290a 2020 2020 2020  values()).      
-00010dd0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-00010de0: 6f6e 2061 7320 653a 2020 2320 7079 6c69  on as e:  # pyli
-00010df0: 6e74 3a20 6469 7361 626c 653d 6272 6f61  nt: disable=broa
-00010e00: 642d 6578 6365 7074 0a20 2020 2020 2020  d-except.       
-00010e10: 2020 2020 2077 6974 6820 7578 5f75 7469       with ux_uti
-00010e20: 6c73 2e70 7269 6e74 5f65 7863 6570 7469  ls.print_excepti
-00010e30: 6f6e 5f6e 6f5f 7472 6163 6562 6163 6b28  on_no_traceback(
-00010e40: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00010e50: 2020 2072 6169 7365 2065 7863 6570 7469     raise excepti
-00010e60: 6f6e 732e 436c 7573 7465 7253 7461 7475  ons.ClusterStatu
-00010e70: 7346 6574 6368 696e 6745 7272 6f72 280a  sFetchingError(.
-00010e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010e90: 2020 2020 6627 4661 696c 6564 2074 6f20      f'Failed to 
-00010ea0: 7175 6572 7920 7b63 6c6f 7564 5f6e 616d  query {cloud_nam
-00010eb0: 657d 2063 6c75 7374 6572 2027 0a20 2020  e} cluster '.   
-00010ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ed0: 2066 277b 636c 7573 7465 725f 6e61 6d65   f'{cluster_name
-00010ee0: 5f69 6e5f 6869 6e74 7d20 270a 2020 2020  _in_hint} '.    
-00010ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f00: 6627 7374 6174 7573 3a20 7b63 6f6d 6d6f  f'status: {commo
-00010f10: 6e5f 7574 696c 732e 666f 726d 6174 5f65  n_utils.format_e
-00010f20: 7863 6570 7469 6f6e 2865 2c20 7573 655f  xception(e, use_
-00010f30: 6272 6163 6b65 743d 5472 7565 297d 270a  bracket=True)}'.
-00010f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f50: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
-00010f60: 2020 2020 7265 6769 6f6e 203d 2070 726f      region = pro
-00010f70: 7669 6465 725f 636f 6e66 6967 2e67 6574  vider_config.get
-00010f80: 2827 7265 6769 6f6e 2729 206f 7220 7072  ('region') or pr
-00010f90: 6f76 6964 6572 5f63 6f6e 6669 672e 6765  ovider_config.ge
-00010fa0: 7428 0a20 2020 2020 2020 2020 2020 2027  t(.            '
-00010fb0: 6c6f 6361 7469 6f6e 2729 0a20 2020 2020  location').     
-00010fc0: 2020 207a 6f6e 6520 3d20 7261 795f 636f     zone = ray_co
-00010fd0: 6e66 6967 5b27 7072 6f76 6964 6572 275d  nfig['provider']
-00010fe0: 2e67 6574 2827 6176 6169 6c61 6269 6c69  .get('availabili
-00010ff0: 7479 5f7a 6f6e 6527 290a 2020 2020 2020  ty_zone').      
-00011000: 2020 6e6f 6465 5f73 7461 7475 7365 7320    node_statuses 
-00011010: 3d20 636c 6f75 642e 7175 6572 795f 7374  = cloud.query_st
-00011020: 6174 7573 280a 2020 2020 2020 2020 2020  atus(.          
-00011030: 2020 636c 7573 7465 725f 6e61 6d65 5f6f    cluster_name_o
-00011040: 6e5f 636c 6f75 642c 0a20 2020 2020 2020  n_cloud,.       
-00011050: 2020 2020 2074 6167 5f66 696c 7465 725f       tag_filter_
-00011060: 666f 725f 636c 7573 7465 7228 636c 7573  for_cluster(clus
-00011070: 7465 725f 6e61 6d65 5f6f 6e5f 636c 6f75  ter_name_on_clou
-00011080: 6429 2c20 7265 6769 6f6e 2c20 7a6f 6e65  d), region, zone
-00011090: 290a 2020 2020 7265 7475 726e 206e 6f64  ).    return nod
-000110a0: 655f 7374 6174 7573 6573 0a0a 0a64 6566  e_statuses...def
-000110b0: 2063 6865 636b 5f63 616e 5f63 6c6f 6e65   check_can_clone
-000110c0: 5f64 6973 6b5f 616e 645f 6f76 6572 7269  _disk_and_overri
-000110d0: 6465 5f74 6173 6b28 0a20 2020 2063 6c75  de_task(.    clu
-000110e0: 7374 6572 5f6e 616d 653a 2073 7472 2c20  ster_name: str, 
-000110f0: 7461 7267 6574 5f63 6c75 7374 6572 5f6e  target_cluster_n
-00011100: 616d 653a 204f 7074 696f 6e61 6c5b 7374  ame: Optional[st
-00011110: 725d 2c20 7461 736b 3a20 2774 6173 6b5f  r], task: 'task_
-00011120: 6c69 622e 5461 736b 270a 2920 2d3e 2054  lib.Task'.) -> T
-00011130: 7570 6c65 5b27 7461 736b 5f6c 6962 2e54  uple['task_lib.T
-00011140: 6173 6b27 2c20 2763 6c6f 7564 5f76 6d5f  ask', 'cloud_vm_
-00011150: 7261 795f 6261 636b 656e 642e 436c 6f75  ray_backend.Clou
-00011160: 6456 6d52 6179 5265 736f 7572 6365 4861  dVmRayResourceHa
-00011170: 6e64 6c65 275d 3a0a 2020 2020 2222 2243  ndle']:.    """C
-00011180: 6865 636b 2069 6620 7468 6520 7461 736b  heck if the task
-00011190: 2069 7320 636f 6d70 6174 6962 6c65 2074   is compatible t
-000111a0: 6f20 636c 6f6e 6520 6469 736b 2066 726f  o clone disk fro
-000111b0: 6d20 7468 6520 736f 7572 6365 2063 6c75  m the source clu
-000111c0: 7374 6572 2e0a 0a20 2020 2041 7267 733a  ster...    Args:
-000111d0: 0a20 2020 2020 2020 2063 6c75 7374 6572  .        cluster
-000111e0: 5f6e 616d 653a 2054 6865 206e 616d 6520  _name: The name 
-000111f0: 6f66 2074 6865 2063 6c75 7374 6572 2074  of the cluster t
-00011200: 6f20 636c 6f6e 6520 6469 736b 2066 726f  o clone disk fro
-00011210: 6d2e 0a20 2020 2020 2020 2074 6172 6765  m..        targe
-00011220: 745f 636c 7573 7465 725f 6e61 6d65 3a20  t_cluster_name: 
-00011230: 5468 6520 6e61 6d65 206f 6620 7468 6520  The name of the 
-00011240: 7461 7267 6574 2063 6c75 7374 6572 2e0a  target cluster..
-00011250: 2020 2020 2020 2020 7461 736b 3a20 5468          task: Th
-00011260: 6520 7461 736b 2074 6f20 6368 6563 6b2e  e task to check.
-00011270: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
-00011280: 2020 2020 2020 2054 6865 2074 6173 6b20         The task 
-00011290: 746f 2075 7365 2061 6e64 2074 6865 2072  to use and the r
-000112a0: 6573 6f75 7263 6520 6861 6e64 6c65 206f  esource handle o
-000112b0: 6620 7468 6520 736f 7572 6365 2063 6c75  f the source clu
-000112c0: 7374 6572 2e0a 0a20 2020 2052 6169 7365  ster...    Raise
-000112d0: 733a 0a20 2020 2020 2020 2056 616c 7565  s:.        Value
-000112e0: 4572 726f 723a 2049 6620 7468 6520 736f  Error: If the so
-000112f0: 7572 6365 2063 6c75 7374 6572 2064 6f65  urce cluster doe
-00011300: 7320 6e6f 7420 6578 6973 742e 0a20 2020  s not exist..   
-00011310: 2020 2020 2065 7863 6570 7469 6f6e 732e       exceptions.
-00011320: 4e6f 7453 7570 706f 7274 6564 4572 726f  NotSupportedErro
-00011330: 723a 2049 6620 7468 6520 736f 7572 6365  r: If the source
-00011340: 2063 6c75 7374 6572 2069 7320 6e6f 7420   cluster is not 
-00011350: 7661 6c69 6420 6f72 2074 6865 0a20 2020  valid or the.   
-00011360: 2020 2020 2020 2020 2074 6173 6b20 6973           task is
-00011370: 206e 6f74 2063 6f6d 7061 7469 626c 6520   not compatible 
-00011380: 746f 2063 6c6f 6e65 2064 6973 6b20 6672  to clone disk fr
-00011390: 6f6d 2074 6865 2073 6f75 7263 6520 636c  om the source cl
-000113a0: 7573 7465 722e 0a20 2020 2022 2222 0a20  uster..    """. 
-000113b0: 2020 2073 6f75 7263 655f 636c 7573 7465     source_cluste
-000113c0: 725f 7374 6174 7573 2c20 6861 6e64 6c65  r_status, handle
-000113d0: 203d 2072 6566 7265 7368 5f63 6c75 7374   = refresh_clust
-000113e0: 6572 5f73 7461 7475 735f 6861 6e64 6c65  er_status_handle
-000113f0: 2863 6c75 7374 6572 5f6e 616d 6529 0a20  (cluster_name). 
-00011400: 2020 2069 6620 736f 7572 6365 5f63 6c75     if source_clu
-00011410: 7374 6572 5f73 7461 7475 7320 6973 204e  ster_status is N
-00011420: 6f6e 653a 0a20 2020 2020 2020 2077 6974  one:.        wit
-00011430: 6820 7578 5f75 7469 6c73 2e70 7269 6e74  h ux_utils.print
-00011440: 5f65 7863 6570 7469 6f6e 5f6e 6f5f 7472  _exception_no_tr
-00011450: 6163 6562 6163 6b28 293a 0a20 2020 2020  aceback():.     
-00011460: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00011470: 7565 4572 726f 7228 0a20 2020 2020 2020  ueError(.       
-00011480: 2020 2020 2020 2020 2066 2743 616e 6e6f           f'Canno
-00011490: 7420 6669 6e64 2063 6c75 7374 6572 207b  t find cluster {
-000114a0: 636c 7573 7465 725f 6e61 6d65 2172 7d20  cluster_name!r} 
-000114b0: 746f 2063 6c6f 6e65 2064 6973 6b20 6672  to clone disk fr
-000114c0: 6f6d 2e27 290a 0a20 2020 2069 6620 6e6f  om.')..    if no
-000114d0: 7420 6973 696e 7374 616e 6365 2868 616e  t isinstance(han
-000114e0: 646c 652c 2062 6163 6b65 6e64 732e 436c  dle, backends.Cl
-000114f0: 6f75 6456 6d52 6179 5265 736f 7572 6365  oudVmRayResource
-00011500: 4861 6e64 6c65 293a 0a20 2020 2020 2020  Handle):.       
-00011510: 2077 6974 6820 7578 5f75 7469 6c73 2e70   with ux_utils.p
-00011520: 7269 6e74 5f65 7863 6570 7469 6f6e 5f6e  rint_exception_n
-00011530: 6f5f 7472 6163 6562 6163 6b28 293a 0a20  o_traceback():. 
-00011540: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00011550: 2065 7863 6570 7469 6f6e 732e 4e6f 7453   exceptions.NotS
-00011560: 7570 706f 7274 6564 4572 726f 7228 0a20  upportedError(. 
-00011570: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00011580: 2743 616e 6e6f 7420 636c 6f6e 6520 6469  'Cannot clone di
-00011590: 736b 2066 726f 6d20 6120 6e6f 6e2d 636c  sk from a non-cl
-000115a0: 6f75 6420 636c 7573 7465 7220 7b63 6c75  oud cluster {clu
-000115b0: 7374 6572 5f6e 616d 6521 727d 2e27 290a  ster_name!r}.').
-000115c0: 0a20 2020 2069 6620 736f 7572 6365 5f63  .    if source_c
-000115d0: 6c75 7374 6572 5f73 7461 7475 7320 213d  luster_status !=
-000115e0: 2073 7461 7475 735f 6c69 622e 436c 7573   status_lib.Clus
-000115f0: 7465 7253 7461 7475 732e 5354 4f50 5045  terStatus.STOPPE
-00011600: 443a 0a20 2020 2020 2020 2077 6974 6820  D:.        with 
-00011610: 7578 5f75 7469 6c73 2e70 7269 6e74 5f65  ux_utils.print_e
-00011620: 7863 6570 7469 6f6e 5f6e 6f5f 7472 6163  xception_no_trac
-00011630: 6562 6163 6b28 293a 0a20 2020 2020 2020  eback():.       
-00011640: 2020 2020 2072 6169 7365 2065 7863 6570       raise excep
-00011650: 7469 6f6e 732e 4e6f 7453 7570 706f 7274  tions.NotSupport
-00011660: 6564 4572 726f 7228 0a20 2020 2020 2020  edError(.       
-00011670: 2020 2020 2020 2020 2066 2743 616e 6e6f           f'Canno
-00011680: 7420 636c 6f6e 6520 6469 736b 2066 726f  t clone disk fro
-00011690: 6d20 636c 7573 7465 7220 7b63 6c75 7374  m cluster {clust
-000116a0: 6572 5f6e 616d 6521 727d 2027 0a20 2020  er_name!r} '.   
-000116b0: 2020 2020 2020 2020 2020 2020 2066 2728               f'(
-000116c0: 7b73 6f75 7263 655f 636c 7573 7465 725f  {source_cluster_
-000116d0: 7374 6174 7573 2172 7d29 2e20 506c 6561  status!r}). Plea
-000116e0: 7365 2073 746f 7020 7468 6520 270a 2020  se stop the '.  
-000116f0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00011700: 636c 7573 7465 7220 6669 7273 743a 2073  cluster first: s
-00011710: 6b79 2073 746f 7020 7b63 6c75 7374 6572  ky stop {cluster
-00011720: 5f6e 616d 657d 2729 0a0a 2020 2020 6966  _name}')..    if
-00011730: 2074 6172 6765 745f 636c 7573 7465 725f   target_cluster_
-00011740: 6e61 6d65 2069 7320 6e6f 7420 4e6f 6e65  name is not None
-00011750: 3a0a 2020 2020 2020 2020 7461 7267 6574  :.        target
-00011760: 5f63 6c75 7374 6572 5f73 7461 7475 732c  _cluster_status,
-00011770: 205f 203d 2072 6566 7265 7368 5f63 6c75   _ = refresh_clu
-00011780: 7374 6572 5f73 7461 7475 735f 6861 6e64  ster_status_hand
-00011790: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
-000117a0: 7461 7267 6574 5f63 6c75 7374 6572 5f6e  target_cluster_n
-000117b0: 616d 6529 0a20 2020 2020 2020 2069 6620  ame).        if 
-000117c0: 7461 7267 6574 5f63 6c75 7374 6572 5f73  target_cluster_s
-000117d0: 7461 7475 7320 6973 206e 6f74 204e 6f6e  tatus is not Non
-000117e0: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
-000117f0: 6974 6820 7578 5f75 7469 6c73 2e70 7269  ith ux_utils.pri
-00011800: 6e74 5f65 7863 6570 7469 6f6e 5f6e 6f5f  nt_exception_no_
-00011810: 7472 6163 6562 6163 6b28 293a 0a20 2020  traceback():.   
-00011820: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00011830: 7365 2065 7863 6570 7469 6f6e 732e 4e6f  se exceptions.No
-00011840: 7453 7570 706f 7274 6564 4572 726f 7228  tSupportedError(
-00011850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011860: 2020 2020 2066 2754 6865 2074 6172 6765       f'The targe
-00011870: 7420 636c 7573 7465 7220 7b74 6172 6765  t cluster {targe
-00011880: 745f 636c 7573 7465 725f 6e61 6d65 2172  t_cluster_name!r
-00011890: 7d20 616c 7265 6164 7920 6578 6973 7473  } already exists
-000118a0: 2e20 436c 6f6e 696e 6720 270a 2020 2020  . Cloning '.    
-000118b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000118c0: 2764 6973 6b20 6973 206f 6e6c 7920 7375  'disk is only su
-000118d0: 7070 6f72 7465 6420 7768 656e 2063 7265  pported when cre
-000118e0: 6174 696e 6720 6120 6e65 7720 636c 7573  ating a new clus
-000118f0: 7465 722e 2054 6f20 6669 783a 2073 7065  ter. To fix: spe
-00011900: 6369 6679 2027 0a20 2020 2020 2020 2020  cify '.         
-00011910: 2020 2020 2020 2020 2020 2027 6120 6e65             'a ne
-00011920: 7720 7461 7267 6574 2063 6c75 7374 6572  w target cluster
-00011930: 206e 616d 652e 2729 0a0a 2020 2020 6e65   name.')..    ne
-00011940: 775f 7461 736b 5f72 6573 6f75 7263 6573  w_task_resources
-00011950: 203d 205b 5d0a 2020 2020 6f72 6967 696e   = [].    origin
-00011960: 616c 5f63 6c6f 7564 203d 2068 616e 646c  al_cloud = handl
-00011970: 652e 6c61 756e 6368 6564 5f72 6573 6f75  e.launched_resou
-00011980: 7263 6573 2e63 6c6f 7564 0a20 2020 206f  rces.cloud.    o
-00011990: 7269 6769 6e61 6c5f 636c 6f75 642e 6368  riginal_cloud.ch
-000119a0: 6563 6b5f 6665 6174 7572 6573 5f61 7265  eck_features_are
-000119b0: 5f73 7570 706f 7274 6564 280a 2020 2020  _supported(.    
-000119c0: 2020 2020 6861 6e64 6c65 2e6c 6175 6e63      handle.launc
-000119d0: 6865 645f 7265 736f 7572 6365 732c 0a20  hed_resources,. 
-000119e0: 2020 2020 2020 207b 636c 6f75 6473 2e43         {clouds.C
-000119f0: 6c6f 7564 496d 706c 656d 656e 7461 7469  loudImplementati
-00011a00: 6f6e 4665 6174 7572 6573 2e43 4c4f 4e45  onFeatures.CLONE
-00011a10: 5f44 4953 4b5f 4652 4f4d 5f43 4c55 5354  _DISK_FROM_CLUST
-00011a20: 4552 7d29 0a0a 2020 2020 6173 7365 7274  ER})..    assert
-00011a30: 206f 7269 6769 6e61 6c5f 636c 6f75 6420   original_cloud 
-00011a40: 6973 206e 6f74 204e 6f6e 652c 2068 616e  is not None, han
-00011a50: 646c 652e 6c61 756e 6368 6564 5f72 6573  dle.launched_res
-00011a60: 6f75 7263 6573 0a20 2020 2068 6173 5f6f  ources.    has_o
-00011a70: 7665 7272 6964 6520 3d20 4661 6c73 650a  verride = False.
-00011a80: 2020 2020 6861 735f 6469 736b 5f73 697a      has_disk_siz
-00011a90: 655f 6d65 7420 3d20 4661 6c73 650a 2020  e_met = False.  
-00011aa0: 2020 6861 735f 636c 6f75 645f 6d65 7420    has_cloud_met 
-00011ab0: 3d20 4661 6c73 650a 2020 2020 666f 7220  = False.    for 
-00011ac0: 7461 736b 5f72 6573 6f75 7263 6573 2069  task_resources i
-00011ad0: 6e20 7461 736b 2e72 6573 6f75 7263 6573  n task.resources
-00011ae0: 3a0a 2020 2020 2020 2020 6966 2068 616e  :.        if han
-00011af0: 646c 652e 6c61 756e 6368 6564 5f72 6573  dle.launched_res
-00011b00: 6f75 7263 6573 2e64 6973 6b5f 7369 7a65  ources.disk_size
-00011b10: 203e 2074 6173 6b5f 7265 736f 7572 6365   > task_resource
-00011b20: 732e 6469 736b 5f73 697a 653a 0a20 2020  s.disk_size:.   
-00011b30: 2020 2020 2020 2020 2023 2054 6865 2074           # The t
-00011b40: 6172 6765 7420 636c 7573 7465 7227 7320  arget cluster's 
-00011b50: 6469 736b 2073 686f 756c 6420 6265 2061  disk should be a
-00011b60: 7420 6c65 6173 7420 6173 206c 6172 6765  t least as large
-00011b70: 2061 7320 7468 6520 736f 7572 6365 2e0a   as the source..
-00011b80: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00011b90: 696e 7565 0a20 2020 2020 2020 2068 6173  inue.        has
-00011ba0: 5f64 6973 6b5f 7369 7a65 5f6d 6574 203d  _disk_size_met =
-00011bb0: 2054 7275 650a 2020 2020 2020 2020 6966   True.        if
-00011bc0: 2074 6173 6b5f 7265 736f 7572 6365 732e   task_resources.
-00011bd0: 636c 6f75 6420 6973 206e 6f74 204e 6f6e  cloud is not Non
-00011be0: 6520 616e 6420 6e6f 7420 6f72 6967 696e  e and not origin
-00011bf0: 616c 5f63 6c6f 7564 2e69 735f 7361 6d65  al_cloud.is_same
-00011c00: 5f63 6c6f 7564 280a 2020 2020 2020 2020  _cloud(.        
-00011c10: 2020 2020 2020 2020 7461 736b 5f72 6573          task_res
-00011c20: 6f75 7263 6573 2e63 6c6f 7564 293a 0a20  ources.cloud):. 
-00011c30: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-00011c40: 6e75 650a 2020 2020 2020 2020 6861 735f  nue.        has_
-00011c50: 636c 6f75 645f 6d65 7420 3d20 5472 7565  cloud_met = True
-00011c60: 0a0a 2020 2020 2020 2020 6f76 6572 7269  ..        overri
-00011c70: 6465 5f70 6172 616d 203d 207b 7d0a 2020  de_param = {}.  
-00011c80: 2020 2020 2020 6966 2074 6173 6b5f 7265        if task_re
-00011c90: 736f 7572 6365 732e 636c 6f75 6420 6973  sources.cloud is
-00011ca0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00011cb0: 2020 206f 7665 7272 6964 655f 7061 7261     override_para
-00011cc0: 6d5b 2763 6c6f 7564 275d 203d 206f 7269  m['cloud'] = ori
-00011cd0: 6769 6e61 6c5f 636c 6f75 640a 2020 2020  ginal_cloud.    
-00011ce0: 2020 2020 6966 2074 6173 6b5f 7265 736f      if task_reso
-00011cf0: 7572 6365 732e 7265 6769 6f6e 2069 7320  urces.region is 
-00011d00: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00011d10: 2020 6f76 6572 7269 6465 5f70 6172 616d    override_param
-00011d20: 5b27 7265 6769 6f6e 275d 203d 2068 616e  ['region'] = han
-00011d30: 646c 652e 6c61 756e 6368 6564 5f72 6573  dle.launched_res
-00011d40: 6f75 7263 6573 2e72 6567 696f 6e0a 0a20  ources.region.. 
-00011d50: 2020 2020 2020 2069 6620 6f76 6572 7269         if overri
-00011d60: 6465 5f70 6172 616d 3a0a 2020 2020 2020  de_param:.      
-00011d70: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
-00011d80: 6f28 0a20 2020 2020 2020 2020 2020 2020  o(.             
-00011d90: 2020 2066 274e 6f20 636c 6f75 642f 7265     f'No cloud/re
-00011da0: 6769 6f6e 2073 7065 6369 6669 6564 2066  gion specified f
-00011db0: 6f72 2074 6865 2074 6173 6b20 7b74 6173  or the task {tas
-00011dc0: 6b5f 7265 736f 7572 6365 737d 2e20 5573  k_resources}. Us
-00011dd0: 696e 6720 7468 6520 7361 6d65 2072 6567  ing the same reg
-00011de0: 696f 6e20 270a 2020 2020 2020 2020 2020  ion '.          
-00011df0: 2020 2020 2020 6627 6173 2073 6f75 7263        f'as sourc
-00011e00: 6520 636c 7573 7465 7220 7b63 6c75 7374  e cluster {clust
-00011e10: 6572 5f6e 616d 6521 727d 3a20 270a 2020  er_name!r}: '.  
-00011e20: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00011e30: 7b68 616e 646c 652e 6c61 756e 6368 6564  {handle.launched
-00011e40: 5f72 6573 6f75 7263 6573 2e63 6c6f 7564  _resources.cloud
-00011e50: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
-00011e60: 2020 2066 2728 7b68 616e 646c 652e 6c61     f'({handle.la
-00011e70: 756e 6368 6564 5f72 6573 6f75 7263 6573  unched_resources
-00011e80: 2e72 6567 696f 6e7d 292e 2729 0a20 2020  .region}).').   
-00011e90: 2020 2020 2020 2020 2068 6173 5f6f 7665           has_ove
-00011ea0: 7272 6964 6520 3d20 5472 7565 0a20 2020  rride = True.   
-00011eb0: 2020 2020 2074 6173 6b5f 7265 736f 7572       task_resour
-00011ec0: 6365 7320 3d20 7461 736b 5f72 6573 6f75  ces = task_resou
-00011ed0: 7263 6573 2e63 6f70 7928 2a2a 6f76 6572  rces.copy(**over
-00011ee0: 7269 6465 5f70 6172 616d 290a 2020 2020  ride_param).    
-00011ef0: 2020 2020 6e65 775f 7461 736b 5f72 6573      new_task_res
-00011f00: 6f75 7263 6573 2e61 7070 656e 6428 7461  ources.append(ta
-00011f10: 736b 5f72 6573 6f75 7263 6573 290a 0a20  sk_resources).. 
-00011f20: 2020 2069 6620 6e6f 7420 6e65 775f 7461     if not new_ta
-00011f30: 736b 5f72 6573 6f75 7263 6573 3a0a 2020  sk_resources:.  
-00011f40: 2020 2020 2020 6966 206e 6f74 2068 6173        if not has
-00011f50: 5f64 6973 6b5f 7369 7a65 5f6d 6574 3a0a  _disk_size_met:.
-00011f60: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00011f70: 2075 785f 7574 696c 732e 7072 696e 745f   ux_utils.print_
-00011f80: 6578 6365 7074 696f 6e5f 6e6f 5f74 7261  exception_no_tra
-00011f90: 6365 6261 636b 2829 3a0a 2020 2020 2020  ceback():.      
-00011fa0: 2020 2020 2020 2020 2020 7461 7267 6574            target
-00011fb0: 5f63 6c75 7374 6572 5f6e 616d 655f 7374  _cluster_name_st
-00011fc0: 7220 3d20 6627 207b 7461 7267 6574 5f63  r = f' {target_c
-00011fd0: 6c75 7374 6572 5f6e 616d 6521 727d 270a  luster_name!r}'.
-00011fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011ff0: 6966 2074 6172 6765 745f 636c 7573 7465  if target_cluste
-00012000: 725f 6e61 6d65 2069 7320 4e6f 6e65 3a0a  r_name is None:.
-00012010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012020: 2020 2020 7461 7267 6574 5f63 6c75 7374      target_clust
-00012030: 6572 5f6e 616d 655f 7374 7220 3d20 2727  er_name_str = ''
-00012040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012050: 2072 6169 7365 2065 7863 6570 7469 6f6e   raise exception
-00012060: 732e 4e6f 7453 7570 706f 7274 6564 4572  s.NotSupportedEr
-00012070: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-00012080: 2020 2020 2020 2020 2066 2754 6865 2074           f'The t
-00012090: 6172 6765 7420 636c 7573 7465 727b 7461  arget cluster{ta
-000120a0: 7267 6574 5f63 6c75 7374 6572 5f6e 616d  rget_cluster_nam
-000120b0: 655f 7374 727d 2073 686f 756c 6420 6861  e_str} should ha
-000120c0: 7665 2061 2064 6973 6b20 7369 7a65 2027  ve a disk size '
-000120d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000120e0: 2020 2020 2066 276f 6620 6174 206c 6561       f'of at lea
-000120f0: 7374 207b 6861 6e64 6c65 2e6c 6175 6e63  st {handle.launc
-00012100: 6865 645f 7265 736f 7572 6365 732e 6469  hed_resources.di
-00012110: 736b 5f73 697a 657d 2047 4220 746f 2063  sk_size} GB to c
-00012120: 6c6f 6e65 2074 6865 2027 0a20 2020 2020  lone the '.     
-00012130: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00012140: 2764 6973 6b20 6672 6f6d 207b 636c 7573  'disk from {clus
-00012150: 7465 725f 6e61 6d65 2172 7d2e 2729 0a20  ter_name!r}.'). 
-00012160: 2020 2020 2020 2069 6620 6e6f 7420 6861         if not ha
-00012170: 735f 636c 6f75 645f 6d65 743a 0a20 2020  s_cloud_met:.   
-00012180: 2020 2020 2020 2020 2074 6173 6b5f 7265           task_re
-00012190: 736f 7572 6365 735f 636c 6f75 645f 7374  sources_cloud_st
-000121a0: 7220 3d20 275b 2720 2b20 272c 272e 6a6f  r = '[' + ','.jo
-000121b0: 696e 280a 2020 2020 2020 2020 2020 2020  in(.            
-000121c0: 2020 2020 5b66 277b 7265 732e 636c 6f75      [f'{res.clou
-000121d0: 647d 2720 666f 7220 7265 7320 696e 2074  d}' for res in t
-000121e0: 6173 6b2e 7265 736f 7572 6365 735d 2920  ask.resources]) 
-000121f0: 2b20 275d 270a 2020 2020 2020 2020 2020  + ']'.          
-00012200: 2020 7461 736b 5f72 6573 6f75 7263 6573    task_resources
-00012210: 5f73 7472 203d 2027 5b27 202b 2027 2c27  _str = '[' + ','
-00012220: 2e6a 6f69 6e28 0a20 2020 2020 2020 2020  .join(.         
-00012230: 2020 2020 2020 205b 6627 7b72 6573 7d27         [f'{res}'
-00012240: 2066 6f72 2072 6573 2069 6e20 7461 736b   for res in task
-00012250: 2e72 6573 6f75 7263 6573 5d29 202b 2027  .resources]) + '
-00012260: 5d27 0a20 2020 2020 2020 2020 2020 2077  ]'.            w
-00012270: 6974 6820 7578 5f75 7469 6c73 2e70 7269  ith ux_utils.pri
-00012280: 6e74 5f65 7863 6570 7469 6f6e 5f6e 6f5f  nt_exception_no_
-00012290: 7472 6163 6562 6163 6b28 293a 0a20 2020  traceback():.   
-000122a0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-000122b0: 7365 2056 616c 7565 4572 726f 7228 0a20  se ValueError(. 
-000122c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000122d0: 2020 2066 2743 616e 6e6f 7420 636c 6f6e     f'Cannot clon
-000122e0: 6520 6469 736b 2061 6372 6f73 7320 636c  e disk across cl
-000122f0: 6f75 6420 6672 6f6d 207b 6f72 6967 696e  oud from {origin
-00012300: 616c 5f63 6c6f 7564 7d20 746f 2027 0a20  al_cloud} to '. 
-00012310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012320: 2020 2066 277b 7461 736b 5f72 6573 6f75     f'{task_resou
-00012330: 7263 6573 5f63 6c6f 7564 5f73 7472 7d20  rces_cloud_str} 
-00012340: 666f 7220 7265 736f 7572 6365 7320 7b74  for resources {t
-00012350: 6173 6b5f 7265 736f 7572 6365 735f 7374  ask_resources_st
-00012360: 727d 2e27 0a20 2020 2020 2020 2020 2020  r}.'.           
-00012370: 2020 2020 2029 0a20 2020 2020 2020 2061       ).        a
-00012380: 7373 6572 7420 4661 6c73 652c 2027 5368  ssert False, 'Sh
-00012390: 6f75 6c64 206e 6f74 2072 6561 6368 2068  ould not reach h
-000123a0: 6572 652e 270a 2020 2020 2320 7365 7420  ere.'.    # set 
-000123b0: 7468 6520 6e65 775f 7461 736b 5f72 6573  the new_task_res
-000123c0: 6f75 7263 6573 2074 6f20 6265 2074 6865  ources to be the
-000123d0: 2073 616d 6520 7479 7065 2028 6c69 7374   same type (list
-000123e0: 206f 7220 7365 7429 2061 7320 7468 650a   or set) as the.
-000123f0: 2020 2020 2320 6f72 6967 696e 616c 2074      # original t
-00012400: 6173 6b2e 7265 736f 7572 6365 730a 2020  ask.resources.  
-00012410: 2020 6966 2068 6173 5f6f 7665 7272 6964    if has_overrid
-00012420: 653a 0a20 2020 2020 2020 2074 6173 6b2e  e:.        task.
-00012430: 7365 745f 7265 736f 7572 6365 7328 7479  set_resources(ty
-00012440: 7065 2874 6173 6b2e 7265 736f 7572 6365  pe(task.resource
-00012450: 7329 286e 6577 5f74 6173 6b5f 7265 736f  s)(new_task_reso
-00012460: 7572 6365 7329 290a 2020 2020 2020 2020  urces)).        
-00012470: 2320 5265 7365 7420 7468 6520 6265 7374  # Reset the best
-00012480: 5f72 6573 6f75 7263 6573 2074 6f20 7472  _resources to tr
-00012490: 6967 6572 2072 652d 6f70 7469 6d69 7a61  iger re-optimiza
-000124a0: 7469 6f6e 0a20 2020 2020 2020 2023 206c  tion.        # l
-000124b0: 6174 6572 2c20 736f 2074 6861 7420 7468  ater, so that th
-000124c0: 6520 6e65 7720 7461 736b 5f72 6573 6f75  e new task_resou
-000124d0: 7263 6573 2077 696c 6c20 6265 2075 7365  rces will be use
-000124e0: 642e 0a20 2020 2020 2020 2074 6173 6b2e  d..        task.
-000124f0: 6265 7374 5f72 6573 6f75 7263 6573 203d  best_resources =
-00012500: 204e 6f6e 650a 2020 2020 7265 7475 726e   None.    return
-00012510: 2074 6173 6b2c 2068 616e 646c 650a 0a0a   task, handle...
-00012520: 6465 6620 5f75 7064 6174 655f 636c 7573  def _update_clus
-00012530: 7465 725f 7374 6174 7573 5f6e 6f5f 6c6f  ter_status_no_lo
-00012540: 636b 280a 2020 2020 2020 2020 636c 7573  ck(.        clus
-00012550: 7465 725f 6e61 6d65 3a20 7374 7229 202d  ter_name: str) -
-00012560: 3e20 4f70 7469 6f6e 616c 5b44 6963 745b  > Optional[Dict[
-00012570: 7374 722c 2041 6e79 5d5d 3a0a 2020 2020  str, Any]]:.    
-00012580: 2222 2255 7064 6174 6573 2074 6865 2073  """Updates the s
-00012590: 7461 7475 7320 6f66 2074 6865 2063 6c75  tatus of the clu
-000125a0: 7374 6572 2e0a 0a20 2020 2052 6169 7365  ster...    Raise
-000125b0: 733a 0a20 2020 2020 2020 2065 7863 6570  s:.        excep
-000125c0: 7469 6f6e 732e 436c 7573 7465 7253 7461  tions.ClusterSta
-000125d0: 7475 7346 6574 6368 696e 6745 7272 6f72  tusFetchingError
-000125e0: 3a20 7468 6520 636c 7573 7465 7220 7374  : the cluster st
-000125f0: 6174 7573 2063 616e 6e6f 7420 6265 0a20  atus cannot be. 
-00012600: 2020 2020 2020 2020 2066 6574 6368 6564           fetched
-00012610: 2066 726f 6d20 7468 6520 636c 6f75 6420   from the cloud 
-00012620: 7072 6f76 6964 6572 2e0a 2020 2020 2222  provider..    ""
-00012630: 220a 2020 2020 7265 636f 7264 203d 2067  ".    record = g
-00012640: 6c6f 6261 6c5f 7573 6572 5f73 7461 7465  lobal_user_state
-00012650: 2e67 6574 5f63 6c75 7374 6572 5f66 726f  .get_cluster_fro
-00012660: 6d5f 6e61 6d65 2863 6c75 7374 6572 5f6e  m_name(cluster_n
-00012670: 616d 6529 0a20 2020 2069 6620 7265 636f  ame).    if reco
-00012680: 7264 2069 7320 4e6f 6e65 3a0a 2020 2020  rd is None:.    
-00012690: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
-000126a0: 2020 2020 6861 6e64 6c65 203d 2072 6563      handle = rec
-000126b0: 6f72 645b 2768 616e 646c 6527 5d0a 2020  ord['handle'].  
-000126c0: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
-000126d0: 6e63 6528 6861 6e64 6c65 2c20 6261 636b  nce(handle, back
-000126e0: 656e 6473 2e43 6c6f 7564 566d 5261 7952  ends.CloudVmRayR
-000126f0: 6573 6f75 7263 6548 616e 646c 6529 3a0a  esourceHandle):.
-00012700: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-00012710: 6563 6f72 640a 2020 2020 636c 7573 7465  ecord.    cluste
-00012720: 725f 6e61 6d65 203d 2068 616e 646c 652e  r_name = handle.
-00012730: 636c 7573 7465 725f 6e61 6d65 0a0a 2020  cluster_name..  
-00012740: 2020 6e6f 6465 5f73 7461 7475 7365 7320    node_statuses 
-00012750: 3d20 5f71 7565 7279 5f63 6c75 7374 6572  = _query_cluster
-00012760: 5f73 7461 7475 735f 7669 615f 636c 6f75  _status_via_clou
-00012770: 645f 6170 6928 6861 6e64 6c65 290a 0a20  d_api(handle).. 
-00012780: 2020 2061 6c6c 5f6e 6f64 6573 5f75 7020     all_nodes_up 
-00012790: 3d20 2861 6c6c 280a 2020 2020 2020 2020  = (all(.        
-000127a0: 7374 6174 7573 203d 3d20 7374 6174 7573  status == status
-000127b0: 5f6c 6962 2e43 6c75 7374 6572 5374 6174  _lib.ClusterStat
-000127c0: 7573 2e55 5020 666f 7220 7374 6174 7573  us.UP for status
-000127d0: 2069 6e20 6e6f 6465 5f73 7461 7475 7365   in node_statuse
-000127e0: 7329 2061 6e64 0a20 2020 2020 2020 2020  s) and.         
-000127f0: 2020 2020 2020 2020 2020 206c 656e 286e             len(n
-00012800: 6f64 655f 7374 6174 7573 6573 2920 3d3d  ode_statuses) ==
-00012810: 2068 616e 646c 652e 6c61 756e 6368 6564   handle.launched
-00012820: 5f6e 6f64 6573 290a 0a20 2020 2064 6566  _nodes)..    def
-00012830: 2072 756e 5f72 6179 5f73 7461 7475 735f   run_ray_status_
-00012840: 746f 5f63 6865 636b 5f72 6179 5f63 6c75  to_check_ray_clu
-00012850: 7374 6572 5f68 6561 6c74 6879 2829 202d  ster_healthy() -
-00012860: 3e20 626f 6f6c 3a0a 2020 2020 2020 2020  > bool:.        
-00012870: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00012880: 2023 2054 4f44 4f28 7a68 7775 293a 2054   # TODO(zhwu): T
-00012890: 6869 7320 6675 6e63 7469 6f6e 2063 616e  his function can
-000128a0: 6e6f 7420 6469 7374 696e 6775 6973 6820  not distinguish 
-000128b0: 7472 616e 7369 656e 7420 6e65 7477 6f72  transient networ
-000128c0: 6b0a 2020 2020 2020 2020 2020 2020 2320  k.            # 
-000128d0: 6572 726f 7220 696e 2072 6179 2773 2067  error in ray's g
-000128e0: 6574 2049 5073 2076 732e 2072 6179 2072  et IPs vs. ray r
-000128f0: 756e 7469 6d65 2066 6169 6c69 6e67 2e0a  untime failing..
-00012900: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
-00012910: 4f54 453a 2066 6574 6368 696e 6720 7468  OTE: fetching th
-00012920: 6520 4950 7320 6973 2076 6572 7920 736c  e IPs is very sl
-00012930: 6f77 2061 7320 6974 2063 616c 6c73 2069  ow as it calls i
-00012940: 6e74 6f0a 2020 2020 2020 2020 2020 2020  nto.            
-00012950: 2320 6072 6179 2067 6574 2068 6561 642d  # `ray get head-
-00012960: 6970 2f77 6f72 6b65 722d 6970 7360 2e20  ip/worker-ips`. 
-00012970: 5573 696e 6720 6361 6368 6564 2049 5073  Using cached IPs
-00012980: 2069 7320 7361 6665 2062 6563 6175 7365   is safe because
-00012990: 0a20 2020 2020 2020 2020 2020 2023 2069  .            # i
-000129a0: 6e20 7468 6520 776f 7273 7420 6361 7365  n the worst case
-000129b0: 2077 6520 7469 6d65 206f 7574 2069 6e20   we time out in 
-000129c0: 7468 6520 6072 6179 2073 7461 7475 7360  the `ray status`
-000129d0: 2053 5348 2063 6f6d 6d61 6e64 0a20 2020   SSH command.   
-000129e0: 2020 2020 2020 2020 2023 2062 656c 6f77           # below
-000129f0: 2e0a 2020 2020 2020 2020 2020 2020 6578  ..            ex
-00012a00: 7465 726e 616c 5f69 7073 203d 2068 616e  ternal_ips = han
-00012a10: 646c 652e 6361 6368 6564 5f65 7874 6572  dle.cached_exter
-00012a20: 6e61 6c5f 6970 730a 2020 2020 2020 2020  nal_ips.        
-00012a30: 2020 2020 2320 5468 6973 2068 6170 7065      # This happe
-00012a40: 6e73 2077 6865 6e20 7573 6572 2069 6e74  ns when user int
-00012a50: 6572 7275 7074 2074 6865 2060 736b 7920  errupt the `sky 
-00012a60: 6c61 756e 6368 6020 7072 6f63 6573 7320  launch` process 
-00012a70: 6265 666f 7265 0a20 2020 2020 2020 2020  before.         
-00012a80: 2020 2023 2074 6865 2066 6972 7374 2074     # the first t
-00012a90: 696d 6520 7265 736f 7572 6365 7320 6861  ime resources ha
-00012aa0: 6e64 6c65 2069 7320 7772 6974 7465 6e20  ndle is written 
-00012ab0: 6261 636b 2074 6f20 6c6f 6361 6c20 6461  back to local da
-00012ac0: 7461 6261 7365 2e0a 2020 2020 2020 2020  tabase..        
-00012ad0: 2020 2020 2320 5468 6973 2069 7320 6865      # This is he
-00012ae0: 6c70 6675 6c20 7768 656e 2075 7365 7220  lpful when user 
-00012af0: 696e 7465 7272 7570 7420 6166 7465 7220  interrupt after 
-00012b00: 7468 6520 7072 6f76 6973 696f 6e20 6973  the provision is
-00012b10: 2064 6f6e 650a 2020 2020 2020 2020 2020   done.          
-00012b20: 2020 2320 616e 6420 6265 666f 7265 2074    # and before t
-00012b30: 6865 2073 6b79 6c65 7420 6973 2072 6573  he skylet is res
-00012b40: 7461 7274 6564 2e20 4166 7465 7220 2332  tarted. After #2
-00012b50: 3330 3420 6973 206d 6572 6765 642c 2074  304 is merged, t
-00012b60: 6869 730a 2020 2020 2020 2020 2020 2020  his.            
-00012b70: 2320 6865 6c70 7320 6b65 6570 2074 6865  # helps keep the
-00012b80: 2063 6c75 7374 6572 2073 7461 7475 7320   cluster status 
-00012b90: 746f 2049 4e49 5420 6166 7465 7220 6073  to INIT after `s
-00012ba0: 6b79 2073 7461 7475 7320 2d72 602c 2073  ky status -r`, s
-00012bb0: 6f0a 2020 2020 2020 2020 2020 2020 2320  o.            # 
-00012bc0: 7573 6572 2077 696c 6c20 6265 206e 6f74  user will be not
-00012bd0: 6966 6965 6420 7468 6174 2061 6e79 2061  ified that any a
-00012be0: 7574 6f20 7374 6f70 2f64 6f77 6e20 6d69  uto stop/down mi
-00012bf0: 6768 7420 6e6f 7420 6265 0a20 2020 2020  ght not be.     
-00012c00: 2020 2020 2020 2023 2074 7269 6767 6572         # trigger
-00012c10: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-00012c20: 6966 2065 7874 6572 6e61 6c5f 6970 7320  if external_ips 
-00012c30: 6973 204e 6f6e 6520 6f72 206c 656e 2865  is None or len(e
-00012c40: 7874 6572 6e61 6c5f 6970 7329 203d 3d20  xternal_ips) == 
-00012c50: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-00012c60: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
-00012c70: 6627 5265 6672 6573 6869 6e67 2073 7461  f'Refreshing sta
-00012c80: 7475 7320 287b 636c 7573 7465 725f 6e61  tus ({cluster_na
-00012c90: 6d65 2172 7d29 3a20 4e6f 2063 6163 6865  me!r}): No cache
-00012ca0: 6420 270a 2020 2020 2020 2020 2020 2020  d '.            
-00012cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012cc0: 2066 2749 5073 2066 6f75 6e64 2e20 4861   f'IPs found. Ha
-00012cd0: 6e64 6c65 3a20 7b68 616e 646c 657d 2729  ndle: {handle}')
-00012ce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012cf0: 2072 6169 7365 2065 7863 6570 7469 6f6e   raise exception
-00012d00: 732e 4665 7463 6849 5045 7272 6f72 280a  s.FetchIPError(.
-00012d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012d20: 2020 2020 7265 6173 6f6e 3d65 7863 6570      reason=excep
-00012d30: 7469 6f6e 732e 4665 7463 6849 5045 7272  tions.FetchIPErr
-00012d40: 6f72 2e52 6561 736f 6e2e 4845 4144 290a  or.Reason.HEAD).
-00012d50: 0a20 2020 2020 2020 2020 2020 2023 2050  .            # P
-00012d60: 6f74 656e 7469 616c 6c79 2072 6566 7265  otentially refre
-00012d70: 7368 2074 6865 2065 7874 6572 6e61 6c20  sh the external 
-00012d80: 5353 4820 706f 7274 732c 2069 6e20 6361  SSH ports, in ca
-00012d90: 7365 2074 6865 2065 7869 7374 696e 670a  se the existing.
-00012da0: 2020 2020 2020 2020 2020 2020 2320 636c              # cl
-00012db0: 7573 7465 7220 6265 666f 7265 2023 3234  uster before #24
-00012dc0: 3931 2077 6173 206c 6175 6e63 6865 6420  91 was launched 
-00012dd0: 7769 7468 6f75 7420 6578 7465 726e 616c  without external
-00012de0: 2053 5348 2070 6f72 7473 0a20 2020 2020   SSH ports.     
-00012df0: 2020 2020 2020 2023 2063 6163 6865 642e         # cached.
-00012e00: 0a20 2020 2020 2020 2020 2020 2065 7874  .            ext
-00012e10: 6572 6e61 6c5f 7373 685f 706f 7274 7320  ernal_ssh_ports 
-00012e20: 3d20 6861 6e64 6c65 2e65 7874 6572 6e61  = handle.externa
-00012e30: 6c5f 7373 685f 706f 7274 7328 290a 2020  l_ssh_ports().  
-00012e40: 2020 2020 2020 2020 2020 6865 6164 5f73            head_s
-00012e50: 7368 5f70 6f72 7420 3d20 6578 7465 726e  sh_port = extern
-00012e60: 616c 5f73 7368 5f70 6f72 7473 5b30 5d0a  al_ssh_ports[0].
-00012e70: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
-00012e80: 6865 636b 2069 6620 7261 7920 636c 7573  heck if ray clus
-00012e90: 7465 7220 7374 6174 7573 2069 7320 6865  ter status is he
-00012ea0: 616c 7468 792e 0a20 2020 2020 2020 2020  althy..         
-00012eb0: 2020 2073 7368 5f63 7265 6465 6e74 6961     ssh_credentia
-00012ec0: 6c73 203d 2073 7368 5f63 7265 6465 6e74  ls = ssh_credent
-00012ed0: 6961 6c5f 6672 6f6d 5f79 616d 6c28 6861  ial_from_yaml(ha
-00012ee0: 6e64 6c65 2e63 6c75 7374 6572 5f79 616d  ndle.cluster_yam
-00012ef0: 6c2c 0a20 2020 2020 2020 2020 2020 2020  l,.             
-00012f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f20: 2020 2020 2020 2020 2020 6861 6e64 6c65            handle
-00012f30: 2e64 6f63 6b65 725f 7573 6572 2c0a 2020  .docker_user,.  
-00012f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f70: 2020 2020 2068 616e 646c 652e 7373 685f       handle.ssh_
-00012f80: 7573 6572 290a 0a20 2020 2020 2020 2020  user)..         
-00012f90: 2020 2072 756e 6e65 7220 3d20 636f 6d6d     runner = comm
-00012fa0: 616e 645f 7275 6e6e 6572 2e53 5348 436f  and_runner.SSHCo
-00012fb0: 6d6d 616e 6452 756e 6e65 7228 6578 7465  mmandRunner(exte
-00012fc0: 726e 616c 5f69 7073 5b30 5d2c 0a20 2020  rnal_ips[0],.   
-00012fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013000: 2020 2a2a 7373 685f 6372 6564 656e 7469    **ssh_credenti
-00013010: 616c 732c 0a20 2020 2020 2020 2020 2020  als,.           
-00013020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013040: 2020 2020 2020 2020 2020 706f 7274 3d68            port=h
-00013050: 6561 645f 7373 685f 706f 7274 290a 2020  ead_ssh_port).  
-00013060: 2020 2020 2020 2020 2020 7263 2c20 6f75            rc, ou
-00013070: 7470 7574 2c20 7374 6465 7272 203d 2072  tput, stderr = r
-00013080: 756e 6e65 722e 7275 6e28 0a20 2020 2020  unner.run(.     
-00013090: 2020 2020 2020 2020 2020 2069 6e73 7461             insta
-000130a0: 6e63 655f 7365 7475 702e 5241 595f 5354  nce_setup.RAY_ST
-000130b0: 4154 5553 5f57 4954 485f 534b 595f 5241  ATUS_WITH_SKY_RA
-000130c0: 595f 504f 5254 5f43 4f4d 4d41 4e44 2c0a  Y_PORT_COMMAND,.
-000130d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000130e0: 7374 7265 616d 5f6c 6f67 733d 4661 6c73  stream_logs=Fals
-000130f0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00013100: 2020 2072 6571 7569 7265 5f6f 7574 7075     require_outpu
-00013110: 7473 3d54 7275 652c 0a20 2020 2020 2020  ts=True,.       
-00013120: 2020 2020 2020 2020 2073 6570 6172 6174           separat
-00013130: 655f 7374 6465 7272 3d54 7275 6529 0a20  e_stderr=True). 
-00013140: 2020 2020 2020 2020 2020 2069 6620 7263             if rc
-00013150: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00013160: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
-00013170: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00013180: 2020 2020 2020 2020 2020 6627 5265 6672            f'Refr
-00013190: 6573 6869 6e67 2073 7461 7475 7320 287b  eshing status ({
-000131a0: 636c 7573 7465 725f 6e61 6d65 2172 7d29  cluster_name!r})
-000131b0: 3a20 4661 696c 6564 2074 6f20 6368 6563  : Failed to chec
-000131c0: 6b20 270a 2020 2020 2020 2020 2020 2020  k '.            
-000131d0: 2020 2020 2020 2020 6627 7261 7920 636c          f'ray cl
-000131e0: 7573 7465 725c 2773 2068 6561 6c74 6869  uster\'s healthi
-000131f0: 6e65 7373 2077 6974 6820 270a 2020 2020  ness with '.    
-00013200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013210: 6627 7b69 6e73 7461 6e63 655f 7365 7475  f'{instance_setu
-00013220: 702e 5241 595f 5354 4154 5553 5f57 4954  p.RAY_STATUS_WIT
-00013230: 485f 534b 595f 5241 595f 504f 5254 5f43  H_SKY_RAY_PORT_C
-00013240: 4f4d 4d41 4e44 7d2e 5c6e 270a 2020 2020  OMMAND}.\n'.    
-00013250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013260: 6627 2d2d 2073 7464 6f75 7420 2d2d 5c6e  f'-- stdout --\n
-00013270: 7b6f 7574 7075 747d 5c6e 2d2d 2073 7464  {output}\n-- std
-00013280: 6572 7220 2d2d 5c6e 7b73 7464 6572 727d  err --\n{stderr}
-00013290: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
-000132a0: 7265 6164 795f 6865 6164 2c20 7265 6164  ready_head, read
-000132b0: 795f 776f 726b 6572 7320 3d20 5f63 6f75  y_workers = _cou
-000132c0: 6e74 5f68 6561 6c74 6879 5f6e 6f64 6573  nt_healthy_nodes
-000132d0: 5f66 726f 6d5f 7261 7928 6f75 7470 7574  _from_ray(output
-000132e0: 290a 2020 2020 2020 2020 2020 2020 746f  ).            to
-000132f0: 7461 6c5f 6e6f 6465 7320 3d20 6861 6e64  tal_nodes = hand
-00013300: 6c65 2e6c 6175 6e63 6865 645f 6e6f 6465  le.launched_node
-00013310: 7320 2a20 6861 6e64 6c65 2e6e 756d 5f69  s * handle.num_i
-00013320: 7073 5f70 6572 5f6e 6f64 650a 2020 2020  ps_per_node.    
-00013330: 2020 2020 2020 2020 6966 2072 6561 6479          if ready
-00013340: 5f68 6561 6420 2b20 7265 6164 795f 776f  _head + ready_wo
-00013350: 726b 6572 7320 3d3d 2074 6f74 616c 5f6e  rkers == total_n
-00013360: 6f64 6573 3a0a 2020 2020 2020 2020 2020  odes:.          
-00013370: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
-00013380: 650a 2020 2020 2020 2020 2020 2020 7261  e.            ra
-00013390: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
-000133a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000133b0: 2020 6627 5265 6672 6573 6869 6e67 2073    f'Refreshing s
-000133c0: 7461 7475 7320 287b 636c 7573 7465 725f  tatus ({cluster_
-000133d0: 6e61 6d65 2172 7d29 3a20 7261 7920 7374  name!r}): ray st
-000133e0: 6174 7573 206e 6f74 2073 686f 7769 6e67  atus not showing
-000133f0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00013400: 2020 2066 2761 6c6c 206e 6f64 6573 2028     f'all nodes (
-00013410: 7b72 6561 6479 5f68 6561 6420 2b20 7265  {ready_head + re
-00013420: 6164 795f 776f 726b 6572 737d 2f27 0a20  ady_workers}/'. 
-00013430: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00013440: 277b 746f 7461 6c5f 6e6f 6465 737d 293b  '{total_nodes});
-00013450: 206f 7574 7075 743a 207b 6f75 7470 7574   output: {output
-00013460: 7d3b 2073 7464 6572 723a 207b 7374 6465  }; stderr: {stde
-00013470: 7272 7d27 290a 2020 2020 2020 2020 6578  rr}').        ex
-00013480: 6365 7074 2065 7863 6570 7469 6f6e 732e  cept exceptions.
-00013490: 4665 7463 6849 5045 7272 6f72 3a0a 2020  FetchIPError:.  
-000134a0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-000134b0: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-000134c0: 2020 2020 2020 2020 6627 5265 6672 6573          f'Refres
-000134d0: 6869 6e67 2073 7461 7475 7320 287b 636c  hing status ({cl
-000134e0: 7573 7465 725f 6e61 6d65 2172 7d29 2066  uster_name!r}) f
-000134f0: 6169 6c65 6420 746f 2067 6574 2049 5073  ailed to get IPs
-00013500: 2e27 290a 2020 2020 2020 2020 6578 6365  .').        exce
-00013510: 7074 2052 756e 7469 6d65 4572 726f 7220  pt RuntimeError 
-00013520: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-00013530: 2020 6c6f 6767 6572 2e64 6562 7567 2873    logger.debug(s
-00013540: 7472 2865 2929 0a20 2020 2020 2020 2065  tr(e)).        e
-00013550: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
-00013560: 6173 2065 3a20 2023 2070 796c 696e 743a  as e:  # pylint:
-00013570: 2064 6973 6162 6c65 3d62 726f 6164 2d65   disable=broad-e
-00013580: 7863 6570 740a 2020 2020 2020 2020 2020  xcept.          
-00013590: 2020 2320 5468 6973 2063 616e 2062 6520    # This can be 
-000135a0: 7261 6973 6564 2062 7920 6065 7874 6572  raised by `exter
-000135b0: 6e61 6c5f 7373 685f 706f 7274 7328 2960  nal_ssh_ports()`
-000135c0: 2c20 6475 6520 746f 2074 6865 0a20 2020  , due to the.   
-000135d0: 2020 2020 2020 2020 2023 2075 6e64 6572           # under
-000135e0: 6c79 696e 6720 6361 6c6c 2074 6f20 6b75  lying call to ku
-000135f0: 6265 726e 6574 6573 2041 5049 2e0a 2020  bernetes API..  
-00013600: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00013610: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-00013620: 2020 2020 2020 2020 6627 5265 6672 6573          f'Refres
-00013630: 6869 6e67 2073 7461 7475 7320 287b 636c  hing status ({cl
-00013640: 7573 7465 725f 6e61 6d65 2172 7d29 2066  uster_name!r}) f
-00013650: 6169 6c65 643a 2027 0a20 2020 2020 2020  ailed: '.       
-00013660: 2020 2020 2020 2020 2066 277b 636f 6d6d           f'{comm
-00013670: 6f6e 5f75 7469 6c73 2e66 6f72 6d61 745f  on_utils.format_
-00013680: 6578 6365 7074 696f 6e28 652c 2075 7365  exception(e, use
-00013690: 5f62 7261 636b 6574 3d54 7275 6529 7d27  _bracket=True)}'
-000136a0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-000136b0: 2046 616c 7365 0a0a 2020 2020 2320 4465   False..    # De
-000136c0: 7465 726d 696e 696e 6720 6966 2074 6865  termining if the
-000136d0: 2063 6c75 7374 6572 2069 7320 6865 616c   cluster is heal
-000136e0: 7468 7920 2855 5029 3a0a 2020 2020 230a  thy (UP):.    #.
-000136f0: 2020 2020 2320 466f 7220 6e6f 6e2d 7370      # For non-sp
-00013700: 6f74 2063 6c75 7374 6572 733a 2049 6620  ot clusters: If 
-00013710: 7261 7920 7374 6174 7573 2073 686f 7773  ray status shows
-00013720: 2061 6c6c 206e 6f64 6573 2061 7265 2068   all nodes are h
-00013730: 6561 6c74 6879 2c20 6974 2069 730a 2020  ealthy, it is.  
-00013740: 2020 2320 7361 6665 2074 6f20 7365 7420    # safe to set 
-00013750: 7468 6520 7374 6174 7573 2074 6f20 5550  the status to UP
-00013760: 2061 7320 7374 6172 7469 6e67 2072 6179   as starting ray
-00013770: 2069 7320 7468 6520 6669 6e61 6c20 7374   is the final st
-00013780: 6570 206f 6620 736b 790a 2020 2020 2320  ep of sky.    # 
-00013790: 6c61 756e 6368 2e20 4275 7420 7765 2066  launch. But we f
-000137a0: 6f75 6e64 2074 6861 7420 7261 7920 7374  ound that ray st
-000137b0: 6174 7573 2069 7320 7761 7920 746f 6f20  atus is way too 
-000137c0: 736c 6f77 2028 7365 6520 4e4f 5445 2062  slow (see NOTE b
-000137d0: 656c 6f77 2920 736f 0a20 2020 2023 2077  elow) so.    # w
-000137e0: 6520 616c 7761 7973 2071 7565 7279 2074  e always query t
-000137f0: 6865 2063 6c6f 7564 2070 726f 7669 6465  he cloud provide
-00013800: 7220 6669 7273 7420 7768 6963 6820 6973  r first which is
-00013810: 2066 6173 7465 722e 0a20 2020 2023 0a20   faster..    #. 
-00013820: 2020 2023 2046 6f72 2073 706f 7420 636c     # For spot cl
-00013830: 7573 7465 7273 3a20 7468 6520 6162 6f76  usters: the abov
-00013840: 6520 6361 6e20 6265 2075 6e73 6166 6520  e can be unsafe 
-00013850: 6265 6361 7573 6520 7468 6520 5261 7920  because the Ray 
-00013860: 636c 7573 7465 7220 6d61 790a 2020 2020  cluster may.    
-00013870: 2320 7265 6d61 696e 2068 6561 6c74 6879  # remain healthy
-00013880: 2066 6f72 2061 2077 6869 6c65 2062 6566   for a while bef
-00013890: 6f72 6520 7468 6520 636c 6f75 6420 636f  ore the cloud co
-000138a0: 6d70 6c65 7465 6c79 2070 7265 656d 7074  mpletely preempt
-000138b0: 7320 7468 6520 564d 732e 0a20 2020 2023  s the VMs..    #
-000138c0: 2057 6520 6861 7665 206d 6974 6967 6174   We have mitigat
-000138d0: 6564 2074 6869 7320 6279 2061 6761 696e  ed this by again
-000138e0: 2066 6972 7374 2071 7565 7279 696e 6720   first querying 
-000138f0: 7468 6520 564d 2073 7461 7465 2066 726f  the VM state fro
-00013900: 6d20 7468 6520 636c 6f75 640a 2020 2020  m the cloud.    
-00013910: 2320 7072 6f76 6964 6572 2e0a 2020 2020  # provider..    
-00013920: 6966 2061 6c6c 5f6e 6f64 6573 5f75 7020  if all_nodes_up 
-00013930: 616e 6420 7275 6e5f 7261 795f 7374 6174  and run_ray_stat
-00013940: 7573 5f74 6f5f 6368 6563 6b5f 7261 795f  us_to_check_ray_
-00013950: 636c 7573 7465 725f 6865 616c 7468 7928  cluster_healthy(
-00013960: 293a 0a20 2020 2020 2020 2023 204e 4f54  ):.        # NOT
-00013970: 453a 2061 6c6c 5f6e 6f64 6573 5f75 7020  E: all_nodes_up 
-00013980: 6361 6c63 756c 6174 696f 6e20 6973 2066  calculation is f
-00013990: 6173 7420 6475 6520 746f 2063 616c 6c69  ast due to calli
-000139a0: 6e67 2063 6c6f 7564 2043 4c49 3b0a 2020  ng cloud CLI;.  
-000139b0: 2020 2020 2020 2320 7275 6e5f 7261 795f        # run_ray_
-000139c0: 7374 6174 7573 5f74 6f5f 6368 6563 6b5f  status_to_check_
-000139d0: 616c 6c5f 6e6f 6465 735f 7570 2829 2069  all_nodes_up() i
-000139e0: 7320 736c 6f77 2064 7565 2074 6f20 6361  s slow due to ca
-000139f0: 6c6c 696e 6720 6072 6179 2067 6574 0a20  lling `ray get. 
-00013a00: 2020 2020 2020 2023 2068 6561 642d 6970         # head-ip
-00013a10: 2f77 6f72 6b65 722d 6970 7360 2e0a 2020  /worker-ips`..  
-00013a20: 2020 2020 2020 7265 636f 7264 5b27 7374        record['st
-00013a30: 6174 7573 275d 203d 2073 7461 7475 735f  atus'] = status_
-00013a40: 6c69 622e 436c 7573 7465 7253 7461 7475  lib.ClusterStatu
-00013a50: 732e 5550 0a20 2020 2020 2020 2067 6c6f  s.UP.        glo
-00013a60: 6261 6c5f 7573 6572 5f73 7461 7465 2e61  bal_user_state.a
-00013a70: 6464 5f6f 725f 7570 6461 7465 5f63 6c75  dd_or_update_clu
-00013a80: 7374 6572 2863 6c75 7374 6572 5f6e 616d  ster(cluster_nam
-00013a90: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00013aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ac0: 2020 2068 616e 646c 652c 0a20 2020 2020     handle,.     
-00013ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013af0: 2020 2020 2020 2020 2020 2072 6571 7565             reque
-00013b00: 7374 6564 5f72 6573 6f75 7263 6573 3d4e  sted_resources=N
-00013b10: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-00013b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b40: 2020 2020 2072 6561 6479 3d54 7275 652c       ready=True,
-00013b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b80: 2069 735f 6c61 756e 6368 3d46 616c 7365   is_launch=False
-00013b90: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00013ba0: 2072 6563 6f72 640a 0a20 2020 2023 2041   record..    # A
-00013bb0: 6c6c 2063 6173 6573 2062 656c 6f77 2061  ll cases below a
-00013bc0: 7265 2074 7261 6e73 6974 696f 6e69 6e67  re transitioning
-00013bd0: 2074 6865 2063 6c75 7374 6572 2074 6f20   the cluster to 
-00013be0: 6e6f 6e2d 5550 2073 7461 7465 732e 0a20  non-UP states.. 
-00013bf0: 2020 2069 6620 6c65 6e28 6e6f 6465 5f73     if len(node_s
-00013c00: 7461 7475 7365 7329 203e 2068 616e 646c  tatuses) > handl
-00013c10: 652e 6c61 756e 6368 6564 5f6e 6f64 6573  e.launched_nodes
-00013c20: 3a0a 2020 2020 2020 2020 2320 556e 6578  :.        # Unex
-00013c30: 7065 6374 6564 3a20 696e 2074 6865 2071  pected: in the q
-00013c40: 7565 7269 6564 2072 6567 696f 6e20 6d6f  ueried region mo
-00013c50: 7265 2074 6861 6e20 3120 636c 7573 7465  re than 1 cluste
-00013c60: 7220 7769 7468 2074 6865 2073 616d 650a  r with the same.
-00013c70: 2020 2020 2020 2020 2320 636f 6e73 7472          # constr
-00013c80: 7563 7465 6420 6e61 6d65 2074 6167 2072  ucted name tag r
-00013c90: 6574 7572 6e65 642e 2054 6869 7320 7769  eturned. This wi
-00013ca0: 6c6c 2074 7970 6963 616c 6c79 206e 6f74  ll typically not
-00013cb0: 2068 6170 7065 6e20 756e 6c65 7373 0a20   happen unless. 
-00013cc0: 2020 2020 2020 2023 2075 7365 7273 206d         # users m
-00013cd0: 616e 7561 6c6c 7920 6372 6561 7465 2061  anually create a
-00013ce0: 2063 6c75 7374 6572 2077 6974 6820 7468   cluster with th
-00013cf0: 6174 2063 6f6e 7374 7275 6374 6564 206e  at constructed n
-00013d00: 616d 6520 6f72 2074 6865 7265 0a20 2020  ame or there.   
-00013d10: 2020 2020 2023 2077 6173 2061 2072 6573       # was a res
-00013d20: 6f75 7263 6520 6c65 616b 2063 6175 7365  ource leak cause
-00013d30: 6420 6279 2064 6966 6665 7265 6e74 206c  d by different l
-00013d40: 6175 6e63 6820 6861 7368 2062 6566 6f72  aunch hash befor
-00013d50: 6520 2331 3637 310a 2020 2020 2020 2020  e #1671.        
-00013d60: 2320 7761 7320 6d65 7267 6564 2e0a 2020  # was merged..  
-00013d70: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
-00013d80: 2320 2854 6563 686e 6963 616c 6c79 2073  # (Technically s
-00013d90: 7065 616b 696e 672c 2065 7665 6e20 6966  peaking, even if
-00013da0: 2072 6574 7572 6e65 6420 6e75 6d20 6e6f   returned num no
-00013db0: 6465 7320 3c3d 206e 756d 0a20 2020 2020  des <= num.     
-00013dc0: 2020 2023 2068 616e 646c 652e 6c61 756e     # handle.laun
-00013dd0: 6368 6564 5f6e 6f64 6573 292c 206e 6f74  ched_nodes), not
-00013de0: 2069 6e63 6c75 6469 6e67 2074 6865 206c   including the l
-00013df0: 6175 6e63 6820 6861 7368 2063 6f75 6c64  aunch hash could
-00013e00: 206d 6561 6e20 7468 650a 2020 2020 2020   mean the.      
-00013e10: 2020 2320 7265 7475 726e 6564 206e 6f64    # returned nod
-00013e20: 6573 2063 6f6e 7461 696e 2073 6f6d 6520  es contain some 
-00013e30: 6e6f 6465 7320 7468 6174 2064 6f20 6e6f  nodes that do no
-00013e40: 7420 6265 6c6f 6e67 2074 6f20 7468 6520  t belong to the 
-00013e50: 6c6f 6769 6361 6c0a 2020 2020 2020 2020  logical.        
-00013e60: 2320 736b 7970 696c 6f74 2063 6c75 7374  # skypilot clust
-00013e70: 6572 2e20 446f 6573 6e27 7420 7365 656d  er. Doesn't seem
-00013e80: 2074 6f20 6265 2061 2067 6f6f 6420 7761   to be a good wa
-00013e90: 7920 746f 2068 616e 646c 6520 7468 6973  y to handle this
-00013ea0: 2066 6f72 0a20 2020 2020 2020 2023 206e   for.        # n
-00013eb0: 6f77 3f29 0a20 2020 2020 2020 2023 0a20  ow?).        #. 
-00013ec0: 2020 2020 2020 2023 2057 6520 6861 7665         # We have
-00013ed0: 206e 6f74 2065 7870 6572 6965 6e63 6564   not experienced
-00013ee0: 2074 6865 2061 626f 7665 3b20 6164 6469   the above; addi
-00013ef0: 6e67 2061 7320 6120 7361 6665 6775 6172  ng as a safeguar
-00013f00: 642e 0a20 2020 2020 2020 2023 0a20 2020  d..        #.   
-00013f10: 2020 2020 2023 2053 696e 6365 2077 6520       # Since we 
-00013f20: 6661 696c 6564 2074 6f20 7265 6672 6573  failed to refres
-00013f30: 682c 2072 6169 7365 2074 6865 2073 7461  h, raise the sta
-00013f40: 7475 7320 6665 7463 6869 6e67 2065 7272  tus fetching err
-00013f50: 6f72 2e0a 2020 2020 2020 2020 7769 7468  or..        with
-00013f60: 2075 785f 7574 696c 732e 7072 696e 745f   ux_utils.print_
-00013f70: 6578 6365 7074 696f 6e5f 6e6f 5f74 7261  exception_no_tra
-00013f80: 6365 6261 636b 2829 3a0a 2020 2020 2020  ceback():.      
-00013f90: 2020 2020 2020 7261 6973 6520 6578 6365        raise exce
-00013fa0: 7074 696f 6e73 2e43 6c75 7374 6572 5374  ptions.ClusterSt
-00013fb0: 6174 7573 4665 7463 6869 6e67 4572 726f  atusFetchingErro
-00013fc0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-00013fd0: 2020 2066 2746 6f75 6e64 207b 6c65 6e28     f'Found {len(
-00013fe0: 6e6f 6465 5f73 7461 7475 7365 7329 7d20  node_statuses)} 
-00013ff0: 6e6f 6465 2873 2920 7769 7468 2074 6865  node(s) with the
-00014000: 2073 616d 6520 636c 7573 7465 7220 6e61   same cluster na
-00014010: 6d65 270a 2020 2020 2020 2020 2020 2020  me'.            
-00014020: 2020 2020 6627 2074 6167 2069 6e20 7468      f' tag in th
-00014030: 6520 636c 6f75 6420 7072 6f76 6964 6572  e cloud provider
-00014040: 2066 6f72 2063 6c75 7374 6572 207b 636c   for cluster {cl
-00014050: 7573 7465 725f 6e61 6d65 2172 7d2c 2027  uster_name!r}, '
-00014060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014070: 2066 2777 6869 6368 2073 686f 756c 6420   f'which should 
-00014080: 6861 7665 207b 6861 6e64 6c65 2e6c 6175  have {handle.lau
-00014090: 6e63 6865 645f 6e6f 6465 737d 206e 6f64  nched_nodes} nod
-000140a0: 6573 2e20 5468 6973 2027 0a20 2020 2020  es. This '.     
-000140b0: 2020 2020 2020 2020 2020 2066 276e 6f72             f'nor
-000140c0: 6d61 6c6c 7920 7368 6f75 6c64 206e 6f74  mally should not
-000140d0: 2068 6170 7065 6e2e 207b 636f 6c6f 7261   happen. {colora
-000140e0: 6d61 2e46 6f72 652e 5245 447d 506c 6561  ma.Fore.RED}Plea
-000140f0: 7365 2063 6865 636b 2027 0a20 2020 2020  se check '.     
-00014100: 2020 2020 2020 2020 2020 2027 7468 6520             'the 
-00014110: 636c 6f75 6420 636f 6e73 6f6c 6520 616e  cloud console an
-00014120: 6420 6669 7820 616e 7920 706f 7373 6962  d fix any possib
-00014130: 6c65 2072 6573 6f75 7263 6573 206c 6561  le resources lea
-00014140: 6b61 6765 2027 0a20 2020 2020 2020 2020  kage '.         
-00014150: 2020 2020 2020 2027 2865 2e67 2e2c 2069         '(e.g., i
-00014160: 6620 7468 6572 6520 6172 6520 616e 7920  f there are any 
-00014170: 7374 6f70 7065 6420 6e6f 6465 7320 616e  stopped nodes an
-00014180: 6420 7468 6579 2064 6f20 6e6f 7420 6861  d they do not ha
-00014190: 7665 2027 0a20 2020 2020 2020 2020 2020  ve '.           
-000141a0: 2020 2020 2027 6461 7461 206f 7220 6172       'data or ar
-000141b0: 6520 756e 6865 616c 7468 792c 2074 6572  e unhealthy, ter
-000141c0: 6d69 6e61 7465 2074 6865 6d29 2e27 0a20  minate them).'. 
-000141d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000141e0: 277b 636f 6c6f 7261 6d61 2e53 7479 6c65  '{colorama.Style
-000141f0: 2e52 4553 4554 5f41 4c4c 7d27 290a 2020  .RESET_ALL}').  
-00014200: 2020 6173 7365 7274 206c 656e 286e 6f64    assert len(nod
-00014210: 655f 7374 6174 7573 6573 2920 3c3d 2068  e_statuses) <= h
-00014220: 616e 646c 652e 6c61 756e 6368 6564 5f6e  andle.launched_n
-00014230: 6f64 6573 0a0a 2020 2020 2320 4966 2074  odes..    # If t
-00014240: 6865 206e 6f64 655f 7374 6174 7573 6573  he node_statuses
-00014250: 2069 7320 656d 7074 792c 2061 6c6c 2074   is empty, all t
-00014260: 6865 206e 6f64 6573 2061 7265 2074 6572  he nodes are ter
-00014270: 6d69 6e61 7465 642e 2057 6520 6361 6e0a  minated. We can.
-00014280: 2020 2020 2320 7361 6665 6c79 2073 6574      # safely set
-00014290: 2074 6865 2063 6c75 7374 6572 2073 7461   the cluster sta
-000142a0: 7475 7320 746f 2054 4552 4d49 4e41 5445  tus to TERMINATE
-000142b0: 442e 2054 6869 7320 6861 6e64 6c65 7320  D. This handles 
-000142c0: 7468 6520 6564 6765 2063 6173 650a 2020  the edge case.  
-000142d0: 2020 2320 7768 6572 6520 7468 6520 636c    # where the cl
-000142e0: 7573 7465 7220 6973 2074 6572 6d69 6e61  uster is termina
-000142f0: 7465 6420 6279 2074 6865 2075 7365 7220  ted by the user 
-00014300: 6d61 6e75 616c 6c79 2074 6872 6f75 6768  manually through
-00014310: 2074 6865 2055 492e 0a20 2020 2074 6f5f   the UI..    to_
-00014320: 7465 726d 696e 6174 6520 3d20 6e6f 7420  terminate = not 
-00014330: 6e6f 6465 5f73 7461 7475 7365 730a 0a20  node_statuses.. 
-00014340: 2020 2023 2041 2063 6c75 7374 6572 2069     # A cluster i
-00014350: 7320 636f 6e73 6964 6572 6564 2022 6162  s considered "ab
-00014360: 6e6f 726d 616c 222c 2069 6620 6e6f 7420  normal", if not 
-00014370: 616c 6c20 6e6f 6465 7320 6172 6520 5445  all nodes are TE
-00014380: 524d 494e 4154 4544 206f 720a 2020 2020  RMINATED or.    
-00014390: 2320 6e6f 7420 616c 6c20 6e6f 6465 7320  # not all nodes 
-000143a0: 6172 6520 5354 4f50 5045 442e 2057 6520  are STOPPED. We 
-000143b0: 6368 6563 6b20 7468 6174 2077 6974 6820  check that with 
-000143c0: 7468 6520 666f 6c6c 6f77 696e 6720 6c6f  the following lo
-000143d0: 6769 633a 0a20 2020 2023 2020 202a 204e  gic:.    #   * N
-000143e0: 6f74 2061 6c6c 206e 6f64 6573 2061 7265  ot all nodes are
-000143f0: 2074 6572 6d69 6e61 7465 6420 616e 6420   terminated and 
-00014400: 7468 6572 6527 7320 6174 206c 6561 7374  there's at least
-00014410: 206f 6e65 206e 6f64 650a 2020 2020 2320   one node.    # 
-00014420: 2020 2020 7465 726d 696e 6174 6564 3b20      terminated; 
-00014430: 6f72 0a20 2020 2023 2020 202a 2041 6e79  or.    #   * Any
-00014440: 206f 6620 7468 6520 6e6f 6e2d 5445 524d   of the non-TERM
-00014450: 494e 4154 4544 206e 6f64 6573 2069 7320  INATED nodes is 
-00014460: 696e 2061 206e 6f6e 2d53 544f 5050 4544  in a non-STOPPED
-00014470: 2073 7461 7475 732e 0a20 2020 2023 0a20   status..    #. 
-00014480: 2020 2023 2054 6869 7320 696e 636c 7564     # This includ
-00014490: 6573 2074 6865 7365 2073 7065 6369 616c  es these special
-000144a0: 2063 6173 6573 3a0a 2020 2020 2320 2020   cases:.    #   
-000144b0: 2a20 416c 6c20 7374 6f70 7065 6420 6172  * All stopped ar
-000144c0: 6520 636f 6e73 6964 6572 6564 206e 6f72  e considered nor
-000144d0: 6d61 6c20 616e 6420 7769 6c6c 2062 6520  mal and will be 
-000144e0: 636c 6561 6e65 6420 7570 2061 7420 7468  cleaned up at th
-000144f0: 6520 656e 640a 2020 2020 2320 2020 2020  e end.    #     
-00014500: 6f66 2074 6865 2066 756e 6374 696f 6e2e  of the function.
-00014510: 0a20 2020 2023 2020 202a 2053 6f6d 6520  .    #   * Some 
-00014520: 6f66 2074 6865 206e 6f64 6573 2055 5020  of the nodes UP 
-00014530: 7368 6f75 6c64 2062 6520 636f 6e73 6964  should be consid
-00014540: 6572 6564 2061 626e 6f72 6d61 6c2c 2062  ered abnormal, b
-00014550: 6563 6175 7365 2074 6865 2072 6179 0a20  ecause the ray. 
-00014560: 2020 2023 2020 2020 2063 6c75 7374 6572     #     cluster
-00014570: 2069 7320 7072 6f62 6162 6c79 2064 6f77   is probably dow
-00014580: 6e2e 0a20 2020 2023 2020 202a 2054 6865  n..    #   * The
-00014590: 2063 6c75 7374 6572 2069 7320 7061 7274   cluster is part
-000145a0: 6961 6c6c 7920 7465 726d 696e 6174 6564  ially terminated
-000145b0: 206f 7220 7374 6f70 7065 6420 7368 6f75   or stopped shou
-000145c0: 6c64 2062 6520 636f 6e73 6964 6572 6564  ld be considered
-000145d0: 0a20 2020 2023 2020 2020 2061 626e 6f72  .    #     abnor
-000145e0: 6d61 6c2e 0a20 2020 2023 0a20 2020 2023  mal..    #.    #
-000145f0: 2041 6e20 6162 6e6f 726d 616c 2063 6c75   An abnormal clu
-00014600: 7374 6572 2077 696c 6c20 7472 616e 7369  ster will transi
-00014610: 7469 6f6e 2074 6f20 494e 4954 2061 6e64  tion to INIT and
-00014620: 2068 6176 6520 616e 7920 6175 746f 7374   have any autost
-00014630: 6f70 2073 6574 7469 6e67 0a20 2020 2023  op setting.    #
-00014640: 2072 6573 6574 2028 756e 6c65 7373 2069   reset (unless i
-00014650: 7427 7320 6175 746f 7374 6f70 7069 6e67  t's autostopping
-00014660: 2f61 7574 6f64 6f77 6e69 6e67 292e 0a20  /autodowning).. 
-00014670: 2020 2069 735f 6162 6e6f 726d 616c 203d     is_abnormal =
-00014680: 2028 2830 203c 206c 656e 286e 6f64 655f   ((0 < len(node_
-00014690: 7374 6174 7573 6573 2920 3c20 6861 6e64  statuses) < hand
-000146a0: 6c65 2e6c 6175 6e63 6865 645f 6e6f 6465  le.launched_node
-000146b0: 7329 206f 7220 616e 7928 0a20 2020 2020  s) or any(.     
-000146c0: 2020 2073 7461 7475 7320 213d 2073 7461     status != sta
-000146d0: 7475 735f 6c69 622e 436c 7573 7465 7253  tus_lib.ClusterS
-000146e0: 7461 7475 732e 5354 4f50 5045 4420 666f  tatus.STOPPED fo
-000146f0: 7220 7374 6174 7573 2069 6e20 6e6f 6465  r status in node
-00014700: 5f73 7461 7475 7365 7329 290a 2020 2020  _statuses)).    
-00014710: 6966 2069 735f 6162 6e6f 726d 616c 3a0a  if is_abnormal:.
-00014720: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
-00014730: 6562 7567 2827 5468 6520 636c 7573 7465  ebug('The cluste
-00014740: 7220 6973 2061 626e 6f72 6d61 6c2e 2053  r is abnormal. S
-00014750: 6574 7469 6e67 2074 6f20 494e 4954 2073  etting to INIT s
-00014760: 7461 7475 732e 2027 0a20 2020 2020 2020  tatus. '.       
-00014770: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00014780: 6e6f 6465 5f73 7461 7475 7365 733a 207b  node_statuses: {
-00014790: 6e6f 6465 5f73 7461 7475 7365 737d 2729  node_statuses}')
-000147a0: 0a20 2020 2020 2020 2062 6163 6b65 6e64  .        backend
-000147b0: 203d 2067 6574 5f62 6163 6b65 6e64 5f66   = get_backend_f
-000147c0: 726f 6d5f 6861 6e64 6c65 2868 616e 646c  rom_handle(handl
-000147d0: 6529 0a20 2020 2020 2020 2069 6620 6973  e).        if is
-000147e0: 696e 7374 616e 6365 2862 6163 6b65 6e64  instance(backend
-000147f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00014800: 2020 2020 2020 2020 6261 636b 656e 6473          backends
-00014810: 2e43 6c6f 7564 566d 5261 7942 6163 6b65  .CloudVmRayBacke
-00014820: 6e64 2920 616e 6420 7265 636f 7264 5b27  nd) and record['
-00014830: 6175 746f 7374 6f70 275d 203e 3d20 303a  autostop'] >= 0:
-00014840: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00014850: 6e6f 7420 6261 636b 656e 642e 6973 5f64  not backend.is_d
-00014860: 6566 696e 6974 656c 795f 6175 746f 7374  efinitely_autost
-00014870: 6f70 7069 6e67 2868 616e 646c 652c 0a20  opping(handle,. 
-00014880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000148a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000148b0: 2020 2020 2073 7472 6561 6d5f 6c6f 6773       stream_logs
-000148c0: 3d46 616c 7365 293a 0a20 2020 2020 2020  =False):.       
-000148d0: 2020 2020 2020 2020 2023 2046 7269 656e           # Frien
-000148e0: 646c 7920 6869 6e74 2e0a 2020 2020 2020  dly hint..      
-000148f0: 2020 2020 2020 2020 2020 6175 746f 7374            autost
-00014900: 6f70 203d 2072 6563 6f72 645b 2761 7574  op = record['aut
-00014910: 6f73 746f 7027 5d0a 2020 2020 2020 2020  ostop'].        
-00014920: 2020 2020 2020 2020 6d61 7962 655f 646f          maybe_do
-00014930: 776e 5f73 7472 203d 2027 202d 2d64 6f77  wn_str = ' --dow
-00014940: 6e27 2069 6620 7265 636f 7264 5b27 746f  n' if record['to
-00014950: 5f64 6f77 6e27 5d20 656c 7365 2027 270a  _down'] else ''.
-00014960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014970: 6e6f 756e 203d 2027 6175 746f 646f 776e  noun = 'autodown
-00014980: 2720 6966 2072 6563 6f72 645b 2774 6f5f  ' if record['to_
-00014990: 646f 776e 275d 2065 6c73 6520 2761 7574  down'] else 'aut
-000149a0: 6f73 746f 7027 0a0a 2020 2020 2020 2020  ostop'..        
-000149b0: 2020 2020 2020 2020 2320 5265 7365 7420          # Reset 
-000149c0: 7468 6520 6175 746f 7374 6f70 7069 6e67  the autostopping
-000149d0: 2061 7320 7468 6520 636c 7573 7465 7220   as the cluster 
-000149e0: 6973 2061 626e 6f72 6d61 6c2c 2061 6e64  is abnormal, and
-000149f0: 206d 6179 0a20 2020 2020 2020 2020 2020   may.           
-00014a00: 2020 2020 2023 206e 6f74 2063 6f72 7265       # not corre
-00014a10: 6374 6c79 2061 7574 6f73 746f 702e 2052  ctly autostop. R
-00014a20: 6573 6574 7469 6e67 2074 6865 2061 7574  esetting the aut
-00014a30: 6f73 746f 7020 7769 6c6c 206c 6574 0a20  ostop will let. 
-00014a40: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00014a50: 2074 6865 2075 7365 7220 6b6e 6f77 2074   the user know t
-00014a60: 6861 7420 7468 6520 6175 746f 7374 6f70  hat the autostop
-00014a70: 206d 6179 206e 6f74 2068 6170 7065 6e20   may not happen 
-00014a80: 746f 2061 766f 6964 0a20 2020 2020 2020  to avoid.       
-00014a90: 2020 2020 2020 2020 2023 206c 6561 6b61           # leaka
-00014aa0: 6765 7320 6672 6f6d 2074 6865 2061 7373  ges from the ass
-00014ab0: 756d 7074 696f 6e20 7468 6174 2074 6865  umption that the
-00014ac0: 2063 6c75 7374 6572 2077 696c 6c20 6175   cluster will au
-00014ad0: 746f 7374 6f70 2e0a 2020 2020 2020 2020  tostop..        
-00014ae0: 2020 2020 2020 2020 7375 6363 6573 7320          success 
-00014af0: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
-00014b00: 2020 2020 2020 2072 6573 6574 5f6c 6f63         reset_loc
-00014b10: 616c 5f61 7574 6f73 746f 7020 3d20 5472  al_autostop = Tr
-00014b20: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
-00014b30: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00014b40: 2020 2020 2020 2020 2020 2020 6261 636b              back
-00014b50: 656e 642e 7365 745f 6175 746f 7374 6f70  end.set_autostop
-00014b60: 2868 616e 646c 652c 202d 312c 2073 7472  (handle, -1, str
-00014b70: 6561 6d5f 6c6f 6773 3d46 616c 7365 290a  eam_logs=False).
-00014b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b90: 6578 6365 7074 2065 7863 6570 7469 6f6e  except exception
-00014ba0: 732e 436f 6d6d 616e 6445 7272 6f72 2061  s.CommandError a
-00014bb0: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-00014bc0: 2020 2020 2020 2020 2073 7563 6365 7373           success
-00014bd0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-00014be0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00014bf0: 652e 7265 7475 726e 636f 6465 203d 3d20  e.returncode == 
-00014c00: 3235 353a 0a20 2020 2020 2020 2020 2020  255:.           
-00014c10: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-00014c20: 6765 722e 6465 6275 6728 6627 5468 6520  ger.debug(f'The 
-00014c30: 636c 7573 7465 7220 6973 206c 696b 656c  cluster is likel
-00014c40: 7920 7b6e 6f75 6e7d 6564 2e27 290a 2020  y {noun}ed.').  
-00014c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014c60: 2020 2020 2020 7265 7365 745f 6c6f 6361        reset_loca
-00014c70: 6c5f 6175 746f 7374 6f70 203d 2046 616c  l_autostop = Fal
-00014c80: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-00014c90: 2020 2065 7863 6570 7420 2845 7863 6570     except (Excep
-00014ca0: 7469 6f6e 2c20 5379 7374 656d 4578 6974  tion, SystemExit
-00014cb0: 2920 6173 2065 3a20 2023 2070 796c 696e  ) as e:  # pylin
-00014cc0: 743a 2064 6973 6162 6c65 3d62 726f 6164  t: disable=broad
-00014cd0: 2d65 7863 6570 740a 2020 2020 2020 2020  -except.        
-00014ce0: 2020 2020 2020 2020 2020 2020 7375 6363              succ
-00014cf0: 6573 7320 3d20 4661 6c73 650a 2020 2020  ess = False.    
-00014d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014d10: 6c6f 6767 6572 2e64 6562 7567 2866 2746  logger.debug(f'F
-00014d20: 6169 6c65 6420 746f 2072 6573 6574 2061  ailed to reset a
-00014d30: 7574 6f73 746f 702e 2044 7565 2074 6f20  utostop. Due to 
-00014d40: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00014d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014d60: 2020 2066 277b 636f 6d6d 6f6e 5f75 7469     f'{common_uti
-00014d70: 6c73 2e66 6f72 6d61 745f 6578 6365 7074  ls.format_except
-00014d80: 696f 6e28 6529 7d27 290a 2020 2020 2020  ion(e)}').      
-00014d90: 2020 2020 2020 2020 2020 6966 2072 6573            if res
-00014da0: 6574 5f6c 6f63 616c 5f61 7574 6f73 746f  et_local_autosto
-00014db0: 703a 0a20 2020 2020 2020 2020 2020 2020  p:.             
-00014dc0: 2020 2020 2020 2067 6c6f 6261 6c5f 7573         global_us
-00014dd0: 6572 5f73 7461 7465 2e73 6574 5f63 6c75  er_state.set_clu
-00014de0: 7374 6572 5f61 7574 6f73 746f 705f 7661  ster_autostop_va
-00014df0: 6c75 6528 0a20 2020 2020 2020 2020 2020  lue(.           
-00014e00: 2020 2020 2020 2020 2020 2020 2068 616e               han
-00014e10: 646c 652e 636c 7573 7465 725f 6e61 6d65  dle.cluster_name
-00014e20: 2c20 2d31 2c20 746f 5f64 6f77 6e3d 4661  , -1, to_down=Fa
-00014e30: 6c73 6529 0a0a 2020 2020 2020 2020 2020  lse)..          
-00014e40: 2020 2020 2020 6966 2073 7563 6365 7373        if success
-00014e50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00014e60: 2020 2020 2020 6f70 6572 6174 696f 6e5f        operation_
-00014e70: 7374 7220 3d20 2866 2743 616e 6365 6c65  str = (f'Cancele
-00014e80: 6420 7b6e 6f75 6e7d 206f 6e20 7468 6520  d {noun} on the 
-00014e90: 636c 7573 7465 7220 270a 2020 2020 2020  cluster '.      
-00014ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014eb0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00014ec0: 277b 636c 7573 7465 725f 6e61 6d65 2172  '{cluster_name!r
-00014ed0: 7d27 290a 2020 2020 2020 2020 2020 2020  }').            
-00014ee0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00014ef0: 2020 2020 2020 2020 2020 2020 2020 6f70                op
-00014f00: 6572 6174 696f 6e5f 7374 7220 3d20 280a  eration_str = (.
-00014f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f20: 2020 2020 2020 2020 6627 4174 7465 6d70          f'Attemp
-00014f30: 7465 6420 746f 2063 616e 6365 6c20 7b6e  ted to cancel {n
-00014f40: 6f75 6e7d 206f 6e20 7468 6520 270a 2020  oun} on the '.  
-00014f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f60: 2020 2020 2020 6627 636c 7573 7465 7220        f'cluster 
-00014f70: 7b63 6c75 7374 6572 5f6e 616d 6521 727d  {cluster_name!r}
-00014f80: 2077 6974 6820 6265 7374 2065 6666 6f72   with best effor
-00014f90: 7427 290a 2020 2020 2020 2020 2020 2020  t').            
-00014fa0: 2020 2020 7965 6c6c 6f77 203d 2063 6f6c      yellow = col
-00014fb0: 6f72 616d 612e 466f 7265 2e59 454c 4c4f  orama.Fore.YELLO
-00014fc0: 570a 2020 2020 2020 2020 2020 2020 2020  W.              
-00014fd0: 2020 6272 6967 6874 203d 2063 6f6c 6f72    bright = color
-00014fe0: 616d 612e 5374 796c 652e 4252 4947 4854  ama.Style.BRIGHT
-00014ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015000: 2072 6573 6574 203d 2063 6f6c 6f72 616d   reset = coloram
-00015010: 612e 5374 796c 652e 5245 5345 545f 414c  a.Style.RESET_AL
-00015020: 4c0a 2020 2020 2020 2020 2020 2020 2020  L.              
-00015030: 2020 7578 5f75 7469 6c73 2e63 6f6e 736f    ux_utils.conso
-00015040: 6c65 5f6e 6577 6c69 6e65 2829 0a20 2020  le_newline().   
-00015050: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-00015060: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
-00015070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015080: 2066 277b 7965 6c6c 6f77 7d7b 6f70 6572   f'{yellow}{oper
-00015090: 6174 696f 6e5f 7374 727d 2c20 7369 6e63  ation_str}, sinc
-000150a0: 6520 6974 2069 7320 666f 756e 6420 746f  e it is found to
-000150b0: 2062 6520 696e 2061 6e20 270a 2020 2020   be in an '.    
-000150c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000150d0: 6627 6162 6e6f 726d 616c 2073 7461 7465  f'abnormal state
-000150e0: 2e20 546f 2066 6978 2c20 7472 7920 7275  . To fix, try ru
-000150f0: 6e6e 696e 673a 207b 7265 7365 747d 7b62  nning: {reset}{b
-00015100: 7269 6768 747d 736b 7920 270a 2020 2020  right}sky '.    
-00015110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015120: 6627 7374 6172 7420 2d66 202d 6920 7b61  f'start -f -i {a
-00015130: 7574 6f73 746f 707d 7b6d 6179 6265 5f64  utostop}{maybe_d
-00015140: 6f77 6e5f 7374 727d 207b 636c 7573 7465  own_str} {cluste
-00015150: 725f 6e61 6d65 7d27 0a20 2020 2020 2020  r_name}'.       
-00015160: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
-00015170: 7265 7365 747d 2729 0a20 2020 2020 2020  reset}').       
-00015180: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00015190: 2020 2020 2020 2020 2020 2075 785f 7574             ux_ut
-000151a0: 696c 732e 636f 6e73 6f6c 655f 6e65 776c  ils.console_newl
-000151b0: 696e 6528 290a 2020 2020 2020 2020 2020  ine().          
-000151c0: 2020 2020 2020 6f70 6572 6174 696f 6e5f        operation_
-000151d0: 7374 7220 3d20 2761 7574 6f64 6f77 6e69  str = 'autodowni
-000151e0: 6e67 2720 6966 2072 6563 6f72 645b 0a20  ng' if record[. 
-000151f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015200: 2020 2027 746f 5f64 6f77 6e27 5d20 656c     'to_down'] el
-00015210: 7365 2027 6175 746f 7374 6f70 7069 6e67  se 'autostopping
-00015220: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00015230: 2020 6c6f 6767 6572 2e69 6e66 6f28 0a20    logger.info(. 
-00015240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015250: 2020 2066 2743 6c75 7374 6572 207b 636c     f'Cluster {cl
-00015260: 7573 7465 725f 6e61 6d65 2172 7d20 6973  uster_name!r} is
-00015270: 207b 6f70 6572 6174 696f 6e5f 7374 727d   {operation_str}
-00015280: 2e20 5365 7474 696e 6720 746f 2027 0a20  . Setting to '. 
-00015290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000152a0: 2020 2027 494e 4954 2073 7461 7475 733b     'INIT status;
-000152b0: 2074 7279 2072 6566 7265 7368 2061 6761   try refresh aga
-000152c0: 696e 2069 6e20 6120 7768 696c 652e 2729  in in a while.')
-000152d0: 0a0a 2020 2020 2020 2020 2320 4966 2074  ..        # If t
-000152e0: 6865 2075 7365 7220 7374 6172 7473 2070  he user starts p
-000152f0: 6172 7420 6f66 2061 2053 544f 5050 4544  art of a STOPPED
-00015300: 2063 6c75 7374 6572 2c20 7765 2073 7469   cluster, we sti
-00015310: 6c6c 206e 6565 6420 6120 7374 6174 7573  ll need a status
-00015320: 0a20 2020 2020 2020 2023 2074 6f20 7265  .        # to re
-00015330: 7072 6573 656e 7420 7468 6520 6162 6e6f  present the abno
-00015340: 726d 616c 2073 7461 7475 732e 2046 6f72  rmal status. For
-00015350: 2073 706f 7420 636c 7573 7465 722c 2069   spot cluster, i
-00015360: 7420 6361 6e20 616c 736f 0a20 2020 2020  t can also.     
-00015370: 2020 2023 2072 6570 7265 7365 6e74 2074     # represent t
-00015380: 6861 7420 7468 6520 636c 7573 7465 7220  hat the cluster 
-00015390: 6973 2070 6172 7469 616c 6c79 2070 7265  is partially pre
-000153a0: 656d 7074 6564 2e0a 2020 2020 2020 2020  empted..        
-000153b0: 2320 544f 444f 287a 6877 7529 3a20 7468  # TODO(zhwu): th
-000153c0: 6520 6465 6669 6e69 7469 6f6e 206f 6620  e definition of 
-000153d0: 494e 4954 2073 686f 756c 6420 6265 2061  INIT should be a
-000153e0: 7564 6974 6564 2f63 6861 6e67 6564 2e0a  udited/changed..
-000153f0: 2020 2020 2020 2020 2320 4164 6469 6e67          # Adding
-00015400: 2061 206e 6577 2073 7461 7475 7320 554e   a new status UN
-00015410: 4845 414c 5448 5920 666f 7220 6162 6e6f  HEALTHY for abno
-00015420: 726d 616c 2073 7461 7475 7320 6361 6e20  rmal status can 
-00015430: 6265 2061 2063 686f 6963 652e 0a20 2020  be a choice..   
-00015440: 2020 2020 2067 6c6f 6261 6c5f 7573 6572       global_user
-00015450: 5f73 7461 7465 2e61 6464 5f6f 725f 7570  _state.add_or_up
-00015460: 6461 7465 5f63 6c75 7374 6572 2863 6c75  date_cluster(clu
-00015470: 7374 6572 5f6e 616d 652c 0a20 2020 2020  ster_name,.     
-00015480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000154a0: 2020 2020 2020 2020 2020 2068 616e 646c             handl
-000154b0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-000154c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000154d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000154e0: 2020 2072 6571 7565 7374 6564 5f72 6573     requested_res
-000154f0: 6f75 7263 6573 3d4e 6f6e 652c 0a20 2020  ources=None,.   
-00015500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015520: 2020 2020 2020 2020 2020 2020 2072 6561               rea
-00015530: 6479 3d46 616c 7365 2c0a 2020 2020 2020  dy=False,.      
-00015540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015560: 2020 2020 2020 2020 2020 6973 5f6c 6175            is_lau
-00015570: 6e63 683d 4661 6c73 6529 0a20 2020 2020  nch=False).     
-00015580: 2020 2072 6574 7572 6e20 676c 6f62 616c     return global
-00015590: 5f75 7365 725f 7374 6174 652e 6765 745f  _user_state.get_
-000155a0: 636c 7573 7465 725f 6672 6f6d 5f6e 616d  cluster_from_nam
-000155b0: 6528 636c 7573 7465 725f 6e61 6d65 290a  e(cluster_name).
-000155c0: 2020 2020 2320 4e6f 7720 6973 5f61 626e      # Now is_abn
-000155d0: 6f72 6d61 6c20 6973 2046 616c 7365 3a20  ormal is False: 
-000155e0: 6569 7468 6572 206e 6f64 655f 7374 6174  either node_stat
-000155f0: 7573 6573 2069 7320 656d 7074 7920 6f72  uses is empty or
-00015600: 2061 6c6c 206e 6f64 6573 2061 7265 0a20   all nodes are. 
-00015610: 2020 2023 2053 544f 5050 4544 2e0a 2020     # STOPPED..  
-00015620: 2020 6261 636b 656e 6420 3d20 6261 636b    backend = back
-00015630: 656e 6473 2e43 6c6f 7564 566d 5261 7942  ends.CloudVmRayB
-00015640: 6163 6b65 6e64 2829 0a20 2020 2062 6163  ackend().    bac
-00015650: 6b65 6e64 2e70 6f73 745f 7465 6172 646f  kend.post_teardo
-00015660: 776e 5f63 6c65 616e 7570 2868 616e 646c  wn_cleanup(handl
-00015670: 652c 2074 6572 6d69 6e61 7465 3d74 6f5f  e, terminate=to_
-00015680: 7465 726d 696e 6174 652c 2070 7572 6765  terminate, purge
-00015690: 3d46 616c 7365 290a 2020 2020 7265 7475  =False).    retu
-000156a0: 726e 2067 6c6f 6261 6c5f 7573 6572 5f73  rn global_user_s
-000156b0: 7461 7465 2e67 6574 5f63 6c75 7374 6572  tate.get_cluster
-000156c0: 5f66 726f 6d5f 6e61 6d65 2863 6c75 7374  _from_name(clust
-000156d0: 6572 5f6e 616d 6529 0a0a 0a64 6566 205f  er_name)...def _
-000156e0: 7570 6461 7465 5f63 6c75 7374 6572 5f73  update_cluster_s
-000156f0: 7461 7475 7328 0a20 2020 2063 6c75 7374  tatus(.    clust
-00015700: 6572 5f6e 616d 653a 2073 7472 2c0a 2020  er_name: str,.  
-00015710: 2020 6163 7175 6972 655f 7065 725f 636c    acquire_per_cl
-00015720: 7573 7465 725f 7374 6174 7573 5f6c 6f63  uster_status_loc
-00015730: 6b3a 2062 6f6f 6c2c 0a20 2020 2063 6c75  k: bool,.    clu
-00015740: 7374 6572 5f73 7461 7475 735f 6c6f 636b  ster_status_lock
-00015750: 5f74 696d 656f 7574 3a20 696e 7420 3d20  _timeout: int = 
-00015760: 434c 5553 5445 525f 5354 4154 5553 5f4c  CLUSTER_STATUS_L
-00015770: 4f43 4b5f 5449 4d45 4f55 545f 5345 434f  OCK_TIMEOUT_SECO
-00015780: 4e44 530a 2920 2d3e 204f 7074 696f 6e61  NDS.) -> Optiona
-00015790: 6c5b 4469 6374 5b73 7472 2c20 416e 795d  l[Dict[str, Any]
-000157a0: 5d3a 0a20 2020 2022 2222 5570 6461 7465  ]:.    """Update
-000157b0: 2074 6865 2063 6c75 7374 6572 2073 7461   the cluster sta
-000157c0: 7475 732e 0a0a 2020 2020 5468 6520 636c  tus...    The cl
-000157d0: 7573 7465 7220 7374 6174 7573 2069 7320  uster status is 
-000157e0: 7570 6461 7465 6420 6279 2063 6865 636b  updated by check
-000157f0: 696e 6720 7261 7920 636c 7573 7465 7220  ing ray cluster 
-00015800: 616e 6420 7265 616c 2073 7461 7475 7320  and real status 
-00015810: 6672 6f6d 0a20 2020 2063 6c6f 7564 2e0a  from.    cloud..
-00015820: 0a20 2020 2054 6865 2066 756e 6374 696f  .    The functio
-00015830: 6e20 7769 6c6c 2075 7064 6174 6520 7468  n will update th
-00015840: 6520 6361 6368 6564 2063 6c75 7374 6572  e cached cluster
-00015850: 2073 7461 7475 7320 696e 2074 6865 2067   status in the g
-00015860: 6c6f 6261 6c20 7374 6174 652e 2046 6f72  lobal state. For
-00015870: 0a20 2020 2074 6865 2064 6573 6967 6e20  .    the design 
-00015880: 6f66 2074 6865 2063 6c75 7374 6572 2073  of the cluster s
-00015890: 7461 7475 7320 616e 6420 7472 616e 7369  tatus and transi
-000158a0: 7469 6f6e 2c20 706c 6561 7365 2072 6566  tion, please ref
-000158b0: 6572 2074 6f20 7468 650a 2020 2020 736b  er to the.    sk
-000158c0: 792f 6465 7369 676e 5f64 6f63 732f 636c  y/design_docs/cl
-000158d0: 7573 7465 725f 7374 6174 7573 2e6d 640a  uster_status.md.
-000158e0: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-000158f0: 2020 2063 6c75 7374 6572 5f6e 616d 653a     cluster_name:
-00015900: 2054 6865 206e 616d 6520 6f66 2074 6865   The name of the
-00015910: 2063 6c75 7374 6572 2e0a 2020 2020 2020   cluster..      
-00015920: 2020 6163 7175 6972 655f 7065 725f 636c    acquire_per_cl
-00015930: 7573 7465 725f 7374 6174 7573 5f6c 6f63  uster_status_loc
-00015940: 6b3a 2057 6865 7468 6572 2074 6f20 6163  k: Whether to ac
-00015950: 7175 6972 6520 7468 6520 7065 722d 636c  quire the per-cl
-00015960: 7573 7465 7220 6c6f 636b 0a20 2020 2020  uster lock.     
-00015970: 2020 2020 2062 6566 6f72 6520 7570 6461       before upda
-00015980: 7469 6e67 2074 6865 2073 7461 7475 732e  ting the status.
-00015990: 0a20 2020 2020 2020 2063 6c75 7374 6572  .        cluster
-000159a0: 5f73 7461 7475 735f 6c6f 636b 5f74 696d  _status_lock_tim
-000159b0: 656f 7574 3a20 5468 6520 7469 6d65 6f75  eout: The timeou
-000159c0: 7420 746f 2061 6371 7569 7265 2074 6865  t to acquire the
-000159d0: 2070 6572 2d63 6c75 7374 6572 0a20 2020   per-cluster.   
-000159e0: 2020 2020 2020 206c 6f63 6b2e 0a0a 2020         lock...  
-000159f0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-00015a00: 2020 2049 6620 7468 6520 636c 7573 7465     If the cluste
-00015a10: 7220 6973 2074 6572 6d69 6e61 7465 6420  r is terminated 
-00015a20: 6f72 2064 6f65 7320 6e6f 7420 6578 6973  or does not exis
-00015a30: 742c 2072 6574 7572 6e20 4e6f 6e65 2e20  t, return None. 
-00015a40: 4f74 6865 7277 6973 650a 2020 2020 2020  Otherwise.      
-00015a50: 2020 7265 7475 726e 7320 7468 6520 696e    returns the in
-00015a60: 7075 7420 7265 636f 7264 2077 6974 6820  put record with 
-00015a70: 7374 6174 7573 2061 6e64 2068 616e 646c  status and handl
-00015a80: 6520 706f 7465 6e74 6961 6c6c 7920 7570  e potentially up
-00015a90: 6461 7465 642e 0a0a 2020 2020 5261 6973  dated...    Rais
-00015aa0: 6573 3a0a 2020 2020 2020 2020 6578 6365  es:.        exce
-00015ab0: 7074 696f 6e73 2e43 6c75 7374 6572 4f77  ptions.ClusterOw
-00015ac0: 6e65 7249 6465 6e74 6974 794d 6973 6d61  nerIdentityMisma
-00015ad0: 7463 6845 7272 6f72 3a20 6966 2074 6865  tchError: if the
-00015ae0: 2063 7572 7265 6e74 2075 7365 7220 6973   current user is
-00015af0: 0a20 2020 2020 2020 2020 206e 6f74 2074  .          not t
-00015b00: 6865 2073 616d 6520 6173 2074 6865 2075  he same as the u
-00015b10: 7365 7220 7768 6f20 6372 6561 7465 6420  ser who created 
-00015b20: 7468 6520 636c 7573 7465 722e 0a20 2020  the cluster..   
-00015b30: 2020 2020 2065 7863 6570 7469 6f6e 732e       exceptions.
-00015b40: 436c 6f75 6455 7365 7249 6465 6e74 6974  CloudUserIdentit
-00015b50: 7945 7272 6f72 3a20 6966 2077 6520 6661  yError: if we fa
-00015b60: 696c 2074 6f20 6765 7420 7468 6520 6375  il to get the cu
-00015b70: 7272 656e 7420 7573 6572 0a20 2020 2020  rrent user.     
-00015b80: 2020 2020 2069 6465 6e74 6974 792e 0a20       identity.. 
-00015b90: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
-00015ba0: 732e 436c 7573 7465 7253 7461 7475 7346  s.ClusterStatusF
-00015bb0: 6574 6368 696e 6745 7272 6f72 3a20 7468  etchingError: th
-00015bc0: 6520 636c 7573 7465 7220 7374 6174 7573  e cluster status
-00015bd0: 2063 616e 6e6f 7420 6265 0a20 2020 2020   cannot be.     
-00015be0: 2020 2020 2066 6574 6368 6564 2066 726f       fetched fro
-00015bf0: 6d20 7468 6520 636c 6f75 6420 7072 6f76  m the cloud prov
-00015c00: 6964 6572 206f 7220 7468 6572 6520 6172  ider or there ar
-00015c10: 6520 6c65 616b 6564 206e 6f64 6573 2063  e leaked nodes c
-00015c20: 6175 7369 6e67 0a20 2020 2020 2020 2020  ausing.         
-00015c30: 2074 6865 206e 6f64 6520 6e75 6d62 6572   the node number
-00015c40: 206c 6172 6765 7220 7468 616e 2065 7870   larger than exp
-00015c50: 6563 7465 642e 0a20 2020 2022 2222 0a20  ected..    """. 
-00015c60: 2020 2069 6620 6e6f 7420 6163 7175 6972     if not acquir
-00015c70: 655f 7065 725f 636c 7573 7465 725f 7374  e_per_cluster_st
-00015c80: 6174 7573 5f6c 6f63 6b3a 0a20 2020 2020  atus_lock:.     
-00015c90: 2020 2072 6574 7572 6e20 5f75 7064 6174     return _updat
-00015ca0: 655f 636c 7573 7465 725f 7374 6174 7573  e_cluster_status
-00015cb0: 5f6e 6f5f 6c6f 636b 2863 6c75 7374 6572  _no_lock(cluster
-00015cc0: 5f6e 616d 6529 0a0a 2020 2020 7472 793a  _name)..    try:
-00015cd0: 0a20 2020 2020 2020 2077 6974 6820 6669  .        with fi
-00015ce0: 6c65 6c6f 636b 2e46 696c 654c 6f63 6b28  lelock.FileLock(
-00015cf0: 434c 5553 5445 525f 5354 4154 5553 5f4c  CLUSTER_STATUS_L
-00015d00: 4f43 4b5f 5041 5448 2e66 6f72 6d61 7428  OCK_PATH.format(
-00015d10: 636c 7573 7465 725f 6e61 6d65 292c 0a20  cluster_name),. 
-00015d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d30: 2020 2020 2020 2020 2020 2020 2020 7469                ti
-00015d40: 6d65 6f75 743d 636c 7573 7465 725f 7374  meout=cluster_st
-00015d50: 6174 7573 5f6c 6f63 6b5f 7469 6d65 6f75  atus_lock_timeou
-00015d60: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-00015d70: 7265 7475 726e 205f 7570 6461 7465 5f63  return _update_c
-00015d80: 6c75 7374 6572 5f73 7461 7475 735f 6e6f  luster_status_no
-00015d90: 5f6c 6f63 6b28 636c 7573 7465 725f 6e61  _lock(cluster_na
-00015da0: 6d65 290a 2020 2020 6578 6365 7074 2066  me).    except f
-00015db0: 696c 656c 6f63 6b2e 5469 6d65 6f75 743a  ilelock.Timeout:
-00015dc0: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
-00015dd0: 6465 6275 6728 2752 6566 7265 7368 696e  debug('Refreshin
-00015de0: 6720 7374 6174 7573 3a20 4661 696c 6564  g status: Failed
-00015df0: 2067 6574 2074 6865 206c 6f63 6b20 666f   get the lock fo
-00015e00: 7220 636c 7573 7465 7220 270a 2020 2020  r cluster '.    
-00015e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015e20: 2066 277b 636c 7573 7465 725f 6e61 6d65   f'{cluster_name
-00015e30: 2172 7d2e 2055 7369 6e67 2074 6865 2063  !r}. Using the c
-00015e40: 6163 6865 6420 7374 6174 7573 2e27 290a  ached status.').
-00015e50: 2020 2020 2020 2020 7265 636f 7264 203d          record =
-00015e60: 2067 6c6f 6261 6c5f 7573 6572 5f73 7461   global_user_sta
-00015e70: 7465 2e67 6574 5f63 6c75 7374 6572 5f66  te.get_cluster_f
-00015e80: 726f 6d5f 6e61 6d65 2863 6c75 7374 6572  rom_name(cluster
-00015e90: 5f6e 616d 6529 0a20 2020 2020 2020 2072  _name).        r
-00015ea0: 6574 7572 6e20 7265 636f 7264 0a0a 0a64  eturn record...d
-00015eb0: 6566 2072 6566 7265 7368 5f63 6c75 7374  ef refresh_clust
-00015ec0: 6572 5f72 6563 6f72 6428 0a20 2020 2063  er_record(.    c
-00015ed0: 6c75 7374 6572 5f6e 616d 653a 2073 7472  luster_name: str
-00015ee0: 2c0a 2020 2020 2a2c 0a20 2020 2066 6f72  ,.    *,.    for
-00015ef0: 6365 5f72 6566 7265 7368 5f73 7461 7475  ce_refresh_statu
-00015f00: 7365 733a 204f 7074 696f 6e61 6c5b 5365  ses: Optional[Se
-00015f10: 745b 7374 6174 7573 5f6c 6962 2e43 6c75  t[status_lib.Clu
-00015f20: 7374 6572 5374 6174 7573 5d5d 203d 204e  sterStatus]] = N
-00015f30: 6f6e 652c 0a20 2020 2061 6371 7569 7265  one,.    acquire
-00015f40: 5f70 6572 5f63 6c75 7374 6572 5f73 7461  _per_cluster_sta
-00015f50: 7475 735f 6c6f 636b 3a20 626f 6f6c 203d  tus_lock: bool =
-00015f60: 2054 7275 652c 0a20 2020 2063 6c75 7374   True,.    clust
-00015f70: 6572 5f73 7461 7475 735f 6c6f 636b 5f74  er_status_lock_t
-00015f80: 696d 656f 7574 3a20 696e 7420 3d20 434c  imeout: int = CL
-00015f90: 5553 5445 525f 5354 4154 5553 5f4c 4f43  USTER_STATUS_LOC
-00015fa0: 4b5f 5449 4d45 4f55 545f 5345 434f 4e44  K_TIMEOUT_SECOND
-00015fb0: 530a 2920 2d3e 204f 7074 696f 6e61 6c5b  S.) -> Optional[
-00015fc0: 4469 6374 5b73 7472 2c20 416e 795d 5d3a  Dict[str, Any]]:
-00015fd0: 0a20 2020 2022 2222 5265 6672 6573 6820  .    """Refresh 
-00015fe0: 7468 6520 636c 7573 7465 722c 2061 6e64  the cluster, and
-00015ff0: 2072 6574 7572 6e20 7468 6520 706f 7373   return the poss
-00016000: 6962 6c79 2075 7064 6174 6564 2072 6563  ibly updated rec
-00016010: 6f72 642e 0a0a 2020 2020 5468 6973 2066  ord...    This f
-00016020: 756e 6374 696f 6e20 7769 6c6c 2061 6c73  unction will als
-00016030: 6f20 6368 6563 6b20 7468 6520 6f77 6e65  o check the owne
-00016040: 7220 6964 656e 7469 7479 206f 6620 7468  r identity of th
-00016050: 6520 636c 7573 7465 722c 2061 6e64 2072  e cluster, and r
-00016060: 6169 7365 0a20 2020 2065 7863 6570 7469  aise.    excepti
-00016070: 6f6e 7320 6966 2074 6865 2063 7572 7265  ons if the curre
-00016080: 6e74 2075 7365 7220 6973 206e 6f74 2074  nt user is not t
-00016090: 6865 2073 616d 6520 6173 2074 6865 2075  he same as the u
-000160a0: 7365 7220 7768 6f20 6372 6561 7465 6420  ser who created 
-000160b0: 7468 650a 2020 2020 636c 7573 7465 722e  the.    cluster.
-000160c0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-000160d0: 2020 2020 636c 7573 7465 725f 6e61 6d65      cluster_name
-000160e0: 3a20 5468 6520 6e61 6d65 206f 6620 7468  : The name of th
-000160f0: 6520 636c 7573 7465 722e 0a20 2020 2020  e cluster..     
-00016100: 2020 2066 6f72 6365 5f72 6566 7265 7368     force_refresh
-00016110: 5f73 7461 7475 7365 733a 2069 6620 7370  _statuses: if sp
-00016120: 6563 6966 6965 642c 2072 6566 7265 7368  ecified, refresh
-00016130: 2074 6865 2063 6c75 7374 6572 2069 6620   the cluster if 
-00016140: 6974 2068 6173 206f 6e65 206f 660a 2020  it has one of.  
-00016150: 2020 2020 2020 2020 7468 6520 7370 6563          the spec
-00016160: 6966 6965 6420 7374 6174 7573 6573 2e20  ified statuses. 
-00016170: 4164 6469 7469 6f6e 616c 6c79 2c20 636c  Additionally, cl
-00016180: 7573 7465 7273 2073 6174 6973 6679 696e  usters satisfyin
-00016190: 6720 7468 650a 2020 2020 2020 2020 2020  g the.          
-000161a0: 666f 6c6c 6f77 696e 6720 636f 6e64 6974  following condit
-000161b0: 696f 6e73 2077 696c 6c20 616c 7761 7973  ions will always
-000161c0: 2062 6520 7265 6672 6573 6865 6420 6e6f   be refreshed no
-000161d0: 206d 6174 7465 7220 7468 650a 2020 2020   matter the.    
-000161e0: 2020 2020 2020 6172 6775 6d65 6e74 2069        argument i
-000161f0: 7320 7370 6563 6966 6965 6420 6f72 206e  s specified or n
-00016200: 6f74 3a0a 2020 2020 2020 2020 2020 2020  ot:.            
-00016210: 312e 2069 7320 6120 7370 6f74 2063 6c75  1. is a spot clu
-00016220: 7374 6572 2c20 6f72 0a20 2020 2020 2020  ster, or.       
-00016230: 2020 2020 2032 2e20 6973 2061 206e 6f6e       2. is a non
-00016240: 2d73 706f 7420 636c 7573 7465 722c 2069  -spot cluster, i
-00016250: 7320 6e6f 7420 5354 4f50 5045 442c 2061  s not STOPPED, a
-00016260: 6e64 2061 7574 6f73 746f 7020 6973 2073  nd autostop is s
-00016270: 6574 2e0a 2020 2020 2020 2020 6163 7175  et..        acqu
-00016280: 6972 655f 7065 725f 636c 7573 7465 725f  ire_per_cluster_
-00016290: 7374 6174 7573 5f6c 6f63 6b3a 2057 6865  status_lock: Whe
-000162a0: 7468 6572 2074 6f20 6163 7175 6972 6520  ther to acquire 
-000162b0: 7468 6520 7065 722d 636c 7573 7465 7220  the per-cluster 
-000162c0: 6c6f 636b 0a20 2020 2020 2020 2020 2062  lock.          b
-000162d0: 6566 6f72 6520 7570 6461 7469 6e67 2074  efore updating t
-000162e0: 6865 2073 7461 7475 732e 0a20 2020 2020  he status..     
-000162f0: 2020 2063 6c75 7374 6572 5f73 7461 7475     cluster_statu
-00016300: 735f 6c6f 636b 5f74 696d 656f 7574 3a20  s_lock_timeout: 
-00016310: 5468 6520 7469 6d65 6f75 7420 746f 2061  The timeout to a
-00016320: 6371 7569 7265 2074 6865 2070 6572 2d63  cquire the per-c
-00016330: 6c75 7374 6572 0a20 2020 2020 2020 2020  luster.         
-00016340: 206c 6f63 6b2e 2049 6620 7469 6d65 6f75   lock. If timeou
-00016350: 742c 2074 6865 2066 756e 6374 696f 6e20  t, the function 
-00016360: 7769 6c6c 2075 7365 2074 6865 2063 6163  will use the cac
-00016370: 6865 6420 7374 6174 7573 2e0a 0a20 2020  hed status...   
-00016380: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-00016390: 2020 4966 2074 6865 2063 6c75 7374 6572    If the cluster
-000163a0: 2069 7320 7465 726d 696e 6174 6564 206f   is terminated o
-000163b0: 7220 646f 6573 206e 6f74 2065 7869 7374  r does not exist
-000163c0: 2c20 7265 7475 726e 204e 6f6e 652e 0a20  , return None.. 
-000163d0: 2020 2020 2020 204f 7468 6572 7769 7365         Otherwise
-000163e0: 2072 6574 7572 6e73 2074 6865 2063 6c75   returns the clu
-000163f0: 7374 6572 2072 6563 6f72 642e 0a0a 2020  ster record...  
-00016400: 2020 5261 6973 6573 3a0a 2020 2020 2020    Raises:.      
-00016410: 2020 6578 6365 7074 696f 6e73 2e43 6c75    exceptions.Clu
-00016420: 7374 6572 4f77 6e65 7249 6465 6e74 6974  sterOwnerIdentit
-00016430: 794d 6973 6d61 7463 6845 7272 6f72 3a20  yMismatchError: 
-00016440: 6966 2074 6865 2063 7572 7265 6e74 2075  if the current u
-00016450: 7365 7220 6973 0a20 2020 2020 2020 2020  ser is.         
-00016460: 206e 6f74 2074 6865 2073 616d 6520 6173   not the same as
-00016470: 2074 6865 2075 7365 7220 7768 6f20 6372   the user who cr
-00016480: 6561 7465 6420 7468 6520 636c 7573 7465  eated the cluste
-00016490: 722e 0a20 2020 2020 2020 2065 7863 6570  r..        excep
-000164a0: 7469 6f6e 732e 436c 6f75 6455 7365 7249  tions.CloudUserI
-000164b0: 6465 6e74 6974 7945 7272 6f72 3a20 6966  dentityError: if
-000164c0: 2077 6520 6661 696c 2074 6f20 6765 7420   we fail to get 
-000164d0: 7468 6520 6375 7272 656e 7420 7573 6572  the current user
-000164e0: 0a20 2020 2020 2020 2020 2069 6465 6e74  .          ident
-000164f0: 6974 792e 0a20 2020 2020 2020 2065 7863  ity..        exc
-00016500: 6570 7469 6f6e 732e 436c 7573 7465 7253  eptions.ClusterS
-00016510: 7461 7475 7346 6574 6368 696e 6745 7272  tatusFetchingErr
-00016520: 6f72 3a20 7468 6520 636c 7573 7465 7220  or: the cluster 
-00016530: 7374 6174 7573 2063 616e 6e6f 7420 6265  status cannot be
-00016540: 0a20 2020 2020 2020 2020 2066 6574 6368  .          fetch
-00016550: 6564 2066 726f 6d20 7468 6520 636c 6f75  ed from the clou
-00016560: 6420 7072 6f76 6964 6572 206f 7220 7468  d provider or th
-00016570: 6572 6520 6172 6520 6c65 616b 6564 206e  ere are leaked n
-00016580: 6f64 6573 2063 6175 7369 6e67 0a20 2020  odes causing.   
-00016590: 2020 2020 2020 2074 6865 206e 6f64 6520         the node 
-000165a0: 6e75 6d62 6572 206c 6172 6765 7220 7468  number larger th
-000165b0: 616e 2065 7870 6563 7465 642e 0a20 2020  an expected..   
-000165c0: 2022 2222 0a0a 2020 2020 7265 636f 7264   """..    record
-000165d0: 203d 2067 6c6f 6261 6c5f 7573 6572 5f73   = global_user_s
-000165e0: 7461 7465 2e67 6574 5f63 6c75 7374 6572  tate.get_cluster
-000165f0: 5f66 726f 6d5f 6e61 6d65 2863 6c75 7374  _from_name(clust
-00016600: 6572 5f6e 616d 6529 0a20 2020 2069 6620  er_name).    if 
-00016610: 7265 636f 7264 2069 7320 4e6f 6e65 3a0a  record is None:.
-00016620: 2020 2020 2020 2020 7265 7475 726e 204e          return N
-00016630: 6f6e 650a 2020 2020 6368 6563 6b5f 6f77  one.    check_ow
-00016640: 6e65 725f 6964 656e 7469 7479 2863 6c75  ner_identity(clu
-00016650: 7374 6572 5f6e 616d 6529 0a0a 2020 2020  ster_name)..    
-00016660: 6861 6e64 6c65 203d 2072 6563 6f72 645b  handle = record[
-00016670: 2768 616e 646c 6527 5d0a 2020 2020 6966  'handle'].    if
-00016680: 2069 7369 6e73 7461 6e63 6528 6861 6e64   isinstance(hand
-00016690: 6c65 2c20 6261 636b 656e 6473 2e43 6c6f  le, backends.Clo
-000166a0: 7564 566d 5261 7952 6573 6f75 7263 6548  udVmRayResourceH
-000166b0: 616e 646c 6529 3a0a 2020 2020 2020 2020  andle):.        
-000166c0: 7573 655f 7370 6f74 203d 2068 616e 646c  use_spot = handl
-000166d0: 652e 6c61 756e 6368 6564 5f72 6573 6f75  e.launched_resou
-000166e0: 7263 6573 2e75 7365 5f73 706f 740a 2020  rces.use_spot.  
-000166f0: 2020 2020 2020 6861 735f 6175 746f 7374        has_autost
-00016700: 6f70 203d 2028 7265 636f 7264 5b27 7374  op = (record['st
-00016710: 6174 7573 275d 2021 3d20 7374 6174 7573  atus'] != status
-00016720: 5f6c 6962 2e43 6c75 7374 6572 5374 6174  _lib.ClusterStat
-00016730: 7573 2e53 544f 5050 4544 2061 6e64 0a20  us.STOPPED and. 
-00016740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016750: 2020 2020 2020 2072 6563 6f72 645b 2761         record['a
-00016760: 7574 6f73 746f 7027 5d20 3e3d 2030 290a  utostop'] >= 0).
-00016770: 2020 2020 2020 2020 666f 7263 655f 7265          force_re
-00016780: 6672 6573 685f 666f 725f 636c 7573 7465  fresh_for_cluste
-00016790: 7220 3d20 2866 6f72 6365 5f72 6566 7265  r = (force_refre
-000167a0: 7368 5f73 7461 7475 7365 7320 6973 206e  sh_statuses is n
-000167b0: 6f74 204e 6f6e 6520 616e 640a 2020 2020  ot None and.    
-000167c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000167d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000167e0: 2072 6563 6f72 645b 2773 7461 7475 7327   record['status'
-000167f0: 5d20 696e 2066 6f72 6365 5f72 6566 7265  ] in force_refre
-00016800: 7368 5f73 7461 7475 7365 7329 0a20 2020  sh_statuses).   
-00016810: 2020 2020 2069 6620 666f 7263 655f 7265       if force_re
-00016820: 6672 6573 685f 666f 725f 636c 7573 7465  fresh_for_cluste
-00016830: 7220 6f72 2068 6173 5f61 7574 6f73 746f  r or has_autosto
-00016840: 7020 6f72 2075 7365 5f73 706f 743a 0a20  p or use_spot:. 
-00016850: 2020 2020 2020 2020 2020 2072 6563 6f72             recor
-00016860: 6420 3d20 5f75 7064 6174 655f 636c 7573  d = _update_clus
-00016870: 7465 725f 7374 6174 7573 280a 2020 2020  ter_status(.    
-00016880: 2020 2020 2020 2020 2020 2020 636c 7573              clus
-00016890: 7465 725f 6e61 6d65 2c0a 2020 2020 2020  ter_name,.      
-000168a0: 2020 2020 2020 2020 2020 6163 7175 6972            acquir
-000168b0: 655f 7065 725f 636c 7573 7465 725f 7374  e_per_cluster_st
-000168c0: 6174 7573 5f6c 6f63 6b3d 6163 7175 6972  atus_lock=acquir
-000168d0: 655f 7065 725f 636c 7573 7465 725f 7374  e_per_cluster_st
-000168e0: 6174 7573 5f6c 6f63 6b2c 0a20 2020 2020  atus_lock,.     
-000168f0: 2020 2020 2020 2020 2020 2063 6c75 7374             clust
-00016900: 6572 5f73 7461 7475 735f 6c6f 636b 5f74  er_status_lock_t
-00016910: 696d 656f 7574 3d63 6c75 7374 6572 5f73  imeout=cluster_s
-00016920: 7461 7475 735f 6c6f 636b 5f74 696d 656f  tatus_lock_timeo
-00016930: 7574 290a 2020 2020 7265 7475 726e 2072  ut).    return r
-00016940: 6563 6f72 640a 0a0a 4074 696d 656c 696e  ecord...@timelin
-00016950: 652e 6576 656e 740a 6465 6620 7265 6672  e.event.def refr
-00016960: 6573 685f 636c 7573 7465 725f 7374 6174  esh_cluster_stat
-00016970: 7573 5f68 616e 646c 6528 0a20 2020 2063  us_handle(.    c
-00016980: 6c75 7374 6572 5f6e 616d 653a 2073 7472  luster_name: str
-00016990: 2c0a 2020 2020 2a2c 0a20 2020 2066 6f72  ,.    *,.    for
-000169a0: 6365 5f72 6566 7265 7368 5f73 7461 7475  ce_refresh_statu
-000169b0: 7365 733a 204f 7074 696f 6e61 6c5b 5365  ses: Optional[Se
-000169c0: 745b 7374 6174 7573 5f6c 6962 2e43 6c75  t[status_lib.Clu
-000169d0: 7374 6572 5374 6174 7573 5d5d 203d 204e  sterStatus]] = N
-000169e0: 6f6e 652c 0a20 2020 2061 6371 7569 7265  one,.    acquire
-000169f0: 5f70 6572 5f63 6c75 7374 6572 5f73 7461  _per_cluster_sta
-00016a00: 7475 735f 6c6f 636b 3a20 626f 6f6c 203d  tus_lock: bool =
-00016a10: 2054 7275 652c 0a20 2020 2063 6c75 7374   True,.    clust
-00016a20: 6572 5f73 7461 7475 735f 6c6f 636b 5f74  er_status_lock_t
-00016a30: 696d 656f 7574 3a20 696e 7420 3d20 434c  imeout: int = CL
-00016a40: 5553 5445 525f 5354 4154 5553 5f4c 4f43  USTER_STATUS_LOC
-00016a50: 4b5f 5449 4d45 4f55 545f 5345 434f 4e44  K_TIMEOUT_SECOND
-00016a60: 530a 2920 2d3e 2054 7570 6c65 5b4f 7074  S.) -> Tuple[Opt
-00016a70: 696f 6e61 6c5b 7374 6174 7573 5f6c 6962  ional[status_lib
-00016a80: 2e43 6c75 7374 6572 5374 6174 7573 5d2c  .ClusterStatus],
-00016a90: 0a20 2020 2020 2020 2020 2020 4f70 7469  .           Opti
-00016aa0: 6f6e 616c 5b62 6163 6b65 6e64 732e 5265  onal[backends.Re
-00016ab0: 736f 7572 6365 4861 6e64 6c65 5d5d 3a0a  sourceHandle]]:.
-00016ac0: 2020 2020 2222 2252 6566 7265 7368 2074      """Refresh t
-00016ad0: 6865 2063 6c75 7374 6572 2c20 616e 6420  he cluster, and 
-00016ae0: 7265 7475 726e 2074 6865 2070 6f73 7369  return the possi
-00016af0: 626c 7920 7570 6461 7465 6420 7374 6174  bly updated stat
-00016b00: 7573 2061 6e64 2068 616e 646c 652e 0a0a  us and handle...
-00016b10: 2020 2020 5468 6973 2069 7320 6120 7772      This is a wr
-00016b20: 6170 7065 7220 6f66 2072 6566 7265 7368  apper of refresh
-00016b30: 5f63 6c75 7374 6572 5f72 6563 6f72 642c  _cluster_record,
-00016b40: 2077 6869 6368 2072 6574 7572 6e73 2074   which returns t
-00016b50: 6865 2073 7461 7475 7320 616e 640a 2020  he status and.  
-00016b60: 2020 6861 6e64 6c65 206f 6620 7468 6520    handle of the 
-00016b70: 636c 7573 7465 722e 0a20 2020 2050 6c65  cluster..    Ple
-00016b80: 6173 6520 7265 6665 7220 746f 2074 6865  ase refer to the
-00016b90: 2064 6f63 7374 7269 6e67 206f 6620 7265   docstring of re
-00016ba0: 6672 6573 685f 636c 7573 7465 725f 7265  fresh_cluster_re
-00016bb0: 636f 7264 2066 6f72 2074 6865 2064 6574  cord for the det
-00016bc0: 6169 6c73 2e0a 2020 2020 2222 220a 2020  ails..    """.  
-00016bd0: 2020 7265 636f 7264 203d 2072 6566 7265    record = refre
-00016be0: 7368 5f63 6c75 7374 6572 5f72 6563 6f72  sh_cluster_recor
-00016bf0: 6428 0a20 2020 2020 2020 2063 6c75 7374  d(.        clust
-00016c00: 6572 5f6e 616d 652c 0a20 2020 2020 2020  er_name,.       
-00016c10: 2066 6f72 6365 5f72 6566 7265 7368 5f73   force_refresh_s
-00016c20: 7461 7475 7365 733d 666f 7263 655f 7265  tatuses=force_re
-00016c30: 6672 6573 685f 7374 6174 7573 6573 2c0a  fresh_statuses,.
-00016c40: 2020 2020 2020 2020 6163 7175 6972 655f          acquire_
-00016c50: 7065 725f 636c 7573 7465 725f 7374 6174  per_cluster_stat
-00016c60: 7573 5f6c 6f63 6b3d 6163 7175 6972 655f  us_lock=acquire_
-00016c70: 7065 725f 636c 7573 7465 725f 7374 6174  per_cluster_stat
-00016c80: 7573 5f6c 6f63 6b2c 0a20 2020 2020 2020  us_lock,.       
-00016c90: 2063 6c75 7374 6572 5f73 7461 7475 735f   cluster_status_
-00016ca0: 6c6f 636b 5f74 696d 656f 7574 3d63 6c75  lock_timeout=clu
-00016cb0: 7374 6572 5f73 7461 7475 735f 6c6f 636b  ster_status_lock
-00016cc0: 5f74 696d 656f 7574 290a 2020 2020 6966  _timeout).    if
-00016cd0: 2072 6563 6f72 6420 6973 204e 6f6e 653a   record is None:
-00016ce0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00016cf0: 4e6f 6e65 2c20 4e6f 6e65 0a20 2020 2072  None, None.    r
-00016d00: 6574 7572 6e20 7265 636f 7264 5b27 7374  eturn record['st
-00016d10: 6174 7573 275d 2c20 7265 636f 7264 5b27  atus'], record['
-00016d20: 6861 6e64 6c65 275d 0a0a 0a23 203d 3d3d  handle']...# ===
-00016d30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00016d40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00016d50: 3d3d 0a0a 0a40 7479 7069 6e67 2e6f 7665  ==...@typing.ove
-00016d60: 726c 6f61 640a 6465 6620 6368 6563 6b5f  rload.def check_
-00016d70: 636c 7573 7465 725f 6176 6169 6c61 626c  cluster_availabl
-00016d80: 6528 0a20 2020 2063 6c75 7374 6572 5f6e  e(.    cluster_n
-00016d90: 616d 653a 2073 7472 2c0a 2020 2020 2a2c  ame: str,.    *,
-00016da0: 0a20 2020 206f 7065 7261 7469 6f6e 3a20  .    operation: 
-00016db0: 7374 722c 0a20 2020 2063 6865 636b 5f63  str,.    check_c
-00016dc0: 6c6f 7564 5f76 6d5f 7261 795f 6261 636b  loud_vm_ray_back
-00016dd0: 656e 643a 204c 6974 6572 616c 5b54 7275  end: Literal[Tru
-00016de0: 655d 203d 2054 7275 652c 0a20 2020 2064  e] = True,.    d
-00016df0: 7279 7275 6e3a 2062 6f6f 6c20 3d20 2e2e  ryrun: bool = ..
-00016e00: 2e2c 0a29 202d 3e20 2763 6c6f 7564 5f76  .,.) -> 'cloud_v
-00016e10: 6d5f 7261 795f 6261 636b 656e 642e 436c  m_ray_backend.Cl
-00016e20: 6f75 6456 6d52 6179 5265 736f 7572 6365  oudVmRayResource
-00016e30: 4861 6e64 6c65 273a 0a20 2020 202e 2e2e  Handle':.    ...
-00016e40: 0a0a 0a40 7479 7069 6e67 2e6f 7665 726c  ...@typing.overl
-00016e50: 6f61 640a 6465 6620 6368 6563 6b5f 636c  oad.def check_cl
-00016e60: 7573 7465 725f 6176 6169 6c61 626c 6528  uster_available(
-00016e70: 0a20 2020 2063 6c75 7374 6572 5f6e 616d  .    cluster_nam
-00016e80: 653a 2073 7472 2c0a 2020 2020 2a2c 0a20  e: str,.    *,. 
-00016e90: 2020 206f 7065 7261 7469 6f6e 3a20 7374     operation: st
-00016ea0: 722c 0a20 2020 2063 6865 636b 5f63 6c6f  r,.    check_clo
-00016eb0: 7564 5f76 6d5f 7261 795f 6261 636b 656e  ud_vm_ray_backen
-00016ec0: 643a 204c 6974 6572 616c 5b46 616c 7365  d: Literal[False
-00016ed0: 5d2c 0a20 2020 2064 7279 7275 6e3a 2062  ],.    dryrun: b
-00016ee0: 6f6f 6c20 3d20 2e2e 2e2c 0a29 202d 3e20  ool = ...,.) -> 
-00016ef0: 6261 636b 656e 6473 2e52 6573 6f75 7263  backends.Resourc
-00016f00: 6548 616e 646c 653a 0a20 2020 202e 2e2e  eHandle:.    ...
-00016f10: 0a0a 0a64 6566 2063 6865 636b 5f63 6c75  ...def check_clu
-00016f20: 7374 6572 5f61 7661 696c 6162 6c65 280a  ster_available(.
-00016f30: 2020 2020 636c 7573 7465 725f 6e61 6d65      cluster_name
-00016f40: 3a20 7374 722c 0a20 2020 202a 2c0a 2020  : str,.    *,.  
-00016f50: 2020 6f70 6572 6174 696f 6e3a 2073 7472    operation: str
-00016f60: 2c0a 2020 2020 6368 6563 6b5f 636c 6f75  ,.    check_clou
-00016f70: 645f 766d 5f72 6179 5f62 6163 6b65 6e64  d_vm_ray_backend
-00016f80: 3a20 626f 6f6c 203d 2054 7275 652c 0a20  : bool = True,. 
-00016f90: 2020 2064 7279 7275 6e3a 2062 6f6f 6c20     dryrun: bool 
-00016fa0: 3d20 4661 6c73 652c 0a29 202d 3e20 6261  = False,.) -> ba
-00016fb0: 636b 656e 6473 2e52 6573 6f75 7263 6548  ckends.ResourceH
-00016fc0: 616e 646c 653a 0a20 2020 2022 2222 4368  andle:.    """Ch
-00016fd0: 6563 6b20 6966 2074 6865 2063 6c75 7374  eck if the clust
-00016fe0: 6572 2069 7320 6176 6169 6c61 626c 652e  er is available.
-00016ff0: 0a0a 2020 2020 5261 6973 6573 3a0a 2020  ..    Raises:.  
-00017000: 2020 2020 2020 5661 6c75 6545 7272 6f72        ValueError
-00017010: 3a20 6966 2074 6865 2063 6c75 7374 6572  : if the cluster
-00017020: 2064 6f65 7320 6e6f 7420 6578 6973 742e   does not exist.
-00017030: 0a20 2020 2020 2020 2065 7863 6570 7469  .        excepti
-00017040: 6f6e 732e 436c 7573 7465 724e 6f74 5570  ons.ClusterNotUp
-00017050: 4572 726f 723a 2069 6620 7468 6520 636c  Error: if the cl
-00017060: 7573 7465 7220 6973 206e 6f74 2055 502e  uster is not UP.
-00017070: 0a20 2020 2020 2020 2065 7863 6570 7469  .        excepti
-00017080: 6f6e 732e 4e6f 7453 7570 706f 7274 6564  ons.NotSupported
-00017090: 4572 726f 723a 2069 6620 7468 6520 636c  Error: if the cl
-000170a0: 7573 7465 7220 6973 206e 6f74 2062 6173  uster is not bas
-000170b0: 6564 206f 6e0a 2020 2020 2020 2020 2020  ed on.          
-000170c0: 436c 6f75 6456 6d52 6179 4261 636b 656e  CloudVmRayBacken
-000170d0: 642e 0a20 2020 2020 2020 2065 7863 6570  d..        excep
-000170e0: 7469 6f6e 732e 436c 7573 7465 724f 776e  tions.ClusterOwn
-000170f0: 6572 4964 656e 7469 7479 4d69 736d 6174  erIdentityMismat
-00017100: 6368 4572 726f 723a 2069 6620 7468 6520  chError: if the 
-00017110: 6375 7272 656e 7420 7573 6572 2069 730a  current user is.
-00017120: 2020 2020 2020 2020 2020 6e6f 7420 7468            not th
-00017130: 6520 7361 6d65 2061 7320 7468 6520 7573  e same as the us
-00017140: 6572 2077 686f 2063 7265 6174 6564 2074  er who created t
-00017150: 6865 2063 6c75 7374 6572 2e0a 2020 2020  he cluster..    
-00017160: 2020 2020 6578 6365 7074 696f 6e73 2e43      exceptions.C
-00017170: 6c6f 7564 5573 6572 4964 656e 7469 7479  loudUserIdentity
-00017180: 4572 726f 723a 2069 6620 7765 2066 6169  Error: if we fai
-00017190: 6c20 746f 2067 6574 2074 6865 2063 7572  l to get the cur
-000171a0: 7265 6e74 2075 7365 720a 2020 2020 2020  rent user.      
-000171b0: 2020 2020 6964 656e 7469 7479 2e0a 2020      identity..  
-000171c0: 2020 2222 220a 2020 2020 7265 636f 7264    """.    record
-000171d0: 203d 2067 6c6f 6261 6c5f 7573 6572 5f73   = global_user_s
-000171e0: 7461 7465 2e67 6574 5f63 6c75 7374 6572  tate.get_cluster
-000171f0: 5f66 726f 6d5f 6e61 6d65 2863 6c75 7374  _from_name(clust
-00017200: 6572 5f6e 616d 6529 0a20 2020 2069 6620  er_name).    if 
-00017210: 6472 7972 756e 3a0a 2020 2020 2020 2020  dryrun:.        
-00017220: 6173 7365 7274 2072 6563 6f72 6420 6973  assert record is
-00017230: 206e 6f74 204e 6f6e 652c 2063 6c75 7374   not None, clust
-00017240: 6572 5f6e 616d 650a 2020 2020 2020 2020  er_name.        
-00017250: 7265 7475 726e 2072 6563 6f72 645b 2768  return record['h
-00017260: 616e 646c 6527 5d0a 0a20 2020 2070 7265  andle']..    pre
-00017270: 7669 6f75 735f 636c 7573 7465 725f 7374  vious_cluster_st
-00017280: 6174 7573 203d 204e 6f6e 650a 2020 2020  atus = None.    
-00017290: 6966 2072 6563 6f72 6420 6973 206e 6f74  if record is not
-000172a0: 204e 6f6e 653a 0a20 2020 2020 2020 2070   None:.        p
-000172b0: 7265 7669 6f75 735f 636c 7573 7465 725f  revious_cluster_
-000172c0: 7374 6174 7573 203d 2072 6563 6f72 645b  status = record[
-000172d0: 2773 7461 7475 7327 5d0a 0a20 2020 2074  'status']..    t
-000172e0: 7279 3a0a 2020 2020 2020 2020 636c 7573  ry:.        clus
-000172f0: 7465 725f 7374 6174 7573 2c20 6861 6e64  ter_status, hand
-00017300: 6c65 203d 2072 6566 7265 7368 5f63 6c75  le = refresh_clu
-00017310: 7374 6572 5f73 7461 7475 735f 6861 6e64  ster_status_hand
-00017320: 6c65 2863 6c75 7374 6572 5f6e 616d 6529  le(cluster_name)
-00017330: 0a20 2020 2065 7863 6570 7420 6578 6365  .    except exce
-00017340: 7074 696f 6e73 2e43 6c75 7374 6572 5374  ptions.ClusterSt
-00017350: 6174 7573 4665 7463 6869 6e67 4572 726f  atusFetchingErro
-00017360: 7220 6173 2065 3a0a 2020 2020 2020 2020  r as e:.        
-00017370: 2320 4661 696c 6564 2074 6f20 7265 6672  # Failed to refr
-00017380: 6573 6820 7468 6520 636c 7573 7465 7220  esh the cluster 
-00017390: 7374 6174 7573 2069 7320 6e6f 7420 6661  status is not fa
-000173a0: 7461 6c20 6572 726f 7220 6173 2074 6865  tal error as the
-000173b0: 2063 616c 6c65 7273 0a20 2020 2020 2020   callers.       
-000173c0: 2023 2063 616e 2073 7469 6c6c 2062 6520   # can still be 
-000173d0: 646f 6e65 2062 7920 6f6e 6c79 2075 7369  done by only usi
-000173e0: 6e67 2073 7368 2c20 6275 7420 7468 6520  ng ssh, but the 
-000173f0: 7373 6820 6361 6e20 6861 6e67 2069 6620  ssh can hang if 
-00017400: 7468 650a 2020 2020 2020 2020 2320 636c  the.        # cl
-00017410: 7573 7465 7220 6973 206e 6f74 2075 7020  uster is not up 
-00017420: 2865 2e67 2e2c 2061 7574 6f73 746f 7070  (e.g., autostopp
-00017430: 6564 292e 0a0a 2020 2020 2020 2020 2320  ed)...        # 
-00017440: 5765 2064 6f20 6e6f 7420 6361 7463 6820  We do not catch 
-00017450: 7468 6520 6578 6365 7074 696f 6e20 666f  the exception fo
-00017460: 7220 636c 6f75 6420 6964 656e 7469 7479  r cloud identity
-00017470: 2063 6865 636b 696e 6720 666f 7220 6e6f   checking for no
-00017480: 772c 2069 6e0a 2020 2020 2020 2020 2320  w, in.        # 
-00017490: 6f72 6465 7220 746f 2064 6973 6162 6c65  order to disable
-000174a0: 2061 6c6c 206f 7065 7261 7469 6f6e 7320   all operations 
-000174b0: 6f6e 2063 6c75 7374 6572 7320 6372 6561  on clusters crea
-000174c0: 7465 6420 6279 2061 6e6f 7468 6572 2075  ted by another u
-000174d0: 7365 720a 2020 2020 2020 2020 2320 6964  ser.        # id
-000174e0: 656e 7469 7479 2e20 2054 6861 7420 7769  entity.  That wi
-000174f0: 6c6c 206d 616b 6520 7468 6520 6465 7369  ll make the desi
-00017500: 676e 2073 696d 706c 6572 2061 6e64 2065  gn simpler and e
-00017510: 6173 6965 7220 746f 0a20 2020 2020 2020  asier to.       
-00017520: 2023 2075 6e64 6572 7374 616e 642c 2062   # understand, b
-00017530: 7574 2069 7420 6d69 6768 7420 6265 2075  ut it might be u
-00017540: 7365 6675 6c20 746f 2061 6c6c 6f77 2074  seful to allow t
-00017550: 6865 2075 7365 7220 746f 2075 7365 0a20  he user to use. 
-00017560: 2020 2020 2020 2023 206f 7065 7261 7469         # operati
-00017570: 6f6e 7320 7468 6174 206f 6e6c 7920 696e  ons that only in
-00017580: 766f 6c76 6520 7373 6820 2865 2e67 2e2c  volve ssh (e.g.,
-00017590: 2073 6b79 2065 7865 632c 2073 6b79 206c   sky exec, sky l
-000175a0: 6f67 732c 2065 7463 2920 6576 656e 0a20  ogs, etc) even. 
-000175b0: 2020 2020 2020 2023 2069 6620 7468 6520         # if the 
-000175c0: 7573 6572 2069 7320 6e6f 7420 7468 6520  user is not the 
-000175d0: 6f77 6e65 7220 6f66 2074 6865 2063 6c75  owner of the clu
-000175e0: 7374 6572 2e0a 2020 2020 2020 2020 7578  ster..        ux
-000175f0: 5f75 7469 6c73 2e63 6f6e 736f 6c65 5f6e  _utils.console_n
-00017600: 6577 6c69 6e65 2829 0a20 2020 2020 2020  ewline().       
-00017610: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
-00017620: 0a20 2020 2020 2020 2020 2020 2066 2746  .            f'F
-00017630: 6169 6c65 6420 746f 2072 6566 7265 7368  ailed to refresh
-00017640: 2074 6865 2073 7461 7475 7320 666f 7220   the status for 
-00017650: 636c 7573 7465 7220 7b63 6c75 7374 6572  cluster {cluster
-00017660: 5f6e 616d 6521 727d 2e20 4974 2069 7320  _name!r}. It is 
-00017670: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
-00017680: 6e6f 7420 6661 7461 6c2c 2062 7574 207b  not fatal, but {
-00017690: 6f70 6572 6174 696f 6e7d 206d 6967 6874  operation} might
-000176a0: 2068 616e 6720 6966 2074 6865 2063 6c75   hang if the clu
-000176b0: 7374 6572 2069 7320 6e6f 7420 7570 2e5c  ster is not up.\
-000176c0: 6e27 0a20 2020 2020 2020 2020 2020 2066  n'.            f
-000176d0: 2744 6574 6169 6c65 6420 7265 6173 6f6e  'Detailed reason
-000176e0: 3a20 7b65 7d27 290a 2020 2020 2020 2020  : {e}').        
-000176f0: 6966 2072 6563 6f72 6420 6973 204e 6f6e  if record is Non
-00017700: 653a 0a20 2020 2020 2020 2020 2020 2063  e:.            c
-00017710: 6c75 7374 6572 5f73 7461 7475 732c 2068  luster_status, h
-00017720: 616e 646c 6520 3d20 4e6f 6e65 2c20 4e6f  andle = None, No
-00017730: 6e65 0a20 2020 2020 2020 2065 6c73 653a  ne.        else:
-00017740: 0a20 2020 2020 2020 2020 2020 2063 6c75  .            clu
-00017750: 7374 6572 5f73 7461 7475 732c 2068 616e  ster_status, han
-00017760: 646c 6520 3d20 7265 636f 7264 5b27 7374  dle = record['st
-00017770: 6174 7573 275d 2c20 7265 636f 7264 5b27  atus'], record['
-00017780: 6861 6e64 6c65 275d 0a0a 2020 2020 6272  handle']..    br
-00017790: 6967 6874 203d 2063 6f6c 6f72 616d 612e  ight = colorama.
-000177a0: 5374 796c 652e 4252 4947 4854 0a20 2020  Style.BRIGHT.   
-000177b0: 2072 6573 6574 203d 2063 6f6c 6f72 616d   reset = coloram
-000177c0: 612e 5374 796c 652e 5245 5345 545f 414c  a.Style.RESET_AL
-000177d0: 4c0a 2020 2020 6966 2068 616e 646c 6520  L.    if handle 
-000177e0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-000177f0: 2069 6620 7072 6576 696f 7573 5f63 6c75   if previous_clu
-00017800: 7374 6572 5f73 7461 7475 7320 6973 204e  ster_status is N
-00017810: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00017820: 2065 7272 6f72 5f6d 7367 203d 2066 2743   error_msg = f'C
-00017830: 6c75 7374 6572 207b 636c 7573 7465 725f  luster {cluster_
-00017840: 6e61 6d65 2172 7d20 646f 6573 206e 6f74  name!r} does not
-00017850: 2065 7869 7374 2e27 0a20 2020 2020 2020   exist.'.       
-00017860: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00017870: 2020 2065 7272 6f72 5f6d 7367 203d 2028     error_msg = (
-00017880: 6627 436c 7573 7465 7220 7b63 6c75 7374  f'Cluster {clust
-00017890: 6572 5f6e 616d 6521 727d 206e 6f74 2066  er_name!r} not f
-000178a0: 6f75 6e64 206f 6e20 7468 6520 636c 6f75  ound on the clou
-000178b0: 6420 270a 2020 2020 2020 2020 2020 2020  d '.            
-000178c0: 2020 2020 2020 2020 2020 2020 2027 7072               'pr
-000178d0: 6f76 6964 6572 2e27 290a 2020 2020 2020  ovider.').      
-000178e0: 2020 2020 2020 6173 7365 7274 2072 6563        assert rec
-000178f0: 6f72 6420 6973 206e 6f74 204e 6f6e 652c  ord is not None,
-00017900: 2070 7265 7669 6f75 735f 636c 7573 7465   previous_cluste
-00017910: 725f 7374 6174 7573 0a20 2020 2020 2020  r_status.       
-00017920: 2020 2020 2061 6374 696f 6e73 203d 205b       actions = [
-00017930: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
-00017940: 2072 6563 6f72 645b 2768 616e 646c 6527   record['handle'
-00017950: 5d2e 6c61 756e 6368 6564 5f72 6573 6f75  ].launched_resou
-00017960: 7263 6573 2e75 7365 5f73 706f 743a 0a20  rces.use_spot:. 
-00017970: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00017980: 6374 696f 6e73 2e61 7070 656e 6428 2770  ctions.append('p
-00017990: 7265 656d 7074 6564 2729 0a20 2020 2020  reempted').     
-000179a0: 2020 2020 2020 2069 6620 7265 636f 7264         if record
-000179b0: 5b27 6175 746f 7374 6f70 275d 203e 2030  ['autostop'] > 0
-000179c0: 2061 6e64 2072 6563 6f72 645b 2774 6f5f   and record['to_
-000179d0: 646f 776e 275d 3a0a 2020 2020 2020 2020  down']:.        
-000179e0: 2020 2020 2020 2020 6163 7469 6f6e 732e          actions.
-000179f0: 6170 7065 6e64 2827 6175 746f 646f 776e  append('autodown
-00017a00: 6564 2729 0a20 2020 2020 2020 2020 2020  ed').           
-00017a10: 2061 6374 696f 6e73 2e61 7070 656e 6428   actions.append(
-00017a20: 276d 616e 7561 6c6c 7920 7465 726d 696e  'manually termin
-00017a30: 6174 6564 2069 6e20 636f 6e73 6f6c 6527  ated in console'
-00017a40: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00017a50: 206c 656e 2861 6374 696f 6e73 2920 3e20   len(actions) > 
-00017a60: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-00017a70: 2020 2061 6374 696f 6e73 5b2d 315d 203d     actions[-1] =
-00017a80: 2027 6f72 2027 202b 2061 6374 696f 6e73   'or ' + actions
-00017a90: 5b2d 315d 0a20 2020 2020 2020 2020 2020  [-1].           
-00017aa0: 2061 6374 696f 6e73 5f73 7472 203d 2027   actions_str = '
-00017ab0: 2c20 272e 6a6f 696e 2861 6374 696f 6e73  , '.join(actions
-00017ac0: 290a 2020 2020 2020 2020 2020 2020 6d65  ).            me
-00017ad0: 7373 6167 6520 3d20 6627 2049 7420 7761  ssage = f' It wa
-00017ae0: 7320 6c69 6b65 6c79 207b 6163 7469 6f6e  s likely {action
-00017af0: 735f 7374 727d 2e27 0a20 2020 2020 2020  s_str}.'.       
-00017b00: 2020 2020 2069 6620 6c65 6e28 6163 7469       if len(acti
-00017b10: 6f6e 7329 203e 2031 3a0a 2020 2020 2020  ons) > 1:.      
-00017b20: 2020 2020 2020 2020 2020 6d65 7373 6167            messag
-00017b30: 6520 3d20 6d65 7373 6167 652e 7265 706c  e = message.repl
-00017b40: 6163 6528 276c 696b 656c 7927 2c20 2765  ace('likely', 'e
-00017b50: 6974 6865 7227 290a 2020 2020 2020 2020  ither').        
-00017b60: 2020 2020 6572 726f 725f 6d73 6720 2b3d      error_msg +=
-00017b70: 206d 6573 7361 6765 0a0a 2020 2020 2020   message..      
-00017b80: 2020 7769 7468 2075 785f 7574 696c 732e    with ux_utils.
-00017b90: 7072 696e 745f 6578 6365 7074 696f 6e5f  print_exception_
-00017ba0: 6e6f 5f74 7261 6365 6261 636b 2829 3a0a  no_traceback():.
-00017bb0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00017bc0: 6520 5661 6c75 6545 7272 6f72 2866 277b  e ValueError(f'{
-00017bd0: 636f 6c6f 7261 6d61 2e46 6f72 652e 5945  colorama.Fore.YE
-00017be0: 4c4c 4f57 7d7b 6572 726f 725f 6d73 677d  LLOW}{error_msg}
-00017bf0: 7b72 6573 6574 7d27 290a 2020 2020 6173  {reset}').    as
-00017c00: 7365 7274 2063 6c75 7374 6572 5f73 7461  sert cluster_sta
-00017c10: 7475 7320 6973 206e 6f74 204e 6f6e 652c  tus is not None,
-00017c20: 2027 6861 6e64 6c65 2069 7320 6e6f 7420   'handle is not 
-00017c30: 4e6f 6e65 2062 7574 2073 7461 7475 7320  None but status 
-00017c40: 6973 204e 6f6e 6527 0a20 2020 2062 6163  is None'.    bac
-00017c50: 6b65 6e64 203d 2067 6574 5f62 6163 6b65  kend = get_backe
-00017c60: 6e64 5f66 726f 6d5f 6861 6e64 6c65 2868  nd_from_handle(h
-00017c70: 616e 646c 6529 0a20 2020 2069 6620 6368  andle).    if ch
-00017c80: 6563 6b5f 636c 6f75 645f 766d 5f72 6179  eck_cloud_vm_ray
-00017c90: 5f62 6163 6b65 6e64 2061 6e64 206e 6f74  _backend and not
-00017ca0: 2069 7369 6e73 7461 6e63 6528 0a20 2020   isinstance(.   
-00017cb0: 2020 2020 2020 2020 2062 6163 6b65 6e64           backend
-00017cc0: 2c20 6261 636b 656e 6473 2e43 6c6f 7564  , backends.Cloud
-00017cd0: 566d 5261 7942 6163 6b65 6e64 293a 0a20  VmRayBackend):. 
-00017ce0: 2020 2020 2020 2077 6974 6820 7578 5f75         with ux_u
-00017cf0: 7469 6c73 2e70 7269 6e74 5f65 7863 6570  tils.print_excep
-00017d00: 7469 6f6e 5f6e 6f5f 7472 6163 6562 6163  tion_no_tracebac
-00017d10: 6b28 293a 0a20 2020 2020 2020 2020 2020  k():.           
-00017d20: 2072 6169 7365 2065 7863 6570 7469 6f6e   raise exception
-00017d30: 732e 4e6f 7453 7570 706f 7274 6564 4572  s.NotSupportedEr
-00017d40: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-00017d50: 2020 2020 2066 277b 636f 6c6f 7261 6d61       f'{colorama
-00017d60: 2e46 6f72 652e 5945 4c4c 4f57 7d7b 6f70  .Fore.YELLOW}{op
-00017d70: 6572 6174 696f 6e2e 6361 7069 7461 6c69  eration.capitali
-00017d80: 7a65 2829 7d3a 2073 6b69 7070 6564 2066  ze()}: skipped f
-00017d90: 6f72 2027 0a20 2020 2020 2020 2020 2020  or '.           
-00017da0: 2020 2020 2066 2763 6c75 7374 6572 207b       f'cluster {
-00017db0: 636c 7573 7465 725f 6e61 6d65 2172 7d2e  cluster_name!r}.
-00017dc0: 2049 7420 6973 206f 6e6c 7920 7375 7070   It is only supp
-00017dd0: 6f72 7465 6420 6279 2062 6163 6b65 6e64  orted by backend
-00017de0: 3a20 270a 2020 2020 2020 2020 2020 2020  : '.            
-00017df0: 2020 2020 6627 7b62 6163 6b65 6e64 732e      f'{backends.
-00017e00: 436c 6f75 6456 6d52 6179 4261 636b 656e  CloudVmRayBacken
-00017e10: 642e 4e41 4d45 7d2e 270a 2020 2020 2020  d.NAME}.'.      
-00017e20: 2020 2020 2020 2020 2020 6627 7b72 6573            f'{res
-00017e30: 6574 7d27 290a 2020 2020 6966 2063 6c75  et}').    if clu
-00017e40: 7374 6572 5f73 7461 7475 7320 213d 2073  ster_status != s
-00017e50: 7461 7475 735f 6c69 622e 436c 7573 7465  tatus_lib.Cluste
-00017e60: 7253 7461 7475 732e 5550 3a0a 2020 2020  rStatus.UP:.    
-00017e70: 2020 2020 7769 7468 2075 785f 7574 696c      with ux_util
-00017e80: 732e 7072 696e 745f 6578 6365 7074 696f  s.print_exceptio
-00017e90: 6e5f 6e6f 5f74 7261 6365 6261 636b 2829  n_no_traceback()
-00017ea0: 3a0a 2020 2020 2020 2020 2020 2020 6869  :.            hi
-00017eb0: 6e74 5f66 6f72 5f69 6e69 7420 3d20 2727  nt_for_init = ''
-00017ec0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00017ed0: 636c 7573 7465 725f 7374 6174 7573 203d  cluster_status =
-00017ee0: 3d20 7374 6174 7573 5f6c 6962 2e43 6c75  = status_lib.Clu
-00017ef0: 7374 6572 5374 6174 7573 2e49 4e49 543a  sterStatus.INIT:
-00017f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017f10: 2068 696e 745f 666f 725f 696e 6974 203d   hint_for_init =
-00017f20: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-00017f30: 2020 2020 2020 2066 277b 7265 7365 747d         f'{reset}
-00017f40: 2057 6169 7420 666f 7220 6120 6c61 756e   Wait for a laun
-00017f50: 6368 2074 6f20 6669 6e69 7368 2c20 6f72  ch to finish, or
-00017f60: 2075 7365 2074 6869 7320 636f 6d6d 616e   use this comman
-00017f70: 6420 270a 2020 2020 2020 2020 2020 2020  d '.            
-00017f80: 2020 2020 2020 2020 6627 746f 2074 7279          f'to try
-00017f90: 2074 6f20 7472 616e 7369 7469 6f6e 2074   to transition t
-00017fa0: 6865 2063 6c75 7374 6572 2074 6f20 5550  he cluster to UP
-00017fb0: 3a20 7b62 7269 6768 747d 736b 7920 270a  : {bright}sky '.
-00017fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017fd0: 2020 2020 6627 7374 6172 7420 7b63 6c75      f'start {clu
-00017fe0: 7374 6572 5f6e 616d 657d 7b72 6573 6574  ster_name}{reset
-00017ff0: 7d27 290a 2020 2020 2020 2020 2020 2020  }').            
-00018000: 7261 6973 6520 6578 6365 7074 696f 6e73  raise exceptions
-00018010: 2e43 6c75 7374 6572 4e6f 7455 7045 7272  .ClusterNotUpErr
-00018020: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00018030: 2020 2020 6627 7b63 6f6c 6f72 616d 612e      f'{colorama.
-00018040: 466f 7265 2e59 454c 4c4f 577d 7b6f 7065  Fore.YELLOW}{ope
-00018050: 7261 7469 6f6e 2e63 6170 6974 616c 697a  ration.capitaliz
-00018060: 6528 297d 3a20 736b 6970 7065 6420 666f  e()}: skipped fo
-00018070: 7220 270a 2020 2020 2020 2020 2020 2020  r '.            
-00018080: 2020 2020 6627 636c 7573 7465 7220 7b63      f'cluster {c
-00018090: 6c75 7374 6572 5f6e 616d 6521 727d 2028  luster_name!r} (
-000180a0: 7374 6174 7573 3a20 7b63 6c75 7374 6572  status: {cluster
-000180b0: 5f73 7461 7475 732e 7661 6c75 657d 292e  _status.value}).
-000180c0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-000180d0: 2020 2027 4974 2069 7320 6f6e 6c79 2061     'It is only a
-000180e0: 6c6c 6f77 6564 2066 6f72 2027 0a20 2020  llowed for '.   
-000180f0: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
-00018100: 7374 6174 7573 5f6c 6962 2e43 6c75 7374  status_lib.Clust
-00018110: 6572 5374 6174 7573 2e55 502e 7661 6c75  erStatus.UP.valu
-00018120: 657d 2063 6c75 7374 6572 732e 270a 2020  e} clusters.'.  
-00018130: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00018140: 7b68 696e 745f 666f 725f 696e 6974 7d27  {hint_for_init}'
-00018150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018160: 2066 277b 7265 7365 747d 272c 0a20 2020   f'{reset}',.   
-00018170: 2020 2020 2020 2020 2020 2020 2063 6c75               clu
-00018180: 7374 6572 5f73 7461 7475 733d 636c 7573  ster_status=clus
-00018190: 7465 725f 7374 6174 7573 2c0a 2020 2020  ter_status,.    
-000181a0: 2020 2020 2020 2020 2020 2020 6861 6e64              hand
-000181b0: 6c65 3d68 616e 646c 6529 0a0a 2020 2020  le=handle)..    
-000181c0: 6966 2068 616e 646c 652e 6865 6164 5f69  if handle.head_i
-000181d0: 7020 6973 204e 6f6e 653a 0a20 2020 2020  p is None:.     
-000181e0: 2020 2077 6974 6820 7578 5f75 7469 6c73     with ux_utils
-000181f0: 2e70 7269 6e74 5f65 7863 6570 7469 6f6e  .print_exception
-00018200: 5f6e 6f5f 7472 6163 6562 6163 6b28 293a  _no_traceback():
-00018210: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00018220: 7365 2065 7863 6570 7469 6f6e 732e 436c  se exceptions.Cl
-00018230: 7573 7465 724e 6f74 5570 4572 726f 7228  usterNotUpError(
-00018240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018250: 2066 2743 6c75 7374 6572 207b 636c 7573   f'Cluster {clus
-00018260: 7465 725f 6e61 6d65 2172 7d20 6861 7320  ter_name!r} has 
-00018270: 6265 656e 2073 746f 7070 6564 206f 7220  been stopped or 
-00018280: 6e6f 7420 7072 6f70 6572 6c79 2027 0a20  not properly '. 
-00018290: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-000182a0: 7365 7420 7570 2e20 506c 6561 7365 2072  set up. Please r
-000182b0: 652d 6c61 756e 6368 2069 7420 7769 7468  e-launch it with
-000182c0: 2060 736b 7920 7374 6172 7460 2e27 2c0a   `sky start`.',.
-000182d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000182e0: 636c 7573 7465 725f 7374 6174 7573 3d63  cluster_status=c
-000182f0: 6c75 7374 6572 5f73 7461 7475 732c 0a20  luster_status,. 
-00018300: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-00018310: 616e 646c 653d 6861 6e64 6c65 290a 2020  andle=handle).  
-00018320: 2020 7265 7475 726e 2068 616e 646c 650a    return handle.
-00018330: 0a0a 2320 544f 444f 2874 6961 6e29 3a20  ..# TODO(tian): 
-00018340: 5265 6661 6374 6f72 2074 6f20 636f 6e74  Refactor to cont
-00018350: 726f 6c6c 6572 5f75 7469 6c73 2e20 4375  roller_utils. Cu
-00018360: 7272 656e 7420 626c 6f63 6b65 723a 2063  rrent blocker: c
-00018370: 6972 6375 6c61 7220 696d 706f 7274 2e0a  ircular import..
-00018380: 6465 6620 6973 5f63 6f6e 7472 6f6c 6c65  def is_controlle
-00018390: 725f 6163 6365 7373 6962 6c65 280a 2020  r_accessible(.  
-000183a0: 2020 636f 6e74 726f 6c6c 6572 5f74 7970    controller_typ
-000183b0: 653a 2063 6f6e 7472 6f6c 6c65 725f 7574  e: controller_ut
-000183c0: 696c 732e 436f 6e74 726f 6c6c 6572 732c  ils.Controllers,
-000183d0: 0a20 2020 2073 746f 7070 6564 5f6d 6573  .    stopped_mes
-000183e0: 7361 6765 3a20 7374 722c 0a20 2020 206e  sage: str,.    n
-000183f0: 6f6e 5f65 7869 7374 656e 745f 6d65 7373  on_existent_mess
-00018400: 6167 653a 204f 7074 696f 6e61 6c5b 7374  age: Optional[st
-00018410: 725d 203d 204e 6f6e 652c 0a20 2020 2065  r] = None,.    e
-00018420: 7869 745f 6966 5f6e 6f74 5f61 6363 6573  xit_if_not_acces
-00018430: 7369 626c 653a 2062 6f6f 6c20 3d20 4661  sible: bool = Fa
-00018440: 6c73 652c 0a29 202d 3e20 2762 6163 6b65  lse,.) -> 'backe
-00018450: 6e64 732e 436c 6f75 6456 6d52 6179 5265  nds.CloudVmRayRe
-00018460: 736f 7572 6365 4861 6e64 6c65 273a 0a20  sourceHandle':. 
-00018470: 2020 2022 2222 4368 6563 6b20 6966 2074     """Check if t
-00018480: 6865 2073 706f 742f 7365 7276 6520 636f  he spot/serve co
-00018490: 6e74 726f 6c6c 6572 2069 7320 7570 2e0a  ntroller is up..
-000184a0: 0a20 2020 2054 6865 2063 6f6e 7472 6f6c  .    The control
-000184b0: 6c65 7220 6973 2061 6363 6573 7369 626c  ler is accessibl
-000184c0: 6520 7768 656e 2069 7420 6973 2069 6e20  e when it is in 
-000184d0: 5550 206f 7220 494e 4954 2073 7461 7465  UP or INIT state
-000184e0: 2c20 616e 6420 7468 6520 7373 680a 2020  , and the ssh.  
-000184f0: 2020 636f 6e6e 6563 7469 6f6e 2069 7320    connection is 
-00018500: 7375 6363 6573 7366 756c 2e0a 0a20 2020  successful...   
-00018510: 2049 7420 6361 6e20 6265 2075 7365 6420   It can be used 
-00018520: 746f 2063 6865 636b 2069 6620 7468 6520  to check if the 
-00018530: 636f 6e74 726f 6c6c 6572 2069 7320 6163  controller is ac
-00018540: 6365 7373 6962 6c65 2028 7369 6e63 6520  cessible (since 
-00018550: 7468 6520 6175 746f 7374 6f70 0a20 2020  the autostop.   
-00018560: 2069 7320 7365 7420 666f 7220 7468 6520   is set for the 
-00018570: 636f 6e74 726f 6c6c 6572 2920 6265 666f  controller) befo
-00018580: 7265 2074 6865 2073 706f 742f 7365 7276  re the spot/serv
-00018590: 6520 636f 6d6d 616e 6473 2069 6e74 6572  e commands inter
-000185a0: 6163 7420 7769 7468 2074 6865 0a20 2020  act with the.   
-000185b0: 2063 6f6e 7472 6f6c 6c65 722e 0a0a 2020   controller...  
-000185c0: 2020 436c 7573 7465 724e 6f74 5570 4572    ClusterNotUpEr
-000185d0: 726f 7220 7769 6c6c 2062 6520 7261 6973  ror will be rais
-000185e0: 6564 2077 6865 6e65 7665 7220 7468 6520  ed whenever the 
-000185f0: 636f 6e74 726f 6c6c 6572 2063 616e 6e6f  controller canno
-00018600: 7420 6265 2061 6363 6573 7365 642e 0a0a  t be accessed...
-00018610: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-00018620: 2020 7479 7065 3a20 5479 7065 206f 6620    type: Type of 
-00018630: 7468 6520 636f 6e74 726f 6c6c 6572 2e0a  the controller..
-00018640: 2020 2020 2020 2020 7374 6f70 7065 645f          stopped_
-00018650: 6d65 7373 6167 653a 204d 6573 7361 6765  message: Message
-00018660: 2074 6f20 7072 696e 7420 6966 2074 6865   to print if the
-00018670: 2063 6f6e 7472 6f6c 6c65 7220 6973 2053   controller is S
-00018680: 544f 5050 4544 2e0a 2020 2020 2020 2020  TOPPED..        
-00018690: 6e6f 6e5f 6578 6973 7465 6e74 5f6d 6573  non_existent_mes
-000186a0: 7361 6765 3a20 4d65 7373 6167 6520 746f  sage: Message to
-000186b0: 2073 686f 7720 6966 2074 6865 2063 6f6e   show if the con
-000186c0: 7472 6f6c 6c65 7220 646f 6573 206e 6f74  troller does not
-000186d0: 2065 7869 7374 2e0a 2020 2020 2020 2020   exist..        
-000186e0: 6578 6974 5f69 665f 6e6f 745f 6163 6365  exit_if_not_acce
-000186f0: 7373 6962 6c65 3a20 5768 6574 6865 7220  ssible: Whether 
-00018700: 746f 2065 7869 7420 6469 7265 6374 6c79  to exit directly
-00018710: 2069 6620 7468 6520 636f 6e74 726f 6c6c   if the controll
-00018720: 6572 2069 7320 6e6f 740a 2020 2020 2020  er is not.      
-00018730: 2020 2020 6163 6365 7373 6962 6c65 2e20      accessible. 
-00018740: 4966 2046 616c 7365 2c20 7468 6520 6675  If False, the fu
-00018750: 6e63 7469 6f6e 2077 696c 6c20 7261 6973  nction will rais
-00018760: 6520 436c 7573 7465 724e 6f74 5570 4572  e ClusterNotUpEr
-00018770: 726f 722e 0a0a 2020 2020 5265 7475 726e  ror...    Return
-00018780: 733a 0a20 2020 2020 2020 2068 616e 646c  s:.        handl
-00018790: 653a 2054 6865 2052 6573 6f75 7263 6548  e: The ResourceH
-000187a0: 616e 646c 6520 6f66 2074 6865 2063 6f6e  andle of the con
-000187b0: 7472 6f6c 6c65 722e 0a0a 2020 2020 5261  troller...    Ra
-000187c0: 6973 6573 3a0a 2020 2020 2020 2020 6578  ises:.        ex
-000187d0: 6365 7074 696f 6e73 2e43 6c75 7374 6572  ceptions.Cluster
-000187e0: 4f77 6e65 7249 6465 6e74 6974 794d 6973  OwnerIdentityMis
-000187f0: 6d61 7463 6845 7272 6f72 3a20 6966 2074  matchError: if t
-00018800: 6865 2063 7572 7265 6e74 2075 7365 7220  he current user 
-00018810: 6973 206e 6f74 0a20 2020 2020 2020 2020  is not.         
-00018820: 2074 6865 2073 616d 6520 6173 2074 6865   the same as the
-00018830: 2075 7365 7220 7768 6f20 6372 6561 7465   user who create
-00018840: 6420 7468 6520 636c 7573 7465 722e 0a20  d the cluster.. 
-00018850: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
-00018860: 732e 436c 6f75 6455 7365 7249 6465 6e74  s.CloudUserIdent
-00018870: 6974 7945 7272 6f72 3a20 6966 2077 6520  ityError: if we 
-00018880: 6661 696c 2074 6f20 6765 7420 7468 6520  fail to get the 
-00018890: 6375 7272 656e 7420 7573 6572 0a20 2020  current user.   
-000188a0: 2020 2020 2020 2069 6465 6e74 6974 792e         identity.
-000188b0: 0a20 2020 2020 2020 2065 7863 6570 7469  .        excepti
-000188c0: 6f6e 732e 436c 7573 7465 724e 6f74 5570  ons.ClusterNotUp
-000188d0: 4572 726f 723a 2069 6620 7468 6520 636f  Error: if the co
-000188e0: 6e74 726f 6c6c 6572 2069 7320 6e6f 7420  ntroller is not 
-000188f0: 6163 6365 7373 6962 6c65 2c20 6f72 0a20  accessible, or. 
-00018900: 2020 2020 2020 2020 2066 6169 6c65 6420           failed 
-00018910: 746f 2062 6520 636f 6e6e 6563 7465 642e  to be connected.
-00018920: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
-00018930: 6e6f 6e5f 6578 6973 7465 6e74 5f6d 6573  non_existent_mes
-00018940: 7361 6765 2069 7320 4e6f 6e65 3a0a 2020  sage is None:.  
-00018950: 2020 2020 2020 6e6f 6e5f 6578 6973 7465        non_existe
-00018960: 6e74 5f6d 6573 7361 6765 203d 2028 0a20  nt_message = (. 
-00018970: 2020 2020 2020 2020 2020 2063 6f6e 7472             contr
-00018980: 6f6c 6c65 725f 7479 7065 2e76 616c 7565  oller_type.value
-00018990: 2e64 6566 6175 6c74 5f68 696e 745f 6966  .default_hint_if
-000189a0: 5f6e 6f6e 5f65 7869 7374 656e 7429 0a20  _non_existent). 
-000189b0: 2020 2063 6c75 7374 6572 5f6e 616d 6520     cluster_name 
-000189c0: 3d20 636f 6e74 726f 6c6c 6572 5f74 7970  = controller_typ
-000189d0: 652e 7661 6c75 652e 636c 7573 7465 725f  e.value.cluster_
-000189e0: 6e61 6d65 0a20 2020 2063 6f6e 7472 6f6c  name.    control
-000189f0: 6c65 725f 6e61 6d65 203d 2063 6f6e 7472  ler_name = contr
-00018a00: 6f6c 6c65 725f 7479 7065 2e76 616c 7565  oller_type.value
-00018a10: 2e6e 616d 652e 7265 706c 6163 6528 2720  .name.replace(' 
-00018a20: 636f 6e74 726f 6c6c 6572 272c 2027 2729  controller', '')
-00018a30: 0a20 2020 206e 6565 645f 636f 6e6e 6563  .    need_connec
-00018a40: 7469 6f6e 5f63 6865 636b 203d 2046 616c  tion_check = Fal
-00018a50: 7365 0a20 2020 2063 6f6e 7472 6f6c 6c65  se.    controlle
-00018a60: 725f 7374 6174 7573 2c20 6861 6e64 6c65  r_status, handle
-00018a70: 203d 204e 6f6e 652c 204e 6f6e 650a 2020   = None, None.  
-00018a80: 2020 7472 793a 0a20 2020 2020 2020 2023    try:.        #
-00018a90: 2053 6574 2066 6f72 6365 5f72 6566 7265   Set force_refre
-00018aa0: 7368 5f73 7461 7475 7365 733d 5b49 4e49  sh_statuses=[INI
-00018ab0: 545d 2074 6f20 6d61 6b65 2073 7572 6520  T] to make sure 
-00018ac0: 7468 6520 7265 6672 6573 6820 6861 7070  the refresh happ
-00018ad0: 656e 730a 2020 2020 2020 2020 2320 7768  ens.        # wh
-00018ae0: 656e 2074 6865 2063 6f6e 7472 6f6c 6c65  en the controlle
-00018af0: 7220 6973 2049 4e49 542f 5550 2028 7472  r is INIT/UP (tr
-00018b00: 6967 6765 7265 6420 696e 2074 6865 7365  iggered in these
-00018b10: 2073 7461 7475 7365 7320 6173 2074 6865   statuses as the
-00018b20: 0a20 2020 2020 2020 2023 2061 7574 6f73  .        # autos
-00018b30: 746f 7020 6973 2061 6c77 6179 7320 7365  top is always se
-00018b40: 7420 666f 7220 7468 6520 636f 6e74 726f  t for the contro
-00018b50: 6c6c 6572 292e 2054 6865 2063 6f6e 7472  ller). The contr
-00018b60: 6f6c 6c65 7220 6361 6e20 6265 2069 6e0a  oller can be in.
-00018b70: 2020 2020 2020 2020 2320 666f 6c6c 6f77          # follow
-00018b80: 696e 6720 6361 7365 733a 0a20 2020 2020  ing cases:.     
-00018b90: 2020 2023 202a 2028 5550 2c20 6175 746f     # * (UP, auto
-00018ba0: 7374 6f70 2073 6574 293a 2069 7420 7769  stop set): it wi
-00018bb0: 6c6c 2062 6520 7265 6672 6573 6865 6420  ll be refreshed 
-00018bc0: 7769 7468 6f75 7420 666f 7263 655f 7265  without force_re
-00018bd0: 6672 6573 6820 7365 742e 0a20 2020 2020  fresh set..     
-00018be0: 2020 2023 202a 2028 5550 2c20 6e6f 2061     # * (UP, no a
-00018bf0: 7574 6f73 746f 7029 3a20 7665 7279 2072  utostop): very r
-00018c00: 6172 6520 2861 2075 7365 7220 6374 726c  are (a user ctrl
-00018c10: 2d63 2077 6865 6e20 7468 6520 636f 6e74  -c when the cont
-00018c20: 726f 6c6c 6572 2069 730a 2020 2020 2020  roller is.      
-00018c30: 2020 2320 2020 6c61 756e 6368 696e 6729    #   launching)
-00018c40: 2c20 646f 6573 206e 6f74 206d 6174 7465  , does not matte
-00018c50: 7220 6966 2072 6566 7265 7368 206f 7220  r if refresh or 
-00018c60: 6e6f 742c 2073 696e 6365 206e 6f20 6175  not, since no au
-00018c70: 746f 7374 6f70 2e20 5765 0a20 2020 2020  tostop. We.     
-00018c80: 2020 2023 2020 2064 6f6e 2774 2069 6e63     #   don't inc
-00018c90: 6c75 6465 2055 5020 696e 2066 6f72 6365  lude UP in force
-00018ca0: 5f72 6566 7265 7368 5f73 7461 7475 7365  _refresh_statuse
-00018cb0: 7320 746f 2061 766f 6964 206f 7665 7268  s to avoid overh
-00018cc0: 6561 6473 2e0a 2020 2020 2020 2020 2320  eads..        # 
-00018cd0: 2a20 2849 4e49 542c 2061 7574 6f73 746f  * (INIT, autosto
-00018ce0: 7020 7365 7429 0a20 2020 2020 2020 2023  p set).        #
-00018cf0: 202a 2028 494e 4954 2c20 6e6f 2061 7574   * (INIT, no aut
-00018d00: 6f73 746f 7029 3a20 7665 7279 2072 6172  ostop): very rar
-00018d10: 6520 285f 7570 6461 7465 5f63 6c75 7374  e (_update_clust
-00018d20: 6572 5f73 7461 7475 735f 6e6f 5f6c 6f63  er_status_no_loc
-00018d30: 6b20 6d61 790a 2020 2020 2020 2020 2320  k may.        # 
-00018d40: 2020 7265 7365 7420 6c6f 6361 6c20 6175    reset local au
-00018d50: 746f 7374 6f70 2063 6f6e 6669 6729 2c20  tostop config), 
-00018d60: 6275 7420 666f 7263 655f 7265 6672 6573  but force_refres
-00018d70: 6820 7769 6c6c 206d 616b 6520 7375 7265  h will make sure
-00018d80: 0a20 2020 2020 2020 2023 2020 2073 7461  .        #   sta
-00018d90: 7475 7320 6973 2072 6566 7265 7368 6564  tus is refreshed
-00018da0: 2e0a 2020 2020 2020 2020 230a 2020 2020  ..        #.    
-00018db0: 2020 2020 2320 5765 2061 766f 6964 7320      # We avoids 
-00018dc0: 756e 6e65 6365 7373 6172 7920 636f 7374  unnecessary cost
-00018dd0: 6c79 2072 6566 7265 7368 2077 6865 6e20  ly refresh when 
-00018de0: 7468 6520 636f 6e74 726f 6c6c 6572 2069  the controller i
-00018df0: 7320 616c 7265 6164 790a 2020 2020 2020  s already.      
-00018e00: 2020 2320 5354 4f50 5045 442e 2054 6869    # STOPPED. Thi
-00018e10: 7320 6f70 7469 6d69 7a61 7469 6f6e 2069  s optimization i
-00018e20: 7320 6261 7365 6420 6f6e 2074 6865 2061  s based on the a
-00018e30: 7373 756d 7074 696f 6e20 7468 6174 2074  ssumption that t
-00018e40: 6865 2075 7365 720a 2020 2020 2020 2020  he user.        
-00018e50: 2320 7769 6c6c 206e 6f74 2073 7461 7274  # will not start
-00018e60: 2074 6865 2063 6f6e 7472 6f6c 6c65 7220   the controller 
-00018e70: 6d61 6e75 616c 6c79 2066 726f 6d20 7468  manually from th
-00018e80: 6520 636c 6f75 6420 636f 6e73 6f6c 652e  e cloud console.
-00018e90: 0a20 2020 2020 2020 2023 0a20 2020 2020  .        #.     
-00018ea0: 2020 2023 2054 6865 2061 6371 7569 7265     # The acquire
-00018eb0: 5f6c 6f63 6b5f 7469 6d65 6f75 7420 6973  _lock_timeout is
-00018ec0: 2073 6574 2074 6f20 3020 746f 2061 766f   set to 0 to avo
-00018ed0: 6964 2068 616e 6769 6e67 2074 6865 2063  id hanging the c
-00018ee0: 6f6d 6d61 6e64 2077 6865 6e0a 2020 2020  ommand when.    
-00018ef0: 2020 2020 2320 6d75 6c74 6970 6c65 2073      # multiple s
-00018f00: 706f 742e 6c61 756e 6368 2063 6f6d 6d61  pot.launch comma
-00018f10: 6e64 7320 6172 6520 7275 6e6e 696e 6720  nds are running 
-00018f20: 6174 2074 6865 2073 616d 6520 7469 6d65  at the same time
-00018f30: 2e20 4f75 7220 6c61 7465 720a 2020 2020  . Our later.    
-00018f40: 2020 2020 2320 636f 6465 2077 696c 6c20      # code will 
-00018f50: 6368 6563 6b20 6966 2074 6865 2063 6f6e  check if the con
-00018f60: 7472 6f6c 6c65 7220 6973 2061 6363 6573  troller is acces
-00018f70: 7369 626c 6520 6279 2064 6972 6563 746c  sible by directl
-00018f80: 7920 6368 6563 6b69 6e67 0a20 2020 2020  y checking.     
-00018f90: 2020 2023 2074 6865 2073 7368 2063 6f6e     # the ssh con
-00018fa0: 6e65 6374 696f 6e20 746f 2074 6865 2063  nection to the c
-00018fb0: 6f6e 7472 6f6c 6c65 722c 2069 6620 6974  ontroller, if it
-00018fc0: 2066 6169 6c73 2074 6f20 6765 7420 6163   fails to get ac
-00018fd0: 6375 7261 7465 0a20 2020 2020 2020 2023  curate.        #
-00018fe0: 2073 7461 7475 7320 6f66 2074 6865 2063   status of the c
-00018ff0: 6f6e 7472 6f6c 6c65 722e 0a20 2020 2020  ontroller..     
-00019000: 2020 2063 6f6e 7472 6f6c 6c65 725f 7374     controller_st
-00019010: 6174 7573 2c20 6861 6e64 6c65 203d 2072  atus, handle = r
-00019020: 6566 7265 7368 5f63 6c75 7374 6572 5f73  efresh_cluster_s
-00019030: 7461 7475 735f 6861 6e64 6c65 280a 2020  tatus_handle(.  
-00019040: 2020 2020 2020 2020 2020 636c 7573 7465            cluste
-00019050: 725f 6e61 6d65 2c0a 2020 2020 2020 2020  r_name,.        
-00019060: 2020 2020 666f 7263 655f 7265 6672 6573      force_refres
-00019070: 685f 7374 6174 7573 6573 3d5b 7374 6174  h_statuses=[stat
-00019080: 7573 5f6c 6962 2e43 6c75 7374 6572 5374  us_lib.ClusterSt
-00019090: 6174 7573 2e49 4e49 545d 2c0a 2020 2020  atus.INIT],.    
-000190a0: 2020 2020 2020 2020 636c 7573 7465 725f          cluster_
-000190b0: 7374 6174 7573 5f6c 6f63 6b5f 7469 6d65  status_lock_time
-000190c0: 6f75 743d 3029 0a20 2020 2065 7863 6570  out=0).    excep
-000190d0: 7420 6578 6365 7074 696f 6e73 2e43 6c75  t exceptions.Clu
-000190e0: 7374 6572 5374 6174 7573 4665 7463 6869  sterStatusFetchi
-000190f0: 6e67 4572 726f 7220 6173 2065 3a0a 2020  ngError as e:.  
-00019100: 2020 2020 2020 2320 5765 2064 6f20 6e6f        # We do no
-00019110: 7420 6361 7463 6820 7468 6520 6578 6365  t catch the exce
-00019120: 7074 696f 6e73 2072 656c 6174 6564 2074  ptions related t
-00019130: 6f20 7468 6520 636c 7573 7465 7220 6f77  o the cluster ow
-00019140: 6e65 7220 6964 656e 7469 7479 0a20 2020  ner identity.   
-00019150: 2020 2020 2023 206d 6973 6d61 7463 682c       # mismatch,
-00019160: 2070 6c65 6173 6520 7265 6665 7220 746f   please refer to
-00019170: 2074 6865 2063 6f6d 6d65 6e74 2069 6e0a   the comment in.
-00019180: 2020 2020 2020 2020 2320 6062 6163 6b65          # `backe
-00019190: 6e64 5f75 7469 6c73 2e63 6865 636b 5f63  nd_utils.check_c
-000191a0: 6c75 7374 6572 5f61 7661 696c 6162 6c65  luster_available
-000191b0: 602e 0a20 2020 2020 2020 206c 6f67 6765  `..        logge
-000191c0: 722e 7761 726e 696e 6728 0a20 2020 2020  r.warning(.     
-000191d0: 2020 2020 2020 2027 4661 696c 6564 2074         'Failed t
-000191e0: 6f20 6765 7420 7468 6520 7374 6174 7573  o get the status
-000191f0: 206f 6620 7468 6520 636f 6e74 726f 6c6c   of the controll
-00019200: 6572 2e20 4974 2069 7320 6e6f 7420 270a  er. It is not '.
-00019210: 2020 2020 2020 2020 2020 2020 6627 6661              f'fa
-00019220: 7461 6c2c 2062 7574 207b 636f 6e74 726f  tal, but {contro
-00019230: 6c6c 6572 5f6e 616d 657d 2063 6f6d 6d61  ller_name} comma
-00019240: 6e64 732f 6361 6c6c 7320 6d61 7920 6861  nds/calls may ha
-00019250: 6e67 206f 7220 7265 7475 726e 2027 0a20  ng or return '. 
-00019260: 2020 2020 2020 2020 2020 2027 7374 616c             'stal
-00019270: 6520 696e 666f 726d 6174 696f 6e2c 2077  e information, w
-00019280: 6865 6e20 7468 6520 636f 6e74 726f 6c6c  hen the controll
-00019290: 6572 2069 7320 6e6f 7420 7570 2e5c 6e27  er is not up.\n'
-000192a0: 0a20 2020 2020 2020 2020 2020 2066 2720  .            f' 
-000192b0: 2044 6574 6169 6c73 3a20 7b63 6f6d 6d6f   Details: {commo
-000192c0: 6e5f 7574 696c 732e 666f 726d 6174 5f65  n_utils.format_e
-000192d0: 7863 6570 7469 6f6e 2865 2c20 7573 655f  xception(e, use_
-000192e0: 6272 6163 6b65 743d 5472 7565 297d 2729  bracket=True)}')
-000192f0: 0a20 2020 2020 2020 2072 6563 6f72 6420  .        record 
-00019300: 3d20 676c 6f62 616c 5f75 7365 725f 7374  = global_user_st
-00019310: 6174 652e 6765 745f 636c 7573 7465 725f  ate.get_cluster_
-00019320: 6672 6f6d 5f6e 616d 6528 636c 7573 7465  from_name(cluste
-00019330: 725f 6e61 6d65 290a 2020 2020 2020 2020  r_name).        
-00019340: 6966 2072 6563 6f72 6420 6973 206e 6f74  if record is not
-00019350: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00019360: 2020 2063 6f6e 7472 6f6c 6c65 725f 7374     controller_st
-00019370: 6174 7573 2c20 6861 6e64 6c65 203d 2072  atus, handle = r
-00019380: 6563 6f72 645b 2773 7461 7475 7327 5d2c  ecord['status'],
-00019390: 2072 6563 6f72 645b 2768 616e 646c 6527   record['handle'
-000193a0: 5d0a 2020 2020 2020 2020 2020 2020 2320  ].            # 
-000193b0: 5765 2063 6865 636b 2074 6865 2063 6f6e  We check the con
-000193c0: 6e65 6374 696f 6e20 6576 656e 2069 6620  nection even if 
-000193d0: 7468 6520 636c 7573 7465 7220 6861 7320  the cluster has 
-000193e0: 6120 6361 6368 6564 2073 7461 7475 7320  a cached status 
-000193f0: 5550 0a20 2020 2020 2020 2020 2020 2023  UP.            #
-00019400: 2074 6f20 6d61 6b65 2073 7572 6520 7468   to make sure th
-00019410: 6520 636f 6e74 726f 6c6c 6572 2069 7320  e controller is 
-00019420: 6163 7475 616c 6c79 2061 6363 6573 7369  actually accessi
-00019430: 626c 652c 2061 7320 7468 6520 6361 6368  ble, as the cach
-00019440: 6564 0a20 2020 2020 2020 2020 2020 2023  ed.            #
-00019450: 2073 7461 7475 7320 6d69 6768 7420 6265   status might be
-00019460: 2073 7461 6c65 2e0a 2020 2020 2020 2020   stale..        
-00019470: 2020 2020 6e65 6564 5f63 6f6e 6e65 6374      need_connect
-00019480: 696f 6e5f 6368 6563 6b20 3d20 5472 7565  ion_check = True
-00019490: 0a0a 2020 2020 6572 726f 725f 6d73 6720  ..    error_msg 
-000194a0: 3d20 4e6f 6e65 0a20 2020 2069 6620 636f  = None.    if co
-000194b0: 6e74 726f 6c6c 6572 5f73 7461 7475 7320  ntroller_status 
-000194c0: 3d3d 2073 7461 7475 735f 6c69 622e 436c  == status_lib.Cl
-000194d0: 7573 7465 7253 7461 7475 732e 5354 4f50  usterStatus.STOP
-000194e0: 5045 443a 0a20 2020 2020 2020 2065 7272  PED:.        err
-000194f0: 6f72 5f6d 7367 203d 2073 746f 7070 6564  or_msg = stopped
-00019500: 5f6d 6573 7361 6765 0a20 2020 2065 6c69  _message.    eli
-00019510: 6620 636f 6e74 726f 6c6c 6572 5f73 7461  f controller_sta
-00019520: 7475 7320 6973 204e 6f6e 6520 6f72 2068  tus is None or h
-00019530: 616e 646c 6520 6973 204e 6f6e 6520 6f72  andle is None or
-00019540: 2068 616e 646c 652e 6865 6164 5f69 7020   handle.head_ip 
-00019550: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00019560: 2023 2057 6520 6368 6563 6b20 7468 6520   # We check the 
-00019570: 636f 6e74 726f 6c6c 6572 2069 7320 5354  controller is ST
-00019580: 4f50 5045 4420 6265 666f 7265 2074 6865  OPPED before the
-00019590: 2063 6865 636b 2066 6f72 2068 616e 646c   check for handl
-000195a0: 652e 6865 6164 5f69 700a 2020 2020 2020  e.head_ip.      
-000195b0: 2020 2320 4e6f 6e65 2062 6563 6175 7365    # None because
-000195c0: 2077 6865 6e20 7468 6520 636f 6e74 726f   when the contro
-000195d0: 6c6c 6572 2069 7320 5354 4f50 5045 442c  ller is STOPPED,
-000195e0: 2068 616e 646c 652e 6865 6164 5f69 7020   handle.head_ip 
-000195f0: 6361 6e20 616c 736f 0a20 2020 2020 2020  can also.       
-00019600: 2023 2062 6520 4e6f 6e65 2c20 6275 7420   # be None, but 
-00019610: 7765 206f 6e6c 7920 7761 6e74 2074 6f20  we only want to 
-00019620: 6361 7463 6820 7468 6520 6361 7365 2077  catch the case w
-00019630: 6865 6e20 7468 6520 636f 6e74 726f 6c6c  hen the controll
-00019640: 6572 2069 730a 2020 2020 2020 2020 2320  er is.        # 
-00019650: 6265 696e 6720 7072 6f76 6973 696f 6e65  being provisione
-00019660: 6420 6174 2074 6865 2066 6972 7374 2074  d at the first t
-00019670: 696d 6520 616e 6420 6861 7665 206e 6f20  ime and have no 
-00019680: 6865 6164 5f69 702e 0a20 2020 2020 2020  head_ip..       
-00019690: 2065 7272 6f72 5f6d 7367 203d 206e 6f6e   error_msg = non
-000196a0: 5f65 7869 7374 656e 745f 6d65 7373 6167  _existent_messag
-000196b0: 650a 2020 2020 656c 6966 2028 636f 6e74  e.    elif (cont
-000196c0: 726f 6c6c 6572 5f73 7461 7475 7320 3d3d  roller_status ==
-000196d0: 2073 7461 7475 735f 6c69 622e 436c 7573   status_lib.Clus
-000196e0: 7465 7253 7461 7475 732e 494e 4954 206f  terStatus.INIT o
-000196f0: 720a 2020 2020 2020 2020 2020 6e65 6564  r.          need
-00019700: 5f63 6f6e 6e65 6374 696f 6e5f 6368 6563  _connection_chec
-00019710: 6b29 3a0a 2020 2020 2020 2020 2320 4368  k):.        # Ch
-00019720: 6563 6b20 7373 6820 636f 6e6e 6563 7469  eck ssh connecti
-00019730: 6f6e 2069 6620 2831 2920 636f 6e74 726f  on if (1) contro
-00019740: 6c6c 6572 2069 7320 696e 2049 4e49 5420  ller is in INIT 
-00019750: 7374 6174 652c 206f 7220 2832 2920 7765  state, or (2) we
-00019760: 2066 6169 6c65 6420 746f 2066 6574 6368   failed to fetch
-00019770: 2074 6865 0a20 2020 2020 2020 2023 2073   the.        # s
-00019780: 7461 7475 732c 2062 6f74 6820 6f66 2077  tatus, both of w
-00019790: 6869 6368 2063 616e 2068 6170 7065 6e20  hich can happen 
-000197a0: 7768 656e 2063 6f6e 7472 6f6c 6c65 7227  when controller'
-000197b0: 7320 7374 6174 7573 206c 6f63 6b20 6973  s status lock is
-000197c0: 2068 656c 6420 6279 2061 6e6f 7468 6572   held by another
-000197d0: 2060 736b 7920 7370 6f74 206c 6175 6e63   `sky spot launc
-000197e0: 6860 206f 720a 2020 2020 2020 2020 2320  h` or.        # 
-000197f0: 6073 6b79 2073 6572 7665 2075 7060 2e20  `sky serve up`. 
-00019800: 4966 2077 6520 6861 7665 c2a0 636f 6e74  If we have..cont
-00019810: 726f 6c6c 6572 2773 2068 6561 645f 6970  roller's head_ip
-00019820: 2061 7661 696c 6162 6c65 2061 6e64 2069   available and i
-00019830: 7420 6973 2073 7368 2d72 6561 6368 6162  t is ssh-reachab
-00019840: 6c65 2c0a 2020 2020 2020 2020 2320 7765  le,.        # we
-00019850: 2063 616e 2061 6c6c 6f77 2061 6363 6573   can allow acces
-00019860: 7320 746f 2074 6865 2063 6f6e 7472 6f6c  s to the control
-00019870: 6c65 722e 0a20 2020 2020 2020 2073 7368  ler..        ssh
-00019880: 5f63 7265 6465 6e74 6961 6c73 203d 2073  _credentials = s
-00019890: 7368 5f63 7265 6465 6e74 6961 6c5f 6672  sh_credential_fr
-000198a0: 6f6d 5f79 616d 6c28 6861 6e64 6c65 2e63  om_yaml(handle.c
-000198b0: 6c75 7374 6572 5f79 616d 6c2c 0a20 2020  luster_yaml,.   
-000198c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000198d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000198e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000198f0: 6861 6e64 6c65 2e64 6f63 6b65 725f 7573  handle.docker_us
-00019900: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
-00019910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019930: 2020 2020 2020 2068 616e 646c 652e 7373         handle.ss
-00019940: 685f 7573 6572 290a 0a20 2020 2020 2020  h_user)..       
-00019950: 2072 756e 6e65 7220 3d20 636f 6d6d 616e   runner = comman
-00019960: 645f 7275 6e6e 6572 2e53 5348 436f 6d6d  d_runner.SSHComm
-00019970: 616e 6452 756e 6e65 7228 6861 6e64 6c65  andRunner(handle
-00019980: 2e68 6561 645f 6970 2c0a 2020 2020 2020  .head_ip,.      
-00019990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000199a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000199b0: 2020 2020 2020 2020 2020 202a 2a73 7368             **ssh
-000199c0: 5f63 7265 6465 6e74 6961 6c73 2c0a 2020  _credentials,.  
-000199d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000199e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000199f0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00019a00: 6f72 743d 6861 6e64 6c65 2e68 6561 645f  ort=handle.head_
-00019a10: 7373 685f 706f 7274 290a 2020 2020 2020  ssh_port).      
-00019a20: 2020 6966 206e 6f74 2072 756e 6e65 722e    if not runner.
-00019a30: 6368 6563 6b5f 636f 6e6e 6563 7469 6f6e  check_connection
-00019a40: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00019a50: 6572 726f 725f 6d73 6720 3d20 636f 6e74  error_msg = cont
-00019a60: 726f 6c6c 6572 5f74 7970 652e 7661 6c75  roller_type.valu
-00019a70: 652e 636f 6e6e 6563 7469 6f6e 5f65 7272  e.connection_err
-00019a80: 6f72 5f68 696e 740a 2020 2020 656c 7365  or_hint.    else
-00019a90: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
-00019aa0: 2063 6f6e 7472 6f6c 6c65 725f 7374 6174   controller_stat
-00019ab0: 7573 203d 3d20 7374 6174 7573 5f6c 6962  us == status_lib
-00019ac0: 2e43 6c75 7374 6572 5374 6174 7573 2e55  .ClusterStatus.U
-00019ad0: 502c 2068 616e 646c 650a 0a20 2020 2069  P, handle..    i
-00019ae0: 6620 6572 726f 725f 6d73 6720 6973 206e  f error_msg is n
-00019af0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00019b00: 2069 6620 6578 6974 5f69 665f 6e6f 745f   if exit_if_not_
-00019b10: 6163 6365 7373 6962 6c65 3a0a 2020 2020  accessible:.    
-00019b20: 2020 2020 2020 2020 736b 795f 6c6f 6767          sky_logg
-00019b30: 696e 672e 7072 696e 7428 6572 726f 725f  ing.print(error_
-00019b40: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
-00019b50: 2073 7973 2e65 7869 7428 3129 0a20 2020   sys.exit(1).   
-00019b60: 2020 2020 2077 6974 6820 7578 5f75 7469       with ux_uti
-00019b70: 6c73 2e70 7269 6e74 5f65 7863 6570 7469  ls.print_excepti
-00019b80: 6f6e 5f6e 6f5f 7472 6163 6562 6163 6b28  on_no_traceback(
-00019b90: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00019ba0: 6169 7365 2065 7863 6570 7469 6f6e 732e  aise exceptions.
-00019bb0: 436c 7573 7465 724e 6f74 5570 4572 726f  ClusterNotUpErro
-00019bc0: 7228 6572 726f 725f 6d73 672c 0a20 2020  r(error_msg,.   
-00019bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019bf0: 2020 2020 2020 2020 2020 2020 636c 7573              clus
-00019c00: 7465 725f 7374 6174 7573 3d63 6f6e 7472  ter_status=contr
-00019c10: 6f6c 6c65 725f 7374 6174 7573 2c0a 2020  oller_status,.  
-00019c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019c40: 2020 2020 2020 2020 2020 2020 2068 616e               han
-00019c50: 646c 653d 6861 6e64 6c65 290a 2020 2020  dle=handle).    
-00019c60: 6173 7365 7274 2068 616e 646c 6520 6973  assert handle is
-00019c70: 206e 6f74 204e 6f6e 6520 616e 6420 6861   not None and ha
-00019c80: 6e64 6c65 2e68 6561 645f 6970 2069 7320  ndle.head_ip is 
-00019c90: 6e6f 7420 4e6f 6e65 2c20 280a 2020 2020  not None, (.    
-00019ca0: 2020 2020 6861 6e64 6c65 2c20 636f 6e74      handle, cont
-00019cb0: 726f 6c6c 6572 5f73 7461 7475 7329 0a20  roller_status). 
-00019cc0: 2020 2072 6574 7572 6e20 6861 6e64 6c65     return handle
-00019cd0: 0a0a 0a63 6c61 7373 2043 6c6f 7564 4669  ...class CloudFi
-00019ce0: 6c74 6572 2865 6e75 6d2e 456e 756d 293a  lter(enum.Enum):
-00019cf0: 0a20 2020 2023 2046 696c 7465 7220 666f  .    # Filter fo
-00019d00: 7220 616c 6c20 7479 7065 7320 6f66 2063  r all types of c
-00019d10: 6c6f 7564 732e 0a20 2020 2041 4c4c 203d  louds..    ALL =
-00019d20: 2027 616c 6c27 0a20 2020 2023 2046 696c   'all'.    # Fil
-00019d30: 7465 7220 666f 7220 536b 7927 7320 6d61  ter for Sky's ma
-00019d40: 696e 2063 6c6f 7564 7320 2861 7773 2c20  in clouds (aws, 
-00019d50: 6763 702c 2061 7a75 7265 2c20 646f 636b  gcp, azure, dock
-00019d60: 6572 292e 0a20 2020 2043 4c4f 5544 535f  er)..    CLOUDS_
-00019d70: 414e 445f 444f 434b 4552 203d 2027 636c  AND_DOCKER = 'cl
-00019d80: 6f75 6473 2d61 6e64 2d64 6f63 6b65 7227  ouds-and-docker'
-00019d90: 0a20 2020 2023 2046 696c 7465 7220 666f  .    # Filter fo
-00019da0: 7220 6f6e 6c79 206c 6f63 616c 2063 6c6f  r only local clo
-00019db0: 7564 732e 0a20 2020 204c 4f43 414c 203d  uds..    LOCAL =
-00019dc0: 2027 6c6f 6361 6c27 0a0a 0a64 6566 2067   'local'...def g
-00019dd0: 6574 5f63 6c75 7374 6572 7328 0a20 2020  et_clusters(.   
-00019de0: 2069 6e63 6c75 6465 5f63 6f6e 7472 6f6c   include_control
-00019df0: 6c65 723a 2062 6f6f 6c2c 0a20 2020 2072  ler: bool,.    r
-00019e00: 6566 7265 7368 3a20 626f 6f6c 2c0a 2020  efresh: bool,.  
-00019e10: 2020 636c 7573 7465 725f 6e61 6d65 733a    cluster_names:
-00019e20: 204f 7074 696f 6e61 6c5b 556e 696f 6e5b   Optional[Union[
-00019e30: 7374 722c 204c 6973 745b 7374 725d 5d5d  str, List[str]]]
-00019e40: 203d 204e 6f6e 652c 0a29 202d 3e20 4c69   = None,.) -> Li
-00019e50: 7374 5b44 6963 745b 7374 722c 2041 6e79  st[Dict[str, Any
-00019e60: 5d5d 3a0a 2020 2020 2222 2252 6574 7572  ]]:.    """Retur
-00019e70: 6e73 2061 206c 6973 7420 6f66 2063 6163  ns a list of cac
-00019e80: 6865 6420 6f72 206f 7074 696f 6e61 6c6c  hed or optionall
-00019e90: 7920 7265 6672 6573 6865 6420 636c 7573  y refreshed clus
-00019ea0: 7465 7220 7265 636f 7264 732e 0a0a 2020  ter records...  
-00019eb0: 2020 436f 6d62 7320 7468 726f 7567 6820    Combs through 
-00019ec0: 7468 6520 6461 7461 6261 7365 2028 696e  the database (in
-00019ed0: 207e 2f2e 736b 792f 7374 6174 652e 6462   ~/.sky/state.db
-00019ee0: 2920 746f 2067 6574 2061 206c 6973 7420  ) to get a list 
-00019ef0: 6f66 2072 6563 6f72 6473 0a20 2020 2063  of records.    c
-00019f00: 6f72 7265 7370 6f6e 6469 6e67 2074 6f20  orresponding to 
-00019f10: 6c61 756e 6368 6564 2063 6c75 7374 6572  launched cluster
-00019f20: 7320 2866 696c 7465 7265 6420 6279 2060  s (filtered by `
-00019f30: 636c 7573 7465 725f 6e61 6d65 7360 2069  cluster_names` i
-00019f40: 6620 6974 2069 730a 2020 2020 7370 6563  f it is.    spec
-00019f50: 6966 6965 6429 2e20 5468 6520 7265 6672  ified). The refr
-00019f60: 6573 6820 666c 6167 2063 616e 2062 6520  esh flag can be 
-00019f70: 7573 6564 2074 6f20 666f 7263 6520 6120  used to force a 
-00019f80: 7265 6672 6573 6820 6f66 2074 6865 2073  refresh of the s
-00019f90: 7461 7475 730a 2020 2020 6f66 2074 6865  tatus.    of the
-00019fa0: 2063 6c75 7374 6572 732e 0a0a 2020 2020   clusters...    
-00019fb0: 4172 6773 3a0a 2020 2020 2020 2020 696e  Args:.        in
-00019fc0: 636c 7564 655f 636f 6e74 726f 6c6c 6572  clude_controller
-00019fd0: 3a20 5768 6574 6865 7220 746f 2069 6e63  : Whether to inc
-00019fe0: 6c75 6465 2063 6f6e 7472 6f6c 6c65 7273  lude controllers
-00019ff0: 2c20 652e 672e 2073 706f 7420 636f 6e74  , e.g. spot cont
-0001a000: 726f 6c6c 6572 0a20 2020 2020 2020 2020  roller.         
-0001a010: 2020 206f 7220 736b 7920 7365 7276 6520     or sky serve 
-0001a020: 636f 6e74 726f 6c6c 6572 2e0a 2020 2020  controller..    
-0001a030: 2020 2020 7265 6672 6573 683a 2057 6865      refresh: Whe
-0001a040: 7468 6572 2074 6f20 7265 6672 6573 6820  ther to refresh 
-0001a050: 7468 6520 7374 6174 7573 206f 6620 7468  the status of th
-0001a060: 6520 636c 7573 7465 7273 2e20 2852 6566  e clusters. (Ref
-0001a070: 7265 7368 696e 6720 7769 6c6c 0a20 2020  reshing will.   
-0001a080: 2020 2020 2020 2020 2073 6574 2074 6865           set the
-0001a090: 2073 7461 7475 7320 746f 2053 544f 5050   status to STOPP
-0001a0a0: 4544 2069 6620 7468 6520 636c 7573 7465  ED if the cluste
-0001a0b0: 7220 6361 6e6e 6f74 2062 6520 7069 6e67  r cannot be ping
-0001a0c0: 6564 2e29 0a20 2020 2020 2020 2063 6c6f  ed.).        clo
-0001a0d0: 7564 5f66 696c 7465 723a 2053 6574 7320  ud_filter: Sets 
-0001a0e0: 7768 6963 6820 636c 6f75 6473 2074 6f20  which clouds to 
-0001a0f0: 6669 6c65 7220 7468 726f 7567 6820 6672  filer through fr
-0001a100: 6f6d 2074 6865 2067 6c6f 6261 6c20 7573  om the global us
-0001a110: 6572 0a20 2020 2020 2020 2020 2020 2073  er.            s
-0001a120: 7461 7465 2e20 5375 7070 6f72 7473 2074  tate. Supports t
-0001a130: 6872 6565 2076 616c 7565 732c 2027 616c  hree values, 'al
-0001a140: 6c27 2066 6f72 2061 6c6c 2063 6c6f 7564  l' for all cloud
-0001a150: 732c 2027 7075 626c 6963 2720 666f 720a  s, 'public' for.
-0001a160: 2020 2020 2020 2020 2020 2020 7075 626c              publ
-0001a170: 6963 2063 6c6f 7564 7320 6f6e 6c79 2c20  ic clouds only, 
-0001a180: 616e 6420 276c 6f63 616c 2720 666f 7220  and 'local' for 
-0001a190: 6f6e 6c79 206c 6f63 616c 2063 6c6f 7564  only local cloud
-0001a1a0: 732e 0a20 2020 2020 2020 2063 6c75 7374  s..        clust
-0001a1b0: 6572 5f6e 616d 6573 3a20 4966 2070 726f  er_names: If pro
-0001a1c0: 7669 6465 642c 206f 6e6c 7920 7265 7475  vided, only retu
-0001a1d0: 726e 2072 6563 6f72 6473 2066 6f72 2074  rn records for t
-0001a1e0: 6865 2067 6976 656e 2063 6c75 7374 6572  he given cluster
-0001a1f0: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-0001a200: 6573 2e0a 0a20 2020 2052 6574 7572 6e73  es...    Returns
-0001a210: 3a0a 2020 2020 2020 2020 4120 6c69 7374  :.        A list
-0001a220: 206f 6620 636c 7573 7465 7220 7265 636f   of cluster reco
-0001a230: 7264 732e 2049 6620 7468 6520 636c 7573  rds. If the clus
-0001a240: 7465 7220 646f 6573 206e 6f74 2065 7869  ter does not exi
-0001a250: 7374 206f 7220 6861 7320 6265 656e 0a20  st or has been. 
-0001a260: 2020 2020 2020 2074 6572 6d69 6e61 7465         terminate
-0001a270: 642c 2074 6865 2072 6563 6f72 6420 7769  d, the record wi
-0001a280: 6c6c 2062 6520 6f6d 6974 7465 6420 6672  ll be omitted fr
-0001a290: 6f6d 2074 6865 2072 6574 7572 6e65 6420  om the returned 
-0001a2a0: 6c69 7374 2e0a 2020 2020 2222 220a 2020  list..    """.  
-0001a2b0: 2020 7265 636f 7264 7320 3d20 676c 6f62    records = glob
-0001a2c0: 616c 5f75 7365 725f 7374 6174 652e 6765  al_user_state.ge
-0001a2d0: 745f 636c 7573 7465 7273 2829 0a0a 2020  t_clusters()..  
-0001a2e0: 2020 6966 206e 6f74 2069 6e63 6c75 6465    if not include
-0001a2f0: 5f63 6f6e 7472 6f6c 6c65 723a 0a20 2020  _controller:.   
-0001a300: 2020 2020 2072 6563 6f72 6473 203d 205b       records = [
-0001a310: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
-0001a320: 6f72 6420 666f 7220 7265 636f 7264 2069  ord for record i
-0001a330: 6e20 7265 636f 7264 730a 2020 2020 2020  n records.      
-0001a340: 2020 2020 2020 6966 2063 6f6e 7472 6f6c        if control
-0001a350: 6c65 725f 7574 696c 732e 436f 6e74 726f  ler_utils.Contro
-0001a360: 6c6c 6572 732e 6672 6f6d 5f6e 616d 6528  llers.from_name(
-0001a370: 7265 636f 7264 5b27 6e61 6d65 275d 2920  record['name']) 
-0001a380: 6973 204e 6f6e 650a 2020 2020 2020 2020  is None.        
-0001a390: 5d0a 0a20 2020 2079 656c 6c6f 7720 3d20  ]..    yellow = 
-0001a3a0: 636f 6c6f 7261 6d61 2e46 6f72 652e 5945  colorama.Fore.YE
-0001a3b0: 4c4c 4f57 0a20 2020 2062 7269 6768 7420  LLOW.    bright 
-0001a3c0: 3d20 636f 6c6f 7261 6d61 2e53 7479 6c65  = colorama.Style
-0001a3d0: 2e42 5249 4748 540a 2020 2020 7265 7365  .BRIGHT.    rese
-0001a3e0: 7420 3d20 636f 6c6f 7261 6d61 2e53 7479  t = colorama.Sty
-0001a3f0: 6c65 2e52 4553 4554 5f41 4c4c 0a0a 2020  le.RESET_ALL..  
-0001a400: 2020 6966 2063 6c75 7374 6572 5f6e 616d    if cluster_nam
-0001a410: 6573 2069 7320 6e6f 7420 4e6f 6e65 3a0a  es is not None:.
-0001a420: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0001a430: 7461 6e63 6528 636c 7573 7465 725f 6e61  tance(cluster_na
-0001a440: 6d65 732c 2073 7472 293a 0a20 2020 2020  mes, str):.     
-0001a450: 2020 2020 2020 2063 6c75 7374 6572 5f6e         cluster_n
-0001a460: 616d 6573 203d 205b 636c 7573 7465 725f  ames = [cluster_
-0001a470: 6e61 6d65 735d 0a20 2020 2020 2020 206e  names].        n
-0001a480: 6577 5f72 6563 6f72 6473 203d 205b 5d0a  ew_records = [].
-0001a490: 2020 2020 2020 2020 6e6f 745f 6578 6973          not_exis
-0001a4a0: 745f 636c 7573 7465 725f 6e61 6d65 7320  t_cluster_names 
-0001a4b0: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
-0001a4c0: 2063 6c75 7374 6572 5f6e 616d 6520 696e   cluster_name in
-0001a4d0: 2063 6c75 7374 6572 5f6e 616d 6573 3a0a   cluster_names:.
-0001a4e0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0001a4f0: 7265 636f 7264 2069 6e20 7265 636f 7264  record in record
-0001a500: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0001a510: 2020 2069 6620 7265 636f 7264 5b27 6e61     if record['na
-0001a520: 6d65 275d 203d 3d20 636c 7573 7465 725f  me'] == cluster_
-0001a530: 6e61 6d65 3a0a 2020 2020 2020 2020 2020  name:.          
-0001a540: 2020 2020 2020 2020 2020 6e65 775f 7265            new_re
-0001a550: 636f 7264 732e 6170 7065 6e64 2872 6563  cords.append(rec
-0001a560: 6f72 6429 0a20 2020 2020 2020 2020 2020  ord).           
-0001a570: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
-0001a580: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0001a590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a5a0: 206e 6f74 5f65 7869 7374 5f63 6c75 7374   not_exist_clust
-0001a5b0: 6572 5f6e 616d 6573 2e61 7070 656e 6428  er_names.append(
-0001a5c0: 636c 7573 7465 725f 6e61 6d65 290a 2020  cluster_name).  
-0001a5d0: 2020 2020 2020 6966 206e 6f74 5f65 7869        if not_exi
-0001a5e0: 7374 5f63 6c75 7374 6572 5f6e 616d 6573  st_cluster_names
-0001a5f0: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
-0001a600: 7573 7465 7273 5f73 7472 203d 2027 2c20  usters_str = ', 
-0001a610: 272e 6a6f 696e 286e 6f74 5f65 7869 7374  '.join(not_exist
-0001a620: 5f63 6c75 7374 6572 5f6e 616d 6573 290a  _cluster_names).
-0001a630: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-0001a640: 6572 2e69 6e66 6f28 6627 436c 7573 7465  er.info(f'Cluste
-0001a650: 7228 7329 206e 6f74 2066 6f75 6e64 3a20  r(s) not found: 
-0001a660: 7b62 7269 6768 747d 7b63 6c75 7374 6572  {bright}{cluster
-0001a670: 735f 7374 727d 7b72 6573 6574 7d2e 2729  s_str}{reset}.')
-0001a680: 0a20 2020 2020 2020 2072 6563 6f72 6473  .        records
-0001a690: 203d 206e 6577 5f72 6563 6f72 6473 0a0a   = new_records..
-0001a6a0: 2020 2020 6966 206e 6f74 2072 6566 7265      if not refre
-0001a6b0: 7368 3a0a 2020 2020 2020 2020 7265 7475  sh:.        retu
-0001a6c0: 726e 2072 6563 6f72 6473 0a0a 2020 2020  rn records..    
-0001a6d0: 706c 7572 616c 203d 2027 7327 2069 6620  plural = 's' if 
-0001a6e0: 6c65 6e28 7265 636f 7264 7329 203e 2031  len(records) > 1
-0001a6f0: 2065 6c73 6520 2727 0a20 2020 2070 726f   else ''.    pro
-0001a700: 6772 6573 7320 3d20 7269 6368 5f70 726f  gress = rich_pro
-0001a710: 6772 6573 732e 5072 6f67 7265 7373 2874  gress.Progress(t
-0001a720: 7261 6e73 6965 6e74 3d54 7275 652c 0a20  ransient=True,. 
-0001a730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a750: 2020 2020 2072 6564 6972 6563 745f 7374       redirect_st
-0001a760: 646f 7574 3d46 616c 7365 2c0a 2020 2020  dout=False,.    
-0001a770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a790: 2020 7265 6469 7265 6374 5f73 7464 6572    redirect_stder
-0001a7a0: 723d 4661 6c73 6529 0a20 2020 2074 6173  r=False).    tas
-0001a7b0: 6b20 3d20 7072 6f67 7265 7373 2e61 6464  k = progress.add
-0001a7c0: 5f74 6173 6b28 0a20 2020 2020 2020 2066  _task(.        f
-0001a7d0: 275b 626f 6c64 2063 7961 6e5d 5265 6672  '[bold cyan]Refr
-0001a7e0: 6573 6869 6e67 2073 7461 7475 7320 666f  eshing status fo
-0001a7f0: 7220 7b6c 656e 2872 6563 6f72 6473 297d  r {len(records)}
-0001a800: 2063 6c75 7374 6572 7b70 6c75 7261 6c7d   cluster{plural}
-0001a810: 5b2f 5d27 2c0a 2020 2020 2020 2020 746f  [/]',.        to
-0001a820: 7461 6c3d 6c65 6e28 7265 636f 7264 7329  tal=len(records)
-0001a830: 290a 0a20 2020 2064 6566 205f 7265 6672  )..    def _refr
-0001a840: 6573 685f 636c 7573 7465 7228 636c 7573  esh_cluster(clus
-0001a850: 7465 725f 6e61 6d65 293a 0a20 2020 2020  ter_name):.     
-0001a860: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0001a870: 2020 2020 7265 636f 7264 203d 2072 6566      record = ref
-0001a880: 7265 7368 5f63 6c75 7374 6572 5f72 6563  resh_cluster_rec
-0001a890: 6f72 6428 0a20 2020 2020 2020 2020 2020  ord(.           
-0001a8a0: 2020 2020 2063 6c75 7374 6572 5f6e 616d       cluster_nam
-0001a8b0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0001a8c0: 2020 2066 6f72 6365 5f72 6566 7265 7368     force_refresh
-0001a8d0: 5f73 7461 7475 7365 733d 7365 7428 7374  _statuses=set(st
-0001a8e0: 6174 7573 5f6c 6962 2e43 6c75 7374 6572  atus_lib.Cluster
-0001a8f0: 5374 6174 7573 292c 0a20 2020 2020 2020  Status),.       
-0001a900: 2020 2020 2020 2020 2061 6371 7569 7265           acquire
-0001a910: 5f70 6572 5f63 6c75 7374 6572 5f73 7461  _per_cluster_sta
-0001a920: 7475 735f 6c6f 636b 3d54 7275 6529 0a20  tus_lock=True). 
-0001a930: 2020 2020 2020 2065 7863 6570 7420 2865         except (e
-0001a940: 7863 6570 7469 6f6e 732e 436c 7573 7465  xceptions.Cluste
-0001a950: 7253 7461 7475 7346 6574 6368 696e 6745  rStatusFetchingE
-0001a960: 7272 6f72 2c0a 2020 2020 2020 2020 2020  rror,.          
-0001a970: 2020 2020 2020 6578 6365 7074 696f 6e73        exceptions
-0001a980: 2e43 6c6f 7564 5573 6572 4964 656e 7469  .CloudUserIdenti
-0001a990: 7479 4572 726f 722c 0a20 2020 2020 2020  tyError,.       
-0001a9a0: 2020 2020 2020 2020 2065 7863 6570 7469           excepti
-0001a9b0: 6f6e 732e 436c 7573 7465 724f 776e 6572  ons.ClusterOwner
-0001a9c0: 4964 656e 7469 7479 4d69 736d 6174 6368  IdentityMismatch
-0001a9d0: 4572 726f 7229 2061 7320 653a 0a20 2020  Error) as e:.   
-0001a9e0: 2020 2020 2020 2020 2023 2044 6f20 6e6f           # Do no
-0001a9f0: 7420 6661 696c 2074 6865 2065 6e74 6972  t fail the entir
-0001aa00: 6520 7265 6672 6573 6820 7072 6f63 6573  e refresh proces
-0001aa10: 732e 2054 6865 2063 616c 6c65 7220 7769  s. The caller wi
-0001aa20: 6c6c 0a20 2020 2020 2020 2020 2020 2023  ll.            #
-0001aa30: 2068 616e 646c 6520 7468 6520 2755 4e4b   handle the 'UNK
-0001aa40: 4e4f 574e 2720 7374 6174 7573 2c20 616e  NOWN' status, an
-0001aa50: 6420 636f 6c6c 6563 7420 7468 6520 6572  d collect the er
-0001aa60: 726f 7273 2069 6e74 6f0a 2020 2020 2020  rors into.      
-0001aa70: 2020 2020 2020 2320 6120 7461 626c 652e        # a table.
-0001aa80: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
-0001aa90: 6f72 6420 3d20 7b27 7374 6174 7573 273a  ord = {'status':
-0001aaa0: 2027 554e 4b4e 4f57 4e27 2c20 2765 7272   'UNKNOWN', 'err
-0001aab0: 6f72 273a 2065 7d0a 2020 2020 2020 2020  or': e}.        
-0001aac0: 7072 6f67 7265 7373 2e75 7064 6174 6528  progress.update(
-0001aad0: 7461 736b 2c20 6164 7661 6e63 653d 3129  task, advance=1)
-0001aae0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001aaf0: 7265 636f 7264 0a0a 2020 2020 636c 7573  record..    clus
-0001ab00: 7465 725f 6e61 6d65 7320 3d20 5b72 6563  ter_names = [rec
-0001ab10: 6f72 645b 276e 616d 6527 5d20 666f 7220  ord['name'] for 
-0001ab20: 7265 636f 7264 2069 6e20 7265 636f 7264  record in record
-0001ab30: 735d 0a20 2020 2077 6974 6820 7072 6f67  s].    with prog
-0001ab40: 7265 7373 3a0a 2020 2020 2020 2020 7570  ress:.        up
-0001ab50: 6461 7465 645f 7265 636f 7264 7320 3d20  dated_records = 
-0001ab60: 7375 6270 726f 6365 7373 5f75 7469 6c73  subprocess_utils
-0001ab70: 2e72 756e 5f69 6e5f 7061 7261 6c6c 656c  .run_in_parallel
-0001ab80: 280a 2020 2020 2020 2020 2020 2020 5f72  (.            _r
-0001ab90: 6566 7265 7368 5f63 6c75 7374 6572 2c20  efresh_cluster, 
-0001aba0: 636c 7573 7465 725f 6e61 6d65 7329 0a0a  cluster_names)..
-0001abb0: 2020 2020 2320 5368 6f77 2069 6e66 6f72      # Show infor
-0001abc0: 6d61 7469 6f6e 2066 6f72 2072 656d 6f76  mation for remov
-0001abd0: 6564 2063 6c75 7374 6572 732e 0a20 2020  ed clusters..   
-0001abe0: 206b 6570 745f 7265 636f 7264 7320 3d20   kept_records = 
-0001abf0: 5b5d 0a20 2020 2061 7574 6f64 6f77 6e5f  [].    autodown_
-0001ac00: 636c 7573 7465 7273 2c20 7265 6d61 696e  clusters, remain
-0001ac10: 696e 675f 636c 7573 7465 7273 2c20 6661  ing_clusters, fa
-0001ac20: 696c 6564 5f63 6c75 7374 6572 7320 3d20  iled_clusters = 
-0001ac30: 5b5d 2c20 5b5d 2c20 5b5d 0a20 2020 2066  [], [], [].    f
-0001ac40: 6f72 2069 2c20 7265 636f 7264 2069 6e20  or i, record in 
-0001ac50: 656e 756d 6572 6174 6528 7265 636f 7264  enumerate(record
-0001ac60: 7329 3a0a 2020 2020 2020 2020 6966 2075  s):.        if u
-0001ac70: 7064 6174 6564 5f72 6563 6f72 6473 5b69  pdated_records[i
-0001ac80: 5d20 6973 204e 6f6e 653a 0a20 2020 2020  ] is None:.     
-0001ac90: 2020 2020 2020 2069 6620 7265 636f 7264         if record
-0001aca0: 5b27 746f 5f64 6f77 6e27 5d3a 0a20 2020  ['to_down']:.   
-0001acb0: 2020 2020 2020 2020 2020 2020 2061 7574               aut
-0001acc0: 6f64 6f77 6e5f 636c 7573 7465 7273 2e61  odown_clusters.a
-0001acd0: 7070 656e 6428 636c 7573 7465 725f 6e61  ppend(cluster_na
-0001ace0: 6d65 735b 695d 290a 2020 2020 2020 2020  mes[i]).        
-0001acf0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001ad00: 2020 2020 2020 2020 2020 7265 6d61 696e            remain
-0001ad10: 696e 675f 636c 7573 7465 7273 2e61 7070  ing_clusters.app
-0001ad20: 656e 6428 636c 7573 7465 725f 6e61 6d65  end(cluster_name
-0001ad30: 735b 695d 290a 2020 2020 2020 2020 656c  s[i]).        el
-0001ad40: 6966 2075 7064 6174 6564 5f72 6563 6f72  if updated_recor
-0001ad50: 6473 5b69 5d5b 2773 7461 7475 7327 5d20  ds[i]['status'] 
-0001ad60: 3d3d 2027 554e 4b4e 4f57 4e27 3a0a 2020  == 'UNKNOWN':.  
-0001ad70: 2020 2020 2020 2020 2020 6661 696c 6564            failed
-0001ad80: 5f63 6c75 7374 6572 732e 6170 7065 6e64  _clusters.append
-0001ad90: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001ada0: 2020 2863 6c75 7374 6572 5f6e 616d 6573    (cluster_names
-0001adb0: 5b69 5d2c 2075 7064 6174 6564 5f72 6563  [i], updated_rec
-0001adc0: 6f72 6473 5b69 5d5b 2765 7272 6f72 275d  ords[i]['error']
-0001add0: 2929 0a20 2020 2020 2020 2020 2020 2023  )).            #
-0001ade0: 204b 6565 7020 7468 6520 6f72 6967 696e   Keep the origin
-0001adf0: 616c 2072 6563 6f72 6420 6966 2074 6865  al record if the
-0001ae00: 2073 7461 7475 7320 6973 2075 6e6b 6e6f   status is unkno
-0001ae10: 776e 2c0a 2020 2020 2020 2020 2020 2020  wn,.            
-0001ae20: 2320 736f 2074 6861 7420 7468 6520 7573  # so that the us
-0001ae30: 6572 2063 616e 2073 7469 6c6c 2073 6565  er can still see
-0001ae40: 2074 6865 2063 6c75 7374 6572 2e0a 2020   the cluster..  
-0001ae50: 2020 2020 2020 2020 2020 6b65 7074 5f72            kept_r
-0001ae60: 6563 6f72 6473 2e61 7070 656e 6428 7265  ecords.append(re
-0001ae70: 636f 7264 290a 2020 2020 2020 2020 656c  cord).        el
-0001ae80: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001ae90: 6b65 7074 5f72 6563 6f72 6473 2e61 7070  kept_records.app
-0001aea0: 656e 6428 7570 6461 7465 645f 7265 636f  end(updated_reco
-0001aeb0: 7264 735b 695d 290a 0a20 2020 2069 6620  rds[i])..    if 
-0001aec0: 6175 746f 646f 776e 5f63 6c75 7374 6572  autodown_cluster
-0001aed0: 733a 0a20 2020 2020 2020 2070 6c75 7261  s:.        plura
-0001aee0: 6c20 3d20 2773 2720 6966 206c 656e 2861  l = 's' if len(a
-0001aef0: 7574 6f64 6f77 6e5f 636c 7573 7465 7273  utodown_clusters
-0001af00: 2920 3e20 3120 656c 7365 2027 270a 2020  ) > 1 else ''.  
-0001af10: 2020 2020 2020 636c 7573 7465 725f 7374        cluster_st
-0001af20: 7220 3d20 272c 2027 2e6a 6f69 6e28 6175  r = ', '.join(au
-0001af30: 746f 646f 776e 5f63 6c75 7374 6572 7329  todown_clusters)
-0001af40: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
-0001af50: 696e 666f 2866 2741 7574 6f64 6f77 6e65  info(f'Autodowne
-0001af60: 6420 636c 7573 7465 727b 706c 7572 616c  d cluster{plural
-0001af70: 7d3a 2027 0a20 2020 2020 2020 2020 2020  }: '.           
-0001af80: 2020 2020 2020 2020 2066 277b 6272 6967           f'{brig
-0001af90: 6874 7d7b 636c 7573 7465 725f 7374 727d  ht}{cluster_str}
-0001afa0: 7b72 6573 6574 7d27 290a 2020 2020 6966  {reset}').    if
-0001afb0: 2072 656d 6169 6e69 6e67 5f63 6c75 7374   remaining_clust
-0001afc0: 6572 733a 0a20 2020 2020 2020 2070 6c75  ers:.        plu
-0001afd0: 7261 6c20 3d20 2773 2720 6966 206c 656e  ral = 's' if len
-0001afe0: 2872 656d 6169 6e69 6e67 5f63 6c75 7374  (remaining_clust
-0001aff0: 6572 7329 203e 2031 2065 6c73 6520 2727  ers) > 1 else ''
-0001b000: 0a20 2020 2020 2020 2063 6c75 7374 6572  .        cluster
-0001b010: 5f73 7472 203d 2027 2c20 272e 6a6f 696e  _str = ', '.join
-0001b020: 286e 616d 6520 666f 7220 6e61 6d65 2069  (name for name i
-0001b030: 6e20 7265 6d61 696e 696e 675f 636c 7573  n remaining_clus
-0001b040: 7465 7273 290a 2020 2020 2020 2020 6c6f  ters).        lo
-0001b050: 6767 6572 2e77 6172 6e69 6e67 2866 277b  gger.warning(f'{
-0001b060: 7965 6c6c 6f77 7d43 6c75 7374 6572 7b70  yellow}Cluster{p
-0001b070: 6c75 7261 6c7d 2074 6572 6d69 6e61 7465  lural} terminate
-0001b080: 6420 6f6e 2027 0a20 2020 2020 2020 2020  d on '.         
-0001b090: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-0001b0a0: 7468 6520 636c 6f75 643a 207b 7265 7365  the cloud: {rese
-0001b0b0: 747d 7b62 7269 6768 747d 7b63 6c75 7374  t}{bright}{clust
-0001b0c0: 6572 5f73 7472 7d7b 7265 7365 747d 2729  er_str}{reset}')
-0001b0d0: 0a0a 2020 2020 6966 2066 6169 6c65 645f  ..    if failed_
-0001b0e0: 636c 7573 7465 7273 3a0a 2020 2020 2020  clusters:.      
-0001b0f0: 2020 706c 7572 616c 203d 2027 7327 2069    plural = 's' i
-0001b100: 6620 6c65 6e28 6661 696c 6564 5f63 6c75  f len(failed_clu
-0001b110: 7374 6572 7329 203e 2031 2065 6c73 6520  sters) > 1 else 
-0001b120: 2727 0a20 2020 2020 2020 206c 6f67 6765  ''.        logge
-0001b130: 722e 7761 726e 696e 6728 6627 7b79 656c  r.warning(f'{yel
-0001b140: 6c6f 777d 4661 696c 6564 2074 6f20 7265  low}Failed to re
-0001b150: 6672 6573 6820 7374 6174 7573 2066 6f72  fresh status for
-0001b160: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0001b170: 2020 2020 2020 2020 2020 6627 7b6c 656e            f'{len
-0001b180: 2866 6169 6c65 645f 636c 7573 7465 7273  (failed_clusters
-0001b190: 297d 2063 6c75 7374 6572 7b70 6c75 7261  )} cluster{plura
-0001b1a0: 6c7d 3a7b 7265 7365 747d 2729 0a20 2020  l}:{reset}').   
-0001b1b0: 2020 2020 2066 6f72 2063 6c75 7374 6572       for cluster
-0001b1c0: 5f6e 616d 652c 2065 2069 6e20 6661 696c  _name, e in fail
-0001b1d0: 6564 5f63 6c75 7374 6572 733a 0a20 2020  ed_clusters:.   
-0001b1e0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-0001b1f0: 7761 726e 696e 6728 6627 2020 7b62 7269  warning(f'  {bri
-0001b200: 6768 747d 7b63 6c75 7374 6572 5f6e 616d  ght}{cluster_nam
-0001b210: 657d 7b72 6573 6574 7d3a 207b 657d 2729  e}{reset}: {e}')
-0001b220: 0a20 2020 2072 6574 7572 6e20 6b65 7074  .    return kept
-0001b230: 5f72 6563 6f72 6473 0a0a 0a40 7479 7069  _records...@typi
-0001b240: 6e67 2e6f 7665 726c 6f61 640a 6465 6620  ng.overload.def 
-0001b250: 6765 745f 6261 636b 656e 645f 6672 6f6d  get_backend_from
-0001b260: 5f68 616e 646c 6528 0a20 2020 2068 616e  _handle(.    han
-0001b270: 646c 653a 2027 636c 6f75 645f 766d 5f72  dle: 'cloud_vm_r
-0001b280: 6179 5f62 6163 6b65 6e64 2e43 6c6f 7564  ay_backend.Cloud
-0001b290: 566d 5261 7952 6573 6f75 7263 6548 616e  VmRayResourceHan
-0001b2a0: 646c 6527 0a29 202d 3e20 2763 6c6f 7564  dle'.) -> 'cloud
-0001b2b0: 5f76 6d5f 7261 795f 6261 636b 656e 642e  _vm_ray_backend.
-0001b2c0: 436c 6f75 6456 6d52 6179 4261 636b 656e  CloudVmRayBacken
-0001b2d0: 6427 3a0a 2020 2020 2e2e 2e0a 0a0a 4074  d':.    ......@t
-0001b2e0: 7970 696e 672e 6f76 6572 6c6f 6164 0a64  yping.overload.d
-0001b2f0: 6566 2067 6574 5f62 6163 6b65 6e64 5f66  ef get_backend_f
-0001b300: 726f 6d5f 6861 6e64 6c65 280a 2020 2020  rom_handle(.    
-0001b310: 6861 6e64 6c65 3a20 276c 6f63 616c 5f64  handle: 'local_d
-0001b320: 6f63 6b65 725f 6261 636b 656e 642e 4c6f  ocker_backend.Lo
-0001b330: 6361 6c44 6f63 6b65 7252 6573 6f75 7263  calDockerResourc
-0001b340: 6548 616e 646c 6527 0a29 202d 3e20 276c  eHandle'.) -> 'l
-0001b350: 6f63 616c 5f64 6f63 6b65 725f 6261 636b  ocal_docker_back
-0001b360: 656e 642e 4c6f 6361 6c44 6f63 6b65 7242  end.LocalDockerB
-0001b370: 6163 6b65 6e64 273a 0a20 2020 202e 2e2e  ackend':.    ...
-0001b380: 0a0a 0a40 7479 7069 6e67 2e6f 7665 726c  ...@typing.overl
-0001b390: 6f61 640a 6465 6620 6765 745f 6261 636b  oad.def get_back
-0001b3a0: 656e 645f 6672 6f6d 5f68 616e 646c 6528  end_from_handle(
-0001b3b0: 0a20 2020 2020 2020 2068 616e 646c 653a  .        handle:
-0001b3c0: 2062 6163 6b65 6e64 732e 5265 736f 7572   backends.Resour
-0001b3d0: 6365 4861 6e64 6c65 2920 2d3e 2062 6163  ceHandle) -> bac
-0001b3e0: 6b65 6e64 732e 4261 636b 656e 643a 0a20  kends.Backend:. 
-0001b3f0: 2020 202e 2e2e 0a0a 0a64 6566 2067 6574     ......def get
-0001b400: 5f62 6163 6b65 6e64 5f66 726f 6d5f 6861  _backend_from_ha
-0001b410: 6e64 6c65 280a 2020 2020 2020 2020 6861  ndle(.        ha
-0001b420: 6e64 6c65 3a20 6261 636b 656e 6473 2e52  ndle: backends.R
-0001b430: 6573 6f75 7263 6548 616e 646c 6529 202d  esourceHandle) -
-0001b440: 3e20 6261 636b 656e 6473 2e42 6163 6b65  > backends.Backe
-0001b450: 6e64 3a0a 2020 2020 2222 2247 6574 7320  nd:.    """Gets 
-0001b460: 6120 4261 636b 656e 6420 6f62 6a65 6374  a Backend object
-0001b470: 2063 6f72 7265 7370 6f6e 6469 6e67 2074   corresponding t
-0001b480: 6f20 6120 6861 6e64 6c65 2e0a 0a20 2020  o a handle...   
-0001b490: 2049 6e73 7065 6374 7320 6861 6e64 6c65   Inspects handle
-0001b4a0: 2074 7970 6520 746f 2069 6e66 6572 2074   type to infer t
-0001b4b0: 6865 2062 6163 6b65 6e64 2075 7365 6420  he backend used 
-0001b4c0: 666f 7220 7468 6520 7265 736f 7572 6365  for the resource
-0001b4d0: 2e0a 2020 2020 2222 220a 2020 2020 6261  ..    """.    ba
-0001b4e0: 636b 656e 643a 2062 6163 6b65 6e64 732e  ckend: backends.
-0001b4f0: 4261 636b 656e 640a 2020 2020 6966 2069  Backend.    if i
-0001b500: 7369 6e73 7461 6e63 6528 6861 6e64 6c65  sinstance(handle
-0001b510: 2c20 6261 636b 656e 6473 2e43 6c6f 7564  , backends.Cloud
-0001b520: 566d 5261 7952 6573 6f75 7263 6548 616e  VmRayResourceHan
-0001b530: 646c 6529 3a0a 2020 2020 2020 2020 6261  dle):.        ba
-0001b540: 636b 656e 6420 3d20 6261 636b 656e 6473  ckend = backends
-0001b550: 2e43 6c6f 7564 566d 5261 7942 6163 6b65  .CloudVmRayBacke
-0001b560: 6e64 2829 0a20 2020 2065 6c69 6620 6973  nd().    elif is
-0001b570: 696e 7374 616e 6365 2868 616e 646c 652c  instance(handle,
-0001b580: 2062 6163 6b65 6e64 732e 4c6f 6361 6c44   backends.LocalD
-0001b590: 6f63 6b65 7252 6573 6f75 7263 6548 616e  ockerResourceHan
-0001b5a0: 646c 6529 3a0a 2020 2020 2020 2020 6261  dle):.        ba
-0001b5b0: 636b 656e 6420 3d20 6261 636b 656e 6473  ckend = backends
-0001b5c0: 2e4c 6f63 616c 446f 636b 6572 4261 636b  .LocalDockerBack
-0001b5d0: 656e 6428 290a 2020 2020 656c 7365 3a0a  end().    else:.
-0001b5e0: 2020 2020 2020 2020 7261 6973 6520 4e6f          raise No
-0001b5f0: 7449 6d70 6c65 6d65 6e74 6564 4572 726f  tImplementedErro
-0001b600: 7228 0a20 2020 2020 2020 2020 2020 2066  r(.            f
-0001b610: 2748 616e 646c 6520 7479 7065 207b 7479  'Handle type {ty
-0001b620: 7065 2868 616e 646c 6529 7d20 6973 206e  pe(handle)} is n
-0001b630: 6f74 2073 7570 706f 7274 6564 2079 6574  ot supported yet
-0001b640: 2e27 290a 2020 2020 7265 7475 726e 2062  .').    return b
-0001b650: 6163 6b65 6e64 0a0a 0a64 6566 2067 6574  ackend...def get
-0001b660: 5f74 6173 6b5f 6465 6d61 6e64 735f 6469  _task_demands_di
-0001b670: 6374 2874 6173 6b3a 2027 7461 736b 5f6c  ct(task: 'task_l
-0001b680: 6962 2e54 6173 6b27 2920 2d3e 2044 6963  ib.Task') -> Dic
-0001b690: 745b 7374 722c 2066 6c6f 6174 5d3a 0a20  t[str, float]:. 
-0001b6a0: 2020 2022 2222 5265 7475 726e 7320 7468     """Returns th
-0001b6b0: 6520 7265 736f 7572 6365 7320 6469 6374  e resources dict
-0001b6c0: 206f 6620 7468 6520 7461 736b 2e0a 0a20   of the task... 
-0001b6d0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-0001b6e0: 2020 2020 4120 6469 6374 206f 6620 7468      A dict of th
-0001b6f0: 6520 7265 736f 7572 6365 7320 6f66 2074  e resources of t
-0001b700: 6865 2074 6173 6b2e 2054 6865 206b 6579  he task. The key
-0001b710: 7320 6172 6520 7468 6520 7265 736f 7572  s are the resour
-0001b720: 6365 206e 616d 6573 0a20 2020 2020 2020  ce names.       
-0001b730: 2061 6e64 2074 6865 2076 616c 7565 7320   and the values 
-0001b740: 6172 6520 7468 6520 6e75 6d62 6572 206f  are the number o
-0001b750: 6620 7468 6520 7265 736f 7572 6365 732e  f the resources.
-0001b760: 2049 7420 616c 7761 7973 2063 6f6e 7461   It always conta
-0001b770: 696e 730a 2020 2020 2020 2020 7468 6520  ins.        the 
-0001b780: 4350 5520 7265 736f 7572 6365 2028 746f  CPU resource (to
-0001b790: 2063 6f6e 7472 6f6c 2074 6865 206d 6178   control the max
-0001b7a0: 696d 756d 206e 756d 6265 7220 6f66 2074  imum number of t
-0001b7b0: 6173 6b73 292c 2061 6e64 0a20 2020 2020  asks), and.     
-0001b7c0: 2020 206f 7074 696f 6e61 6c6c 7920 6163     optionally ac
-0001b7d0: 6365 6c65 7261 746f 7220 6465 6d61 6e64  celerator demand
-0001b7e0: 732e 0a20 2020 2022 2222 0a20 2020 2023  s..    """.    #
-0001b7f0: 2054 4f44 4f3a 2043 7573 746f 6d20 4350   TODO: Custom CP
-0001b800: 5520 616e 6420 6f74 6865 7220 6d65 6d6f  U and other memo
-0001b810: 7279 2072 6573 6f75 7263 6573 2061 7265  ry resources are
-0001b820: 206e 6f74 2073 7570 706f 7274 6564 2079   not supported y
-0001b830: 6574 2e0a 2020 2020 2320 466f 7220 736b  et..    # For sk
-0001b840: 7920 7370 6f74 2f73 6572 7665 2063 6f6e  y spot/serve con
-0001b850: 7472 6f6c 6c65 7220 7461 736b 2c20 7765  troller task, we
-0001b860: 2073 6574 2074 6865 2043 5055 2072 6573   set the CPU res
-0001b870: 6f75 7263 6520 746f 2061 2073 6d61 6c6c  ource to a small
-0001b880: 6572 0a20 2020 2023 2076 616c 7565 2074  er.    # value t
-0001b890: 6f20 7375 7070 6f72 7420 6120 6c61 7267  o support a larg
-0001b8a0: 6572 206e 756d 6265 7220 6f66 2073 706f  er number of spo
-0001b8b0: 7420 6a6f 6273 2061 6e64 2073 6572 7669  t jobs and servi
-0001b8c0: 6365 732e 0a20 2020 2072 6573 6f75 7263  ces..    resourc
-0001b8d0: 6573 5f64 6963 7420 3d20 7b0a 2020 2020  es_dict = {.    
-0001b8e0: 2020 2020 2743 5055 273a 2028 636f 6e73      'CPU': (cons
-0001b8f0: 7461 6e74 732e 434f 4e54 524f 4c4c 4552  tants.CONTROLLER
-0001b900: 5f50 524f 4345 5353 5f43 5055 5f44 454d  _PROCESS_CPU_DEM
-0001b910: 414e 440a 2020 2020 2020 2020 2020 2020  AND.            
-0001b920: 2020 2020 6966 2074 6173 6b2e 6973 5f63      if task.is_c
-0001b930: 6f6e 7472 6f6c 6c65 725f 7461 736b 2829  ontroller_task()
-0001b940: 2065 6c73 6520 4445 4641 554c 545f 5441   else DEFAULT_TA
-0001b950: 534b 5f43 5055 5f44 454d 414e 4429 0a20  SK_CPU_DEMAND). 
-0001b960: 2020 207d 0a20 2020 2069 6620 7461 736b     }.    if task
-0001b970: 2e62 6573 745f 7265 736f 7572 6365 7320  .best_resources 
-0001b980: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0001b990: 2020 2020 2072 6573 6f75 7263 6573 203d       resources =
-0001b9a0: 2074 6173 6b2e 6265 7374 5f72 6573 6f75   task.best_resou
-0001b9b0: 7263 6573 0a20 2020 2065 6c73 653a 0a20  rces.    else:. 
-0001b9c0: 2020 2020 2020 2023 2054 6173 6b20 6d61         # Task ma
-0001b9d0: 7920 2865 2e67 2e2c 2073 6b79 206c 6175  y (e.g., sky lau
-0001b9e0: 6e63 6829 206f 7220 6d61 7920 6e6f 7420  nch) or may not 
-0001b9f0: 2865 2e67 2e2c 2073 6b79 2065 7865 6329  (e.g., sky exec)
-0001ba00: 2068 6176 6520 756e 6465 7267 6f6e 650a   have undergone.
-0001ba10: 2020 2020 2020 2020 2320 736b 792e 6f70          # sky.op
-0001ba20: 7469 6d69 7a65 2829 2c20 736f 2062 6573  timize(), so bes
-0001ba30: 745f 7265 736f 7572 6365 7320 6d61 7920  t_resources may 
-0001ba40: 6265 204e 6f6e 652e 0a20 2020 2020 2020  be None..       
-0001ba50: 2061 7373 6572 7420 6c65 6e28 7461 736b   assert len(task
-0001ba60: 2e72 6573 6f75 7263 6573 2920 3d3d 2031  .resources) == 1
-0001ba70: 2c20 7461 736b 2e72 6573 6f75 7263 6573  , task.resources
-0001ba80: 0a20 2020 2020 2020 2072 6573 6f75 7263  .        resourc
-0001ba90: 6573 203d 206c 6973 7428 7461 736b 2e72  es = list(task.r
-0001baa0: 6573 6f75 7263 6573 295b 305d 0a20 2020  esources)[0].   
-0001bab0: 2069 6620 7265 736f 7572 6365 7320 6973   if resources is
-0001bac0: 206e 6f74 204e 6f6e 6520 616e 6420 7265   not None and re
-0001bad0: 736f 7572 6365 732e 6163 6365 6c65 7261  sources.accelera
-0001bae0: 746f 7273 2069 7320 6e6f 7420 4e6f 6e65  tors is not None
-0001baf0: 3a0a 2020 2020 2020 2020 7265 736f 7572  :.        resour
-0001bb00: 6365 735f 6469 6374 2e75 7064 6174 6528  ces_dict.update(
-0001bb10: 7265 736f 7572 6365 732e 6163 6365 6c65  resources.accele
-0001bb20: 7261 746f 7273 290a 2020 2020 7265 7475  rators).    retu
-0001bb30: 726e 2072 6573 6f75 7263 6573 5f64 6963  rn resources_dic
-0001bb40: 740a 0a0a 6465 6620 6765 745f 7461 736b  t...def get_task
-0001bb50: 5f72 6573 6f75 7263 6573 5f73 7472 2874  _resources_str(t
-0001bb60: 6173 6b3a 2027 7461 736b 5f6c 6962 2e54  ask: 'task_lib.T
-0001bb70: 6173 6b27 2920 2d3e 2073 7472 3a0a 2020  ask') -> str:.  
-0001bb80: 2020 2222 2252 6574 7572 6e73 2074 6865    """Returns the
-0001bb90: 2072 6573 6f75 7263 6573 2073 7472 696e   resources strin
-0001bba0: 6720 6f66 2074 6865 2074 6173 6b2e 0a0a  g of the task...
-0001bbb0: 2020 2020 5468 6520 7265 736f 7572 6365      The resource
-0001bbc0: 7320 7374 7269 6e67 2069 7320 6f6e 6c79  s string is only
-0001bbd0: 2075 7365 6420 6173 2061 2064 6973 706c   used as a displ
-0001bbe0: 6179 2070 7572 706f 7365 2c20 736f 2077  ay purpose, so w
-0001bbf0: 6520 6f6e 6c79 2073 686f 770a 2020 2020  e only show.    
-0001bc00: 7468 6520 6163 6365 6c65 7261 746f 7220  the accelerator 
-0001bc10: 6465 6d61 6e64 7320 2869 6620 616e 7929  demands (if any)
-0001bc20: 2e20 4f74 6865 7277 6973 652c 2074 6865  . Otherwise, the
-0001bc30: 2043 5055 2064 656d 616e 6420 6973 2073   CPU demand is s
-0001bc40: 686f 776e 2e0a 2020 2020 2222 220a 2020  hown..    """.  
-0001bc50: 2020 7461 736b 5f63 7075 5f64 656d 616e    task_cpu_deman
-0001bc60: 6420 3d20 2863 6f6e 7374 616e 7473 2e43  d = (constants.C
-0001bc70: 4f4e 5452 4f4c 4c45 525f 5052 4f43 4553  ONTROLLER_PROCES
-0001bc80: 535f 4350 555f 4445 4d41 4e44 2069 660a  S_CPU_DEMAND if.
-0001bc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bca0: 2020 2020 2020 2074 6173 6b2e 6973 5f63         task.is_c
-0001bcb0: 6f6e 7472 6f6c 6c65 725f 7461 736b 2829  ontroller_task()
-0001bcc0: 2065 6c73 6520 4445 4641 554c 545f 5441   else DEFAULT_TA
-0001bcd0: 534b 5f43 5055 5f44 454d 414e 4429 0a20  SK_CPU_DEMAND). 
-0001bce0: 2020 2069 6620 7461 736b 2e62 6573 745f     if task.best_
-0001bcf0: 7265 736f 7572 6365 7320 6973 206e 6f74  resources is not
-0001bd00: 204e 6f6e 653a 0a20 2020 2020 2020 2061   None:.        a
-0001bd10: 6363 656c 6572 6174 6f72 5f64 6963 7420  ccelerator_dict 
-0001bd20: 3d20 7461 736b 2e62 6573 745f 7265 736f  = task.best_reso
-0001bd30: 7572 6365 732e 6163 6365 6c65 7261 746f  urces.accelerato
-0001bd40: 7273 0a20 2020 2020 2020 2069 6620 6163  rs.        if ac
-0001bd50: 6365 6c65 7261 746f 725f 6469 6374 2069  celerator_dict i
-0001bd60: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0001bd70: 2020 2020 7265 736f 7572 6365 735f 7374      resources_st
-0001bd80: 7220 3d20 6627 4350 553a 7b74 6173 6b5f  r = f'CPU:{task_
-0001bd90: 6370 755f 6465 6d61 6e64 7d27 0a20 2020  cpu_demand}'.   
-0001bda0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0001bdb0: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
-0001bdc0: 5f73 7472 203d 2027 2c20 272e 6a6f 696e  _str = ', '.join
-0001bdd0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001bde0: 2020 6627 7b6b 7d3a 7b76 7d27 2066 6f72    f'{k}:{v}' for
-0001bdf0: 206b 2c20 7620 696e 2061 6363 656c 6572   k, v in acceler
-0001be00: 6174 6f72 5f64 6963 742e 6974 656d 7328  ator_dict.items(
-0001be10: 2929 0a20 2020 2065 6c69 6620 6c65 6e28  )).    elif len(
-0001be20: 7461 736b 2e72 6573 6f75 7263 6573 2920  task.resources) 
-0001be30: 3d3d 2031 3a0a 2020 2020 2020 2020 7265  == 1:.        re
-0001be40: 736f 7572 6365 735f 6469 6374 203d 206c  sources_dict = l
-0001be50: 6973 7428 7461 736b 2e72 6573 6f75 7263  ist(task.resourc
-0001be60: 6573 295b 305d 2e61 6363 656c 6572 6174  es)[0].accelerat
-0001be70: 6f72 730a 2020 2020 2020 2020 6966 2072  ors.        if r
-0001be80: 6573 6f75 7263 6573 5f64 6963 7420 6973  esources_dict is
-0001be90: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0001bea0: 2020 2072 6573 6f75 7263 6573 5f73 7472     resources_str
-0001beb0: 203d 2066 2743 5055 3a7b 7461 736b 5f63   = f'CPU:{task_c
-0001bec0: 7075 5f64 656d 616e 647d 270a 2020 2020  pu_demand}'.    
-0001bed0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001bee0: 2020 2020 2020 7265 736f 7572 6365 735f        resources_
-0001bef0: 7374 7220 3d20 272c 2027 2e6a 6f69 6e28  str = ', '.join(
-0001bf00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001bf10: 2066 277b 6b7d 3a7b 767d 2720 666f 7220   f'{k}:{v}' for 
-0001bf20: 6b2c 2076 2069 6e20 7265 736f 7572 6365  k, v in resource
-0001bf30: 735f 6469 6374 2e69 7465 6d73 2829 290a  s_dict.items()).
-0001bf40: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001bf50: 2020 7265 736f 7572 6365 5f61 6363 656c    resource_accel
-0001bf60: 6572 6174 6f72 7320 3d20 5b5d 0a20 2020  erators = [].   
-0001bf70: 2020 2020 2066 6f72 2072 6573 6f75 7263       for resourc
-0001bf80: 6520 696e 2074 6173 6b2e 7265 736f 7572  e in task.resour
-0001bf90: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
-0001bfa0: 2069 6620 7265 736f 7572 6365 2e61 6363   if resource.acc
-0001bfb0: 656c 6572 6174 6f72 7320 6973 204e 6f6e  elerators is Non
-0001bfc0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001bfd0: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
-0001bfe0: 2020 2020 2020 2020 666f 7220 6b2c 2076          for k, v
-0001bff0: 2069 6e20 7265 736f 7572 6365 2e61 6363   in resource.acc
-0001c000: 656c 6572 6174 6f72 732e 6974 656d 7328  elerators.items(
-0001c010: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0001c020: 2020 2072 6573 6f75 7263 655f 6163 6365     resource_acce
-0001c030: 6c65 7261 746f 7273 2e61 7070 656e 6428  lerators.append(
-0001c040: 6627 7b6b 7d3a 7b76 7d27 290a 0a20 2020  f'{k}:{v}')..   
-0001c050: 2020 2020 2069 6620 7265 736f 7572 6365       if resource
-0001c060: 5f61 6363 656c 6572 6174 6f72 733a 0a20  _accelerators:. 
-0001c070: 2020 2020 2020 2020 2020 2072 6573 6f75             resou
-0001c080: 7263 6573 5f73 7472 203d 2027 2c20 272e  rces_str = ', '.
-0001c090: 6a6f 696e 2873 6574 2872 6573 6f75 7263  join(set(resourc
-0001c0a0: 655f 6163 6365 6c65 7261 746f 7273 2929  e_accelerators))
-0001c0b0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0001c0c0: 2020 2020 2020 2020 2020 2072 6573 6f75             resou
-0001c0d0: 7263 6573 5f73 7472 203d 2066 2743 5055  rces_str = f'CPU
-0001c0e0: 3a7b 7461 736b 5f63 7075 5f64 656d 616e  :{task_cpu_deman
-0001c0f0: 647d 270a 2020 2020 7265 736f 7572 6365  d}'.    resource
-0001c100: 735f 7374 7220 3d20 6627 7b74 6173 6b2e  s_str = f'{task.
-0001c110: 6e75 6d5f 6e6f 6465 737d 7820 5b7b 7265  num_nodes}x [{re
-0001c120: 736f 7572 6365 735f 7374 727d 5d27 0a20  sources_str}]'. 
-0001c130: 2020 2072 6574 7572 6e20 7265 736f 7572     return resour
-0001c140: 6365 735f 7374 720a 0a0a 2320 4861 6e64  ces_str...# Hand
-0001c150: 6c65 2063 7472 6c2d 630a 6465 6620 696e  le ctrl-c.def in
-0001c160: 7465 7272 7570 745f 6861 6e64 6c65 7228  terrupt_handler(
-0001c170: 7369 676e 756d 2c20 6672 616d 6529 3a0a  signum, frame):.
-0001c180: 2020 2020 6465 6c20 7369 676e 756d 2c20      del signum, 
-0001c190: 6672 616d 650a 2020 2020 7375 6270 726f  frame.    subpro
-0001c1a0: 6365 7373 5f75 7469 6c73 2e6b 696c 6c5f  cess_utils.kill_
-0001c1b0: 6368 696c 6472 656e 5f70 726f 6365 7373  children_process
-0001c1c0: 6573 2829 0a20 2020 2023 2041 766f 6964  es().    # Avoid
-0001c1d0: 2075 7369 6e67 206c 6f67 6765 7220 6865   using logger he
-0001c1e0: 7265 2c20 6173 2069 7420 7769 6c6c 2070  re, as it will p
-0001c1f0: 7269 6e74 2074 6865 2073 7461 636b 2074  rint the stack t
-0001c200: 7261 6365 2066 6f72 2062 726f 6b65 6e0a  race for broken.
-0001c210: 2020 2020 2320 7069 7065 2c20 7768 656e      # pipe, when
-0001c220: 2074 6865 206f 7574 7075 7420 6973 2070   the output is p
-0001c230: 6970 6564 2074 6f20 616e 6f74 6865 7220  iped to another 
-0001c240: 7072 6f67 7261 6d2e 0a20 2020 2070 7269  program..    pri
-0001c250: 6e74 2866 277b 636f 6c6f 7261 6d61 2e53  nt(f'{colorama.S
-0001c260: 7479 6c65 2e44 494d 7d54 6970 3a20 5468  tyle.DIM}Tip: Th
-0001c270: 6520 6a6f 6220 7769 6c6c 206b 6565 7020  e job will keep 
-0001c280: 270a 2020 2020 2020 2020 2020 6627 7275  '.          f'ru
-0001c290: 6e6e 696e 6720 6166 7465 7220 4374 726c  nning after Ctrl
-0001c2a0: 2d43 2e7b 636f 6c6f 7261 6d61 2e53 7479  -C.{colorama.Sty
-0001c2b0: 6c65 2e52 4553 4554 5f41 4c4c 7d27 290a  le.RESET_ALL}').
-0001c2c0: 2020 2020 7769 7468 2075 785f 7574 696c      with ux_util
-0001c2d0: 732e 7072 696e 745f 6578 6365 7074 696f  s.print_exceptio
-0001c2e0: 6e5f 6e6f 5f74 7261 6365 6261 636b 2829  n_no_traceback()
-0001c2f0: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-0001c300: 4b65 7962 6f61 7264 496e 7465 7272 7570  KeyboardInterrup
-0001c310: 7428 6578 6365 7074 696f 6e73 2e4b 4559  t(exceptions.KEY
-0001c320: 424f 4152 445f 494e 5445 5252 5550 545f  BOARD_INTERRUPT_
-0001c330: 434f 4445 290a 0a0a 2320 4861 6e64 6c65  CODE)...# Handle
-0001c340: 2063 7472 6c2d 7a0a 6465 6620 7374 6f70   ctrl-z.def stop
-0001c350: 5f68 616e 646c 6572 2873 6967 6e75 6d2c  _handler(signum,
-0001c360: 2066 7261 6d65 293a 0a20 2020 2064 656c   frame):.    del
-0001c370: 2073 6967 6e75 6d2c 2066 7261 6d65 0a20   signum, frame. 
-0001c380: 2020 2073 7562 7072 6f63 6573 735f 7574     subprocess_ut
-0001c390: 696c 732e 6b69 6c6c 5f63 6869 6c64 7265  ils.kill_childre
-0001c3a0: 6e5f 7072 6f63 6573 7365 7328 290a 2020  n_processes().  
-0001c3b0: 2020 2320 4176 6f69 6420 7573 696e 6720    # Avoid using 
-0001c3c0: 6c6f 6767 6572 2068 6572 652c 2061 7320  logger here, as 
-0001c3d0: 6974 2077 696c 6c20 7072 696e 7420 7468  it will print th
-0001c3e0: 6520 7374 6163 6b20 7472 6163 6520 666f  e stack trace fo
-0001c3f0: 7220 6272 6f6b 656e 0a20 2020 2023 2070  r broken.    # p
-0001c400: 6970 652c 2077 6865 6e20 7468 6520 6f75  ipe, when the ou
-0001c410: 7470 7574 2069 7320 7069 7065 6420 746f  tput is piped to
-0001c420: 2061 6e6f 7468 6572 2070 726f 6772 616d   another program
-0001c430: 2e0a 2020 2020 7072 696e 7428 6627 7b63  ..    print(f'{c
-0001c440: 6f6c 6f72 616d 612e 5374 796c 652e 4449  olorama.Style.DI
-0001c450: 4d7d 5469 703a 2054 6865 206a 6f62 2077  M}Tip: The job w
-0001c460: 696c 6c20 6b65 6570 2027 0a20 2020 2020  ill keep '.     
-0001c470: 2020 2020 2066 2772 756e 6e69 6e67 2061       f'running a
-0001c480: 6674 6572 2043 7472 6c2d 5a2e 7b63 6f6c  fter Ctrl-Z.{col
-0001c490: 6f72 616d 612e 5374 796c 652e 5245 5345  orama.Style.RESE
-0001c4a0: 545f 414c 4c7d 2729 0a20 2020 2077 6974  T_ALL}').    wit
-0001c4b0: 6820 7578 5f75 7469 6c73 2e70 7269 6e74  h ux_utils.print
-0001c4c0: 5f65 7863 6570 7469 6f6e 5f6e 6f5f 7472  _exception_no_tr
-0001c4d0: 6163 6562 6163 6b28 293a 0a20 2020 2020  aceback():.     
-0001c4e0: 2020 2072 6169 7365 204b 6579 626f 6172     raise Keyboar
-0001c4f0: 6449 6e74 6572 7275 7074 2865 7863 6570  dInterrupt(excep
-0001c500: 7469 6f6e 732e 5349 4754 5354 505f 434f  tions.SIGTSTP_CO
-0001c510: 4445 290a 0a0a 6465 6620 7275 6e5f 636f  DE)...def run_co
-0001c520: 6d6d 616e 645f 616e 645f 6861 6e64 6c65  mmand_and_handle
-0001c530: 5f73 7368 5f66 6169 6c75 7265 2872 756e  _ssh_failure(run
-0001c540: 6e65 723a 2063 6f6d 6d61 6e64 5f72 756e  ner: command_run
-0001c550: 6e65 722e 5353 4843 6f6d 6d61 6e64 5275  ner.SSHCommandRu
-0001c560: 6e6e 6572 2c0a 2020 2020 2020 2020 2020  nner,.          
-0001c570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c580: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
-0001c590: 6d61 6e64 3a20 7374 722c 0a20 2020 2020  mand: str,.     
-0001c5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c5c0: 2020 6661 696c 7572 655f 6d65 7373 6167    failure_messag
-0001c5d0: 653a 2073 7472 2920 2d3e 2073 7472 3a0a  e: str) -> str:.
-0001c5e0: 2020 2020 2222 2252 756e 7320 636f 6d6d      """Runs comm
-0001c5f0: 616e 6420 7265 6d6f 7465 6c79 2061 6e64  and remotely and
-0001c600: 2072 6574 7572 6e73 206f 7574 7075 7420   returns output 
-0001c610: 7769 7468 2070 726f 7065 7220 6572 726f  with proper erro
-0001c620: 7220 6861 6e64 6c69 6e67 2e22 2222 0a20  r handling.""". 
-0001c630: 2020 2072 632c 2073 7464 6f75 742c 2073     rc, stdout, s
-0001c640: 7464 6572 7220 3d20 7275 6e6e 6572 2e72  tderr = runner.r
-0001c650: 756e 2863 6f6d 6d61 6e64 2c0a 2020 2020  un(command,.    
-0001c660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c680: 7265 7175 6972 655f 6f75 7470 7574 733d  require_outputs=
-0001c690: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
-0001c6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c6b0: 2020 2020 2020 2020 2020 7374 7265 616d            stream
-0001c6c0: 5f6c 6f67 733d 4661 6c73 6529 0a20 2020  _logs=False).   
-0001c6d0: 2069 6620 7263 203d 3d20 3235 353a 0a20   if rc == 255:. 
-0001c6e0: 2020 2020 2020 2023 2053 5348 2066 6169         # SSH fai
-0001c6f0: 6c65 640a 2020 2020 2020 2020 7261 6973  led.        rais
-0001c700: 6520 5275 6e74 696d 6545 7272 6f72 280a  e RuntimeError(.
-0001c710: 2020 2020 2020 2020 2020 2020 6627 5353              f'SS
-0001c720: 4820 7769 7468 2075 7365 7220 7b72 756e  H with user {run
-0001c730: 6e65 722e 7373 685f 7573 6572 7d20 616e  ner.ssh_user} an
-0001c740: 6420 6b65 7920 7b72 756e 6e65 722e 7373  d key {runner.ss
-0001c750: 685f 7072 6976 6174 655f 6b65 797d 2027  h_private_key} '
-0001c760: 0a20 2020 2020 2020 2020 2020 2066 2774  .            f't
-0001c770: 6f20 7b72 756e 6e65 722e 6970 7d20 6661  o {runner.ip} fa
-0001c780: 696c 6564 2e20 5468 6973 2069 7320 6d6f  iled. This is mo
-0001c790: 7374 206c 696b 656c 7920 6475 6520 746f  st likely due to
-0001c7a0: 2069 6e63 6f72 7265 6374 2027 0a20 2020   incorrect '.   
-0001c7b0: 2020 2020 2020 2020 2027 6372 6564 656e           'creden
-0001c7c0: 7469 616c 7320 6f72 2069 6e63 6f72 7265  tials or incorre
-0001c7d0: 6374 2070 6572 6d69 7373 696f 6e73 2066  ct permissions f
-0001c7e0: 6f72 2074 6865 206b 6579 2066 696c 652e  or the key file.
-0001c7f0: 2043 6865 636b 2027 0a20 2020 2020 2020   Check '.       
-0001c800: 2020 2020 2027 796f 7572 2063 7265 6465       'your crede
-0001c810: 6e74 6961 6c73 2061 6e64 2074 7279 2061  ntials and try a
-0001c820: 6761 696e 2e27 290a 2020 2020 7375 6270  gain.').    subp
-0001c830: 726f 6365 7373 5f75 7469 6c73 2e68 616e  rocess_utils.han
-0001c840: 646c 655f 7265 7475 726e 636f 6465 2872  dle_returncode(r
-0001c850: 632c 0a20 2020 2020 2020 2020 2020 2020  c,.             
-0001c860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c870: 2020 2020 2020 2020 2020 636f 6d6d 616e            comman
-0001c880: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-0001c890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c8a0: 2020 2020 2020 2020 2020 6661 696c 7572            failur
-0001c8b0: 655f 6d65 7373 6167 652c 0a20 2020 2020  e_message,.     
-0001c8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c8e0: 2020 7374 6465 7272 3d73 7464 6572 7229    stderr=stderr)
-0001c8f0: 0a20 2020 2072 6574 7572 6e20 7374 646f  .    return stdo
-0001c900: 7574 0a0a 0a64 6566 2063 6865 636b 5f72  ut...def check_r
-0001c910: 7379 6e63 5f69 6e73 7461 6c6c 6564 2829  sync_installed()
-0001c920: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2222   -> None:.    ""
-0001c930: 2243 6865 636b 7320 6966 2072 7379 6e63  "Checks if rsync
-0001c940: 2069 7320 696e 7374 616c 6c65 642e 0a0a   is installed...
-0001c950: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
-0001c960: 2020 2020 5275 6e74 696d 6545 7272 6f72      RuntimeError
-0001c970: 3a20 6966 2072 7379 6e63 2069 7320 6e6f  : if rsync is no
-0001c980: 7420 696e 7374 616c 6c65 6420 696e 2074  t installed in t
-0001c990: 6865 206d 6163 6869 6e65 2e0a 2020 2020  he machine..    
-0001c9a0: 2222 220a 2020 2020 7472 793a 0a20 2020  """.    try:.   
-0001c9b0: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
-0001c9c0: 7275 6e28 2772 7379 6e63 202d 2d76 6572  run('rsync --ver
-0001c9d0: 7369 6f6e 272c 0a20 2020 2020 2020 2020  sion',.         
-0001c9e0: 2020 2020 2020 2020 2020 2020 2020 7368                sh
-0001c9f0: 656c 6c3d 5472 7565 2c0a 2020 2020 2020  ell=True,.      
-0001ca00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca10: 2063 6865 636b 3d54 7275 652c 0a20 2020   check=True,.   
-0001ca20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca30: 2020 2020 7374 646f 7574 3d73 7562 7072      stdout=subpr
-0001ca40: 6f63 6573 732e 5049 5045 2c0a 2020 2020  ocess.PIPE,.    
-0001ca50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca60: 2020 2073 7464 6572 723d 7375 6270 726f     stderr=subpro
-0001ca70: 6365 7373 2e50 4950 4529 0a20 2020 2065  cess.PIPE).    e
-0001ca80: 7863 6570 7420 7375 6270 726f 6365 7373  xcept subprocess
-0001ca90: 2e43 616c 6c65 6450 726f 6365 7373 4572  .CalledProcessEr
-0001caa0: 726f 723a 0a20 2020 2020 2020 2077 6974  ror:.        wit
-0001cab0: 6820 7578 5f75 7469 6c73 2e70 7269 6e74  h ux_utils.print
-0001cac0: 5f65 7863 6570 7469 6f6e 5f6e 6f5f 7472  _exception_no_tr
-0001cad0: 6163 6562 6163 6b28 293a 0a20 2020 2020  aceback():.     
-0001cae0: 2020 2020 2020 2072 6169 7365 2052 756e         raise Run
-0001caf0: 7469 6d65 4572 726f 7228 0a20 2020 2020  timeError(.     
-0001cb00: 2020 2020 2020 2020 2020 2027 6072 7379             '`rsy
-0001cb10: 6e63 6020 6973 2072 6571 7569 7265 6420  nc` is required 
-0001cb20: 666f 7220 7072 6f76 6973 696f 6e69 6e67  for provisioning
-0001cb30: 2061 6e64 270a 2020 2020 2020 2020 2020   and'.          
-0001cb40: 2020 2020 2020 2720 6974 2069 7320 6e6f        ' it is no
-0001cb50: 7420 696e 7374 616c 6c65 642e 2046 6f72  t installed. For
-0001cb60: 2044 6562 6961 6e2f 5562 756e 7475 2073   Debian/Ubuntu s
-0001cb70: 7973 7465 6d2c 2027 0a20 2020 2020 2020  ystem, '.       
-0001cb80: 2020 2020 2020 2020 2027 696e 7374 616c           'instal
-0001cb90: 6c20 6974 2077 6974 683a 5c6e 270a 2020  l it with:\n'.  
-0001cba0: 2020 2020 2020 2020 2020 2020 2020 2720                ' 
-0001cbb0: 2024 2073 7564 6f20 6170 7420 696e 7374   $ sudo apt inst
-0001cbc0: 616c 6c20 7273 796e 6327 2920 6672 6f6d  all rsync') from
-0001cbd0: 204e 6f6e 650a 0a0a 6465 6620 6368 6563   None...def chec
-0001cbe0: 6b5f 7374 616c 655f 7275 6e74 696d 655f  k_stale_runtime_
-0001cbf0: 6f6e 5f72 656d 6f74 6528 7265 7475 726e  on_remote(return
-0001cc00: 636f 6465 3a20 696e 742c 2073 7464 6572  code: int, stder
-0001cc10: 723a 2073 7472 2c0a 2020 2020 2020 2020  r: str,.        
-0001cc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc30: 2020 2020 2020 2020 2020 636c 7573 7465            cluste
-0001cc40: 725f 6e61 6d65 3a20 7374 7229 202d 3e20  r_name: str) -> 
-0001cc50: 4e6f 6e65 3a0a 2020 2020 2222 2252 6169  None:.    """Rai
-0001cc60: 7365 7320 5275 6e74 696d 6545 7272 6f72  ses RuntimeError
-0001cc70: 2069 6620 7265 6d6f 7465 2053 6b79 5069   if remote SkyPi
-0001cc80: 6c6f 7420 7275 6e74 696d 6520 6e65 6564  lot runtime need
-0001cc90: 7320 746f 2062 6520 7570 6461 7465 642e  s to be updated.
-0001cca0: 0a0a 2020 2020 5765 2064 6574 6563 7420  ..    We detect 
-0001ccb0: 7468 6973 2062 7920 7061 7273 696e 6720  this by parsing 
-0001ccc0: 6365 7274 6169 6e20 6261 636b 7761 7264  certain backward
-0001ccd0: 2d69 6e63 6f6d 7061 7469 626c 6520 6572  -incompatible er
-0001cce0: 726f 7220 6d65 7373 6167 6573 2066 726f  ror messages fro
-0001ccf0: 6d0a 2020 2020 6073 7464 6572 7260 2e20  m.    `stderr`. 
-0001cd00: 5479 7069 6361 6c6c 7920 6475 6520 746f  Typically due to
-0001cd10: 2074 6865 206c 6f63 616c 2063 6c69 656e   the local clien
-0001cd20: 7420 7665 7273 696f 6e20 6a75 7374 2067  t version just g
-0001cd30: 6f74 2075 7064 6174 6564 2c20 616e 640a  ot updated, and.
-0001cd40: 2020 2020 7468 6520 7265 6d6f 7465 2072      the remote r
-0001cd50: 756e 7469 6d65 2069 7320 616e 206f 6c64  untime is an old
-0001cd60: 6572 2076 6572 7369 6f6e 2e0a 2020 2020  er version..    
-0001cd70: 2222 220a 2020 2020 7061 7474 6572 6e20  """.    pattern 
-0001cd80: 3d20 7265 2e63 6f6d 7069 6c65 2872 2741  = re.compile(r'A
-0001cd90: 7474 7269 6275 7465 4572 726f 723a 206d  ttributeError: m
-0001cda0: 6f64 756c 6520 5c27 736b 795c 2e28 2e2a  odule \'sky\.(.*
-0001cdb0: 295c 2720 6861 7320 6e6f 2027 0a20 2020  )\' has no '.   
-0001cdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cdd0: 2020 2020 2020 7227 6174 7472 6962 7574        r'attribut
-0001cde0: 6520 5c27 282e 2a29 5c27 2729 0a20 2020  e \'(.*)\'').   
-0001cdf0: 2069 6620 7265 7475 726e 636f 6465 2021   if returncode !
-0001ce00: 3d20 303a 0a20 2020 2020 2020 2061 7474  = 0:.        att
-0001ce10: 7269 6275 7465 5f65 7272 6f72 203d 2072  ribute_error = r
-0001ce20: 652e 6669 6e64 616c 6c28 7061 7474 6572  e.findall(patter
-0001ce30: 6e2c 2073 7464 6572 7229 0a20 2020 2020  n, stderr).     
-0001ce40: 2020 2069 6620 6174 7472 6962 7574 655f     if attribute_
-0001ce50: 6572 726f 723a 0a20 2020 2020 2020 2020  error:.         
-0001ce60: 2020 2077 6974 6820 7578 5f75 7469 6c73     with ux_utils
-0001ce70: 2e70 7269 6e74 5f65 7863 6570 7469 6f6e  .print_exception
-0001ce80: 5f6e 6f5f 7472 6163 6562 6163 6b28 293a  _no_traceback():
-0001ce90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001cea0: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
-0001ceb0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-0001cec0: 2020 2020 2020 2020 2066 277b 636f 6c6f           f'{colo
-0001ced0: 7261 6d61 2e46 6f72 652e 5245 447d 536b  rama.Fore.RED}Sk
-0001cee0: 7950 696c 6f74 2072 756e 7469 6d65 206e  yPilot runtime n
-0001cef0: 6565 6473 2074 6f20 6265 2075 7064 6174  eeds to be updat
-0001cf00: 6564 2027 0a20 2020 2020 2020 2020 2020  ed '.           
-0001cf10: 2020 2020 2020 2020 2027 6f6e 2074 6865           'on the
-0001cf20: 2072 656d 6f74 6520 636c 7573 7465 722e   remote cluster.
-0001cf30: 2054 6f20 7570 6461 7465 2c20 7275 6e20   To update, run 
-0001cf40: 2865 7869 7374 696e 6720 6a6f 6273 2061  (existing jobs a
-0001cf50: 7265 2027 0a20 2020 2020 2020 2020 2020  re '.           
-0001cf60: 2020 2020 2020 2020 2066 276e 6f74 2069           f'not i
-0001cf70: 6e74 6572 7275 7074 6564 293a 207b 636f  nterrupted): {co
-0001cf80: 6c6f 7261 6d61 2e53 7479 6c65 2e42 5249  lorama.Style.BRI
-0001cf90: 4748 547d 736b 7920 7374 6172 7420 2d66  GHT}sky start -f
-0001cfa0: 202d 7920 270a 2020 2020 2020 2020 2020   -y '.          
-0001cfb0: 2020 2020 2020 2020 2020 6627 7b63 6c75            f'{clu
-0001cfc0: 7374 6572 5f6e 616d 657d 7b63 6f6c 6f72  ster_name}{color
-0001cfd0: 616d 612e 5374 796c 652e 5245 5345 545f  ama.Style.RESET_
-0001cfe0: 414c 4c7d 270a 2020 2020 2020 2020 2020  ALL}'.          
-0001cff0: 2020 2020 2020 2020 2020 6627 5c6e 2d2d            f'\n--
-0001d000: 2d20 4465 7461 696c 7320 2d2d 2d5c 6e7b  - Details ---\n{
-0001d010: 7374 6465 7272 2e73 7472 6970 2829 7d5c  stderr.strip()}\
-0001d020: 6e27 290a                                n').
+00010370: 2020 2066 2761 206e 6577 2069 6465 6e74     f'a new ident
+00010380: 6974 7920 7b63 7572 7265 6e74 5f75 7365  ity {current_use
+00010390: 725f 6964 656e 7469 7479 7d20 6973 2061  r_identity} is a
+000103a0: 6374 6976 6174 6564 2e20 5765 2073 7469  ctivated. We sti
+000103b0: 6c6c 2027 0a20 2020 2020 2020 2020 2020  ll '.           
+000103c0: 2020 2020 2020 2020 2020 2020 2027 616c               'al
+000103d0: 6c6f 7720 7468 6520 6f70 6572 6174 696f  low the operatio
+000103e0: 6e20 6173 2074 6865 2074 776f 2069 6465  n as the two ide
+000103f0: 6e74 6974 6965 7320 6172 6520 6c69 6b65  ntities are like
+00010400: 6c79 2074 6f20 6861 7665 2027 0a20 2020  ly to have '.   
+00010410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010420: 2020 2020 2027 7468 6520 7361 6d65 2061       'the same a
+00010430: 6363 6573 7320 746f 2074 6865 2063 6c75  ccess to the clu
+00010440: 7374 6572 2e20 506c 6561 7365 2062 6520  ster. Please be 
+00010450: 6177 6172 6520 7468 6174 2074 6869 7320  aware that this 
+00010460: 6361 6e20 270a 2020 2020 2020 2020 2020  can '.          
+00010470: 2020 2020 2020 2020 2020 2020 2020 2763                'c
+00010480: 6175 7365 2075 6e65 7870 6563 7465 6420  ause unexpected 
+00010490: 636c 7573 7465 7220 6c65 616b 6167 6520  cluster leakage 
+000104a0: 6966 2074 6865 2074 776f 2069 6465 6e74  if the two ident
+000104b0: 6974 6965 7320 6172 6520 6e6f 7420 270a  ities are not '.
+000104c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000104d0: 2020 2020 2020 2020 2761 6374 7561 6c6c          'actuall
+000104e0: 7920 6571 7569 7661 6c65 6e74 2028 652e  y equivalent (e.
+000104f0: 672e 2c20 6265 6c6f 6e67 2074 6f20 7468  g., belong to th
+00010500: 6520 7361 6d65 2070 6572 736f 6e29 2e27  e same person).'
+00010510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010520: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00010530: 2020 2020 2020 2069 6620 6920 213d 2030         if i != 0
+00010540: 206f 7220 6c65 6e28 6f77 6e65 725f 6964   or len(owner_id
+00010550: 656e 7469 7479 2920 213d 206c 656e 2863  entity) != len(c
+00010560: 7572 7265 6e74 5f75 7365 725f 6964 656e  urrent_user_iden
+00010570: 7469 7479 293a 0a20 2020 2020 2020 2020  tity):.         
+00010580: 2020 2020 2020 2020 2020 2023 2057 6520             # We 
+00010590: 7570 6461 7465 2074 6865 206f 776e 6572  update the owner
+000105a0: 206f 6620 6120 636c 7573 7465 722c 2077   of a cluster, w
+000105b0: 6865 6e3a 0a20 2020 2020 2020 2020 2020  hen:.           
+000105c0: 2020 2020 2020 2020 2023 2031 2e20 5468           # 1. Th
+000105d0: 6520 7374 7269 6374 6573 7420 6964 656e  e strictest iden
+000105e0: 7474 7920 2869 2e65 2e20 7468 6520 6669  tty (i.e. the fi
+000105f0: 7273 7420 6f6e 6529 2064 6f65 7320 6e6f  rst one) does no
+00010600: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+00010610: 2020 2020 2020 2320 6d61 7463 682c 2062        # match, b
+00010620: 7574 2074 6865 206c 6174 7465 7220 6f6e  ut the latter on
+00010630: 6573 206d 6174 6368 2e0a 2020 2020 2020  es match..      
+00010640: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00010650: 322e 2054 6865 206c 656e 6774 6820 6f66  2. The length of
+00010660: 2074 6865 2074 776f 2069 6465 6e74 6974   the two identit
+00010670: 6965 7320 6172 6520 6469 6666 6572 656e  ies are differen
+00010680: 742c 2077 6869 6368 0a20 2020 2020 2020  t, which.       
+00010690: 2020 2020 2020 2020 2020 2020 2023 2077               # w
+000106a0: 696c 6c20 6f6e 6c79 2068 6170 7065 6e20  ill only happen 
+000106b0: 7768 656e 2074 6865 2063 6c75 7374 6572  when the cluster
+000106c0: 2069 7320 6c61 756e 6368 6564 2062 6566   is launched bef
+000106d0: 6f72 6520 2331 3830 382e 0a20 2020 2020  ore #1808..     
+000106e0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000106f0: 2055 7064 6174 6520 7468 6520 7573 6572   Update the user
+00010700: 2069 6465 6e74 6974 7920 746f 2061 766f   identity to avo
+00010710: 6964 2073 686f 7769 6e67 2074 6865 2077  id showing the w
+00010720: 6172 6e69 6e67 2061 626f 7665 0a20 2020  arning above.   
+00010730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010740: 2023 2061 6761 696e 2e0a 2020 2020 2020   # again..      
+00010750: 2020 2020 2020 2020 2020 2020 2020 676c                gl
+00010760: 6f62 616c 5f75 7365 725f 7374 6174 652e  obal_user_state.
+00010770: 7365 745f 6f77 6e65 725f 6964 656e 7469  set_owner_identi
+00010780: 7479 5f66 6f72 5f63 6c75 7374 6572 280a  ty_for_cluster(.
+00010790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000107a0: 2020 2020 2020 2020 636c 7573 7465 725f          cluster_
+000107b0: 6e61 6d65 2c20 6375 7272 656e 745f 7573  name, current_us
+000107c0: 6572 5f69 6465 6e74 6974 7929 0a20 2020  er_identity).   
+000107d0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+000107e0: 7572 6e20 2023 2054 6865 2075 7365 7220  urn  # The user 
+000107f0: 6964 656e 7469 7479 206d 6174 6368 6573  identity matches
+00010800: 2e0a 2020 2020 2020 2020 7769 7468 2075  ..        with u
+00010810: 785f 7574 696c 732e 7072 696e 745f 6578  x_utils.print_ex
+00010820: 6365 7074 696f 6e5f 6e6f 5f74 7261 6365  ception_no_trace
+00010830: 6261 636b 2829 3a0a 2020 2020 2020 2020  back():.        
+00010840: 2020 2020 7261 6973 6520 6578 6365 7074      raise except
+00010850: 696f 6e73 2e43 6c75 7374 6572 4f77 6e65  ions.ClusterOwne
+00010860: 7249 6465 6e74 6974 794d 6973 6d61 7463  rIdentityMismatc
+00010870: 6845 7272 6f72 280a 2020 2020 2020 2020  hError(.        
+00010880: 2020 2020 2020 2020 6627 7b63 6c75 7374          f'{clust
+00010890: 6572 5f6e 616d 6521 727d 2028 7b63 6c6f  er_name!r} ({clo
+000108a0: 7564 7d29 2069 7320 6f77 6e65 6420 6279  ud}) is owned by
+000108b0: 2061 6363 6f75 6e74 2027 0a20 2020 2020   account '.     
+000108c0: 2020 2020 2020 2020 2020 2066 277b 6f77             f'{ow
+000108d0: 6e65 725f 6964 656e 7469 7479 2172 7d2c  ner_identity!r},
+000108e0: 2062 7574 2074 6865 2061 6374 6976 6174   but the activat
+000108f0: 6564 2061 6363 6f75 6e74 2027 0a20 2020  ed account '.   
+00010900: 2020 2020 2020 2020 2020 2020 2066 2769               f'i
+00010910: 7320 7b63 7572 7265 6e74 5f75 7365 725f  s {current_user_
+00010920: 6964 656e 7469 7479 2172 7d2e 2729 0a0a  identity!r}.')..
+00010930: 0a64 6566 2074 6167 5f66 696c 7465 725f  .def tag_filter_
+00010940: 666f 725f 636c 7573 7465 7228 636c 7573  for_cluster(clus
+00010950: 7465 725f 6e61 6d65 3a20 7374 7229 202d  ter_name: str) -
+00010960: 3e20 4469 6374 5b73 7472 2c20 7374 725d  > Dict[str, str]
+00010970: 3a0a 2020 2020 2222 2252 6574 7572 6e73  :.    """Returns
+00010980: 2061 2074 6167 2066 696c 7465 7220 666f   a tag filter fo
+00010990: 7220 7468 6520 636c 7573 7465 722e 2222  r the cluster.""
+000109a0: 220a 2020 2020 7265 7475 726e 207b 0a20  ".    return {. 
+000109b0: 2020 2020 2020 2027 7261 792d 636c 7573         'ray-clus
+000109c0: 7465 722d 6e61 6d65 273a 2063 6c75 7374  ter-name': clust
+000109d0: 6572 5f6e 616d 652c 0a20 2020 207d 0a0a  er_name,.    }..
+000109e0: 0a64 6566 205f 7175 6572 795f 636c 7573  .def _query_clus
+000109f0: 7465 725f 7374 6174 7573 5f76 6961 5f63  ter_status_via_c
+00010a00: 6c6f 7564 5f61 7069 280a 2020 2020 6861  loud_api(.    ha
+00010a10: 6e64 6c65 3a20 2763 6c6f 7564 5f76 6d5f  ndle: 'cloud_vm_
+00010a20: 7261 795f 6261 636b 656e 642e 436c 6f75  ray_backend.Clou
+00010a30: 6456 6d52 6179 5265 736f 7572 6365 4861  dVmRayResourceHa
+00010a40: 6e64 6c65 270a 2920 2d3e 204c 6973 745b  ndle'.) -> List[
+00010a50: 7374 6174 7573 5f6c 6962 2e43 6c75 7374  status_lib.Clust
+00010a60: 6572 5374 6174 7573 5d3a 0a20 2020 2022  erStatus]:.    "
+00010a70: 2222 5265 7475 726e 7320 7468 6520 7374  ""Returns the st
+00010a80: 6174 7573 206f 6620 7468 6520 636c 7573  atus of the clus
+00010a90: 7465 722e 0a0a 2020 2020 5261 6973 6573  ter...    Raises
+00010aa0: 3a0a 2020 2020 2020 2020 6578 6365 7074  :.        except
+00010ab0: 696f 6e73 2e43 6c75 7374 6572 5374 6174  ions.ClusterStat
+00010ac0: 7573 4665 7463 6869 6e67 4572 726f 723a  usFetchingError:
+00010ad0: 2074 6865 2063 6c75 7374 6572 2073 7461   the cluster sta
+00010ae0: 7475 7320 6361 6e6e 6f74 2062 650a 2020  tus cannot be.  
+00010af0: 2020 2020 2020 2020 6665 7463 6865 6420          fetched 
+00010b00: 6672 6f6d 2074 6865 2063 6c6f 7564 2070  from the cloud p
+00010b10: 726f 7669 6465 722e 0a20 2020 2022 2222  rovider..    """
+00010b20: 0a20 2020 2063 6c75 7374 6572 5f6e 616d  .    cluster_nam
+00010b30: 655f 6f6e 5f63 6c6f 7564 203d 2068 616e  e_on_cloud = han
+00010b40: 646c 652e 636c 7573 7465 725f 6e61 6d65  dle.cluster_name
+00010b50: 5f6f 6e5f 636c 6f75 640a 2020 2020 636c  _on_cloud.    cl
+00010b60: 7573 7465 725f 6e61 6d65 5f69 6e5f 6869  uster_name_in_hi
+00010b70: 6e74 203d 2063 6f6d 6d6f 6e5f 7574 696c  nt = common_util
+00010b80: 732e 636c 7573 7465 725f 6e61 6d65 5f69  s.cluster_name_i
+00010b90: 6e5f 6869 6e74 280a 2020 2020 2020 2020  n_hint(.        
+00010ba0: 6861 6e64 6c65 2e63 6c75 7374 6572 5f6e  handle.cluster_n
+00010bb0: 616d 652c 2063 6c75 7374 6572 5f6e 616d  ame, cluster_nam
+00010bc0: 655f 6f6e 5f63 6c6f 7564 290a 2020 2020  e_on_cloud).    
+00010bd0: 2320 5573 6520 7265 6769 6f6e 2061 6e64  # Use region and
+00010be0: 207a 6f6e 6520 6672 6f6d 2074 6865 2063   zone from the c
+00010bf0: 6c75 7374 6572 2063 6f6e 6669 672c 2069  luster config, i
+00010c00: 6e73 7465 6164 206f 6620 7468 650a 2020  nstead of the.  
+00010c10: 2020 2320 6861 6e64 6c65 2e6c 6175 6e63    # handle.launc
+00010c20: 6865 645f 7265 736f 7572 6365 732c 2062  hed_resources, b
+00010c30: 6563 6175 7365 2074 6865 206c 6174 7465  ecause the latte
+00010c40: 7220 6d61 7920 6e6f 7420 6265 2073 6574  r may not be set
+00010c50: 0a20 2020 2023 2063 6f72 7265 6374 6c79  .    # correctly
+00010c60: 2079 6574 2e0a 2020 2020 7261 795f 636f   yet..    ray_co
+00010c70: 6e66 6967 203d 2063 6f6d 6d6f 6e5f 7574  nfig = common_ut
+00010c80: 696c 732e 7265 6164 5f79 616d 6c28 6861  ils.read_yaml(ha
+00010c90: 6e64 6c65 2e63 6c75 7374 6572 5f79 616d  ndle.cluster_yam
+00010ca0: 6c29 0a20 2020 2070 726f 7669 6465 725f  l).    provider_
+00010cb0: 636f 6e66 6967 203d 2072 6179 5f63 6f6e  config = ray_con
+00010cc0: 6669 675b 2770 726f 7669 6465 7227 5d0a  fig['provider'].
+00010cd0: 0a20 2020 2023 2051 7565 7279 2074 6865  .    # Query the
+00010ce0: 2063 6c6f 7564 2070 726f 7669 6465 722e   cloud provider.
+00010cf0: 0a20 2020 2023 2054 4f44 4f28 7375 7175  .    # TODO(suqu
+00010d00: 6172 6b29 3a20 6d6f 7665 2069 6d70 6c65  ark): move imple
+00010d10: 6d65 6e74 6174 696f 6e73 206f 6620 6d6f  mentations of mo
+00010d20: 7265 2063 6c6f 7564 7320 6865 7265 0a20  re clouds here. 
+00010d30: 2020 2063 6c6f 7564 203d 2068 616e 646c     cloud = handl
+00010d40: 652e 6c61 756e 6368 6564 5f72 6573 6f75  e.launched_resou
+00010d50: 7263 6573 2e63 6c6f 7564 0a20 2020 2061  rces.cloud.    a
+00010d60: 7373 6572 7420 636c 6f75 6420 6973 206e  ssert cloud is n
+00010d70: 6f74 204e 6f6e 652c 2068 616e 646c 650a  ot None, handle.
+00010d80: 2020 2020 6966 2063 6c6f 7564 2e53 5441      if cloud.STA
+00010d90: 5455 535f 5645 5253 494f 4e20 3e3d 2063  TUS_VERSION >= c
+00010da0: 6c6f 7564 732e 5374 6174 7573 5665 7273  louds.StatusVers
+00010db0: 696f 6e2e 534b 5950 494c 4f54 3a0a 2020  ion.SKYPILOT:.  
+00010dc0: 2020 2020 2020 636c 6f75 645f 6e61 6d65        cloud_name
+00010dd0: 203d 2072 6570 7228 6861 6e64 6c65 2e6c   = repr(handle.l
+00010de0: 6175 6e63 6865 645f 7265 736f 7572 6365  aunched_resource
+00010df0: 732e 636c 6f75 6429 0a20 2020 2020 2020  s.cloud).       
+00010e00: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00010e10: 2020 6e6f 6465 5f73 7461 7475 735f 6469    node_status_di
+00010e20: 6374 203d 2070 726f 7669 7369 6f6e 5f6c  ct = provision_l
+00010e30: 6962 2e71 7565 7279 5f69 6e73 7461 6e63  ib.query_instanc
+00010e40: 6573 280a 2020 2020 2020 2020 2020 2020  es(.            
+00010e50: 2020 2020 636c 6f75 645f 6e61 6d65 2c20      cloud_name, 
+00010e60: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
+00010e70: 636c 6f75 642c 2070 726f 7669 6465 725f  cloud, provider_
+00010e80: 636f 6e66 6967 290a 2020 2020 2020 2020  config).        
+00010e90: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
+00010ea0: 2866 2751 7565 7279 696e 6720 7b63 6c6f  (f'Querying {clo
+00010eb0: 7564 5f6e 616d 657d 2063 6c75 7374 6572  ud_name} cluster
+00010ec0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00010ed0: 2020 2020 2020 2020 2020 2020 6627 7b63              f'{c
+00010ee0: 6c75 7374 6572 5f6e 616d 655f 696e 5f68  luster_name_in_h
+00010ef0: 696e 747d 2027 0a20 2020 2020 2020 2020  int} '.         
+00010f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010f10: 6627 7374 6174 7573 3a5c 6e7b 7070 7269  f'status:\n{ppri
+00010f20: 6e74 2e70 666f 726d 6174 286e 6f64 655f  nt.pformat(node_
+00010f30: 7374 6174 7573 5f64 6963 7429 7d27 290a  status_dict)}').
+00010f40: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+00010f50: 5f73 7461 7475 7365 7320 3d20 6c69 7374  _statuses = list
+00010f60: 286e 6f64 655f 7374 6174 7573 5f64 6963  (node_status_dic
+00010f70: 742e 7661 6c75 6573 2829 290a 2020 2020  t.values()).    
+00010f80: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+00010f90: 7469 6f6e 2061 7320 653a 2020 2320 7079  tion as e:  # py
+00010fa0: 6c69 6e74 3a20 6469 7361 626c 653d 6272  lint: disable=br
+00010fb0: 6f61 642d 6578 6365 7074 0a20 2020 2020  oad-except.     
+00010fc0: 2020 2020 2020 2077 6974 6820 7578 5f75         with ux_u
+00010fd0: 7469 6c73 2e70 7269 6e74 5f65 7863 6570  tils.print_excep
+00010fe0: 7469 6f6e 5f6e 6f5f 7472 6163 6562 6163  tion_no_tracebac
+00010ff0: 6b28 293a 0a20 2020 2020 2020 2020 2020  k():.           
+00011000: 2020 2020 2072 6169 7365 2065 7863 6570       raise excep
+00011010: 7469 6f6e 732e 436c 7573 7465 7253 7461  tions.ClusterSta
+00011020: 7475 7346 6574 6368 696e 6745 7272 6f72  tusFetchingError
+00011030: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00011040: 2020 2020 2020 6627 4661 696c 6564 2074        f'Failed t
+00011050: 6f20 7175 6572 7920 7b63 6c6f 7564 5f6e  o query {cloud_n
+00011060: 616d 657d 2063 6c75 7374 6572 2027 0a20  ame} cluster '. 
+00011070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011080: 2020 2066 277b 636c 7573 7465 725f 6e61     f'{cluster_na
+00011090: 6d65 5f69 6e5f 6869 6e74 7d20 270a 2020  me_in_hint} '.  
+000110a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000110b0: 2020 6627 7374 6174 7573 3a20 7b63 6f6d    f'status: {com
+000110c0: 6d6f 6e5f 7574 696c 732e 666f 726d 6174  mon_utils.format
+000110d0: 5f65 7863 6570 7469 6f6e 2865 2c20 7573  _exception(e, us
+000110e0: 655f 6272 6163 6b65 743d 5472 7565 297d  e_bracket=True)}
+000110f0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00011100: 2020 290a 2020 2020 656c 7365 3a0a 2020    ).    else:.  
+00011110: 2020 2020 2020 7265 6769 6f6e 203d 2070        region = p
+00011120: 726f 7669 6465 725f 636f 6e66 6967 2e67  rovider_config.g
+00011130: 6574 2827 7265 6769 6f6e 2729 206f 7220  et('region') or 
+00011140: 7072 6f76 6964 6572 5f63 6f6e 6669 672e  provider_config.
+00011150: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
+00011160: 2027 6c6f 6361 7469 6f6e 2729 0a20 2020   'location').   
+00011170: 2020 2020 207a 6f6e 6520 3d20 7261 795f       zone = ray_
+00011180: 636f 6e66 6967 5b27 7072 6f76 6964 6572  config['provider
+00011190: 275d 2e67 6574 2827 6176 6169 6c61 6269  '].get('availabi
+000111a0: 6c69 7479 5f7a 6f6e 6527 290a 2020 2020  lity_zone').    
+000111b0: 2020 2020 6e6f 6465 5f73 7461 7475 7365      node_statuse
+000111c0: 7320 3d20 636c 6f75 642e 7175 6572 795f  s = cloud.query_
+000111d0: 7374 6174 7573 280a 2020 2020 2020 2020  status(.        
+000111e0: 2020 2020 636c 7573 7465 725f 6e61 6d65      cluster_name
+000111f0: 5f6f 6e5f 636c 6f75 642c 0a20 2020 2020  _on_cloud,.     
+00011200: 2020 2020 2020 2074 6167 5f66 696c 7465         tag_filte
+00011210: 725f 666f 725f 636c 7573 7465 7228 636c  r_for_cluster(cl
+00011220: 7573 7465 725f 6e61 6d65 5f6f 6e5f 636c  uster_name_on_cl
+00011230: 6f75 6429 2c20 7265 6769 6f6e 2c20 7a6f  oud), region, zo
+00011240: 6e65 290a 2020 2020 7265 7475 726e 206e  ne).    return n
+00011250: 6f64 655f 7374 6174 7573 6573 0a0a 0a64  ode_statuses...d
+00011260: 6566 2063 6865 636b 5f63 616e 5f63 6c6f  ef check_can_clo
+00011270: 6e65 5f64 6973 6b5f 616e 645f 6f76 6572  ne_disk_and_over
+00011280: 7269 6465 5f74 6173 6b28 0a20 2020 2063  ride_task(.    c
+00011290: 6c75 7374 6572 5f6e 616d 653a 2073 7472  luster_name: str
+000112a0: 2c20 7461 7267 6574 5f63 6c75 7374 6572  , target_cluster
+000112b0: 5f6e 616d 653a 204f 7074 696f 6e61 6c5b  _name: Optional[
+000112c0: 7374 725d 2c20 7461 736b 3a20 2774 6173  str], task: 'tas
+000112d0: 6b5f 6c69 622e 5461 736b 270a 2920 2d3e  k_lib.Task'.) ->
+000112e0: 2054 7570 6c65 5b27 7461 736b 5f6c 6962   Tuple['task_lib
+000112f0: 2e54 6173 6b27 2c20 2763 6c6f 7564 5f76  .Task', 'cloud_v
+00011300: 6d5f 7261 795f 6261 636b 656e 642e 436c  m_ray_backend.Cl
+00011310: 6f75 6456 6d52 6179 5265 736f 7572 6365  oudVmRayResource
+00011320: 4861 6e64 6c65 275d 3a0a 2020 2020 2222  Handle']:.    ""
+00011330: 2243 6865 636b 2069 6620 7468 6520 7461  "Check if the ta
+00011340: 736b 2069 7320 636f 6d70 6174 6962 6c65  sk is compatible
+00011350: 2074 6f20 636c 6f6e 6520 6469 736b 2066   to clone disk f
+00011360: 726f 6d20 7468 6520 736f 7572 6365 2063  rom the source c
+00011370: 6c75 7374 6572 2e0a 0a20 2020 2041 7267  luster...    Arg
+00011380: 733a 0a20 2020 2020 2020 2063 6c75 7374  s:.        clust
+00011390: 6572 5f6e 616d 653a 2054 6865 206e 616d  er_name: The nam
+000113a0: 6520 6f66 2074 6865 2063 6c75 7374 6572  e of the cluster
+000113b0: 2074 6f20 636c 6f6e 6520 6469 736b 2066   to clone disk f
+000113c0: 726f 6d2e 0a20 2020 2020 2020 2074 6172  rom..        tar
+000113d0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+000113e0: 3a20 5468 6520 6e61 6d65 206f 6620 7468  : The name of th
+000113f0: 6520 7461 7267 6574 2063 6c75 7374 6572  e target cluster
+00011400: 2e0a 2020 2020 2020 2020 7461 736b 3a20  ..        task: 
+00011410: 5468 6520 7461 736b 2074 6f20 6368 6563  The task to chec
+00011420: 6b2e 0a0a 2020 2020 5265 7475 726e 733a  k...    Returns:
+00011430: 0a20 2020 2020 2020 2054 6865 2074 6173  .        The tas
+00011440: 6b20 746f 2075 7365 2061 6e64 2074 6865  k to use and the
+00011450: 2072 6573 6f75 7263 6520 6861 6e64 6c65   resource handle
+00011460: 206f 6620 7468 6520 736f 7572 6365 2063   of the source c
+00011470: 6c75 7374 6572 2e0a 0a20 2020 2052 6169  luster...    Rai
+00011480: 7365 733a 0a20 2020 2020 2020 2056 616c  ses:.        Val
+00011490: 7565 4572 726f 723a 2049 6620 7468 6520  ueError: If the 
+000114a0: 736f 7572 6365 2063 6c75 7374 6572 2064  source cluster d
+000114b0: 6f65 7320 6e6f 7420 6578 6973 742e 0a20  oes not exist.. 
+000114c0: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
+000114d0: 732e 4e6f 7453 7570 706f 7274 6564 4572  s.NotSupportedEr
+000114e0: 726f 723a 2049 6620 7468 6520 736f 7572  ror: If the sour
+000114f0: 6365 2063 6c75 7374 6572 2069 7320 6e6f  ce cluster is no
+00011500: 7420 7661 6c69 6420 6f72 2074 6865 0a20  t valid or the. 
+00011510: 2020 2020 2020 2020 2020 2074 6173 6b20             task 
+00011520: 6973 206e 6f74 2063 6f6d 7061 7469 626c  is not compatibl
+00011530: 6520 746f 2063 6c6f 6e65 2064 6973 6b20  e to clone disk 
+00011540: 6672 6f6d 2074 6865 2073 6f75 7263 6520  from the source 
+00011550: 636c 7573 7465 722e 0a20 2020 2022 2222  cluster..    """
+00011560: 0a20 2020 2073 6f75 7263 655f 636c 7573  .    source_clus
+00011570: 7465 725f 7374 6174 7573 2c20 6861 6e64  ter_status, hand
+00011580: 6c65 203d 2072 6566 7265 7368 5f63 6c75  le = refresh_clu
+00011590: 7374 6572 5f73 7461 7475 735f 6861 6e64  ster_status_hand
+000115a0: 6c65 2863 6c75 7374 6572 5f6e 616d 6529  le(cluster_name)
+000115b0: 0a20 2020 2069 6620 736f 7572 6365 5f63  .    if source_c
+000115c0: 6c75 7374 6572 5f73 7461 7475 7320 6973  luster_status is
+000115d0: 204e 6f6e 653a 0a20 2020 2020 2020 2077   None:.        w
+000115e0: 6974 6820 7578 5f75 7469 6c73 2e70 7269  ith ux_utils.pri
+000115f0: 6e74 5f65 7863 6570 7469 6f6e 5f6e 6f5f  nt_exception_no_
+00011600: 7472 6163 6562 6163 6b28 293a 0a20 2020  traceback():.   
+00011610: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00011620: 616c 7565 4572 726f 7228 0a20 2020 2020  alueError(.     
+00011630: 2020 2020 2020 2020 2020 2066 2743 616e             f'Can
+00011640: 6e6f 7420 6669 6e64 2063 6c75 7374 6572  not find cluster
+00011650: 207b 636c 7573 7465 725f 6e61 6d65 2172   {cluster_name!r
+00011660: 7d20 746f 2063 6c6f 6e65 2064 6973 6b20  } to clone disk 
+00011670: 6672 6f6d 2e27 290a 0a20 2020 2069 6620  from.')..    if 
+00011680: 6e6f 7420 6973 696e 7374 616e 6365 2868  not isinstance(h
+00011690: 616e 646c 652c 2062 6163 6b65 6e64 732e  andle, backends.
+000116a0: 436c 6f75 6456 6d52 6179 5265 736f 7572  CloudVmRayResour
+000116b0: 6365 4861 6e64 6c65 293a 0a20 2020 2020  ceHandle):.     
+000116c0: 2020 2077 6974 6820 7578 5f75 7469 6c73     with ux_utils
+000116d0: 2e70 7269 6e74 5f65 7863 6570 7469 6f6e  .print_exception
+000116e0: 5f6e 6f5f 7472 6163 6562 6163 6b28 293a  _no_traceback():
+000116f0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00011700: 7365 2065 7863 6570 7469 6f6e 732e 4e6f  se exceptions.No
+00011710: 7453 7570 706f 7274 6564 4572 726f 7228  tSupportedError(
+00011720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011730: 2066 2743 616e 6e6f 7420 636c 6f6e 6520   f'Cannot clone 
+00011740: 6469 736b 2066 726f 6d20 6120 6e6f 6e2d  disk from a non-
+00011750: 636c 6f75 6420 636c 7573 7465 7220 7b63  cloud cluster {c
+00011760: 6c75 7374 6572 5f6e 616d 6521 727d 2e27  luster_name!r}.'
+00011770: 290a 0a20 2020 2069 6620 736f 7572 6365  )..    if source
+00011780: 5f63 6c75 7374 6572 5f73 7461 7475 7320  _cluster_status 
+00011790: 213d 2073 7461 7475 735f 6c69 622e 436c  != status_lib.Cl
+000117a0: 7573 7465 7253 7461 7475 732e 5354 4f50  usterStatus.STOP
+000117b0: 5045 443a 0a20 2020 2020 2020 2077 6974  PED:.        wit
+000117c0: 6820 7578 5f75 7469 6c73 2e70 7269 6e74  h ux_utils.print
+000117d0: 5f65 7863 6570 7469 6f6e 5f6e 6f5f 7472  _exception_no_tr
+000117e0: 6163 6562 6163 6b28 293a 0a20 2020 2020  aceback():.     
+000117f0: 2020 2020 2020 2072 6169 7365 2065 7863         raise exc
+00011800: 6570 7469 6f6e 732e 4e6f 7453 7570 706f  eptions.NotSuppo
+00011810: 7274 6564 4572 726f 7228 0a20 2020 2020  rtedError(.     
+00011820: 2020 2020 2020 2020 2020 2066 2743 616e             f'Can
+00011830: 6e6f 7420 636c 6f6e 6520 6469 736b 2066  not clone disk f
+00011840: 726f 6d20 636c 7573 7465 7220 7b63 6c75  rom cluster {clu
+00011850: 7374 6572 5f6e 616d 6521 727d 2027 0a20  ster_name!r} '. 
+00011860: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00011870: 2728 7b73 6f75 7263 655f 636c 7573 7465  '({source_cluste
+00011880: 725f 7374 6174 7573 2172 7d29 2e20 506c  r_status!r}). Pl
+00011890: 6561 7365 2073 746f 7020 7468 6520 270a  ease stop the '.
+000118a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000118b0: 6627 636c 7573 7465 7220 6669 7273 743a  f'cluster first:
+000118c0: 2073 6b79 2073 746f 7020 7b63 6c75 7374   sky stop {clust
+000118d0: 6572 5f6e 616d 657d 2729 0a0a 2020 2020  er_name}')..    
+000118e0: 6966 2074 6172 6765 745f 636c 7573 7465  if target_cluste
+000118f0: 725f 6e61 6d65 2069 7320 6e6f 7420 4e6f  r_name is not No
+00011900: 6e65 3a0a 2020 2020 2020 2020 7461 7267  ne:.        targ
+00011910: 6574 5f63 6c75 7374 6572 5f73 7461 7475  et_cluster_statu
+00011920: 732c 205f 203d 2072 6566 7265 7368 5f63  s, _ = refresh_c
+00011930: 6c75 7374 6572 5f73 7461 7475 735f 6861  luster_status_ha
+00011940: 6e64 6c65 280a 2020 2020 2020 2020 2020  ndle(.          
+00011950: 2020 7461 7267 6574 5f63 6c75 7374 6572    target_cluster
+00011960: 5f6e 616d 6529 0a20 2020 2020 2020 2069  _name).        i
+00011970: 6620 7461 7267 6574 5f63 6c75 7374 6572  f target_cluster
+00011980: 5f73 7461 7475 7320 6973 206e 6f74 204e  _status is not N
+00011990: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+000119a0: 2077 6974 6820 7578 5f75 7469 6c73 2e70   with ux_utils.p
+000119b0: 7269 6e74 5f65 7863 6570 7469 6f6e 5f6e  rint_exception_n
+000119c0: 6f5f 7472 6163 6562 6163 6b28 293a 0a20  o_traceback():. 
+000119d0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000119e0: 6169 7365 2065 7863 6570 7469 6f6e 732e  aise exceptions.
+000119f0: 4e6f 7453 7570 706f 7274 6564 4572 726f  NotSupportedErro
+00011a00: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00011a10: 2020 2020 2020 2066 2754 6865 2074 6172         f'The tar
+00011a20: 6765 7420 636c 7573 7465 7220 7b74 6172  get cluster {tar
+00011a30: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+00011a40: 2172 7d20 616c 7265 6164 7920 6578 6973  !r} already exis
+00011a50: 7473 2e20 436c 6f6e 696e 6720 270a 2020  ts. Cloning '.  
+00011a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011a70: 2020 2764 6973 6b20 6973 206f 6e6c 7920    'disk is only 
+00011a80: 7375 7070 6f72 7465 6420 7768 656e 2063  supported when c
+00011a90: 7265 6174 696e 6720 6120 6e65 7720 636c  reating a new cl
+00011aa0: 7573 7465 722e 2054 6f20 6669 783a 2073  uster. To fix: s
+00011ab0: 7065 6369 6679 2027 0a20 2020 2020 2020  pecify '.       
+00011ac0: 2020 2020 2020 2020 2020 2020 2027 6120               'a 
+00011ad0: 6e65 7720 7461 7267 6574 2063 6c75 7374  new target clust
+00011ae0: 6572 206e 616d 652e 2729 0a0a 2020 2020  er name.')..    
+00011af0: 6e65 775f 7461 736b 5f72 6573 6f75 7263  new_task_resourc
+00011b00: 6573 203d 205b 5d0a 2020 2020 6f72 6967  es = [].    orig
+00011b10: 696e 616c 5f63 6c6f 7564 203d 2068 616e  inal_cloud = han
+00011b20: 646c 652e 6c61 756e 6368 6564 5f72 6573  dle.launched_res
+00011b30: 6f75 7263 6573 2e63 6c6f 7564 0a20 2020  ources.cloud.   
+00011b40: 206f 7269 6769 6e61 6c5f 636c 6f75 642e   original_cloud.
+00011b50: 6368 6563 6b5f 6665 6174 7572 6573 5f61  check_features_a
+00011b60: 7265 5f73 7570 706f 7274 6564 280a 2020  re_supported(.  
+00011b70: 2020 2020 2020 6861 6e64 6c65 2e6c 6175        handle.lau
+00011b80: 6e63 6865 645f 7265 736f 7572 6365 732c  nched_resources,
+00011b90: 0a20 2020 2020 2020 207b 636c 6f75 6473  .        {clouds
+00011ba0: 2e43 6c6f 7564 496d 706c 656d 656e 7461  .CloudImplementa
+00011bb0: 7469 6f6e 4665 6174 7572 6573 2e43 4c4f  tionFeatures.CLO
+00011bc0: 4e45 5f44 4953 4b5f 4652 4f4d 5f43 4c55  NE_DISK_FROM_CLU
+00011bd0: 5354 4552 7d29 0a0a 2020 2020 6173 7365  STER})..    asse
+00011be0: 7274 206f 7269 6769 6e61 6c5f 636c 6f75  rt original_clou
+00011bf0: 6420 6973 206e 6f74 204e 6f6e 652c 2068  d is not None, h
+00011c00: 616e 646c 652e 6c61 756e 6368 6564 5f72  andle.launched_r
+00011c10: 6573 6f75 7263 6573 0a20 2020 2068 6173  esources.    has
+00011c20: 5f6f 7665 7272 6964 6520 3d20 4661 6c73  _override = Fals
+00011c30: 650a 2020 2020 6861 735f 6469 736b 5f73  e.    has_disk_s
+00011c40: 697a 655f 6d65 7420 3d20 4661 6c73 650a  ize_met = False.
+00011c50: 2020 2020 6861 735f 636c 6f75 645f 6d65      has_cloud_me
+00011c60: 7420 3d20 4661 6c73 650a 2020 2020 666f  t = False.    fo
+00011c70: 7220 7461 736b 5f72 6573 6f75 7263 6573  r task_resources
+00011c80: 2069 6e20 7461 736b 2e72 6573 6f75 7263   in task.resourc
+00011c90: 6573 3a0a 2020 2020 2020 2020 6966 2068  es:.        if h
+00011ca0: 616e 646c 652e 6c61 756e 6368 6564 5f72  andle.launched_r
+00011cb0: 6573 6f75 7263 6573 2e64 6973 6b5f 7369  esources.disk_si
+00011cc0: 7a65 203e 2074 6173 6b5f 7265 736f 7572  ze > task_resour
+00011cd0: 6365 732e 6469 736b 5f73 697a 653a 0a20  ces.disk_size:. 
+00011ce0: 2020 2020 2020 2020 2020 2023 2054 6865             # The
+00011cf0: 2074 6172 6765 7420 636c 7573 7465 7227   target cluster'
+00011d00: 7320 6469 736b 2073 686f 756c 6420 6265  s disk should be
+00011d10: 2061 7420 6c65 6173 7420 6173 206c 6172   at least as lar
+00011d20: 6765 2061 7320 7468 6520 736f 7572 6365  ge as the source
+00011d30: 2e0a 2020 2020 2020 2020 2020 2020 636f  ..            co
+00011d40: 6e74 696e 7565 0a20 2020 2020 2020 2068  ntinue.        h
+00011d50: 6173 5f64 6973 6b5f 7369 7a65 5f6d 6574  as_disk_size_met
+00011d60: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+00011d70: 6966 2074 6173 6b5f 7265 736f 7572 6365  if task_resource
+00011d80: 732e 636c 6f75 6420 6973 206e 6f74 204e  s.cloud is not N
+00011d90: 6f6e 6520 616e 6420 6e6f 7420 6f72 6967  one and not orig
+00011da0: 696e 616c 5f63 6c6f 7564 2e69 735f 7361  inal_cloud.is_sa
+00011db0: 6d65 5f63 6c6f 7564 280a 2020 2020 2020  me_cloud(.      
+00011dc0: 2020 2020 2020 2020 2020 7461 736b 5f72            task_r
+00011dd0: 6573 6f75 7263 6573 2e63 6c6f 7564 293a  esources.cloud):
+00011de0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+00011df0: 7469 6e75 650a 2020 2020 2020 2020 6861  tinue.        ha
+00011e00: 735f 636c 6f75 645f 6d65 7420 3d20 5472  s_cloud_met = Tr
+00011e10: 7565 0a0a 2020 2020 2020 2020 6f76 6572  ue..        over
+00011e20: 7269 6465 5f70 6172 616d 203d 207b 7d0a  ride_param = {}.
+00011e30: 2020 2020 2020 2020 6966 2074 6173 6b5f          if task_
+00011e40: 7265 736f 7572 6365 732e 636c 6f75 6420  resources.cloud 
+00011e50: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00011e60: 2020 2020 206f 7665 7272 6964 655f 7061       override_pa
+00011e70: 7261 6d5b 2763 6c6f 7564 275d 203d 206f  ram['cloud'] = o
+00011e80: 7269 6769 6e61 6c5f 636c 6f75 640a 2020  riginal_cloud.  
+00011e90: 2020 2020 2020 6966 2074 6173 6b5f 7265        if task_re
+00011ea0: 736f 7572 6365 732e 7265 6769 6f6e 2069  sources.region i
+00011eb0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00011ec0: 2020 2020 6f76 6572 7269 6465 5f70 6172      override_par
+00011ed0: 616d 5b27 7265 6769 6f6e 275d 203d 2068  am['region'] = h
+00011ee0: 616e 646c 652e 6c61 756e 6368 6564 5f72  andle.launched_r
+00011ef0: 6573 6f75 7263 6573 2e72 6567 696f 6e0a  esources.region.
+00011f00: 0a20 2020 2020 2020 2069 6620 6f76 6572  .        if over
+00011f10: 7269 6465 5f70 6172 616d 3a0a 2020 2020  ride_param:.    
+00011f20: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+00011f30: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
+00011f40: 2020 2020 2066 274e 6f20 636c 6f75 642f       f'No cloud/
+00011f50: 7265 6769 6f6e 2073 7065 6369 6669 6564  region specified
+00011f60: 2066 6f72 2074 6865 2074 6173 6b20 7b74   for the task {t
+00011f70: 6173 6b5f 7265 736f 7572 6365 737d 2e20  ask_resources}. 
+00011f80: 5573 696e 6720 7468 6520 7361 6d65 2072  Using the same r
+00011f90: 6567 696f 6e20 270a 2020 2020 2020 2020  egion '.        
+00011fa0: 2020 2020 2020 2020 6627 6173 2073 6f75          f'as sou
+00011fb0: 7263 6520 636c 7573 7465 7220 7b63 6c75  rce cluster {clu
+00011fc0: 7374 6572 5f6e 616d 6521 727d 3a20 270a  ster_name!r}: '.
+00011fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011fe0: 6627 7b68 616e 646c 652e 6c61 756e 6368  f'{handle.launch
+00011ff0: 6564 5f72 6573 6f75 7263 6573 2e63 6c6f  ed_resources.clo
+00012000: 7564 7d27 0a20 2020 2020 2020 2020 2020  ud}'.           
+00012010: 2020 2020 2066 2728 7b68 616e 646c 652e       f'({handle.
+00012020: 6c61 756e 6368 6564 5f72 6573 6f75 7263  launched_resourc
+00012030: 6573 2e72 6567 696f 6e7d 292e 2729 0a20  es.region}).'). 
+00012040: 2020 2020 2020 2020 2020 2068 6173 5f6f             has_o
+00012050: 7665 7272 6964 6520 3d20 5472 7565 0a20  verride = True. 
+00012060: 2020 2020 2020 2074 6173 6b5f 7265 736f         task_reso
+00012070: 7572 6365 7320 3d20 7461 736b 5f72 6573  urces = task_res
+00012080: 6f75 7263 6573 2e63 6f70 7928 2a2a 6f76  ources.copy(**ov
+00012090: 6572 7269 6465 5f70 6172 616d 290a 2020  erride_param).  
+000120a0: 2020 2020 2020 6e65 775f 7461 736b 5f72        new_task_r
+000120b0: 6573 6f75 7263 6573 2e61 7070 656e 6428  esources.append(
+000120c0: 7461 736b 5f72 6573 6f75 7263 6573 290a  task_resources).
+000120d0: 0a20 2020 2069 6620 6e6f 7420 6e65 775f  .    if not new_
+000120e0: 7461 736b 5f72 6573 6f75 7263 6573 3a0a  task_resources:.
+000120f0: 2020 2020 2020 2020 6966 206e 6f74 2068          if not h
+00012100: 6173 5f64 6973 6b5f 7369 7a65 5f6d 6574  as_disk_size_met
+00012110: 3a0a 2020 2020 2020 2020 2020 2020 7769  :.            wi
+00012120: 7468 2075 785f 7574 696c 732e 7072 696e  th ux_utils.prin
+00012130: 745f 6578 6365 7074 696f 6e5f 6e6f 5f74  t_exception_no_t
+00012140: 7261 6365 6261 636b 2829 3a0a 2020 2020  raceback():.    
+00012150: 2020 2020 2020 2020 2020 2020 7461 7267              targ
+00012160: 6574 5f63 6c75 7374 6572 5f6e 616d 655f  et_cluster_name_
+00012170: 7374 7220 3d20 6627 207b 7461 7267 6574  str = f' {target
+00012180: 5f63 6c75 7374 6572 5f6e 616d 6521 727d  _cluster_name!r}
+00012190: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+000121a0: 2020 6966 2074 6172 6765 745f 636c 7573    if target_clus
+000121b0: 7465 725f 6e61 6d65 2069 7320 4e6f 6e65  ter_name is None
+000121c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000121d0: 2020 2020 2020 7461 7267 6574 5f63 6c75        target_clu
+000121e0: 7374 6572 5f6e 616d 655f 7374 7220 3d20  ster_name_str = 
+000121f0: 2727 0a20 2020 2020 2020 2020 2020 2020  ''.             
+00012200: 2020 2072 6169 7365 2065 7863 6570 7469     raise excepti
+00012210: 6f6e 732e 4e6f 7453 7570 706f 7274 6564  ons.NotSupported
+00012220: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+00012230: 2020 2020 2020 2020 2020 2066 2754 6865             f'The
+00012240: 2074 6172 6765 7420 636c 7573 7465 727b   target cluster{
+00012250: 7461 7267 6574 5f63 6c75 7374 6572 5f6e  target_cluster_n
+00012260: 616d 655f 7374 727d 2073 686f 756c 6420  ame_str} should 
+00012270: 6861 7665 2061 2064 6973 6b20 7369 7a65  have a disk size
+00012280: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00012290: 2020 2020 2020 2066 276f 6620 6174 206c         f'of at l
+000122a0: 6561 7374 207b 6861 6e64 6c65 2e6c 6175  east {handle.lau
+000122b0: 6e63 6865 645f 7265 736f 7572 6365 732e  nched_resources.
+000122c0: 6469 736b 5f73 697a 657d 2047 4220 746f  disk_size} GB to
+000122d0: 2063 6c6f 6e65 2074 6865 2027 0a20 2020   clone the '.   
+000122e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000122f0: 2066 2764 6973 6b20 6672 6f6d 207b 636c   f'disk from {cl
+00012300: 7573 7465 725f 6e61 6d65 2172 7d2e 2729  uster_name!r}.')
+00012310: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00012320: 6861 735f 636c 6f75 645f 6d65 743a 0a20  has_cloud_met:. 
+00012330: 2020 2020 2020 2020 2020 2074 6173 6b5f             task_
+00012340: 7265 736f 7572 6365 735f 636c 6f75 645f  resources_cloud_
+00012350: 7374 7220 3d20 275b 2720 2b20 272c 272e  str = '[' + ','.
+00012360: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
+00012370: 2020 2020 2020 5b66 277b 7265 732e 636c        [f'{res.cl
+00012380: 6f75 647d 2720 666f 7220 7265 7320 696e  oud}' for res in
+00012390: 2074 6173 6b2e 7265 736f 7572 6365 735d   task.resources]
+000123a0: 2920 2b20 275d 270a 2020 2020 2020 2020  ) + ']'.        
+000123b0: 2020 2020 7461 736b 5f72 6573 6f75 7263      task_resourc
+000123c0: 6573 5f73 7472 203d 2027 5b27 202b 2027  es_str = '[' + '
+000123d0: 2c27 2e6a 6f69 6e28 0a20 2020 2020 2020  ,'.join(.       
+000123e0: 2020 2020 2020 2020 205b 6627 7b72 6573           [f'{res
+000123f0: 7d27 2066 6f72 2072 6573 2069 6e20 7461  }' for res in ta
+00012400: 736b 2e72 6573 6f75 7263 6573 5d29 202b  sk.resources]) +
+00012410: 2027 5d27 0a20 2020 2020 2020 2020 2020   ']'.           
+00012420: 2077 6974 6820 7578 5f75 7469 6c73 2e70   with ux_utils.p
+00012430: 7269 6e74 5f65 7863 6570 7469 6f6e 5f6e  rint_exception_n
+00012440: 6f5f 7472 6163 6562 6163 6b28 293a 0a20  o_traceback():. 
+00012450: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00012460: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00012470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012480: 2020 2020 2066 2743 616e 6e6f 7420 636c       f'Cannot cl
+00012490: 6f6e 6520 6469 736b 2061 6372 6f73 7320  one disk across 
+000124a0: 636c 6f75 6420 6672 6f6d 207b 6f72 6967  cloud from {orig
+000124b0: 696e 616c 5f63 6c6f 7564 7d20 746f 2027  inal_cloud} to '
+000124c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000124d0: 2020 2020 2066 277b 7461 736b 5f72 6573       f'{task_res
+000124e0: 6f75 7263 6573 5f63 6c6f 7564 5f73 7472  ources_cloud_str
+000124f0: 7d20 666f 7220 7265 736f 7572 6365 7320  } for resources 
+00012500: 7b74 6173 6b5f 7265 736f 7572 6365 735f  {task_resources_
+00012510: 7374 727d 2e27 0a20 2020 2020 2020 2020  str}.'.         
+00012520: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00012530: 2061 7373 6572 7420 4661 6c73 652c 2027   assert False, '
+00012540: 5368 6f75 6c64 206e 6f74 2072 6561 6368  Should not reach
+00012550: 2068 6572 652e 270a 2020 2020 2320 7365   here.'.    # se
+00012560: 7420 7468 6520 6e65 775f 7461 736b 5f72  t the new_task_r
+00012570: 6573 6f75 7263 6573 2074 6f20 6265 2074  esources to be t
+00012580: 6865 2073 616d 6520 7479 7065 2028 6c69  he same type (li
+00012590: 7374 206f 7220 7365 7429 2061 7320 7468  st or set) as th
+000125a0: 650a 2020 2020 2320 6f72 6967 696e 616c  e.    # original
+000125b0: 2074 6173 6b2e 7265 736f 7572 6365 730a   task.resources.
+000125c0: 2020 2020 6966 2068 6173 5f6f 7665 7272      if has_overr
+000125d0: 6964 653a 0a20 2020 2020 2020 2074 6173  ide:.        tas
+000125e0: 6b2e 7365 745f 7265 736f 7572 6365 7328  k.set_resources(
+000125f0: 7479 7065 2874 6173 6b2e 7265 736f 7572  type(task.resour
+00012600: 6365 7329 286e 6577 5f74 6173 6b5f 7265  ces)(new_task_re
+00012610: 736f 7572 6365 7329 290a 2020 2020 2020  sources)).      
+00012620: 2020 2320 5265 7365 7420 7468 6520 6265    # Reset the be
+00012630: 7374 5f72 6573 6f75 7263 6573 2074 6f20  st_resources to 
+00012640: 7472 6967 6572 2072 652d 6f70 7469 6d69  triger re-optimi
+00012650: 7a61 7469 6f6e 0a20 2020 2020 2020 2023  zation.        #
+00012660: 206c 6174 6572 2c20 736f 2074 6861 7420   later, so that 
+00012670: 7468 6520 6e65 7720 7461 736b 5f72 6573  the new task_res
+00012680: 6f75 7263 6573 2077 696c 6c20 6265 2075  ources will be u
+00012690: 7365 642e 0a20 2020 2020 2020 2074 6173  sed..        tas
+000126a0: 6b2e 6265 7374 5f72 6573 6f75 7263 6573  k.best_resources
+000126b0: 203d 204e 6f6e 650a 2020 2020 7265 7475   = None.    retu
+000126c0: 726e 2074 6173 6b2c 2068 616e 646c 650a  rn task, handle.
+000126d0: 0a0a 6465 6620 5f75 7064 6174 655f 636c  ..def _update_cl
+000126e0: 7573 7465 725f 7374 6174 7573 5f6e 6f5f  uster_status_no_
+000126f0: 6c6f 636b 280a 2020 2020 2020 2020 636c  lock(.        cl
+00012700: 7573 7465 725f 6e61 6d65 3a20 7374 7229  uster_name: str)
+00012710: 202d 3e20 4f70 7469 6f6e 616c 5b44 6963   -> Optional[Dic
+00012720: 745b 7374 722c 2041 6e79 5d5d 3a0a 2020  t[str, Any]]:.  
+00012730: 2020 2222 2255 7064 6174 6573 2074 6865    """Updates the
+00012740: 2073 7461 7475 7320 6f66 2074 6865 2063   status of the c
+00012750: 6c75 7374 6572 2e0a 0a20 2020 2052 6169  luster...    Rai
+00012760: 7365 733a 0a20 2020 2020 2020 2065 7863  ses:.        exc
+00012770: 6570 7469 6f6e 732e 436c 7573 7465 7253  eptions.ClusterS
+00012780: 7461 7475 7346 6574 6368 696e 6745 7272  tatusFetchingErr
+00012790: 6f72 3a20 7468 6520 636c 7573 7465 7220  or: the cluster 
+000127a0: 7374 6174 7573 2063 616e 6e6f 7420 6265  status cannot be
+000127b0: 0a20 2020 2020 2020 2020 2066 6574 6368  .          fetch
+000127c0: 6564 2066 726f 6d20 7468 6520 636c 6f75  ed from the clou
+000127d0: 6420 7072 6f76 6964 6572 2e0a 2020 2020  d provider..    
+000127e0: 2222 220a 2020 2020 7265 636f 7264 203d  """.    record =
+000127f0: 2067 6c6f 6261 6c5f 7573 6572 5f73 7461   global_user_sta
+00012800: 7465 2e67 6574 5f63 6c75 7374 6572 5f66  te.get_cluster_f
+00012810: 726f 6d5f 6e61 6d65 2863 6c75 7374 6572  rom_name(cluster
+00012820: 5f6e 616d 6529 0a20 2020 2069 6620 7265  _name).    if re
+00012830: 636f 7264 2069 7320 4e6f 6e65 3a0a 2020  cord is None:.  
+00012840: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+00012850: 650a 2020 2020 6861 6e64 6c65 203d 2072  e.    handle = r
+00012860: 6563 6f72 645b 2768 616e 646c 6527 5d0a  ecord['handle'].
+00012870: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
+00012880: 7461 6e63 6528 6861 6e64 6c65 2c20 6261  tance(handle, ba
+00012890: 636b 656e 6473 2e43 6c6f 7564 566d 5261  ckends.CloudVmRa
+000128a0: 7952 6573 6f75 7263 6548 616e 646c 6529  yResourceHandle)
+000128b0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+000128c0: 2072 6563 6f72 640a 2020 2020 636c 7573   record.    clus
+000128d0: 7465 725f 6e61 6d65 203d 2068 616e 646c  ter_name = handl
+000128e0: 652e 636c 7573 7465 725f 6e61 6d65 0a0a  e.cluster_name..
+000128f0: 2020 2020 6e6f 6465 5f73 7461 7475 7365      node_statuse
+00012900: 7320 3d20 5f71 7565 7279 5f63 6c75 7374  s = _query_clust
+00012910: 6572 5f73 7461 7475 735f 7669 615f 636c  er_status_via_cl
+00012920: 6f75 645f 6170 6928 6861 6e64 6c65 290a  oud_api(handle).
+00012930: 0a20 2020 2061 6c6c 5f6e 6f64 6573 5f75  .    all_nodes_u
+00012940: 7020 3d20 2861 6c6c 280a 2020 2020 2020  p = (all(.      
+00012950: 2020 7374 6174 7573 203d 3d20 7374 6174    status == stat
+00012960: 7573 5f6c 6962 2e43 6c75 7374 6572 5374  us_lib.ClusterSt
+00012970: 6174 7573 2e55 5020 666f 7220 7374 6174  atus.UP for stat
+00012980: 7573 2069 6e20 6e6f 6465 5f73 7461 7475  us in node_statu
+00012990: 7365 7329 2061 6e64 0a20 2020 2020 2020  ses) and.       
+000129a0: 2020 2020 2020 2020 2020 2020 206c 656e               len
+000129b0: 286e 6f64 655f 7374 6174 7573 6573 2920  (node_statuses) 
+000129c0: 3d3d 2068 616e 646c 652e 6c61 756e 6368  == handle.launch
+000129d0: 6564 5f6e 6f64 6573 290a 0a20 2020 2064  ed_nodes)..    d
+000129e0: 6566 2072 756e 5f72 6179 5f73 7461 7475  ef run_ray_statu
+000129f0: 735f 746f 5f63 6865 636b 5f72 6179 5f63  s_to_check_ray_c
+00012a00: 6c75 7374 6572 5f68 6561 6c74 6879 2829  luster_healthy()
+00012a10: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
+00012a20: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00012a30: 2020 2023 2054 4f44 4f28 7a68 7775 293a     # TODO(zhwu):
+00012a40: 2054 6869 7320 6675 6e63 7469 6f6e 2063   This function c
+00012a50: 616e 6e6f 7420 6469 7374 696e 6775 6973  annot distinguis
+00012a60: 6820 7472 616e 7369 656e 7420 6e65 7477  h transient netw
+00012a70: 6f72 6b0a 2020 2020 2020 2020 2020 2020  ork.            
+00012a80: 2320 6572 726f 7220 696e 2072 6179 2773  # error in ray's
+00012a90: 2067 6574 2049 5073 2076 732e 2072 6179   get IPs vs. ray
+00012aa0: 2072 756e 7469 6d65 2066 6169 6c69 6e67   runtime failing
+00012ab0: 2e0a 0a20 2020 2020 2020 2020 2020 2023  ...            #
+00012ac0: 204e 4f54 453a 2066 6574 6368 696e 6720   NOTE: fetching 
+00012ad0: 7468 6520 4950 7320 6973 2076 6572 7920  the IPs is very 
+00012ae0: 736c 6f77 2061 7320 6974 2063 616c 6c73  slow as it calls
+00012af0: 2069 6e74 6f0a 2020 2020 2020 2020 2020   into.          
+00012b00: 2020 2320 6072 6179 2067 6574 2068 6561    # `ray get hea
+00012b10: 642d 6970 2f77 6f72 6b65 722d 6970 7360  d-ip/worker-ips`
+00012b20: 2e20 5573 696e 6720 6361 6368 6564 2049  . Using cached I
+00012b30: 5073 2069 7320 7361 6665 2062 6563 6175  Ps is safe becau
+00012b40: 7365 0a20 2020 2020 2020 2020 2020 2023  se.            #
+00012b50: 2069 6e20 7468 6520 776f 7273 7420 6361   in the worst ca
+00012b60: 7365 2077 6520 7469 6d65 206f 7574 2069  se we time out i
+00012b70: 6e20 7468 6520 6072 6179 2073 7461 7475  n the `ray statu
+00012b80: 7360 2053 5348 2063 6f6d 6d61 6e64 0a20  s` SSH command. 
+00012b90: 2020 2020 2020 2020 2020 2023 2062 656c             # bel
+00012ba0: 6f77 2e0a 2020 2020 2020 2020 2020 2020  ow..            
+00012bb0: 6578 7465 726e 616c 5f69 7073 203d 2068  external_ips = h
+00012bc0: 616e 646c 652e 6361 6368 6564 5f65 7874  andle.cached_ext
+00012bd0: 6572 6e61 6c5f 6970 730a 2020 2020 2020  ernal_ips.      
+00012be0: 2020 2020 2020 2320 5468 6973 2068 6170        # This hap
+00012bf0: 7065 6e73 2077 6865 6e20 7573 6572 2069  pens when user i
+00012c00: 6e74 6572 7275 7074 2074 6865 2060 736b  nterrupt the `sk
+00012c10: 7920 6c61 756e 6368 6020 7072 6f63 6573  y launch` proces
+00012c20: 7320 6265 666f 7265 0a20 2020 2020 2020  s before.       
+00012c30: 2020 2020 2023 2074 6865 2066 6972 7374       # the first
+00012c40: 2074 696d 6520 7265 736f 7572 6365 7320   time resources 
+00012c50: 6861 6e64 6c65 2069 7320 7772 6974 7465  handle is writte
+00012c60: 6e20 6261 636b 2074 6f20 6c6f 6361 6c20  n back to local 
+00012c70: 6461 7461 6261 7365 2e0a 2020 2020 2020  database..      
+00012c80: 2020 2020 2020 2320 5468 6973 2069 7320        # This is 
+00012c90: 6865 6c70 6675 6c20 7768 656e 2075 7365  helpful when use
+00012ca0: 7220 696e 7465 7272 7570 7420 6166 7465  r interrupt afte
+00012cb0: 7220 7468 6520 7072 6f76 6973 696f 6e20  r the provision 
+00012cc0: 6973 2064 6f6e 650a 2020 2020 2020 2020  is done.        
+00012cd0: 2020 2020 2320 616e 6420 6265 666f 7265      # and before
+00012ce0: 2074 6865 2073 6b79 6c65 7420 6973 2072   the skylet is r
+00012cf0: 6573 7461 7274 6564 2e20 4166 7465 7220  estarted. After 
+00012d00: 2332 3330 3420 6973 206d 6572 6765 642c  #2304 is merged,
+00012d10: 2074 6869 730a 2020 2020 2020 2020 2020   this.          
+00012d20: 2020 2320 6865 6c70 7320 6b65 6570 2074    # helps keep t
+00012d30: 6865 2063 6c75 7374 6572 2073 7461 7475  he cluster statu
+00012d40: 7320 746f 2049 4e49 5420 6166 7465 7220  s to INIT after 
+00012d50: 6073 6b79 2073 7461 7475 7320 2d72 602c  `sky status -r`,
+00012d60: 2073 6f0a 2020 2020 2020 2020 2020 2020   so.            
+00012d70: 2320 7573 6572 2077 696c 6c20 6265 206e  # user will be n
+00012d80: 6f74 6966 6965 6420 7468 6174 2061 6e79  otified that any
+00012d90: 2061 7574 6f20 7374 6f70 2f64 6f77 6e20   auto stop/down 
+00012da0: 6d69 6768 7420 6e6f 7420 6265 0a20 2020  might not be.   
+00012db0: 2020 2020 2020 2020 2023 2074 7269 6767           # trigg
+00012dc0: 6572 6564 2e0a 2020 2020 2020 2020 2020  ered..          
+00012dd0: 2020 6966 2065 7874 6572 6e61 6c5f 6970    if external_ip
+00012de0: 7320 6973 204e 6f6e 6520 6f72 206c 656e  s is None or len
+00012df0: 2865 7874 6572 6e61 6c5f 6970 7329 203d  (external_ips) =
+00012e00: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+00012e10: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
+00012e20: 6728 6627 5265 6672 6573 6869 6e67 2073  g(f'Refreshing s
+00012e30: 7461 7475 7320 287b 636c 7573 7465 725f  tatus ({cluster_
+00012e40: 6e61 6d65 2172 7d29 3a20 4e6f 2063 6163  name!r}): No cac
+00012e50: 6865 6420 270a 2020 2020 2020 2020 2020  hed '.          
+00012e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012e70: 2020 2066 2749 5073 2066 6f75 6e64 2e20     f'IPs found. 
+00012e80: 4861 6e64 6c65 3a20 7b68 616e 646c 657d  Handle: {handle}
+00012e90: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+00012ea0: 2020 2072 6169 7365 2065 7863 6570 7469     raise excepti
+00012eb0: 6f6e 732e 4665 7463 6849 5045 7272 6f72  ons.FetchIPError
+00012ec0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00012ed0: 2020 2020 2020 7265 6173 6f6e 3d65 7863        reason=exc
+00012ee0: 6570 7469 6f6e 732e 4665 7463 6849 5045  eptions.FetchIPE
+00012ef0: 7272 6f72 2e52 6561 736f 6e2e 4845 4144  rror.Reason.HEAD
+00012f00: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+00012f10: 2050 6f74 656e 7469 616c 6c79 2072 6566   Potentially ref
+00012f20: 7265 7368 2074 6865 2065 7874 6572 6e61  resh the externa
+00012f30: 6c20 5353 4820 706f 7274 732c 2069 6e20  l SSH ports, in 
+00012f40: 6361 7365 2074 6865 2065 7869 7374 696e  case the existin
+00012f50: 670a 2020 2020 2020 2020 2020 2020 2320  g.            # 
+00012f60: 636c 7573 7465 7220 6265 666f 7265 2023  cluster before #
+00012f70: 3234 3931 2077 6173 206c 6175 6e63 6865  2491 was launche
+00012f80: 6420 7769 7468 6f75 7420 6578 7465 726e  d without extern
+00012f90: 616c 2053 5348 2070 6f72 7473 0a20 2020  al SSH ports.   
+00012fa0: 2020 2020 2020 2020 2023 2063 6163 6865           # cache
+00012fb0: 642e 0a20 2020 2020 2020 2020 2020 2065  d..            e
+00012fc0: 7874 6572 6e61 6c5f 7373 685f 706f 7274  xternal_ssh_port
+00012fd0: 7320 3d20 6861 6e64 6c65 2e65 7874 6572  s = handle.exter
+00012fe0: 6e61 6c5f 7373 685f 706f 7274 7328 290a  nal_ssh_ports().
+00012ff0: 2020 2020 2020 2020 2020 2020 6865 6164              head
+00013000: 5f73 7368 5f70 6f72 7420 3d20 6578 7465  _ssh_port = exte
+00013010: 726e 616c 5f73 7368 5f70 6f72 7473 5b30  rnal_ssh_ports[0
+00013020: 5d0a 0a20 2020 2020 2020 2020 2020 2023  ]..            #
+00013030: 2043 6865 636b 2069 6620 7261 7920 636c   Check if ray cl
+00013040: 7573 7465 7220 7374 6174 7573 2069 7320  uster status is 
+00013050: 6865 616c 7468 792e 0a20 2020 2020 2020  healthy..       
+00013060: 2020 2020 2073 7368 5f63 7265 6465 6e74       ssh_credent
+00013070: 6961 6c73 203d 2073 7368 5f63 7265 6465  ials = ssh_crede
+00013080: 6e74 6961 6c5f 6672 6f6d 5f79 616d 6c28  ntial_from_yaml(
+00013090: 6861 6e64 6c65 2e63 6c75 7374 6572 5f79  handle.cluster_y
+000130a0: 616d 6c2c 0a20 2020 2020 2020 2020 2020  aml,.           
+000130b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000130c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000130d0: 2020 2020 2020 2020 2020 2020 6861 6e64              hand
+000130e0: 6c65 2e64 6f63 6b65 725f 7573 6572 2c0a  le.docker_user,.
+000130f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013120: 2020 2020 2020 2068 616e 646c 652e 7373         handle.ss
+00013130: 685f 7573 6572 290a 0a20 2020 2020 2020  h_user)..       
+00013140: 2020 2020 2072 756e 6e65 7220 3d20 636f       runner = co
+00013150: 6d6d 616e 645f 7275 6e6e 6572 2e53 5348  mmand_runner.SSH
+00013160: 436f 6d6d 616e 6452 756e 6e65 7228 6578  CommandRunner(ex
+00013170: 7465 726e 616c 5f69 7073 5b30 5d2c 0a20  ternal_ips[0],. 
+00013180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000131a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000131b0: 2020 2020 2a2a 7373 685f 6372 6564 656e      **ssh_creden
+000131c0: 7469 616c 732c 0a20 2020 2020 2020 2020  tials,.         
+000131d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000131e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000131f0: 2020 2020 2020 2020 2020 2020 706f 7274              port
+00013200: 3d68 6561 645f 7373 685f 706f 7274 290a  =head_ssh_port).
+00013210: 2020 2020 2020 2020 2020 2020 7263 2c20              rc, 
+00013220: 6f75 7470 7574 2c20 7374 6465 7272 203d  output, stderr =
+00013230: 2072 756e 6e65 722e 7275 6e28 0a20 2020   runner.run(.   
+00013240: 2020 2020 2020 2020 2020 2020 2069 6e73               ins
+00013250: 7461 6e63 655f 7365 7475 702e 5241 595f  tance_setup.RAY_
+00013260: 5354 4154 5553 5f57 4954 485f 534b 595f  STATUS_WITH_SKY_
+00013270: 5241 595f 504f 5254 5f43 4f4d 4d41 4e44  RAY_PORT_COMMAND
+00013280: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00013290: 2020 7374 7265 616d 5f6c 6f67 733d 4661    stream_logs=Fa
+000132a0: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
+000132b0: 2020 2020 2072 6571 7569 7265 5f6f 7574       require_out
+000132c0: 7075 7473 3d54 7275 652c 0a20 2020 2020  puts=True,.     
+000132d0: 2020 2020 2020 2020 2020 2073 6570 6172             separ
+000132e0: 6174 655f 7374 6465 7272 3d54 7275 6529  ate_stderr=True)
+000132f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00013300: 7263 3a0a 2020 2020 2020 2020 2020 2020  rc:.            
+00013310: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
+00013320: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
+00013330: 2020 2020 2020 2020 2020 2020 6627 5265              f'Re
+00013340: 6672 6573 6869 6e67 2073 7461 7475 7320  freshing status 
+00013350: 287b 636c 7573 7465 725f 6e61 6d65 2172  ({cluster_name!r
+00013360: 7d29 3a20 4661 696c 6564 2074 6f20 6368  }): Failed to ch
+00013370: 6563 6b20 270a 2020 2020 2020 2020 2020  eck '.          
+00013380: 2020 2020 2020 2020 2020 6627 7261 7920            f'ray 
+00013390: 636c 7573 7465 725c 2773 2068 6561 6c74  cluster\'s healt
+000133a0: 6869 6e65 7373 2077 6974 6820 270a 2020  hiness with '.  
+000133b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000133c0: 2020 6627 7b69 6e73 7461 6e63 655f 7365    f'{instance_se
+000133d0: 7475 702e 5241 595f 5354 4154 5553 5f57  tup.RAY_STATUS_W
+000133e0: 4954 485f 534b 595f 5241 595f 504f 5254  ITH_SKY_RAY_PORT
+000133f0: 5f43 4f4d 4d41 4e44 7d2e 5c6e 270a 2020  _COMMAND}.\n'.  
+00013400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013410: 2020 6627 2d2d 2073 7464 6f75 7420 2d2d    f'-- stdout --
+00013420: 5c6e 7b6f 7574 7075 747d 5c6e 2d2d 2073  \n{output}\n-- s
+00013430: 7464 6572 7220 2d2d 5c6e 7b73 7464 6572  tderr --\n{stder
+00013440: 727d 2729 0a0a 2020 2020 2020 2020 2020  r}')..          
+00013450: 2020 7265 6164 795f 6865 6164 2c20 7265    ready_head, re
+00013460: 6164 795f 776f 726b 6572 7320 3d20 5f63  ady_workers = _c
+00013470: 6f75 6e74 5f68 6561 6c74 6879 5f6e 6f64  ount_healthy_nod
+00013480: 6573 5f66 726f 6d5f 7261 7928 6f75 7470  es_from_ray(outp
+00013490: 7574 290a 2020 2020 2020 2020 2020 2020  ut).            
+000134a0: 746f 7461 6c5f 6e6f 6465 7320 3d20 6861  total_nodes = ha
+000134b0: 6e64 6c65 2e6c 6175 6e63 6865 645f 6e6f  ndle.launched_no
+000134c0: 6465 7320 2a20 6861 6e64 6c65 2e6e 756d  des * handle.num
+000134d0: 5f69 7073 5f70 6572 5f6e 6f64 650a 2020  _ips_per_node.  
+000134e0: 2020 2020 2020 2020 2020 6966 2072 6561            if rea
+000134f0: 6479 5f68 6561 6420 2b20 7265 6164 795f  dy_head + ready_
+00013500: 776f 726b 6572 7320 3d3d 2074 6f74 616c  workers == total
+00013510: 5f6e 6f64 6573 3a0a 2020 2020 2020 2020  _nodes:.        
+00013520: 2020 2020 2020 2020 7265 7475 726e 2054          return T
+00013530: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+00013540: 7261 6973 6520 5275 6e74 696d 6545 7272  raise RuntimeErr
+00013550: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00013560: 2020 2020 6627 5265 6672 6573 6869 6e67      f'Refreshing
+00013570: 2073 7461 7475 7320 287b 636c 7573 7465   status ({cluste
+00013580: 725f 6e61 6d65 2172 7d29 3a20 7261 7920  r_name!r}): ray 
+00013590: 7374 6174 7573 206e 6f74 2073 686f 7769  status not showi
+000135a0: 6e67 2027 0a20 2020 2020 2020 2020 2020  ng '.           
+000135b0: 2020 2020 2066 2761 6c6c 206e 6f64 6573       f'all nodes
+000135c0: 2028 7b72 6561 6479 5f68 6561 6420 2b20   ({ready_head + 
+000135d0: 7265 6164 795f 776f 726b 6572 737d 2f27  ready_workers}/'
+000135e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000135f0: 2066 277b 746f 7461 6c5f 6e6f 6465 737d   f'{total_nodes}
+00013600: 293b 206f 7574 7075 743a 207b 6f75 7470  ); output: {outp
+00013610: 7574 7d3b 2073 7464 6572 723a 207b 7374  ut}; stderr: {st
+00013620: 6465 7272 7d27 290a 2020 2020 2020 2020  derr}').        
+00013630: 6578 6365 7074 2065 7863 6570 7469 6f6e  except exception
+00013640: 732e 4665 7463 6849 5045 7272 6f72 3a0a  s.FetchIPError:.
+00013650: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00013660: 6572 2e64 6562 7567 280a 2020 2020 2020  er.debug(.      
+00013670: 2020 2020 2020 2020 2020 6627 5265 6672            f'Refr
+00013680: 6573 6869 6e67 2073 7461 7475 7320 287b  eshing status ({
+00013690: 636c 7573 7465 725f 6e61 6d65 2172 7d29  cluster_name!r})
+000136a0: 2066 6169 6c65 6420 746f 2067 6574 2049   failed to get I
+000136b0: 5073 2e27 290a 2020 2020 2020 2020 6578  Ps.').        ex
+000136c0: 6365 7074 2052 756e 7469 6d65 4572 726f  cept RuntimeErro
+000136d0: 7220 6173 2065 3a0a 2020 2020 2020 2020  r as e:.        
+000136e0: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
+000136f0: 2873 7472 2865 2929 0a20 2020 2020 2020  (str(e)).       
+00013700: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+00013710: 6e20 6173 2065 3a20 2023 2070 796c 696e  n as e:  # pylin
+00013720: 743a 2064 6973 6162 6c65 3d62 726f 6164  t: disable=broad
+00013730: 2d65 7863 6570 740a 2020 2020 2020 2020  -except.        
+00013740: 2020 2020 2320 5468 6973 2063 616e 2062      # This can b
+00013750: 6520 7261 6973 6564 2062 7920 6065 7874  e raised by `ext
+00013760: 6572 6e61 6c5f 7373 685f 706f 7274 7328  ernal_ssh_ports(
+00013770: 2960 2c20 6475 6520 746f 2074 6865 0a20  )`, due to the. 
+00013780: 2020 2020 2020 2020 2020 2023 2075 6e64             # und
+00013790: 6572 6c79 696e 6720 6361 6c6c 2074 6f20  erlying call to 
+000137a0: 6b75 6265 726e 6574 6573 2041 5049 2e0a  kubernetes API..
+000137b0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+000137c0: 6572 2e64 6562 7567 280a 2020 2020 2020  er.debug(.      
+000137d0: 2020 2020 2020 2020 2020 6627 5265 6672            f'Refr
+000137e0: 6573 6869 6e67 2073 7461 7475 7320 287b  eshing status ({
+000137f0: 636c 7573 7465 725f 6e61 6d65 2172 7d29  cluster_name!r})
+00013800: 2066 6169 6c65 643a 2027 0a20 2020 2020   failed: '.     
+00013810: 2020 2020 2020 2020 2020 2066 277b 636f             f'{co
+00013820: 6d6d 6f6e 5f75 7469 6c73 2e66 6f72 6d61  mmon_utils.forma
+00013830: 745f 6578 6365 7074 696f 6e28 652c 2075  t_exception(e, u
+00013840: 7365 5f62 7261 636b 6574 3d54 7275 6529  se_bracket=True)
+00013850: 7d27 290a 2020 2020 2020 2020 7265 7475  }').        retu
+00013860: 726e 2046 616c 7365 0a0a 2020 2020 2320  rn False..    # 
+00013870: 4465 7465 726d 696e 696e 6720 6966 2074  Determining if t
+00013880: 6865 2063 6c75 7374 6572 2069 7320 6865  he cluster is he
+00013890: 616c 7468 7920 2855 5029 3a0a 2020 2020  althy (UP):.    
+000138a0: 230a 2020 2020 2320 466f 7220 6e6f 6e2d  #.    # For non-
+000138b0: 7370 6f74 2063 6c75 7374 6572 733a 2049  spot clusters: I
+000138c0: 6620 7261 7920 7374 6174 7573 2073 686f  f ray status sho
+000138d0: 7773 2061 6c6c 206e 6f64 6573 2061 7265  ws all nodes are
+000138e0: 2068 6561 6c74 6879 2c20 6974 2069 730a   healthy, it is.
+000138f0: 2020 2020 2320 7361 6665 2074 6f20 7365      # safe to se
+00013900: 7420 7468 6520 7374 6174 7573 2074 6f20  t the status to 
+00013910: 5550 2061 7320 7374 6172 7469 6e67 2072  UP as starting r
+00013920: 6179 2069 7320 7468 6520 6669 6e61 6c20  ay is the final 
+00013930: 7374 6570 206f 6620 736b 790a 2020 2020  step of sky.    
+00013940: 2320 6c61 756e 6368 2e20 4275 7420 7765  # launch. But we
+00013950: 2066 6f75 6e64 2074 6861 7420 7261 7920   found that ray 
+00013960: 7374 6174 7573 2069 7320 7761 7920 746f  status is way to
+00013970: 6f20 736c 6f77 2028 7365 6520 4e4f 5445  o slow (see NOTE
+00013980: 2062 656c 6f77 2920 736f 0a20 2020 2023   below) so.    #
+00013990: 2077 6520 616c 7761 7973 2071 7565 7279   we always query
+000139a0: 2074 6865 2063 6c6f 7564 2070 726f 7669   the cloud provi
+000139b0: 6465 7220 6669 7273 7420 7768 6963 6820  der first which 
+000139c0: 6973 2066 6173 7465 722e 0a20 2020 2023  is faster..    #
+000139d0: 0a20 2020 2023 2046 6f72 2073 706f 7420  .    # For spot 
+000139e0: 636c 7573 7465 7273 3a20 7468 6520 6162  clusters: the ab
+000139f0: 6f76 6520 6361 6e20 6265 2075 6e73 6166  ove can be unsaf
+00013a00: 6520 6265 6361 7573 6520 7468 6520 5261  e because the Ra
+00013a10: 7920 636c 7573 7465 7220 6d61 790a 2020  y cluster may.  
+00013a20: 2020 2320 7265 6d61 696e 2068 6561 6c74    # remain healt
+00013a30: 6879 2066 6f72 2061 2077 6869 6c65 2062  hy for a while b
+00013a40: 6566 6f72 6520 7468 6520 636c 6f75 6420  efore the cloud 
+00013a50: 636f 6d70 6c65 7465 6c79 2070 7265 656d  completely preem
+00013a60: 7074 7320 7468 6520 564d 732e 0a20 2020  pts the VMs..   
+00013a70: 2023 2057 6520 6861 7665 206d 6974 6967   # We have mitig
+00013a80: 6174 6564 2074 6869 7320 6279 2061 6761  ated this by aga
+00013a90: 696e 2066 6972 7374 2071 7565 7279 696e  in first queryin
+00013aa0: 6720 7468 6520 564d 2073 7461 7465 2066  g the VM state f
+00013ab0: 726f 6d20 7468 6520 636c 6f75 640a 2020  rom the cloud.  
+00013ac0: 2020 2320 7072 6f76 6964 6572 2e0a 2020    # provider..  
+00013ad0: 2020 6966 2061 6c6c 5f6e 6f64 6573 5f75    if all_nodes_u
+00013ae0: 7020 616e 6420 7275 6e5f 7261 795f 7374  p and run_ray_st
+00013af0: 6174 7573 5f74 6f5f 6368 6563 6b5f 7261  atus_to_check_ra
+00013b00: 795f 636c 7573 7465 725f 6865 616c 7468  y_cluster_health
+00013b10: 7928 293a 0a20 2020 2020 2020 2023 204e  y():.        # N
+00013b20: 4f54 453a 2061 6c6c 5f6e 6f64 6573 5f75  OTE: all_nodes_u
+00013b30: 7020 6361 6c63 756c 6174 696f 6e20 6973  p calculation is
+00013b40: 2066 6173 7420 6475 6520 746f 2063 616c   fast due to cal
+00013b50: 6c69 6e67 2063 6c6f 7564 2043 4c49 3b0a  ling cloud CLI;.
+00013b60: 2020 2020 2020 2020 2320 7275 6e5f 7261          # run_ra
+00013b70: 795f 7374 6174 7573 5f74 6f5f 6368 6563  y_status_to_chec
+00013b80: 6b5f 616c 6c5f 6e6f 6465 735f 7570 2829  k_all_nodes_up()
+00013b90: 2069 7320 736c 6f77 2064 7565 2074 6f20   is slow due to 
+00013ba0: 6361 6c6c 696e 6720 6072 6179 2067 6574  calling `ray get
+00013bb0: 0a20 2020 2020 2020 2023 2068 6561 642d  .        # head-
+00013bc0: 6970 2f77 6f72 6b65 722d 6970 7360 2e0a  ip/worker-ips`..
+00013bd0: 2020 2020 2020 2020 7265 636f 7264 5b27          record['
+00013be0: 7374 6174 7573 275d 203d 2073 7461 7475  status'] = statu
+00013bf0: 735f 6c69 622e 436c 7573 7465 7253 7461  s_lib.ClusterSta
+00013c00: 7475 732e 5550 0a20 2020 2020 2020 2067  tus.UP.        g
+00013c10: 6c6f 6261 6c5f 7573 6572 5f73 7461 7465  lobal_user_state
+00013c20: 2e61 6464 5f6f 725f 7570 6461 7465 5f63  .add_or_update_c
+00013c30: 6c75 7374 6572 2863 6c75 7374 6572 5f6e  luster(cluster_n
+00013c40: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
+00013c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013c70: 2020 2020 2068 616e 646c 652c 0a20 2020       handle,.   
+00013c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ca0: 2020 2020 2020 2020 2020 2020 2072 6571               req
+00013cb0: 7565 7374 6564 5f72 6573 6f75 7263 6573  uested_resources
+00013cc0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
+00013cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013cf0: 2020 2020 2020 2072 6561 6479 3d54 7275         ready=Tru
+00013d00: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00013d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013d30: 2020 2069 735f 6c61 756e 6368 3d46 616c     is_launch=Fal
+00013d40: 7365 290a 2020 2020 2020 2020 7265 7475  se).        retu
+00013d50: 726e 2072 6563 6f72 640a 0a20 2020 2023  rn record..    #
+00013d60: 2041 6c6c 2063 6173 6573 2062 656c 6f77   All cases below
+00013d70: 2061 7265 2074 7261 6e73 6974 696f 6e69   are transitioni
+00013d80: 6e67 2074 6865 2063 6c75 7374 6572 2074  ng the cluster t
+00013d90: 6f20 6e6f 6e2d 5550 2073 7461 7465 732e  o non-UP states.
+00013da0: 0a20 2020 2069 6620 6c65 6e28 6e6f 6465  .    if len(node
+00013db0: 5f73 7461 7475 7365 7329 203e 2068 616e  _statuses) > han
+00013dc0: 646c 652e 6c61 756e 6368 6564 5f6e 6f64  dle.launched_nod
+00013dd0: 6573 3a0a 2020 2020 2020 2020 2320 556e  es:.        # Un
+00013de0: 6578 7065 6374 6564 3a20 696e 2074 6865  expected: in the
+00013df0: 2071 7565 7269 6564 2072 6567 696f 6e20   queried region 
+00013e00: 6d6f 7265 2074 6861 6e20 3120 636c 7573  more than 1 clus
+00013e10: 7465 7220 7769 7468 2074 6865 2073 616d  ter with the sam
+00013e20: 650a 2020 2020 2020 2020 2320 636f 6e73  e.        # cons
+00013e30: 7472 7563 7465 6420 6e61 6d65 2074 6167  tructed name tag
+00013e40: 2072 6574 7572 6e65 642e 2054 6869 7320   returned. This 
+00013e50: 7769 6c6c 2074 7970 6963 616c 6c79 206e  will typically n
+00013e60: 6f74 2068 6170 7065 6e20 756e 6c65 7373  ot happen unless
+00013e70: 0a20 2020 2020 2020 2023 2075 7365 7273  .        # users
+00013e80: 206d 616e 7561 6c6c 7920 6372 6561 7465   manually create
+00013e90: 2061 2063 6c75 7374 6572 2077 6974 6820   a cluster with 
+00013ea0: 7468 6174 2063 6f6e 7374 7275 6374 6564  that constructed
+00013eb0: 206e 616d 6520 6f72 2074 6865 7265 0a20   name or there. 
+00013ec0: 2020 2020 2020 2023 2077 6173 2061 2072         # was a r
+00013ed0: 6573 6f75 7263 6520 6c65 616b 2063 6175  esource leak cau
+00013ee0: 7365 6420 6279 2064 6966 6665 7265 6e74  sed by different
+00013ef0: 206c 6175 6e63 6820 6861 7368 2062 6566   launch hash bef
+00013f00: 6f72 6520 2331 3637 310a 2020 2020 2020  ore #1671.      
+00013f10: 2020 2320 7761 7320 6d65 7267 6564 2e0a    # was merged..
+00013f20: 2020 2020 2020 2020 230a 2020 2020 2020          #.      
+00013f30: 2020 2320 2854 6563 686e 6963 616c 6c79    # (Technically
+00013f40: 2073 7065 616b 696e 672c 2065 7665 6e20   speaking, even 
+00013f50: 6966 2072 6574 7572 6e65 6420 6e75 6d20  if returned num 
+00013f60: 6e6f 6465 7320 3c3d 206e 756d 0a20 2020  nodes <= num.   
+00013f70: 2020 2020 2023 2068 616e 646c 652e 6c61       # handle.la
+00013f80: 756e 6368 6564 5f6e 6f64 6573 292c 206e  unched_nodes), n
+00013f90: 6f74 2069 6e63 6c75 6469 6e67 2074 6865  ot including the
+00013fa0: 206c 6175 6e63 6820 6861 7368 2063 6f75   launch hash cou
+00013fb0: 6c64 206d 6561 6e20 7468 650a 2020 2020  ld mean the.    
+00013fc0: 2020 2020 2320 7265 7475 726e 6564 206e      # returned n
+00013fd0: 6f64 6573 2063 6f6e 7461 696e 2073 6f6d  odes contain som
+00013fe0: 6520 6e6f 6465 7320 7468 6174 2064 6f20  e nodes that do 
+00013ff0: 6e6f 7420 6265 6c6f 6e67 2074 6f20 7468  not belong to th
+00014000: 6520 6c6f 6769 6361 6c0a 2020 2020 2020  e logical.      
+00014010: 2020 2320 736b 7970 696c 6f74 2063 6c75    # skypilot clu
+00014020: 7374 6572 2e20 446f 6573 6e27 7420 7365  ster. Doesn't se
+00014030: 656d 2074 6f20 6265 2061 2067 6f6f 6420  em to be a good 
+00014040: 7761 7920 746f 2068 616e 646c 6520 7468  way to handle th
+00014050: 6973 2066 6f72 0a20 2020 2020 2020 2023  is for.        #
+00014060: 206e 6f77 3f29 0a20 2020 2020 2020 2023   now?).        #
+00014070: 0a20 2020 2020 2020 2023 2057 6520 6861  .        # We ha
+00014080: 7665 206e 6f74 2065 7870 6572 6965 6e63  ve not experienc
+00014090: 6564 2074 6865 2061 626f 7665 3b20 6164  ed the above; ad
+000140a0: 6469 6e67 2061 7320 6120 7361 6665 6775  ding as a safegu
+000140b0: 6172 642e 0a20 2020 2020 2020 2023 0a20  ard..        #. 
+000140c0: 2020 2020 2020 2023 2053 696e 6365 2077         # Since w
+000140d0: 6520 6661 696c 6564 2074 6f20 7265 6672  e failed to refr
+000140e0: 6573 682c 2072 6169 7365 2074 6865 2073  esh, raise the s
+000140f0: 7461 7475 7320 6665 7463 6869 6e67 2065  tatus fetching e
+00014100: 7272 6f72 2e0a 2020 2020 2020 2020 7769  rror..        wi
+00014110: 7468 2075 785f 7574 696c 732e 7072 696e  th ux_utils.prin
+00014120: 745f 6578 6365 7074 696f 6e5f 6e6f 5f74  t_exception_no_t
+00014130: 7261 6365 6261 636b 2829 3a0a 2020 2020  raceback():.    
+00014140: 2020 2020 2020 2020 7261 6973 6520 6578          raise ex
+00014150: 6365 7074 696f 6e73 2e43 6c75 7374 6572  ceptions.Cluster
+00014160: 5374 6174 7573 4665 7463 6869 6e67 4572  StatusFetchingEr
+00014170: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+00014180: 2020 2020 2066 2746 6f75 6e64 207b 6c65       f'Found {le
+00014190: 6e28 6e6f 6465 5f73 7461 7475 7365 7329  n(node_statuses)
+000141a0: 7d20 6e6f 6465 2873 2920 7769 7468 2074  } node(s) with t
+000141b0: 6865 2073 616d 6520 636c 7573 7465 7220  he same cluster 
+000141c0: 6e61 6d65 270a 2020 2020 2020 2020 2020  name'.          
+000141d0: 2020 2020 2020 6627 2074 6167 2069 6e20        f' tag in 
+000141e0: 7468 6520 636c 6f75 6420 7072 6f76 6964  the cloud provid
+000141f0: 6572 2066 6f72 2063 6c75 7374 6572 207b  er for cluster {
+00014200: 636c 7573 7465 725f 6e61 6d65 2172 7d2c  cluster_name!r},
+00014210: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00014220: 2020 2066 2777 6869 6368 2073 686f 756c     f'which shoul
+00014230: 6420 6861 7665 207b 6861 6e64 6c65 2e6c  d have {handle.l
+00014240: 6175 6e63 6865 645f 6e6f 6465 737d 206e  aunched_nodes} n
+00014250: 6f64 6573 2e20 5468 6973 2027 0a20 2020  odes. This '.   
+00014260: 2020 2020 2020 2020 2020 2020 2066 276e               f'n
+00014270: 6f72 6d61 6c6c 7920 7368 6f75 6c64 206e  ormally should n
+00014280: 6f74 2068 6170 7065 6e2e 207b 636f 6c6f  ot happen. {colo
+00014290: 7261 6d61 2e46 6f72 652e 5245 447d 506c  rama.Fore.RED}Pl
+000142a0: 6561 7365 2063 6865 636b 2027 0a20 2020  ease check '.   
+000142b0: 2020 2020 2020 2020 2020 2020 2027 7468               'th
+000142c0: 6520 636c 6f75 6420 636f 6e73 6f6c 6520  e cloud console 
+000142d0: 616e 6420 6669 7820 616e 7920 706f 7373  and fix any poss
+000142e0: 6962 6c65 2072 6573 6f75 7263 6573 206c  ible resources l
+000142f0: 6561 6b61 6765 2027 0a20 2020 2020 2020  eakage '.       
+00014300: 2020 2020 2020 2020 2027 2865 2e67 2e2c           '(e.g.,
+00014310: 2069 6620 7468 6572 6520 6172 6520 616e   if there are an
+00014320: 7920 7374 6f70 7065 6420 6e6f 6465 7320  y stopped nodes 
+00014330: 616e 6420 7468 6579 2064 6f20 6e6f 7420  and they do not 
+00014340: 6861 7665 2027 0a20 2020 2020 2020 2020  have '.         
+00014350: 2020 2020 2020 2027 6461 7461 206f 7220         'data or 
+00014360: 6172 6520 756e 6865 616c 7468 792c 2074  are unhealthy, t
+00014370: 6572 6d69 6e61 7465 2074 6865 6d29 2e27  erminate them).'
+00014380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014390: 2066 277b 636f 6c6f 7261 6d61 2e53 7479   f'{colorama.Sty
+000143a0: 6c65 2e52 4553 4554 5f41 4c4c 7d27 290a  le.RESET_ALL}').
+000143b0: 2020 2020 6173 7365 7274 206c 656e 286e      assert len(n
+000143c0: 6f64 655f 7374 6174 7573 6573 2920 3c3d  ode_statuses) <=
+000143d0: 2068 616e 646c 652e 6c61 756e 6368 6564   handle.launched
+000143e0: 5f6e 6f64 6573 0a0a 2020 2020 2320 4966  _nodes..    # If
+000143f0: 2074 6865 206e 6f64 655f 7374 6174 7573   the node_status
+00014400: 6573 2069 7320 656d 7074 792c 2061 6c6c  es is empty, all
+00014410: 2074 6865 206e 6f64 6573 2061 7265 2074   the nodes are t
+00014420: 6572 6d69 6e61 7465 642e 2057 6520 6361  erminated. We ca
+00014430: 6e0a 2020 2020 2320 7361 6665 6c79 2073  n.    # safely s
+00014440: 6574 2074 6865 2063 6c75 7374 6572 2073  et the cluster s
+00014450: 7461 7475 7320 746f 2054 4552 4d49 4e41  tatus to TERMINA
+00014460: 5445 442e 2054 6869 7320 6861 6e64 6c65  TED. This handle
+00014470: 7320 7468 6520 6564 6765 2063 6173 650a  s the edge case.
+00014480: 2020 2020 2320 7768 6572 6520 7468 6520      # where the 
+00014490: 636c 7573 7465 7220 6973 2074 6572 6d69  cluster is termi
+000144a0: 6e61 7465 6420 6279 2074 6865 2075 7365  nated by the use
+000144b0: 7220 6d61 6e75 616c 6c79 2074 6872 6f75  r manually throu
+000144c0: 6768 2074 6865 2055 492e 0a20 2020 2074  gh the UI..    t
+000144d0: 6f5f 7465 726d 696e 6174 6520 3d20 6e6f  o_terminate = no
+000144e0: 7420 6e6f 6465 5f73 7461 7475 7365 730a  t node_statuses.
+000144f0: 0a20 2020 2023 2041 2063 6c75 7374 6572  .    # A cluster
+00014500: 2069 7320 636f 6e73 6964 6572 6564 2022   is considered "
+00014510: 6162 6e6f 726d 616c 222c 2069 6620 6e6f  abnormal", if no
+00014520: 7420 616c 6c20 6e6f 6465 7320 6172 6520  t all nodes are 
+00014530: 5445 524d 494e 4154 4544 206f 720a 2020  TERMINATED or.  
+00014540: 2020 2320 6e6f 7420 616c 6c20 6e6f 6465    # not all node
+00014550: 7320 6172 6520 5354 4f50 5045 442e 2057  s are STOPPED. W
+00014560: 6520 6368 6563 6b20 7468 6174 2077 6974  e check that wit
+00014570: 6820 7468 6520 666f 6c6c 6f77 696e 6720  h the following 
+00014580: 6c6f 6769 633a 0a20 2020 2023 2020 202a  logic:.    #   *
+00014590: 204e 6f74 2061 6c6c 206e 6f64 6573 2061   Not all nodes a
+000145a0: 7265 2074 6572 6d69 6e61 7465 6420 616e  re terminated an
+000145b0: 6420 7468 6572 6527 7320 6174 206c 6561  d there's at lea
+000145c0: 7374 206f 6e65 206e 6f64 650a 2020 2020  st one node.    
+000145d0: 2320 2020 2020 7465 726d 696e 6174 6564  #     terminated
+000145e0: 3b20 6f72 0a20 2020 2023 2020 202a 2041  ; or.    #   * A
+000145f0: 6e79 206f 6620 7468 6520 6e6f 6e2d 5445  ny of the non-TE
+00014600: 524d 494e 4154 4544 206e 6f64 6573 2069  RMINATED nodes i
+00014610: 7320 696e 2061 206e 6f6e 2d53 544f 5050  s in a non-STOPP
+00014620: 4544 2073 7461 7475 732e 0a20 2020 2023  ED status..    #
+00014630: 0a20 2020 2023 2054 6869 7320 696e 636c  .    # This incl
+00014640: 7564 6573 2074 6865 7365 2073 7065 6369  udes these speci
+00014650: 616c 2063 6173 6573 3a0a 2020 2020 2320  al cases:.    # 
+00014660: 2020 2a20 416c 6c20 7374 6f70 7065 6420    * All stopped 
+00014670: 6172 6520 636f 6e73 6964 6572 6564 206e  are considered n
+00014680: 6f72 6d61 6c20 616e 6420 7769 6c6c 2062  ormal and will b
+00014690: 6520 636c 6561 6e65 6420 7570 2061 7420  e cleaned up at 
+000146a0: 7468 6520 656e 640a 2020 2020 2320 2020  the end.    #   
+000146b0: 2020 6f66 2074 6865 2066 756e 6374 696f    of the functio
+000146c0: 6e2e 0a20 2020 2023 2020 202a 2053 6f6d  n..    #   * Som
+000146d0: 6520 6f66 2074 6865 206e 6f64 6573 2055  e of the nodes U
+000146e0: 5020 7368 6f75 6c64 2062 6520 636f 6e73  P should be cons
+000146f0: 6964 6572 6564 2061 626e 6f72 6d61 6c2c  idered abnormal,
+00014700: 2062 6563 6175 7365 2074 6865 2072 6179   because the ray
+00014710: 0a20 2020 2023 2020 2020 2063 6c75 7374  .    #     clust
+00014720: 6572 2069 7320 7072 6f62 6162 6c79 2064  er is probably d
+00014730: 6f77 6e2e 0a20 2020 2023 2020 202a 2054  own..    #   * T
+00014740: 6865 2063 6c75 7374 6572 2069 7320 7061  he cluster is pa
+00014750: 7274 6961 6c6c 7920 7465 726d 696e 6174  rtially terminat
+00014760: 6564 206f 7220 7374 6f70 7065 6420 7368  ed or stopped sh
+00014770: 6f75 6c64 2062 6520 636f 6e73 6964 6572  ould be consider
+00014780: 6564 0a20 2020 2023 2020 2020 2061 626e  ed.    #     abn
+00014790: 6f72 6d61 6c2e 0a20 2020 2023 0a20 2020  ormal..    #.   
+000147a0: 2023 2041 6e20 6162 6e6f 726d 616c 2063   # An abnormal c
+000147b0: 6c75 7374 6572 2077 696c 6c20 7472 616e  luster will tran
+000147c0: 7369 7469 6f6e 2074 6f20 494e 4954 2061  sition to INIT a
+000147d0: 6e64 2068 6176 6520 616e 7920 6175 746f  nd have any auto
+000147e0: 7374 6f70 2073 6574 7469 6e67 0a20 2020  stop setting.   
+000147f0: 2023 2072 6573 6574 2028 756e 6c65 7373   # reset (unless
+00014800: 2069 7427 7320 6175 746f 7374 6f70 7069   it's autostoppi
+00014810: 6e67 2f61 7574 6f64 6f77 6e69 6e67 292e  ng/autodowning).
+00014820: 0a20 2020 2069 735f 6162 6e6f 726d 616c  .    is_abnormal
+00014830: 203d 2028 2830 203c 206c 656e 286e 6f64   = ((0 < len(nod
+00014840: 655f 7374 6174 7573 6573 2920 3c20 6861  e_statuses) < ha
+00014850: 6e64 6c65 2e6c 6175 6e63 6865 645f 6e6f  ndle.launched_no
+00014860: 6465 7329 206f 7220 616e 7928 0a20 2020  des) or any(.   
+00014870: 2020 2020 2073 7461 7475 7320 213d 2073       status != s
+00014880: 7461 7475 735f 6c69 622e 436c 7573 7465  tatus_lib.Cluste
+00014890: 7253 7461 7475 732e 5354 4f50 5045 4420  rStatus.STOPPED 
+000148a0: 666f 7220 7374 6174 7573 2069 6e20 6e6f  for status in no
+000148b0: 6465 5f73 7461 7475 7365 7329 290a 2020  de_statuses)).  
+000148c0: 2020 6966 2069 735f 6162 6e6f 726d 616c    if is_abnormal
+000148d0: 3a0a 2020 2020 2020 2020 6c6f 6767 6572  :.        logger
+000148e0: 2e64 6562 7567 2827 5468 6520 636c 7573  .debug('The clus
+000148f0: 7465 7220 6973 2061 626e 6f72 6d61 6c2e  ter is abnormal.
+00014900: 2053 6574 7469 6e67 2074 6f20 494e 4954   Setting to INIT
+00014910: 2073 7461 7475 732e 2027 0a20 2020 2020   status. '.     
+00014920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014930: 6627 6e6f 6465 5f73 7461 7475 7365 733a  f'node_statuses:
+00014940: 207b 6e6f 6465 5f73 7461 7475 7365 737d   {node_statuses}
+00014950: 2729 0a20 2020 2020 2020 2062 6163 6b65  ').        backe
+00014960: 6e64 203d 2067 6574 5f62 6163 6b65 6e64  nd = get_backend
+00014970: 5f66 726f 6d5f 6861 6e64 6c65 2868 616e  _from_handle(han
+00014980: 646c 6529 0a20 2020 2020 2020 2069 6620  dle).        if 
+00014990: 6973 696e 7374 616e 6365 2862 6163 6b65  isinstance(backe
+000149a0: 6e64 2c0a 2020 2020 2020 2020 2020 2020  nd,.            
+000149b0: 2020 2020 2020 2020 2020 6261 636b 656e            backen
+000149c0: 6473 2e43 6c6f 7564 566d 5261 7942 6163  ds.CloudVmRayBac
+000149d0: 6b65 6e64 2920 616e 6420 7265 636f 7264  kend) and record
+000149e0: 5b27 6175 746f 7374 6f70 275d 203e 3d20  ['autostop'] >= 
+000149f0: 303a 0a20 2020 2020 2020 2020 2020 2069  0:.            i
+00014a00: 6620 6e6f 7420 6261 636b 656e 642e 6973  f not backend.is
+00014a10: 5f64 6566 696e 6974 656c 795f 6175 746f  _definitely_auto
+00014a20: 7374 6f70 7069 6e67 2868 616e 646c 652c  stopping(handle,
+00014a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a60: 2020 2020 2020 2073 7472 6561 6d5f 6c6f         stream_lo
+00014a70: 6773 3d46 616c 7365 293a 0a20 2020 2020  gs=False):.     
+00014a80: 2020 2020 2020 2020 2020 2023 2046 7269             # Fri
+00014a90: 656e 646c 7920 6869 6e74 2e0a 2020 2020  endly hint..    
+00014aa0: 2020 2020 2020 2020 2020 2020 6175 746f              auto
+00014ab0: 7374 6f70 203d 2072 6563 6f72 645b 2761  stop = record['a
+00014ac0: 7574 6f73 746f 7027 5d0a 2020 2020 2020  utostop'].      
+00014ad0: 2020 2020 2020 2020 2020 6d61 7962 655f            maybe_
+00014ae0: 646f 776e 5f73 7472 203d 2027 202d 2d64  down_str = ' --d
+00014af0: 6f77 6e27 2069 6620 7265 636f 7264 5b27  own' if record['
+00014b00: 746f 5f64 6f77 6e27 5d20 656c 7365 2027  to_down'] else '
+00014b10: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00014b20: 2020 6e6f 756e 203d 2027 6175 746f 646f    noun = 'autodo
+00014b30: 776e 2720 6966 2072 6563 6f72 645b 2774  wn' if record['t
+00014b40: 6f5f 646f 776e 275d 2065 6c73 6520 2761  o_down'] else 'a
+00014b50: 7574 6f73 746f 7027 0a0a 2020 2020 2020  utostop'..      
+00014b60: 2020 2020 2020 2020 2020 2320 5265 7365            # Rese
+00014b70: 7420 7468 6520 6175 746f 7374 6f70 7069  t the autostoppi
+00014b80: 6e67 2061 7320 7468 6520 636c 7573 7465  ng as the cluste
+00014b90: 7220 6973 2061 626e 6f72 6d61 6c2c 2061  r is abnormal, a
+00014ba0: 6e64 206d 6179 0a20 2020 2020 2020 2020  nd may.         
+00014bb0: 2020 2020 2020 2023 206e 6f74 2063 6f72         # not cor
+00014bc0: 7265 6374 6c79 2061 7574 6f73 746f 702e  rectly autostop.
+00014bd0: 2052 6573 6574 7469 6e67 2074 6865 2061   Resetting the a
+00014be0: 7574 6f73 746f 7020 7769 6c6c 206c 6574  utostop will let
+00014bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014c00: 2023 2074 6865 2075 7365 7220 6b6e 6f77   # the user know
+00014c10: 2074 6861 7420 7468 6520 6175 746f 7374   that the autost
+00014c20: 6f70 206d 6179 206e 6f74 2068 6170 7065  op may not happe
+00014c30: 6e20 746f 2061 766f 6964 0a20 2020 2020  n to avoid.     
+00014c40: 2020 2020 2020 2020 2020 2023 206c 6561             # lea
+00014c50: 6b61 6765 7320 6672 6f6d 2074 6865 2061  kages from the a
+00014c60: 7373 756d 7074 696f 6e20 7468 6174 2074  ssumption that t
+00014c70: 6865 2063 6c75 7374 6572 2077 696c 6c20  he cluster will 
+00014c80: 6175 746f 7374 6f70 2e0a 2020 2020 2020  autostop..      
+00014c90: 2020 2020 2020 2020 2020 7375 6363 6573            succes
+00014ca0: 7320 3d20 5472 7565 0a20 2020 2020 2020  s = True.       
+00014cb0: 2020 2020 2020 2020 2072 6573 6574 5f6c           reset_l
+00014cc0: 6f63 616c 5f61 7574 6f73 746f 7020 3d20  ocal_autostop = 
+00014cd0: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
+00014ce0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00014cf0: 2020 2020 2020 2020 2020 2020 2020 6261                ba
+00014d00: 636b 656e 642e 7365 745f 6175 746f 7374  ckend.set_autost
+00014d10: 6f70 2868 616e 646c 652c 202d 312c 2073  op(handle, -1, s
+00014d20: 7472 6561 6d5f 6c6f 6773 3d46 616c 7365  tream_logs=False
+00014d30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00014d40: 2020 6578 6365 7074 2065 7863 6570 7469    except excepti
+00014d50: 6f6e 732e 436f 6d6d 616e 6445 7272 6f72  ons.CommandError
+00014d60: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+00014d70: 2020 2020 2020 2020 2020 2073 7563 6365             succe
+00014d80: 7373 203d 2046 616c 7365 0a20 2020 2020  ss = False.     
+00014d90: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00014da0: 6620 652e 7265 7475 726e 636f 6465 203d  f e.returncode =
+00014db0: 3d20 3235 353a 0a20 2020 2020 2020 2020  = 255:.         
+00014dc0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00014dd0: 6f67 6765 722e 6465 6275 6728 6627 5468  ogger.debug(f'Th
+00014de0: 6520 636c 7573 7465 7220 6973 206c 696b  e cluster is lik
+00014df0: 656c 7920 7b6e 6f75 6e7d 6564 2e27 290a  ely {noun}ed.').
+00014e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014e10: 2020 2020 2020 2020 7265 7365 745f 6c6f          reset_lo
+00014e20: 6361 6c5f 6175 746f 7374 6f70 203d 2046  cal_autostop = F
+00014e30: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
+00014e40: 2020 2020 2065 7863 6570 7420 2845 7863       except (Exc
+00014e50: 6570 7469 6f6e 2c20 5379 7374 656d 4578  eption, SystemEx
+00014e60: 6974 2920 6173 2065 3a20 2023 2070 796c  it) as e:  # pyl
+00014e70: 696e 743a 2064 6973 6162 6c65 3d62 726f  int: disable=bro
+00014e80: 6164 2d65 7863 6570 740a 2020 2020 2020  ad-except.      
+00014e90: 2020 2020 2020 2020 2020 2020 2020 7375                su
+00014ea0: 6363 6573 7320 3d20 4661 6c73 650a 2020  ccess = False.  
+00014eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014ec0: 2020 6c6f 6767 6572 2e64 6562 7567 2866    logger.debug(f
+00014ed0: 2746 6169 6c65 6420 746f 2072 6573 6574  'Failed to reset
+00014ee0: 2061 7574 6f73 746f 702e 2044 7565 2074   autostop. Due t
+00014ef0: 6f20 270a 2020 2020 2020 2020 2020 2020  o '.            
+00014f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014f10: 2020 2020 2066 277b 636f 6d6d 6f6e 5f75       f'{common_u
+00014f20: 7469 6c73 2e66 6f72 6d61 745f 6578 6365  tils.format_exce
+00014f30: 7074 696f 6e28 6529 7d27 290a 2020 2020  ption(e)}').    
+00014f40: 2020 2020 2020 2020 2020 2020 6966 2072              if r
+00014f50: 6573 6574 5f6c 6f63 616c 5f61 7574 6f73  eset_local_autos
+00014f60: 746f 703a 0a20 2020 2020 2020 2020 2020  top:.           
+00014f70: 2020 2020 2020 2020 2067 6c6f 6261 6c5f           global_
+00014f80: 7573 6572 5f73 7461 7465 2e73 6574 5f63  user_state.set_c
+00014f90: 6c75 7374 6572 5f61 7574 6f73 746f 705f  luster_autostop_
+00014fa0: 7661 6c75 6528 0a20 2020 2020 2020 2020  value(.         
+00014fb0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+00014fc0: 616e 646c 652e 636c 7573 7465 725f 6e61  andle.cluster_na
+00014fd0: 6d65 2c20 2d31 2c20 746f 5f64 6f77 6e3d  me, -1, to_down=
+00014fe0: 4661 6c73 6529 0a0a 2020 2020 2020 2020  False)..        
+00014ff0: 2020 2020 2020 2020 6966 2073 7563 6365          if succe
+00015000: 7373 3a0a 2020 2020 2020 2020 2020 2020  ss:.            
+00015010: 2020 2020 2020 2020 6f70 6572 6174 696f          operatio
+00015020: 6e5f 7374 7220 3d20 2866 2743 616e 6365  n_str = (f'Cance
+00015030: 6c65 6420 7b6e 6f75 6e7d 206f 6e20 7468  led {noun} on th
+00015040: 6520 636c 7573 7465 7220 270a 2020 2020  e cluster '.    
+00015050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015070: 2066 277b 636c 7573 7465 725f 6e61 6d65   f'{cluster_name
+00015080: 2172 7d27 290a 2020 2020 2020 2020 2020  !r}').          
+00015090: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000150a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000150b0: 6f70 6572 6174 696f 6e5f 7374 7220 3d20  operation_str = 
+000150c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000150d0: 2020 2020 2020 2020 2020 6627 4174 7465            f'Atte
+000150e0: 6d70 7465 6420 746f 2063 616e 6365 6c20  mpted to cancel 
+000150f0: 7b6e 6f75 6e7d 206f 6e20 7468 6520 270a  {noun} on the '.
+00015100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015110: 2020 2020 2020 2020 6627 636c 7573 7465          f'cluste
+00015120: 7220 7b63 6c75 7374 6572 5f6e 616d 6521  r {cluster_name!
+00015130: 727d 2077 6974 6820 6265 7374 2065 6666  r} with best eff
+00015140: 6f72 7427 290a 2020 2020 2020 2020 2020  ort').          
+00015150: 2020 2020 2020 7965 6c6c 6f77 203d 2063        yellow = c
+00015160: 6f6c 6f72 616d 612e 466f 7265 2e59 454c  olorama.Fore.YEL
+00015170: 4c4f 570a 2020 2020 2020 2020 2020 2020  LOW.            
+00015180: 2020 2020 6272 6967 6874 203d 2063 6f6c      bright = col
+00015190: 6f72 616d 612e 5374 796c 652e 4252 4947  orama.Style.BRIG
+000151a0: 4854 0a20 2020 2020 2020 2020 2020 2020  HT.             
+000151b0: 2020 2072 6573 6574 203d 2063 6f6c 6f72     reset = color
+000151c0: 616d 612e 5374 796c 652e 5245 5345 545f  ama.Style.RESET_
+000151d0: 414c 4c0a 2020 2020 2020 2020 2020 2020  ALL.            
+000151e0: 2020 2020 7578 5f75 7469 6c73 2e63 6f6e      ux_utils.con
+000151f0: 736f 6c65 5f6e 6577 6c69 6e65 2829 0a20  sole_newline(). 
+00015200: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00015210: 6f67 6765 722e 7761 726e 696e 6728 0a20  ogger.warning(. 
+00015220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015230: 2020 2066 277b 7965 6c6c 6f77 7d7b 6f70     f'{yellow}{op
+00015240: 6572 6174 696f 6e5f 7374 727d 2c20 7369  eration_str}, si
+00015250: 6e63 6520 6974 2069 7320 666f 756e 6420  nce it is found 
+00015260: 746f 2062 6520 696e 2061 6e20 270a 2020  to be in an '.  
+00015270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015280: 2020 6627 6162 6e6f 726d 616c 2073 7461    f'abnormal sta
+00015290: 7465 2e20 546f 2066 6978 2c20 7472 7920  te. To fix, try 
+000152a0: 7275 6e6e 696e 673a 207b 7265 7365 747d  running: {reset}
+000152b0: 7b62 7269 6768 747d 736b 7920 270a 2020  {bright}sky '.  
+000152c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000152d0: 2020 6627 7374 6172 7420 2d66 202d 6920    f'start -f -i 
+000152e0: 7b61 7574 6f73 746f 707d 7b6d 6179 6265  {autostop}{maybe
+000152f0: 5f64 6f77 6e5f 7374 727d 207b 636c 7573  _down_str} {clus
+00015300: 7465 725f 6e61 6d65 7d27 0a20 2020 2020  ter_name}'.     
+00015310: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00015320: 277b 7265 7365 747d 2729 0a20 2020 2020  '{reset}').     
+00015330: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00015340: 2020 2020 2020 2020 2020 2020 2075 785f               ux_
+00015350: 7574 696c 732e 636f 6e73 6f6c 655f 6e65  utils.console_ne
+00015360: 776c 696e 6528 290a 2020 2020 2020 2020  wline().        
+00015370: 2020 2020 2020 2020 6f70 6572 6174 696f          operatio
+00015380: 6e5f 7374 7220 3d20 2761 7574 6f64 6f77  n_str = 'autodow
+00015390: 6e69 6e67 2720 6966 2072 6563 6f72 645b  ning' if record[
+000153a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000153b0: 2020 2020 2027 746f 5f64 6f77 6e27 5d20       'to_down'] 
+000153c0: 656c 7365 2027 6175 746f 7374 6f70 7069  else 'autostoppi
+000153d0: 6e67 270a 2020 2020 2020 2020 2020 2020  ng'.            
+000153e0: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+000153f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015400: 2020 2020 2066 2743 6c75 7374 6572 207b       f'Cluster {
+00015410: 636c 7573 7465 725f 6e61 6d65 2172 7d20  cluster_name!r} 
+00015420: 6973 207b 6f70 6572 6174 696f 6e5f 7374  is {operation_st
+00015430: 727d 2e20 5365 7474 696e 6720 746f 2027  r}. Setting to '
+00015440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015450: 2020 2020 2027 494e 4954 2073 7461 7475       'INIT statu
+00015460: 733b 2074 7279 2072 6566 7265 7368 2061  s; try refresh a
+00015470: 6761 696e 2069 6e20 6120 7768 696c 652e  gain in a while.
+00015480: 2729 0a0a 2020 2020 2020 2020 2320 4966  ')..        # If
+00015490: 2074 6865 2075 7365 7220 7374 6172 7473   the user starts
+000154a0: 2070 6172 7420 6f66 2061 2053 544f 5050   part of a STOPP
+000154b0: 4544 2063 6c75 7374 6572 2c20 7765 2073  ED cluster, we s
+000154c0: 7469 6c6c 206e 6565 6420 6120 7374 6174  till need a stat
+000154d0: 7573 0a20 2020 2020 2020 2023 2074 6f20  us.        # to 
+000154e0: 7265 7072 6573 656e 7420 7468 6520 6162  represent the ab
+000154f0: 6e6f 726d 616c 2073 7461 7475 732e 2046  normal status. F
+00015500: 6f72 2073 706f 7420 636c 7573 7465 722c  or spot cluster,
+00015510: 2069 7420 6361 6e20 616c 736f 0a20 2020   it can also.   
+00015520: 2020 2020 2023 2072 6570 7265 7365 6e74       # represent
+00015530: 2074 6861 7420 7468 6520 636c 7573 7465   that the cluste
+00015540: 7220 6973 2070 6172 7469 616c 6c79 2070  r is partially p
+00015550: 7265 656d 7074 6564 2e0a 2020 2020 2020  reempted..      
+00015560: 2020 2320 544f 444f 287a 6877 7529 3a20    # TODO(zhwu): 
+00015570: 7468 6520 6465 6669 6e69 7469 6f6e 206f  the definition o
+00015580: 6620 494e 4954 2073 686f 756c 6420 6265  f INIT should be
+00015590: 2061 7564 6974 6564 2f63 6861 6e67 6564   audited/changed
+000155a0: 2e0a 2020 2020 2020 2020 2320 4164 6469  ..        # Addi
+000155b0: 6e67 2061 206e 6577 2073 7461 7475 7320  ng a new status 
+000155c0: 554e 4845 414c 5448 5920 666f 7220 6162  UNHEALTHY for ab
+000155d0: 6e6f 726d 616c 2073 7461 7475 7320 6361  normal status ca
+000155e0: 6e20 6265 2061 2063 686f 6963 652e 0a20  n be a choice.. 
+000155f0: 2020 2020 2020 2067 6c6f 6261 6c5f 7573         global_us
+00015600: 6572 5f73 7461 7465 2e61 6464 5f6f 725f  er_state.add_or_
+00015610: 7570 6461 7465 5f63 6c75 7374 6572 2863  update_cluster(c
+00015620: 6c75 7374 6572 5f6e 616d 652c 0a20 2020  luster_name,.   
+00015630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015650: 2020 2020 2020 2020 2020 2020 2068 616e               han
+00015660: 646c 652c 0a20 2020 2020 2020 2020 2020  dle,.           
+00015670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015690: 2020 2020 2072 6571 7565 7374 6564 5f72       requested_r
+000156a0: 6573 6f75 7263 6573 3d4e 6f6e 652c 0a20  esources=None,. 
+000156b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000156c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000156d0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000156e0: 6561 6479 3d46 616c 7365 2c0a 2020 2020  eady=False,.    
+000156f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015710: 2020 2020 2020 2020 2020 2020 6973 5f6c              is_l
+00015720: 6175 6e63 683d 4661 6c73 6529 0a20 2020  aunch=False).   
+00015730: 2020 2020 2072 6574 7572 6e20 676c 6f62       return glob
+00015740: 616c 5f75 7365 725f 7374 6174 652e 6765  al_user_state.ge
+00015750: 745f 636c 7573 7465 725f 6672 6f6d 5f6e  t_cluster_from_n
+00015760: 616d 6528 636c 7573 7465 725f 6e61 6d65  ame(cluster_name
+00015770: 290a 2020 2020 2320 4e6f 7720 6973 5f61  ).    # Now is_a
+00015780: 626e 6f72 6d61 6c20 6973 2046 616c 7365  bnormal is False
+00015790: 3a20 6569 7468 6572 206e 6f64 655f 7374  : either node_st
+000157a0: 6174 7573 6573 2069 7320 656d 7074 7920  atuses is empty 
+000157b0: 6f72 2061 6c6c 206e 6f64 6573 2061 7265  or all nodes are
+000157c0: 0a20 2020 2023 2053 544f 5050 4544 2e0a  .    # STOPPED..
+000157d0: 2020 2020 6261 636b 656e 6420 3d20 6261      backend = ba
+000157e0: 636b 656e 6473 2e43 6c6f 7564 566d 5261  ckends.CloudVmRa
+000157f0: 7942 6163 6b65 6e64 2829 0a20 2020 2062  yBackend().    b
+00015800: 6163 6b65 6e64 2e70 6f73 745f 7465 6172  ackend.post_tear
+00015810: 646f 776e 5f63 6c65 616e 7570 2868 616e  down_cleanup(han
+00015820: 646c 652c 2074 6572 6d69 6e61 7465 3d74  dle, terminate=t
+00015830: 6f5f 7465 726d 696e 6174 652c 2070 7572  o_terminate, pur
+00015840: 6765 3d46 616c 7365 290a 2020 2020 7265  ge=False).    re
+00015850: 7475 726e 2067 6c6f 6261 6c5f 7573 6572  turn global_user
+00015860: 5f73 7461 7465 2e67 6574 5f63 6c75 7374  _state.get_clust
+00015870: 6572 5f66 726f 6d5f 6e61 6d65 2863 6c75  er_from_name(clu
+00015880: 7374 6572 5f6e 616d 6529 0a0a 0a64 6566  ster_name)...def
+00015890: 205f 7570 6461 7465 5f63 6c75 7374 6572   _update_cluster
+000158a0: 5f73 7461 7475 7328 0a20 2020 2063 6c75  _status(.    clu
+000158b0: 7374 6572 5f6e 616d 653a 2073 7472 2c0a  ster_name: str,.
+000158c0: 2020 2020 6163 7175 6972 655f 7065 725f      acquire_per_
+000158d0: 636c 7573 7465 725f 7374 6174 7573 5f6c  cluster_status_l
+000158e0: 6f63 6b3a 2062 6f6f 6c2c 0a20 2020 2063  ock: bool,.    c
+000158f0: 6c75 7374 6572 5f73 7461 7475 735f 6c6f  luster_status_lo
+00015900: 636b 5f74 696d 656f 7574 3a20 696e 7420  ck_timeout: int 
+00015910: 3d20 434c 5553 5445 525f 5354 4154 5553  = CLUSTER_STATUS
+00015920: 5f4c 4f43 4b5f 5449 4d45 4f55 545f 5345  _LOCK_TIMEOUT_SE
+00015930: 434f 4e44 530a 2920 2d3e 204f 7074 696f  CONDS.) -> Optio
+00015940: 6e61 6c5b 4469 6374 5b73 7472 2c20 416e  nal[Dict[str, An
+00015950: 795d 5d3a 0a20 2020 2022 2222 5570 6461  y]]:.    """Upda
+00015960: 7465 2074 6865 2063 6c75 7374 6572 2073  te the cluster s
+00015970: 7461 7475 732e 0a0a 2020 2020 5468 6520  tatus...    The 
+00015980: 636c 7573 7465 7220 7374 6174 7573 2069  cluster status i
+00015990: 7320 7570 6461 7465 6420 6279 2063 6865  s updated by che
+000159a0: 636b 696e 6720 7261 7920 636c 7573 7465  cking ray cluste
+000159b0: 7220 616e 6420 7265 616c 2073 7461 7475  r and real statu
+000159c0: 7320 6672 6f6d 0a20 2020 2063 6c6f 7564  s from.    cloud
+000159d0: 2e0a 0a20 2020 2054 6865 2066 756e 6374  ...    The funct
+000159e0: 696f 6e20 7769 6c6c 2075 7064 6174 6520  ion will update 
+000159f0: 7468 6520 6361 6368 6564 2063 6c75 7374  the cached clust
+00015a00: 6572 2073 7461 7475 7320 696e 2074 6865  er status in the
+00015a10: 2067 6c6f 6261 6c20 7374 6174 652e 2046   global state. F
+00015a20: 6f72 0a20 2020 2074 6865 2064 6573 6967  or.    the desig
+00015a30: 6e20 6f66 2074 6865 2063 6c75 7374 6572  n of the cluster
+00015a40: 2073 7461 7475 7320 616e 6420 7472 616e   status and tran
+00015a50: 7369 7469 6f6e 2c20 706c 6561 7365 2072  sition, please r
+00015a60: 6566 6572 2074 6f20 7468 650a 2020 2020  efer to the.    
+00015a70: 736b 792f 6465 7369 676e 5f64 6f63 732f  sky/design_docs/
+00015a80: 636c 7573 7465 725f 7374 6174 7573 2e6d  cluster_status.m
+00015a90: 640a 0a20 2020 2041 7267 733a 0a20 2020  d..    Args:.   
+00015aa0: 2020 2020 2063 6c75 7374 6572 5f6e 616d       cluster_nam
+00015ab0: 653a 2054 6865 206e 616d 6520 6f66 2074  e: The name of t
+00015ac0: 6865 2063 6c75 7374 6572 2e0a 2020 2020  he cluster..    
+00015ad0: 2020 2020 6163 7175 6972 655f 7065 725f      acquire_per_
+00015ae0: 636c 7573 7465 725f 7374 6174 7573 5f6c  cluster_status_l
+00015af0: 6f63 6b3a 2057 6865 7468 6572 2074 6f20  ock: Whether to 
+00015b00: 6163 7175 6972 6520 7468 6520 7065 722d  acquire the per-
+00015b10: 636c 7573 7465 7220 6c6f 636b 0a20 2020  cluster lock.   
+00015b20: 2020 2020 2020 2062 6566 6f72 6520 7570         before up
+00015b30: 6461 7469 6e67 2074 6865 2073 7461 7475  dating the statu
+00015b40: 732e 0a20 2020 2020 2020 2063 6c75 7374  s..        clust
+00015b50: 6572 5f73 7461 7475 735f 6c6f 636b 5f74  er_status_lock_t
+00015b60: 696d 656f 7574 3a20 5468 6520 7469 6d65  imeout: The time
+00015b70: 6f75 7420 746f 2061 6371 7569 7265 2074  out to acquire t
+00015b80: 6865 2070 6572 2d63 6c75 7374 6572 0a20  he per-cluster. 
+00015b90: 2020 2020 2020 2020 206c 6f63 6b2e 0a0a           lock...
+00015ba0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+00015bb0: 2020 2020 2049 6620 7468 6520 636c 7573       If the clus
+00015bc0: 7465 7220 6973 2074 6572 6d69 6e61 7465  ter is terminate
+00015bd0: 6420 6f72 2064 6f65 7320 6e6f 7420 6578  d or does not ex
+00015be0: 6973 742c 2072 6574 7572 6e20 4e6f 6e65  ist, return None
+00015bf0: 2e20 4f74 6865 7277 6973 650a 2020 2020  . Otherwise.    
+00015c00: 2020 2020 7265 7475 726e 7320 7468 6520      returns the 
+00015c10: 696e 7075 7420 7265 636f 7264 2077 6974  input record wit
+00015c20: 6820 7374 6174 7573 2061 6e64 2068 616e  h status and han
+00015c30: 646c 6520 706f 7465 6e74 6961 6c6c 7920  dle potentially 
+00015c40: 7570 6461 7465 642e 0a0a 2020 2020 5261  updated...    Ra
+00015c50: 6973 6573 3a0a 2020 2020 2020 2020 6578  ises:.        ex
+00015c60: 6365 7074 696f 6e73 2e43 6c75 7374 6572  ceptions.Cluster
+00015c70: 4f77 6e65 7249 6465 6e74 6974 794d 6973  OwnerIdentityMis
+00015c80: 6d61 7463 6845 7272 6f72 3a20 6966 2074  matchError: if t
+00015c90: 6865 2063 7572 7265 6e74 2075 7365 7220  he current user 
+00015ca0: 6973 0a20 2020 2020 2020 2020 206e 6f74  is.          not
+00015cb0: 2074 6865 2073 616d 6520 6173 2074 6865   the same as the
+00015cc0: 2075 7365 7220 7768 6f20 6372 6561 7465   user who create
+00015cd0: 6420 7468 6520 636c 7573 7465 722e 0a20  d the cluster.. 
+00015ce0: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
+00015cf0: 732e 436c 6f75 6455 7365 7249 6465 6e74  s.CloudUserIdent
+00015d00: 6974 7945 7272 6f72 3a20 6966 2077 6520  ityError: if we 
+00015d10: 6661 696c 2074 6f20 6765 7420 7468 6520  fail to get the 
+00015d20: 6375 7272 656e 7420 7573 6572 0a20 2020  current user.   
+00015d30: 2020 2020 2020 2069 6465 6e74 6974 792e         identity.
+00015d40: 0a20 2020 2020 2020 2065 7863 6570 7469  .        excepti
+00015d50: 6f6e 732e 436c 7573 7465 7253 7461 7475  ons.ClusterStatu
+00015d60: 7346 6574 6368 696e 6745 7272 6f72 3a20  sFetchingError: 
+00015d70: 7468 6520 636c 7573 7465 7220 7374 6174  the cluster stat
+00015d80: 7573 2063 616e 6e6f 7420 6265 0a20 2020  us cannot be.   
+00015d90: 2020 2020 2020 2066 6574 6368 6564 2066         fetched f
+00015da0: 726f 6d20 7468 6520 636c 6f75 6420 7072  rom the cloud pr
+00015db0: 6f76 6964 6572 206f 7220 7468 6572 6520  ovider or there 
+00015dc0: 6172 6520 6c65 616b 6564 206e 6f64 6573  are leaked nodes
+00015dd0: 2063 6175 7369 6e67 0a20 2020 2020 2020   causing.       
+00015de0: 2020 2074 6865 206e 6f64 6520 6e75 6d62     the node numb
+00015df0: 6572 206c 6172 6765 7220 7468 616e 2065  er larger than e
+00015e00: 7870 6563 7465 642e 0a20 2020 2022 2222  xpected..    """
+00015e10: 0a20 2020 2069 6620 6e6f 7420 6163 7175  .    if not acqu
+00015e20: 6972 655f 7065 725f 636c 7573 7465 725f  ire_per_cluster_
+00015e30: 7374 6174 7573 5f6c 6f63 6b3a 0a20 2020  status_lock:.   
+00015e40: 2020 2020 2072 6574 7572 6e20 5f75 7064       return _upd
+00015e50: 6174 655f 636c 7573 7465 725f 7374 6174  ate_cluster_stat
+00015e60: 7573 5f6e 6f5f 6c6f 636b 2863 6c75 7374  us_no_lock(clust
+00015e70: 6572 5f6e 616d 6529 0a0a 2020 2020 7472  er_name)..    tr
+00015e80: 793a 0a20 2020 2020 2020 2077 6974 6820  y:.        with 
+00015e90: 6669 6c65 6c6f 636b 2e46 696c 654c 6f63  filelock.FileLoc
+00015ea0: 6b28 434c 5553 5445 525f 5354 4154 5553  k(CLUSTER_STATUS
+00015eb0: 5f4c 4f43 4b5f 5041 5448 2e66 6f72 6d61  _LOCK_PATH.forma
+00015ec0: 7428 636c 7573 7465 725f 6e61 6d65 292c  t(cluster_name),
+00015ed0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015ef0: 7469 6d65 6f75 743d 636c 7573 7465 725f  timeout=cluster_
+00015f00: 7374 6174 7573 5f6c 6f63 6b5f 7469 6d65  status_lock_time
+00015f10: 6f75 7429 3a0a 2020 2020 2020 2020 2020  out):.          
+00015f20: 2020 7265 7475 726e 205f 7570 6461 7465    return _update
+00015f30: 5f63 6c75 7374 6572 5f73 7461 7475 735f  _cluster_status_
+00015f40: 6e6f 5f6c 6f63 6b28 636c 7573 7465 725f  no_lock(cluster_
+00015f50: 6e61 6d65 290a 2020 2020 6578 6365 7074  name).    except
+00015f60: 2066 696c 656c 6f63 6b2e 5469 6d65 6f75   filelock.Timeou
+00015f70: 743a 0a20 2020 2020 2020 206c 6f67 6765  t:.        logge
+00015f80: 722e 6465 6275 6728 2752 6566 7265 7368  r.debug('Refresh
+00015f90: 696e 6720 7374 6174 7573 3a20 4661 696c  ing status: Fail
+00015fa0: 6564 2067 6574 2074 6865 206c 6f63 6b20  ed get the lock 
+00015fb0: 666f 7220 636c 7573 7465 7220 270a 2020  for cluster '.  
+00015fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015fd0: 2020 2066 277b 636c 7573 7465 725f 6e61     f'{cluster_na
+00015fe0: 6d65 2172 7d2e 2055 7369 6e67 2074 6865  me!r}. Using the
+00015ff0: 2063 6163 6865 6420 7374 6174 7573 2e27   cached status.'
+00016000: 290a 2020 2020 2020 2020 7265 636f 7264  ).        record
+00016010: 203d 2067 6c6f 6261 6c5f 7573 6572 5f73   = global_user_s
+00016020: 7461 7465 2e67 6574 5f63 6c75 7374 6572  tate.get_cluster
+00016030: 5f66 726f 6d5f 6e61 6d65 2863 6c75 7374  _from_name(clust
+00016040: 6572 5f6e 616d 6529 0a20 2020 2020 2020  er_name).       
+00016050: 2072 6574 7572 6e20 7265 636f 7264 0a0a   return record..
+00016060: 0a64 6566 2072 6566 7265 7368 5f63 6c75  .def refresh_clu
+00016070: 7374 6572 5f72 6563 6f72 6428 0a20 2020  ster_record(.   
+00016080: 2063 6c75 7374 6572 5f6e 616d 653a 2073   cluster_name: s
+00016090: 7472 2c0a 2020 2020 2a2c 0a20 2020 2066  tr,.    *,.    f
+000160a0: 6f72 6365 5f72 6566 7265 7368 5f73 7461  orce_refresh_sta
+000160b0: 7475 7365 733a 204f 7074 696f 6e61 6c5b  tuses: Optional[
+000160c0: 5365 745b 7374 6174 7573 5f6c 6962 2e43  Set[status_lib.C
+000160d0: 6c75 7374 6572 5374 6174 7573 5d5d 203d  lusterStatus]] =
+000160e0: 204e 6f6e 652c 0a20 2020 2061 6371 7569   None,.    acqui
+000160f0: 7265 5f70 6572 5f63 6c75 7374 6572 5f73  re_per_cluster_s
+00016100: 7461 7475 735f 6c6f 636b 3a20 626f 6f6c  tatus_lock: bool
+00016110: 203d 2054 7275 652c 0a20 2020 2063 6c75   = True,.    clu
+00016120: 7374 6572 5f73 7461 7475 735f 6c6f 636b  ster_status_lock
+00016130: 5f74 696d 656f 7574 3a20 696e 7420 3d20  _timeout: int = 
+00016140: 434c 5553 5445 525f 5354 4154 5553 5f4c  CLUSTER_STATUS_L
+00016150: 4f43 4b5f 5449 4d45 4f55 545f 5345 434f  OCK_TIMEOUT_SECO
+00016160: 4e44 530a 2920 2d3e 204f 7074 696f 6e61  NDS.) -> Optiona
+00016170: 6c5b 4469 6374 5b73 7472 2c20 416e 795d  l[Dict[str, Any]
+00016180: 5d3a 0a20 2020 2022 2222 5265 6672 6573  ]:.    """Refres
+00016190: 6820 7468 6520 636c 7573 7465 722c 2061  h the cluster, a
+000161a0: 6e64 2072 6574 7572 6e20 7468 6520 706f  nd return the po
+000161b0: 7373 6962 6c79 2075 7064 6174 6564 2072  ssibly updated r
+000161c0: 6563 6f72 642e 0a0a 2020 2020 5468 6973  ecord...    This
+000161d0: 2066 756e 6374 696f 6e20 7769 6c6c 2061   function will a
+000161e0: 6c73 6f20 6368 6563 6b20 7468 6520 6f77  lso check the ow
+000161f0: 6e65 7220 6964 656e 7469 7479 206f 6620  ner identity of 
+00016200: 7468 6520 636c 7573 7465 722c 2061 6e64  the cluster, and
+00016210: 2072 6169 7365 0a20 2020 2065 7863 6570   raise.    excep
+00016220: 7469 6f6e 7320 6966 2074 6865 2063 7572  tions if the cur
+00016230: 7265 6e74 2075 7365 7220 6973 206e 6f74  rent user is not
+00016240: 2074 6865 2073 616d 6520 6173 2074 6865   the same as the
+00016250: 2075 7365 7220 7768 6f20 6372 6561 7465   user who create
+00016260: 6420 7468 650a 2020 2020 636c 7573 7465  d the.    cluste
+00016270: 722e 0a0a 2020 2020 4172 6773 3a0a 2020  r...    Args:.  
+00016280: 2020 2020 2020 636c 7573 7465 725f 6e61        cluster_na
+00016290: 6d65 3a20 5468 6520 6e61 6d65 206f 6620  me: The name of 
+000162a0: 7468 6520 636c 7573 7465 722e 0a20 2020  the cluster..   
+000162b0: 2020 2020 2066 6f72 6365 5f72 6566 7265       force_refre
+000162c0: 7368 5f73 7461 7475 7365 733a 2069 6620  sh_statuses: if 
+000162d0: 7370 6563 6966 6965 642c 2072 6566 7265  specified, refre
+000162e0: 7368 2074 6865 2063 6c75 7374 6572 2069  sh the cluster i
+000162f0: 6620 6974 2068 6173 206f 6e65 206f 660a  f it has one of.
+00016300: 2020 2020 2020 2020 2020 7468 6520 7370            the sp
+00016310: 6563 6966 6965 6420 7374 6174 7573 6573  ecified statuses
+00016320: 2e20 4164 6469 7469 6f6e 616c 6c79 2c20  . Additionally, 
+00016330: 636c 7573 7465 7273 2073 6174 6973 6679  clusters satisfy
+00016340: 696e 6720 7468 650a 2020 2020 2020 2020  ing the.        
+00016350: 2020 666f 6c6c 6f77 696e 6720 636f 6e64    following cond
+00016360: 6974 696f 6e73 2077 696c 6c20 616c 7761  itions will alwa
+00016370: 7973 2062 6520 7265 6672 6573 6865 6420  ys be refreshed 
+00016380: 6e6f 206d 6174 7465 7220 7468 650a 2020  no matter the.  
+00016390: 2020 2020 2020 2020 6172 6775 6d65 6e74          argument
+000163a0: 2069 7320 7370 6563 6966 6965 6420 6f72   is specified or
+000163b0: 206e 6f74 3a0a 2020 2020 2020 2020 2020   not:.          
+000163c0: 2020 312e 2069 7320 6120 7370 6f74 2063    1. is a spot c
+000163d0: 6c75 7374 6572 2c20 6f72 0a20 2020 2020  luster, or.     
+000163e0: 2020 2020 2020 2032 2e20 6973 2061 206e         2. is a n
+000163f0: 6f6e 2d73 706f 7420 636c 7573 7465 722c  on-spot cluster,
+00016400: 2069 7320 6e6f 7420 5354 4f50 5045 442c   is not STOPPED,
+00016410: 2061 6e64 2061 7574 6f73 746f 7020 6973   and autostop is
+00016420: 2073 6574 2e0a 2020 2020 2020 2020 6163   set..        ac
+00016430: 7175 6972 655f 7065 725f 636c 7573 7465  quire_per_cluste
+00016440: 725f 7374 6174 7573 5f6c 6f63 6b3a 2057  r_status_lock: W
+00016450: 6865 7468 6572 2074 6f20 6163 7175 6972  hether to acquir
+00016460: 6520 7468 6520 7065 722d 636c 7573 7465  e the per-cluste
+00016470: 7220 6c6f 636b 0a20 2020 2020 2020 2020  r lock.         
+00016480: 2062 6566 6f72 6520 7570 6461 7469 6e67   before updating
+00016490: 2074 6865 2073 7461 7475 732e 0a20 2020   the status..   
+000164a0: 2020 2020 2063 6c75 7374 6572 5f73 7461       cluster_sta
+000164b0: 7475 735f 6c6f 636b 5f74 696d 656f 7574  tus_lock_timeout
+000164c0: 3a20 5468 6520 7469 6d65 6f75 7420 746f  : The timeout to
+000164d0: 2061 6371 7569 7265 2074 6865 2070 6572   acquire the per
+000164e0: 2d63 6c75 7374 6572 0a20 2020 2020 2020  -cluster.       
+000164f0: 2020 206c 6f63 6b2e 2049 6620 7469 6d65     lock. If time
+00016500: 6f75 742c 2074 6865 2066 756e 6374 696f  out, the functio
+00016510: 6e20 7769 6c6c 2075 7365 2074 6865 2063  n will use the c
+00016520: 6163 6865 6420 7374 6174 7573 2e0a 0a20  ached status... 
+00016530: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+00016540: 2020 2020 4966 2074 6865 2063 6c75 7374      If the clust
+00016550: 6572 2069 7320 7465 726d 696e 6174 6564  er is terminated
+00016560: 206f 7220 646f 6573 206e 6f74 2065 7869   or does not exi
+00016570: 7374 2c20 7265 7475 726e 204e 6f6e 652e  st, return None.
+00016580: 0a20 2020 2020 2020 204f 7468 6572 7769  .        Otherwi
+00016590: 7365 2072 6574 7572 6e73 2074 6865 2063  se returns the c
+000165a0: 6c75 7374 6572 2072 6563 6f72 642e 0a0a  luster record...
+000165b0: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
+000165c0: 2020 2020 6578 6365 7074 696f 6e73 2e43      exceptions.C
+000165d0: 6c75 7374 6572 4f77 6e65 7249 6465 6e74  lusterOwnerIdent
+000165e0: 6974 794d 6973 6d61 7463 6845 7272 6f72  ityMismatchError
+000165f0: 3a20 6966 2074 6865 2063 7572 7265 6e74  : if the current
+00016600: 2075 7365 7220 6973 0a20 2020 2020 2020   user is.       
+00016610: 2020 206e 6f74 2074 6865 2073 616d 6520     not the same 
+00016620: 6173 2074 6865 2075 7365 7220 7768 6f20  as the user who 
+00016630: 6372 6561 7465 6420 7468 6520 636c 7573  created the clus
+00016640: 7465 722e 0a20 2020 2020 2020 2065 7863  ter..        exc
+00016650: 6570 7469 6f6e 732e 436c 6f75 6455 7365  eptions.CloudUse
+00016660: 7249 6465 6e74 6974 7945 7272 6f72 3a20  rIdentityError: 
+00016670: 6966 2077 6520 6661 696c 2074 6f20 6765  if we fail to ge
+00016680: 7420 7468 6520 6375 7272 656e 7420 7573  t the current us
+00016690: 6572 0a20 2020 2020 2020 2020 2069 6465  er.          ide
+000166a0: 6e74 6974 792e 0a20 2020 2020 2020 2065  ntity..        e
+000166b0: 7863 6570 7469 6f6e 732e 436c 7573 7465  xceptions.Cluste
+000166c0: 7253 7461 7475 7346 6574 6368 696e 6745  rStatusFetchingE
+000166d0: 7272 6f72 3a20 7468 6520 636c 7573 7465  rror: the cluste
+000166e0: 7220 7374 6174 7573 2063 616e 6e6f 7420  r status cannot 
+000166f0: 6265 0a20 2020 2020 2020 2020 2066 6574  be.          fet
+00016700: 6368 6564 2066 726f 6d20 7468 6520 636c  ched from the cl
+00016710: 6f75 6420 7072 6f76 6964 6572 206f 7220  oud provider or 
+00016720: 7468 6572 6520 6172 6520 6c65 616b 6564  there are leaked
+00016730: 206e 6f64 6573 2063 6175 7369 6e67 0a20   nodes causing. 
+00016740: 2020 2020 2020 2020 2074 6865 206e 6f64           the nod
+00016750: 6520 6e75 6d62 6572 206c 6172 6765 7220  e number larger 
+00016760: 7468 616e 2065 7870 6563 7465 642e 0a20  than expected.. 
+00016770: 2020 2022 2222 0a0a 2020 2020 7265 636f     """..    reco
+00016780: 7264 203d 2067 6c6f 6261 6c5f 7573 6572  rd = global_user
+00016790: 5f73 7461 7465 2e67 6574 5f63 6c75 7374  _state.get_clust
+000167a0: 6572 5f66 726f 6d5f 6e61 6d65 2863 6c75  er_from_name(clu
+000167b0: 7374 6572 5f6e 616d 6529 0a20 2020 2069  ster_name).    i
+000167c0: 6620 7265 636f 7264 2069 7320 4e6f 6e65  f record is None
+000167d0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+000167e0: 204e 6f6e 650a 2020 2020 6368 6563 6b5f   None.    check_
+000167f0: 6f77 6e65 725f 6964 656e 7469 7479 2863  owner_identity(c
+00016800: 6c75 7374 6572 5f6e 616d 6529 0a0a 2020  luster_name)..  
+00016810: 2020 6861 6e64 6c65 203d 2072 6563 6f72    handle = recor
+00016820: 645b 2768 616e 646c 6527 5d0a 2020 2020  d['handle'].    
+00016830: 6966 2069 7369 6e73 7461 6e63 6528 6861  if isinstance(ha
+00016840: 6e64 6c65 2c20 6261 636b 656e 6473 2e43  ndle, backends.C
+00016850: 6c6f 7564 566d 5261 7952 6573 6f75 7263  loudVmRayResourc
+00016860: 6548 616e 646c 6529 3a0a 2020 2020 2020  eHandle):.      
+00016870: 2020 7573 655f 7370 6f74 203d 2068 616e    use_spot = han
+00016880: 646c 652e 6c61 756e 6368 6564 5f72 6573  dle.launched_res
+00016890: 6f75 7263 6573 2e75 7365 5f73 706f 740a  ources.use_spot.
+000168a0: 2020 2020 2020 2020 6861 735f 6175 746f          has_auto
+000168b0: 7374 6f70 203d 2028 7265 636f 7264 5b27  stop = (record['
+000168c0: 7374 6174 7573 275d 2021 3d20 7374 6174  status'] != stat
+000168d0: 7573 5f6c 6962 2e43 6c75 7374 6572 5374  us_lib.ClusterSt
+000168e0: 6174 7573 2e53 544f 5050 4544 2061 6e64  atus.STOPPED and
+000168f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016900: 2020 2020 2020 2020 2072 6563 6f72 645b           record[
+00016910: 2761 7574 6f73 746f 7027 5d20 3e3d 2030  'autostop'] >= 0
+00016920: 290a 2020 2020 2020 2020 666f 7263 655f  ).        force_
+00016930: 7265 6672 6573 685f 666f 725f 636c 7573  refresh_for_clus
+00016940: 7465 7220 3d20 2866 6f72 6365 5f72 6566  ter = (force_ref
+00016950: 7265 7368 5f73 7461 7475 7365 7320 6973  resh_statuses is
+00016960: 206e 6f74 204e 6f6e 6520 616e 640a 2020   not None and.  
+00016970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016990: 2020 2072 6563 6f72 645b 2773 7461 7475     record['statu
+000169a0: 7327 5d20 696e 2066 6f72 6365 5f72 6566  s'] in force_ref
+000169b0: 7265 7368 5f73 7461 7475 7365 7329 0a20  resh_statuses). 
+000169c0: 2020 2020 2020 2069 6620 666f 7263 655f         if force_
+000169d0: 7265 6672 6573 685f 666f 725f 636c 7573  refresh_for_clus
+000169e0: 7465 7220 6f72 2068 6173 5f61 7574 6f73  ter or has_autos
+000169f0: 746f 7020 6f72 2075 7365 5f73 706f 743a  top or use_spot:
+00016a00: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
+00016a10: 6f72 6420 3d20 5f75 7064 6174 655f 636c  ord = _update_cl
+00016a20: 7573 7465 725f 7374 6174 7573 280a 2020  uster_status(.  
+00016a30: 2020 2020 2020 2020 2020 2020 2020 636c                cl
+00016a40: 7573 7465 725f 6e61 6d65 2c0a 2020 2020  uster_name,.    
+00016a50: 2020 2020 2020 2020 2020 2020 6163 7175              acqu
+00016a60: 6972 655f 7065 725f 636c 7573 7465 725f  ire_per_cluster_
+00016a70: 7374 6174 7573 5f6c 6f63 6b3d 6163 7175  status_lock=acqu
+00016a80: 6972 655f 7065 725f 636c 7573 7465 725f  ire_per_cluster_
+00016a90: 7374 6174 7573 5f6c 6f63 6b2c 0a20 2020  status_lock,.   
+00016aa0: 2020 2020 2020 2020 2020 2020 2063 6c75               clu
+00016ab0: 7374 6572 5f73 7461 7475 735f 6c6f 636b  ster_status_lock
+00016ac0: 5f74 696d 656f 7574 3d63 6c75 7374 6572  _timeout=cluster
+00016ad0: 5f73 7461 7475 735f 6c6f 636b 5f74 696d  _status_lock_tim
+00016ae0: 656f 7574 290a 2020 2020 7265 7475 726e  eout).    return
+00016af0: 2072 6563 6f72 640a 0a0a 4074 696d 656c   record...@timel
+00016b00: 696e 652e 6576 656e 740a 6465 6620 7265  ine.event.def re
+00016b10: 6672 6573 685f 636c 7573 7465 725f 7374  fresh_cluster_st
+00016b20: 6174 7573 5f68 616e 646c 6528 0a20 2020  atus_handle(.   
+00016b30: 2063 6c75 7374 6572 5f6e 616d 653a 2073   cluster_name: s
+00016b40: 7472 2c0a 2020 2020 2a2c 0a20 2020 2066  tr,.    *,.    f
+00016b50: 6f72 6365 5f72 6566 7265 7368 5f73 7461  orce_refresh_sta
+00016b60: 7475 7365 733a 204f 7074 696f 6e61 6c5b  tuses: Optional[
+00016b70: 5365 745b 7374 6174 7573 5f6c 6962 2e43  Set[status_lib.C
+00016b80: 6c75 7374 6572 5374 6174 7573 5d5d 203d  lusterStatus]] =
+00016b90: 204e 6f6e 652c 0a20 2020 2061 6371 7569   None,.    acqui
+00016ba0: 7265 5f70 6572 5f63 6c75 7374 6572 5f73  re_per_cluster_s
+00016bb0: 7461 7475 735f 6c6f 636b 3a20 626f 6f6c  tatus_lock: bool
+00016bc0: 203d 2054 7275 652c 0a20 2020 2063 6c75   = True,.    clu
+00016bd0: 7374 6572 5f73 7461 7475 735f 6c6f 636b  ster_status_lock
+00016be0: 5f74 696d 656f 7574 3a20 696e 7420 3d20  _timeout: int = 
+00016bf0: 434c 5553 5445 525f 5354 4154 5553 5f4c  CLUSTER_STATUS_L
+00016c00: 4f43 4b5f 5449 4d45 4f55 545f 5345 434f  OCK_TIMEOUT_SECO
+00016c10: 4e44 530a 2920 2d3e 2054 7570 6c65 5b4f  NDS.) -> Tuple[O
+00016c20: 7074 696f 6e61 6c5b 7374 6174 7573 5f6c  ptional[status_l
+00016c30: 6962 2e43 6c75 7374 6572 5374 6174 7573  ib.ClusterStatus
+00016c40: 5d2c 0a20 2020 2020 2020 2020 2020 4f70  ],.           Op
+00016c50: 7469 6f6e 616c 5b62 6163 6b65 6e64 732e  tional[backends.
+00016c60: 5265 736f 7572 6365 4861 6e64 6c65 5d5d  ResourceHandle]]
+00016c70: 3a0a 2020 2020 2222 2252 6566 7265 7368  :.    """Refresh
+00016c80: 2074 6865 2063 6c75 7374 6572 2c20 616e   the cluster, an
+00016c90: 6420 7265 7475 726e 2074 6865 2070 6f73  d return the pos
+00016ca0: 7369 626c 7920 7570 6461 7465 6420 7374  sibly updated st
+00016cb0: 6174 7573 2061 6e64 2068 616e 646c 652e  atus and handle.
+00016cc0: 0a0a 2020 2020 5468 6973 2069 7320 6120  ..    This is a 
+00016cd0: 7772 6170 7065 7220 6f66 2072 6566 7265  wrapper of refre
+00016ce0: 7368 5f63 6c75 7374 6572 5f72 6563 6f72  sh_cluster_recor
+00016cf0: 642c 2077 6869 6368 2072 6574 7572 6e73  d, which returns
+00016d00: 2074 6865 2073 7461 7475 7320 616e 640a   the status and.
+00016d10: 2020 2020 6861 6e64 6c65 206f 6620 7468      handle of th
+00016d20: 6520 636c 7573 7465 722e 0a20 2020 2050  e cluster..    P
+00016d30: 6c65 6173 6520 7265 6665 7220 746f 2074  lease refer to t
+00016d40: 6865 2064 6f63 7374 7269 6e67 206f 6620  he docstring of 
+00016d50: 7265 6672 6573 685f 636c 7573 7465 725f  refresh_cluster_
+00016d60: 7265 636f 7264 2066 6f72 2074 6865 2064  record for the d
+00016d70: 6574 6169 6c73 2e0a 2020 2020 2222 220a  etails..    """.
+00016d80: 2020 2020 7265 636f 7264 203d 2072 6566      record = ref
+00016d90: 7265 7368 5f63 6c75 7374 6572 5f72 6563  resh_cluster_rec
+00016da0: 6f72 6428 0a20 2020 2020 2020 2063 6c75  ord(.        clu
+00016db0: 7374 6572 5f6e 616d 652c 0a20 2020 2020  ster_name,.     
+00016dc0: 2020 2066 6f72 6365 5f72 6566 7265 7368     force_refresh
+00016dd0: 5f73 7461 7475 7365 733d 666f 7263 655f  _statuses=force_
+00016de0: 7265 6672 6573 685f 7374 6174 7573 6573  refresh_statuses
+00016df0: 2c0a 2020 2020 2020 2020 6163 7175 6972  ,.        acquir
+00016e00: 655f 7065 725f 636c 7573 7465 725f 7374  e_per_cluster_st
+00016e10: 6174 7573 5f6c 6f63 6b3d 6163 7175 6972  atus_lock=acquir
+00016e20: 655f 7065 725f 636c 7573 7465 725f 7374  e_per_cluster_st
+00016e30: 6174 7573 5f6c 6f63 6b2c 0a20 2020 2020  atus_lock,.     
+00016e40: 2020 2063 6c75 7374 6572 5f73 7461 7475     cluster_statu
+00016e50: 735f 6c6f 636b 5f74 696d 656f 7574 3d63  s_lock_timeout=c
+00016e60: 6c75 7374 6572 5f73 7461 7475 735f 6c6f  luster_status_lo
+00016e70: 636b 5f74 696d 656f 7574 290a 2020 2020  ck_timeout).    
+00016e80: 6966 2072 6563 6f72 6420 6973 204e 6f6e  if record is Non
+00016e90: 653a 0a20 2020 2020 2020 2072 6574 7572  e:.        retur
+00016ea0: 6e20 4e6f 6e65 2c20 4e6f 6e65 0a20 2020  n None, None.   
+00016eb0: 2072 6574 7572 6e20 7265 636f 7264 5b27   return record['
+00016ec0: 7374 6174 7573 275d 2c20 7265 636f 7264  status'], record
+00016ed0: 5b27 6861 6e64 6c65 275d 0a0a 0a23 203d  ['handle']...# =
+00016ee0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00016ef0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00016f00: 3d3d 3d3d 0a0a 0a40 7479 7069 6e67 2e6f  ====...@typing.o
+00016f10: 7665 726c 6f61 640a 6465 6620 6368 6563  verload.def chec
+00016f20: 6b5f 636c 7573 7465 725f 6176 6169 6c61  k_cluster_availa
+00016f30: 626c 6528 0a20 2020 2063 6c75 7374 6572  ble(.    cluster
+00016f40: 5f6e 616d 653a 2073 7472 2c0a 2020 2020  _name: str,.    
+00016f50: 2a2c 0a20 2020 206f 7065 7261 7469 6f6e  *,.    operation
+00016f60: 3a20 7374 722c 0a20 2020 2063 6865 636b  : str,.    check
+00016f70: 5f63 6c6f 7564 5f76 6d5f 7261 795f 6261  _cloud_vm_ray_ba
+00016f80: 636b 656e 643a 204c 6974 6572 616c 5b54  ckend: Literal[T
+00016f90: 7275 655d 203d 2054 7275 652c 0a20 2020  rue] = True,.   
+00016fa0: 2064 7279 7275 6e3a 2062 6f6f 6c20 3d20   dryrun: bool = 
+00016fb0: 2e2e 2e2c 0a29 202d 3e20 2763 6c6f 7564  ...,.) -> 'cloud
+00016fc0: 5f76 6d5f 7261 795f 6261 636b 656e 642e  _vm_ray_backend.
+00016fd0: 436c 6f75 6456 6d52 6179 5265 736f 7572  CloudVmRayResour
+00016fe0: 6365 4861 6e64 6c65 273a 0a20 2020 202e  ceHandle':.    .
+00016ff0: 2e2e 0a0a 0a40 7479 7069 6e67 2e6f 7665  .....@typing.ove
+00017000: 726c 6f61 640a 6465 6620 6368 6563 6b5f  rload.def check_
+00017010: 636c 7573 7465 725f 6176 6169 6c61 626c  cluster_availabl
+00017020: 6528 0a20 2020 2063 6c75 7374 6572 5f6e  e(.    cluster_n
+00017030: 616d 653a 2073 7472 2c0a 2020 2020 2a2c  ame: str,.    *,
+00017040: 0a20 2020 206f 7065 7261 7469 6f6e 3a20  .    operation: 
+00017050: 7374 722c 0a20 2020 2063 6865 636b 5f63  str,.    check_c
+00017060: 6c6f 7564 5f76 6d5f 7261 795f 6261 636b  loud_vm_ray_back
+00017070: 656e 643a 204c 6974 6572 616c 5b46 616c  end: Literal[Fal
+00017080: 7365 5d2c 0a20 2020 2064 7279 7275 6e3a  se],.    dryrun:
+00017090: 2062 6f6f 6c20 3d20 2e2e 2e2c 0a29 202d   bool = ...,.) -
+000170a0: 3e20 6261 636b 656e 6473 2e52 6573 6f75  > backends.Resou
+000170b0: 7263 6548 616e 646c 653a 0a20 2020 202e  rceHandle:.    .
+000170c0: 2e2e 0a0a 0a64 6566 2063 6865 636b 5f63  .....def check_c
+000170d0: 6c75 7374 6572 5f61 7661 696c 6162 6c65  luster_available
+000170e0: 280a 2020 2020 636c 7573 7465 725f 6e61  (.    cluster_na
+000170f0: 6d65 3a20 7374 722c 0a20 2020 202a 2c0a  me: str,.    *,.
+00017100: 2020 2020 6f70 6572 6174 696f 6e3a 2073      operation: s
+00017110: 7472 2c0a 2020 2020 6368 6563 6b5f 636c  tr,.    check_cl
+00017120: 6f75 645f 766d 5f72 6179 5f62 6163 6b65  oud_vm_ray_backe
+00017130: 6e64 3a20 626f 6f6c 203d 2054 7275 652c  nd: bool = True,
+00017140: 0a20 2020 2064 7279 7275 6e3a 2062 6f6f  .    dryrun: boo
+00017150: 6c20 3d20 4661 6c73 652c 0a29 202d 3e20  l = False,.) -> 
+00017160: 6261 636b 656e 6473 2e52 6573 6f75 7263  backends.Resourc
+00017170: 6548 616e 646c 653a 0a20 2020 2022 2222  eHandle:.    """
+00017180: 4368 6563 6b20 6966 2074 6865 2063 6c75  Check if the clu
+00017190: 7374 6572 2069 7320 6176 6169 6c61 626c  ster is availabl
+000171a0: 652e 0a0a 2020 2020 5261 6973 6573 3a0a  e...    Raises:.
+000171b0: 2020 2020 2020 2020 5661 6c75 6545 7272          ValueErr
+000171c0: 6f72 3a20 6966 2074 6865 2063 6c75 7374  or: if the clust
+000171d0: 6572 2064 6f65 7320 6e6f 7420 6578 6973  er does not exis
+000171e0: 742e 0a20 2020 2020 2020 2065 7863 6570  t..        excep
+000171f0: 7469 6f6e 732e 436c 7573 7465 724e 6f74  tions.ClusterNot
+00017200: 5570 4572 726f 723a 2069 6620 7468 6520  UpError: if the 
+00017210: 636c 7573 7465 7220 6973 206e 6f74 2055  cluster is not U
+00017220: 502e 0a20 2020 2020 2020 2065 7863 6570  P..        excep
+00017230: 7469 6f6e 732e 4e6f 7453 7570 706f 7274  tions.NotSupport
+00017240: 6564 4572 726f 723a 2069 6620 7468 6520  edError: if the 
+00017250: 636c 7573 7465 7220 6973 206e 6f74 2062  cluster is not b
+00017260: 6173 6564 206f 6e0a 2020 2020 2020 2020  ased on.        
+00017270: 2020 436c 6f75 6456 6d52 6179 4261 636b    CloudVmRayBack
+00017280: 656e 642e 0a20 2020 2020 2020 2065 7863  end..        exc
+00017290: 6570 7469 6f6e 732e 436c 7573 7465 724f  eptions.ClusterO
+000172a0: 776e 6572 4964 656e 7469 7479 4d69 736d  wnerIdentityMism
+000172b0: 6174 6368 4572 726f 723a 2069 6620 7468  atchError: if th
+000172c0: 6520 6375 7272 656e 7420 7573 6572 2069  e current user i
+000172d0: 730a 2020 2020 2020 2020 2020 6e6f 7420  s.          not 
+000172e0: 7468 6520 7361 6d65 2061 7320 7468 6520  the same as the 
+000172f0: 7573 6572 2077 686f 2063 7265 6174 6564  user who created
+00017300: 2074 6865 2063 6c75 7374 6572 2e0a 2020   the cluster..  
+00017310: 2020 2020 2020 6578 6365 7074 696f 6e73        exceptions
+00017320: 2e43 6c6f 7564 5573 6572 4964 656e 7469  .CloudUserIdenti
+00017330: 7479 4572 726f 723a 2069 6620 7765 2066  tyError: if we f
+00017340: 6169 6c20 746f 2067 6574 2074 6865 2063  ail to get the c
+00017350: 7572 7265 6e74 2075 7365 720a 2020 2020  urrent user.    
+00017360: 2020 2020 2020 6964 656e 7469 7479 2e0a        identity..
+00017370: 2020 2020 2222 220a 2020 2020 7265 636f      """.    reco
+00017380: 7264 203d 2067 6c6f 6261 6c5f 7573 6572  rd = global_user
+00017390: 5f73 7461 7465 2e67 6574 5f63 6c75 7374  _state.get_clust
+000173a0: 6572 5f66 726f 6d5f 6e61 6d65 2863 6c75  er_from_name(clu
+000173b0: 7374 6572 5f6e 616d 6529 0a20 2020 2069  ster_name).    i
+000173c0: 6620 6472 7972 756e 3a0a 2020 2020 2020  f dryrun:.      
+000173d0: 2020 6173 7365 7274 2072 6563 6f72 6420    assert record 
+000173e0: 6973 206e 6f74 204e 6f6e 652c 2063 6c75  is not None, clu
+000173f0: 7374 6572 5f6e 616d 650a 2020 2020 2020  ster_name.      
+00017400: 2020 7265 7475 726e 2072 6563 6f72 645b    return record[
+00017410: 2768 616e 646c 6527 5d0a 0a20 2020 2070  'handle']..    p
+00017420: 7265 7669 6f75 735f 636c 7573 7465 725f  revious_cluster_
+00017430: 7374 6174 7573 203d 204e 6f6e 650a 2020  status = None.  
+00017440: 2020 6966 2072 6563 6f72 6420 6973 206e    if record is n
+00017450: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00017460: 2070 7265 7669 6f75 735f 636c 7573 7465   previous_cluste
+00017470: 725f 7374 6174 7573 203d 2072 6563 6f72  r_status = recor
+00017480: 645b 2773 7461 7475 7327 5d0a 0a20 2020  d['status']..   
+00017490: 2074 7279 3a0a 2020 2020 2020 2020 636c   try:.        cl
+000174a0: 7573 7465 725f 7374 6174 7573 2c20 6861  uster_status, ha
+000174b0: 6e64 6c65 203d 2072 6566 7265 7368 5f63  ndle = refresh_c
+000174c0: 6c75 7374 6572 5f73 7461 7475 735f 6861  luster_status_ha
+000174d0: 6e64 6c65 2863 6c75 7374 6572 5f6e 616d  ndle(cluster_nam
+000174e0: 6529 0a20 2020 2065 7863 6570 7420 6578  e).    except ex
+000174f0: 6365 7074 696f 6e73 2e43 6c75 7374 6572  ceptions.Cluster
+00017500: 5374 6174 7573 4665 7463 6869 6e67 4572  StatusFetchingEr
+00017510: 726f 7220 6173 2065 3a0a 2020 2020 2020  ror as e:.      
+00017520: 2020 2320 4661 696c 6564 2074 6f20 7265    # Failed to re
+00017530: 6672 6573 6820 7468 6520 636c 7573 7465  fresh the cluste
+00017540: 7220 7374 6174 7573 2069 7320 6e6f 7420  r status is not 
+00017550: 6661 7461 6c20 6572 726f 7220 6173 2074  fatal error as t
+00017560: 6865 2063 616c 6c65 7273 0a20 2020 2020  he callers.     
+00017570: 2020 2023 2063 616e 2073 7469 6c6c 2062     # can still b
+00017580: 6520 646f 6e65 2062 7920 6f6e 6c79 2075  e done by only u
+00017590: 7369 6e67 2073 7368 2c20 6275 7420 7468  sing ssh, but th
+000175a0: 6520 7373 6820 6361 6e20 6861 6e67 2069  e ssh can hang i
+000175b0: 6620 7468 650a 2020 2020 2020 2020 2320  f the.        # 
+000175c0: 636c 7573 7465 7220 6973 206e 6f74 2075  cluster is not u
+000175d0: 7020 2865 2e67 2e2c 2061 7574 6f73 746f  p (e.g., autosto
+000175e0: 7070 6564 292e 0a0a 2020 2020 2020 2020  pped)...        
+000175f0: 2320 5765 2064 6f20 6e6f 7420 6361 7463  # We do not catc
+00017600: 6820 7468 6520 6578 6365 7074 696f 6e20  h the exception 
+00017610: 666f 7220 636c 6f75 6420 6964 656e 7469  for cloud identi
+00017620: 7479 2063 6865 636b 696e 6720 666f 7220  ty checking for 
+00017630: 6e6f 772c 2069 6e0a 2020 2020 2020 2020  now, in.        
+00017640: 2320 6f72 6465 7220 746f 2064 6973 6162  # order to disab
+00017650: 6c65 2061 6c6c 206f 7065 7261 7469 6f6e  le all operation
+00017660: 7320 6f6e 2063 6c75 7374 6572 7320 6372  s on clusters cr
+00017670: 6561 7465 6420 6279 2061 6e6f 7468 6572  eated by another
+00017680: 2075 7365 720a 2020 2020 2020 2020 2320   user.        # 
+00017690: 6964 656e 7469 7479 2e20 2054 6861 7420  identity.  That 
+000176a0: 7769 6c6c 206d 616b 6520 7468 6520 6465  will make the de
+000176b0: 7369 676e 2073 696d 706c 6572 2061 6e64  sign simpler and
+000176c0: 2065 6173 6965 7220 746f 0a20 2020 2020   easier to.     
+000176d0: 2020 2023 2075 6e64 6572 7374 616e 642c     # understand,
+000176e0: 2062 7574 2069 7420 6d69 6768 7420 6265   but it might be
+000176f0: 2075 7365 6675 6c20 746f 2061 6c6c 6f77   useful to allow
+00017700: 2074 6865 2075 7365 7220 746f 2075 7365   the user to use
+00017710: 0a20 2020 2020 2020 2023 206f 7065 7261  .        # opera
+00017720: 7469 6f6e 7320 7468 6174 206f 6e6c 7920  tions that only 
+00017730: 696e 766f 6c76 6520 7373 6820 2865 2e67  involve ssh (e.g
+00017740: 2e2c 2073 6b79 2065 7865 632c 2073 6b79  ., sky exec, sky
+00017750: 206c 6f67 732c 2065 7463 2920 6576 656e   logs, etc) even
+00017760: 0a20 2020 2020 2020 2023 2069 6620 7468  .        # if th
+00017770: 6520 7573 6572 2069 7320 6e6f 7420 7468  e user is not th
+00017780: 6520 6f77 6e65 7220 6f66 2074 6865 2063  e owner of the c
+00017790: 6c75 7374 6572 2e0a 2020 2020 2020 2020  luster..        
+000177a0: 7578 5f75 7469 6c73 2e63 6f6e 736f 6c65  ux_utils.console
+000177b0: 5f6e 6577 6c69 6e65 2829 0a20 2020 2020  _newline().     
+000177c0: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
+000177d0: 6728 0a20 2020 2020 2020 2020 2020 2066  g(.            f
+000177e0: 2746 6169 6c65 6420 746f 2072 6566 7265  'Failed to refre
+000177f0: 7368 2074 6865 2073 7461 7475 7320 666f  sh the status fo
+00017800: 7220 636c 7573 7465 7220 7b63 6c75 7374  r cluster {clust
+00017810: 6572 5f6e 616d 6521 727d 2e20 4974 2069  er_name!r}. It i
+00017820: 7320 270a 2020 2020 2020 2020 2020 2020  s '.            
+00017830: 6627 6e6f 7420 6661 7461 6c2c 2062 7574  f'not fatal, but
+00017840: 207b 6f70 6572 6174 696f 6e7d 206d 6967   {operation} mig
+00017850: 6874 2068 616e 6720 6966 2074 6865 2063  ht hang if the c
+00017860: 6c75 7374 6572 2069 7320 6e6f 7420 7570  luster is not up
+00017870: 2e5c 6e27 0a20 2020 2020 2020 2020 2020  .\n'.           
+00017880: 2066 2744 6574 6169 6c65 6420 7265 6173   f'Detailed reas
+00017890: 6f6e 3a20 7b65 7d27 290a 2020 2020 2020  on: {e}').      
+000178a0: 2020 6966 2072 6563 6f72 6420 6973 204e    if record is N
+000178b0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+000178c0: 2063 6c75 7374 6572 5f73 7461 7475 732c   cluster_status,
+000178d0: 2068 616e 646c 6520 3d20 4e6f 6e65 2c20   handle = None, 
+000178e0: 4e6f 6e65 0a20 2020 2020 2020 2065 6c73  None.        els
+000178f0: 653a 0a20 2020 2020 2020 2020 2020 2063  e:.            c
+00017900: 6c75 7374 6572 5f73 7461 7475 732c 2068  luster_status, h
+00017910: 616e 646c 6520 3d20 7265 636f 7264 5b27  andle = record['
+00017920: 7374 6174 7573 275d 2c20 7265 636f 7264  status'], record
+00017930: 5b27 6861 6e64 6c65 275d 0a0a 2020 2020  ['handle']..    
+00017940: 6272 6967 6874 203d 2063 6f6c 6f72 616d  bright = coloram
+00017950: 612e 5374 796c 652e 4252 4947 4854 0a20  a.Style.BRIGHT. 
+00017960: 2020 2072 6573 6574 203d 2063 6f6c 6f72     reset = color
+00017970: 616d 612e 5374 796c 652e 5245 5345 545f  ama.Style.RESET_
+00017980: 414c 4c0a 2020 2020 6966 2068 616e 646c  ALL.    if handl
+00017990: 6520 6973 204e 6f6e 653a 0a20 2020 2020  e is None:.     
+000179a0: 2020 2069 6620 7072 6576 696f 7573 5f63     if previous_c
+000179b0: 6c75 7374 6572 5f73 7461 7475 7320 6973  luster_status is
+000179c0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+000179d0: 2020 2065 7272 6f72 5f6d 7367 203d 2066     error_msg = f
+000179e0: 2743 6c75 7374 6572 207b 636c 7573 7465  'Cluster {cluste
+000179f0: 725f 6e61 6d65 2172 7d20 646f 6573 206e  r_name!r} does n
+00017a00: 6f74 2065 7869 7374 2e27 0a20 2020 2020  ot exist.'.     
+00017a10: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00017a20: 2020 2020 2065 7272 6f72 5f6d 7367 203d       error_msg =
+00017a30: 2028 6627 436c 7573 7465 7220 7b63 6c75   (f'Cluster {clu
+00017a40: 7374 6572 5f6e 616d 6521 727d 206e 6f74  ster_name!r} not
+00017a50: 2066 6f75 6e64 206f 6e20 7468 6520 636c   found on the cl
+00017a60: 6f75 6420 270a 2020 2020 2020 2020 2020  oud '.          
+00017a70: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00017a80: 7072 6f76 6964 6572 2e27 290a 2020 2020  provider.').    
+00017a90: 2020 2020 2020 2020 6173 7365 7274 2072          assert r
+00017aa0: 6563 6f72 6420 6973 206e 6f74 204e 6f6e  ecord is not Non
+00017ab0: 652c 2070 7265 7669 6f75 735f 636c 7573  e, previous_clus
+00017ac0: 7465 725f 7374 6174 7573 0a20 2020 2020  ter_status.     
+00017ad0: 2020 2020 2020 2061 6374 696f 6e73 203d         actions =
+00017ae0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+00017af0: 6966 2072 6563 6f72 645b 2768 616e 646c  if record['handl
+00017b00: 6527 5d2e 6c61 756e 6368 6564 5f72 6573  e'].launched_res
+00017b10: 6f75 7263 6573 2e75 7365 5f73 706f 743a  ources.use_spot:
+00017b20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017b30: 2061 6374 696f 6e73 2e61 7070 656e 6428   actions.append(
+00017b40: 2770 7265 656d 7074 6564 2729 0a20 2020  'preempted').   
+00017b50: 2020 2020 2020 2020 2069 6620 7265 636f           if reco
+00017b60: 7264 5b27 6175 746f 7374 6f70 275d 203e  rd['autostop'] >
+00017b70: 2030 2061 6e64 2072 6563 6f72 645b 2774   0 and record['t
+00017b80: 6f5f 646f 776e 275d 3a0a 2020 2020 2020  o_down']:.      
+00017b90: 2020 2020 2020 2020 2020 6163 7469 6f6e            action
+00017ba0: 732e 6170 7065 6e64 2827 6175 746f 646f  s.append('autodo
+00017bb0: 776e 6564 2729 0a20 2020 2020 2020 2020  wned').         
+00017bc0: 2020 2061 6374 696f 6e73 2e61 7070 656e     actions.appen
+00017bd0: 6428 276d 616e 7561 6c6c 7920 7465 726d  d('manually term
+00017be0: 696e 6174 6564 2069 6e20 636f 6e73 6f6c  inated in consol
+00017bf0: 6527 290a 2020 2020 2020 2020 2020 2020  e').            
+00017c00: 6966 206c 656e 2861 6374 696f 6e73 2920  if len(actions) 
+00017c10: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
+00017c20: 2020 2020 2061 6374 696f 6e73 5b2d 315d       actions[-1]
+00017c30: 203d 2027 6f72 2027 202b 2061 6374 696f   = 'or ' + actio
+00017c40: 6e73 5b2d 315d 0a20 2020 2020 2020 2020  ns[-1].         
+00017c50: 2020 2061 6374 696f 6e73 5f73 7472 203d     actions_str =
+00017c60: 2027 2c20 272e 6a6f 696e 2861 6374 696f   ', '.join(actio
+00017c70: 6e73 290a 2020 2020 2020 2020 2020 2020  ns).            
+00017c80: 6d65 7373 6167 6520 3d20 6627 2049 7420  message = f' It 
+00017c90: 7761 7320 6c69 6b65 6c79 207b 6163 7469  was likely {acti
+00017ca0: 6f6e 735f 7374 727d 2e27 0a20 2020 2020  ons_str}.'.     
+00017cb0: 2020 2020 2020 2069 6620 6c65 6e28 6163         if len(ac
+00017cc0: 7469 6f6e 7329 203e 2031 3a0a 2020 2020  tions) > 1:.    
+00017cd0: 2020 2020 2020 2020 2020 2020 6d65 7373              mess
+00017ce0: 6167 6520 3d20 6d65 7373 6167 652e 7265  age = message.re
+00017cf0: 706c 6163 6528 276c 696b 656c 7927 2c20  place('likely', 
+00017d00: 2765 6974 6865 7227 290a 2020 2020 2020  'either').      
+00017d10: 2020 2020 2020 6572 726f 725f 6d73 6720        error_msg 
+00017d20: 2b3d 206d 6573 7361 6765 0a0a 2020 2020  += message..    
+00017d30: 2020 2020 7769 7468 2075 785f 7574 696c      with ux_util
+00017d40: 732e 7072 696e 745f 6578 6365 7074 696f  s.print_exceptio
+00017d50: 6e5f 6e6f 5f74 7261 6365 6261 636b 2829  n_no_traceback()
+00017d60: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00017d70: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
+00017d80: 277b 636f 6c6f 7261 6d61 2e46 6f72 652e  '{colorama.Fore.
+00017d90: 5945 4c4c 4f57 7d7b 6572 726f 725f 6d73  YELLOW}{error_ms
+00017da0: 677d 7b72 6573 6574 7d27 290a 2020 2020  g}{reset}').    
+00017db0: 6173 7365 7274 2063 6c75 7374 6572 5f73  assert cluster_s
+00017dc0: 7461 7475 7320 6973 206e 6f74 204e 6f6e  tatus is not Non
+00017dd0: 652c 2027 6861 6e64 6c65 2069 7320 6e6f  e, 'handle is no
+00017de0: 7420 4e6f 6e65 2062 7574 2073 7461 7475  t None but statu
+00017df0: 7320 6973 204e 6f6e 6527 0a20 2020 2062  s is None'.    b
+00017e00: 6163 6b65 6e64 203d 2067 6574 5f62 6163  ackend = get_bac
+00017e10: 6b65 6e64 5f66 726f 6d5f 6861 6e64 6c65  kend_from_handle
+00017e20: 2868 616e 646c 6529 0a20 2020 2069 6620  (handle).    if 
+00017e30: 6368 6563 6b5f 636c 6f75 645f 766d 5f72  check_cloud_vm_r
+00017e40: 6179 5f62 6163 6b65 6e64 2061 6e64 206e  ay_backend and n
+00017e50: 6f74 2069 7369 6e73 7461 6e63 6528 0a20  ot isinstance(. 
+00017e60: 2020 2020 2020 2020 2020 2062 6163 6b65             backe
+00017e70: 6e64 2c20 6261 636b 656e 6473 2e43 6c6f  nd, backends.Clo
+00017e80: 7564 566d 5261 7942 6163 6b65 6e64 293a  udVmRayBackend):
+00017e90: 0a20 2020 2020 2020 2077 6974 6820 7578  .        with ux
+00017ea0: 5f75 7469 6c73 2e70 7269 6e74 5f65 7863  _utils.print_exc
+00017eb0: 6570 7469 6f6e 5f6e 6f5f 7472 6163 6562  eption_no_traceb
+00017ec0: 6163 6b28 293a 0a20 2020 2020 2020 2020  ack():.         
+00017ed0: 2020 2072 6169 7365 2065 7863 6570 7469     raise excepti
+00017ee0: 6f6e 732e 4e6f 7453 7570 706f 7274 6564  ons.NotSupported
+00017ef0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+00017f00: 2020 2020 2020 2066 277b 636f 6c6f 7261         f'{colora
+00017f10: 6d61 2e46 6f72 652e 5945 4c4c 4f57 7d7b  ma.Fore.YELLOW}{
+00017f20: 6f70 6572 6174 696f 6e2e 6361 7069 7461  operation.capita
+00017f30: 6c69 7a65 2829 7d3a 2073 6b69 7070 6564  lize()}: skipped
+00017f40: 2066 6f72 2027 0a20 2020 2020 2020 2020   for '.         
+00017f50: 2020 2020 2020 2066 2763 6c75 7374 6572         f'cluster
+00017f60: 207b 636c 7573 7465 725f 6e61 6d65 2172   {cluster_name!r
+00017f70: 7d2e 2049 7420 6973 206f 6e6c 7920 7375  }. It is only su
+00017f80: 7070 6f72 7465 6420 6279 2062 6163 6b65  pported by backe
+00017f90: 6e64 3a20 270a 2020 2020 2020 2020 2020  nd: '.          
+00017fa0: 2020 2020 2020 6627 7b62 6163 6b65 6e64        f'{backend
+00017fb0: 732e 436c 6f75 6456 6d52 6179 4261 636b  s.CloudVmRayBack
+00017fc0: 656e 642e 4e41 4d45 7d2e 270a 2020 2020  end.NAME}.'.    
+00017fd0: 2020 2020 2020 2020 2020 2020 6627 7b72              f'{r
+00017fe0: 6573 6574 7d27 290a 2020 2020 6966 2063  eset}').    if c
+00017ff0: 6c75 7374 6572 5f73 7461 7475 7320 213d  luster_status !=
+00018000: 2073 7461 7475 735f 6c69 622e 436c 7573   status_lib.Clus
+00018010: 7465 7253 7461 7475 732e 5550 3a0a 2020  terStatus.UP:.  
+00018020: 2020 2020 2020 7769 7468 2075 785f 7574        with ux_ut
+00018030: 696c 732e 7072 696e 745f 6578 6365 7074  ils.print_except
+00018040: 696f 6e5f 6e6f 5f74 7261 6365 6261 636b  ion_no_traceback
+00018050: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00018060: 6869 6e74 5f66 6f72 5f69 6e69 7420 3d20  hint_for_init = 
+00018070: 2727 0a20 2020 2020 2020 2020 2020 2069  ''.            i
+00018080: 6620 636c 7573 7465 725f 7374 6174 7573  f cluster_status
+00018090: 203d 3d20 7374 6174 7573 5f6c 6962 2e43   == status_lib.C
+000180a0: 6c75 7374 6572 5374 6174 7573 2e49 4e49  lusterStatus.INI
+000180b0: 543a 0a20 2020 2020 2020 2020 2020 2020  T:.             
+000180c0: 2020 2068 696e 745f 666f 725f 696e 6974     hint_for_init
+000180d0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+000180e0: 2020 2020 2020 2020 2066 277b 7265 7365           f'{rese
+000180f0: 747d 2057 6169 7420 666f 7220 6120 6c61  t} Wait for a la
+00018100: 756e 6368 2074 6f20 6669 6e69 7368 2c20  unch to finish, 
+00018110: 6f72 2075 7365 2074 6869 7320 636f 6d6d  or use this comm
+00018120: 616e 6420 270a 2020 2020 2020 2020 2020  and '.          
+00018130: 2020 2020 2020 2020 2020 6627 746f 2074            f'to t
+00018140: 7279 2074 6f20 7472 616e 7369 7469 6f6e  ry to transition
+00018150: 2074 6865 2063 6c75 7374 6572 2074 6f20   the cluster to 
+00018160: 5550 3a20 7b62 7269 6768 747d 736b 7920  UP: {bright}sky 
+00018170: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00018180: 2020 2020 2020 6627 7374 6172 7420 7b63        f'start {c
+00018190: 6c75 7374 6572 5f6e 616d 657d 7b72 6573  luster_name}{res
+000181a0: 6574 7d27 290a 2020 2020 2020 2020 2020  et}').          
+000181b0: 2020 7261 6973 6520 6578 6365 7074 696f    raise exceptio
+000181c0: 6e73 2e43 6c75 7374 6572 4e6f 7455 7045  ns.ClusterNotUpE
+000181d0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+000181e0: 2020 2020 2020 6627 7b63 6f6c 6f72 616d        f'{coloram
+000181f0: 612e 466f 7265 2e59 454c 4c4f 577d 7b6f  a.Fore.YELLOW}{o
+00018200: 7065 7261 7469 6f6e 2e63 6170 6974 616c  peration.capital
+00018210: 697a 6528 297d 3a20 736b 6970 7065 6420  ize()}: skipped 
+00018220: 666f 7220 270a 2020 2020 2020 2020 2020  for '.          
+00018230: 2020 2020 2020 6627 636c 7573 7465 7220        f'cluster 
+00018240: 7b63 6c75 7374 6572 5f6e 616d 6521 727d  {cluster_name!r}
+00018250: 2028 7374 6174 7573 3a20 7b63 6c75 7374   (status: {clust
+00018260: 6572 5f73 7461 7475 732e 7661 6c75 657d  er_status.value}
+00018270: 292e 2027 0a20 2020 2020 2020 2020 2020  ). '.           
+00018280: 2020 2020 2027 4974 2069 7320 6f6e 6c79       'It is only
+00018290: 2061 6c6c 6f77 6564 2066 6f72 2027 0a20   allowed for '. 
+000182a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000182b0: 277b 7374 6174 7573 5f6c 6962 2e43 6c75  '{status_lib.Clu
+000182c0: 7374 6572 5374 6174 7573 2e55 502e 7661  sterStatus.UP.va
+000182d0: 6c75 657d 2063 6c75 7374 6572 732e 270a  lue} clusters.'.
+000182e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000182f0: 6627 7b68 696e 745f 666f 725f 696e 6974  f'{hint_for_init
+00018300: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
+00018310: 2020 2066 277b 7265 7365 747d 272c 0a20     f'{reset}',. 
+00018320: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00018330: 6c75 7374 6572 5f73 7461 7475 733d 636c  luster_status=cl
+00018340: 7573 7465 725f 7374 6174 7573 2c0a 2020  uster_status,.  
+00018350: 2020 2020 2020 2020 2020 2020 2020 6861                ha
+00018360: 6e64 6c65 3d68 616e 646c 6529 0a0a 2020  ndle=handle)..  
+00018370: 2020 6966 2068 616e 646c 652e 6865 6164    if handle.head
+00018380: 5f69 7020 6973 204e 6f6e 653a 0a20 2020  _ip is None:.   
+00018390: 2020 2020 2077 6974 6820 7578 5f75 7469       with ux_uti
+000183a0: 6c73 2e70 7269 6e74 5f65 7863 6570 7469  ls.print_excepti
+000183b0: 6f6e 5f6e 6f5f 7472 6163 6562 6163 6b28  on_no_traceback(
+000183c0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+000183d0: 6169 7365 2065 7863 6570 7469 6f6e 732e  aise exceptions.
+000183e0: 436c 7573 7465 724e 6f74 5570 4572 726f  ClusterNotUpErro
+000183f0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00018400: 2020 2066 2743 6c75 7374 6572 207b 636c     f'Cluster {cl
+00018410: 7573 7465 725f 6e61 6d65 2172 7d20 6861  uster_name!r} ha
+00018420: 7320 6265 656e 2073 746f 7070 6564 206f  s been stopped o
+00018430: 7220 6e6f 7420 7072 6f70 6572 6c79 2027  r not properly '
+00018440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018450: 2027 7365 7420 7570 2e20 506c 6561 7365   'set up. Please
+00018460: 2072 652d 6c61 756e 6368 2069 7420 7769   re-launch it wi
+00018470: 7468 2060 736b 7920 7374 6172 7460 2e27  th `sky start`.'
+00018480: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00018490: 2020 636c 7573 7465 725f 7374 6174 7573    cluster_status
+000184a0: 3d63 6c75 7374 6572 5f73 7461 7475 732c  =cluster_status,
+000184b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000184c0: 2068 616e 646c 653d 6861 6e64 6c65 290a   handle=handle).
+000184d0: 2020 2020 7265 7475 726e 2068 616e 646c      return handl
+000184e0: 650a 0a0a 2320 544f 444f 2874 6961 6e29  e...# TODO(tian)
+000184f0: 3a20 5265 6661 6374 6f72 2074 6f20 636f  : Refactor to co
+00018500: 6e74 726f 6c6c 6572 5f75 7469 6c73 2e20  ntroller_utils. 
+00018510: 4375 7272 656e 7420 626c 6f63 6b65 723a  Current blocker:
+00018520: 2063 6972 6375 6c61 7220 696d 706f 7274   circular import
+00018530: 2e0a 6465 6620 6973 5f63 6f6e 7472 6f6c  ..def is_control
+00018540: 6c65 725f 6163 6365 7373 6962 6c65 280a  ler_accessible(.
+00018550: 2020 2020 636f 6e74 726f 6c6c 6572 5f74      controller_t
+00018560: 7970 653a 2063 6f6e 7472 6f6c 6c65 725f  ype: controller_
+00018570: 7574 696c 732e 436f 6e74 726f 6c6c 6572  utils.Controller
+00018580: 732c 0a20 2020 2073 746f 7070 6564 5f6d  s,.    stopped_m
+00018590: 6573 7361 6765 3a20 7374 722c 0a20 2020  essage: str,.   
+000185a0: 206e 6f6e 5f65 7869 7374 656e 745f 6d65   non_existent_me
+000185b0: 7373 6167 653a 204f 7074 696f 6e61 6c5b  ssage: Optional[
+000185c0: 7374 725d 203d 204e 6f6e 652c 0a20 2020  str] = None,.   
+000185d0: 2065 7869 745f 6966 5f6e 6f74 5f61 6363   exit_if_not_acc
+000185e0: 6573 7369 626c 653a 2062 6f6f 6c20 3d20  essible: bool = 
+000185f0: 4661 6c73 652c 0a29 202d 3e20 2762 6163  False,.) -> 'bac
+00018600: 6b65 6e64 732e 436c 6f75 6456 6d52 6179  kends.CloudVmRay
+00018610: 5265 736f 7572 6365 4861 6e64 6c65 273a  ResourceHandle':
+00018620: 0a20 2020 2022 2222 4368 6563 6b20 6966  .    """Check if
+00018630: 2074 6865 2073 706f 742f 7365 7276 6520   the spot/serve 
+00018640: 636f 6e74 726f 6c6c 6572 2069 7320 7570  controller is up
+00018650: 2e0a 0a20 2020 2054 6865 2063 6f6e 7472  ...    The contr
+00018660: 6f6c 6c65 7220 6973 2061 6363 6573 7369  oller is accessi
+00018670: 626c 6520 7768 656e 2069 7420 6973 2069  ble when it is i
+00018680: 6e20 5550 206f 7220 494e 4954 2073 7461  n UP or INIT sta
+00018690: 7465 2c20 616e 6420 7468 6520 7373 680a  te, and the ssh.
+000186a0: 2020 2020 636f 6e6e 6563 7469 6f6e 2069      connection i
+000186b0: 7320 7375 6363 6573 7366 756c 2e0a 0a20  s successful... 
+000186c0: 2020 2049 7420 6361 6e20 6265 2075 7365     It can be use
+000186d0: 6420 746f 2063 6865 636b 2069 6620 7468  d to check if th
+000186e0: 6520 636f 6e74 726f 6c6c 6572 2069 7320  e controller is 
+000186f0: 6163 6365 7373 6962 6c65 2028 7369 6e63  accessible (sinc
+00018700: 6520 7468 6520 6175 746f 7374 6f70 0a20  e the autostop. 
+00018710: 2020 2069 7320 7365 7420 666f 7220 7468     is set for th
+00018720: 6520 636f 6e74 726f 6c6c 6572 2920 6265  e controller) be
+00018730: 666f 7265 2074 6865 2073 706f 742f 7365  fore the spot/se
+00018740: 7276 6520 636f 6d6d 616e 6473 2069 6e74  rve commands int
+00018750: 6572 6163 7420 7769 7468 2074 6865 0a20  eract with the. 
+00018760: 2020 2063 6f6e 7472 6f6c 6c65 722e 0a0a     controller...
+00018770: 2020 2020 436c 7573 7465 724e 6f74 5570      ClusterNotUp
+00018780: 4572 726f 7220 7769 6c6c 2062 6520 7261  Error will be ra
+00018790: 6973 6564 2077 6865 6e65 7665 7220 7468  ised whenever th
+000187a0: 6520 636f 6e74 726f 6c6c 6572 2063 616e  e controller can
+000187b0: 6e6f 7420 6265 2061 6363 6573 7365 642e  not be accessed.
+000187c0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+000187d0: 2020 2020 7479 7065 3a20 5479 7065 206f      type: Type o
+000187e0: 6620 7468 6520 636f 6e74 726f 6c6c 6572  f the controller
+000187f0: 2e0a 2020 2020 2020 2020 7374 6f70 7065  ..        stoppe
+00018800: 645f 6d65 7373 6167 653a 204d 6573 7361  d_message: Messa
+00018810: 6765 2074 6f20 7072 696e 7420 6966 2074  ge to print if t
+00018820: 6865 2063 6f6e 7472 6f6c 6c65 7220 6973  he controller is
+00018830: 2053 544f 5050 4544 2e0a 2020 2020 2020   STOPPED..      
+00018840: 2020 6e6f 6e5f 6578 6973 7465 6e74 5f6d    non_existent_m
+00018850: 6573 7361 6765 3a20 4d65 7373 6167 6520  essage: Message 
+00018860: 746f 2073 686f 7720 6966 2074 6865 2063  to show if the c
+00018870: 6f6e 7472 6f6c 6c65 7220 646f 6573 206e  ontroller does n
+00018880: 6f74 2065 7869 7374 2e0a 2020 2020 2020  ot exist..      
+00018890: 2020 6578 6974 5f69 665f 6e6f 745f 6163    exit_if_not_ac
+000188a0: 6365 7373 6962 6c65 3a20 5768 6574 6865  cessible: Whethe
+000188b0: 7220 746f 2065 7869 7420 6469 7265 6374  r to exit direct
+000188c0: 6c79 2069 6620 7468 6520 636f 6e74 726f  ly if the contro
+000188d0: 6c6c 6572 2069 7320 6e6f 740a 2020 2020  ller is not.    
+000188e0: 2020 2020 2020 6163 6365 7373 6962 6c65        accessible
+000188f0: 2e20 4966 2046 616c 7365 2c20 7468 6520  . If False, the 
+00018900: 6675 6e63 7469 6f6e 2077 696c 6c20 7261  function will ra
+00018910: 6973 6520 436c 7573 7465 724e 6f74 5570  ise ClusterNotUp
+00018920: 4572 726f 722e 0a0a 2020 2020 5265 7475  Error...    Retu
+00018930: 726e 733a 0a20 2020 2020 2020 2068 616e  rns:.        han
+00018940: 646c 653a 2054 6865 2052 6573 6f75 7263  dle: The Resourc
+00018950: 6548 616e 646c 6520 6f66 2074 6865 2063  eHandle of the c
+00018960: 6f6e 7472 6f6c 6c65 722e 0a0a 2020 2020  ontroller...    
+00018970: 5261 6973 6573 3a0a 2020 2020 2020 2020  Raises:.        
+00018980: 6578 6365 7074 696f 6e73 2e43 6c75 7374  exceptions.Clust
+00018990: 6572 4f77 6e65 7249 6465 6e74 6974 794d  erOwnerIdentityM
+000189a0: 6973 6d61 7463 6845 7272 6f72 3a20 6966  ismatchError: if
+000189b0: 2074 6865 2063 7572 7265 6e74 2075 7365   the current use
+000189c0: 7220 6973 206e 6f74 0a20 2020 2020 2020  r is not.       
+000189d0: 2020 2074 6865 2073 616d 6520 6173 2074     the same as t
+000189e0: 6865 2075 7365 7220 7768 6f20 6372 6561  he user who crea
+000189f0: 7465 6420 7468 6520 636c 7573 7465 722e  ted the cluster.
+00018a00: 0a20 2020 2020 2020 2065 7863 6570 7469  .        excepti
+00018a10: 6f6e 732e 436c 6f75 6455 7365 7249 6465  ons.CloudUserIde
+00018a20: 6e74 6974 7945 7272 6f72 3a20 6966 2077  ntityError: if w
+00018a30: 6520 6661 696c 2074 6f20 6765 7420 7468  e fail to get th
+00018a40: 6520 6375 7272 656e 7420 7573 6572 0a20  e current user. 
+00018a50: 2020 2020 2020 2020 2069 6465 6e74 6974           identit
+00018a60: 792e 0a20 2020 2020 2020 2065 7863 6570  y..        excep
+00018a70: 7469 6f6e 732e 436c 7573 7465 724e 6f74  tions.ClusterNot
+00018a80: 5570 4572 726f 723a 2069 6620 7468 6520  UpError: if the 
+00018a90: 636f 6e74 726f 6c6c 6572 2069 7320 6e6f  controller is no
+00018aa0: 7420 6163 6365 7373 6962 6c65 2c20 6f72  t accessible, or
+00018ab0: 0a20 2020 2020 2020 2020 2066 6169 6c65  .          faile
+00018ac0: 6420 746f 2062 6520 636f 6e6e 6563 7465  d to be connecte
+00018ad0: 642e 0a20 2020 2022 2222 0a20 2020 2069  d..    """.    i
+00018ae0: 6620 6e6f 6e5f 6578 6973 7465 6e74 5f6d  f non_existent_m
+00018af0: 6573 7361 6765 2069 7320 4e6f 6e65 3a0a  essage is None:.
+00018b00: 2020 2020 2020 2020 6e6f 6e5f 6578 6973          non_exis
+00018b10: 7465 6e74 5f6d 6573 7361 6765 203d 2028  tent_message = (
+00018b20: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+00018b30: 7472 6f6c 6c65 725f 7479 7065 2e76 616c  troller_type.val
+00018b40: 7565 2e64 6566 6175 6c74 5f68 696e 745f  ue.default_hint_
+00018b50: 6966 5f6e 6f6e 5f65 7869 7374 656e 7429  if_non_existent)
+00018b60: 0a20 2020 2063 6c75 7374 6572 5f6e 616d  .    cluster_nam
+00018b70: 6520 3d20 636f 6e74 726f 6c6c 6572 5f74  e = controller_t
+00018b80: 7970 652e 7661 6c75 652e 636c 7573 7465  ype.value.cluste
+00018b90: 725f 6e61 6d65 0a20 2020 2063 6f6e 7472  r_name.    contr
+00018ba0: 6f6c 6c65 725f 6e61 6d65 203d 2063 6f6e  oller_name = con
+00018bb0: 7472 6f6c 6c65 725f 7479 7065 2e76 616c  troller_type.val
+00018bc0: 7565 2e6e 616d 652e 7265 706c 6163 6528  ue.name.replace(
+00018bd0: 2720 636f 6e74 726f 6c6c 6572 272c 2027  ' controller', '
+00018be0: 2729 0a20 2020 206e 6565 645f 636f 6e6e  ').    need_conn
+00018bf0: 6563 7469 6f6e 5f63 6865 636b 203d 2046  ection_check = F
+00018c00: 616c 7365 0a20 2020 2063 6f6e 7472 6f6c  alse.    control
+00018c10: 6c65 725f 7374 6174 7573 2c20 6861 6e64  ler_status, hand
+00018c20: 6c65 203d 204e 6f6e 652c 204e 6f6e 650a  le = None, None.
+00018c30: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00018c40: 2023 2053 6574 2066 6f72 6365 5f72 6566   # Set force_ref
+00018c50: 7265 7368 5f73 7461 7475 7365 733d 5b49  resh_statuses=[I
+00018c60: 4e49 545d 2074 6f20 6d61 6b65 2073 7572  NIT] to make sur
+00018c70: 6520 7468 6520 7265 6672 6573 6820 6861  e the refresh ha
+00018c80: 7070 656e 730a 2020 2020 2020 2020 2320  ppens.        # 
+00018c90: 7768 656e 2074 6865 2063 6f6e 7472 6f6c  when the control
+00018ca0: 6c65 7220 6973 2049 4e49 542f 5550 2028  ler is INIT/UP (
+00018cb0: 7472 6967 6765 7265 6420 696e 2074 6865  triggered in the
+00018cc0: 7365 2073 7461 7475 7365 7320 6173 2074  se statuses as t
+00018cd0: 6865 0a20 2020 2020 2020 2023 2061 7574  he.        # aut
+00018ce0: 6f73 746f 7020 6973 2061 6c77 6179 7320  ostop is always 
+00018cf0: 7365 7420 666f 7220 7468 6520 636f 6e74  set for the cont
+00018d00: 726f 6c6c 6572 292e 2054 6865 2063 6f6e  roller). The con
+00018d10: 7472 6f6c 6c65 7220 6361 6e20 6265 2069  troller can be i
+00018d20: 6e0a 2020 2020 2020 2020 2320 666f 6c6c  n.        # foll
+00018d30: 6f77 696e 6720 6361 7365 733a 0a20 2020  owing cases:.   
+00018d40: 2020 2020 2023 202a 2028 5550 2c20 6175       # * (UP, au
+00018d50: 746f 7374 6f70 2073 6574 293a 2069 7420  tostop set): it 
+00018d60: 7769 6c6c 2062 6520 7265 6672 6573 6865  will be refreshe
+00018d70: 6420 7769 7468 6f75 7420 666f 7263 655f  d without force_
+00018d80: 7265 6672 6573 6820 7365 742e 0a20 2020  refresh set..   
+00018d90: 2020 2020 2023 202a 2028 5550 2c20 6e6f       # * (UP, no
+00018da0: 2061 7574 6f73 746f 7029 3a20 7665 7279   autostop): very
+00018db0: 2072 6172 6520 2861 2075 7365 7220 6374   rare (a user ct
+00018dc0: 726c 2d63 2077 6865 6e20 7468 6520 636f  rl-c when the co
+00018dd0: 6e74 726f 6c6c 6572 2069 730a 2020 2020  ntroller is.    
+00018de0: 2020 2020 2320 2020 6c61 756e 6368 696e      #   launchin
+00018df0: 6729 2c20 646f 6573 206e 6f74 206d 6174  g), does not mat
+00018e00: 7465 7220 6966 2072 6566 7265 7368 206f  ter if refresh o
+00018e10: 7220 6e6f 742c 2073 696e 6365 206e 6f20  r not, since no 
+00018e20: 6175 746f 7374 6f70 2e20 5765 0a20 2020  autostop. We.   
+00018e30: 2020 2020 2023 2020 2064 6f6e 2774 2069       #   don't i
+00018e40: 6e63 6c75 6465 2055 5020 696e 2066 6f72  nclude UP in for
+00018e50: 6365 5f72 6566 7265 7368 5f73 7461 7475  ce_refresh_statu
+00018e60: 7365 7320 746f 2061 766f 6964 206f 7665  ses to avoid ove
+00018e70: 7268 6561 6473 2e0a 2020 2020 2020 2020  rheads..        
+00018e80: 2320 2a20 2849 4e49 542c 2061 7574 6f73  # * (INIT, autos
+00018e90: 746f 7020 7365 7429 0a20 2020 2020 2020  top set).       
+00018ea0: 2023 202a 2028 494e 4954 2c20 6e6f 2061   # * (INIT, no a
+00018eb0: 7574 6f73 746f 7029 3a20 7665 7279 2072  utostop): very r
+00018ec0: 6172 6520 285f 7570 6461 7465 5f63 6c75  are (_update_clu
+00018ed0: 7374 6572 5f73 7461 7475 735f 6e6f 5f6c  ster_status_no_l
+00018ee0: 6f63 6b20 6d61 790a 2020 2020 2020 2020  ock may.        
+00018ef0: 2320 2020 7265 7365 7420 6c6f 6361 6c20  #   reset local 
+00018f00: 6175 746f 7374 6f70 2063 6f6e 6669 6729  autostop config)
+00018f10: 2c20 6275 7420 666f 7263 655f 7265 6672  , but force_refr
+00018f20: 6573 6820 7769 6c6c 206d 616b 6520 7375  esh will make su
+00018f30: 7265 0a20 2020 2020 2020 2023 2020 2073  re.        #   s
+00018f40: 7461 7475 7320 6973 2072 6566 7265 7368  tatus is refresh
+00018f50: 6564 2e0a 2020 2020 2020 2020 230a 2020  ed..        #.  
+00018f60: 2020 2020 2020 2320 5765 2061 766f 6964        # We avoid
+00018f70: 7320 756e 6e65 6365 7373 6172 7920 636f  s unnecessary co
+00018f80: 7374 6c79 2072 6566 7265 7368 2077 6865  stly refresh whe
+00018f90: 6e20 7468 6520 636f 6e74 726f 6c6c 6572  n the controller
+00018fa0: 2069 7320 616c 7265 6164 790a 2020 2020   is already.    
+00018fb0: 2020 2020 2320 5354 4f50 5045 442e 2054      # STOPPED. T
+00018fc0: 6869 7320 6f70 7469 6d69 7a61 7469 6f6e  his optimization
+00018fd0: 2069 7320 6261 7365 6420 6f6e 2074 6865   is based on the
+00018fe0: 2061 7373 756d 7074 696f 6e20 7468 6174   assumption that
+00018ff0: 2074 6865 2075 7365 720a 2020 2020 2020   the user.      
+00019000: 2020 2320 7769 6c6c 206e 6f74 2073 7461    # will not sta
+00019010: 7274 2074 6865 2063 6f6e 7472 6f6c 6c65  rt the controlle
+00019020: 7220 6d61 6e75 616c 6c79 2066 726f 6d20  r manually from 
+00019030: 7468 6520 636c 6f75 6420 636f 6e73 6f6c  the cloud consol
+00019040: 652e 0a20 2020 2020 2020 2023 0a20 2020  e..        #.   
+00019050: 2020 2020 2023 2054 6865 2061 6371 7569       # The acqui
+00019060: 7265 5f6c 6f63 6b5f 7469 6d65 6f75 7420  re_lock_timeout 
+00019070: 6973 2073 6574 2074 6f20 3020 746f 2061  is set to 0 to a
+00019080: 766f 6964 2068 616e 6769 6e67 2074 6865  void hanging the
+00019090: 2063 6f6d 6d61 6e64 2077 6865 6e0a 2020   command when.  
+000190a0: 2020 2020 2020 2320 6d75 6c74 6970 6c65        # multiple
+000190b0: 2073 706f 742e 6c61 756e 6368 2063 6f6d   spot.launch com
+000190c0: 6d61 6e64 7320 6172 6520 7275 6e6e 696e  mands are runnin
+000190d0: 6720 6174 2074 6865 2073 616d 6520 7469  g at the same ti
+000190e0: 6d65 2e20 4f75 7220 6c61 7465 720a 2020  me. Our later.  
+000190f0: 2020 2020 2020 2320 636f 6465 2077 696c        # code wil
+00019100: 6c20 6368 6563 6b20 6966 2074 6865 2063  l check if the c
+00019110: 6f6e 7472 6f6c 6c65 7220 6973 2061 6363  ontroller is acc
+00019120: 6573 7369 626c 6520 6279 2064 6972 6563  essible by direc
+00019130: 746c 7920 6368 6563 6b69 6e67 0a20 2020  tly checking.   
+00019140: 2020 2020 2023 2074 6865 2073 7368 2063       # the ssh c
+00019150: 6f6e 6e65 6374 696f 6e20 746f 2074 6865  onnection to the
+00019160: 2063 6f6e 7472 6f6c 6c65 722c 2069 6620   controller, if 
+00019170: 6974 2066 6169 6c73 2074 6f20 6765 7420  it fails to get 
+00019180: 6163 6375 7261 7465 0a20 2020 2020 2020  accurate.       
+00019190: 2023 2073 7461 7475 7320 6f66 2074 6865   # status of the
+000191a0: 2063 6f6e 7472 6f6c 6c65 722e 0a20 2020   controller..   
+000191b0: 2020 2020 2063 6f6e 7472 6f6c 6c65 725f       controller_
+000191c0: 7374 6174 7573 2c20 6861 6e64 6c65 203d  status, handle =
+000191d0: 2072 6566 7265 7368 5f63 6c75 7374 6572   refresh_cluster
+000191e0: 5f73 7461 7475 735f 6861 6e64 6c65 280a  _status_handle(.
+000191f0: 2020 2020 2020 2020 2020 2020 636c 7573              clus
+00019200: 7465 725f 6e61 6d65 2c0a 2020 2020 2020  ter_name,.      
+00019210: 2020 2020 2020 666f 7263 655f 7265 6672        force_refr
+00019220: 6573 685f 7374 6174 7573 6573 3d5b 7374  esh_statuses=[st
+00019230: 6174 7573 5f6c 6962 2e43 6c75 7374 6572  atus_lib.Cluster
+00019240: 5374 6174 7573 2e49 4e49 545d 2c0a 2020  Status.INIT],.  
+00019250: 2020 2020 2020 2020 2020 636c 7573 7465            cluste
+00019260: 725f 7374 6174 7573 5f6c 6f63 6b5f 7469  r_status_lock_ti
+00019270: 6d65 6f75 743d 3029 0a20 2020 2065 7863  meout=0).    exc
+00019280: 6570 7420 6578 6365 7074 696f 6e73 2e43  ept exceptions.C
+00019290: 6c75 7374 6572 5374 6174 7573 4665 7463  lusterStatusFetc
+000192a0: 6869 6e67 4572 726f 7220 6173 2065 3a0a  hingError as e:.
+000192b0: 2020 2020 2020 2020 2320 5765 2064 6f20          # We do 
+000192c0: 6e6f 7420 6361 7463 6820 7468 6520 6578  not catch the ex
+000192d0: 6365 7074 696f 6e73 2072 656c 6174 6564  ceptions related
+000192e0: 2074 6f20 7468 6520 636c 7573 7465 7220   to the cluster 
+000192f0: 6f77 6e65 7220 6964 656e 7469 7479 0a20  owner identity. 
+00019300: 2020 2020 2020 2023 206d 6973 6d61 7463         # mismatc
+00019310: 682c 2070 6c65 6173 6520 7265 6665 7220  h, please refer 
+00019320: 746f 2074 6865 2063 6f6d 6d65 6e74 2069  to the comment i
+00019330: 6e0a 2020 2020 2020 2020 2320 6062 6163  n.        # `bac
+00019340: 6b65 6e64 5f75 7469 6c73 2e63 6865 636b  kend_utils.check
+00019350: 5f63 6c75 7374 6572 5f61 7661 696c 6162  _cluster_availab
+00019360: 6c65 602e 0a20 2020 2020 2020 206c 6f67  le`..        log
+00019370: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
+00019380: 2020 2020 2020 2020 2027 4661 696c 6564           'Failed
+00019390: 2074 6f20 6765 7420 7468 6520 7374 6174   to get the stat
+000193a0: 7573 206f 6620 7468 6520 636f 6e74 726f  us of the contro
+000193b0: 6c6c 6572 2e20 4974 2069 7320 6e6f 7420  ller. It is not 
+000193c0: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+000193d0: 6661 7461 6c2c 2062 7574 207b 636f 6e74  fatal, but {cont
+000193e0: 726f 6c6c 6572 5f6e 616d 657d 2063 6f6d  roller_name} com
+000193f0: 6d61 6e64 732f 6361 6c6c 7320 6d61 7920  mands/calls may 
+00019400: 6861 6e67 206f 7220 7265 7475 726e 2027  hang or return '
+00019410: 0a20 2020 2020 2020 2020 2020 2027 7374  .            'st
+00019420: 616c 6520 696e 666f 726d 6174 696f 6e2c  ale information,
+00019430: 2077 6865 6e20 7468 6520 636f 6e74 726f   when the contro
+00019440: 6c6c 6572 2069 7320 6e6f 7420 7570 2e5c  ller is not up.\
+00019450: 6e27 0a20 2020 2020 2020 2020 2020 2066  n'.            f
+00019460: 2720 2044 6574 6169 6c73 3a20 7b63 6f6d  '  Details: {com
+00019470: 6d6f 6e5f 7574 696c 732e 666f 726d 6174  mon_utils.format
+00019480: 5f65 7863 6570 7469 6f6e 2865 2c20 7573  _exception(e, us
+00019490: 655f 6272 6163 6b65 743d 5472 7565 297d  e_bracket=True)}
+000194a0: 2729 0a20 2020 2020 2020 2072 6563 6f72  ').        recor
+000194b0: 6420 3d20 676c 6f62 616c 5f75 7365 725f  d = global_user_
+000194c0: 7374 6174 652e 6765 745f 636c 7573 7465  state.get_cluste
+000194d0: 725f 6672 6f6d 5f6e 616d 6528 636c 7573  r_from_name(clus
+000194e0: 7465 725f 6e61 6d65 290a 2020 2020 2020  ter_name).      
+000194f0: 2020 6966 2072 6563 6f72 6420 6973 206e    if record is n
+00019500: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00019510: 2020 2020 2063 6f6e 7472 6f6c 6c65 725f       controller_
+00019520: 7374 6174 7573 2c20 6861 6e64 6c65 203d  status, handle =
+00019530: 2072 6563 6f72 645b 2773 7461 7475 7327   record['status'
+00019540: 5d2c 2072 6563 6f72 645b 2768 616e 646c  ], record['handl
+00019550: 6527 5d0a 2020 2020 2020 2020 2020 2020  e'].            
+00019560: 2320 5765 2063 6865 636b 2074 6865 2063  # We check the c
+00019570: 6f6e 6e65 6374 696f 6e20 6576 656e 2069  onnection even i
+00019580: 6620 7468 6520 636c 7573 7465 7220 6861  f the cluster ha
+00019590: 7320 6120 6361 6368 6564 2073 7461 7475  s a cached statu
+000195a0: 7320 5550 0a20 2020 2020 2020 2020 2020  s UP.           
+000195b0: 2023 2074 6f20 6d61 6b65 2073 7572 6520   # to make sure 
+000195c0: 7468 6520 636f 6e74 726f 6c6c 6572 2069  the controller i
+000195d0: 7320 6163 7475 616c 6c79 2061 6363 6573  s actually acces
+000195e0: 7369 626c 652c 2061 7320 7468 6520 6361  sible, as the ca
+000195f0: 6368 6564 0a20 2020 2020 2020 2020 2020  ched.           
+00019600: 2023 2073 7461 7475 7320 6d69 6768 7420   # status might 
+00019610: 6265 2073 7461 6c65 2e0a 2020 2020 2020  be stale..      
+00019620: 2020 2020 2020 6e65 6564 5f63 6f6e 6e65        need_conne
+00019630: 6374 696f 6e5f 6368 6563 6b20 3d20 5472  ction_check = Tr
+00019640: 7565 0a0a 2020 2020 6572 726f 725f 6d73  ue..    error_ms
+00019650: 6720 3d20 4e6f 6e65 0a20 2020 2069 6620  g = None.    if 
+00019660: 636f 6e74 726f 6c6c 6572 5f73 7461 7475  controller_statu
+00019670: 7320 3d3d 2073 7461 7475 735f 6c69 622e  s == status_lib.
+00019680: 436c 7573 7465 7253 7461 7475 732e 5354  ClusterStatus.ST
+00019690: 4f50 5045 443a 0a20 2020 2020 2020 2065  OPPED:.        e
+000196a0: 7272 6f72 5f6d 7367 203d 2073 746f 7070  rror_msg = stopp
+000196b0: 6564 5f6d 6573 7361 6765 0a20 2020 2065  ed_message.    e
+000196c0: 6c69 6620 636f 6e74 726f 6c6c 6572 5f73  lif controller_s
+000196d0: 7461 7475 7320 6973 204e 6f6e 6520 6f72  tatus is None or
+000196e0: 2068 616e 646c 6520 6973 204e 6f6e 6520   handle is None 
+000196f0: 6f72 2068 616e 646c 652e 6865 6164 5f69  or handle.head_i
+00019700: 7020 6973 204e 6f6e 653a 0a20 2020 2020  p is None:.     
+00019710: 2020 2023 2057 6520 6368 6563 6b20 7468     # We check th
+00019720: 6520 636f 6e74 726f 6c6c 6572 2069 7320  e controller is 
+00019730: 5354 4f50 5045 4420 6265 666f 7265 2074  STOPPED before t
+00019740: 6865 2063 6865 636b 2066 6f72 2068 616e  he check for han
+00019750: 646c 652e 6865 6164 5f69 700a 2020 2020  dle.head_ip.    
+00019760: 2020 2020 2320 4e6f 6e65 2062 6563 6175      # None becau
+00019770: 7365 2077 6865 6e20 7468 6520 636f 6e74  se when the cont
+00019780: 726f 6c6c 6572 2069 7320 5354 4f50 5045  roller is STOPPE
+00019790: 442c 2068 616e 646c 652e 6865 6164 5f69  D, handle.head_i
+000197a0: 7020 6361 6e20 616c 736f 0a20 2020 2020  p can also.     
+000197b0: 2020 2023 2062 6520 4e6f 6e65 2c20 6275     # be None, bu
+000197c0: 7420 7765 206f 6e6c 7920 7761 6e74 2074  t we only want t
+000197d0: 6f20 6361 7463 6820 7468 6520 6361 7365  o catch the case
+000197e0: 2077 6865 6e20 7468 6520 636f 6e74 726f   when the contro
+000197f0: 6c6c 6572 2069 730a 2020 2020 2020 2020  ller is.        
+00019800: 2320 6265 696e 6720 7072 6f76 6973 696f  # being provisio
+00019810: 6e65 6420 6174 2074 6865 2066 6972 7374  ned at the first
+00019820: 2074 696d 6520 616e 6420 6861 7665 206e   time and have n
+00019830: 6f20 6865 6164 5f69 702e 0a20 2020 2020  o head_ip..     
+00019840: 2020 2065 7272 6f72 5f6d 7367 203d 206e     error_msg = n
+00019850: 6f6e 5f65 7869 7374 656e 745f 6d65 7373  on_existent_mess
+00019860: 6167 650a 2020 2020 656c 6966 2028 636f  age.    elif (co
+00019870: 6e74 726f 6c6c 6572 5f73 7461 7475 7320  ntroller_status 
+00019880: 3d3d 2073 7461 7475 735f 6c69 622e 436c  == status_lib.Cl
+00019890: 7573 7465 7253 7461 7475 732e 494e 4954  usterStatus.INIT
+000198a0: 206f 720a 2020 2020 2020 2020 2020 6e65   or.          ne
+000198b0: 6564 5f63 6f6e 6e65 6374 696f 6e5f 6368  ed_connection_ch
+000198c0: 6563 6b29 3a0a 2020 2020 2020 2020 2320  eck):.        # 
+000198d0: 4368 6563 6b20 7373 6820 636f 6e6e 6563  Check ssh connec
+000198e0: 7469 6f6e 2069 6620 2831 2920 636f 6e74  tion if (1) cont
+000198f0: 726f 6c6c 6572 2069 7320 696e 2049 4e49  roller is in INI
+00019900: 5420 7374 6174 652c 206f 7220 2832 2920  T state, or (2) 
+00019910: 7765 2066 6169 6c65 6420 746f 2066 6574  we failed to fet
+00019920: 6368 2074 6865 0a20 2020 2020 2020 2023  ch the.        #
+00019930: 2073 7461 7475 732c 2062 6f74 6820 6f66   status, both of
+00019940: 2077 6869 6368 2063 616e 2068 6170 7065   which can happe
+00019950: 6e20 7768 656e 2063 6f6e 7472 6f6c 6c65  n when controlle
+00019960: 7227 7320 7374 6174 7573 206c 6f63 6b20  r's status lock 
+00019970: 6973 2068 656c 6420 6279 2061 6e6f 7468  is held by anoth
+00019980: 6572 2060 736b 7920 7370 6f74 206c 6175  er `sky spot lau
+00019990: 6e63 6860 206f 720a 2020 2020 2020 2020  nch` or.        
+000199a0: 2320 6073 6b79 2073 6572 7665 2075 7060  # `sky serve up`
+000199b0: 2e20 4966 2077 6520 6861 7665 c2a0 636f  . If we have..co
+000199c0: 6e74 726f 6c6c 6572 2773 2068 6561 645f  ntroller's head_
+000199d0: 6970 2061 7661 696c 6162 6c65 2061 6e64  ip available and
+000199e0: 2069 7420 6973 2073 7368 2d72 6561 6368   it is ssh-reach
+000199f0: 6162 6c65 2c0a 2020 2020 2020 2020 2320  able,.        # 
+00019a00: 7765 2063 616e 2061 6c6c 6f77 2061 6363  we can allow acc
+00019a10: 6573 7320 746f 2074 6865 2063 6f6e 7472  ess to the contr
+00019a20: 6f6c 6c65 722e 0a20 2020 2020 2020 2073  oller..        s
+00019a30: 7368 5f63 7265 6465 6e74 6961 6c73 203d  sh_credentials =
+00019a40: 2073 7368 5f63 7265 6465 6e74 6961 6c5f   ssh_credential_
+00019a50: 6672 6f6d 5f79 616d 6c28 6861 6e64 6c65  from_yaml(handle
+00019a60: 2e63 6c75 7374 6572 5f79 616d 6c2c 0a20  .cluster_yaml,. 
+00019a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019aa0: 2020 6861 6e64 6c65 2e64 6f63 6b65 725f    handle.docker_
+00019ab0: 7573 6572 2c0a 2020 2020 2020 2020 2020  user,.          
+00019ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ae0: 2020 2020 2020 2020 2068 616e 646c 652e           handle.
+00019af0: 7373 685f 7573 6572 290a 0a20 2020 2020  ssh_user)..     
+00019b00: 2020 2072 756e 6e65 7220 3d20 636f 6d6d     runner = comm
+00019b10: 616e 645f 7275 6e6e 6572 2e53 5348 436f  and_runner.SSHCo
+00019b20: 6d6d 616e 6452 756e 6e65 7228 6861 6e64  mmandRunner(hand
+00019b30: 6c65 2e68 6561 645f 6970 2c0a 2020 2020  le.head_ip,.    
+00019b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b60: 2020 2020 2020 2020 2020 2020 202a 2a73               **s
+00019b70: 7368 5f63 7265 6465 6e74 6961 6c73 2c0a  sh_credentials,.
+00019b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019bb0: 2070 6f72 743d 6861 6e64 6c65 2e68 6561   port=handle.hea
+00019bc0: 645f 7373 685f 706f 7274 290a 2020 2020  d_ssh_port).    
+00019bd0: 2020 2020 6966 206e 6f74 2072 756e 6e65      if not runne
+00019be0: 722e 6368 6563 6b5f 636f 6e6e 6563 7469  r.check_connecti
+00019bf0: 6f6e 2829 3a0a 2020 2020 2020 2020 2020  on():.          
+00019c00: 2020 6572 726f 725f 6d73 6720 3d20 636f    error_msg = co
+00019c10: 6e74 726f 6c6c 6572 5f74 7970 652e 7661  ntroller_type.va
+00019c20: 6c75 652e 636f 6e6e 6563 7469 6f6e 5f65  lue.connection_e
+00019c30: 7272 6f72 5f68 696e 740a 2020 2020 656c  rror_hint.    el
+00019c40: 7365 3a0a 2020 2020 2020 2020 6173 7365  se:.        asse
+00019c50: 7274 2063 6f6e 7472 6f6c 6c65 725f 7374  rt controller_st
+00019c60: 6174 7573 203d 3d20 7374 6174 7573 5f6c  atus == status_l
+00019c70: 6962 2e43 6c75 7374 6572 5374 6174 7573  ib.ClusterStatus
+00019c80: 2e55 502c 2068 616e 646c 650a 0a20 2020  .UP, handle..   
+00019c90: 2069 6620 6572 726f 725f 6d73 6720 6973   if error_msg is
+00019ca0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00019cb0: 2020 2069 6620 6578 6974 5f69 665f 6e6f     if exit_if_no
+00019cc0: 745f 6163 6365 7373 6962 6c65 3a0a 2020  t_accessible:.  
+00019cd0: 2020 2020 2020 2020 2020 736b 795f 6c6f            sky_lo
+00019ce0: 6767 696e 672e 7072 696e 7428 6572 726f  gging.print(erro
+00019cf0: 725f 6d73 6729 0a20 2020 2020 2020 2020  r_msg).         
+00019d00: 2020 2073 7973 2e65 7869 7428 3129 0a20     sys.exit(1). 
+00019d10: 2020 2020 2020 2077 6974 6820 7578 5f75         with ux_u
+00019d20: 7469 6c73 2e70 7269 6e74 5f65 7863 6570  tils.print_excep
+00019d30: 7469 6f6e 5f6e 6f5f 7472 6163 6562 6163  tion_no_tracebac
+00019d40: 6b28 293a 0a20 2020 2020 2020 2020 2020  k():.           
+00019d50: 2072 6169 7365 2065 7863 6570 7469 6f6e   raise exception
+00019d60: 732e 436c 7573 7465 724e 6f74 5570 4572  s.ClusterNotUpEr
+00019d70: 726f 7228 6572 726f 725f 6d73 672c 0a20  ror(error_msg,. 
+00019d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019da0: 2020 2020 2020 2020 2020 2020 2020 636c                cl
+00019db0: 7573 7465 725f 7374 6174 7573 3d63 6f6e  uster_status=con
+00019dc0: 7472 6f6c 6c65 725f 7374 6174 7573 2c0a  troller_status,.
+00019dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019df0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+00019e00: 616e 646c 653d 6861 6e64 6c65 290a 2020  andle=handle).  
+00019e10: 2020 6173 7365 7274 2068 616e 646c 6520    assert handle 
+00019e20: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+00019e30: 6861 6e64 6c65 2e68 6561 645f 6970 2069  handle.head_ip i
+00019e40: 7320 6e6f 7420 4e6f 6e65 2c20 280a 2020  s not None, (.  
+00019e50: 2020 2020 2020 6861 6e64 6c65 2c20 636f        handle, co
+00019e60: 6e74 726f 6c6c 6572 5f73 7461 7475 7329  ntroller_status)
+00019e70: 0a20 2020 2072 6574 7572 6e20 6861 6e64  .    return hand
+00019e80: 6c65 0a0a 0a63 6c61 7373 2043 6c6f 7564  le...class Cloud
+00019e90: 4669 6c74 6572 2865 6e75 6d2e 456e 756d  Filter(enum.Enum
+00019ea0: 293a 0a20 2020 2023 2046 696c 7465 7220  ):.    # Filter 
+00019eb0: 666f 7220 616c 6c20 7479 7065 7320 6f66  for all types of
+00019ec0: 2063 6c6f 7564 732e 0a20 2020 2041 4c4c   clouds..    ALL
+00019ed0: 203d 2027 616c 6c27 0a20 2020 2023 2046   = 'all'.    # F
+00019ee0: 696c 7465 7220 666f 7220 536b 7927 7320  ilter for Sky's 
+00019ef0: 6d61 696e 2063 6c6f 7564 7320 2861 7773  main clouds (aws
+00019f00: 2c20 6763 702c 2061 7a75 7265 2c20 646f  , gcp, azure, do
+00019f10: 636b 6572 292e 0a20 2020 2043 4c4f 5544  cker)..    CLOUD
+00019f20: 535f 414e 445f 444f 434b 4552 203d 2027  S_AND_DOCKER = '
+00019f30: 636c 6f75 6473 2d61 6e64 2d64 6f63 6b65  clouds-and-docke
+00019f40: 7227 0a20 2020 2023 2046 696c 7465 7220  r'.    # Filter 
+00019f50: 666f 7220 6f6e 6c79 206c 6f63 616c 2063  for only local c
+00019f60: 6c6f 7564 732e 0a20 2020 204c 4f43 414c  louds..    LOCAL
+00019f70: 203d 2027 6c6f 6361 6c27 0a0a 0a64 6566   = 'local'...def
+00019f80: 2067 6574 5f63 6c75 7374 6572 7328 0a20   get_clusters(. 
+00019f90: 2020 2069 6e63 6c75 6465 5f63 6f6e 7472     include_contr
+00019fa0: 6f6c 6c65 723a 2062 6f6f 6c2c 0a20 2020  oller: bool,.   
+00019fb0: 2072 6566 7265 7368 3a20 626f 6f6c 2c0a   refresh: bool,.
+00019fc0: 2020 2020 636c 7573 7465 725f 6e61 6d65      cluster_name
+00019fd0: 733a 204f 7074 696f 6e61 6c5b 556e 696f  s: Optional[Unio
+00019fe0: 6e5b 7374 722c 204c 6973 745b 7374 725d  n[str, List[str]
+00019ff0: 5d5d 203d 204e 6f6e 652c 0a29 202d 3e20  ]] = None,.) -> 
+0001a000: 4c69 7374 5b44 6963 745b 7374 722c 2041  List[Dict[str, A
+0001a010: 6e79 5d5d 3a0a 2020 2020 2222 2252 6574  ny]]:.    """Ret
+0001a020: 7572 6e73 2061 206c 6973 7420 6f66 2063  urns a list of c
+0001a030: 6163 6865 6420 6f72 206f 7074 696f 6e61  ached or optiona
+0001a040: 6c6c 7920 7265 6672 6573 6865 6420 636c  lly refreshed cl
+0001a050: 7573 7465 7220 7265 636f 7264 732e 0a0a  uster records...
+0001a060: 2020 2020 436f 6d62 7320 7468 726f 7567      Combs throug
+0001a070: 6820 7468 6520 6461 7461 6261 7365 2028  h the database (
+0001a080: 696e 207e 2f2e 736b 792f 7374 6174 652e  in ~/.sky/state.
+0001a090: 6462 2920 746f 2067 6574 2061 206c 6973  db) to get a lis
+0001a0a0: 7420 6f66 2072 6563 6f72 6473 0a20 2020  t of records.   
+0001a0b0: 2063 6f72 7265 7370 6f6e 6469 6e67 2074   corresponding t
+0001a0c0: 6f20 6c61 756e 6368 6564 2063 6c75 7374  o launched clust
+0001a0d0: 6572 7320 2866 696c 7465 7265 6420 6279  ers (filtered by
+0001a0e0: 2060 636c 7573 7465 725f 6e61 6d65 7360   `cluster_names`
+0001a0f0: 2069 6620 6974 2069 730a 2020 2020 7370   if it is.    sp
+0001a100: 6563 6966 6965 6429 2e20 5468 6520 7265  ecified). The re
+0001a110: 6672 6573 6820 666c 6167 2063 616e 2062  fresh flag can b
+0001a120: 6520 7573 6564 2074 6f20 666f 7263 6520  e used to force 
+0001a130: 6120 7265 6672 6573 6820 6f66 2074 6865  a refresh of the
+0001a140: 2073 7461 7475 730a 2020 2020 6f66 2074   status.    of t
+0001a150: 6865 2063 6c75 7374 6572 732e 0a0a 2020  he clusters...  
+0001a160: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+0001a170: 696e 636c 7564 655f 636f 6e74 726f 6c6c  include_controll
+0001a180: 6572 3a20 5768 6574 6865 7220 746f 2069  er: Whether to i
+0001a190: 6e63 6c75 6465 2063 6f6e 7472 6f6c 6c65  nclude controlle
+0001a1a0: 7273 2c20 652e 672e 2073 706f 7420 636f  rs, e.g. spot co
+0001a1b0: 6e74 726f 6c6c 6572 0a20 2020 2020 2020  ntroller.       
+0001a1c0: 2020 2020 206f 7220 736b 7920 7365 7276       or sky serv
+0001a1d0: 6520 636f 6e74 726f 6c6c 6572 2e0a 2020  e controller..  
+0001a1e0: 2020 2020 2020 7265 6672 6573 683a 2057        refresh: W
+0001a1f0: 6865 7468 6572 2074 6f20 7265 6672 6573  hether to refres
+0001a200: 6820 7468 6520 7374 6174 7573 206f 6620  h the status of 
+0001a210: 7468 6520 636c 7573 7465 7273 2e20 2852  the clusters. (R
+0001a220: 6566 7265 7368 696e 6720 7769 6c6c 0a20  efreshing will. 
+0001a230: 2020 2020 2020 2020 2020 2073 6574 2074             set t
+0001a240: 6865 2073 7461 7475 7320 746f 2053 544f  he status to STO
+0001a250: 5050 4544 2069 6620 7468 6520 636c 7573  PPED if the clus
+0001a260: 7465 7220 6361 6e6e 6f74 2062 6520 7069  ter cannot be pi
+0001a270: 6e67 6564 2e29 0a20 2020 2020 2020 2063  nged.).        c
+0001a280: 6c6f 7564 5f66 696c 7465 723a 2053 6574  loud_filter: Set
+0001a290: 7320 7768 6963 6820 636c 6f75 6473 2074  s which clouds t
+0001a2a0: 6f20 6669 6c65 7220 7468 726f 7567 6820  o filer through 
+0001a2b0: 6672 6f6d 2074 6865 2067 6c6f 6261 6c20  from the global 
+0001a2c0: 7573 6572 0a20 2020 2020 2020 2020 2020  user.           
+0001a2d0: 2073 7461 7465 2e20 5375 7070 6f72 7473   state. Supports
+0001a2e0: 2074 6872 6565 2076 616c 7565 732c 2027   three values, '
+0001a2f0: 616c 6c27 2066 6f72 2061 6c6c 2063 6c6f  all' for all clo
+0001a300: 7564 732c 2027 7075 626c 6963 2720 666f  uds, 'public' fo
+0001a310: 720a 2020 2020 2020 2020 2020 2020 7075  r.            pu
+0001a320: 626c 6963 2063 6c6f 7564 7320 6f6e 6c79  blic clouds only
+0001a330: 2c20 616e 6420 276c 6f63 616c 2720 666f  , and 'local' fo
+0001a340: 7220 6f6e 6c79 206c 6f63 616c 2063 6c6f  r only local clo
+0001a350: 7564 732e 0a20 2020 2020 2020 2063 6c75  uds..        clu
+0001a360: 7374 6572 5f6e 616d 6573 3a20 4966 2070  ster_names: If p
+0001a370: 726f 7669 6465 642c 206f 6e6c 7920 7265  rovided, only re
+0001a380: 7475 726e 2072 6563 6f72 6473 2066 6f72  turn records for
+0001a390: 2074 6865 2067 6976 656e 2063 6c75 7374   the given clust
+0001a3a0: 6572 0a20 2020 2020 2020 2020 2020 206e  er.            n
+0001a3b0: 616d 6573 2e0a 0a20 2020 2052 6574 7572  ames...    Retur
+0001a3c0: 6e73 3a0a 2020 2020 2020 2020 4120 6c69  ns:.        A li
+0001a3d0: 7374 206f 6620 636c 7573 7465 7220 7265  st of cluster re
+0001a3e0: 636f 7264 732e 2049 6620 7468 6520 636c  cords. If the cl
+0001a3f0: 7573 7465 7220 646f 6573 206e 6f74 2065  uster does not e
+0001a400: 7869 7374 206f 7220 6861 7320 6265 656e  xist or has been
+0001a410: 0a20 2020 2020 2020 2074 6572 6d69 6e61  .        termina
+0001a420: 7465 642c 2074 6865 2072 6563 6f72 6420  ted, the record 
+0001a430: 7769 6c6c 2062 6520 6f6d 6974 7465 6420  will be omitted 
+0001a440: 6672 6f6d 2074 6865 2072 6574 7572 6e65  from the returne
+0001a450: 6420 6c69 7374 2e0a 2020 2020 2222 220a  d list..    """.
+0001a460: 2020 2020 7265 636f 7264 7320 3d20 676c      records = gl
+0001a470: 6f62 616c 5f75 7365 725f 7374 6174 652e  obal_user_state.
+0001a480: 6765 745f 636c 7573 7465 7273 2829 0a0a  get_clusters()..
+0001a490: 2020 2020 6966 206e 6f74 2069 6e63 6c75      if not inclu
+0001a4a0: 6465 5f63 6f6e 7472 6f6c 6c65 723a 0a20  de_controller:. 
+0001a4b0: 2020 2020 2020 2072 6563 6f72 6473 203d         records =
+0001a4c0: 205b 0a20 2020 2020 2020 2020 2020 2072   [.            r
+0001a4d0: 6563 6f72 6420 666f 7220 7265 636f 7264  ecord for record
+0001a4e0: 2069 6e20 7265 636f 7264 730a 2020 2020   in records.    
+0001a4f0: 2020 2020 2020 2020 6966 2063 6f6e 7472          if contr
+0001a500: 6f6c 6c65 725f 7574 696c 732e 436f 6e74  oller_utils.Cont
+0001a510: 726f 6c6c 6572 732e 6672 6f6d 5f6e 616d  rollers.from_nam
+0001a520: 6528 7265 636f 7264 5b27 6e61 6d65 275d  e(record['name']
+0001a530: 2920 6973 204e 6f6e 650a 2020 2020 2020  ) is None.      
+0001a540: 2020 5d0a 0a20 2020 2079 656c 6c6f 7720    ]..    yellow 
+0001a550: 3d20 636f 6c6f 7261 6d61 2e46 6f72 652e  = colorama.Fore.
+0001a560: 5945 4c4c 4f57 0a20 2020 2062 7269 6768  YELLOW.    brigh
+0001a570: 7420 3d20 636f 6c6f 7261 6d61 2e53 7479  t = colorama.Sty
+0001a580: 6c65 2e42 5249 4748 540a 2020 2020 7265  le.BRIGHT.    re
+0001a590: 7365 7420 3d20 636f 6c6f 7261 6d61 2e53  set = colorama.S
+0001a5a0: 7479 6c65 2e52 4553 4554 5f41 4c4c 0a0a  tyle.RESET_ALL..
+0001a5b0: 2020 2020 6966 2063 6c75 7374 6572 5f6e      if cluster_n
+0001a5c0: 616d 6573 2069 7320 6e6f 7420 4e6f 6e65  ames is not None
+0001a5d0: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
+0001a5e0: 6e73 7461 6e63 6528 636c 7573 7465 725f  nstance(cluster_
+0001a5f0: 6e61 6d65 732c 2073 7472 293a 0a20 2020  names, str):.   
+0001a600: 2020 2020 2020 2020 2063 6c75 7374 6572           cluster
+0001a610: 5f6e 616d 6573 203d 205b 636c 7573 7465  _names = [cluste
+0001a620: 725f 6e61 6d65 735d 0a20 2020 2020 2020  r_names].       
+0001a630: 206e 6577 5f72 6563 6f72 6473 203d 205b   new_records = [
+0001a640: 5d0a 2020 2020 2020 2020 6e6f 745f 6578  ].        not_ex
+0001a650: 6973 745f 636c 7573 7465 725f 6e61 6d65  ist_cluster_name
+0001a660: 7320 3d20 5b5d 0a20 2020 2020 2020 2066  s = [].        f
+0001a670: 6f72 2063 6c75 7374 6572 5f6e 616d 6520  or cluster_name 
+0001a680: 696e 2063 6c75 7374 6572 5f6e 616d 6573  in cluster_names
+0001a690: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
+0001a6a0: 7220 7265 636f 7264 2069 6e20 7265 636f  r record in reco
+0001a6b0: 7264 733a 0a20 2020 2020 2020 2020 2020  rds:.           
+0001a6c0: 2020 2020 2069 6620 7265 636f 7264 5b27       if record['
+0001a6d0: 6e61 6d65 275d 203d 3d20 636c 7573 7465  name'] == cluste
+0001a6e0: 725f 6e61 6d65 3a0a 2020 2020 2020 2020  r_name:.        
+0001a6f0: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
+0001a700: 7265 636f 7264 732e 6170 7065 6e64 2872  records.append(r
+0001a710: 6563 6f72 6429 0a20 2020 2020 2020 2020  ecord).         
+0001a720: 2020 2020 2020 2020 2020 2062 7265 616b             break
+0001a730: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0001a740: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001a750: 2020 206e 6f74 5f65 7869 7374 5f63 6c75     not_exist_clu
+0001a760: 7374 6572 5f6e 616d 6573 2e61 7070 656e  ster_names.appen
+0001a770: 6428 636c 7573 7465 725f 6e61 6d65 290a  d(cluster_name).
+0001a780: 2020 2020 2020 2020 6966 206e 6f74 5f65          if not_e
+0001a790: 7869 7374 5f63 6c75 7374 6572 5f6e 616d  xist_cluster_nam
+0001a7a0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+0001a7b0: 636c 7573 7465 7273 5f73 7472 203d 2027  clusters_str = '
+0001a7c0: 2c20 272e 6a6f 696e 286e 6f74 5f65 7869  , '.join(not_exi
+0001a7d0: 7374 5f63 6c75 7374 6572 5f6e 616d 6573  st_cluster_names
+0001a7e0: 290a 2020 2020 2020 2020 2020 2020 6c6f  ).            lo
+0001a7f0: 6767 6572 2e69 6e66 6f28 6627 436c 7573  gger.info(f'Clus
+0001a800: 7465 7228 7329 206e 6f74 2066 6f75 6e64  ter(s) not found
+0001a810: 3a20 7b62 7269 6768 747d 7b63 6c75 7374  : {bright}{clust
+0001a820: 6572 735f 7374 727d 7b72 6573 6574 7d2e  ers_str}{reset}.
+0001a830: 2729 0a20 2020 2020 2020 2072 6563 6f72  ').        recor
+0001a840: 6473 203d 206e 6577 5f72 6563 6f72 6473  ds = new_records
+0001a850: 0a0a 2020 2020 6966 206e 6f74 2072 6566  ..    if not ref
+0001a860: 7265 7368 3a0a 2020 2020 2020 2020 7265  resh:.        re
+0001a870: 7475 726e 2072 6563 6f72 6473 0a0a 2020  turn records..  
+0001a880: 2020 706c 7572 616c 203d 2027 7327 2069    plural = 's' i
+0001a890: 6620 6c65 6e28 7265 636f 7264 7329 203e  f len(records) >
+0001a8a0: 2031 2065 6c73 6520 2727 0a20 2020 2070   1 else ''.    p
+0001a8b0: 726f 6772 6573 7320 3d20 7269 6368 5f70  rogress = rich_p
+0001a8c0: 726f 6772 6573 732e 5072 6f67 7265 7373  rogress.Progress
+0001a8d0: 2874 7261 6e73 6965 6e74 3d54 7275 652c  (transient=True,
+0001a8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a900: 2020 2020 2020 2072 6564 6972 6563 745f         redirect_
+0001a910: 7374 646f 7574 3d46 616c 7365 2c0a 2020  stdout=False,.  
+0001a920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a940: 2020 2020 7265 6469 7265 6374 5f73 7464      redirect_std
+0001a950: 6572 723d 4661 6c73 6529 0a20 2020 2074  err=False).    t
+0001a960: 6173 6b20 3d20 7072 6f67 7265 7373 2e61  ask = progress.a
+0001a970: 6464 5f74 6173 6b28 0a20 2020 2020 2020  dd_task(.       
+0001a980: 2066 275b 626f 6c64 2063 7961 6e5d 5265   f'[bold cyan]Re
+0001a990: 6672 6573 6869 6e67 2073 7461 7475 7320  freshing status 
+0001a9a0: 666f 7220 7b6c 656e 2872 6563 6f72 6473  for {len(records
+0001a9b0: 297d 2063 6c75 7374 6572 7b70 6c75 7261  )} cluster{plura
+0001a9c0: 6c7d 5b2f 5d27 2c0a 2020 2020 2020 2020  l}[/]',.        
+0001a9d0: 746f 7461 6c3d 6c65 6e28 7265 636f 7264  total=len(record
+0001a9e0: 7329 290a 0a20 2020 2064 6566 205f 7265  s))..    def _re
+0001a9f0: 6672 6573 685f 636c 7573 7465 7228 636c  fresh_cluster(cl
+0001aa00: 7573 7465 725f 6e61 6d65 293a 0a20 2020  uster_name):.   
+0001aa10: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0001aa20: 2020 2020 2020 7265 636f 7264 203d 2072        record = r
+0001aa30: 6566 7265 7368 5f63 6c75 7374 6572 5f72  efresh_cluster_r
+0001aa40: 6563 6f72 6428 0a20 2020 2020 2020 2020  ecord(.         
+0001aa50: 2020 2020 2020 2063 6c75 7374 6572 5f6e         cluster_n
+0001aa60: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
+0001aa70: 2020 2020 2066 6f72 6365 5f72 6566 7265       force_refre
+0001aa80: 7368 5f73 7461 7475 7365 733d 7365 7428  sh_statuses=set(
+0001aa90: 7374 6174 7573 5f6c 6962 2e43 6c75 7374  status_lib.Clust
+0001aaa0: 6572 5374 6174 7573 292c 0a20 2020 2020  erStatus),.     
+0001aab0: 2020 2020 2020 2020 2020 2061 6371 7569             acqui
+0001aac0: 7265 5f70 6572 5f63 6c75 7374 6572 5f73  re_per_cluster_s
+0001aad0: 7461 7475 735f 6c6f 636b 3d54 7275 6529  tatus_lock=True)
+0001aae0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0001aaf0: 2865 7863 6570 7469 6f6e 732e 436c 7573  (exceptions.Clus
+0001ab00: 7465 7253 7461 7475 7346 6574 6368 696e  terStatusFetchin
+0001ab10: 6745 7272 6f72 2c0a 2020 2020 2020 2020  gError,.        
+0001ab20: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
+0001ab30: 6e73 2e43 6c6f 7564 5573 6572 4964 656e  ns.CloudUserIden
+0001ab40: 7469 7479 4572 726f 722c 0a20 2020 2020  tityError,.     
+0001ab50: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0001ab60: 7469 6f6e 732e 436c 7573 7465 724f 776e  tions.ClusterOwn
+0001ab70: 6572 4964 656e 7469 7479 4d69 736d 6174  erIdentityMismat
+0001ab80: 6368 4572 726f 7229 2061 7320 653a 0a20  chError) as e:. 
+0001ab90: 2020 2020 2020 2020 2020 2023 2044 6f20             # Do 
+0001aba0: 6e6f 7420 6661 696c 2074 6865 2065 6e74  not fail the ent
+0001abb0: 6972 6520 7265 6672 6573 6820 7072 6f63  ire refresh proc
+0001abc0: 6573 732e 2054 6865 2063 616c 6c65 7220  ess. The caller 
+0001abd0: 7769 6c6c 0a20 2020 2020 2020 2020 2020  will.           
+0001abe0: 2023 2068 616e 646c 6520 7468 6520 2755   # handle the 'U
+0001abf0: 4e4b 4e4f 574e 2720 7374 6174 7573 2c20  NKNOWN' status, 
+0001ac00: 616e 6420 636f 6c6c 6563 7420 7468 6520  and collect the 
+0001ac10: 6572 726f 7273 2069 6e74 6f0a 2020 2020  errors into.    
+0001ac20: 2020 2020 2020 2020 2320 6120 7461 626c          # a tabl
+0001ac30: 652e 0a20 2020 2020 2020 2020 2020 2072  e..            r
+0001ac40: 6563 6f72 6420 3d20 7b27 7374 6174 7573  ecord = {'status
+0001ac50: 273a 2027 554e 4b4e 4f57 4e27 2c20 2765  ': 'UNKNOWN', 'e
+0001ac60: 7272 6f72 273a 2065 7d0a 2020 2020 2020  rror': e}.      
+0001ac70: 2020 7072 6f67 7265 7373 2e75 7064 6174    progress.updat
+0001ac80: 6528 7461 736b 2c20 6164 7661 6e63 653d  e(task, advance=
+0001ac90: 3129 0a20 2020 2020 2020 2072 6574 7572  1).        retur
+0001aca0: 6e20 7265 636f 7264 0a0a 2020 2020 636c  n record..    cl
+0001acb0: 7573 7465 725f 6e61 6d65 7320 3d20 5b72  uster_names = [r
+0001acc0: 6563 6f72 645b 276e 616d 6527 5d20 666f  ecord['name'] fo
+0001acd0: 7220 7265 636f 7264 2069 6e20 7265 636f  r record in reco
+0001ace0: 7264 735d 0a20 2020 2077 6974 6820 7072  rds].    with pr
+0001acf0: 6f67 7265 7373 3a0a 2020 2020 2020 2020  ogress:.        
+0001ad00: 7570 6461 7465 645f 7265 636f 7264 7320  updated_records 
+0001ad10: 3d20 7375 6270 726f 6365 7373 5f75 7469  = subprocess_uti
+0001ad20: 6c73 2e72 756e 5f69 6e5f 7061 7261 6c6c  ls.run_in_parall
+0001ad30: 656c 280a 2020 2020 2020 2020 2020 2020  el(.            
+0001ad40: 5f72 6566 7265 7368 5f63 6c75 7374 6572  _refresh_cluster
+0001ad50: 2c20 636c 7573 7465 725f 6e61 6d65 7329  , cluster_names)
+0001ad60: 0a0a 2020 2020 2320 5368 6f77 2069 6e66  ..    # Show inf
+0001ad70: 6f72 6d61 7469 6f6e 2066 6f72 2072 656d  ormation for rem
+0001ad80: 6f76 6564 2063 6c75 7374 6572 732e 0a20  oved clusters.. 
+0001ad90: 2020 206b 6570 745f 7265 636f 7264 7320     kept_records 
+0001ada0: 3d20 5b5d 0a20 2020 2061 7574 6f64 6f77  = [].    autodow
+0001adb0: 6e5f 636c 7573 7465 7273 2c20 7265 6d61  n_clusters, rema
+0001adc0: 696e 696e 675f 636c 7573 7465 7273 2c20  ining_clusters, 
+0001add0: 6661 696c 6564 5f63 6c75 7374 6572 7320  failed_clusters 
+0001ade0: 3d20 5b5d 2c20 5b5d 2c20 5b5d 0a20 2020  = [], [], [].   
+0001adf0: 2066 6f72 2069 2c20 7265 636f 7264 2069   for i, record i
+0001ae00: 6e20 656e 756d 6572 6174 6528 7265 636f  n enumerate(reco
+0001ae10: 7264 7329 3a0a 2020 2020 2020 2020 6966  rds):.        if
+0001ae20: 2075 7064 6174 6564 5f72 6563 6f72 6473   updated_records
+0001ae30: 5b69 5d20 6973 204e 6f6e 653a 0a20 2020  [i] is None:.   
+0001ae40: 2020 2020 2020 2020 2069 6620 7265 636f           if reco
+0001ae50: 7264 5b27 746f 5f64 6f77 6e27 5d3a 0a20  rd['to_down']:. 
+0001ae60: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0001ae70: 7574 6f64 6f77 6e5f 636c 7573 7465 7273  utodown_clusters
+0001ae80: 2e61 7070 656e 6428 636c 7573 7465 725f  .append(cluster_
+0001ae90: 6e61 6d65 735b 695d 290a 2020 2020 2020  names[i]).      
+0001aea0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001aeb0: 2020 2020 2020 2020 2020 2020 7265 6d61              rema
+0001aec0: 696e 696e 675f 636c 7573 7465 7273 2e61  ining_clusters.a
+0001aed0: 7070 656e 6428 636c 7573 7465 725f 6e61  ppend(cluster_na
+0001aee0: 6d65 735b 695d 290a 2020 2020 2020 2020  mes[i]).        
+0001aef0: 656c 6966 2075 7064 6174 6564 5f72 6563  elif updated_rec
+0001af00: 6f72 6473 5b69 5d5b 2773 7461 7475 7327  ords[i]['status'
+0001af10: 5d20 3d3d 2027 554e 4b4e 4f57 4e27 3a0a  ] == 'UNKNOWN':.
+0001af20: 2020 2020 2020 2020 2020 2020 6661 696c              fail
+0001af30: 6564 5f63 6c75 7374 6572 732e 6170 7065  ed_clusters.appe
+0001af40: 6e64 280a 2020 2020 2020 2020 2020 2020  nd(.            
+0001af50: 2020 2020 2863 6c75 7374 6572 5f6e 616d      (cluster_nam
+0001af60: 6573 5b69 5d2c 2075 7064 6174 6564 5f72  es[i], updated_r
+0001af70: 6563 6f72 6473 5b69 5d5b 2765 7272 6f72  ecords[i]['error
+0001af80: 275d 2929 0a20 2020 2020 2020 2020 2020  '])).           
+0001af90: 2023 204b 6565 7020 7468 6520 6f72 6967   # Keep the orig
+0001afa0: 696e 616c 2072 6563 6f72 6420 6966 2074  inal record if t
+0001afb0: 6865 2073 7461 7475 7320 6973 2075 6e6b  he status is unk
+0001afc0: 6e6f 776e 2c0a 2020 2020 2020 2020 2020  nown,.          
+0001afd0: 2020 2320 736f 2074 6861 7420 7468 6520    # so that the 
+0001afe0: 7573 6572 2063 616e 2073 7469 6c6c 2073  user can still s
+0001aff0: 6565 2074 6865 2063 6c75 7374 6572 2e0a  ee the cluster..
+0001b000: 2020 2020 2020 2020 2020 2020 6b65 7074              kept
+0001b010: 5f72 6563 6f72 6473 2e61 7070 656e 6428  _records.append(
+0001b020: 7265 636f 7264 290a 2020 2020 2020 2020  record).        
+0001b030: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0001b040: 2020 6b65 7074 5f72 6563 6f72 6473 2e61    kept_records.a
+0001b050: 7070 656e 6428 7570 6461 7465 645f 7265  ppend(updated_re
+0001b060: 636f 7264 735b 695d 290a 0a20 2020 2069  cords[i])..    i
+0001b070: 6620 6175 746f 646f 776e 5f63 6c75 7374  f autodown_clust
+0001b080: 6572 733a 0a20 2020 2020 2020 2070 6c75  ers:.        plu
+0001b090: 7261 6c20 3d20 2773 2720 6966 206c 656e  ral = 's' if len
+0001b0a0: 2861 7574 6f64 6f77 6e5f 636c 7573 7465  (autodown_cluste
+0001b0b0: 7273 2920 3e20 3120 656c 7365 2027 270a  rs) > 1 else ''.
+0001b0c0: 2020 2020 2020 2020 636c 7573 7465 725f          cluster_
+0001b0d0: 7374 7220 3d20 272c 2027 2e6a 6f69 6e28  str = ', '.join(
+0001b0e0: 6175 746f 646f 776e 5f63 6c75 7374 6572  autodown_cluster
+0001b0f0: 7329 0a20 2020 2020 2020 206c 6f67 6765  s).        logge
+0001b100: 722e 696e 666f 2866 2741 7574 6f64 6f77  r.info(f'Autodow
+0001b110: 6e65 6420 636c 7573 7465 727b 706c 7572  ned cluster{plur
+0001b120: 616c 7d3a 2027 0a20 2020 2020 2020 2020  al}: '.         
+0001b130: 2020 2020 2020 2020 2020 2066 277b 6272             f'{br
+0001b140: 6967 6874 7d7b 636c 7573 7465 725f 7374  ight}{cluster_st
+0001b150: 727d 7b72 6573 6574 7d27 290a 2020 2020  r}{reset}').    
+0001b160: 6966 2072 656d 6169 6e69 6e67 5f63 6c75  if remaining_clu
+0001b170: 7374 6572 733a 0a20 2020 2020 2020 2070  sters:.        p
+0001b180: 6c75 7261 6c20 3d20 2773 2720 6966 206c  lural = 's' if l
+0001b190: 656e 2872 656d 6169 6e69 6e67 5f63 6c75  en(remaining_clu
+0001b1a0: 7374 6572 7329 203e 2031 2065 6c73 6520  sters) > 1 else 
+0001b1b0: 2727 0a20 2020 2020 2020 2063 6c75 7374  ''.        clust
+0001b1c0: 6572 5f73 7472 203d 2027 2c20 272e 6a6f  er_str = ', '.jo
+0001b1d0: 696e 286e 616d 6520 666f 7220 6e61 6d65  in(name for name
+0001b1e0: 2069 6e20 7265 6d61 696e 696e 675f 636c   in remaining_cl
+0001b1f0: 7573 7465 7273 290a 2020 2020 2020 2020  usters).        
+0001b200: 6c6f 6767 6572 2e77 6172 6e69 6e67 2866  logger.warning(f
+0001b210: 277b 7965 6c6c 6f77 7d43 6c75 7374 6572  '{yellow}Cluster
+0001b220: 7b70 6c75 7261 6c7d 2074 6572 6d69 6e61  {plural} termina
+0001b230: 7465 6420 6f6e 2027 0a20 2020 2020 2020  ted on '.       
+0001b240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b250: 6627 7468 6520 636c 6f75 643a 207b 7265  f'the cloud: {re
+0001b260: 7365 747d 7b62 7269 6768 747d 7b63 6c75  set}{bright}{clu
+0001b270: 7374 6572 5f73 7472 7d7b 7265 7365 747d  ster_str}{reset}
+0001b280: 2729 0a0a 2020 2020 6966 2066 6169 6c65  ')..    if faile
+0001b290: 645f 636c 7573 7465 7273 3a0a 2020 2020  d_clusters:.    
+0001b2a0: 2020 2020 706c 7572 616c 203d 2027 7327      plural = 's'
+0001b2b0: 2069 6620 6c65 6e28 6661 696c 6564 5f63   if len(failed_c
+0001b2c0: 6c75 7374 6572 7329 203e 2031 2065 6c73  lusters) > 1 els
+0001b2d0: 6520 2727 0a20 2020 2020 2020 206c 6f67  e ''.        log
+0001b2e0: 6765 722e 7761 726e 696e 6728 6627 7b79  ger.warning(f'{y
+0001b2f0: 656c 6c6f 777d 4661 696c 6564 2074 6f20  ellow}Failed to 
+0001b300: 7265 6672 6573 6820 7374 6174 7573 2066  refresh status f
+0001b310: 6f72 2027 0a20 2020 2020 2020 2020 2020  or '.           
+0001b320: 2020 2020 2020 2020 2020 2020 6627 7b6c              f'{l
+0001b330: 656e 2866 6169 6c65 645f 636c 7573 7465  en(failed_cluste
+0001b340: 7273 297d 2063 6c75 7374 6572 7b70 6c75  rs)} cluster{plu
+0001b350: 7261 6c7d 3a7b 7265 7365 747d 2729 0a20  ral}:{reset}'). 
+0001b360: 2020 2020 2020 2066 6f72 2063 6c75 7374         for clust
+0001b370: 6572 5f6e 616d 652c 2065 2069 6e20 6661  er_name, e in fa
+0001b380: 696c 6564 5f63 6c75 7374 6572 733a 0a20  iled_clusters:. 
+0001b390: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+0001b3a0: 722e 7761 726e 696e 6728 6627 2020 7b62  r.warning(f'  {b
+0001b3b0: 7269 6768 747d 7b63 6c75 7374 6572 5f6e  right}{cluster_n
+0001b3c0: 616d 657d 7b72 6573 6574 7d3a 207b 657d  ame}{reset}: {e}
+0001b3d0: 2729 0a20 2020 2072 6574 7572 6e20 6b65  ').    return ke
+0001b3e0: 7074 5f72 6563 6f72 6473 0a0a 0a40 7479  pt_records...@ty
+0001b3f0: 7069 6e67 2e6f 7665 726c 6f61 640a 6465  ping.overload.de
+0001b400: 6620 6765 745f 6261 636b 656e 645f 6672  f get_backend_fr
+0001b410: 6f6d 5f68 616e 646c 6528 0a20 2020 2068  om_handle(.    h
+0001b420: 616e 646c 653a 2027 636c 6f75 645f 766d  andle: 'cloud_vm
+0001b430: 5f72 6179 5f62 6163 6b65 6e64 2e43 6c6f  _ray_backend.Clo
+0001b440: 7564 566d 5261 7952 6573 6f75 7263 6548  udVmRayResourceH
+0001b450: 616e 646c 6527 0a29 202d 3e20 2763 6c6f  andle'.) -> 'clo
+0001b460: 7564 5f76 6d5f 7261 795f 6261 636b 656e  ud_vm_ray_backen
+0001b470: 642e 436c 6f75 6456 6d52 6179 4261 636b  d.CloudVmRayBack
+0001b480: 656e 6427 3a0a 2020 2020 2e2e 2e0a 0a0a  end':.    ......
+0001b490: 4074 7970 696e 672e 6f76 6572 6c6f 6164  @typing.overload
+0001b4a0: 0a64 6566 2067 6574 5f62 6163 6b65 6e64  .def get_backend
+0001b4b0: 5f66 726f 6d5f 6861 6e64 6c65 280a 2020  _from_handle(.  
+0001b4c0: 2020 6861 6e64 6c65 3a20 276c 6f63 616c    handle: 'local
+0001b4d0: 5f64 6f63 6b65 725f 6261 636b 656e 642e  _docker_backend.
+0001b4e0: 4c6f 6361 6c44 6f63 6b65 7252 6573 6f75  LocalDockerResou
+0001b4f0: 7263 6548 616e 646c 6527 0a29 202d 3e20  rceHandle'.) -> 
+0001b500: 276c 6f63 616c 5f64 6f63 6b65 725f 6261  'local_docker_ba
+0001b510: 636b 656e 642e 4c6f 6361 6c44 6f63 6b65  ckend.LocalDocke
+0001b520: 7242 6163 6b65 6e64 273a 0a20 2020 202e  rBackend':.    .
+0001b530: 2e2e 0a0a 0a40 7479 7069 6e67 2e6f 7665  .....@typing.ove
+0001b540: 726c 6f61 640a 6465 6620 6765 745f 6261  rload.def get_ba
+0001b550: 636b 656e 645f 6672 6f6d 5f68 616e 646c  ckend_from_handl
+0001b560: 6528 0a20 2020 2020 2020 2068 616e 646c  e(.        handl
+0001b570: 653a 2062 6163 6b65 6e64 732e 5265 736f  e: backends.Reso
+0001b580: 7572 6365 4861 6e64 6c65 2920 2d3e 2062  urceHandle) -> b
+0001b590: 6163 6b65 6e64 732e 4261 636b 656e 643a  ackends.Backend:
+0001b5a0: 0a20 2020 202e 2e2e 0a0a 0a64 6566 2067  .    ......def g
+0001b5b0: 6574 5f62 6163 6b65 6e64 5f66 726f 6d5f  et_backend_from_
+0001b5c0: 6861 6e64 6c65 280a 2020 2020 2020 2020  handle(.        
+0001b5d0: 6861 6e64 6c65 3a20 6261 636b 656e 6473  handle: backends
+0001b5e0: 2e52 6573 6f75 7263 6548 616e 646c 6529  .ResourceHandle)
+0001b5f0: 202d 3e20 6261 636b 656e 6473 2e42 6163   -> backends.Bac
+0001b600: 6b65 6e64 3a0a 2020 2020 2222 2247 6574  kend:.    """Get
+0001b610: 7320 6120 4261 636b 656e 6420 6f62 6a65  s a Backend obje
+0001b620: 6374 2063 6f72 7265 7370 6f6e 6469 6e67  ct corresponding
+0001b630: 2074 6f20 6120 6861 6e64 6c65 2e0a 0a20   to a handle... 
+0001b640: 2020 2049 6e73 7065 6374 7320 6861 6e64     Inspects hand
+0001b650: 6c65 2074 7970 6520 746f 2069 6e66 6572  le type to infer
+0001b660: 2074 6865 2062 6163 6b65 6e64 2075 7365   the backend use
+0001b670: 6420 666f 7220 7468 6520 7265 736f 7572  d for the resour
+0001b680: 6365 2e0a 2020 2020 2222 220a 2020 2020  ce..    """.    
+0001b690: 6261 636b 656e 643a 2062 6163 6b65 6e64  backend: backend
+0001b6a0: 732e 4261 636b 656e 640a 2020 2020 6966  s.Backend.    if
+0001b6b0: 2069 7369 6e73 7461 6e63 6528 6861 6e64   isinstance(hand
+0001b6c0: 6c65 2c20 6261 636b 656e 6473 2e43 6c6f  le, backends.Clo
+0001b6d0: 7564 566d 5261 7952 6573 6f75 7263 6548  udVmRayResourceH
+0001b6e0: 616e 646c 6529 3a0a 2020 2020 2020 2020  andle):.        
+0001b6f0: 6261 636b 656e 6420 3d20 6261 636b 656e  backend = backen
+0001b700: 6473 2e43 6c6f 7564 566d 5261 7942 6163  ds.CloudVmRayBac
+0001b710: 6b65 6e64 2829 0a20 2020 2065 6c69 6620  kend().    elif 
+0001b720: 6973 696e 7374 616e 6365 2868 616e 646c  isinstance(handl
+0001b730: 652c 2062 6163 6b65 6e64 732e 4c6f 6361  e, backends.Loca
+0001b740: 6c44 6f63 6b65 7252 6573 6f75 7263 6548  lDockerResourceH
+0001b750: 616e 646c 6529 3a0a 2020 2020 2020 2020  andle):.        
+0001b760: 6261 636b 656e 6420 3d20 6261 636b 656e  backend = backen
+0001b770: 6473 2e4c 6f63 616c 446f 636b 6572 4261  ds.LocalDockerBa
+0001b780: 636b 656e 6428 290a 2020 2020 656c 7365  ckend().    else
+0001b790: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+0001b7a0: 4e6f 7449 6d70 6c65 6d65 6e74 6564 4572  NotImplementedEr
+0001b7b0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+0001b7c0: 2066 2748 616e 646c 6520 7479 7065 207b   f'Handle type {
+0001b7d0: 7479 7065 2868 616e 646c 6529 7d20 6973  type(handle)} is
+0001b7e0: 206e 6f74 2073 7570 706f 7274 6564 2079   not supported y
+0001b7f0: 6574 2e27 290a 2020 2020 7265 7475 726e  et.').    return
+0001b800: 2062 6163 6b65 6e64 0a0a 0a64 6566 2067   backend...def g
+0001b810: 6574 5f74 6173 6b5f 6465 6d61 6e64 735f  et_task_demands_
+0001b820: 6469 6374 2874 6173 6b3a 2027 7461 736b  dict(task: 'task
+0001b830: 5f6c 6962 2e54 6173 6b27 2920 2d3e 2044  _lib.Task') -> D
+0001b840: 6963 745b 7374 722c 2066 6c6f 6174 5d3a  ict[str, float]:
+0001b850: 0a20 2020 2022 2222 5265 7475 726e 7320  .    """Returns 
+0001b860: 7468 6520 7265 736f 7572 6365 7320 6469  the resources di
+0001b870: 6374 206f 6620 7468 6520 7461 736b 2e0a  ct of the task..
+0001b880: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
+0001b890: 2020 2020 2020 4120 6469 6374 206f 6620        A dict of 
+0001b8a0: 7468 6520 7265 736f 7572 6365 7320 6f66  the resources of
+0001b8b0: 2074 6865 2074 6173 6b2e 2054 6865 206b   the task. The k
+0001b8c0: 6579 7320 6172 6520 7468 6520 7265 736f  eys are the reso
+0001b8d0: 7572 6365 206e 616d 6573 0a20 2020 2020  urce names.     
+0001b8e0: 2020 2061 6e64 2074 6865 2076 616c 7565     and the value
+0001b8f0: 7320 6172 6520 7468 6520 6e75 6d62 6572  s are the number
+0001b900: 206f 6620 7468 6520 7265 736f 7572 6365   of the resource
+0001b910: 732e 2049 7420 616c 7761 7973 2063 6f6e  s. It always con
+0001b920: 7461 696e 730a 2020 2020 2020 2020 7468  tains.        th
+0001b930: 6520 4350 5520 7265 736f 7572 6365 2028  e CPU resource (
+0001b940: 746f 2063 6f6e 7472 6f6c 2074 6865 206d  to control the m
+0001b950: 6178 696d 756d 206e 756d 6265 7220 6f66  aximum number of
+0001b960: 2074 6173 6b73 292c 2061 6e64 0a20 2020   tasks), and.   
+0001b970: 2020 2020 206f 7074 696f 6e61 6c6c 7920       optionally 
+0001b980: 6163 6365 6c65 7261 746f 7220 6465 6d61  accelerator dema
+0001b990: 6e64 732e 0a20 2020 2022 2222 0a20 2020  nds..    """.   
+0001b9a0: 2023 2054 4f44 4f3a 2043 7573 746f 6d20   # TODO: Custom 
+0001b9b0: 4350 5520 616e 6420 6f74 6865 7220 6d65  CPU and other me
+0001b9c0: 6d6f 7279 2072 6573 6f75 7263 6573 2061  mory resources a
+0001b9d0: 7265 206e 6f74 2073 7570 706f 7274 6564  re not supported
+0001b9e0: 2079 6574 2e0a 2020 2020 2320 466f 7220   yet..    # For 
+0001b9f0: 736b 7920 7370 6f74 2f73 6572 7665 2063  sky spot/serve c
+0001ba00: 6f6e 7472 6f6c 6c65 7220 7461 736b 2c20  ontroller task, 
+0001ba10: 7765 2073 6574 2074 6865 2043 5055 2072  we set the CPU r
+0001ba20: 6573 6f75 7263 6520 746f 2061 2073 6d61  esource to a sma
+0001ba30: 6c6c 6572 0a20 2020 2023 2076 616c 7565  ller.    # value
+0001ba40: 2074 6f20 7375 7070 6f72 7420 6120 6c61   to support a la
+0001ba50: 7267 6572 206e 756d 6265 7220 6f66 2073  rger number of s
+0001ba60: 706f 7420 6a6f 6273 2061 6e64 2073 6572  pot jobs and ser
+0001ba70: 7669 6365 732e 0a20 2020 2072 6573 6f75  vices..    resou
+0001ba80: 7263 6573 5f64 6963 7420 3d20 7b0a 2020  rces_dict = {.  
+0001ba90: 2020 2020 2020 2743 5055 273a 2028 636f        'CPU': (co
+0001baa0: 6e73 7461 6e74 732e 434f 4e54 524f 4c4c  nstants.CONTROLL
+0001bab0: 4552 5f50 524f 4345 5353 5f43 5055 5f44  ER_PROCESS_CPU_D
+0001bac0: 454d 414e 440a 2020 2020 2020 2020 2020  EMAND.          
+0001bad0: 2020 2020 2020 6966 2074 6173 6b2e 6973        if task.is
+0001bae0: 5f63 6f6e 7472 6f6c 6c65 725f 7461 736b  _controller_task
+0001baf0: 2829 2065 6c73 6520 4445 4641 554c 545f  () else DEFAULT_
+0001bb00: 5441 534b 5f43 5055 5f44 454d 414e 4429  TASK_CPU_DEMAND)
+0001bb10: 0a20 2020 207d 0a20 2020 2069 6620 7461  .    }.    if ta
+0001bb20: 736b 2e62 6573 745f 7265 736f 7572 6365  sk.best_resource
+0001bb30: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
+0001bb40: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
+0001bb50: 203d 2074 6173 6b2e 6265 7374 5f72 6573   = task.best_res
+0001bb60: 6f75 7263 6573 0a20 2020 2065 6c73 653a  ources.    else:
+0001bb70: 0a20 2020 2020 2020 2023 2054 6173 6b20  .        # Task 
+0001bb80: 6d61 7920 2865 2e67 2e2c 2073 6b79 206c  may (e.g., sky l
+0001bb90: 6175 6e63 6829 206f 7220 6d61 7920 6e6f  aunch) or may no
+0001bba0: 7420 2865 2e67 2e2c 2073 6b79 2065 7865  t (e.g., sky exe
+0001bbb0: 6329 2068 6176 6520 756e 6465 7267 6f6e  c) have undergon
+0001bbc0: 650a 2020 2020 2020 2020 2320 736b 792e  e.        # sky.
+0001bbd0: 6f70 7469 6d69 7a65 2829 2c20 736f 2062  optimize(), so b
+0001bbe0: 6573 745f 7265 736f 7572 6365 7320 6d61  est_resources ma
+0001bbf0: 7920 6265 204e 6f6e 652e 0a20 2020 2020  y be None..     
+0001bc00: 2020 2061 7373 6572 7420 6c65 6e28 7461     assert len(ta
+0001bc10: 736b 2e72 6573 6f75 7263 6573 2920 3d3d  sk.resources) ==
+0001bc20: 2031 2c20 7461 736b 2e72 6573 6f75 7263   1, task.resourc
+0001bc30: 6573 0a20 2020 2020 2020 2072 6573 6f75  es.        resou
+0001bc40: 7263 6573 203d 206c 6973 7428 7461 736b  rces = list(task
+0001bc50: 2e72 6573 6f75 7263 6573 295b 305d 0a20  .resources)[0]. 
+0001bc60: 2020 2069 6620 7265 736f 7572 6365 7320     if resources 
+0001bc70: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+0001bc80: 7265 736f 7572 6365 732e 6163 6365 6c65  resources.accele
+0001bc90: 7261 746f 7273 2069 7320 6e6f 7420 4e6f  rators is not No
+0001bca0: 6e65 3a0a 2020 2020 2020 2020 7265 736f  ne:.        reso
+0001bcb0: 7572 6365 735f 6469 6374 2e75 7064 6174  urces_dict.updat
+0001bcc0: 6528 7265 736f 7572 6365 732e 6163 6365  e(resources.acce
+0001bcd0: 6c65 7261 746f 7273 290a 2020 2020 7265  lerators).    re
+0001bce0: 7475 726e 2072 6573 6f75 7263 6573 5f64  turn resources_d
+0001bcf0: 6963 740a 0a0a 6465 6620 6765 745f 7461  ict...def get_ta
+0001bd00: 736b 5f72 6573 6f75 7263 6573 5f73 7472  sk_resources_str
+0001bd10: 2874 6173 6b3a 2027 7461 736b 5f6c 6962  (task: 'task_lib
+0001bd20: 2e54 6173 6b27 2920 2d3e 2073 7472 3a0a  .Task') -> str:.
+0001bd30: 2020 2020 2222 2252 6574 7572 6e73 2074      """Returns t
+0001bd40: 6865 2072 6573 6f75 7263 6573 2073 7472  he resources str
+0001bd50: 696e 6720 6f66 2074 6865 2074 6173 6b2e  ing of the task.
+0001bd60: 0a0a 2020 2020 5468 6520 7265 736f 7572  ..    The resour
+0001bd70: 6365 7320 7374 7269 6e67 2069 7320 6f6e  ces string is on
+0001bd80: 6c79 2075 7365 6420 6173 2061 2064 6973  ly used as a dis
+0001bd90: 706c 6179 2070 7572 706f 7365 2c20 736f  play purpose, so
+0001bda0: 2077 6520 6f6e 6c79 2073 686f 770a 2020   we only show.  
+0001bdb0: 2020 7468 6520 6163 6365 6c65 7261 746f    the accelerato
+0001bdc0: 7220 6465 6d61 6e64 7320 2869 6620 616e  r demands (if an
+0001bdd0: 7929 2e20 4f74 6865 7277 6973 652c 2074  y). Otherwise, t
+0001bde0: 6865 2043 5055 2064 656d 616e 6420 6973  he CPU demand is
+0001bdf0: 2073 686f 776e 2e0a 2020 2020 2222 220a   shown..    """.
+0001be00: 2020 2020 7461 736b 5f63 7075 5f64 656d      task_cpu_dem
+0001be10: 616e 6420 3d20 2863 6f6e 7374 616e 7473  and = (constants
+0001be20: 2e43 4f4e 5452 4f4c 4c45 525f 5052 4f43  .CONTROLLER_PROC
+0001be30: 4553 535f 4350 555f 4445 4d41 4e44 2069  ESS_CPU_DEMAND i
+0001be40: 660a 2020 2020 2020 2020 2020 2020 2020  f.              
+0001be50: 2020 2020 2020 2020 2074 6173 6b2e 6973           task.is
+0001be60: 5f63 6f6e 7472 6f6c 6c65 725f 7461 736b  _controller_task
+0001be70: 2829 2065 6c73 6520 4445 4641 554c 545f  () else DEFAULT_
+0001be80: 5441 534b 5f43 5055 5f44 454d 414e 4429  TASK_CPU_DEMAND)
+0001be90: 0a20 2020 2069 6620 7461 736b 2e62 6573  .    if task.bes
+0001bea0: 745f 7265 736f 7572 6365 7320 6973 206e  t_resources is n
+0001beb0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0001bec0: 2061 6363 656c 6572 6174 6f72 5f64 6963   accelerator_dic
+0001bed0: 7420 3d20 7461 736b 2e62 6573 745f 7265  t = task.best_re
+0001bee0: 736f 7572 6365 732e 6163 6365 6c65 7261  sources.accelera
+0001bef0: 746f 7273 0a20 2020 2020 2020 2069 6620  tors.        if 
+0001bf00: 6163 6365 6c65 7261 746f 725f 6469 6374  accelerator_dict
+0001bf10: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0001bf20: 2020 2020 2020 7265 736f 7572 6365 735f        resources_
+0001bf30: 7374 7220 3d20 6627 4350 553a 7b74 6173  str = f'CPU:{tas
+0001bf40: 6b5f 6370 755f 6465 6d61 6e64 7d27 0a20  k_cpu_demand}'. 
+0001bf50: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0001bf60: 2020 2020 2020 2020 2072 6573 6f75 7263           resourc
+0001bf70: 6573 5f73 7472 203d 2027 2c20 272e 6a6f  es_str = ', '.jo
+0001bf80: 696e 280a 2020 2020 2020 2020 2020 2020  in(.            
+0001bf90: 2020 2020 6627 7b6b 7d3a 7b76 7d27 2066      f'{k}:{v}' f
+0001bfa0: 6f72 206b 2c20 7620 696e 2061 6363 656c  or k, v in accel
+0001bfb0: 6572 6174 6f72 5f64 6963 742e 6974 656d  erator_dict.item
+0001bfc0: 7328 2929 0a20 2020 2065 6c69 6620 6c65  s()).    elif le
+0001bfd0: 6e28 7461 736b 2e72 6573 6f75 7263 6573  n(task.resources
+0001bfe0: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
+0001bff0: 7265 736f 7572 6365 735f 6469 6374 203d  resources_dict =
+0001c000: 206c 6973 7428 7461 736b 2e72 6573 6f75   list(task.resou
+0001c010: 7263 6573 295b 305d 2e61 6363 656c 6572  rces)[0].acceler
+0001c020: 6174 6f72 730a 2020 2020 2020 2020 6966  ators.        if
+0001c030: 2072 6573 6f75 7263 6573 5f64 6963 7420   resources_dict 
+0001c040: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0001c050: 2020 2020 2072 6573 6f75 7263 6573 5f73       resources_s
+0001c060: 7472 203d 2066 2743 5055 3a7b 7461 736b  tr = f'CPU:{task
+0001c070: 5f63 7075 5f64 656d 616e 647d 270a 2020  _cpu_demand}'.  
+0001c080: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001c090: 2020 2020 2020 2020 7265 736f 7572 6365          resource
+0001c0a0: 735f 7374 7220 3d20 272c 2027 2e6a 6f69  s_str = ', '.joi
+0001c0b0: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+0001c0c0: 2020 2066 277b 6b7d 3a7b 767d 2720 666f     f'{k}:{v}' fo
+0001c0d0: 7220 6b2c 2076 2069 6e20 7265 736f 7572  r k, v in resour
+0001c0e0: 6365 735f 6469 6374 2e69 7465 6d73 2829  ces_dict.items()
+0001c0f0: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+0001c100: 2020 2020 7265 736f 7572 6365 5f61 6363      resource_acc
+0001c110: 656c 6572 6174 6f72 7320 3d20 5b5d 0a20  elerators = []. 
+0001c120: 2020 2020 2020 2066 6f72 2072 6573 6f75         for resou
+0001c130: 7263 6520 696e 2074 6173 6b2e 7265 736f  rce in task.reso
+0001c140: 7572 6365 733a 0a20 2020 2020 2020 2020  urces:.         
+0001c150: 2020 2069 6620 7265 736f 7572 6365 2e61     if resource.a
+0001c160: 6363 656c 6572 6174 6f72 7320 6973 204e  ccelerators is N
+0001c170: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0001c180: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
+0001c190: 2020 2020 2020 2020 2020 666f 7220 6b2c            for k,
+0001c1a0: 2076 2069 6e20 7265 736f 7572 6365 2e61   v in resource.a
+0001c1b0: 6363 656c 6572 6174 6f72 732e 6974 656d  ccelerators.item
+0001c1c0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+0001c1d0: 2020 2020 2072 6573 6f75 7263 655f 6163       resource_ac
+0001c1e0: 6365 6c65 7261 746f 7273 2e61 7070 656e  celerators.appen
+0001c1f0: 6428 6627 7b6b 7d3a 7b76 7d27 290a 0a20  d(f'{k}:{v}').. 
+0001c200: 2020 2020 2020 2069 6620 7265 736f 7572         if resour
+0001c210: 6365 5f61 6363 656c 6572 6174 6f72 733a  ce_accelerators:
+0001c220: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+0001c230: 6f75 7263 6573 5f73 7472 203d 2027 2c20  ources_str = ', 
+0001c240: 272e 6a6f 696e 2873 6574 2872 6573 6f75  '.join(set(resou
+0001c250: 7263 655f 6163 6365 6c65 7261 746f 7273  rce_accelerators
+0001c260: 2929 0a20 2020 2020 2020 2065 6c73 653a  )).        else:
+0001c270: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+0001c280: 6f75 7263 6573 5f73 7472 203d 2066 2743  ources_str = f'C
+0001c290: 5055 3a7b 7461 736b 5f63 7075 5f64 656d  PU:{task_cpu_dem
+0001c2a0: 616e 647d 270a 2020 2020 7265 736f 7572  and}'.    resour
+0001c2b0: 6365 735f 7374 7220 3d20 6627 7b74 6173  ces_str = f'{tas
+0001c2c0: 6b2e 6e75 6d5f 6e6f 6465 737d 7820 5b7b  k.num_nodes}x [{
+0001c2d0: 7265 736f 7572 6365 735f 7374 727d 5d27  resources_str}]'
+0001c2e0: 0a20 2020 2072 6574 7572 6e20 7265 736f  .    return reso
+0001c2f0: 7572 6365 735f 7374 720a 0a0a 2320 4861  urces_str...# Ha
+0001c300: 6e64 6c65 2063 7472 6c2d 630a 6465 6620  ndle ctrl-c.def 
+0001c310: 696e 7465 7272 7570 745f 6861 6e64 6c65  interrupt_handle
+0001c320: 7228 7369 676e 756d 2c20 6672 616d 6529  r(signum, frame)
+0001c330: 3a0a 2020 2020 6465 6c20 7369 676e 756d  :.    del signum
+0001c340: 2c20 6672 616d 650a 2020 2020 7375 6270  , frame.    subp
+0001c350: 726f 6365 7373 5f75 7469 6c73 2e6b 696c  rocess_utils.kil
+0001c360: 6c5f 6368 696c 6472 656e 5f70 726f 6365  l_children_proce
+0001c370: 7373 6573 2829 0a20 2020 2023 2041 766f  sses().    # Avo
+0001c380: 6964 2075 7369 6e67 206c 6f67 6765 7220  id using logger 
+0001c390: 6865 7265 2c20 6173 2069 7420 7769 6c6c  here, as it will
+0001c3a0: 2070 7269 6e74 2074 6865 2073 7461 636b   print the stack
+0001c3b0: 2074 7261 6365 2066 6f72 2062 726f 6b65   trace for broke
+0001c3c0: 6e0a 2020 2020 2320 7069 7065 2c20 7768  n.    # pipe, wh
+0001c3d0: 656e 2074 6865 206f 7574 7075 7420 6973  en the output is
+0001c3e0: 2070 6970 6564 2074 6f20 616e 6f74 6865   piped to anothe
+0001c3f0: 7220 7072 6f67 7261 6d2e 0a20 2020 2070  r program..    p
+0001c400: 7269 6e74 2866 277b 636f 6c6f 7261 6d61  rint(f'{colorama
+0001c410: 2e53 7479 6c65 2e44 494d 7d54 6970 3a20  .Style.DIM}Tip: 
+0001c420: 5468 6520 6a6f 6220 7769 6c6c 206b 6565  The job will kee
+0001c430: 7020 270a 2020 2020 2020 2020 2020 6627  p '.          f'
+0001c440: 7275 6e6e 696e 6720 6166 7465 7220 4374  running after Ct
+0001c450: 726c 2d43 2e7b 636f 6c6f 7261 6d61 2e53  rl-C.{colorama.S
+0001c460: 7479 6c65 2e52 4553 4554 5f41 4c4c 7d27  tyle.RESET_ALL}'
+0001c470: 290a 2020 2020 7769 7468 2075 785f 7574  ).    with ux_ut
+0001c480: 696c 732e 7072 696e 745f 6578 6365 7074  ils.print_except
+0001c490: 696f 6e5f 6e6f 5f74 7261 6365 6261 636b  ion_no_traceback
+0001c4a0: 2829 3a0a 2020 2020 2020 2020 7261 6973  ():.        rais
+0001c4b0: 6520 4b65 7962 6f61 7264 496e 7465 7272  e KeyboardInterr
+0001c4c0: 7570 7428 6578 6365 7074 696f 6e73 2e4b  upt(exceptions.K
+0001c4d0: 4559 424f 4152 445f 494e 5445 5252 5550  EYBOARD_INTERRUP
+0001c4e0: 545f 434f 4445 290a 0a0a 2320 4861 6e64  T_CODE)...# Hand
+0001c4f0: 6c65 2063 7472 6c2d 7a0a 6465 6620 7374  le ctrl-z.def st
+0001c500: 6f70 5f68 616e 646c 6572 2873 6967 6e75  op_handler(signu
+0001c510: 6d2c 2066 7261 6d65 293a 0a20 2020 2064  m, frame):.    d
+0001c520: 656c 2073 6967 6e75 6d2c 2066 7261 6d65  el signum, frame
+0001c530: 0a20 2020 2073 7562 7072 6f63 6573 735f  .    subprocess_
+0001c540: 7574 696c 732e 6b69 6c6c 5f63 6869 6c64  utils.kill_child
+0001c550: 7265 6e5f 7072 6f63 6573 7365 7328 290a  ren_processes().
+0001c560: 2020 2020 2320 4176 6f69 6420 7573 696e      # Avoid usin
+0001c570: 6720 6c6f 6767 6572 2068 6572 652c 2061  g logger here, a
+0001c580: 7320 6974 2077 696c 6c20 7072 696e 7420  s it will print 
+0001c590: 7468 6520 7374 6163 6b20 7472 6163 6520  the stack trace 
+0001c5a0: 666f 7220 6272 6f6b 656e 0a20 2020 2023  for broken.    #
+0001c5b0: 2070 6970 652c 2077 6865 6e20 7468 6520   pipe, when the 
+0001c5c0: 6f75 7470 7574 2069 7320 7069 7065 6420  output is piped 
+0001c5d0: 746f 2061 6e6f 7468 6572 2070 726f 6772  to another progr
+0001c5e0: 616d 2e0a 2020 2020 7072 696e 7428 6627  am..    print(f'
+0001c5f0: 7b63 6f6c 6f72 616d 612e 5374 796c 652e  {colorama.Style.
+0001c600: 4449 4d7d 5469 703a 2054 6865 206a 6f62  DIM}Tip: The job
+0001c610: 2077 696c 6c20 6b65 6570 2027 0a20 2020   will keep '.   
+0001c620: 2020 2020 2020 2066 2772 756e 6e69 6e67         f'running
+0001c630: 2061 6674 6572 2043 7472 6c2d 5a2e 7b63   after Ctrl-Z.{c
+0001c640: 6f6c 6f72 616d 612e 5374 796c 652e 5245  olorama.Style.RE
+0001c650: 5345 545f 414c 4c7d 2729 0a20 2020 2077  SET_ALL}').    w
+0001c660: 6974 6820 7578 5f75 7469 6c73 2e70 7269  ith ux_utils.pri
+0001c670: 6e74 5f65 7863 6570 7469 6f6e 5f6e 6f5f  nt_exception_no_
+0001c680: 7472 6163 6562 6163 6b28 293a 0a20 2020  traceback():.   
+0001c690: 2020 2020 2072 6169 7365 204b 6579 626f       raise Keybo
+0001c6a0: 6172 6449 6e74 6572 7275 7074 2865 7863  ardInterrupt(exc
+0001c6b0: 6570 7469 6f6e 732e 5349 4754 5354 505f  eptions.SIGTSTP_
+0001c6c0: 434f 4445 290a 0a0a 6465 6620 7275 6e5f  CODE)...def run_
+0001c6d0: 636f 6d6d 616e 645f 616e 645f 6861 6e64  command_and_hand
+0001c6e0: 6c65 5f73 7368 5f66 6169 6c75 7265 2872  le_ssh_failure(r
+0001c6f0: 756e 6e65 723a 2063 6f6d 6d61 6e64 5f72  unner: command_r
+0001c700: 756e 6e65 722e 5353 4843 6f6d 6d61 6e64  unner.SSHCommand
+0001c710: 5275 6e6e 6572 2c0a 2020 2020 2020 2020  Runner,.        
+0001c720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c730: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0001c740: 6f6d 6d61 6e64 3a20 7374 722c 0a20 2020  ommand: str,.   
+0001c750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c770: 2020 2020 6661 696c 7572 655f 6d65 7373      failure_mess
+0001c780: 6167 653a 2073 7472 2920 2d3e 2073 7472  age: str) -> str
+0001c790: 3a0a 2020 2020 2222 2252 756e 7320 636f  :.    """Runs co
+0001c7a0: 6d6d 616e 6420 7265 6d6f 7465 6c79 2061  mmand remotely a
+0001c7b0: 6e64 2072 6574 7572 6e73 206f 7574 7075  nd returns outpu
+0001c7c0: 7420 7769 7468 2070 726f 7065 7220 6572  t with proper er
+0001c7d0: 726f 7220 6861 6e64 6c69 6e67 2e22 2222  ror handling."""
+0001c7e0: 0a20 2020 2072 632c 2073 7464 6f75 742c  .    rc, stdout,
+0001c7f0: 2073 7464 6572 7220 3d20 7275 6e6e 6572   stderr = runner
+0001c800: 2e72 756e 2863 6f6d 6d61 6e64 2c0a 2020  .run(command,.  
+0001c810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c830: 2020 7265 7175 6972 655f 6f75 7470 7574    require_output
+0001c840: 733d 5472 7565 2c0a 2020 2020 2020 2020  s=True,.        
+0001c850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c860: 2020 2020 2020 2020 2020 2020 7374 7265              stre
+0001c870: 616d 5f6c 6f67 733d 4661 6c73 6529 0a20  am_logs=False). 
+0001c880: 2020 2069 6620 7263 203d 3d20 3235 353a     if rc == 255:
+0001c890: 0a20 2020 2020 2020 2023 2053 5348 2066  .        # SSH f
+0001c8a0: 6169 6c65 640a 2020 2020 2020 2020 7261  ailed.        ra
+0001c8b0: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
+0001c8c0: 280a 2020 2020 2020 2020 2020 2020 6627  (.            f'
+0001c8d0: 5353 4820 7769 7468 2075 7365 7220 7b72  SSH with user {r
+0001c8e0: 756e 6e65 722e 7373 685f 7573 6572 7d20  unner.ssh_user} 
+0001c8f0: 616e 6420 6b65 7920 7b72 756e 6e65 722e  and key {runner.
+0001c900: 7373 685f 7072 6976 6174 655f 6b65 797d  ssh_private_key}
+0001c910: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
+0001c920: 2774 6f20 7b72 756e 6e65 722e 6970 7d20  'to {runner.ip} 
+0001c930: 6661 696c 6564 2e20 5468 6973 2069 7320  failed. This is 
+0001c940: 6d6f 7374 206c 696b 656c 7920 6475 6520  most likely due 
+0001c950: 746f 2069 6e63 6f72 7265 6374 2027 0a20  to incorrect '. 
+0001c960: 2020 2020 2020 2020 2020 2027 6372 6564             'cred
+0001c970: 656e 7469 616c 7320 6f72 2069 6e63 6f72  entials or incor
+0001c980: 7265 6374 2070 6572 6d69 7373 696f 6e73  rect permissions
+0001c990: 2066 6f72 2074 6865 206b 6579 2066 696c   for the key fil
+0001c9a0: 652e 2043 6865 636b 2027 0a20 2020 2020  e. Check '.     
+0001c9b0: 2020 2020 2020 2027 796f 7572 2063 7265         'your cre
+0001c9c0: 6465 6e74 6961 6c73 2061 6e64 2074 7279  dentials and try
+0001c9d0: 2061 6761 696e 2e27 290a 2020 2020 7375   again.').    su
+0001c9e0: 6270 726f 6365 7373 5f75 7469 6c73 2e68  bprocess_utils.h
+0001c9f0: 616e 646c 655f 7265 7475 726e 636f 6465  andle_returncode
+0001ca00: 2872 632c 0a20 2020 2020 2020 2020 2020  (rc,.           
+0001ca10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ca20: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
+0001ca30: 616e 642c 0a20 2020 2020 2020 2020 2020  and,.           
+0001ca40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ca50: 2020 2020 2020 2020 2020 2020 6661 696c              fail
+0001ca60: 7572 655f 6d65 7373 6167 652c 0a20 2020  ure_message,.   
+0001ca70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ca80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ca90: 2020 2020 7374 6465 7272 3d73 7464 6572      stderr=stder
+0001caa0: 7229 0a20 2020 2072 6574 7572 6e20 7374  r).    return st
+0001cab0: 646f 7574 0a0a 0a64 6566 2063 6865 636b  dout...def check
+0001cac0: 5f72 7379 6e63 5f69 6e73 7461 6c6c 6564  _rsync_installed
+0001cad0: 2829 202d 3e20 4e6f 6e65 3a0a 2020 2020  () -> None:.    
+0001cae0: 2222 2243 6865 636b 7320 6966 2072 7379  """Checks if rsy
+0001caf0: 6e63 2069 7320 696e 7374 616c 6c65 642e  nc is installed.
+0001cb00: 0a0a 2020 2020 5261 6973 6573 3a0a 2020  ..    Raises:.  
+0001cb10: 2020 2020 2020 5275 6e74 696d 6545 7272        RuntimeErr
+0001cb20: 6f72 3a20 6966 2072 7379 6e63 2069 7320  or: if rsync is 
+0001cb30: 6e6f 7420 696e 7374 616c 6c65 6420 696e  not installed in
+0001cb40: 2074 6865 206d 6163 6869 6e65 2e0a 2020   the machine..  
+0001cb50: 2020 2222 220a 2020 2020 7472 793a 0a20    """.    try:. 
+0001cb60: 2020 2020 2020 2073 7562 7072 6f63 6573         subproces
+0001cb70: 732e 7275 6e28 2772 7379 6e63 202d 2d76  s.run('rsync --v
+0001cb80: 6572 7369 6f6e 272c 0a20 2020 2020 2020  ersion',.       
+0001cb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cba0: 7368 656c 6c3d 5472 7565 2c0a 2020 2020  shell=True,.    
+0001cbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cbc0: 2020 2063 6865 636b 3d54 7275 652c 0a20     check=True,. 
+0001cbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cbe0: 2020 2020 2020 7374 646f 7574 3d73 7562        stdout=sub
+0001cbf0: 7072 6f63 6573 732e 5049 5045 2c0a 2020  process.PIPE,.  
+0001cc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cc10: 2020 2020 2073 7464 6572 723d 7375 6270       stderr=subp
+0001cc20: 726f 6365 7373 2e50 4950 4529 0a20 2020  rocess.PIPE).   
+0001cc30: 2065 7863 6570 7420 7375 6270 726f 6365   except subproce
+0001cc40: 7373 2e43 616c 6c65 6450 726f 6365 7373  ss.CalledProcess
+0001cc50: 4572 726f 723a 0a20 2020 2020 2020 2077  Error:.        w
+0001cc60: 6974 6820 7578 5f75 7469 6c73 2e70 7269  ith ux_utils.pri
+0001cc70: 6e74 5f65 7863 6570 7469 6f6e 5f6e 6f5f  nt_exception_no_
+0001cc80: 7472 6163 6562 6163 6b28 293a 0a20 2020  traceback():.   
+0001cc90: 2020 2020 2020 2020 2072 6169 7365 2052           raise R
+0001cca0: 756e 7469 6d65 4572 726f 7228 0a20 2020  untimeError(.   
+0001ccb0: 2020 2020 2020 2020 2020 2020 2027 6072               '`r
+0001ccc0: 7379 6e63 6020 6973 2072 6571 7569 7265  sync` is require
+0001ccd0: 6420 666f 7220 7072 6f76 6973 696f 6e69  d for provisioni
+0001cce0: 6e67 2061 6e64 270a 2020 2020 2020 2020  ng and'.        
+0001ccf0: 2020 2020 2020 2020 2720 6974 2069 7320          ' it is 
+0001cd00: 6e6f 7420 696e 7374 616c 6c65 642e 2046  not installed. F
+0001cd10: 6f72 2044 6562 6961 6e2f 5562 756e 7475  or Debian/Ubuntu
+0001cd20: 2073 7973 7465 6d2c 2027 0a20 2020 2020   system, '.     
+0001cd30: 2020 2020 2020 2020 2020 2027 696e 7374             'inst
+0001cd40: 616c 6c20 6974 2077 6974 683a 5c6e 270a  all it with:\n'.
+0001cd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd60: 2720 2024 2073 7564 6f20 6170 7420 696e  '  $ sudo apt in
+0001cd70: 7374 616c 6c20 7273 796e 6327 2920 6672  stall rsync') fr
+0001cd80: 6f6d 204e 6f6e 650a 0a0a 6465 6620 6368  om None...def ch
+0001cd90: 6563 6b5f 7374 616c 655f 7275 6e74 696d  eck_stale_runtim
+0001cda0: 655f 6f6e 5f72 656d 6f74 6528 7265 7475  e_on_remote(retu
+0001cdb0: 726e 636f 6465 3a20 696e 742c 2073 7464  rncode: int, std
+0001cdc0: 6572 723a 2073 7472 2c0a 2020 2020 2020  err: str,.      
+0001cdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cde0: 2020 2020 2020 2020 2020 2020 636c 7573              clus
+0001cdf0: 7465 725f 6e61 6d65 3a20 7374 7229 202d  ter_name: str) -
+0001ce00: 3e20 4e6f 6e65 3a0a 2020 2020 2222 2252  > None:.    """R
+0001ce10: 6169 7365 7320 5275 6e74 696d 6545 7272  aises RuntimeErr
+0001ce20: 6f72 2069 6620 7265 6d6f 7465 2053 6b79  or if remote Sky
+0001ce30: 5069 6c6f 7420 7275 6e74 696d 6520 6e65  Pilot runtime ne
+0001ce40: 6564 7320 746f 2062 6520 7570 6461 7465  eds to be update
+0001ce50: 642e 0a0a 2020 2020 5765 2064 6574 6563  d...    We detec
+0001ce60: 7420 7468 6973 2062 7920 7061 7273 696e  t this by parsin
+0001ce70: 6720 6365 7274 6169 6e20 6261 636b 7761  g certain backwa
+0001ce80: 7264 2d69 6e63 6f6d 7061 7469 626c 6520  rd-incompatible 
+0001ce90: 6572 726f 7220 6d65 7373 6167 6573 2066  error messages f
+0001cea0: 726f 6d0a 2020 2020 6073 7464 6572 7260  rom.    `stderr`
+0001ceb0: 2e20 5479 7069 6361 6c6c 7920 6475 6520  . Typically due 
+0001cec0: 746f 2074 6865 206c 6f63 616c 2063 6c69  to the local cli
+0001ced0: 656e 7420 7665 7273 696f 6e20 6a75 7374  ent version just
+0001cee0: 2067 6f74 2075 7064 6174 6564 2c20 616e   got updated, an
+0001cef0: 640a 2020 2020 7468 6520 7265 6d6f 7465  d.    the remote
+0001cf00: 2072 756e 7469 6d65 2069 7320 616e 206f   runtime is an o
+0001cf10: 6c64 6572 2076 6572 7369 6f6e 2e0a 2020  lder version..  
+0001cf20: 2020 2222 220a 2020 2020 7061 7474 6572    """.    patter
+0001cf30: 6e20 3d20 7265 2e63 6f6d 7069 6c65 2872  n = re.compile(r
+0001cf40: 2741 7474 7269 6275 7465 4572 726f 723a  'AttributeError:
+0001cf50: 206d 6f64 756c 6520 5c27 736b 795c 2e28   module \'sky\.(
+0001cf60: 2e2a 295c 2720 6861 7320 6e6f 2027 0a20  .*)\' has no '. 
+0001cf70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cf80: 2020 2020 2020 2020 7227 6174 7472 6962          r'attrib
+0001cf90: 7574 6520 5c27 282e 2a29 5c27 2729 0a20  ute \'(.*)\''). 
+0001cfa0: 2020 2069 6620 7265 7475 726e 636f 6465     if returncode
+0001cfb0: 2021 3d20 303a 0a20 2020 2020 2020 2061   != 0:.        a
+0001cfc0: 7474 7269 6275 7465 5f65 7272 6f72 203d  ttribute_error =
+0001cfd0: 2072 652e 6669 6e64 616c 6c28 7061 7474   re.findall(patt
+0001cfe0: 6572 6e2c 2073 7464 6572 7229 0a20 2020  ern, stderr).   
+0001cff0: 2020 2020 2069 6620 6174 7472 6962 7574       if attribut
+0001d000: 655f 6572 726f 723a 0a20 2020 2020 2020  e_error:.       
+0001d010: 2020 2020 2077 6974 6820 7578 5f75 7469       with ux_uti
+0001d020: 6c73 2e70 7269 6e74 5f65 7863 6570 7469  ls.print_excepti
+0001d030: 6f6e 5f6e 6f5f 7472 6163 6562 6163 6b28  on_no_traceback(
+0001d040: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0001d050: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
+0001d060: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+0001d070: 2020 2020 2020 2020 2020 2066 277b 636f             f'{co
+0001d080: 6c6f 7261 6d61 2e46 6f72 652e 5245 447d  lorama.Fore.RED}
+0001d090: 536b 7950 696c 6f74 2072 756e 7469 6d65  SkyPilot runtime
+0001d0a0: 206e 6565 6473 2074 6f20 6265 2075 7064   needs to be upd
+0001d0b0: 6174 6564 2027 0a20 2020 2020 2020 2020  ated '.         
+0001d0c0: 2020 2020 2020 2020 2020 2027 6f6e 2074             'on t
+0001d0d0: 6865 2072 656d 6f74 6520 636c 7573 7465  he remote cluste
+0001d0e0: 722e 2054 6f20 7570 6461 7465 2c20 7275  r. To update, ru
+0001d0f0: 6e20 2865 7869 7374 696e 6720 6a6f 6273  n (existing jobs
+0001d100: 2061 7265 2027 0a20 2020 2020 2020 2020   are '.         
+0001d110: 2020 2020 2020 2020 2020 2066 276e 6f74             f'not
+0001d120: 2069 6e74 6572 7275 7074 6564 293a 207b   interrupted): {
+0001d130: 636f 6c6f 7261 6d61 2e53 7479 6c65 2e42  colorama.Style.B
+0001d140: 5249 4748 547d 736b 7920 7374 6172 7420  RIGHT}sky start 
+0001d150: 2d66 202d 7920 270a 2020 2020 2020 2020  -f -y '.        
+0001d160: 2020 2020 2020 2020 2020 2020 6627 7b63              f'{c
+0001d170: 6c75 7374 6572 5f6e 616d 657d 7b63 6f6c  luster_name}{col
+0001d180: 6f72 616d 612e 5374 796c 652e 5245 5345  orama.Style.RESE
+0001d190: 545f 414c 4c7d 270a 2020 2020 2020 2020  T_ALL}'.        
+0001d1a0: 2020 2020 2020 2020 2020 2020 6627 5c6e              f'\n
+0001d1b0: 2d2d 2d20 4465 7461 696c 7320 2d2d 2d5c  --- Details ---\
+0001d1c0: 6e7b 7374 6465 7272 2e73 7472 6970 2829  n{stderr.strip()
+0001d1d0: 7d5c 6e27 290a                           }\n').
```

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/backends/cloud_vm_ray_backend.py` & `skypilot_nightly-1.0.0.dev20240502/sky/backends/cloud_vm_ray_backend.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/backends/docker_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/backends/docker_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/backends/local_docker_backend.py` & `skypilot_nightly-1.0.0.dev20240502/sky/backends/local_docker_backend.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/backends/monkey_patches/monkey_patch_ray_up.py` & `skypilot_nightly-1.0.0.dev20240502/sky/backends/monkey_patches/monkey_patch_ray_up.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/backends/wheel_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/backends/wheel_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/benchmark/benchmark_state.py` & `skypilot_nightly-1.0.0.dev20240502/sky/benchmark/benchmark_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/benchmark/benchmark_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/benchmark/benchmark_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/check.py` & `skypilot_nightly-1.0.0.dev20240502/sky/check.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/cli.py` & `skypilot_nightly-1.0.0.dev20240502/sky/cli.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/cloud_stores.py` & `skypilot_nightly-1.0.0.dev20240502/sky/cloud_stores.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/__init__.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/aws.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/aws.py`

 * *Files 2% similar despite different names*

```diff
@@ -958,7 +958,26 @@
         )
         subprocess_utils.handle_returncode(
             returncode,
             delete_image_cmd,
             error_msg=f'Failed to delete image {image_id!r} on {region}.',
             stderr=stderr,
             stream_logs=True)
+
+    @classmethod
+    def is_label_valid(cls, label_key: str,
+                       label_value: str) -> Tuple[bool, Optional[str]]:
+        key_regex = re.compile(r'^[^aws:][\S]{0,127}$')
+        value_regex = re.compile(r'^[\S]{0,255}$')
+        key_valid = bool(key_regex.match(label_key))
+        value_valid = bool(value_regex.match(label_value))
+        error_msg = None
+        if not key_valid:
+            error_msg = (f'Invalid tag key {label_key} for AWS. '
+                         'Key must start with any character except \'aws:\' '
+                         'and must be 128 characters or fewer in length.')
+        if not value_valid:
+            error_msg = (f'Invalid tag value {label_value} for AWS. '
+                         'Value must be 256 characters or fewer in length.')
+        if not key_valid or not value_valid:
+            return False, error_msg
+        return True, None
```

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/azure.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/azure.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/cloud.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/cloud.py`

 * *Files 2% similar despite different names*

```diff
@@ -316,14 +316,33 @@
     @classmethod
     def is_image_tag_valid(cls, image_tag: str, region: Optional[str]) -> bool:
         """Validates that the image tag is valid for this cloud."""
         return service_catalog.is_image_tag_valid(image_tag,
                                                   region,
                                                   clouds=cls._REPR.lower())
 
+    @classmethod
+    def is_label_valid(cls, label_key: str,
+                       label_value: str) -> Tuple[bool, Optional[str]]:
+        """Validates that the label key and value are valid for this cloud.
+
+        Labels can be implemented in different ways across clouds. For example,
+        on AWS we use instance tags, on GCP we use labels, and on Kubernetes we
+        use labels. This method should be implemented to validate the label
+        format for the cloud.
+
+        Returns:
+            A tuple of a boolean indicating whether the label is valid and an
+            optional string describing the reason if the label is invalid.
+        """
+        # If a cloud does not support labels, they are ignored. Only clouds
+        # that support labels implement this method.
+        del label_key, label_value
+        return True, None
+
     def get_feasible_launchable_resources(
         self,
         resources: 'resources_lib.Resources',
         num_nodes: int = 1
     ) -> Tuple[List['resources_lib.Resources'], List[str]]:
         """Returns ([feasible and launchable resources], [fuzzy candidates]).
```

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/cloud_registry.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/cloud_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/cudo.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/cudo.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/fluidstack.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/fluidstack.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/gcp.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/gcp.py`

 * *Files 2% similar despite different names*

```diff
@@ -1065,7 +1065,29 @@
         )
         subprocess_utils.handle_returncode(
             returncode,
             delete_image_cmd,
             error_msg=f'Failed to delete image {image_name!r}',
             stderr=stderr,
             stream_logs=True)
+
+    @classmethod
+    def is_label_valid(cls, label_key: str,
+                       label_value: str) -> Tuple[bool, Optional[str]]:
+        key_regex = re.compile(r'^[a-z]([a-z0-9_-]{0,62})?$')
+        value_regex = re.compile(r'^[a-z0-9_-]{0,63}$')
+        key_valid = bool(key_regex.match(label_key))
+        value_valid = bool(value_regex.match(label_value))
+        error_msg = None
+        condition_msg = ('can include lowercase alphanumeric characters, '
+                         'dashes, and underscores, with a total length of 63 '
+                         'characters or less.')
+        if not key_valid:
+            error_msg = (f'Invalid label key {label_key} for GCP. '
+                         f'Key must start with a lowercase letter '
+                         f'and {condition_msg}')
+        if not value_valid:
+            error_msg = (f'Invalid label value {label_value} for GCP. Value '
+                         f'{condition_msg}')
+        if not key_valid or not value_valid:
+            return False, error_msg
+        return True, None
```

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/ibm.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/ibm.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/kubernetes.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/kubernetes.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,10 +1,11 @@
 """Kubernetes."""
 import json
 import os
+import re
 import typing
 from typing import Dict, Iterator, List, Optional, Tuple
 
 from sky import clouds
 from sky import sky_logging
 from sky import skypilot_config
 from sky.adaptors import kubernetes
@@ -394,7 +395,37 @@
                 namespace = kubernetes_utils.DEFAULT_NAMESPACE
 
             user = current_context['context']['user']
             cluster = current_context['context']['cluster']
             return [f'{cluster}_{user}_{namespace}']
         except k8s.config.config_exception.ConfigException:
             return None
+
+    @classmethod
+    def is_label_valid(cls, label_key: str,
+                       label_value: str) -> Tuple[bool, Optional[str]]:
+        # Kubernetes labels can be of the format <domain>/<key>: <value>
+        key_regex = re.compile(
+            # Look-ahead to ensure proper domain formatting up to a slash
+            r'^(?:(?=[a-z0-9]([-a-z0-9.]*[a-z0-9])?\/)'
+            # Match domain: starts and ends with alphanum up to 253 chars
+            # including a slash in the domain.
+            r'[a-z0-9]([-a-z0-9.]{0,251}[a-z0-9])?\/)?'
+            # Match key: starts and ends with alphanum, upto to 63 chars.
+            r'[a-z0-9]([-a-z0-9_.]{0,61}[a-z0-9])?$')
+        value_regex = re.compile(
+            r'^([a-zA-Z0-9]([-a-zA-Z0-9_.]{0,61}[a-zA-Z0-9])?)?$')
+        key_valid = bool(key_regex.match(label_key))
+        value_valid = bool(value_regex.match(label_value))
+        error_msg = None
+        condition_msg = ('Value must consist of alphanumeric characters or '
+                         '\'-\', \'_\', \'.\', and must be no more than 63 '
+                         'characters in length.')
+        if not key_valid:
+            error_msg = (f'Invalid label key {label_key} for Kubernetes. '
+                         f'{condition_msg}')
+        if not value_valid:
+            error_msg = (f'Invalid label value {label_value} for Kubernetes. '
+                         f'{condition_msg}')
+        if not key_valid or not value_valid:
+            return False, error_msg
+        return True, None
```

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/lambda_cloud.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/lambda_cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/oci.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/oci.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/paperspace.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/paperspace.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/runpod.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/runpod.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/scp.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/scp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/__init__.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/aws_catalog.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/aws_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/azure_catalog.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/azure_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/common.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/common.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/config.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/cudo_catalog.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/cudo_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/data_fetchers/fetch_aws.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/data_fetchers/fetch_aws.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/data_fetchers/fetch_azure.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/data_fetchers/fetch_azure.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/fluidstack_catalog.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/fluidstack_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/gcp_catalog.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/gcp_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/ibm_catalog.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/ibm_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/kubernetes_catalog.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/kubernetes_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/lambda_catalog.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/lambda_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/oci_catalog.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/oci_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/paperspace_catalog.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/paperspace_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/runpod_catalog.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/runpod_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/scp_catalog.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/scp_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/service_catalog/vsphere_catalog.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/service_catalog/vsphere_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/utils/gcp_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/utils/gcp_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/utils/lambda_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/utils/lambda_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/utils/oci_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/utils/oci_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/utils/scp_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/utils/scp_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/clouds/vsphere.py` & `skypilot_nightly-1.0.0.dev20240502/sky/clouds/vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/core.py` & `skypilot_nightly-1.0.0.dev20240502/sky/core.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/dag.py` & `skypilot_nightly-1.0.0.dev20240502/sky/dag.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/data/data_transfer.py` & `skypilot_nightly-1.0.0.dev20240502/sky/data/data_transfer.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/data/data_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/data/data_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/data/mounting_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/data/mounting_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/data/storage.py` & `skypilot_nightly-1.0.0.dev20240502/sky/data/storage.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/data/storage_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/data/storage_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/exceptions.py` & `skypilot_nightly-1.0.0.dev20240502/sky/exceptions.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/execution.py` & `skypilot_nightly-1.0.0.dev20240502/sky/execution.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/global_user_state.py` & `skypilot_nightly-1.0.0.dev20240502/sky/global_user_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/optimizer.py` & `skypilot_nightly-1.0.0.dev20240502/sky/optimizer.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/__init__.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/aws/__init__.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/aws/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/aws/config.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/aws/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/aws/instance.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/aws/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/aws/utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/aws/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/azure/instance.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/azure/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/common.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/common.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/cudo/__init__.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/cudo/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/cudo/cudo_machine_type.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/cudo/cudo_machine_type.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/cudo/cudo_wrapper.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/cudo/cudo_wrapper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/cudo/instance.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/cudo/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/docker_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/docker_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/fluidstack/__init__.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/fluidstack/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/fluidstack/fluidstack_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/fluidstack/fluidstack_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/fluidstack/instance.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/fluidstack/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/gcp/__init__.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/gcp/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/gcp/config.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/gcp/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/gcp/constants.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/gcp/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/gcp/instance.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/gcp/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/gcp/instance_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/gcp/instance_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/instance_setup.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/instance_setup.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/kubernetes/__init__.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/kubernetes/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/kubernetes/config.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/kubernetes/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/kubernetes/instance.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/kubernetes/instance.py`

 * *Files 1% similar despite different names*

```diff
@@ -492,26 +492,33 @@
             # worker pods on different nodes than the head pod.
             # This is not set as a hard constraint because if different nodes
             # are not available, we still want to be able to schedule worker
             # pods on larger nodes which may be able to fit multiple SkyPilot
             # "nodes".
             pod_spec['spec']['affinity'] = {
                 'podAntiAffinity': {
-                    'requiredDuringSchedulingIgnoredDuringExecution': [{
-                        'labelSelector': {
-                            'matchExpressions': [{
-                                'key': TAG_SKYPILOT_CLUSTER_NAME,
-                                'operator': 'In',
-                                'values': [cluster_name_on_cloud]
-                            }]
-                        },
-                        'topologyKey': 'kubernetes.io/hostname'
+                    # Set as a soft constraint
+                    'preferredDuringSchedulingIgnoredDuringExecution': [{
+                        # Max weight to avoid scheduling on the
+                        # same physical node unless necessary.
+                        'weight': 100,
+                        'podAffinityTerm': {
+                            'labelSelector': {
+                                'matchExpressions': [{
+                                    'key': TAG_SKYPILOT_CLUSTER_NAME,
+                                    'operator': 'In',
+                                    'values': [cluster_name_on_cloud]
+                                }]
+                            },
+                            'topologyKey': 'kubernetes.io/hostname'
+                        }
                     }]
                 }
             }
+
         pod = kubernetes.core_api().create_namespaced_pod(namespace, pod_spec)
         created_pods[pod.metadata.name] = pod
         if head_pod_name is None:
             head_pod_name = pod.metadata.name
 
     # Adding the jump pod to the new_nodes list as well so it can be
     # checked if it's scheduled and running along with other pods.
```

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/kubernetes/network.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/kubernetes/network.py`

 * *Files 6% similar despite different names*

```diff
@@ -27,14 +27,17 @@
             cluster_name_on_cloud=cluster_name_on_cloud,
             ports=ports,
             provider_config=provider_config)
     elif port_mode == kubernetes_enums.KubernetesPortMode.INGRESS:
         _open_ports_using_ingress(cluster_name_on_cloud=cluster_name_on_cloud,
                                   ports=ports,
                                   provider_config=provider_config)
+    elif port_mode == kubernetes_enums.KubernetesPortMode.PODIP:
+        # Do nothing, as PodIP mode does not require opening ports
+        pass
 
 
 def _open_ports_using_loadbalancer(
     cluster_name_on_cloud: str,
     ports: List[int],
     provider_config: Dict[str, Any],
 ) -> None:
@@ -129,14 +132,17 @@
         _cleanup_ports_for_loadbalancer(
             cluster_name_on_cloud=cluster_name_on_cloud,
             provider_config=provider_config)
     elif port_mode == kubernetes_enums.KubernetesPortMode.INGRESS:
         _cleanup_ports_for_ingress(cluster_name_on_cloud=cluster_name_on_cloud,
                                    ports=ports,
                                    provider_config=provider_config)
+    elif port_mode == kubernetes_enums.KubernetesPortMode.PODIP:
+        # Do nothing, as PodIP mode does not require opening ports
+        pass
 
 
 def _cleanup_ports_for_loadbalancer(
     cluster_name_on_cloud: str,
     provider_config: Dict[str, Any],
 ) -> None:
     service_name = _LOADBALANCER_SERVICE_NAME.format(
@@ -187,14 +193,19 @@
                 provider_config=provider_config,
             )
         elif port_mode == kubernetes_enums.KubernetesPortMode.INGRESS:
             return _query_ports_for_ingress(
                 cluster_name_on_cloud=cluster_name_on_cloud,
                 ports=ports,
             )
+        elif port_mode == kubernetes_enums.KubernetesPortMode.PODIP:
+            return _query_ports_for_podip(
+                cluster_name_on_cloud=cluster_name_on_cloud,
+                ports=ports,
+            )
         else:
             return {}
     except kubernetes.kubernetes.client.ApiException as e:
         if e.status == 404:
             return {}
         raise e
 
@@ -242,7 +253,25 @@
                                 path=path_prefix.lstrip('/')),
             common.HTTPSEndpoint(host=external_ip,
                                  port=https_port,
                                  path=path_prefix.lstrip('/')),
         ]
 
     return result
+
+
+def _query_ports_for_podip(
+    cluster_name_on_cloud: str,
+    ports: List[int],
+) -> Dict[int, List[common.Endpoint]]:
+    namespace = kubernetes_utils.get_current_kube_config_context_namespace()
+    pod_name = kubernetes_utils.get_head_pod_name(cluster_name_on_cloud)
+    pod_ip = network_utils.get_pod_ip(namespace, pod_name)
+
+    result: Dict[int, List[common.Endpoint]] = {}
+    if pod_ip is None:
+        return {}
+
+    for port in ports:
+        result[port] = [common.SocketEndpoint(host=pod_ip, port=port)]
+
+    return result
```

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/kubernetes/network_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/kubernetes/network_utils.py`

 * *Files 8% similar despite different names*

```diff
@@ -224,7 +224,17 @@
 
     if service.status.load_balancer.ingress is None:
         return None
 
     ip = service.status.load_balancer.ingress[
         0].ip or service.status.load_balancer.ingress[0].hostname
     return ip if ip is not None else None
+
+
+def get_pod_ip(namespace: str, pod_name: str) -> Optional[str]:
+    """Returns the IP address of the pod."""
+    core_api = kubernetes.core_api()
+    pod = core_api.read_namespaced_pod(pod_name,
+                                       namespace,
+                                       _request_timeout=kubernetes.API_TIMEOUT)
+
+    return pod.status.pod_ip if pod.status.pod_ip is not None else None
```

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/kubernetes/utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/kubernetes/utils.py`

 * *Files 2% similar despite different names*

```diff
@@ -1096,14 +1096,17 @@
     port_mode = network_utils.get_port_mode()
     if port_mode == kubernetes_enums.KubernetesPortMode.INGRESS:
         endpoint_type = 'Ingress'
         debug_cmd = 'kubectl describe ingress && kubectl describe ingressclass'
     elif port_mode == kubernetes_enums.KubernetesPortMode.LOADBALANCER:
         endpoint_type = 'LoadBalancer'
         debug_cmd = 'kubectl describe service'
+    elif port_mode == kubernetes_enums.KubernetesPortMode.PODIP:
+        endpoint_type = 'PodIP'
+        debug_cmd = 'kubectl describe pod'
     return ENDPOINTS_DEBUG_MESSAGE.format(endpoint_type=endpoint_type,
                                           debug_cmd=debug_cmd)
 
 
 def merge_dicts(source: Dict[Any, Any], destination: Dict[Any, Any]):
     """Merge two dictionaries into the destination dictionary.
 
@@ -1288,7 +1291,22 @@
     try:
         kubernetes.core_api().create_namespace(namespace_obj)
     except kubernetes.api_exception() as e:
         if e.status == 409:
             logger.info(f'Namespace {namespace} already exists in the cluster.')
         else:
             raise
+
+
+def get_head_pod_name(cluster_name_on_cloud: str):
+    """Returns the pod name of the head pod for the given cluster name on cloud
+
+    Args:
+        cluster_name_on_cloud: Name of the cluster on cloud
+
+    Returns:
+        str: Pod name of the head pod
+    """
+    # We could have iterated over all pods in the namespace and checked for the
+    # label, but since we know the naming convention, we can directly return the
+    # head pod name.
+    return f'{cluster_name_on_cloud}-head'
```

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/logging.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/logging.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/metadata_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/metadata_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/paperspace/__init__.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/paperspace/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/paperspace/config.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/paperspace/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/paperspace/constants.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/paperspace/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/paperspace/instance.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/paperspace/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/paperspace/utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/paperspace/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/provisioner.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/provisioner.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/runpod/instance.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/runpod/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/runpod/utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/runpod/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/__init__.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/common/cls_api_client.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/common/cls_api_client.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/common/cls_api_helper.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/common/cls_api_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/common/metadata_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/common/metadata_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/common/service_manager.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/common/service_manager.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/common/service_manager_factory.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/common/service_manager_factory.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/common/ssl_helper.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/common/ssl_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/common/vapiconnect.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/common/vapiconnect.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/common/vim_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/common/vim_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/instance.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/provision/vsphere/vsphere_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/provision/vsphere/vsphere_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/resources.py` & `skypilot_nightly-1.0.0.dev20240502/sky/resources.py`

 * *Files 3% similar despite different names*

```diff
@@ -40,15 +40,15 @@
     * as a "filter" to get concrete launchable instances
     * for calculating billing
     * for provisioning on a cloud
 
     """
     # If any fields changed, increment the version. For backward compatibility,
     # modify the __setstate__ method to handle the old version.
-    _VERSION = 16
+    _VERSION = 17
 
     def __init__(
         self,
         cloud: Optional[clouds.Cloud] = None,
         instance_type: Optional[str] = None,
         cpus: Union[None, int, float, str] = None,
         memory: Union[None, int, float, str] = None,
@@ -58,14 +58,15 @@
         spot_recovery: Optional[str] = None,
         region: Optional[str] = None,
         zone: Optional[str] = None,
         image_id: Union[Dict[str, str], str, None] = None,
         disk_size: Optional[int] = None,
         disk_tier: Optional[Union[str, resources_utils.DiskTier]] = None,
         ports: Optional[Union[int, str, List[str], Tuple[str]]] = None,
+        labels: Optional[Dict[str, str]] = None,
         # Internal use only.
         # pylint: disable=invalid-name
         _docker_login_config: Optional[docker_utils.DockerLoginConfig] = None,
         _is_image_managed: Optional[bool] = None,
         _requires_fuse: Optional[bool] = None,
     ):
         """Initialize a Resources object.
@@ -126,15 +127,21 @@
                 'us-east1': 'ami-1234567890abcdef0'
               }
 
           disk_size: the size of the OS disk in GiB.
           disk_tier: the disk performance tier to use. If None, defaults to
             ``'medium'``.
           ports: the ports to open on the instance.
-          _docker_login_config: the docker configuration to use. This include
+          labels: the labels to apply to the instance. These are useful for
+            assigning metadata that may be used by external tools.
+            Implementation depends on the chosen cloud - On AWS, labels map to
+            instance tags. On GCP, labels map to instance labels. On
+            Kubernetes, labels map to pod labels. On other clouds, labels are
+            not supported and will be ignored.
+          _docker_login_config: the docker configuration to use. This includes
             the docker username, password, and registry server. If None, skip
             docker login.
           _requires_fuse: whether the task requires FUSE mounting support. This
             is used internally by certain cloud implementations to do additional
             setup for FUSE mounting. This flag also safeguards against using
             FUSE mounting on existing clusters that do not support it. If None,
             defaults to False.
@@ -201,28 +208,31 @@
                 [str(port) for port in ports])
             if not ports:
                 # Set to None if empty. This is mainly for resources from
                 # cli, which will comes in as an empty tuple.
                 ports = None
         self._ports = ports
 
+        self._labels = labels
+
         self._docker_login_config = _docker_login_config
 
         self._requires_fuse = _requires_fuse
 
         self._set_cpus(cpus)
         self._set_memory(memory)
         self._set_accelerators(accelerators, accelerator_args)
 
         self._try_validate_instance_type()
         self._try_validate_cpus_mem()
         self._try_validate_spot()
         self._try_validate_image_id()
         self._try_validate_disk_tier()
         self._try_validate_ports()
+        self._try_validate_labels()
 
     # When querying the accelerators inside this func (we call self.accelerators
     # which is a @property), we will check the cloud's catalog, which can error
     # if it fails to fetch some account specific catalog information (e.g., AWS
     # zone mapping). It is fine to use the default catalog as this function is
     # only for display purposes.
     @service_catalog.fallback_to_default_catalog
@@ -414,14 +424,18 @@
         return self._disk_tier
 
     @property
     def ports(self) -> Optional[List[str]]:
         return self._ports
 
     @property
+    def labels(self) -> Optional[Dict[str, str]]:
+        return self._labels
+
+    @property
     def is_image_managed(self) -> Optional[bool]:
         return self._is_image_managed
 
     @property
     def requires_fuse(self) -> bool:
         if self._requires_fuse is None:
             return False
@@ -928,14 +942,42 @@
                     raise ValueError(
                         'No enabled clouds support opening ports. To fix: '
                         'do not specify resources.ports, or enable a cloud '
                         'that does support this feature.')
         # We don't need to check the ports format since we already done it
         # in resources_utils.simplify_ports
 
+    def _try_validate_labels(self) -> None:
+        """Try to validate the labels attribute.
+
+        Raises:
+            ValueError: if the attribute is invalid.
+        """
+        if not self._labels:
+            return
+
+        if self.cloud is None:
+            # Because each cloud has its own label format, we cannot validate
+            # the labels without knowing the cloud.
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError(
+                    'Cloud must be specified when labels are provided.')
+
+        # Check if the label key value pairs are valid.
+        invalid_table = log_utils.create_table(['Label', 'Reason'])
+        for key, value in self._labels.items():
+            valid, err_msg = self.cloud.is_label_valid(key, value)
+            if not valid:
+                invalid_table.add_row([f'{key}: {value}', err_msg])
+        if len(invalid_table.rows) > 0:
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError(
+                    'The following labels are invalid:'
+                    '\n\t' + invalid_table.get_string().replace('\n', '\n\t'))
+
     def get_cost(self, seconds: float) -> float:
         """Returns cost in USD for the runtime in seconds."""
         hours = seconds / 3600
         # Instance.
         hourly_cost = self.cloud.instance_type_to_hourly_cost(
             self._instance_type, self.use_spot, self._region, self._zone)
         # Accelerators (if any).
@@ -1154,14 +1196,15 @@
             spot_recovery=override.pop('spot_recovery', self.spot_recovery),
             disk_size=override.pop('disk_size', self.disk_size),
             region=override.pop('region', self.region),
             zone=override.pop('zone', self.zone),
             image_id=override.pop('image_id', self.image_id),
             disk_tier=override.pop('disk_tier', self.disk_tier),
             ports=override.pop('ports', self.ports),
+            labels=override.pop('labels', self.labels),
             _docker_login_config=override.pop('_docker_login_config',
                                               self._docker_login_config),
             _is_image_managed=override.pop('_is_image_managed',
                                            self._is_image_managed),
             _requires_fuse=override.pop('_requires_fuse', self._requires_fuse),
         )
         assert len(override) == 0
@@ -1206,15 +1249,26 @@
 
         def _override_resources(
                 base_resource_config: Dict[str, Any],
                 override_configs: List[Dict[str, Any]]) -> List[Resources]:
             resources_list = []
             for override_config in override_configs:
                 new_resource_config = base_resource_config.copy()
+                # Labels are handled separately.
+                override_labels = override_config.pop('labels', None)
                 new_resource_config.update(override_config)
+
+                # Update the labels with the override labels.
+                labels = new_resource_config.get('labels', None)
+                if labels is not None and override_labels is not None:
+                    labels.update(override_labels)
+                elif override_labels is not None:
+                    labels = override_labels
+                new_resource_config['labels'] = labels
+
                 # Call from_yaml_config again instead of
                 # _from_yaml_config_single to handle the case, where both
                 # multiple accelerators and `any_of` is specified.
                 # This will not cause infinite recursion because we have made
                 # sure that `any_of` and `ordered` cannot be specified in the
                 # resource candidates in `any_of` or `ordered`, by the schema
                 # validation above.
@@ -1293,14 +1347,15 @@
         resources_fields['spot_recovery'] = config.pop('spot_recovery', None)
         resources_fields['disk_size'] = config.pop('disk_size', None)
         resources_fields['region'] = config.pop('region', None)
         resources_fields['zone'] = config.pop('zone', None)
         resources_fields['image_id'] = config.pop('image_id', None)
         resources_fields['disk_tier'] = config.pop('disk_tier', None)
         resources_fields['ports'] = config.pop('ports', None)
+        resources_fields['labels'] = config.pop('labels', None)
         resources_fields['_docker_login_config'] = config.pop(
             '_docker_login_config', None)
         resources_fields['_is_image_managed'] = config.pop(
             '_is_image_managed', None)
         resources_fields['_requires_fuse'] = config.pop('_requires_fuse', None)
 
         if resources_fields['cpus'] is not None:
@@ -1337,14 +1392,15 @@
         add_if_not_none('disk_size', self.disk_size)
         add_if_not_none('region', self.region)
         add_if_not_none('zone', self.zone)
         add_if_not_none('image_id', self.image_id)
         if self.disk_tier is not None:
             config['disk_tier'] = self.disk_tier.value
         add_if_not_none('ports', self.ports)
+        add_if_not_none('labels', self.labels)
         if self._docker_login_config is not None:
             config['_docker_login_config'] = dataclasses.asdict(
                 self._docker_login_config)
         if self._is_image_managed is not None:
             config['_is_image_managed'] = self._is_image_managed
         if self._requires_fuse is not None:
             config['_requires_fuse'] = self._requires_fuse
@@ -1447,8 +1503,11 @@
 
         if version < 16:
             # Kubernetes clusters launched prior to version 16 run in privileged
             # mode and have FUSE support enabled by default. As a result, we
             # set the default to True for backward compatibility.
             state['_requires_fuse'] = state.get('_requires_fuse', True)
 
+        if version < 17:
+            state['_labels'] = state.get('_labels', None)
+
         self.__dict__.update(state)
```

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/serve/__init__.py` & `skypilot_nightly-1.0.0.dev20240502/sky/serve/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/serve/autoscalers.py` & `skypilot_nightly-1.0.0.dev20240502/sky/serve/autoscalers.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/serve/constants.py` & `skypilot_nightly-1.0.0.dev20240502/sky/serve/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/serve/controller.py` & `skypilot_nightly-1.0.0.dev20240502/sky/serve/controller.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/serve/core.py` & `skypilot_nightly-1.0.0.dev20240502/sky/serve/core.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/serve/load_balancer.py` & `skypilot_nightly-1.0.0.dev20240502/sky/serve/load_balancer.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/serve/load_balancing_policies.py` & `skypilot_nightly-1.0.0.dev20240502/sky/serve/load_balancing_policies.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/serve/replica_managers.py` & `skypilot_nightly-1.0.0.dev20240502/sky/serve/replica_managers.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/serve/serve_state.py` & `skypilot_nightly-1.0.0.dev20240502/sky/serve/serve_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/serve/serve_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/serve/serve_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/serve/service.py` & `skypilot_nightly-1.0.0.dev20240502/sky/serve/service.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/serve/service_spec.py` & `skypilot_nightly-1.0.0.dev20240502/sky/serve/service_spec.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/setup_files/MANIFEST.in` & `skypilot_nightly-1.0.0.dev20240502/sky/setup_files/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/setup_files/setup.py` & `skypilot_nightly-1.0.0.dev20240502/sky/setup_files/setup.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/sky_logging.py` & `skypilot_nightly-1.0.0.dev20240502/sky/sky_logging.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/LICENSE` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/attempt_skylet.py` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/attempt_skylet.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/autostop_lib.py` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/autostop_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/configs.py` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/configs.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/constants.py` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/events.py` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/events.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/job_lib.py` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/job_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/log_lib.py` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/log_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/log_lib.pyi` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/log_lib.pyi`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/azure/azure-config-template.json` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/azure/azure-config-template.json`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/azure/azure-vm-template.json` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/azure/azure-vm-template.json`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/azure/config.py` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/azure/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/azure/node_provider.py` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/azure/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/command_runner.py` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/command_runner.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/ibm/node_provider.py` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/ibm/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/ibm/utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/ibm/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/ibm/vpc_provider.py` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/ibm/vpc_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/lambda_cloud/node_provider.py` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/lambda_cloud/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/oci/node_provider.py` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/oci/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/oci/query_helper.py` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/oci/query_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/scp/config.py` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/scp/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/providers/scp/node_provider.py` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/providers/scp/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/ray_patches/__init__.py` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/ray_patches/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/ray_patches/log_monitor.py.patch` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/ray_patches/log_monitor.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/ray_patches/resource_demand_scheduler.py.patch` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/ray_patches/resource_demand_scheduler.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/ray_patches/worker.py.patch` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/ray_patches/worker.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/skylet.py` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/skylet.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skylet/subprocess_daemon.py` & `skypilot_nightly-1.0.0.dev20240502/sky/skylet/subprocess_daemon.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/skypilot_config.py` & `skypilot_nightly-1.0.0.dev20240502/sky/skypilot_config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/spot/__init__.py` & `skypilot_nightly-1.0.0.dev20240502/sky/spot/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/spot/constants.py` & `skypilot_nightly-1.0.0.dev20240502/sky/spot/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/spot/controller.py` & `skypilot_nightly-1.0.0.dev20240502/sky/spot/controller.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/spot/core.py` & `skypilot_nightly-1.0.0.dev20240502/sky/spot/core.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/spot/dashboard/dashboard.py` & `skypilot_nightly-1.0.0.dev20240502/sky/spot/dashboard/dashboard.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/spot/dashboard/static/favicon.ico` & `skypilot_nightly-1.0.0.dev20240502/sky/spot/dashboard/static/favicon.ico`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/spot/dashboard/templates/index.html` & `skypilot_nightly-1.0.0.dev20240502/sky/spot/dashboard/templates/index.html`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/spot/recovery_strategy.py` & `skypilot_nightly-1.0.0.dev20240502/sky/spot/recovery_strategy.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/spot/spot_state.py` & `skypilot_nightly-1.0.0.dev20240502/sky/spot/spot_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/spot/spot_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/spot/spot_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/status_lib.py` & `skypilot_nightly-1.0.0.dev20240502/sky/status_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/task.py` & `skypilot_nightly-1.0.0.dev20240502/sky/task.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/templates/aws-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240502/sky/templates/aws-ray.yml.j2`

 * *Files 2% similar despite different names*

```diff
@@ -110,18 +110,18 @@
             content: |
               APT::Periodic::Enable "0";
       TagSpecifications:
         - ResourceType: instance
           Tags:
             - Key: skypilot-user
               Value: {{ user }}
-{%- for tag_key, tag_value in instance_tags.items() %}
-            - Key: {{ tag_key }}
-              Value: {{ tag_value|tojson }}
-{%- endfor %}
+            {%- for label_key, label_value in labels.items() %}
+            - Key: {{ label_key }}
+              Value: {{ label_value|tojson }}
+            {%- endfor %}
 
 head_node_type: ray.head.default
 
 # Format: `REMOTE_PATH : LOCAL_PATH`
 file_mounts: {
   "{{sky_ray_yaml_remote_path}}": "{{sky_ray_yaml_local_path}}",
   "{{sky_remote_path}}/{{sky_wheel_hash}}": "{{sky_local_path}}",
```

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/templates/azure-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240502/sky/templates/azure-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/templates/cudo-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240502/sky/templates/cudo-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/templates/fluidstack-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240502/sky/templates/fluidstack-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/templates/gcp-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240502/sky/templates/gcp-ray.yml.j2`

 * *Files 2% similar despite different names*

```diff
@@ -72,16 +72,16 @@
 
 available_node_types:
   ray_head_default:
     resources: {}
     node_config:
       labels:
         skypilot-user: {{ user }}
-      {%- for tag_key, tag_value in instance_tags.items() %}
-        {{ tag_key }}: {{ tag_value|tojson }}
+      {%- for label_key, label_value in labels.items() %}
+        {{ label_key }}: {{ label_value|tojson }}
       {%- endfor %}
       {%- if specific_reservations %}
       reservationAffinity:
         consumeReservationType: SPECIFIC_RESERVATION
         key: compute.googleapis.com/reservation-name
         values: {{ specific_reservations }}
       {%- endif %}
```

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/templates/ibm-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240502/sky/templates/ibm-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/templates/kubernetes-ingress.yml.j2` & `skypilot_nightly-1.0.0.dev20240502/sky/templates/kubernetes-ingress.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/templates/kubernetes-port-forward-proxy-command.sh.j2` & `skypilot_nightly-1.0.0.dev20240502/sky/templates/kubernetes-port-forward-proxy-command.sh.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/templates/kubernetes-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240502/sky/templates/kubernetes-ray.yml.j2`

 * *Files 2% similar despite different names*

```diff
@@ -140,14 +140,18 @@
         # service is required.
         labels:
             parent: skypilot
             # component will be set for the head node pod to be the same as the head node service selector above if a 
             skypilot-cluster: {{cluster_name_on_cloud}}
             # Identifies the SSH jump pod used by this pod. Used in life cycle management of the ssh jump pod.
             skypilot-ssh-jump: {{k8s_ssh_jump_name}}
+            # Custom tags for the pods
+            {%- for label_key, label_value in labels.items() %}
+            {{ label_key }}: {{ label_value }}
+            {%- endfor %}
         {% if k8s_fuse_device_required %}
         annotations:
             # Required for FUSE mounting to access /dev/fuse
             container.apparmor.security.beta.kubernetes.io/ray-node: unconfined
         {% endif %}
       spec:
         # Change this if you altered the autoscaler_service_account above
```

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/templates/kubernetes-ssh-jump.yml.j2` & `skypilot_nightly-1.0.0.dev20240502/sky/templates/kubernetes-ssh-jump.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/templates/lambda-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240502/sky/templates/lambda-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/templates/local-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240502/sky/templates/local-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/templates/oci-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240502/sky/templates/oci-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/templates/paperspace-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240502/sky/templates/paperspace-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/templates/runpod-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240502/sky/templates/runpod-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/templates/scp-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240502/sky/templates/scp-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/templates/sky-serve-controller.yaml.j2` & `skypilot_nightly-1.0.0.dev20240502/sky/templates/sky-serve-controller.yaml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/templates/spot-controller.yaml.j2` & `skypilot_nightly-1.0.0.dev20240502/sky/templates/spot-controller.yaml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/templates/vsphere-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240502/sky/templates/vsphere-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/usage/constants.py` & `skypilot_nightly-1.0.0.dev20240502/sky/usage/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/usage/usage_lib.py` & `skypilot_nightly-1.0.0.dev20240502/sky/usage/usage_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/accelerator_registry.py` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/accelerator_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/cli_utils/status_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/cli_utils/status_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/cluster_yaml_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/cluster_yaml_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/command_runner.py` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/command_runner.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/command_runner.pyi` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/command_runner.pyi`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/common_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/common_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/controller_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/controller_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/dag_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/dag_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/db_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/db_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/env_options.py` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/env_options.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/kubernetes/create_cluster.sh` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/kubernetes/create_cluster.sh`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/kubernetes/delete_cluster.sh` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/kubernetes/delete_cluster.sh`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/kubernetes/generate_kind_config.py` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/kubernetes/generate_kind_config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/kubernetes/gpu_labeler.py` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/kubernetes/gpu_labeler.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/kubernetes_enums.py` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/kubernetes_enums.py`

 * *Files 2% similar despite different names*

```diff
@@ -31,7 +31,8 @@
 
 class KubernetesPortMode(enum.Enum):
     """Enum for the different types of modes supported for opening
     ports on Kubernetes.
     """
     INGRESS = 'ingress'
     LOADBALANCER = 'loadbalancer'
+    PODIP = 'podip'
```

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/log_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/log_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/resources_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/resources_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/rich_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/rich_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/schemas.py` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/schemas.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,14 +1,38 @@
 """This module contains schemas used to validate objects.
 
 Schemas conform to the JSON Schema specification as defined at
 https://json-schema.org/
 """
 
 
+def _check_not_both_fields_present(field1: str, field2: str):
+    return {
+        'oneOf': [{
+            'required': [field1],
+            'not': {
+                'required': [field2]
+            }
+        }, {
+            'required': [field2],
+            'not': {
+                'required': [field1]
+            }
+        }, {
+            'not': {
+                'anyOf': [{
+                    'required': [field1]
+                }, {
+                    'required': [field2]
+                }]
+            }
+        }]
+    }
+
+
 def _get_single_resources_schema():
     """Schema for a single resource in a resources list."""
     # To avoid circular imports, only import when needed.
     # pylint: disable=import-outside-toplevel
     from sky.clouds import service_catalog
     return {
         '$schema': 'https://json-schema.org/draft/2020-12/schema',
@@ -79,14 +103,20 @@
                             'type': 'string',
                         }, {
                             'type': 'integer',
                         }]
                     }
                 }],
             },
+            'labels': {
+                'type': 'object',
+                'additionalProperties': {
+                    'type': 'string'
+                }
+            },
             'accelerator_args': {
                 'type': 'object',
                 'required': [],
                 'additionalProperties': False,
                 'properties': {
                     'runtime_version': {
                         'type': 'string',
@@ -130,18 +160,29 @@
             '_requires_fuse': {
                 'type': 'boolean',
             },
         }
     }
 
 
+def _get_multi_resources_schema():
+    multi_resources_schema = {
+        k: v
+        for k, v in _get_single_resources_schema().items()
+        # Validation may fail if $schema is included.
+        if k != '$schema'
+    }
+    return multi_resources_schema
+
+
 def get_resources_schema():
     """Resource schema in task config."""
     single_resources_schema = _get_single_resources_schema()['properties']
     single_resources_schema.pop('accelerators')
+    multi_resources_schema = _get_multi_resources_schema()
     return {
         '$schema': 'http://json-schema.org/draft-07/schema#',
         'type': 'object',
         'required': [],
         'additionalProperties': False,
         'properties': {
             **single_resources_schema,
@@ -167,29 +208,19 @@
                     'items': {
                         'type': 'string',
                     }
                 }]
             },
             'any_of': {
                 'type': 'array',
-                'items': {
-                    k: v
-                    for k, v in _get_single_resources_schema().items()
-                    # Validation may fail if $schema is included.
-                    if k != '$schema'
-                },
+                'items': multi_resources_schema,
             },
             'ordered': {
                 'type': 'array',
-                'items': {
-                    k: v
-                    for k, v in _get_single_resources_schema().items()
-                    # Validation may fail if $schema is included.
-                    if k != '$schema'
-                },
+                'items': multi_resources_schema,
             }
         }
     }
 
 
 def get_storage_schema():
     # pylint: disable=import-outside-toplevel
@@ -461,22 +492,31 @@
                     },
                 ]
             }
         }]
     },
 }
 
-_INSTANCE_TAGS_SCHEMA = {
+_LABELS_SCHEMA = {
+    # Deprecated: 'instance_tags' is replaced by 'labels'. Keeping for backward
+    # compatibility. Will be removed after 0.7.0.
     'instance_tags': {
         'type': 'object',
         'required': [],
         'additionalProperties': {
             'type': 'string',
         },
     },
+    'labels': {
+        'type': 'object',
+        'required': [],
+        'additionalProperties': {
+            'type': 'string',
+        },
+    }
 }
 
 _REMOTE_IDENTITY_SCHEMA = {
     'remote_identity': {
         'type': 'string',
         'case_insensitive_enum': ['LOCAL_CREDENTIALS', 'SERVICE_ACCOUNT'],
     }
@@ -514,17 +554,18 @@
             'type': 'object',
             'required': [],
             'additionalProperties': False,
             'properties': {
                 'security_group_name': {
                     'type': 'string',
                 },
-                **_INSTANCE_TAGS_SCHEMA,
+                **_LABELS_SCHEMA,
                 **_NETWORK_CONFIG_SCHEMA,
-            }
+            },
+            **_check_not_both_fields_present('instance_tags', 'labels')
         },
         'gcp': {
             'type': 'object',
             'required': [],
             'additionalProperties': False,
             'properties': {
                 'prioritize_reservations': {
@@ -532,17 +573,18 @@
                 },
                 'specific_reservations': {
                     'type': 'array',
                     'items': {
                         'type': 'string',
                     },
                 },
-                **_INSTANCE_TAGS_SCHEMA,
+                **_LABELS_SCHEMA,
                 **_NETWORK_CONFIG_SCHEMA,
-            }
+            },
+            **_check_not_both_fields_present('instance_tags', 'labels')
         },
         'kubernetes': {
             'type': 'object',
             'required': [],
             'additionalProperties': False,
             'properties': {
                 'networking': {
```

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/subprocess_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/subprocess_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/timeline.py` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/timeline.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/ux_utils.py` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/ux_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/sky/utils/validator.py` & `skypilot_nightly-1.0.0.dev20240502/sky/utils/validator.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/skypilot_nightly.egg-info/PKG-INFO` & `skypilot_nightly-1.0.0.dev20240502/skypilot_nightly.egg-info/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot-nightly
-Version: 1.0.0.dev20240501
+Version: 1.0.0.dev20240502
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
```

### Comparing `skypilot_nightly-1.0.0.dev20240501/skypilot_nightly.egg-info/SOURCES.txt` & `skypilot_nightly-1.0.0.dev20240502/skypilot_nightly.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/skypilot_nightly.egg-info/requires.txt` & `skypilot_nightly-1.0.0.dev20240502/skypilot_nightly.egg-info/requires.txt`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/tests/test_cli.py` & `skypilot_nightly-1.0.0.dev20240502/tests/test_cli.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/tests/test_config.py` & `skypilot_nightly-1.0.0.dev20240502/tests/test_config.py`

 * *Files 1% similar despite different names*

```diff
@@ -64,15 +64,15 @@
 
 
 def test_valid_null_proxy_config(monkeypatch, tmp_path) -> None:
     """Test that the config is not loaded if the config file is empty."""
     with open(tmp_path / 'valid.yaml', 'w', encoding='utf-8') as f:
         f.write(f"""\
         aws:
-            instance_tags:
+            labels:
                 mytag: myvalue
             ssh_proxy_command:
                 eu-west-1: null
                 us-east-1: null
             use_internal_ips: true
             vpc_name: abc
```

### Comparing `skypilot_nightly-1.0.0.dev20240501/tests/test_jobs.py` & `skypilot_nightly-1.0.0.dev20240502/tests/test_jobs.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/tests/test_list_accelerators.py` & `skypilot_nightly-1.0.0.dev20240502/tests/test_list_accelerators.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/tests/test_optimizer_dryruns.py` & `skypilot_nightly-1.0.0.dev20240502/tests/test_optimizer_dryruns.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/tests/test_optimizer_random_dag.py` & `skypilot_nightly-1.0.0.dev20240502/tests/test_optimizer_random_dag.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/tests/test_serve_autoscaler.py` & `skypilot_nightly-1.0.0.dev20240502/tests/test_serve_autoscaler.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/tests/test_smoke.py` & `skypilot_nightly-1.0.0.dev20240502/tests/test_smoke.py`

 * *Files 1% similar despite different names*

```diff
@@ -4634,8632 +4634,8832 @@
 00012190: 6363 6573 7322 203d 2066 616c 7365 205d  ccess" = false ]
 000121a0: 3b20 7468 656e 2065 7869 7420 313b 2066  ; then exit 1; f
 000121b0: 6927 2c0a 2020 2020 2020 2020 5d2c 0a20  i',.        ],. 
 000121c0: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
 000121d0: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
 000121e0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
 000121f0: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
-00012200: 2d2d 2d2d 2d2d 2d2d 2d20 5461 736b 3a20  --------- Task: 
-00012210: 6e3d 3220 6e6f 6465 7320 7769 7468 2073  n=2 nodes with s
-00012220: 6574 7570 732e 202d 2d2d 2d2d 2d2d 2d2d  etups. ---------
-00012230: 2d0a 4070 7974 6573 742e 6d61 726b 2e6e  -.@pytest.mark.n
-00012240: 6f5f 6c61 6d62 6461 5f63 6c6f 7564 2020  o_lambda_cloud  
-00012250: 2320 4c61 6d62 6461 2043 6c6f 7564 2064  # Lambda Cloud d
-00012260: 6f65 7320 6e6f 7420 6861 7665 2056 3130  oes not have V10
-00012270: 3020 6770 7573 0a40 7079 7465 7374 2e6d  0 gpus.@pytest.m
-00012280: 6172 6b2e 6e6f 5f69 626d 2020 2320 4942  ark.no_ibm  # IB
-00012290: 4d20 636c 6f75 6420 6375 7272 656e 746c  M cloud currentl
-000122a0: 7920 646f 6573 6e27 7420 7072 6f76 6964  y doesn't provid
-000122b0: 6520 7075 626c 6963 2069 6d61 6765 2077  e public image w
-000122c0: 6974 6820 4355 4441 0a40 7079 7465 7374  ith CUDA.@pytest
-000122d0: 2e6d 6172 6b2e 6e6f 5f73 6370 2020 2320  .mark.no_scp  # 
-000122e0: 5343 5020 646f 6573 206e 6f74 2073 7570  SCP does not sup
-000122f0: 706f 7274 206e 756d 5f6e 6f64 6573 203e  port num_nodes >
-00012300: 2031 2079 6574 0a40 7079 7465 7374 2e6d   1 yet.@pytest.m
-00012310: 6172 6b2e 736b 6970 280a 2020 2020 7265  ark.skip(.    re
-00012320: 6173 6f6e 3d0a 2020 2020 2754 6865 2072  ason=.    'The r
-00012330: 6573 6e65 745f 6469 7374 7269 6275 7465  esnet_distribute
-00012340: 645f 7466 5f61 7070 2069 7320 666c 616b  d_tf_app is flak
-00012350: 792c 2064 7565 2074 6f20 6974 2066 6169  y, due to it fai
-00012360: 6c69 6e67 2074 6f20 6465 7465 6374 2047  ling to detect G
-00012370: 5055 732e 2729 0a64 6566 2074 6573 745f  PUs.').def test_
-00012380: 6469 7374 7269 6275 7465 645f 7466 2867  distributed_tf(g
-00012390: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
-000123a0: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
-000123b0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-000123c0: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-000123d0: 7374 280a 2020 2020 2020 2020 2772 6573  st(.        'res
-000123e0: 6e65 745f 6469 7374 7269 6275 7465 645f  net_distributed_
-000123f0: 7466 5f61 7070 272c 0a20 2020 2020 2020  tf_app',.       
-00012400: 205b 0a20 2020 2020 2020 2020 2020 2023   [.            #
-00012410: 204e 4f54 453a 2072 756e 6e69 6e67 2069   NOTE: running i
-00012420: 7420 7477 6963 6520 7769 6c6c 2068 616e  t twice will han
-00012430: 6720 2873 6f6d 6574 696d 6573 3f29 202d  g (sometimes?) -
-00012440: 2061 6e20 6170 702d 6c65 7665 6c20 6275   an app-level bu
-00012450: 672e 0a20 2020 2020 2020 2020 2020 2066  g..            f
-00012460: 2770 7974 686f 6e20 6578 616d 706c 6573  'python examples
-00012470: 2f72 6573 6e65 745f 6469 7374 7269 6275  /resnet_distribu
-00012480: 7465 645f 7466 5f61 7070 2e70 7920 7b6e  ted_tf_app.py {n
-00012490: 616d 657d 207b 6765 6e65 7269 635f 636c  ame} {generic_cl
-000124a0: 6f75 647d 272c 0a20 2020 2020 2020 2020  oud}',.         
-000124b0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-000124c0: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
-000124d0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-000124e0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-000124f0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00012500: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00012510: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
-00012520: 2074 696d 656f 7574 3d32 3520 2a20 3630   timeout=25 * 60
-00012530: 2c20 2023 2032 3520 6d69 6e73 2028 6974  ,  # 25 mins (it
-00012540: 2074 616b 6573 2061 726f 756e 6420 7e31   takes around ~1
-00012550: 3920 6d69 6e73 290a 2020 2020 290a 2020  9 mins).    ).  
-00012560: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00012570: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-00012580: 2d2d 2d20 5465 7374 696e 6720 4743 5020  --- Testing GCP 
-00012590: 7374 6172 7420 616e 6420 7374 6f70 2069  start and stop i
-000125a0: 6e73 7461 6e63 6573 202d 2d2d 2d2d 2d2d  nstances -------
-000125b0: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
-000125c0: 2e67 6370 0a64 6566 2074 6573 745f 6763  .gcp.def test_gc
-000125d0: 705f 7374 6172 745f 7374 6f70 2829 3a0a  p_start_stop():.
-000125e0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-000125f0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00012600: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00012610: 2020 2020 2020 2020 2767 6370 2d73 7461          'gcp-sta
-00012620: 7274 2d73 746f 7027 2c0a 2020 2020 2020  rt-stop',.      
-00012630: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00012640: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00012650: 2d63 207b 6e61 6d65 7d20 6578 616d 706c  -c {name} exampl
-00012660: 6573 2f67 6370 5f73 7461 7274 5f73 746f  es/gcp_start_sto
-00012670: 702e 7961 6d6c 272c 0a20 2020 2020 2020  p.yaml',.       
-00012680: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00012690: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-000126a0: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-000126b0: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-000126c0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000126d0: 6b79 2065 7865 6320 7b6e 616d 657d 2065  ky exec {name} e
-000126e0: 7861 6d70 6c65 732f 6763 705f 7374 6172  xamples/gcp_star
-000126f0: 745f 7374 6f70 2e79 616d 6c27 2c0a 2020  t_stop.yaml',.  
-00012700: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00012710: 6c6f 6773 207b 6e61 6d65 7d20 3220 2d2d  logs {name} 2 --
-00012720: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-00012730: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
-00012740: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
-00012750: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-00012760: 6d65 7d20 2270 726c 696d 6974 202d 6e20  me} "prlimit -n 
-00012770: 2d2d 7069 643d 5c24 2870 6772 6570 202d  --pid=\$(pgrep -
-00012780: 6620 5c27 7261 796c 6574 2f72 6179 6c65  f \'raylet/rayle
-00012790: 7420 2d2d 7261 796c 6574 5f73 6f63 6b65  t --raylet_socke
-000127a0: 745f 6e61 6d65 5c27 2920 7c20 6772 6570  t_name\') | grep
-000127b0: 205c 2722 5c27 3130 3438 3537 3620 3130   \'"\'1048576 10
-000127c0: 3438 3537 365c 2722 5c27 2227 2c20 2023  48576\'"\'"',  #
-000127d0: 2045 6e73 7572 6520 7468 6520 7261 796c   Ensure the rayl
-000127e0: 6574 2070 726f 6365 7373 2068 6173 2074  et process has t
-000127f0: 6865 2063 6f72 7265 6374 2066 696c 6520  he correct file 
-00012800: 6465 7363 7269 7074 6f72 206c 696d 6974  descriptor limit
-00012810: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00012820: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00012830: 3320 2d2d 7374 6174 7573 272c 2020 2320  3 --status',  # 
-00012840: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-00012850: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-00012860: 2020 2020 2020 6627 736b 7920 7374 6f70        f'sky stop
-00012870: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00012880: 2020 2020 2020 2020 2066 2773 6c65 6570           f'sleep
-00012890: 2032 3027 2c0a 2020 2020 2020 2020 2020   20',.          
-000128a0: 2020 6627 736b 7920 7374 6172 7420 2d79    f'sky start -y
-000128b0: 207b 6e61 6d65 7d20 2d69 2031 272c 0a20   {name} -i 1',. 
-000128c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000128d0: 2065 7865 6320 7b6e 616d 657d 2065 7861   exec {name} exa
-000128e0: 6d70 6c65 732f 6763 705f 7374 6172 745f  mples/gcp_start_
-000128f0: 7374 6f70 2e79 616d 6c27 2c0a 2020 2020  stop.yaml',.    
-00012900: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00012910: 6773 207b 6e61 6d65 7d20 3420 2d2d 7374  gs {name} 4 --st
-00012920: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
-00012930: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
-00012940: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-00012950: 2773 6c65 6570 2031 3830 272c 0a20 2020  'sleep 180',.   
-00012960: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-00012970: 7461 7475 7320 2d72 207b 6e61 6d65 7d20  tatus -r {name} 
-00012980: 7c20 6772 6570 2022 494e 4954 5c7c 5354  | grep "INIT\|ST
-00012990: 4f50 5045 4422 272c 0a20 2020 2020 2020  OPPED"',.       
-000129a0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-000129b0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-000129c0: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
-000129d0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-000129e0: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
-000129f0: 6573 7469 6e67 2041 7a75 7265 2073 7461  esting Azure sta
-00012a00: 7274 2061 6e64 2073 746f 7020 696e 7374  rt and stop inst
-00012a10: 616e 6365 7320 2d2d 2d2d 2d2d 2d2d 2d2d  ances ----------
-00012a20: 0a40 7079 7465 7374 2e6d 6172 6b2e 617a  .@pytest.mark.az
-00012a30: 7572 650a 6465 6620 7465 7374 5f61 7a75  ure.def test_azu
-00012a40: 7265 5f73 7461 7274 5f73 746f 7028 293a  re_start_stop():
-00012a50: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00012a60: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-00012a70: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00012a80: 0a20 2020 2020 2020 2027 617a 7572 652d  .        'azure-
-00012a90: 7374 6172 742d 7374 6f70 272c 0a20 2020  start-stop',.   
-00012aa0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00012ab0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00012ac0: 2d79 202d 6320 7b6e 616d 657d 2065 7861  -y -c {name} exa
-00012ad0: 6d70 6c65 732f 617a 7572 655f 7374 6172  mples/azure_star
-00012ae0: 745f 7374 6f70 2e79 616d 6c27 2c0a 2020  t_stop.yaml',.  
-00012af0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00012b00: 6578 6563 207b 6e61 6d65 7d20 6578 616d  exec {name} exam
-00012b10: 706c 6573 2f61 7a75 7265 5f73 7461 7274  ples/azure_start
-00012b20: 5f73 746f 702e 7961 6d6c 272c 0a20 2020  _stop.yaml',.   
-00012b30: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00012b40: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-00012b50: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-00012b60: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-00012b70: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-00012b80: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00012b90: 657d 2022 7072 6c69 6d69 7420 2d6e 202d  e} "prlimit -n -
-00012ba0: 2d70 6964 3d5c 2428 7067 7265 7020 2d66  -pid=\$(pgrep -f
-00012bb0: 205c 2772 6179 6c65 742f 7261 796c 6574   \'raylet/raylet
-00012bc0: 202d 2d72 6179 6c65 745f 736f 636b 6574   --raylet_socket
-00012bd0: 5f6e 616d 655c 2729 207c 2067 7265 7020  _name\') | grep 
-00012be0: 5c27 225c 2731 3034 3835 3736 2031 3034  \'"\'1048576 104
-00012bf0: 3835 3736 5c27 225c 2722 272c 2020 2320  8576\'"\'"',  # 
-00012c00: 456e 7375 7265 2074 6865 2072 6179 6c65  Ensure the rayle
-00012c10: 7420 7072 6f63 6573 7320 6861 7320 7468  t process has th
-00012c20: 6520 636f 7272 6563 7420 6669 6c65 2064  e correct file d
-00012c30: 6573 6372 6970 746f 7220 6c69 6d69 742e  escriptor limit.
-00012c40: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00012c50: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
-00012c60: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
-00012c70: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
-00012c80: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
-00012c90: 2020 2020 2066 2773 6b79 2073 746f 7020       f'sky stop 
-00012ca0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-00012cb0: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-00012cc0: 6172 7420 2d79 207b 6e61 6d65 7d20 2d69  art -y {name} -i
-00012cd0: 2031 272c 0a20 2020 2020 2020 2020 2020   1',.           
-00012ce0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00012cf0: 657d 2065 7861 6d70 6c65 732f 617a 7572  e} examples/azur
-00012d00: 655f 7374 6172 745f 7374 6f70 2e79 616d  e_start_stop.yam
-00012d10: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00012d20: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00012d30: 7d20 3320 2d2d 7374 6174 7573 272c 2020  } 3 --status',  
-00012d40: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-00012d50: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-00012d60: 2020 2020 2020 2020 2773 6c65 6570 2032          'sleep 2
-00012d70: 3030 272c 0a20 2020 2020 2020 2020 2020  00',.           
-00012d80: 2066 2773 3d24 2873 6b79 2073 7461 7475   f's=$(sky statu
-00012d90: 7320 2d72 207b 6e61 6d65 7d29 2026 2620  s -r {name}) && 
-00012da0: 6563 686f 2024 7320 2626 2065 6368 6f20  echo $s && echo 
-00012db0: 2473 207c 2067 7265 7020 2249 4e49 545c  $s | grep "INIT\
-00012dc0: 7c53 544f 5050 4544 2227 0a20 2020 2020  |STOPPED"'.     
-00012dd0: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-00012de0: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-00012df0: 657d 272c 0a20 2020 2020 2020 2074 696d  e}',.        tim
-00012e00: 656f 7574 3d33 3020 2a20 3630 2c20 2023  eout=30 * 60,  #
-00012e10: 2033 3020 6d69 6e73 0a20 2020 2029 0a20   30 mins.    ). 
-00012e20: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00012e30: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-00012e40: 2d2d 2d2d 2054 6573 7469 6e67 2041 7574  ---- Testing Aut
-00012e50: 6f73 746f 7070 696e 6720 2d2d 2d2d 2d2d  ostopping ------
-00012e60: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
-00012e70: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b20  k.no_fluidstack 
-00012e80: 2023 2046 6c75 6964 5374 6163 6b20 646f   # FluidStack do
-00012e90: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-00012ea0: 746f 7070 696e 6720 696e 2053 6b79 5069  topping in SkyPi
-00012eb0: 6c6f 7420 696d 706c 656d 656e 7461 7469  lot implementati
-00012ec0: 6f6e 0a40 7079 7465 7374 2e6d 6172 6b2e  on.@pytest.mark.
-00012ed0: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
-00012ee0: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
-00012ef0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-00012f00: 2073 746f 7070 696e 6720 696e 7374 616e   stopping instan
-00012f10: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
-00012f20: 2e6e 6f5f 6962 6d20 2023 2046 4958 2849  .no_ibm  # FIX(I
-00012f30: 424d 2920 7370 6f72 6164 6963 616c 6c79  BM) sporadically
-00012f40: 2066 6169 6c73 2c20 6173 2072 6573 7461   fails, as resta
-00012f50: 7274 6564 2077 6f72 6b65 7273 2073 7461  rted workers sta
-00012f60: 7920 756e 696e 6974 6961 6c69 7a65 6420  y uninitialized 
-00012f70: 696e 6465 6669 6e69 7465 6c79 0a40 7079  indefinitely.@py
-00012f80: 7465 7374 2e6d 6172 6b2e 6e6f 5f73 6370  test.mark.no_scp
-00012f90: 2020 2320 5343 5020 646f 6573 206e 6f74    # SCP does not
-00012fa0: 2073 7570 706f 7274 206e 756d 5f6e 6f64   support num_nod
-00012fb0: 6573 203e 2031 2079 6574 0a40 7079 7465  es > 1 yet.@pyte
-00012fc0: 7374 2e6d 6172 6b2e 6e6f 5f6b 7562 6572  st.mark.no_kuber
-00012fd0: 6e65 7465 7320 2023 204b 7562 6572 6e65  netes  # Kuberne
-00012fe0: 7465 7320 646f 6573 206e 6f74 2061 7574  tes does not aut
-00012ff0: 6f73 746f 7020 7965 740a 6465 6620 7465  ostop yet.def te
-00013000: 7374 5f61 7574 6f73 746f 7028 6765 6e65  st_autostop(gene
-00013010: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
-00013020: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00013030: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-00013040: 2020 2020 2320 417a 7572 6520 7461 6b65      # Azure take
-00013050: 7320 7e20 376d 3135 7320 2834 3335 7329  s ~ 7m15s (435s)
-00013060: 2074 6f20 6175 746f 7374 6f70 2061 2056   to autostop a V
-00013070: 4d2c 2073 6f20 6865 7265 2077 6520 7573  M, so here we us
-00013080: 6520 3630 3020 746f 2065 6e73 7572 650a  e 600 to ensure.
-00013090: 2020 2020 2320 7468 6520 564d 2069 7320      # the VM is 
-000130a0: 7374 6f70 7065 642e 0a20 2020 2061 7574  stopped..    aut
-000130b0: 6f73 746f 705f 7469 6d65 6f75 7420 3d20  ostop_timeout = 
-000130c0: 3630 3020 6966 2067 656e 6572 6963 5f63  600 if generic_c
-000130d0: 6c6f 7564 203d 3d20 2761 7a75 7265 2720  loud == 'azure' 
-000130e0: 656c 7365 2032 3530 0a20 2020 2023 204c  else 250.    # L
-000130f0: 6175 6e63 6869 6e67 2061 6e64 2073 7461  aunching and sta
-00013100: 7274 696e 6720 417a 7572 6520 636c 7573  rting Azure clus
-00013110: 7465 7273 2063 616e 2074 616b 6520 6120  ters can take a 
-00013120: 6c6f 6e67 2074 696d 6520 746f 6f2e 2065  long time too. e
-00013130: 2e67 2e2c 2072 6573 7461 7274 0a20 2020  .g., restart.   
-00013140: 2023 2061 2073 746f 7070 6564 2041 7a75   # a stopped Azu
-00013150: 7265 2063 6c75 7374 6572 2063 616e 2074  re cluster can t
-00013160: 616b 6520 376d 2e20 536f 2077 6520 7365  ake 7m. So we se
-00013170: 7420 7468 6520 746f 7461 6c20 7469 6d65  t the total time
-00013180: 6f75 7420 746f 2037 306d 2e0a 2020 2020  out to 70m..    
-00013190: 746f 7461 6c5f 7469 6d65 6f75 745f 6d69  total_timeout_mi
-000131a0: 6e75 7465 7320 3d20 3730 2069 6620 6765  nutes = 70 if ge
-000131b0: 6e65 7269 635f 636c 6f75 6420 3d3d 2027  neric_cloud == '
-000131c0: 617a 7572 6527 2065 6c73 6520 3230 0a20  azure' else 20. 
-000131d0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-000131e0: 2020 2020 2020 2020 2761 7574 6f73 746f          'autosto
-000131f0: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
-00013200: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00013210: 6c61 756e 6368 202d 7920 2d64 202d 6320  launch -y -d -c 
-00013220: 7b6e 616d 657d 202d 2d6e 756d 2d6e 6f64  {name} --num-nod
-00013230: 6573 2032 202d 2d63 6c6f 7564 207b 6765  es 2 --cloud {ge
-00013240: 6e65 7269 635f 636c 6f75 647d 2074 6573  neric_cloud} tes
-00013250: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
-00013260: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-00013270: 2020 2020 2020 2020 2066 2773 6b79 2061           f'sky a
-00013280: 7574 6f73 746f 7020 2d79 207b 6e61 6d65  utostop -y {name
-00013290: 7d20 2d69 2031 272c 0a0a 2020 2020 2020  } -i 1',..      
-000132a0: 2020 2020 2020 2320 456e 7375 7265 2061        # Ensure a
-000132b0: 7574 6f73 746f 7020 6973 2073 6574 2e0a  utostop is set..
-000132c0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000132d0: 7920 7374 6174 7573 207c 2067 7265 7020  y status | grep 
-000132e0: 7b6e 616d 657d 207c 2067 7265 7020 2231  {name} | grep "1
-000132f0: 6d22 272c 0a0a 2020 2020 2020 2020 2020  m"',..          
-00013300: 2020 2320 456e 7375 7265 2074 6865 2063    # Ensure the c
-00013310: 6c75 7374 6572 2069 7320 6e6f 7420 7374  luster is not st
-00013320: 6f70 7065 6420 6561 726c 792e 0a20 2020  opped early..   
-00013330: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00013340: 3430 272c 0a20 2020 2020 2020 2020 2020  40',.           
-00013350: 2066 2773 3d24 2873 6b79 2073 7461 7475   f's=$(sky statu
-00013360: 7320 7b6e 616d 657d 202d 2d72 6566 7265  s {name} --refre
-00013370: 7368 293b 2065 6368 6f20 2224 7322 3b20  sh); echo "$s"; 
-00013380: 6563 686f 3b20 6563 686f 3b20 6563 686f  echo; echo; echo
-00013390: 2022 2473 2220 207c 2067 7265 7020 7b6e   "$s"  | grep {n
-000133a0: 616d 657d 207c 2067 7265 7020 5550 272c  ame} | grep UP',
-000133b0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-000133c0: 456e 7375 7265 2074 6865 2063 6c75 7374  Ensure the clust
-000133d0: 6572 2069 7320 5354 4f50 5045 442e 0a20  er is STOPPED.. 
-000133e0: 2020 2020 2020 2020 2020 2066 2773 6c65             f'sle
-000133f0: 6570 207b 6175 746f 7374 6f70 5f74 696d  ep {autostop_tim
-00013400: 656f 7574 7d27 2c0a 2020 2020 2020 2020  eout}',.        
-00013410: 2020 2020 6627 733d 2428 736b 7920 7374      f's=$(sky st
-00013420: 6174 7573 207b 6e61 6d65 7d20 2d2d 7265  atus {name} --re
-00013430: 6672 6573 6829 3b20 6563 686f 2022 2473  fresh); echo "$s
-00013440: 223b 2065 6368 6f3b 2065 6368 6f3b 2065  "; echo; echo; e
-00013450: 6368 6f20 2224 7322 2020 7c20 6772 6570  cho "$s"  | grep
-00013460: 207b 6e61 6d65 7d20 7c20 6772 6570 2053   {name} | grep S
-00013470: 544f 5050 4544 272c 0a0a 2020 2020 2020  TOPPED',..      
-00013480: 2020 2020 2020 2320 456e 7375 7265 2074        # Ensure t
-00013490: 6865 2063 6c75 7374 6572 2069 7320 5550  he cluster is UP
-000134a0: 2061 6e64 2074 6865 2061 7574 6f73 746f   and the autosto
-000134b0: 7020 7365 7474 696e 6720 6973 2072 6573  p setting is res
-000134c0: 6574 2028 272d 2729 2e0a 2020 2020 2020  et ('-')..      
-000134d0: 2020 2020 2020 6627 736b 7920 7374 6172        f'sky star
-000134e0: 7420 2d79 207b 6e61 6d65 7d27 2c0a 2020  t -y {name}',.  
-000134f0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00013500: 7374 6174 7573 207c 2067 7265 7020 7b6e  status | grep {n
-00013510: 616d 657d 207c 2067 7265 7020 2d45 2022  ame} | grep -E "
-00013520: 5550 5c73 2b2d 2227 2c0a 0a20 2020 2020  UP\s+-"',..     
-00013530: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
-00013540: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-00013550: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
-00013560: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00013570: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-00013580: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
-00013590: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000135a0: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
-000135b0: 202d 2d73 7461 7475 7327 2c0a 0a20 2020   --status',..   
-000135c0: 2020 2020 2020 2020 2023 2054 6573 7420           # Test 
-000135d0: 7265 7374 6172 7469 6e67 2074 6865 2069  restarting the i
-000135e0: 646c 656e 6573 7320 7469 6d65 7220 7669  dleness timer vi
-000135f0: 6120 7265 7365 743a 0a20 2020 2020 2020  a reset:.       
-00013600: 2020 2020 2066 2773 6b79 2061 7574 6f73       f'sky autos
-00013610: 746f 7020 2d79 207b 6e61 6d65 7d20 2d69  top -y {name} -i
-00013620: 2031 272c 2020 2320 4964 6c65 6e65 7373   1',  # Idleness
-00013630: 2073 7461 7274 7320 636f 756e 7469 6e67   starts counting
-00013640: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
-00013650: 6c65 6570 2034 3027 2c20 2023 2041 6c6d  leep 40',  # Alm
-00013660: 6f73 7420 7265 6163 6865 6420 7468 6520  ost reached the 
-00013670: 7468 7265 7368 6f6c 642e 0a20 2020 2020  threshold..     
-00013680: 2020 2020 2020 2066 2773 6b79 2061 7574         f'sky aut
-00013690: 6f73 746f 7020 2d79 207b 6e61 6d65 7d20  ostop -y {name} 
-000136a0: 2d69 2031 272c 2020 2320 5368 6f75 6c64  -i 1',  # Should
-000136b0: 2072 6573 7461 7274 2074 6865 2074 696d   restart the tim
-000136c0: 6572 2e0a 2020 2020 2020 2020 2020 2020  er..            
-000136d0: 2773 6c65 6570 2034 3027 2c0a 2020 2020  'sleep 40',.    
-000136e0: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-000136f0: 7920 7374 6174 7573 207b 6e61 6d65 7d20  y status {name} 
-00013700: 2d2d 7265 6672 6573 6829 3b20 6563 686f  --refresh); echo
-00013710: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
-00013720: 6f3b 2065 6368 6f20 2224 7322 207c 2067  o; echo "$s" | g
-00013730: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-00013740: 7020 5550 272c 0a20 2020 2020 2020 2020  p UP',.         
-00013750: 2020 2066 2773 6c65 6570 207b 6175 746f     f'sleep {auto
-00013760: 7374 6f70 5f74 696d 656f 7574 7d27 2c0a  stop_timeout}',.
-00013770: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
-00013780: 2428 736b 7920 7374 6174 7573 207b 6e61  $(sky status {na
-00013790: 6d65 7d20 2d2d 7265 6672 6573 6829 3b20  me} --refresh); 
-000137a0: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
-000137b0: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
-000137c0: 2020 7c20 6772 6570 207b 6e61 6d65 7d20    | grep {name} 
-000137d0: 7c20 6772 6570 2053 544f 5050 4544 272c  | grep STOPPED',
-000137e0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-000137f0: 5465 7374 2072 6573 7461 7274 696e 6720  Test restarting 
-00013800: 7468 6520 6964 6c65 6e65 7373 2074 696d  the idleness tim
-00013810: 6572 2076 6961 2065 7865 633a 0a20 2020  er via exec:.   
-00013820: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-00013830: 7461 7274 202d 7920 7b6e 616d 657d 272c  tart -y {name}',
-00013840: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00013850: 6b79 2073 7461 7475 7320 7c20 6772 6570  ky status | grep
-00013860: 207b 6e61 6d65 7d20 7c20 6772 6570 202d   {name} | grep -
-00013870: 4520 2255 505c 732b 2d22 272c 0a20 2020  E "UP\s+-"',.   
-00013880: 2020 2020 2020 2020 2066 2773 6b79 2061           f'sky a
-00013890: 7574 6f73 746f 7020 2d79 207b 6e61 6d65  utostop -y {name
-000138a0: 7d20 2d69 2031 272c 2020 2320 4964 6c65  } -i 1',  # Idle
-000138b0: 6e65 7373 2073 7461 7274 7320 636f 756e  ness starts coun
-000138c0: 7469 6e67 2e0a 2020 2020 2020 2020 2020  ting..          
-000138d0: 2020 2773 6c65 6570 2034 3527 2c20 2023    'sleep 45',  #
-000138e0: 2041 6c6d 6f73 7420 7265 6163 6865 6420   Almost reached 
-000138f0: 7468 6520 7468 7265 7368 6f6c 642e 0a20  the threshold.. 
-00013900: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00013910: 2065 7865 6320 7b6e 616d 657d 2065 6368   exec {name} ech
-00013920: 6f20 6869 272c 2020 2320 5368 6f75 6c64  o hi',  # Should
-00013930: 2072 6573 7461 7274 2074 6865 2074 696d   restart the tim
-00013940: 6572 2e0a 2020 2020 2020 2020 2020 2020  er..            
-00013950: 2773 6c65 6570 2034 3527 2c0a 2020 2020  'sleep 45',.    
-00013960: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-00013970: 7920 7374 6174 7573 207b 6e61 6d65 7d20  y status {name} 
-00013980: 2d2d 7265 6672 6573 6829 3b20 6563 686f  --refresh); echo
-00013990: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
-000139a0: 6f3b 2065 6368 6f20 2224 7322 2020 7c20  o; echo "$s"  | 
-000139b0: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
-000139c0: 6570 2055 5027 2c0a 2020 2020 2020 2020  ep UP',.        
-000139d0: 2020 2020 6627 736c 6565 7020 7b61 7574      f'sleep {aut
-000139e0: 6f73 746f 705f 7469 6d65 6f75 747d 272c  ostop_timeout}',
-000139f0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00013a00: 3d24 2873 6b79 2073 7461 7475 7320 7b6e  =$(sky status {n
-00013a10: 616d 657d 202d 2d72 6566 7265 7368 293b  ame} --refresh);
-00013a20: 2065 6368 6f20 2224 7322 3b20 6563 686f   echo "$s"; echo
-00013a30: 3b20 6563 686f 3b20 6563 686f 2022 2473  ; echo; echo "$s
-00013a40: 2220 207c 2067 7265 7020 7b6e 616d 657d  "  | grep {name}
-00013a50: 207c 2067 7265 7020 5354 4f50 5045 4427   | grep STOPPED'
-00013a60: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-00013a70: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-00013a80: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-00013a90: 2020 2020 7469 6d65 6f75 743d 746f 7461      timeout=tota
-00013aa0: 6c5f 7469 6d65 6f75 745f 6d69 6e75 7465  l_timeout_minute
-00013ab0: 7320 2a20 3630 2c0a 2020 2020 290a 2020  s * 60,.    ).  
-00013ac0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00013ad0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-00013ae0: 2d2d 2d20 5465 7374 696e 6720 4175 746f  --- Testing Auto
-00013af0: 646f 776e 696e 6720 2d2d 2d2d 2d2d 2d2d  downing --------
-00013b00: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
-00013b10: 6e6f 5f66 6c75 6964 7374 6163 6b20 2023  no_fluidstack  #
-00013b20: 2046 6c75 6964 5374 6163 6b20 646f 6573   FluidStack does
-00013b30: 206e 6f74 2073 7570 706f 7274 2073 746f   not support sto
-00013b40: 7070 696e 6720 696e 2053 6b79 5069 6c6f  pping in SkyPilo
-00013b50: 7420 696d 706c 656d 656e 7461 7469 6f6e  t implementation
-00013b60: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00013b70: 5f73 6370 2020 2320 5343 5020 646f 6573  _scp  # SCP does
-00013b80: 206e 6f74 2073 7570 706f 7274 206e 756d   not support num
-00013b90: 5f6e 6f64 6573 203e 2031 2079 6574 2e20  _nodes > 1 yet. 
-00013ba0: 5275 6e20 7465 7374 5f73 6370 5f61 7574  Run test_scp_aut
-00013bb0: 6f64 6f77 6e20 696e 7374 6561 642e 0a64  odown instead..d
-00013bc0: 6566 2074 6573 745f 6175 746f 646f 776e  ef test_autodown
-00013bd0: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
-00013be0: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
-00013bf0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00013c00: 6d65 2829 0a20 2020 2023 2041 7a75 7265  me().    # Azure
-00013c10: 2074 616b 6573 207e 2031 336d 3330 7320   takes ~ 13m30s 
-00013c20: 2838 3130 7329 2074 6f20 6175 746f 646f  (810s) to autodo
-00013c30: 776e 2061 2056 4d2c 2073 6f20 6865 7265  wn a VM, so here
-00013c40: 2077 6520 7573 6520 3930 3020 746f 2065   we use 900 to e
-00013c50: 6e73 7572 650a 2020 2020 2320 7468 6520  nsure.    # the 
-00013c60: 564d 2069 7320 7465 726d 696e 6174 6564  VM is terminated
-00013c70: 2e0a 2020 2020 6175 746f 646f 776e 5f74  ..    autodown_t
-00013c80: 696d 656f 7574 203d 2039 3030 2069 6620  imeout = 900 if 
-00013c90: 6765 6e65 7269 635f 636c 6f75 6420 3d3d  generic_cloud ==
-00013ca0: 2027 617a 7572 6527 2065 6c73 6520 3234   'azure' else 24
-00013cb0: 300a 2020 2020 746f 7461 6c5f 7469 6d65  0.    total_time
-00013cc0: 6f75 745f 6d69 6e75 7465 7320 3d20 3930  out_minutes = 90
-00013cd0: 2069 6620 6765 6e65 7269 635f 636c 6f75   if generic_clou
-00013ce0: 6420 3d3d 2027 617a 7572 6527 2065 6c73  d == 'azure' els
-00013cf0: 6520 3230 0a20 2020 2074 6573 7420 3d20  e 20.    test = 
-00013d00: 5465 7374 280a 2020 2020 2020 2020 2761  Test(.        'a
-00013d10: 7574 6f64 6f77 6e27 2c0a 2020 2020 2020  utodown',.      
-00013d20: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00013d30: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00013d40: 2d64 202d 6320 7b6e 616d 657d 202d 2d6e  -d -c {name} --n
-00013d50: 756d 2d6e 6f64 6573 2032 202d 2d63 6c6f  um-nodes 2 --clo
-00013d60: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
-00013d70: 647d 2074 6573 7473 2f74 6573 745f 7961  d} tests/test_ya
-00013d80: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
-00013d90: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00013da0: 2773 6b79 2061 7574 6f73 746f 7020 2d79  'sky autostop -y
-00013db0: 207b 6e61 6d65 7d20 2d2d 646f 776e 202d   {name} --down -
-00013dc0: 6920 3127 2c0a 2020 2020 2020 2020 2020  i 1',.          
-00013dd0: 2020 2320 456e 7375 7265 2061 7574 6f73    # Ensure autos
-00013de0: 746f 7020 6973 2073 6574 2e0a 2020 2020  top is set..    
-00013df0: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-00013e00: 6174 7573 207c 2067 7265 7020 7b6e 616d  atus | grep {nam
-00013e10: 657d 207c 2067 7265 7020 2231 6d20 2864  e} | grep "1m (d
-00013e20: 6f77 6e29 2227 2c0a 2020 2020 2020 2020  own)"',.        
-00013e30: 2020 2020 2320 456e 7375 7265 2074 6865      # Ensure the
-00013e40: 2063 6c75 7374 6572 2069 7320 6e6f 7420   cluster is not 
-00013e50: 7465 726d 696e 6174 6564 2065 6172 6c79  terminated early
-00013e60: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
-00013e70: 6c65 6570 2034 3027 2c0a 2020 2020 2020  leep 40',.      
-00013e80: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
-00013e90: 7374 6174 7573 207b 6e61 6d65 7d20 2d2d  status {name} --
-00013ea0: 7265 6672 6573 6829 3b20 6563 686f 2022  refresh); echo "
-00013eb0: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
-00013ec0: 2065 6368 6f20 2224 7322 2020 7c20 6772   echo "$s"  | gr
-00013ed0: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
-00013ee0: 2055 5027 2c0a 2020 2020 2020 2020 2020   UP',.          
-00013ef0: 2020 2320 456e 7375 7265 2074 6865 2063    # Ensure the c
-00013f00: 6c75 7374 6572 2069 7320 7465 726d 696e  luster is termin
-00013f10: 6174 6564 2e0a 2020 2020 2020 2020 2020  ated..          
-00013f20: 2020 6627 736c 6565 7020 7b61 7574 6f64    f'sleep {autod
-00013f30: 6f77 6e5f 7469 6d65 6f75 747d 272c 0a20  own_timeout}',. 
-00013f40: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-00013f50: 2853 4b59 5049 4c4f 545f 4445 4255 473d  (SKYPILOT_DEBUG=
-00013f60: 3020 736b 7920 7374 6174 7573 207b 6e61  0 sky status {na
-00013f70: 6d65 7d20 2d2d 7265 6672 6573 6829 2026  me} --refresh) &
-00013f80: 2620 6563 686f 2022 2473 2220 2626 207b  & echo "$s" && {
-00013f90: 7b20 6563 686f 2022 2473 2220 7c20 6772  { echo "$s" | gr
-00013fa0: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
-00013fb0: 2022 4175 746f 646f 776e 6564 2063 6c75   "Autodowned clu
-00013fc0: 7374 6572 5c7c 7465 726d 696e 6174 6564  ster\|terminated
-00013fd0: 206f 6e20 7468 6520 636c 6f75 6422 3b20   on the cloud"; 
-00013fe0: 7d7d 207c 7c20 7b7b 2065 6368 6f20 2224  }} || {{ echo "$
-00013ff0: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
-00014000: 2026 2620 6578 6974 2031 207c 7c20 6578   && exit 1 || ex
-00014010: 6974 2030 3b20 7d7d 272c 0a20 2020 2020  it 0; }}',.     
-00014020: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00014030: 6e63 6820 2d79 202d 6420 2d63 207b 6e61  nch -y -d -c {na
-00014040: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-00014050: 6572 6963 5f63 6c6f 7564 7d20 2d2d 6e75  eric_cloud} --nu
-00014060: 6d2d 6e6f 6465 7320 3220 2d2d 646f 776e  m-nodes 2 --down
-00014070: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-00014080: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
-00014090: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000140a0: 6b79 2073 7461 7475 7320 7c20 6772 6570  ky status | grep
-000140b0: 207b 6e61 6d65 7d20 7c20 6772 6570 2055   {name} | grep U
-000140c0: 5027 2c20 2023 2045 6e73 7572 6520 7468  P',  # Ensure th
-000140d0: 6520 636c 7573 7465 7220 6973 2055 502e  e cluster is UP.
-000140e0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000140f0: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-00014100: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-00014110: 636c 6f75 647d 2074 6573 7473 2f74 6573  cloud} tests/tes
-00014120: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
-00014130: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00014140: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
-00014150: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-00014160: 6772 6570 2022 316d 2028 646f 776e 2922  grep "1m (down)"
-00014170: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00014180: 2773 6c65 6570 207b 6175 746f 646f 776e  'sleep {autodown
-00014190: 5f74 696d 656f 7574 7d27 2c0a 2020 2020  _timeout}',.    
-000141a0: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
-000141b0: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
-000141c0: 7465 726d 696e 6174 6564 2e0a 2020 2020  terminated..    
-000141d0: 2020 2020 2020 2020 6627 733d 2428 534b          f's=$(SK
-000141e0: 5950 494c 4f54 5f44 4542 5547 3d30 2073  YPILOT_DEBUG=0 s
-000141f0: 6b79 2073 7461 7475 7320 7b6e 616d 657d  ky status {name}
-00014200: 202d 2d72 6566 7265 7368 2920 2626 2065   --refresh) && e
-00014210: 6368 6f20 2224 7322 2026 2620 7b7b 2065  cho "$s" && {{ e
-00014220: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-00014230: 7b6e 616d 657d 207c 2067 7265 7020 2241  {name} | grep "A
-00014240: 7574 6f64 6f77 6e65 6420 636c 7573 7465  utodowned cluste
-00014250: 725c 7c74 6572 6d69 6e61 7465 6420 6f6e  r\|terminated on
-00014260: 2074 6865 2063 6c6f 7564 223b 207d 7d20   the cloud"; }} 
-00014270: 7c7c 207b 7b20 6563 686f 2022 2473 2220  || {{ echo "$s" 
-00014280: 7c20 6772 6570 207b 6e61 6d65 7d20 2626  | grep {name} &&
-00014290: 2065 7869 7420 3120 7c7c 2065 7869 7420   exit 1 || exit 
-000142a0: 303b 207d 7d27 2c0a 2020 2020 2020 2020  0; }}',.        
-000142b0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-000142c0: 202d 7920 2d64 202d 6320 7b6e 616d 657d   -y -d -c {name}
-000142d0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-000142e0: 635f 636c 6f75 647d 202d 2d6e 756d 2d6e  c_cloud} --num-n
-000142f0: 6f64 6573 2032 202d 2d64 6f77 6e20 7465  odes 2 --down te
-00014300: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
-00014310: 696e 696d 616c 2e79 616d 6c27 2c0a 2020  inimal.yaml',.  
-00014320: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00014330: 6175 746f 7374 6f70 202d 7920 7b6e 616d  autostop -y {nam
-00014340: 657d 202d 2d63 616e 6365 6c27 2c0a 2020  e} --cancel',.  
-00014350: 2020 2020 2020 2020 2020 6627 736c 6565            f'slee
-00014360: 7020 7b61 7574 6f64 6f77 6e5f 7469 6d65  p {autodown_time
-00014370: 6f75 747d 272c 0a20 2020 2020 2020 2020  out}',.         
-00014380: 2020 2023 2045 6e73 7572 6520 7468 6520     # Ensure the 
-00014390: 636c 7573 7465 7220 6973 2073 7469 6c6c  cluster is still
-000143a0: 2055 502e 0a20 2020 2020 2020 2020 2020   UP..           
-000143b0: 2066 2773 3d24 2853 4b59 5049 4c4f 545f   f's=$(SKYPILOT_
-000143c0: 4445 4255 473d 3020 736b 7920 7374 6174  DEBUG=0 sky stat
-000143d0: 7573 207b 6e61 6d65 7d20 2d2d 7265 6672  us {name} --refr
-000143e0: 6573 6829 2026 2620 6563 686f 2022 2473  esh) && echo "$s
-000143f0: 2220 2626 2065 6368 6f20 2224 7322 207c  " && echo "$s" |
-00014400: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-00014410: 7265 7020 5550 272c 0a20 2020 2020 2020  rep UP',.       
-00014420: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-00014430: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-00014440: 272c 0a20 2020 2020 2020 2074 696d 656f  ',.        timeo
-00014450: 7574 3d74 6f74 616c 5f74 696d 656f 7574  ut=total_timeout
-00014460: 5f6d 696e 7574 6573 202a 2036 302c 0a20  _minutes * 60,. 
-00014470: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00014480: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-00014490: 7974 6573 742e 6d61 726b 2e73 6370 0a64  ytest.mark.scp.d
-000144a0: 6566 2074 6573 745f 7363 705f 6175 746f  ef test_scp_auto
-000144b0: 646f 776e 2829 3a0a 2020 2020 6e61 6d65  down():.    name
-000144c0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-000144d0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-000144e0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-000144f0: 2753 4350 5f61 7574 6f64 6f77 6e27 2c0a  'SCP_autodown',.
-00014500: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00014510: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00014520: 6368 202d 7920 2d64 202d 6320 7b6e 616d  ch -y -d -c {nam
-00014530: 657d 207b 5343 505f 5459 5045 7d20 7465  e} {SCP_TYPE} te
-00014540: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
-00014550: 696e 696d 616c 2e79 616d 6c27 2c0a 2020  inimal.yaml',.  
-00014560: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00014570: 6175 746f 7374 6f70 202d 7920 7b6e 616d  autostop -y {nam
-00014580: 657d 202d 2d64 6f77 6e20 2d69 2031 272c  e} --down -i 1',
-00014590: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
-000145a0: 6e73 7572 6520 6175 746f 7374 6f70 2069  nsure autostop i
-000145b0: 7320 7365 742e 0a20 2020 2020 2020 2020  s set..         
-000145c0: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
-000145d0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-000145e0: 6772 6570 2022 316d 2028 646f 776e 2922  grep "1m (down)"
-000145f0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-00014600: 2045 6e73 7572 6520 7468 6520 636c 7573   Ensure the clus
-00014610: 7465 7220 6973 206e 6f74 2074 6572 6d69  ter is not termi
-00014620: 6e61 7465 6420 6561 726c 792e 0a20 2020  nated early..   
-00014630: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00014640: 3435 272c 0a20 2020 2020 2020 2020 2020  45',.           
-00014650: 2066 2773 6b79 2073 7461 7475 7320 2d2d   f'sky status --
-00014660: 7265 6672 6573 6820 7c20 6772 6570 207b  refresh | grep {
-00014670: 6e61 6d65 7d20 7c20 6772 6570 2055 5027  name} | grep UP'
-00014680: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00014690: 456e 7375 7265 2074 6865 2063 6c75 7374  Ensure the clust
-000146a0: 6572 2069 7320 7465 726d 696e 6174 6564  er is terminated
-000146b0: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
-000146c0: 6c65 6570 2032 3030 272c 0a20 2020 2020  leep 200',.     
-000146d0: 2020 2020 2020 2066 2773 3d24 2853 4b59         f's=$(SKY
-000146e0: 5049 4c4f 545f 4445 4255 473d 3020 736b  PILOT_DEBUG=0 sk
-000146f0: 7920 7374 6174 7573 202d 2d72 6566 7265  y status --refre
-00014700: 7368 2920 2626 2070 7269 6e74 6620 2224  sh) && printf "$
-00014710: 7322 2026 2620 7b7b 2065 6368 6f20 2224  s" && {{ echo "$
-00014720: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
-00014730: 207c 2067 7265 7020 2241 7574 6f64 6f77   | grep "Autodow
-00014740: 6e65 6420 636c 7573 7465 725c 7c74 6572  ned cluster\|ter
-00014750: 6d69 6e61 7465 6420 6f6e 2074 6865 2063  minated on the c
-00014760: 6c6f 7564 223b 207d 7d20 7c7c 207b 7b20  loud"; }} || {{ 
-00014770: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-00014780: 207b 6e61 6d65 7d20 2626 2065 7869 7420   {name} && exit 
-00014790: 3120 7c7c 2065 7869 7420 303b 207d 7d27  1 || exit 0; }}'
-000147a0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000147b0: 736b 7920 6c61 756e 6368 202d 7920 2d64  sky launch -y -d
-000147c0: 202d 6320 7b6e 616d 657d 207b 5343 505f   -c {name} {SCP_
-000147d0: 5459 5045 7d20 2d2d 646f 776e 2074 6573  TYPE} --down tes
-000147e0: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
-000147f0: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-00014800: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-00014810: 7461 7475 7320 7c20 6772 6570 207b 6e61  tatus | grep {na
-00014820: 6d65 7d20 7c20 6772 6570 2055 5027 2c20  me} | grep UP', 
-00014830: 2023 2045 6e73 7572 6520 7468 6520 636c   # Ensure the cl
-00014840: 7573 7465 7220 6973 2055 502e 0a20 2020  uster is UP..   
-00014850: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00014860: 7865 6320 7b6e 616d 657d 207b 5343 505f  xec {name} {SCP_
-00014870: 5459 5045 7d20 7465 7374 732f 7465 7374  TYPE} tests/test
-00014880: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
-00014890: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-000148a0: 2020 6627 736b 7920 7374 6174 7573 207c    f'sky status |
-000148b0: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-000148c0: 7265 7020 2231 6d20 2864 6f77 6e29 2227  rep "1m (down)"'
-000148d0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-000148e0: 6c65 6570 2032 3030 272c 0a20 2020 2020  leep 200',.     
-000148f0: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
-00014900: 7468 6520 636c 7573 7465 7220 6973 2074  the cluster is t
-00014910: 6572 6d69 6e61 7465 642e 0a20 2020 2020  erminated..     
-00014920: 2020 2020 2020 2066 2773 3d24 2853 4b59         f's=$(SKY
-00014930: 5049 4c4f 545f 4445 4255 473d 3020 736b  PILOT_DEBUG=0 sk
-00014940: 7920 7374 6174 7573 202d 2d72 6566 7265  y status --refre
-00014950: 7368 2920 2626 2070 7269 6e74 6620 2224  sh) && printf "$
-00014960: 7322 2026 2620 7b7b 2065 6368 6f20 2224  s" && {{ echo "$
-00014970: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
-00014980: 207c 2067 7265 7020 2241 7574 6f64 6f77   | grep "Autodow
-00014990: 6e65 6420 636c 7573 7465 725c 7c74 6572  ned cluster\|ter
-000149a0: 6d69 6e61 7465 6420 6f6e 2074 6865 2063  minated on the c
-000149b0: 6c6f 7564 223b 207d 7d20 7c7c 207b 7b20  loud"; }} || {{ 
-000149c0: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-000149d0: 207b 6e61 6d65 7d20 2626 2065 7869 7420   {name} && exit 
-000149e0: 3120 7c7c 2065 7869 7420 303b 207d 7d27  1 || exit 0; }}'
-000149f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00014a00: 736b 7920 6c61 756e 6368 202d 7920 2d64  sky launch -y -d
-00014a10: 202d 6320 7b6e 616d 657d 207b 5343 505f   -c {name} {SCP_
-00014a20: 5459 5045 7d20 2d2d 646f 776e 2074 6573  TYPE} --down tes
-00014a30: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
-00014a40: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-00014a50: 2020 2020 2020 2020 2066 2773 6b79 2061           f'sky a
-00014a60: 7574 6f73 746f 7020 2d79 207b 6e61 6d65  utostop -y {name
-00014a70: 7d20 2d2d 6361 6e63 656c 272c 0a20 2020  } --cancel',.   
-00014a80: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00014a90: 3230 3027 2c0a 2020 2020 2020 2020 2020  200',.          
-00014aa0: 2020 2320 456e 7375 7265 2074 6865 2063    # Ensure the c
-00014ab0: 6c75 7374 6572 2069 7320 7374 696c 6c20  luster is still 
-00014ac0: 5550 2e0a 2020 2020 2020 2020 2020 2020  UP..            
-00014ad0: 6627 733d 2428 534b 5950 494c 4f54 5f44  f's=$(SKYPILOT_D
-00014ae0: 4542 5547 3d30 2073 6b79 2073 7461 7475  EBUG=0 sky statu
-00014af0: 7320 2d2d 7265 6672 6573 6829 2026 2620  s --refresh) && 
-00014b00: 7072 696e 7466 2022 2473 2220 2626 2065  printf "$s" && e
-00014b10: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-00014b20: 7b6e 616d 657d 207c 2067 7265 7020 5550  {name} | grep UP
-00014b30: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-00014b40: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-00014b50: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00014b60: 2020 2020 2074 696d 656f 7574 3d32 3520       timeout=25 
-00014b70: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
-00014b80: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00014b90: 7429 0a0a 0a64 6566 205f 6765 745f 6361  t)...def _get_ca
-00014ba0: 6e63 656c 5f74 6173 6b5f 7769 7468 5f63  ncel_task_with_c
-00014bb0: 6c6f 7564 286e 616d 652c 2063 6c6f 7564  loud(name, cloud
-00014bc0: 2c20 7469 6d65 6f75 743d 3135 202a 2036  , timeout=15 * 6
-00014bd0: 3029 3a0a 2020 2020 7465 7374 203d 2054  0):.    test = T
-00014be0: 6573 7428 0a20 2020 2020 2020 2066 277b  est(.        f'{
-00014bf0: 636c 6f75 647d 2d63 616e 6365 6c2d 7461  cloud}-cancel-ta
-00014c00: 736b 272c 0a20 2020 2020 2020 205b 0a20  sk',.        [. 
-00014c10: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00014c20: 206c 6175 6e63 6820 2d63 207b 6e61 6d65   launch -c {name
-00014c30: 7d20 6578 616d 706c 6573 2f72 6573 6e65  } examples/resne
-00014c40: 745f 6170 702e 7961 6d6c 202d 2d63 6c6f  t_app.yaml --clo
-00014c50: 7564 207b 636c 6f75 647d 202d 7920 2d64  ud {cloud} -y -d
-00014c60: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-00014c70: 2057 6169 7420 7468 6520 4750 5520 7072   Wait the GPU pr
-00014c80: 6f63 6573 7320 746f 2073 7461 7274 2e0a  ocess to start..
-00014c90: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-00014ca0: 6570 2036 3027 2c0a 2020 2020 2020 2020  ep 60',.        
-00014cb0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00014cc0: 6e61 6d65 7d20 226e 7669 6469 612d 736d  name} "nvidia-sm
-00014cd0: 6920 7c20 6772 6570 2070 7974 686f 6e22  i | grep python"
-00014ce0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00014cf0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00014d00: 2032 202d 2d73 7461 7475 7327 2c20 2023   2 --status',  #
-00014d10: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-00014d20: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-00014d30: 2020 2020 2020 2066 2773 6b79 2063 616e         f'sky can
-00014d40: 6365 6c20 2d79 207b 6e61 6d65 7d20 3127  cel -y {name} 1'
-00014d50: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-00014d60: 6c65 6570 2036 3027 2c0a 2020 2020 2020  leep 60',.      
-00014d70: 2020 2020 2020 2320 6368 6563 6b20 6966        # check if
-00014d80: 2074 6865 2070 7974 686f 6e20 6a6f 6220   the python job 
-00014d90: 6973 2067 6f6e 652e 0a20 2020 2020 2020  is gone..       
-00014da0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00014db0: 7b6e 616d 657d 2022 2120 6e76 6964 6961  {name} "! nvidia
-00014dc0: 2d73 6d69 207c 2067 7265 7020 7079 7468  -smi | grep pyth
-00014dd0: 6f6e 2227 2c0a 2020 2020 2020 2020 2020  on"',.          
-00014de0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00014df0: 6d65 7d20 3320 2d2d 7374 6174 7573 272c  me} 3 --status',
-00014e00: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-00014e10: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-00014e20: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00014e30: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00014e40: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
-00014e50: 7469 6d65 6f75 743d 7469 6d65 6f75 742c  timeout=timeout,
-00014e60: 0a20 2020 2029 0a20 2020 2072 6574 7572  .    ).    retur
-00014e70: 6e20 7465 7374 0a0a 0a23 202d 2d2d 2d2d  n test...# -----
-00014e80: 2d2d 2d2d 2d20 5465 7374 696e 6720 6073  ----- Testing `s
-00014e90: 6b79 2063 616e 6365 6c60 202d 2d2d 2d2d  ky cancel` -----
-00014ea0: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
-00014eb0: 726b 2e61 7773 0a40 7079 7465 7374 2e6d  rk.aws.@pytest.m
-00014ec0: 6172 6b2e 736b 6970 280a 2020 2020 7265  ark.skip(.    re
-00014ed0: 6173 6f6e 3d27 5468 6520 7265 736e 6574  ason='The resnet
-00014ee0: 5f61 7070 2069 7320 666c 616b 792c 2064  _app is flaky, d
-00014ef0: 7565 2074 6f20 5446 2066 6169 6c69 6e67  ue to TF failing
-00014f00: 2074 6f20 6465 7465 6374 2047 5055 732e   to detect GPUs.
-00014f10: 2729 0a64 6566 2074 6573 745f 6361 6e63  ').def test_canc
-00014f20: 656c 5f61 7773 2829 3a0a 2020 2020 6e61  el_aws():.    na
-00014f30: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00014f40: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-00014f50: 7420 3d20 5f67 6574 5f63 616e 6365 6c5f  t = _get_cancel_
-00014f60: 7461 736b 5f77 6974 685f 636c 6f75 6428  task_with_cloud(
-00014f70: 6e61 6d65 2c20 2761 7773 2729 0a20 2020  name, 'aws').   
-00014f80: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00014f90: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00014fa0: 726b 2e67 6370 0a40 7079 7465 7374 2e6d  rk.gcp.@pytest.m
-00014fb0: 6172 6b2e 736b 6970 280a 2020 2020 7265  ark.skip(.    re
-00014fc0: 6173 6f6e 3d27 5468 6520 7265 736e 6574  ason='The resnet
-00014fd0: 5f61 7070 2069 7320 666c 616b 792c 2064  _app is flaky, d
-00014fe0: 7565 2074 6f20 5446 2066 6169 6c69 6e67  ue to TF failing
-00014ff0: 2074 6f20 6465 7465 6374 2047 5055 732e   to detect GPUs.
-00015000: 2729 0a64 6566 2074 6573 745f 6361 6e63  ').def test_canc
-00015010: 656c 5f67 6370 2829 3a0a 2020 2020 6e61  el_gcp():.    na
-00015020: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00015030: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-00015040: 7420 3d20 5f67 6574 5f63 616e 6365 6c5f  t = _get_cancel_
-00015050: 7461 736b 5f77 6974 685f 636c 6f75 6428  task_with_cloud(
-00015060: 6e61 6d65 2c20 2767 6370 2729 0a20 2020  name, 'gcp').   
-00015070: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00015080: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00015090: 726b 2e61 7a75 7265 0a40 7079 7465 7374  rk.azure.@pytest
-000150a0: 2e6d 6172 6b2e 736b 6970 280a 2020 2020  .mark.skip(.    
-000150b0: 7265 6173 6f6e 3d27 5468 6520 7265 736e  reason='The resn
-000150c0: 6574 5f61 7070 2069 7320 666c 616b 792c  et_app is flaky,
-000150d0: 2064 7565 2074 6f20 5446 2066 6169 6c69   due to TF faili
-000150e0: 6e67 2074 6f20 6465 7465 6374 2047 5055  ng to detect GPU
-000150f0: 732e 2729 0a64 6566 2074 6573 745f 6361  s.').def test_ca
-00015100: 6e63 656c 5f61 7a75 7265 2829 3a0a 2020  ncel_azure():.  
-00015110: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00015120: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00015130: 2074 6573 7420 3d20 5f67 6574 5f63 616e   test = _get_can
-00015140: 6365 6c5f 7461 736b 5f77 6974 685f 636c  cel_task_with_cl
-00015150: 6f75 6428 6e61 6d65 2c20 2761 7a75 7265  oud(name, 'azure
-00015160: 272c 2074 696d 656f 7574 3d33 3020 2a20  ', timeout=30 * 
-00015170: 3630 290a 2020 2020 7275 6e5f 6f6e 655f  60).    run_one_
-00015180: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-00015190: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
-000151a0: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
-000151b0: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
-000151c0: 6f74 2068 6176 6520 5631 3030 2067 7075  ot have V100 gpu
-000151d0: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
-000151e0: 6f5f 6962 6d20 2023 2049 424d 2063 6c6f  o_ibm  # IBM clo
-000151f0: 7564 2063 7572 7265 6e74 6c79 2064 6f65  ud currently doe
-00015200: 736e 2774 2070 726f 7669 6465 2070 7562  sn't provide pub
-00015210: 6c69 6320 696d 6167 6520 7769 7468 2043  lic image with C
-00015220: 5544 410a 4070 7974 6573 742e 6d61 726b  UDA.@pytest.mark
-00015230: 2e6e 6f5f 7061 7065 7273 7061 6365 2020  .no_paperspace  
-00015240: 2320 5061 7065 7273 7061 6365 2068 6173  # Paperspace has
-00015250: 2060 676e 6f6d 652d 7368 656c 6c60 206f   `gnome-shell` o
-00015260: 6e20 6e76 6964 6961 2d73 6d69 0a40 7079  n nvidia-smi.@py
-00015270: 7465 7374 2e6d 6172 6b2e 6e6f 5f73 6370  test.mark.no_scp
-00015280: 2020 2320 5343 5020 646f 6573 206e 6f74    # SCP does not
-00015290: 2073 7570 706f 7274 206e 756d 5f6e 6f64   support num_nod
-000152a0: 6573 203e 2031 2079 6574 0a64 6566 2074  es > 1 yet.def t
-000152b0: 6573 745f 6361 6e63 656c 5f70 7974 6f72  est_cancel_pytor
-000152c0: 6368 2867 656e 6572 6963 5f63 6c6f 7564  ch(generic_cloud
-000152d0: 3a20 7374 7229 3a0a 2020 2020 6e61 6d65  : str):.    name
-000152e0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-000152f0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-00015300: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00015310: 2763 616e 6365 6c2d 7079 746f 7263 6827  'cancel-pytorch'
-00015320: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00015330: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00015340: 756e 6368 202d 6320 7b6e 616d 657d 202d  unch -c {name} -
-00015350: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-00015360: 636c 6f75 647d 2065 7861 6d70 6c65 732f  cloud} examples/
-00015370: 7265 736e 6574 5f64 6973 7472 6962 7574  resnet_distribut
-00015380: 6564 5f74 6f72 6368 2e79 616d 6c20 2d79  ed_torch.yaml -y
-00015390: 202d 6427 2c0a 2020 2020 2020 2020 2020   -d',.          
-000153a0: 2020 2320 5761 6974 2074 6865 2047 5055    # Wait the GPU
-000153b0: 2070 726f 6365 7373 2074 6f20 7374 6172   process to star
-000153c0: 742e 0a20 2020 2020 2020 2020 2020 2027  t..            '
-000153d0: 736c 6565 7020 3930 272c 0a20 2020 2020  sleep 90',.     
-000153e0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-000153f0: 6320 7b6e 616d 657d 2022 286e 7669 6469  c {name} "(nvidi
-00015400: 612d 736d 6920 7c20 6772 6570 2070 7974  a-smi | grep pyt
-00015410: 686f 6e29 207c 7c20 270a 2020 2020 2020  hon) || '.      
-00015420: 2020 2020 2020 2320 5768 656e 2072 756e        # When run
-00015430: 2069 6e73 6964 6520 636f 6e74 6169 6e65   inside containe
-00015440: 722f 6b38 732c 206e 7669 6469 612d 736d  r/k8s, nvidia-sm
-00015450: 6920 6361 6e6e 6f74 2073 686f 7720 7072  i cannot show pr
-00015460: 6f63 6573 7320 6964 732e 0a20 2020 2020  ocess ids..     
-00015470: 2020 2020 2020 2023 2053 6565 2068 7474         # See htt
-00015480: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
-00015490: 4e56 4944 4941 2f6e 7669 6469 612d 646f  NVIDIA/nvidia-do
-000154a0: 636b 6572 2f69 7373 7565 732f 3137 390a  cker/issues/179.
-000154b0: 2020 2020 2020 2020 2020 2020 2320 546f              # To
-000154c0: 2077 6f72 6b20 6172 6f75 6e64 2c20 7765   work around, we
-000154d0: 2063 6865 636b 2069 6620 4750 5520 7574   check if GPU ut
-000154e0: 696c 697a 6174 696f 6e20 6973 2067 7265  ilization is gre
-000154f0: 6174 6572 2074 6861 6e20 302e 0a20 2020  ater than 0..   
-00015500: 2020 2020 2020 2020 2066 275b 205c 2428           f'[ \$(
-00015510: 6e76 6964 6961 2d73 6d69 202d 2d71 7565  nvidia-smi --que
-00015520: 7279 2d67 7075 3d75 7469 6c69 7a61 7469  ry-gpu=utilizati
-00015530: 6f6e 2e67 7075 202d 2d66 6f72 6d61 743d  on.gpu --format=
-00015540: 6373 762c 6e6f 6865 6164 6572 2c6e 6f75  csv,noheader,nou
-00015550: 6e69 7473 2920 2d67 7420 3020 5d22 272c  nits) -gt 0 ]"',
-00015560: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00015570: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
-00015580: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
-00015590: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
-000155a0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
-000155b0: 2020 2020 2066 2773 6b79 2063 616e 6365       f'sky cance
-000155c0: 6c20 2d79 207b 6e61 6d65 7d20 3127 2c0a  l -y {name} 1',.
-000155d0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-000155e0: 6570 2036 3027 2c0a 2020 2020 2020 2020  ep 60',.        
-000155f0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00015600: 6e61 6d65 7d20 2228 6e76 6964 6961 2d73  name} "(nvidia-s
-00015610: 6d69 207c 2067 7265 7020 5c27 4e6f 2072  mi | grep \'No r
-00015620: 756e 6e69 6e67 2070 726f 6365 7373 5c27  unning process\'
-00015630: 2920 7c7c 2027 0a20 2020 2020 2020 2020  ) || '.         
-00015640: 2020 2023 2045 6e73 7572 6520 586f 7267     # Ensure Xorg
-00015650: 2069 7320 7468 6520 6f6e 6c79 2070 726f   is the only pro
-00015660: 6365 7373 2072 756e 6e69 6e67 2e0a 2020  cess running..  
-00015670: 2020 2020 2020 2020 2020 275b 205c 2428            '[ \$(
-00015680: 6e76 6964 6961 2d73 6d69 207c 2067 7265  nvidia-smi | gre
-00015690: 7020 2d41 2031 3020 5072 6f63 6573 7365  p -A 10 Processe
-000156a0: 7320 7c20 6772 6570 202d 4120 3130 203d  s | grep -A 10 =
-000156b0: 3d3d 207c 2067 7265 7020 2d76 2058 6f72  == | grep -v Xor
-000156c0: 6729 202d 6571 2032 205d 2227 2c0a 2020  g) -eq 2 ]"',.  
-000156d0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000156e0: 6c6f 6773 207b 6e61 6d65 7d20 3320 2d2d  logs {name} 3 --
-000156f0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-00015700: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
-00015710: 6564 6564 2e0a 2020 2020 2020 2020 5d2c  eded..        ],
-00015720: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-00015730: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-00015740: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-00015750: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
-00015760: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00015770: 7465 7374 290a 0a0a 2320 6361 6e27 7420  test)...# can't 
-00015780: 7573 6520 605f 6765 745f 6361 6e63 656c  use `_get_cancel
-00015790: 5f74 6173 6b5f 7769 7468 5f63 6c6f 7564  _task_with_cloud
-000157a0: 2829 602c 2061 7320 636f 6d6d 616e 6420  ()`, as command 
-000157b0: 606e 7669 6469 612d 736d 6960 0a23 2072  `nvidia-smi`.# r
-000157c0: 6571 7569 7265 7320 6120 4355 4441 2070  equires a CUDA p
-000157d0: 7562 6c69 6320 696d 6167 652c 2077 6869  ublic image, whi
-000157e0: 6368 2049 424d 2064 6f65 736e 2774 206f  ch IBM doesn't o
-000157f0: 6666 6572 0a40 7079 7465 7374 2e6d 6172  ffer.@pytest.mar
-00015800: 6b2e 6962 6d0a 6465 6620 7465 7374 5f63  k.ibm.def test_c
-00015810: 616e 6365 6c5f 6962 6d28 293a 0a20 2020  ancel_ibm():.   
-00015820: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00015830: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00015840: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00015850: 2020 2020 2027 6962 6d2d 6361 6e63 656c       'ibm-cancel
-00015860: 2d74 6173 6b27 2c0a 2020 2020 2020 2020  -task',.        
-00015870: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-00015880: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-00015890: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-000158a0: 6962 6d20 6578 616d 706c 6573 2f6d 696e  ibm examples/min
-000158b0: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
-000158c0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-000158d0: 6563 207b 6e61 6d65 7d20 2d6e 207b 6e61  ec {name} -n {na
-000158e0: 6d65 7d2d 3120 2d64 2020 2277 6869 6c65  me}-1 -d  "while
-000158f0: 2074 7275 653b 2064 6f20 6563 686f 205c   true; do echo \
-00015900: 2748 656c 6c6f 2053 6b79 5069 6c6f 745c  'Hello SkyPilot\
-00015910: 273b 2073 6c65 6570 2032 3b20 646f 6e65  '; sleep 2; done
-00015920: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00015930: 2773 6c65 6570 2032 3027 2c0a 2020 2020  'sleep 20',.    
-00015940: 2020 2020 2020 2020 6627 736b 7920 7175          f'sky qu
-00015950: 6575 6520 7b6e 616d 657d 207c 2067 7265  eue {name} | gre
-00015960: 7020 7b6e 616d 657d 2d31 207c 2067 7265  p {name}-1 | gre
-00015970: 7020 5255 4e4e 494e 4727 2c0a 2020 2020  p RUNNING',.    
-00015980: 2020 2020 2020 2020 6627 736b 7920 6361          f'sky ca
-00015990: 6e63 656c 202d 7920 7b6e 616d 657d 2032  ncel -y {name} 2
-000159a0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000159b0: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
-000159c0: 2020 2020 2020 2066 2773 6b79 2071 7565         f'sky que
-000159d0: 7565 207b 6e61 6d65 7d20 7c20 6772 6570  ue {name} | grep
-000159e0: 207b 6e61 6d65 7d2d 3120 7c20 6772 6570   {name}-1 | grep
-000159f0: 2043 414e 4345 4c4c 4544 272c 0a20 2020   CANCELLED',.   
-00015a00: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00015a10: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-00015a20: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
-00015a30: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00015a40: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
-00015a50: 2d2d 2054 6573 7469 6e67 2075 7365 2d73  -- Testing use-s
-00015a60: 706f 7420 6f70 7469 6f6e 202d 2d2d 2d2d  pot option -----
-00015a70: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
-00015a80: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
-00015a90: 2020 2320 466c 7569 6453 7461 636b 2064    # FluidStack d
-00015aa0: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-00015ab0: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-00015ac0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f61  pytest.mark.no_a
-00015ad0: 7a75 7265 2020 2320 417a 7572 6520 646f  zure  # Azure do
-00015ae0: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-00015af0: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
-00015b00: 7974 6573 742e 6d61 726b 2e6e 6f5f 6c61  ytest.mark.no_la
-00015b10: 6d62 6461 5f63 6c6f 7564 2020 2320 4c61  mbda_cloud  # La
-00015b20: 6d62 6461 2043 6c6f 7564 2064 6f65 7320  mbda Cloud does 
-00015b30: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-00015b40: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-00015b50: 7374 2e6d 6172 6b2e 6e6f 5f70 6170 6572  st.mark.no_paper
-00015b60: 7370 6163 6520 2023 2050 6170 6572 7370  space  # Papersp
-00015b70: 6163 6520 646f 6573 206e 6f74 2073 7570  ace does not sup
-00015b80: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
-00015b90: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
-00015ba0: 2e6e 6f5f 6962 6d20 2023 2049 424d 2043  .no_ibm  # IBM C
-00015bb0: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
-00015bc0: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-00015bd0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-00015be0: 6b2e 6e6f 5f73 6370 2020 2320 5343 5020  k.no_scp  # SCP 
-00015bf0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-00015c00: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
-00015c10: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00015c20: 6b75 6265 726e 6574 6573 2020 2320 4b75  kubernetes  # Ku
-00015c30: 6265 726e 6574 6573 2064 6f65 7320 6e6f  bernetes does no
-00015c40: 7420 6861 7665 2061 206e 6f74 696f 6e20  t have a notion 
-00015c50: 6f66 2073 706f 7420 696e 7374 616e 6365  of spot instance
-00015c60: 730a 6465 6620 7465 7374 5f75 7365 5f73  s.def test_use_s
-00015c70: 706f 7428 6765 6e65 7269 635f 636c 6f75  pot(generic_clou
-00015c80: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
-00015c90: 5465 7374 2075 7365 2d73 706f 7420 616e  Test use-spot an
-00015ca0: 6420 736b 7920 6578 6563 2e22 2222 0a20  d sky exec.""". 
-00015cb0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-00015cc0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-00015cd0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00015ce0: 2020 2020 2020 2027 7573 652d 7370 6f74         'use-spot
-00015cf0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-00015d00: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00015d10: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
-00015d20: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-00015d30: 5f63 6c6f 7564 7d20 7465 7374 732f 7465  _cloud} tests/te
-00015d40: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
-00015d50: 2e79 616d 6c20 2d2d 7573 652d 7370 6f74  .yaml --use-spot
-00015d60: 202d 7927 2c0a 2020 2020 2020 2020 2020   -y',.          
-00015d70: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00015d80: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-00015d90: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00015da0: 6b79 2065 7865 6320 7b6e 616d 657d 2065  ky exec {name} e
-00015db0: 6368 6f20 6869 272c 0a20 2020 2020 2020  cho hi',.       
-00015dc0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00015dd0: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
-00015de0: 7327 2c0a 2020 2020 2020 2020 5d2c 0a20  s',.        ],. 
-00015df0: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-00015e00: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-00015e10: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00015e20: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-00015e30: 7465 7374 2e6d 6172 6b2e 6763 700a 6465  test.mark.gcp.de
-00015e40: 6620 7465 7374 5f73 746f 705f 6763 705f  f test_stop_gcp_
-00015e50: 7370 6f74 2829 3a0a 2020 2020 2222 2254  spot():.    """T
-00015e60: 6573 7420 4743 5020 7370 6f74 2063 616e  est GCP spot can
-00015e70: 2062 6520 7374 6f70 7065 642c 2061 7574   be stopped, aut
-00015e80: 6f73 746f 7070 6564 2c20 7265 7374 6172  ostopped, restar
-00015e90: 7465 642e 2222 220a 2020 2020 6e61 6d65  ted.""".    name
-00015ea0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-00015eb0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-00015ec0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00015ed0: 2773 746f 705f 6763 705f 7370 6f74 272c  'stop_gcp_spot',
-00015ee0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-00015ef0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00015f00: 6e63 6820 2d63 207b 6e61 6d65 7d20 2d2d  nch -c {name} --
-00015f10: 636c 6f75 6420 6763 7020 2d2d 7573 652d  cloud gcp --use-
-00015f20: 7370 6f74 202d 2d63 7075 7320 322b 202d  spot --cpus 2+ -
-00015f30: 7920 2d2d 2074 6f75 6368 206d 7966 696c  y -- touch myfil
-00015f40: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
-00015f50: 2320 7374 6f70 2073 686f 756c 6420 676f  # stop should go
-00015f60: 2074 6872 6f75 6768 3a0a 2020 2020 2020   through:.      
-00015f70: 2020 2020 2020 6627 736b 7920 7374 6f70        f'sky stop
-00015f80: 207b 6e61 6d65 7d20 2d79 272c 0a20 2020   {name} -y',.   
-00015f90: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-00015fa0: 7461 7274 207b 6e61 6d65 7d20 2d79 272c  tart {name} -y',
-00015fb0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00015fc0: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-00015fd0: 2d20 6c73 206d 7966 696c 6527 2c0a 2020  - ls myfile',.  
-00015fe0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00015ff0: 6c6f 6773 207b 6e61 6d65 7d20 3220 2d2d  logs {name} 2 --
-00016000: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-00016010: 2020 2020 2066 2773 6b79 2061 7574 6f73       f'sky autos
-00016020: 746f 7020 7b6e 616d 657d 202d 6930 202d  top {name} -i0 -
-00016030: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
-00016040: 2773 6c65 6570 2039 3027 2c0a 2020 2020  'sleep 90',.    
-00016050: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-00016060: 7920 7374 6174 7573 207b 6e61 6d65 7d20  y status {name} 
-00016070: 2d2d 7265 6672 6573 6829 3b20 6563 686f  --refresh); echo
-00016080: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
-00016090: 6f3b 2065 6368 6f20 2224 7322 2020 7c20  o; echo "$s"  | 
-000160a0: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
-000160b0: 6570 2053 544f 5050 4544 272c 0a20 2020  ep STOPPED',.   
-000160c0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-000160d0: 7461 7274 207b 6e61 6d65 7d20 2d79 272c  tart {name} -y',
-000160e0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000160f0: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-00016100: 2d20 6c73 206d 7966 696c 6527 2c0a 2020  - ls myfile',.  
-00016110: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00016120: 6c6f 6773 207b 6e61 6d65 7d20 3320 2d2d  logs {name} 3 --
-00016130: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-00016140: 2020 2020 2023 202d 6920 6f70 7469 6f6e       # -i option
-00016150: 2061 7420 6c61 756e 6368 2073 686f 756c   at launch shoul
-00016160: 6420 676f 2074 6872 6f75 6768 3a0a 2020  d go through:.  
-00016170: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00016180: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
-00016190: 202d 6930 202d 7927 2c0a 2020 2020 2020   -i0 -y',.      
-000161a0: 2020 2020 2020 2773 6c65 6570 2031 3230        'sleep 120
-000161b0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000161c0: 2773 3d24 2873 6b79 2073 7461 7475 7320  's=$(sky status 
-000161d0: 7b6e 616d 657d 202d 2d72 6566 7265 7368  {name} --refresh
-000161e0: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
-000161f0: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
-00016200: 2473 2220 207c 2067 7265 7020 7b6e 616d  $s"  | grep {nam
-00016210: 657d 207c 2067 7265 7020 5354 4f50 5045  e} | grep STOPPE
-00016220: 4427 2c0a 2020 2020 2020 2020 5d2c 0a20  D',.        ],. 
-00016230: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-00016240: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-00016250: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00016260: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
-00016270: 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374 696e  --------- Testin
-00016280: 6720 6d61 6e61 6765 6420 7370 6f74 202d  g managed spot -
-00016290: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
-000162a0: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
-000162b0: 7461 636b 2020 2320 466c 7569 6453 7461  tack  # FluidSta
-000162c0: 636b 2064 6f65 7320 6e6f 7420 7375 7070  ck does not supp
-000162d0: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
-000162e0: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-000162f0: 6e6f 5f61 7a75 7265 2020 2320 417a 7572  no_azure  # Azur
-00016300: 6520 646f 6573 206e 6f74 2073 7570 706f  e does not suppo
-00016310: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
-00016320: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
-00016330: 6f5f 6c61 6d62 6461 5f63 6c6f 7564 2020  o_lambda_cloud  
-00016340: 2320 4c61 6d62 6461 2043 6c6f 7564 2064  # Lambda Cloud d
-00016350: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-00016360: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-00016370: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f69  pytest.mark.no_i
-00016380: 626d 2020 2320 4942 4d20 436c 6f75 6420  bm  # IBM Cloud 
-00016390: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-000163a0: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
-000163b0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-000163c0: 7363 7020 2023 2053 4350 2064 6f65 7320  scp  # SCP does 
-000163d0: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-000163e0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-000163f0: 7374 2e6d 6172 6b2e 6e6f 5f70 6170 6572  st.mark.no_paper
-00016400: 7370 6163 6520 2023 2050 6170 7065 7273  space  # Pappers
-00016410: 7061 6365 2064 6f65 7320 6e6f 7420 7375  pace does not su
-00016420: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-00016430: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-00016440: 6b2e 6e6f 5f6b 7562 6572 6e65 7465 7320  k.no_kubernetes 
-00016450: 2023 204b 7562 6572 6e65 7465 7320 646f   # Kubernetes do
-00016460: 6573 206e 6f74 2068 6176 6520 6120 6e6f  es not have a no
-00016470: 7469 6f6e 206f 6620 7370 6f74 2069 6e73  tion of spot ins
-00016480: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
-00016490: 6172 6b2e 6d61 6e61 6765 645f 7370 6f74  ark.managed_spot
-000164a0: 0a64 6566 2074 6573 745f 7370 6f74 2867  .def test_spot(g
-000164b0: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
-000164c0: 7229 3a0a 2020 2020 2222 2254 6573 7420  r):.    """Test 
-000164d0: 7468 6520 7370 6f74 2079 616d 6c2e 2222  the spot yaml.""
-000164e0: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
-000164f0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00016500: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00016510: 280a 2020 2020 2020 2020 276d 616e 6167  (.        'manag
-00016520: 6564 2d73 706f 7427 2c0a 2020 2020 2020  ed-spot',.      
-00016530: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00016540: 6627 736b 7920 7370 6f74 206c 6175 6e63  f'sky spot launc
-00016550: 6820 2d6e 207b 6e61 6d65 7d2d 3120 2d2d  h -n {name}-1 --
-00016560: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-00016570: 6c6f 7564 7d20 6578 616d 706c 6573 2f6d  loud} examples/m
-00016580: 616e 6167 6564 5f73 706f 742e 7961 6d6c  anaged_spot.yaml
-00016590: 202d 7920 2d64 272c 0a20 2020 2020 2020   -y -d',.       
-000165a0: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
-000165b0: 6c61 756e 6368 202d 6e20 7b6e 616d 657d  launch -n {name}
-000165c0: 2d32 202d 2d63 6c6f 7564 207b 6765 6e65  -2 --cloud {gene
-000165d0: 7269 635f 636c 6f75 647d 2065 7861 6d70  ric_cloud} examp
-000165e0: 6c65 732f 6d61 6e61 6765 645f 7370 6f74  les/managed_spot
-000165f0: 2e79 616d 6c20 2d79 202d 6427 2c0a 2020  .yaml -y -d',.  
-00016600: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-00016610: 2035 272c 0a20 2020 2020 2020 2020 2020   5',.           
-00016620: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-00016630: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
-00016640: 657d 2d31 207c 2068 6561 6420 2d6e 3120  e}-1 | head -n1 
-00016650: 7c20 6772 6570 2022 5354 4152 5449 4e47  | grep "STARTING
-00016660: 5c7c 5255 4e4e 494e 4722 272c 0a20 2020  \|RUNNING"',.   
-00016670: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-00016680: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
-00016690: 7265 7020 7b6e 616d 657d 2d32 207c 2068  rep {name}-2 | h
-000166a0: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-000166b0: 5354 4152 5449 4e47 5c7c 5255 4e4e 494e  STARTING\|RUNNIN
-000166c0: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
-000166d0: 205f 5350 4f54 5f43 414e 4345 4c5f 5741   _SPOT_CANCEL_WA
-000166e0: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
-000166f0: 6d65 3d66 277b 6e61 6d65 7d2d 3127 292c  me=f'{name}-1'),
-00016700: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00016710: 6565 7020 3527 2c0a 2020 2020 2020 2020  eep 5',.        
-00016720: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-00016730: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-00016740: 6e61 6d65 7d2d 3120 7c20 6865 6164 202d  name}-1 | head -
-00016750: 6e31 207c 2067 7265 7020 2243 414e 4345  n1 | grep "CANCE
-00016760: 4c4c 494e 475c 7c43 414e 4345 4c4c 4544  LLING\|CANCELLED
-00016770: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00016780: 2773 6c65 6570 2032 3030 272c 0a20 2020  'sleep 200',.   
-00016790: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-000167a0: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
-000167b0: 7265 7020 7b6e 616d 657d 2d31 207c 2068  rep {name}-1 | h
-000167c0: 6561 6420 2d6e 3120 7c20 6772 6570 2043  ead -n1 | grep C
-000167d0: 414e 4345 4c4c 4544 272c 0a20 2020 2020  ANCELLED',.     
-000167e0: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-000167f0: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-00016800: 7020 7b6e 616d 657d 2d32 207c 2068 6561  p {name}-2 | hea
-00016810: 6420 2d6e 3120 7c20 6772 6570 2022 5255  d -n1 | grep "RU
-00016820: 4e4e 494e 475c 7c53 5543 4345 4544 4544  NNING\|SUCCEEDED
-00016830: 2227 2c0a 2020 2020 2020 2020 5d2c 0a20  "',.        ],. 
-00016840: 2020 2020 2020 2023 2054 4f44 4f28 7a68         # TODO(zh
-00016850: 7775 293a 2043 6861 6e67 6520 746f 205f  wu): Change to _
-00016860: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
-00016870: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
-00016880: 3d66 277b 6e61 6d65 7d2d 3120 2d6e 207b  =f'{name}-1 -n {
-00016890: 6e61 6d65 7d2d 3227 2920 7768 656e 0a20  name}-2') when. 
-000168a0: 2020 2020 2020 2023 2063 616e 6365 6c69         # canceli
-000168b0: 6e67 206d 756c 7469 706c 6520 6a6f 6220  ng multiple job 
-000168c0: 6e61 6d65 7320 6973 2073 7570 706f 7274  names is support
-000168d0: 6564 2e0a 2020 2020 2020 2020 285f 5350  ed..        (_SP
-000168e0: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
-000168f0: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d66  ormat(job_name=f
-00016900: 277b 6e61 6d65 7d2d 3127 2920 2b20 273b  '{name}-1') + ';
-00016910: 2027 202b 0a20 2020 2020 2020 2020 5f53   ' +.         _S
-00016920: 504f 545f 4341 4e43 454c 5f57 4149 542e  POT_CANCEL_WAIT.
-00016930: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
-00016940: 6627 7b6e 616d 657d 2d32 2729 292c 0a20  f'{name}-2')),. 
-00016950: 2020 2020 2020 2023 2049 6e63 7265 6173         # Increas
-00016960: 6520 7469 6d65 6f75 7420 7369 6e63 6520  e timeout since 
-00016970: 736b 7920 7370 6f74 2071 7565 7565 202d  sky spot queue -
-00016980: 7220 6361 6e20 6265 2062 6c6f 636b 6564  r can be blocked
-00016990: 2062 7920 6f74 6865 7220 7370 6f74 2074   by other spot t
-000169a0: 6573 7473 2e0a 2020 2020 2020 2020 7469  ests..        ti
-000169b0: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
-000169c0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-000169d0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-000169e0: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
-000169f0: 7569 6473 7461 636b 2020 2366 6c75 6964  uidstack  #fluid
-00016a00: 7374 6163 6b20 646f 6573 206e 6f74 2073  stack does not s
-00016a10: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-00016a20: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-00016a30: 726b 2e6e 6f5f 617a 7572 6520 2023 2041  rk.no_azure  # A
-00016a40: 7a75 7265 2064 6f65 7320 6e6f 7420 7375  zure does not su
-00016a50: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-00016a60: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-00016a70: 6b2e 6e6f 5f6c 616d 6264 615f 636c 6f75  k.no_lambda_clou
-00016a80: 6420 2023 204c 616d 6264 6120 436c 6f75  d  # Lambda Clou
-00016a90: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
-00016aa0: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
-00016ab0: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
-00016ac0: 6f5f 6962 6d20 2023 2049 424d 2043 6c6f  o_ibm  # IBM Clo
-00016ad0: 7564 2064 6f65 7320 6e6f 7420 7375 7070  ud does not supp
-00016ae0: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
-00016af0: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-00016b00: 6e6f 5f73 6370 2020 2320 5343 5020 646f  no_scp  # SCP do
-00016b10: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-00016b20: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
-00016b30: 7974 6573 742e 6d61 726b 2e6e 6f5f 7061  ytest.mark.no_pa
-00016b40: 7065 7273 7061 6365 2020 2320 5061 7065  perspace  # Pape
-00016b50: 7273 7061 6365 2064 6f65 7320 6e6f 7420  rspace does not 
-00016b60: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
-00016b70: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
-00016b80: 6172 6b2e 6e6f 5f6b 7562 6572 6e65 7465  ark.no_kubernete
-00016b90: 7320 2023 204b 7562 6572 6e65 7465 7320  s  # Kubernetes 
-00016ba0: 646f 6573 206e 6f74 2068 6176 6520 6120  does not have a 
-00016bb0: 6e6f 7469 6f6e 206f 6620 7370 6f74 2069  notion of spot i
-00016bc0: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
-00016bd0: 2e6d 6172 6b2e 6d61 6e61 6765 645f 7370  .mark.managed_sp
-00016be0: 6f74 0a64 6566 2074 6573 745f 7370 6f74  ot.def test_spot
-00016bf0: 5f70 6970 656c 696e 6528 6765 6e65 7269  _pipeline(generi
-00016c00: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-00016c10: 2020 2022 2222 5465 7374 2061 2073 706f     """Test a spo
-00016c20: 7420 7069 7065 6c69 6e65 2e22 2222 0a20  t pipeline.""". 
-00016c30: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-00016c40: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-00016c50: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00016c60: 2020 2020 2020 2027 7370 6f74 2d70 6970         'spot-pip
-00016c70: 656c 696e 6527 2c0a 2020 2020 2020 2020  eline',.        
-00016c80: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-00016c90: 736b 7920 7370 6f74 206c 6175 6e63 6820  sky spot launch 
-00016ca0: 2d6e 207b 6e61 6d65 7d20 7465 7374 732f  -n {name} tests/
-00016cb0: 7465 7374 5f79 616d 6c73 2f70 6970 656c  test_yamls/pipel
-00016cc0: 696e 652e 7961 6d6c 202d 7920 2d64 272c  ine.yaml -y -d',
-00016cd0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00016ce0: 6565 7020 3527 2c0a 2020 2020 2020 2020  eep 5',.        
-00016cf0: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-00016d00: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-00016d10: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
-00016d20: 207c 2067 7265 7020 2253 5441 5254 494e   | grep "STARTIN
-00016d30: 475c 7c52 554e 4e49 4e47 2227 2c0a 2020  G\|RUNNING"',.  
-00016d40: 2020 2020 2020 2020 2020 2320 6067 7265            # `gre
-00016d50: 7020 2d41 2034 207b 6e61 6d65 7d60 2066  p -A 4 {name}` f
-00016d60: 696e 6473 2074 6865 206a 6f62 2077 6974  inds the job wit
-00016d70: 6820 7b6e 616d 657d 2061 6e64 2074 6865  h {name} and the
-00016d80: 2034 206c 696e 6573 0a20 2020 2020 2020   4 lines.       
-00016d90: 2020 2020 2023 2061 6674 6572 2069 742c       # after it,
-00016da0: 2069 2e65 2e20 7468 6520 3420 7461 736b   i.e. the 4 task
-00016db0: 7320 7769 7468 696e 2074 6865 206a 6f62  s within the job
-00016dc0: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00016dd0: 6073 6564 202d 6e20 3270 6020 6765 7473  `sed -n 2p` gets
-00016de0: 2074 6865 2073 6563 6f6e 6420 6c69 6e65   the second line
-00016df0: 206f 6620 7468 6520 3420 6c69 6e65 732c   of the 4 lines,
-00016e00: 2069 2e65 2e20 7468 6520 6669 7273 740a   i.e. the first.
-00016e10: 2020 2020 2020 2020 2020 2020 2320 7461              # ta
-00016e20: 736b 2077 6974 6869 6e20 7468 6520 6a6f  sk within the jo
-00016e30: 622e 0a20 2020 2020 2020 2020 2020 2066  b..            f
-00016e40: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-00016e50: 4954 7d7c 2067 7265 7020 2d41 2034 207b  IT}| grep -A 4 {
-00016e60: 6e61 6d65 7d7c 2073 6564 202d 6e20 3270  name}| sed -n 2p
-00016e70: 207c 2067 7265 7020 2253 5441 5254 494e   | grep "STARTIN
-00016e80: 475c 7c52 554e 4e49 4e47 2227 2c0a 2020  G\|RUNNING"',.  
-00016e90: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-00016ea0: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-00016eb0: 6772 6570 202d 4120 3420 7b6e 616d 657d  grep -A 4 {name}
-00016ec0: 7c20 7365 6420 2d6e 2033 7020 7c20 6772  | sed -n 3p | gr
-00016ed0: 6570 2022 5045 4e44 494e 4722 272c 0a20  ep "PENDING"',. 
-00016ee0: 2020 2020 2020 2020 2020 205f 5350 4f54             _SPOT
-00016ef0: 5f43 414e 4345 4c5f 5741 4954 2e66 6f72  _CANCEL_WAIT.for
-00016f00: 6d61 7428 6a6f 625f 6e61 6d65 3d66 277b  mat(job_name=f'{
-00016f10: 6e61 6d65 7d27 292c 0a20 2020 2020 2020  name}'),.       
-00016f20: 2020 2020 2027 736c 6565 7020 3527 2c0a       'sleep 5',.
-00016f30: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00016f40: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-00016f50: 7c20 6772 6570 202d 4120 3420 7b6e 616d  | grep -A 4 {nam
-00016f60: 657d 7c20 7365 6420 2d6e 2032 7020 7c20  e}| sed -n 2p | 
-00016f70: 6772 6570 2022 4341 4e43 454c 4c49 4e47  grep "CANCELLING
-00016f80: 5c7c 4341 4e43 454c 4c45 4422 272c 0a20  \|CANCELLED"',. 
-00016f90: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00016fa0: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-00016fb0: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
-00016fc0: 7d7c 2073 6564 202d 6e20 3370 207c 2067  }| sed -n 3p | g
-00016fd0: 7265 7020 2243 414e 4345 4c4c 494e 475c  rep "CANCELLING\
-00016fe0: 7c43 414e 4345 4c4c 4544 2227 2c0a 2020  |CANCELLED"',.  
-00016ff0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-00017000: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-00017010: 6772 6570 202d 4120 3420 7b6e 616d 657d  grep -A 4 {name}
-00017020: 7c20 7365 6420 2d6e 2034 7020 7c20 6772  | sed -n 4p | gr
-00017030: 6570 2022 4341 4e43 454c 4c49 4e47 5c7c  ep "CANCELLING\|
-00017040: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
-00017050: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-00017060: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
-00017070: 7265 7020 2d41 2034 207b 6e61 6d65 7d7c  rep -A 4 {name}|
-00017080: 2073 6564 202d 6e20 3570 207c 2067 7265   sed -n 5p | gre
-00017090: 7020 2243 414e 4345 4c4c 494e 475c 7c43  p "CANCELLING\|C
-000170a0: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
-000170b0: 2020 2020 2020 2020 2773 6c65 6570 2032          'sleep 2
-000170c0: 3030 272c 0a20 2020 2020 2020 2020 2020  00',.           
-000170d0: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-000170e0: 5741 4954 7d7c 2067 7265 7020 2d41 2034  WAIT}| grep -A 4
-000170f0: 207b 6e61 6d65 7d7c 2073 6564 202d 6e20   {name}| sed -n 
-00017100: 3270 207c 2067 7265 7020 2243 414e 4345  2p | grep "CANCE
-00017110: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
-00017120: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-00017130: 5545 5f57 4149 547d 7c20 6772 6570 202d  UE_WAIT}| grep -
-00017140: 4120 3420 7b6e 616d 657d 7c20 7365 6420  A 4 {name}| sed 
-00017150: 2d6e 2033 7020 7c20 6772 6570 2022 4341  -n 3p | grep "CA
-00017160: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
-00017170: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-00017180: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-00017190: 7020 2d41 2034 207b 6e61 6d65 7d7c 2073  p -A 4 {name}| s
-000171a0: 6564 202d 6e20 3470 207c 2067 7265 7020  ed -n 4p | grep 
-000171b0: 2243 414e 4345 4c4c 4544 2227 2c0a 2020  "CANCELLED"',.  
-000171c0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-000171d0: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-000171e0: 6772 6570 202d 4120 3420 7b6e 616d 657d  grep -A 4 {name}
-000171f0: 7c20 7365 6420 2d6e 2035 7020 7c20 6772  | sed -n 5p | gr
-00017200: 6570 2022 4341 4e43 454c 4c45 4422 272c  ep "CANCELLED"',
-00017210: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00017220: 2020 2020 5f53 504f 545f 4341 4e43 454c      _SPOT_CANCEL
-00017230: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
-00017240: 5f6e 616d 653d 6627 7b6e 616d 657d 2729  _name=f'{name}')
-00017250: 2c0a 2020 2020 2020 2020 2320 496e 6372  ,.        # Incr
-00017260: 6561 7365 2074 696d 656f 7574 2073 696e  ease timeout sin
-00017270: 6365 2073 6b79 2073 706f 7420 7175 6575  ce sky spot queu
-00017280: 6520 2d72 2063 616e 2062 6520 626c 6f63  e -r can be bloc
-00017290: 6b65 6420 6279 206f 7468 6572 2073 706f  ked by other spo
-000172a0: 7420 7465 7374 732e 0a20 2020 2020 2020  t tests..       
-000172b0: 2074 696d 656f 7574 3d33 3020 2a20 3630   timeout=30 * 60
-000172c0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-000172d0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-000172e0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-000172f0: 5f66 6c75 6964 7374 6163 6b20 2023 666c  _fluidstack  #fl
-00017300: 7569 6473 7461 636b 2064 6f65 7320 6e6f  uidstack does no
-00017310: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
-00017320: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
-00017330: 2e6d 6172 6b2e 6e6f 5f61 7a75 7265 2020  .mark.no_azure  
-00017340: 2320 417a 7572 6520 646f 6573 206e 6f74  # Azure does not
-00017350: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-00017360: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-00017370: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
-00017380: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
-00017390: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
-000173a0: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-000173b0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-000173c0: 6b2e 6e6f 5f69 626d 2020 2320 4942 4d20  k.no_ibm  # IBM 
-000173d0: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
-000173e0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-000173f0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-00017400: 726b 2e6e 6f5f 7363 7020 2023 2053 4350  rk.no_scp  # SCP
-00017410: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00017420: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-00017430: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00017440: 5f70 6170 6572 7370 6163 6520 2023 2050  _paperspace  # P
-00017450: 6170 6572 7370 6163 6520 646f 6573 206e  aperspace does n
-00017460: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-00017470: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-00017480: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
-00017490: 6574 6573 2020 2320 4b75 6265 726e 6574  etes  # Kubernet
-000174a0: 6573 2064 6f65 7320 6e6f 7420 6861 7665  es does not have
-000174b0: 2061 206e 6f74 696f 6e20 6f66 2073 706f   a notion of spo
-000174c0: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-000174d0: 6573 742e 6d61 726b 2e6d 616e 6167 6564  est.mark.managed
-000174e0: 5f73 706f 740a 6465 6620 7465 7374 5f73  _spot.def test_s
-000174f0: 706f 745f 6661 696c 6564 5f73 6574 7570  pot_failed_setup
-00017500: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
-00017510: 7374 7229 3a0a 2020 2020 2222 2254 6573  str):.    """Tes
-00017520: 7420 6d61 6e61 6765 6420 7370 6f74 206a  t managed spot j
-00017530: 6f62 2077 6974 6820 6661 696c 6564 2073  ob with failed s
-00017540: 6574 7570 2e22 2222 0a20 2020 206e 616d  etup.""".    nam
-00017550: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00017560: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00017570: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00017580: 2027 7370 6f74 5f66 6169 6c65 645f 7365   'spot_failed_se
-00017590: 7475 7027 2c0a 2020 2020 2020 2020 5b0a  tup',.        [.
-000175a0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000175b0: 7920 7370 6f74 206c 6175 6e63 6820 2d6e  y spot launch -n
-000175c0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-000175d0: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
-000175e0: 2d79 202d 6420 7465 7374 732f 7465 7374  -y -d tests/test
-000175f0: 5f79 616d 6c73 2f66 6169 6c65 645f 7365  _yamls/failed_se
-00017600: 7475 702e 7961 6d6c 272c 0a20 2020 2020  tup.yaml',.     
-00017610: 2020 2020 2020 2027 736c 6565 7020 3333         'sleep 33
-00017620: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-00017630: 2320 4d61 6b65 2073 7572 6520 7468 6520  # Make sure the 
-00017640: 6a6f 6220 6661 696c 6564 2071 7569 636b  job failed quick
-00017650: 6c79 2e0a 2020 2020 2020 2020 2020 2020  ly..            
-00017660: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-00017670: 4149 547d 207c 2067 7265 7020 7b6e 616d  AIT} | grep {nam
-00017680: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
-00017690: 6772 6570 2022 4641 494c 4544 5f53 4554  grep "FAILED_SET
-000176a0: 5550 2227 2c0a 2020 2020 2020 2020 5d2c  UP"',.        ],
-000176b0: 0a20 2020 2020 2020 205f 5350 4f54 5f43  .        _SPOT_C
-000176c0: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
-000176d0: 7428 6a6f 625f 6e61 6d65 3d6e 616d 6529  t(job_name=name)
-000176e0: 2c0a 2020 2020 2020 2020 2320 496e 6372  ,.        # Incr
-000176f0: 6561 7365 2074 696d 656f 7574 2073 696e  ease timeout sin
-00017700: 6365 2073 6b79 2073 706f 7420 7175 6575  ce sky spot queu
-00017710: 6520 2d72 2063 616e 2062 6520 626c 6f63  e -r can be bloc
-00017720: 6b65 6420 6279 206f 7468 6572 2073 706f  ked by other spo
-00017730: 7420 7465 7374 732e 0a20 2020 2020 2020  t tests..       
-00017740: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
-00017750: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00017760: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00017770: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00017780: 5f66 6c75 6964 7374 6163 6b20 2023 666c  _fluidstack  #fl
-00017790: 7569 6473 7461 636b 2064 6f65 7320 6e6f  uidstack does no
-000177a0: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
-000177b0: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
-000177c0: 2e6d 6172 6b2e 6e6f 5f61 7a75 7265 2020  .mark.no_azure  
-000177d0: 2320 417a 7572 6520 646f 6573 206e 6f74  # Azure does not
-000177e0: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-000177f0: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-00017800: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
-00017810: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
-00017820: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
-00017830: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-00017840: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-00017850: 6b2e 6e6f 5f69 626d 2020 2320 4942 4d20  k.no_ibm  # IBM 
-00017860: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
-00017870: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-00017880: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-00017890: 726b 2e6e 6f5f 7363 7020 2023 2053 4350  rk.no_scp  # SCP
-000178a0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-000178b0: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-000178c0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-000178d0: 5f70 6170 6572 7370 6163 6520 2023 2050  _paperspace  # P
-000178e0: 6170 6572 7370 6163 6520 646f 6573 206e  aperspace does n
-000178f0: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-00017900: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-00017910: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
-00017920: 6574 6573 2020 2320 4b75 6265 726e 6574  etes  # Kubernet
-00017930: 6573 2064 6f65 7320 6e6f 7420 6861 7665  es does not have
-00017940: 2061 206e 6f74 696f 6e20 6f66 2073 706f   a notion of spo
-00017950: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-00017960: 6573 742e 6d61 726b 2e6d 616e 6167 6564  est.mark.managed
-00017970: 5f73 706f 740a 6465 6620 7465 7374 5f73  _spot.def test_s
-00017980: 706f 745f 7069 7065 6c69 6e65 5f66 6169  pot_pipeline_fai
-00017990: 6c65 645f 7365 7475 7028 6765 6e65 7269  led_setup(generi
-000179a0: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-000179b0: 2020 2022 2222 5465 7374 206d 616e 6167     """Test manag
-000179c0: 6564 2073 706f 7420 6a6f 6220 7769 7468  ed spot job with
-000179d0: 2066 6169 6c65 6420 7365 7475 7020 666f   failed setup fo
-000179e0: 7220 6120 7069 7065 6c69 6e65 2e22 2222  r a pipeline."""
-000179f0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00017a00: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-00017a10: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00017a20: 0a20 2020 2020 2020 2027 7370 6f74 5f70  .        'spot_p
-00017a30: 6970 656c 696e 655f 6661 696c 6564 5f73  ipeline_failed_s
-00017a40: 6574 7570 272c 0a20 2020 2020 2020 205b  etup',.        [
-00017a50: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00017a60: 6b79 2073 706f 7420 6c61 756e 6368 202d  ky spot launch -
-00017a70: 6e20 7b6e 616d 657d 202d 7920 2d64 2074  n {name} -y -d t
-00017a80: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
-00017a90: 6661 696c 6564 5f73 6574 7570 5f70 6970  failed_setup_pip
-00017aa0: 656c 696e 652e 7961 6d6c 272c 0a20 2020  eline.yaml',.   
-00017ab0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00017ac0: 3830 3027 2c0a 2020 2020 2020 2020 2020  800',.          
-00017ad0: 2020 2320 4d61 6b65 2073 7572 6520 7468    # Make sure th
-00017ae0: 6520 6a6f 6220 6661 696c 6564 2071 7569  e job failed qui
-00017af0: 636b 6c79 2e0a 2020 2020 2020 2020 2020  ckly..          
-00017b00: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-00017b10: 5f57 4149 547d 207c 2067 7265 7020 7b6e  _WAIT} | grep {n
-00017b20: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
-00017b30: 7c20 6772 6570 2022 4641 494c 4544 5f53  | grep "FAILED_S
-00017b40: 4554 5550 2227 2c0a 2020 2020 2020 2020  ETUP"',.        
-00017b50: 2020 2020 2320 5461 736b 2030 2073 686f      # Task 0 sho
-00017b60: 756c 6420 6265 2053 5543 4345 4544 4544  uld be SUCCEEDED
-00017b70: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00017b80: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-00017b90: 547d 207c 2067 7265 7020 2d41 2034 207b  T} | grep -A 4 {
-00017ba0: 6e61 6d65 7d7c 2073 6564 202d 6e20 3270  name}| sed -n 2p
-00017bb0: 207c 2067 7265 7020 2253 5543 4345 4544   | grep "SUCCEED
-00017bc0: 4544 2227 2c0a 2020 2020 2020 2020 2020  ED"',.          
-00017bd0: 2020 2320 5461 736b 2031 2073 686f 756c    # Task 1 shoul
-00017be0: 6420 6265 2046 4149 4c45 445f 5345 5455  d be FAILED_SETU
-00017bf0: 502e 0a20 2020 2020 2020 2020 2020 2066  P..            f
-00017c00: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-00017c10: 4954 7d20 7c20 6772 6570 202d 4120 3420  IT} | grep -A 4 
-00017c20: 7b6e 616d 657d 7c20 7365 6420 2d6e 2033  {name}| sed -n 3
-00017c30: 7020 7c20 6772 6570 2022 4641 494c 4544  p | grep "FAILED
-00017c40: 5f53 4554 5550 2227 2c0a 2020 2020 2020  _SETUP"',.      
-00017c50: 2020 2020 2020 2320 5461 736b 2032 2073        # Task 2 s
-00017c60: 686f 756c 6420 6265 2043 414e 4345 4c4c  hould be CANCELL
-00017c70: 4544 2e0a 2020 2020 2020 2020 2020 2020  ED..            
-00017c80: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-00017c90: 4149 547d 207c 2067 7265 7020 2d41 2034  AIT} | grep -A 4
-00017ca0: 207b 6e61 6d65 7d7c 2073 6564 202d 6e20   {name}| sed -n 
-00017cb0: 3470 207c 2067 7265 7020 2243 414e 4345  4p | grep "CANCE
-00017cc0: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
-00017cd0: 2020 2020 2320 5461 736b 2033 2073 686f      # Task 3 sho
-00017ce0: 756c 6420 6265 2043 414e 4345 4c4c 4544  uld be CANCELLED
-00017cf0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00017d00: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-00017d10: 547d 207c 2067 7265 7020 2d41 2034 207b  T} | grep -A 4 {
-00017d20: 6e61 6d65 7d7c 2073 6564 202d 6e20 3570  name}| sed -n 5p
-00017d30: 207c 2067 7265 7020 2243 414e 4345 4c4c   | grep "CANCELL
-00017d40: 4544 2227 2c0a 2020 2020 2020 2020 5d2c  ED"',.        ],
-00017d50: 0a20 2020 2020 2020 205f 5350 4f54 5f43  .        _SPOT_C
-00017d60: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
-00017d70: 7428 6a6f 625f 6e61 6d65 3d6e 616d 6529  t(job_name=name)
-00017d80: 2c0a 2020 2020 2020 2020 2320 496e 6372  ,.        # Incr
-00017d90: 6561 7365 2074 696d 656f 7574 2073 696e  ease timeout sin
-00017da0: 6365 2073 6b79 2073 706f 7420 7175 6575  ce sky spot queu
-00017db0: 6520 2d72 2063 616e 2062 6520 626c 6f63  e -r can be bloc
-00017dc0: 6b65 6420 6279 206f 7468 6572 2073 706f  ked by other spo
-00017dd0: 7420 7465 7374 732e 0a20 2020 2020 2020  t tests..       
-00017de0: 2074 696d 656f 7574 3d33 3020 2a20 3630   timeout=30 * 60
-00017df0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00017e00: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00017e10: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
-00017e20: 7374 696e 6720 6d61 6e61 6765 6420 7370  sting managed sp
-00017e30: 6f74 2072 6563 6f76 6572 7920 2d2d 2d2d  ot recovery ----
-00017e40: 2d2d 2d2d 2d2d 0a0a 0a40 7079 7465 7374  ------...@pytest
-00017e50: 2e6d 6172 6b2e 6177 730a 4070 7974 6573  .mark.aws.@pytes
-00017e60: 742e 6d61 726b 2e6d 616e 6167 6564 5f73  t.mark.managed_s
-00017e70: 706f 740a 6465 6620 7465 7374 5f73 706f  pot.def test_spo
-00017e80: 745f 7265 636f 7665 7279 5f61 7773 2861  t_recovery_aws(a
-00017e90: 7773 5f63 6f6e 6669 675f 7265 6769 6f6e  ws_config_region
-00017ea0: 293a 0a20 2020 2022 2222 5465 7374 206d  ):.    """Test m
-00017eb0: 616e 6167 6564 2073 706f 7420 7265 636f  anaged spot reco
-00017ec0: 7665 7279 2e22 2222 0a20 2020 206e 616d  very.""".    nam
-00017ed0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00017ee0: 5f6e 616d 6528 290a 2020 2020 6e61 6d65  _name().    name
-00017ef0: 5f6f 6e5f 636c 6f75 6420 3d20 636f 6d6d  _on_cloud = comm
-00017f00: 6f6e 5f75 7469 6c73 2e6d 616b 655f 636c  on_utils.make_cl
-00017f10: 7573 7465 725f 6e61 6d65 5f6f 6e5f 636c  uster_name_on_cl
-00017f20: 6f75 6428 0a20 2020 2020 2020 206e 616d  oud(.        nam
-00017f30: 652c 2073 706f 742e 5350 4f54 5f43 4c55  e, spot.SPOT_CLU
-00017f40: 5354 4552 5f4e 414d 455f 5052 4546 4958  STER_NAME_PREFIX
-00017f50: 5f4c 454e 4754 482c 2061 6464 5f75 7365  _LENGTH, add_use
-00017f60: 725f 6861 7368 3d46 616c 7365 290a 2020  r_hash=False).  
-00017f70: 2020 7265 6769 6f6e 203d 2061 7773 5f63    region = aws_c
-00017f80: 6f6e 6669 675f 7265 6769 6f6e 0a20 2020  onfig_region.   
-00017f90: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00017fa0: 2020 2020 2020 2773 706f 745f 7265 636f        'spot_reco
-00017fb0: 7665 7279 5f61 7773 272c 0a20 2020 2020  very_aws',.     
-00017fc0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00017fd0: 2066 2773 6b79 2073 706f 7420 6c61 756e   f'sky spot laun
-00017fe0: 6368 202d 2d63 6c6f 7564 2061 7773 202d  ch --cloud aws -
-00017ff0: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
-00018000: 202d 6e20 7b6e 616d 657d 2022 6563 686f   -n {name} "echo
-00018010: 2053 4b59 5049 4c4f 545f 5441 534b 5f49   SKYPILOT_TASK_I
-00018020: 443a 205c 2453 4b59 5049 4c4f 545f 5441  D: \$SKYPILOT_TA
-00018030: 534b 5f49 443b 2073 6c65 6570 2031 3830  SK_ID; sleep 180
-00018040: 3022 2020 2d79 202d 6427 2c0a 2020 2020  0"  -y -d',.    
-00018050: 2020 2020 2020 2020 2773 6c65 6570 2033          'sleep 3
-00018060: 3630 272c 0a20 2020 2020 2020 2020 2020  60',.           
-00018070: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-00018080: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
-00018090: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
-000180a0: 6772 6570 2022 5255 4e4e 494e 4722 272c  grep "RUNNING"',
-000180b0: 0a20 2020 2020 2020 2020 2020 2066 2752  .            f'R
-000180c0: 554e 5f49 443d 2428 736b 7920 7370 6f74  UN_ID=$(sky spot
-000180d0: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
-000180e0: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
-000180f0: 6570 2053 4b59 5049 4c4f 545f 5441 534b  ep SKYPILOT_TASK
-00018100: 5f49 4420 7c20 6375 7420 2d64 3a20 2d66  _ID | cut -d: -f
-00018110: 3229 3b20 6563 686f 2022 2452 554e 5f49  2); echo "$RUN_I
-00018120: 4422 207c 2074 6565 202f 746d 702f 7b6e  D" | tee /tmp/{n
-00018130: 616d 657d 2d72 756e 2d69 6427 2c0a 2020  ame}-run-id',.  
-00018140: 2020 2020 2020 2020 2020 2320 5465 726d            # Term
-00018150: 696e 6174 6520 7468 6520 636c 7573 7465  inate the cluste
-00018160: 7220 6d61 6e75 616c 6c79 2e0a 2020 2020  r manually..    
-00018170: 2020 2020 2020 2020 2866 2761 7773 2065          (f'aws e
-00018180: 6332 2074 6572 6d69 6e61 7465 2d69 6e73  c2 terminate-ins
-00018190: 7461 6e63 6573 202d 2d72 6567 696f 6e20  tances --region 
-000181a0: 7b72 6567 696f 6e7d 202d 2d69 6e73 7461  {region} --insta
-000181b0: 6e63 652d 6964 7320 2428 270a 2020 2020  nce-ids $('.    
-000181c0: 2020 2020 2020 2020 2066 2761 7773 2065           f'aws e
-000181d0: 6332 2064 6573 6372 6962 652d 696e 7374  c2 describe-inst
-000181e0: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
-000181f0: 7265 6769 6f6e 7d20 270a 2020 2020 2020  region} '.      
-00018200: 2020 2020 2020 2066 272d 2d66 696c 7465         f'--filte
-00018210: 7273 204e 616d 653d 7461 673a 7261 792d  rs Name=tag:ray-
-00018220: 636c 7573 7465 722d 6e61 6d65 2c56 616c  cluster-name,Val
-00018230: 7565 733d 7b6e 616d 655f 6f6e 5f63 6c6f  ues={name_on_clo
-00018240: 7564 7d2a 2027 0a20 2020 2020 2020 2020  ud}* '.         
-00018250: 2020 2020 6627 2d2d 7175 6572 7920 5265      f'--query Re
-00018260: 7365 7276 6174 696f 6e73 5b5d 2e49 6e73  servations[].Ins
-00018270: 7461 6e63 6573 5b5d 2e49 6e73 7461 6e63  tances[].Instanc
-00018280: 6549 6420 270a 2020 2020 2020 2020 2020  eId '.          
-00018290: 2020 2027 2d2d 6f75 7470 7574 2074 6578     '--output tex
-000182a0: 7429 2729 2c0a 2020 2020 2020 2020 2020  t)'),.          
-000182b0: 2020 2773 6c65 6570 2031 3030 272c 0a20    'sleep 100',. 
-000182c0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-000182d0: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-000182e0: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-000182f0: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-00018300: 5245 434f 5645 5249 4e47 2227 2c0a 2020  RECOVERING"',.  
-00018310: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-00018320: 2032 3030 272c 0a20 2020 2020 2020 2020   200',.         
-00018330: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-00018340: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-00018350: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
-00018360: 7c20 6772 6570 2022 5255 4e4e 494e 4722  | grep "RUNNING"
-00018370: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00018380: 2752 554e 5f49 443d 2428 6361 7420 2f74  'RUN_ID=$(cat /t
-00018390: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
-000183a0: 293b 2065 6368 6f20 2452 554e 5f49 443b  ); echo $RUN_ID;
-000183b0: 2073 6b79 2073 706f 7420 6c6f 6773 202d   sky spot logs -
-000183c0: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
-000183d0: 6c6c 6f77 207c 2067 7265 7020 534b 5950  llow | grep SKYP
-000183e0: 494c 4f54 5f54 4153 4b5f 4944 207c 2067  ILOT_TASK_ID | g
-000183f0: 7265 7020 2224 5255 4e5f 4944 2227 2c0a  rep "$RUN_ID"',.
-00018400: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00018410: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
-00018420: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
-00018430: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
-00018440: 2020 2020 7469 6d65 6f75 743d 3235 202a      timeout=25 *
-00018450: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
-00018460: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00018470: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00018480: 2e67 6370 0a40 7079 7465 7374 2e6d 6172  .gcp.@pytest.mar
-00018490: 6b2e 6d61 6e61 6765 645f 7370 6f74 0a64  k.managed_spot.d
-000184a0: 6566 2074 6573 745f 7370 6f74 5f72 6563  ef test_spot_rec
-000184b0: 6f76 6572 795f 6763 7028 293a 0a20 2020  overy_gcp():.   
-000184c0: 2022 2222 5465 7374 206d 616e 6167 6564   """Test managed
-000184d0: 2073 706f 7420 7265 636f 7665 7279 2e22   spot recovery."
-000184e0: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
-000184f0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-00018500: 290a 2020 2020 6e61 6d65 5f6f 6e5f 636c  ).    name_on_cl
-00018510: 6f75 6420 3d20 636f 6d6d 6f6e 5f75 7469  oud = common_uti
-00018520: 6c73 2e6d 616b 655f 636c 7573 7465 725f  ls.make_cluster_
-00018530: 6e61 6d65 5f6f 6e5f 636c 6f75 6428 0a20  name_on_cloud(. 
-00018540: 2020 2020 2020 206e 616d 652c 2073 706f         name, spo
-00018550: 742e 5350 4f54 5f43 4c55 5354 4552 5f4e  t.SPOT_CLUSTER_N
-00018560: 414d 455f 5052 4546 4958 5f4c 454e 4754  AME_PREFIX_LENGT
-00018570: 482c 2061 6464 5f75 7365 725f 6861 7368  H, add_user_hash
-00018580: 3d46 616c 7365 290a 2020 2020 7a6f 6e65  =False).    zone
-00018590: 203d 2027 7573 2d65 6173 7434 2d62 270a   = 'us-east4-b'.
-000185a0: 2020 2020 7175 6572 795f 636d 6420 3d20      query_cmd = 
-000185b0: 280a 2020 2020 2020 2020 6627 6763 6c6f  (.        f'gclo
-000185c0: 7564 2063 6f6d 7075 7465 2069 6e73 7461  ud compute insta
-000185d0: 6e63 6573 206c 6973 7420 2d2d 6669 6c74  nces list --filt
-000185e0: 6572 3d27 0a20 2020 2020 2020 2023 2060  er='.        # `
-000185f0: 3a60 206d 6561 6e73 2070 7265 6669 7820  :` means prefix 
-00018600: 6d61 7463 682e 0a20 2020 2020 2020 2066  match..        f
-00018610: 2722 286c 6162 656c 732e 7261 792d 636c  '"(labels.ray-cl
-00018620: 7573 7465 722d 6e61 6d65 3a7b 6e61 6d65  uster-name:{name
-00018630: 5f6f 6e5f 636c 6f75 647d 2922 2027 0a20  _on_cloud})" '. 
-00018640: 2020 2020 2020 2066 272d 2d7a 6f6e 6573         f'--zones
-00018650: 3d7b 7a6f 6e65 7d20 2d2d 666f 726d 6174  ={zone} --format
-00018660: 3d22 7661 6c75 6528 6e61 6d65 2922 2729  ="value(name)"')
-00018670: 0a20 2020 2074 6572 6d69 6e61 7465 5f63  .    terminate_c
-00018680: 6d64 203d 2028 6627 6763 6c6f 7564 2063  md = (f'gcloud c
-00018690: 6f6d 7075 7465 2069 6e73 7461 6e63 6573  ompute instances
-000186a0: 2064 656c 6574 6520 2d2d 7a6f 6e65 3d7b   delete --zone={
-000186b0: 7a6f 6e65 7d27 0a20 2020 2020 2020 2020  zone}'.         
-000186c0: 2020 2020 2020 2020 2020 2020 6627 202d              f' -
-000186d0: 2d71 7569 6574 2024 287b 7175 6572 795f  -quiet $({query_
-000186e0: 636d 647d 2927 290a 2020 2020 7465 7374  cmd})').    test
-000186f0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00018700: 2027 7370 6f74 5f72 6563 6f76 6572 795f   'spot_recovery_
-00018710: 6763 7027 2c0a 2020 2020 2020 2020 5b0a  gcp',.        [.
-00018720: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00018730: 7920 7370 6f74 206c 6175 6e63 6820 2d2d  y spot launch --
-00018740: 636c 6f75 6420 6763 7020 2d2d 7a6f 6e65  cloud gcp --zone
-00018750: 207b 7a6f 6e65 7d20 2d6e 207b 6e61 6d65   {zone} -n {name
-00018760: 7d20 2d2d 6370 7573 2032 2022 6563 686f  } --cpus 2 "echo
-00018770: 2053 4b59 5049 4c4f 545f 5441 534b 5f49   SKYPILOT_TASK_I
-00018780: 443a 205c 2453 4b59 5049 4c4f 545f 5441  D: \$SKYPILOT_TA
-00018790: 534b 5f49 443b 2073 6c65 6570 2031 3830  SK_ID; sleep 180
-000187a0: 3022 2020 2d79 202d 6427 2c0a 2020 2020  0"  -y -d',.    
-000187b0: 2020 2020 2020 2020 2773 6c65 6570 2033          'sleep 3
-000187c0: 3630 272c 0a20 2020 2020 2020 2020 2020  60',.           
-000187d0: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-000187e0: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
-000187f0: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
-00018800: 6772 6570 2022 5255 4e4e 494e 4722 272c  grep "RUNNING"',
-00018810: 0a20 2020 2020 2020 2020 2020 2066 2752  .            f'R
-00018820: 554e 5f49 443d 2428 736b 7920 7370 6f74  UN_ID=$(sky spot
-00018830: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
-00018840: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
-00018850: 6570 2053 4b59 5049 4c4f 545f 5441 534b  ep SKYPILOT_TASK
-00018860: 5f49 4420 7c20 6375 7420 2d64 3a20 2d66  _ID | cut -d: -f
-00018870: 3229 3b20 6563 686f 2022 2452 554e 5f49  2); echo "$RUN_I
-00018880: 4422 207c 2074 6565 202f 746d 702f 7b6e  D" | tee /tmp/{n
-00018890: 616d 657d 2d72 756e 2d69 6427 2c0a 2020  ame}-run-id',.  
-000188a0: 2020 2020 2020 2020 2020 2320 5465 726d            # Term
-000188b0: 696e 6174 6520 7468 6520 636c 7573 7465  inate the cluste
-000188c0: 7220 6d61 6e75 616c 6c79 2e0a 2020 2020  r manually..    
-000188d0: 2020 2020 2020 2020 7465 726d 696e 6174          terminat
-000188e0: 655f 636d 642c 0a20 2020 2020 2020 2020  e_cmd,.         
-000188f0: 2020 2027 736c 6565 7020 3630 272c 0a20     'sleep 60',. 
-00018900: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00018910: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-00018920: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-00018930: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-00018940: 5245 434f 5645 5249 4e47 2227 2c0a 2020  RECOVERING"',.  
-00018950: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-00018960: 2032 3030 272c 0a20 2020 2020 2020 2020   200',.         
-00018970: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-00018980: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-00018990: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
-000189a0: 7c20 6772 6570 2022 5255 4e4e 494e 4722  | grep "RUNNING"
-000189b0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000189c0: 2752 554e 5f49 443d 2428 6361 7420 2f74  'RUN_ID=$(cat /t
-000189d0: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
-000189e0: 293b 2065 6368 6f20 2452 554e 5f49 443b  ); echo $RUN_ID;
-000189f0: 2073 6b79 2073 706f 7420 6c6f 6773 202d   sky spot logs -
-00018a00: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
-00018a10: 6c6c 6f77 207c 2067 7265 7020 534b 5950  llow | grep SKYP
-00018a20: 494c 4f54 5f54 4153 4b5f 4944 3a20 7c20  ILOT_TASK_ID: | 
-00018a30: 6772 6570 2022 2452 554e 5f49 4422 272c  grep "$RUN_ID"',
-00018a40: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00018a50: 2020 2020 5f53 504f 545f 4341 4e43 454c      _SPOT_CANCEL
-00018a60: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
-00018a70: 5f6e 616d 653d 6e61 6d65 292c 0a20 2020  _name=name),.   
-00018a80: 2020 2020 2074 696d 656f 7574 3d32 3520       timeout=25 
-00018a90: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
-00018aa0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00018ab0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00018ac0: 6b2e 6177 730a 4070 7974 6573 742e 6d61  k.aws.@pytest.ma
-00018ad0: 726b 2e6d 616e 6167 6564 5f73 706f 740a  rk.managed_spot.
-00018ae0: 6465 6620 7465 7374 5f73 706f 745f 7069  def test_spot_pi
-00018af0: 7065 6c69 6e65 5f72 6563 6f76 6572 795f  peline_recovery_
-00018b00: 6177 7328 6177 735f 636f 6e66 6967 5f72  aws(aws_config_r
-00018b10: 6567 696f 6e29 3a0a 2020 2020 2222 2254  egion):.    """T
-00018b20: 6573 7420 6d61 6e61 6765 6420 7370 6f74  est managed spot
-00018b30: 2072 6563 6f76 6572 7920 666f 7220 6120   recovery for a 
-00018b40: 7069 7065 6c69 6e65 2e22 2222 0a20 2020  pipeline.""".   
-00018b50: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00018b60: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00018b70: 7573 6572 5f68 6173 6820 3d20 636f 6d6d  user_hash = comm
-00018b80: 6f6e 5f75 7469 6c73 2e67 6574 5f75 7365  on_utils.get_use
-00018b90: 725f 6861 7368 2829 0a20 2020 2075 7365  r_hash().    use
-00018ba0: 725f 6861 7368 203d 2075 7365 725f 6861  r_hash = user_ha
-00018bb0: 7368 5b3a 636f 6d6d 6f6e 5f75 7469 6c73  sh[:common_utils
-00018bc0: 2e55 5345 525f 4841 5348 5f4c 454e 4754  .USER_HASH_LENGT
-00018bd0: 485f 494e 5f43 4c55 5354 4552 5f4e 414d  H_IN_CLUSTER_NAM
-00018be0: 455d 0a20 2020 2072 6567 696f 6e20 3d20  E].    region = 
-00018bf0: 6177 735f 636f 6e66 6967 5f72 6567 696f  aws_config_regio
-00018c00: 6e0a 2020 2020 6966 2072 6567 696f 6e20  n.    if region 
-00018c10: 213d 2027 7573 2d65 6173 742d 3227 3a0a  != 'us-east-2':.
-00018c20: 2020 2020 2020 2020 7079 7465 7374 2e73          pytest.s
-00018c30: 6b69 7028 274f 6e6c 7920 7275 6e20 7370  kip('Only run sp
-00018c40: 6f74 2070 6970 656c 696e 6520 7265 636f  ot pipeline reco
-00018c50: 7665 7279 2074 6573 7420 696e 2075 732d  very test in us-
-00018c60: 6561 7374 2d32 2729 0a20 2020 2074 6573  east-2').    tes
-00018c70: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00018c80: 2020 2773 706f 745f 7069 7065 6c69 6e65    'spot_pipeline
-00018c90: 5f72 6563 6f76 6572 795f 6177 7327 2c0a  _recovery_aws',.
-00018ca0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00018cb0: 2020 2020 2020 6627 736b 7920 7370 6f74        f'sky spot
-00018cc0: 206c 6175 6e63 6820 2d6e 207b 6e61 6d65   launch -n {name
-00018cd0: 7d20 7465 7374 732f 7465 7374 5f79 616d  } tests/test_yam
-00018ce0: 6c73 2f70 6970 656c 696e 655f 6177 732e  ls/pipeline_aws.
-00018cf0: 7961 6d6c 2020 2d79 202d 6427 2c0a 2020  yaml  -y -d',.  
-00018d00: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-00018d10: 2034 3030 272c 0a20 2020 2020 2020 2020   400',.         
-00018d20: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-00018d30: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-00018d40: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
-00018d50: 7c20 6772 6570 2022 5255 4e4e 494e 4722  | grep "RUNNING"
-00018d60: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00018d70: 2752 554e 5f49 443d 2428 736b 7920 7370  'RUN_ID=$(sky sp
-00018d80: 6f74 206c 6f67 7320 2d6e 207b 6e61 6d65  ot logs -n {name
-00018d90: 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  } --no-follow | 
-00018da0: 6772 6570 2053 4b59 5049 4c4f 545f 5441  grep SKYPILOT_TA
-00018db0: 534b 5f49 443a 207c 2063 7574 202d 643a  SK_ID: | cut -d:
-00018dc0: 202d 6632 293b 2065 6368 6f20 2224 5255   -f2); echo "$RU
-00018dd0: 4e5f 4944 2220 7c20 7465 6520 2f74 6d70  N_ID" | tee /tmp
-00018de0: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 272c  /{name}-run-id',
-00018df0: 0a20 2020 2020 2020 2020 2020 2066 2752  .            f'R
-00018e00: 554e 5f49 4453 3d24 2873 6b79 2073 706f  UN_IDS=$(sky spo
-00018e10: 7420 6c6f 6773 202d 6e20 7b6e 616d 657d  t logs -n {name}
-00018e20: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
-00018e30: 7265 7020 2d41 2034 2053 4b59 5049 4c4f  rep -A 4 SKYPILO
-00018e40: 545f 5441 534b 5f49 4453 207c 2063 7574  T_TASK_IDS | cut
-00018e50: 202d 6422 2922 202d 6632 293b 2065 6368   -d")" -f2); ech
-00018e60: 6f20 2224 5255 4e5f 4944 5322 207c 2074  o "$RUN_IDS" | t
-00018e70: 6565 202f 746d 702f 7b6e 616d 657d 2d72  ee /tmp/{name}-r
-00018e80: 756e 2d69 6473 272c 0a20 2020 2020 2020  un-ids',.       
-00018e90: 2020 2020 2023 2054 6572 6d69 6e61 7465       # Terminate
-00018ea0: 2074 6865 2063 6c75 7374 6572 206d 616e   the cluster man
-00018eb0: 7561 6c6c 792e 0a20 2020 2020 2020 2020  ually..         
-00018ec0: 2020 2023 2054 6865 2060 6361 7420 2e2e     # The `cat ..
-00018ed0: 2e7c 2072 6576 6020 6973 2074 6f20 7265  .| rev` is to re
-00018ee0: 7472 6965 7665 2074 6865 206a 6f62 5f69  trieve the job_i
-00018ef0: 6420 6672 6f6d 2074 6865 0a20 2020 2020  d from the.     
-00018f00: 2020 2020 2020 2023 2053 4b59 5049 4c4f         # SKYPILO
-00018f10: 545f 5441 534b 5f49 442c 2077 6869 6368  T_TASK_ID, which
-00018f20: 2067 6574 7320 7468 6520 7365 636f 6e64   gets the second
-00018f30: 2074 6f20 6c61 7374 2066 6965 6c64 0a20   to last field. 
-00018f40: 2020 2020 2020 2020 2020 2023 2073 6570             # sep
-00018f50: 6172 6174 6564 2062 7920 602d 602e 0a20  arated by `-`.. 
-00018f60: 2020 2020 2020 2020 2020 2028 0a20 2020             (.   
-00018f70: 2020 2020 2020 2020 2020 2020 2066 2753               f'S
-00018f80: 504f 545f 4a4f 425f 4944 3d60 6361 7420  POT_JOB_ID=`cat 
-00018f90: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
-00018fa0: 6964 207c 2072 6576 207c 2027 0a20 2020  id | rev | '.   
-00018fb0: 2020 2020 2020 2020 2020 2020 2027 6375               'cu
-00018fc0: 7420 2d64 5c27 5f5c 2720 2d66 3120 7c20  t -d\'_\' -f1 | 
-00018fd0: 7265 7620 7c20 6375 7420 2d64 5c27 2d5c  rev | cut -d\'-\
-00018fe0: 2720 2d66 3160 3b27 0a20 2020 2020 2020  ' -f1`;'.       
-00018ff0: 2020 2020 2020 2020 2066 2761 7773 2065           f'aws e
-00019000: 6332 2074 6572 6d69 6e61 7465 2d69 6e73  c2 terminate-ins
-00019010: 7461 6e63 6573 202d 2d72 6567 696f 6e20  tances --region 
-00019020: 7b72 6567 696f 6e7d 202d 2d69 6e73 7461  {region} --insta
-00019030: 6e63 652d 6964 7320 2428 270a 2020 2020  nce-ids $('.    
-00019040: 2020 2020 2020 2020 2020 2020 6627 6177              f'aw
-00019050: 7320 6563 3220 6465 7363 7269 6265 2d69  s ec2 describe-i
-00019060: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
-00019070: 6e20 7b72 6567 696f 6e7d 2027 0a20 2020  n {region} '.   
-00019080: 2020 2020 2020 2020 2020 2020 2023 2054               # T
-00019090: 4f44 4f28 7a68 7775 293a 2066 6978 2074  ODO(zhwu): fix t
-000190a0: 6865 206e 616d 6520 666f 7220 7370 6f74  he name for spot
-000190b0: 2063 6c75 7374 6572 2e0a 2020 2020 2020   cluster..      
-000190c0: 2020 2020 2020 2020 2020 272d 2d66 696c            '--fil
-000190d0: 7465 7273 204e 616d 653d 7461 673a 7261  ters Name=tag:ra
-000190e0: 792d 636c 7573 7465 722d 6e61 6d65 2c56  y-cluster-name,V
-000190f0: 616c 7565 733d 2a2d 247b 5350 4f54 5f4a  alues=*-${SPOT_J
-00019100: 4f42 5f49 447d 270a 2020 2020 2020 2020  OB_ID}'.        
-00019110: 2020 2020 2020 2020 6627 2d7b 7573 6572          f'-{user
-00019120: 5f68 6173 687d 2027 0a20 2020 2020 2020  _hash} '.       
-00019130: 2020 2020 2020 2020 2066 272d 2d71 7565           f'--que
-00019140: 7279 2052 6573 6572 7661 7469 6f6e 735b  ry Reservations[
-00019150: 5d2e 496e 7374 616e 6365 735b 5d2e 496e  ].Instances[].In
-00019160: 7374 616e 6365 4964 2027 0a20 2020 2020  stanceId '.     
-00019170: 2020 2020 2020 2020 2020 2027 2d2d 6f75             '--ou
-00019180: 7470 7574 2074 6578 7429 2729 2c0a 2020  tput text)'),.  
-00019190: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-000191a0: 2031 3030 272c 0a20 2020 2020 2020 2020   100',.         
-000191b0: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-000191c0: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-000191d0: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
-000191e0: 7c20 6772 6570 2022 5245 434f 5645 5249  | grep "RECOVERI
-000191f0: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
-00019200: 2020 2773 6c65 6570 2032 3030 272c 0a20    'sleep 200',. 
-00019210: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00019220: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-00019230: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-00019240: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-00019250: 5255 4e4e 494e 4722 272c 0a20 2020 2020  RUNNING"',.     
-00019260: 2020 2020 2020 2066 2752 554e 5f49 443d         f'RUN_ID=
-00019270: 2428 6361 7420 2f74 6d70 2f7b 6e61 6d65  $(cat /tmp/{name
-00019280: 7d2d 7275 6e2d 6964 293b 2065 6368 6f20  }-run-id); echo 
-00019290: 2452 554e 5f49 443b 2073 6b79 2073 706f  $RUN_ID; sky spo
-000192a0: 7420 6c6f 6773 202d 6e20 7b6e 616d 657d  t logs -n {name}
-000192b0: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
-000192c0: 7265 7020 534b 5950 494c 4f54 5f54 4153  rep SKYPILOT_TAS
-000192d0: 4b5f 4944 3a20 7c20 6772 6570 2022 2452  K_ID: | grep "$R
-000192e0: 554e 5f49 4422 272c 0a20 2020 2020 2020  UN_ID"',.       
-000192f0: 2020 2020 2066 2752 554e 5f49 4453 3d24       f'RUN_IDS=$
-00019300: 2873 6b79 2073 706f 7420 6c6f 6773 202d  (sky spot logs -
-00019310: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
-00019320: 6c6c 6f77 207c 2067 7265 7020 2d41 2034  llow | grep -A 4
-00019330: 2053 4b59 5049 4c4f 545f 5441 534b 5f49   SKYPILOT_TASK_I
-00019340: 4453 207c 2063 7574 202d 6422 2922 202d  DS | cut -d")" -
-00019350: 6632 293b 2065 6368 6f20 2224 5255 4e5f  f2); echo "$RUN_
-00019360: 4944 5322 207c 2074 6565 202f 746d 702f  IDS" | tee /tmp/
-00019370: 7b6e 616d 657d 2d72 756e 2d69 6473 2d6e  {name}-run-ids-n
-00019380: 6577 272c 0a20 2020 2020 2020 2020 2020  ew',.           
-00019390: 2066 2764 6966 6620 2f74 6d70 2f7b 6e61   f'diff /tmp/{na
-000193a0: 6d65 7d2d 7275 6e2d 6964 7320 2f74 6d70  me}-run-ids /tmp
-000193b0: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 732d  /{name}-run-ids-
-000193c0: 6e65 7727 2c0a 2020 2020 2020 2020 2020  new',.          
-000193d0: 2020 6627 6361 7420 2f74 6d70 2f7b 6e61    f'cat /tmp/{na
-000193e0: 6d65 7d2d 7275 6e2d 6964 7320 7c20 7365  me}-run-ids | se
-000193f0: 6420 2d6e 2032 7020 7c20 6772 6570 2060  d -n 2p | grep `
-00019400: 6361 7420 2f74 6d70 2f7b 6e61 6d65 7d2d  cat /tmp/{name}-
-00019410: 7275 6e2d 6964 6027 2c0a 2020 2020 2020  run-id`',.      
-00019420: 2020 5d2c 0a20 2020 2020 2020 205f 5350    ],.        _SP
-00019430: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
-00019440: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d6e  ormat(job_name=n
-00019450: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
-00019460: 6d65 6f75 743d 3235 202a 2036 302c 0a20  meout=25 * 60,. 
-00019470: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00019480: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-00019490: 7974 6573 742e 6d61 726b 2e67 6370 0a40  ytest.mark.gcp.@
-000194a0: 7079 7465 7374 2e6d 6172 6b2e 6d61 6e61  pytest.mark.mana
-000194b0: 6765 645f 7370 6f74 0a64 6566 2074 6573  ged_spot.def tes
-000194c0: 745f 7370 6f74 5f70 6970 656c 696e 655f  t_spot_pipeline_
-000194d0: 7265 636f 7665 7279 5f67 6370 2829 3a0a  recovery_gcp():.
-000194e0: 2020 2020 2222 2254 6573 7420 6d61 6e61      """Test mana
-000194f0: 6765 6420 7370 6f74 2072 6563 6f76 6572  ged spot recover
-00019500: 7920 666f 7220 6120 7069 7065 6c69 6e65  y for a pipeline
-00019510: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
-00019520: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00019530: 6528 290a 2020 2020 7a6f 6e65 203d 2027  e().    zone = '
-00019540: 7573 2d65 6173 7434 2d62 270a 2020 2020  us-east4-b'.    
-00019550: 7573 6572 5f68 6173 6820 3d20 636f 6d6d  user_hash = comm
-00019560: 6f6e 5f75 7469 6c73 2e67 6574 5f75 7365  on_utils.get_use
-00019570: 725f 6861 7368 2829 0a20 2020 2075 7365  r_hash().    use
-00019580: 725f 6861 7368 203d 2075 7365 725f 6861  r_hash = user_ha
-00019590: 7368 5b3a 636f 6d6d 6f6e 5f75 7469 6c73  sh[:common_utils
-000195a0: 2e55 5345 525f 4841 5348 5f4c 454e 4754  .USER_HASH_LENGT
-000195b0: 485f 494e 5f43 4c55 5354 4552 5f4e 414d  H_IN_CLUSTER_NAM
-000195c0: 455d 0a20 2020 2071 7565 7279 5f63 6d64  E].    query_cmd
-000195d0: 203d 2028 2767 636c 6f75 6420 636f 6d70   = ('gcloud comp
-000195e0: 7574 6520 696e 7374 616e 6365 7320 6c69  ute instances li
-000195f0: 7374 202d 2d66 696c 7465 723d 270a 2020  st --filter='.  
-00019600: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00019610: 2722 286c 6162 656c 732e 7261 792d 636c  '"(labels.ray-cl
-00019620: 7573 7465 722d 6e61 6d65 3a2a 2d24 7b7b  uster-name:*-${{
-00019630: 5350 4f54 5f4a 4f42 5f49 447d 7d2d 7b75  SPOT_JOB_ID}}-{u
-00019640: 7365 725f 6861 7368 7d29 2220 270a 2020  ser_hash})" '.  
-00019650: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00019660: 272d 2d7a 6f6e 6573 3d7b 7a6f 6e65 7d20  '--zones={zone} 
-00019670: 2d2d 666f 726d 6174 3d22 7661 6c75 6528  --format="value(
-00019680: 6e61 6d65 2922 2729 0a20 2020 2074 6572  name)"').    ter
-00019690: 6d69 6e61 7465 5f63 6d64 203d 2028 6627  minate_cmd = (f'
-000196a0: 6763 6c6f 7564 2063 6f6d 7075 7465 2069  gcloud compute i
-000196b0: 6e73 7461 6e63 6573 2064 656c 6574 6520  nstances delete 
-000196c0: 2d2d 7a6f 6e65 3d7b 7a6f 6e65 7d27 0a20  --zone={zone}'. 
-000196d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000196e0: 2020 2020 6627 202d 2d71 7569 6574 2024      f' --quiet $
-000196f0: 287b 7175 6572 795f 636d 647d 2927 290a  ({query_cmd})').
-00019700: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00019710: 0a20 2020 2020 2020 2027 7370 6f74 5f70  .        'spot_p
-00019720: 6970 656c 696e 655f 7265 636f 7665 7279  ipeline_recovery
-00019730: 5f67 6370 272c 0a20 2020 2020 2020 205b  _gcp',.        [
-00019740: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00019750: 6b79 2073 706f 7420 6c61 756e 6368 202d  ky spot launch -
-00019760: 6e20 7b6e 616d 657d 2074 6573 7473 2f74  n {name} tests/t
-00019770: 6573 745f 7961 6d6c 732f 7069 7065 6c69  est_yamls/pipeli
-00019780: 6e65 5f67 6370 2e79 616d 6c20 202d 7920  ne_gcp.yaml  -y 
-00019790: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
-000197a0: 2027 736c 6565 7020 3430 3027 2c0a 2020   'sleep 400',.  
-000197b0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-000197c0: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-000197d0: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-000197e0: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-000197f0: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
-00019800: 2020 2020 2020 6627 5255 4e5f 4944 3d24        f'RUN_ID=$
-00019810: 2873 6b79 2073 706f 7420 6c6f 6773 202d  (sky spot logs -
-00019820: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
-00019830: 6c6c 6f77 207c 2067 7265 7020 534b 5950  llow | grep SKYP
-00019840: 494c 4f54 5f54 4153 4b5f 4944 3a20 7c20  ILOT_TASK_ID: | 
-00019850: 6375 7420 2d64 3a20 2d66 3229 3b20 6563  cut -d: -f2); ec
-00019860: 686f 2022 2452 554e 5f49 4422 207c 2074  ho "$RUN_ID" | t
-00019870: 6565 202f 746d 702f 7b6e 616d 657d 2d72  ee /tmp/{name}-r
-00019880: 756e 2d69 6427 2c0a 2020 2020 2020 2020  un-id',.        
-00019890: 2020 2020 6627 5255 4e5f 4944 533d 2428      f'RUN_IDS=$(
-000198a0: 736b 7920 7370 6f74 206c 6f67 7320 2d6e  sky spot logs -n
-000198b0: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
-000198c0: 6c6f 7720 7c20 6772 6570 202d 4120 3420  low | grep -A 4 
-000198d0: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
-000198e0: 5320 7c20 6375 7420 2d64 2229 2220 2d66  S | cut -d")" -f
-000198f0: 3229 3b20 6563 686f 2022 2452 554e 5f49  2); echo "$RUN_I
-00019900: 4453 2220 7c20 7465 6520 2f74 6d70 2f7b  DS" | tee /tmp/{
-00019910: 6e61 6d65 7d2d 7275 6e2d 6964 7327 2c0a  name}-run-ids',.
-00019920: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
-00019930: 726d 696e 6174 6520 7468 6520 636c 7573  rminate the clus
-00019940: 7465 7220 6d61 6e75 616c 6c79 2e0a 2020  ter manually..  
-00019950: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
-00019960: 6063 6174 202e 2e2e 7c20 7265 7660 2069  `cat ...| rev` i
-00019970: 7320 746f 2072 6574 7269 6576 6520 7468  s to retrieve th
-00019980: 6520 6a6f 625f 6964 2066 726f 6d20 7468  e job_id from th
-00019990: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-000199a0: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
-000199b0: 2c20 7768 6963 6820 6765 7473 2074 6865  , which gets the
-000199c0: 2073 6563 6f6e 6420 746f 206c 6173 7420   second to last 
-000199d0: 6669 656c 640a 2020 2020 2020 2020 2020  field.          
-000199e0: 2020 2320 7365 7061 7261 7465 6420 6279    # separated by
-000199f0: 2060 2d60 2e0a 2020 2020 2020 2020 2020   `-`..          
-00019a00: 2020 2866 2753 504f 545f 4a4f 425f 4944    (f'SPOT_JOB_ID
-00019a10: 3d60 6361 7420 2f74 6d70 2f7b 6e61 6d65  =`cat /tmp/{name
-00019a20: 7d2d 7275 6e2d 6964 207c 2072 6576 207c  }-run-id | rev |
-00019a30: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00019a40: 6627 6375 7420 2d64 5c27 5f5c 2720 2d66  f'cut -d\'_\' -f
-00019a50: 3120 7c20 7265 7620 7c20 6375 7420 2d64  1 | rev | cut -d
-00019a60: 5c27 2d5c 2720 2d66 3160 3b20 7b74 6572  \'-\' -f1`; {ter
-00019a70: 6d69 6e61 7465 5f63 6d64 7d27 292c 0a20  minate_cmd}'),. 
-00019a80: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00019a90: 7020 3630 272c 0a20 2020 2020 2020 2020  p 60',.         
-00019aa0: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-00019ab0: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-00019ac0: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
-00019ad0: 7c20 6772 6570 2022 5245 434f 5645 5249  | grep "RECOVERI
-00019ae0: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
-00019af0: 2020 2773 6c65 6570 2032 3030 272c 0a20    'sleep 200',. 
-00019b00: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00019b10: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-00019b20: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-00019b30: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-00019b40: 5255 4e4e 494e 4722 272c 0a20 2020 2020  RUNNING"',.     
-00019b50: 2020 2020 2020 2066 2752 554e 5f49 443d         f'RUN_ID=
-00019b60: 2428 6361 7420 2f74 6d70 2f7b 6e61 6d65  $(cat /tmp/{name
-00019b70: 7d2d 7275 6e2d 6964 293b 2065 6368 6f20  }-run-id); echo 
-00019b80: 2452 554e 5f49 443b 2073 6b79 2073 706f  $RUN_ID; sky spo
-00019b90: 7420 6c6f 6773 202d 6e20 7b6e 616d 657d  t logs -n {name}
-00019ba0: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
-00019bb0: 7265 7020 534b 5950 494c 4f54 5f54 4153  rep SKYPILOT_TAS
-00019bc0: 4b5f 4944 3a20 7c20 6772 6570 2022 2452  K_ID: | grep "$R
-00019bd0: 554e 5f49 4422 272c 0a20 2020 2020 2020  UN_ID"',.       
-00019be0: 2020 2020 2066 2752 554e 5f49 4453 3d24       f'RUN_IDS=$
-00019bf0: 2873 6b79 2073 706f 7420 6c6f 6773 202d  (sky spot logs -
-00019c00: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
-00019c10: 6c6c 6f77 207c 2067 7265 7020 2d41 2034  llow | grep -A 4
-00019c20: 2053 4b59 5049 4c4f 545f 5441 534b 5f49   SKYPILOT_TASK_I
-00019c30: 4453 207c 2063 7574 202d 6422 2922 202d  DS | cut -d")" -
-00019c40: 6632 293b 2065 6368 6f20 2224 5255 4e5f  f2); echo "$RUN_
-00019c50: 4944 5322 207c 2074 6565 202f 746d 702f  IDS" | tee /tmp/
-00019c60: 7b6e 616d 657d 2d72 756e 2d69 6473 2d6e  {name}-run-ids-n
-00019c70: 6577 272c 0a20 2020 2020 2020 2020 2020  ew',.           
-00019c80: 2066 2764 6966 6620 2f74 6d70 2f7b 6e61   f'diff /tmp/{na
-00019c90: 6d65 7d2d 7275 6e2d 6964 7320 2f74 6d70  me}-run-ids /tmp
-00019ca0: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 732d  /{name}-run-ids-
-00019cb0: 6e65 7727 2c0a 2020 2020 2020 2020 2020  new',.          
-00019cc0: 2020 6627 6361 7420 2f74 6d70 2f7b 6e61    f'cat /tmp/{na
-00019cd0: 6d65 7d2d 7275 6e2d 6964 7320 7c20 7365  me}-run-ids | se
-00019ce0: 6420 2d6e 2032 7020 7c20 6772 6570 2060  d -n 2p | grep `
-00019cf0: 6361 7420 2f74 6d70 2f7b 6e61 6d65 7d2d  cat /tmp/{name}-
-00019d00: 7275 6e2d 6964 6027 2c0a 2020 2020 2020  run-id`',.      
-00019d10: 2020 5d2c 0a20 2020 2020 2020 205f 5350    ],.        _SP
-00019d20: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
-00019d30: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d6e  ormat(job_name=n
-00019d40: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
-00019d50: 6d65 6f75 743d 3235 202a 2036 302c 0a20  meout=25 * 60,. 
-00019d60: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00019d70: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-00019d80: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
-00019d90: 7569 6473 7461 636b 2020 2320 466c 7569  uidstack  # Flui
-00019da0: 6473 7461 636b 2064 6f65 7320 6e6f 7420  dstack does not 
-00019db0: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
-00019dc0: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
-00019dd0: 6172 6b2e 6e6f 5f61 7a75 7265 2020 2320  ark.no_azure  # 
-00019de0: 417a 7572 6520 646f 6573 206e 6f74 2073  Azure does not s
-00019df0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-00019e00: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-00019e10: 726b 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f  rk.no_lambda_clo
-00019e20: 7564 2020 2320 4c61 6d62 6461 2043 6c6f  ud  # Lambda Clo
-00019e30: 7564 2064 6f65 7320 6e6f 7420 7375 7070  ud does not supp
-00019e40: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
-00019e50: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-00019e60: 6e6f 5f69 626d 2020 2320 4942 4d20 436c  no_ibm  # IBM Cl
-00019e70: 6f75 6420 646f 6573 206e 6f74 2073 7570  oud does not sup
-00019e80: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
-00019e90: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
-00019ea0: 2e6e 6f5f 7363 7020 2023 2053 4350 2064  .no_scp  # SCP d
-00019eb0: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-00019ec0: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-00019ed0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f70  pytest.mark.no_p
-00019ee0: 6170 6572 7370 6163 6520 2023 2050 6170  aperspace  # Pap
-00019ef0: 6572 7370 6163 6520 646f 6573 206e 6f74  erspace does not
-00019f00: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-00019f10: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-00019f20: 6d61 726b 2e6e 6f5f 6b75 6265 726e 6574  mark.no_kubernet
-00019f30: 6573 2020 2320 4b75 6265 726e 6574 6573  es  # Kubernetes
-00019f40: 2064 6f65 7320 6e6f 7420 6861 7665 2061   does not have a
-00019f50: 206e 6f74 696f 6e20 6f66 2073 706f 7420   notion of spot 
-00019f60: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-00019f70: 742e 6d61 726b 2e6d 616e 6167 6564 5f73  t.mark.managed_s
-00019f80: 706f 740a 6465 6620 7465 7374 5f73 706f  pot.def test_spo
-00019f90: 745f 7265 636f 7665 7279 5f64 6566 6175  t_recovery_defau
-00019fa0: 6c74 5f72 6573 6f75 7263 6573 2867 656e  lt_resources(gen
-00019fb0: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-00019fc0: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
-00019fd0: 6e61 6765 6420 7370 6f74 2072 6563 6f76  naged spot recov
-00019fe0: 6572 7920 666f 7220 6465 6661 756c 7420  ery for default 
-00019ff0: 7265 736f 7572 6365 732e 2222 220a 2020  resources.""".  
-0001a000: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-0001a010: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-0001a020: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-0001a030: 2020 2020 2020 276d 616e 6167 6564 2d73        'managed-s
-0001a040: 706f 742d 7265 636f 7665 7279 2d64 6566  pot-recovery-def
-0001a050: 6175 6c74 2d72 6573 6f75 7263 6573 272c  ault-resources',
-0001a060: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-0001a070: 2020 2020 2020 2066 2773 6b79 2073 706f         f'sky spo
-0001a080: 7420 6c61 756e 6368 202d 6e20 7b6e 616d  t launch -n {nam
-0001a090: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
-0001a0a0: 7269 635f 636c 6f75 647d 2022 736c 6565  ric_cloud} "slee
-0001a0b0: 7020 3330 2026 2620 7375 646f 2073 6875  p 30 && sudo shu
-0001a0c0: 7464 6f77 6e20 6e6f 7720 2626 2073 6c65  tdown now && sle
-0001a0d0: 6570 2031 3030 3022 202d 7920 2d64 272c  ep 1000" -y -d',
-0001a0e0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0001a0f0: 6565 7020 3336 3027 2c0a 2020 2020 2020  eep 360',.      
-0001a100: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-0001a110: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-0001a120: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
-0001a130: 6e31 207c 2067 7265 7020 2252 554e 4e49  n1 | grep "RUNNI
-0001a140: 4e47 5c7c 5245 434f 5645 5249 4e47 2227  NG\|RECOVERING"'
-0001a150: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-0001a160: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
-0001a170: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
-0001a180: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
-0001a190: 2020 2020 2020 7469 6d65 6f75 743d 3235        timeout=25
-0001a1a0: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-0001a1b0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-0001a1c0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-0001a1d0: 726b 2e61 7773 0a40 7079 7465 7374 2e6d  rk.aws.@pytest.m
-0001a1e0: 6172 6b2e 6d61 6e61 6765 645f 7370 6f74  ark.managed_spot
-0001a1f0: 0a64 6566 2074 6573 745f 7370 6f74 5f72  .def test_spot_r
-0001a200: 6563 6f76 6572 795f 6d75 6c74 695f 6e6f  ecovery_multi_no
-0001a210: 6465 5f61 7773 2861 7773 5f63 6f6e 6669  de_aws(aws_confi
-0001a220: 675f 7265 6769 6f6e 293a 0a20 2020 2022  g_region):.    "
-0001a230: 2222 5465 7374 206d 616e 6167 6564 2073  ""Test managed s
-0001a240: 706f 7420 7265 636f 7665 7279 2e22 2222  pot recovery."""
-0001a250: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0001a260: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0001a270: 2020 2020 6e61 6d65 5f6f 6e5f 636c 6f75      name_on_clou
-0001a280: 6420 3d20 636f 6d6d 6f6e 5f75 7469 6c73  d = common_utils
-0001a290: 2e6d 616b 655f 636c 7573 7465 725f 6e61  .make_cluster_na
-0001a2a0: 6d65 5f6f 6e5f 636c 6f75 6428 0a20 2020  me_on_cloud(.   
-0001a2b0: 2020 2020 206e 616d 652c 2073 706f 742e       name, spot.
-0001a2c0: 5350 4f54 5f43 4c55 5354 4552 5f4e 414d  SPOT_CLUSTER_NAM
-0001a2d0: 455f 5052 4546 4958 5f4c 454e 4754 482c  E_PREFIX_LENGTH,
-0001a2e0: 2061 6464 5f75 7365 725f 6861 7368 3d46   add_user_hash=F
-0001a2f0: 616c 7365 290a 2020 2020 7265 6769 6f6e  alse).    region
-0001a300: 203d 2061 7773 5f63 6f6e 6669 675f 7265   = aws_config_re
-0001a310: 6769 6f6e 0a20 2020 2074 6573 7420 3d20  gion.    test = 
-0001a320: 5465 7374 280a 2020 2020 2020 2020 2773  Test(.        's
-0001a330: 706f 745f 7265 636f 7665 7279 5f6d 756c  pot_recovery_mul
-0001a340: 7469 5f6e 6f64 655f 6177 7327 2c0a 2020  ti_node_aws',.  
-0001a350: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-0001a360: 2020 2020 6627 736b 7920 7370 6f74 206c      f'sky spot l
-0001a370: 6175 6e63 6820 2d2d 636c 6f75 6420 6177  aunch --cloud aw
-0001a380: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
-0001a390: 6f6e 7d20 2d6e 207b 6e61 6d65 7d20 2d2d  on} -n {name} --
-0001a3a0: 6e75 6d2d 6e6f 6465 7320 3220 2265 6368  num-nodes 2 "ech
-0001a3b0: 6f20 534b 5950 494c 4f54 5f54 4153 4b5f  o SKYPILOT_TASK_
-0001a3c0: 4944 3a20 5c24 534b 5950 494c 4f54 5f54  ID: \$SKYPILOT_T
-0001a3d0: 4153 4b5f 4944 3b20 736c 6565 7020 3138  ASK_ID; sleep 18
-0001a3e0: 3030 2220 202d 7920 2d64 272c 0a20 2020  00"  -y -d',.   
-0001a3f0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-0001a400: 3435 3027 2c0a 2020 2020 2020 2020 2020  450',.          
-0001a410: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-0001a420: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-0001a430: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-0001a440: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
-0001a450: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001a460: 5255 4e5f 4944 3d24 2873 6b79 2073 706f  RUN_ID=$(sky spo
-0001a470: 7420 6c6f 6773 202d 6e20 7b6e 616d 657d  t logs -n {name}
-0001a480: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
-0001a490: 7265 7020 534b 5950 494c 4f54 5f54 4153  rep SKYPILOT_TAS
-0001a4a0: 4b5f 4944 207c 2063 7574 202d 643a 202d  K_ID | cut -d: -
-0001a4b0: 6632 293b 2065 6368 6f20 2224 5255 4e5f  f2); echo "$RUN_
-0001a4c0: 4944 2220 7c20 7465 6520 2f74 6d70 2f7b  ID" | tee /tmp/{
-0001a4d0: 6e61 6d65 7d2d 7275 6e2d 6964 272c 0a20  name}-run-id',. 
-0001a4e0: 2020 2020 2020 2020 2020 2023 2054 6572             # Ter
-0001a4f0: 6d69 6e61 7465 2074 6865 2077 6f72 6b65  minate the worke
-0001a500: 7220 6d61 6e75 616c 6c79 2e0a 2020 2020  r manually..    
-0001a510: 2020 2020 2020 2020 2866 2761 7773 2065          (f'aws e
-0001a520: 6332 2074 6572 6d69 6e61 7465 2d69 6e73  c2 terminate-ins
-0001a530: 7461 6e63 6573 202d 2d72 6567 696f 6e20  tances --region 
-0001a540: 7b72 6567 696f 6e7d 202d 2d69 6e73 7461  {region} --insta
-0001a550: 6e63 652d 6964 7320 2428 270a 2020 2020  nce-ids $('.    
-0001a560: 2020 2020 2020 2020 2066 2761 7773 2065           f'aws e
-0001a570: 6332 2064 6573 6372 6962 652d 696e 7374  c2 describe-inst
-0001a580: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
-0001a590: 7265 6769 6f6e 7d20 270a 2020 2020 2020  region} '.      
-0001a5a0: 2020 2020 2020 2066 272d 2d66 696c 7465         f'--filte
-0001a5b0: 7273 204e 616d 653d 7461 673a 7261 792d  rs Name=tag:ray-
-0001a5c0: 636c 7573 7465 722d 6e61 6d65 2c56 616c  cluster-name,Val
-0001a5d0: 7565 733d 7b6e 616d 655f 6f6e 5f63 6c6f  ues={name_on_clo
-0001a5e0: 7564 7d2a 2027 0a20 2020 2020 2020 2020  ud}* '.         
-0001a5f0: 2020 2020 274e 616d 653d 7461 673a 7261      'Name=tag:ra
-0001a600: 792d 6e6f 6465 2d74 7970 652c 5661 6c75  y-node-type,Valu
-0001a610: 6573 3d77 6f72 6b65 7220 270a 2020 2020  es=worker '.    
-0001a620: 2020 2020 2020 2020 2066 272d 2d71 7565           f'--que
-0001a630: 7279 2052 6573 6572 7661 7469 6f6e 735b  ry Reservations[
-0001a640: 5d2e 496e 7374 616e 6365 735b 5d2e 496e  ].Instances[].In
-0001a650: 7374 616e 6365 4964 2027 0a20 2020 2020  stanceId '.     
-0001a660: 2020 2020 2020 2020 272d 2d6f 7574 7075          '--outpu
-0001a670: 7420 7465 7874 2927 292c 0a20 2020 2020  t text)'),.     
-0001a680: 2020 2020 2020 2027 736c 6565 7020 3530         'sleep 50
-0001a690: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001a6a0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-0001a6b0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-0001a6c0: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-0001a6d0: 6570 2022 5245 434f 5645 5249 4e47 2227  ep "RECOVERING"'
-0001a6e0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0001a6f0: 6c65 6570 2035 3630 272c 0a20 2020 2020  leep 560',.     
-0001a700: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-0001a710: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-0001a720: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
-0001a730: 2d6e 3120 7c20 6772 6570 2022 5255 4e4e  -n1 | grep "RUNN
-0001a740: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
-0001a750: 2020 2066 2752 554e 5f49 443d 2428 6361     f'RUN_ID=$(ca
-0001a760: 7420 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  t /tmp/{name}-ru
-0001a770: 6e2d 6964 293b 2065 6368 6f20 2452 554e  n-id); echo $RUN
-0001a780: 5f49 443b 2073 6b79 2073 706f 7420 6c6f  _ID; sky spot lo
-0001a790: 6773 202d 6e20 7b6e 616d 657d 202d 2d6e  gs -n {name} --n
-0001a7a0: 6f2d 666f 6c6c 6f77 207c 2067 7265 7020  o-follow | grep 
-0001a7b0: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
-0001a7c0: 207c 2063 7574 202d 643a 202d 6632 207c   | cut -d: -f2 |
-0001a7d0: 2067 7265 7020 2224 5255 4e5f 4944 2227   grep "$RUN_ID"'
-0001a7e0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-0001a7f0: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
-0001a800: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
-0001a810: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
-0001a820: 2020 2020 2020 7469 6d65 6f75 743d 3330        timeout=30
-0001a830: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-0001a840: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-0001a850: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-0001a860: 726b 2e67 6370 0a40 7079 7465 7374 2e6d  rk.gcp.@pytest.m
-0001a870: 6172 6b2e 6d61 6e61 6765 645f 7370 6f74  ark.managed_spot
-0001a880: 0a64 6566 2074 6573 745f 7370 6f74 5f72  .def test_spot_r
-0001a890: 6563 6f76 6572 795f 6d75 6c74 695f 6e6f  ecovery_multi_no
-0001a8a0: 6465 5f67 6370 2829 3a0a 2020 2020 2222  de_gcp():.    ""
-0001a8b0: 2254 6573 7420 6d61 6e61 6765 6420 7370  "Test managed sp
-0001a8c0: 6f74 2072 6563 6f76 6572 792e 2222 220a  ot recovery.""".
-0001a8d0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-0001a8e0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-0001a8f0: 2020 206e 616d 655f 6f6e 5f63 6c6f 7564     name_on_cloud
-0001a900: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
-0001a910: 6d61 6b65 5f63 6c75 7374 6572 5f6e 616d  make_cluster_nam
-0001a920: 655f 6f6e 5f63 6c6f 7564 280a 2020 2020  e_on_cloud(.    
-0001a930: 2020 2020 6e61 6d65 2c20 7370 6f74 2e53      name, spot.S
-0001a940: 504f 545f 434c 5553 5445 525f 4e41 4d45  POT_CLUSTER_NAME
-0001a950: 5f50 5245 4649 585f 4c45 4e47 5448 2c20  _PREFIX_LENGTH, 
-0001a960: 6164 645f 7573 6572 5f68 6173 683d 4661  add_user_hash=Fa
-0001a970: 6c73 6529 0a20 2020 207a 6f6e 6520 3d20  lse).    zone = 
-0001a980: 2775 732d 7765 7374 322d 6127 0a20 2020  'us-west2-a'.   
-0001a990: 2023 2055 7365 2027 3a27 2074 6f20 6d61   # Use ':' to ma
-0001a9a0: 7463 6820 6173 2074 6865 2063 6c75 7374  tch as the clust
-0001a9b0: 6572 206e 616d 6520 7769 6c6c 2063 6f6e  er name will con
-0001a9c0: 7461 696e 2074 6865 2073 7566 6669 7820  tain the suffix 
-0001a9d0: 7769 7468 206a 6f62 2069 640a 2020 2020  with job id.    
-0001a9e0: 7175 6572 795f 636d 6420 3d20 280a 2020  query_cmd = (.  
-0001a9f0: 2020 2020 2020 6627 6763 6c6f 7564 2063        f'gcloud c
-0001aa00: 6f6d 7075 7465 2069 6e73 7461 6e63 6573  ompute instances
-0001aa10: 206c 6973 7420 2d2d 6669 6c74 6572 3d27   list --filter='
-0001aa20: 0a20 2020 2020 2020 2066 2722 286c 6162  .        f'"(lab
-0001aa30: 656c 732e 7261 792d 636c 7573 7465 722d  els.ray-cluster-
-0001aa40: 6e61 6d65 3a7b 6e61 6d65 5f6f 6e5f 636c  name:{name_on_cl
-0001aa50: 6f75 647d 2041 4e44 2027 0a20 2020 2020  oud} AND '.     
-0001aa60: 2020 2066 276c 6162 656c 732e 7261 792d     f'labels.ray-
-0001aa70: 6e6f 6465 2d74 7970 653d 776f 726b 6572  node-type=worker
-0001aa80: 2922 202d 2d7a 6f6e 6573 3d7b 7a6f 6e65  )" --zones={zone
-0001aa90: 7d20 2d2d 666f 726d 6174 3d22 7661 6c75  } --format="valu
-0001aaa0: 6528 6e61 6d65 2922 2729 0a20 2020 2074  e(name)"').    t
-0001aab0: 6572 6d69 6e61 7465 5f63 6d64 203d 2028  erminate_cmd = (
-0001aac0: 6627 6763 6c6f 7564 2063 6f6d 7075 7465  f'gcloud compute
-0001aad0: 2069 6e73 7461 6e63 6573 2064 656c 6574   instances delet
-0001aae0: 6520 2d2d 7a6f 6e65 3d7b 7a6f 6e65 7d27  e --zone={zone}'
-0001aaf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ab00: 2020 2020 2020 6627 202d 2d71 7569 6574        f' --quiet
-0001ab10: 2024 287b 7175 6572 795f 636d 647d 2927   $({query_cmd})'
-0001ab20: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-0001ab30: 7428 0a20 2020 2020 2020 2027 7370 6f74  t(.        'spot
-0001ab40: 5f72 6563 6f76 6572 795f 6d75 6c74 695f  _recovery_multi_
-0001ab50: 6e6f 6465 5f67 6370 272c 0a20 2020 2020  node_gcp',.     
-0001ab60: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-0001ab70: 2066 2773 6b79 2073 706f 7420 6c61 756e   f'sky spot laun
-0001ab80: 6368 202d 2d63 6c6f 7564 2067 6370 202d  ch --cloud gcp -
-0001ab90: 2d7a 6f6e 6520 7b7a 6f6e 657d 202d 6e20  -zone {zone} -n 
-0001aba0: 7b6e 616d 657d 202d 2d6e 756d 2d6e 6f64  {name} --num-nod
-0001abb0: 6573 2032 2022 6563 686f 2053 4b59 5049  es 2 "echo SKYPI
-0001abc0: 4c4f 545f 5441 534b 5f49 443a 205c 2453  LOT_TASK_ID: \$S
-0001abd0: 4b59 5049 4c4f 545f 5441 534b 5f49 443b  KYPILOT_TASK_ID;
-0001abe0: 2073 6c65 6570 2031 3830 3022 2020 2d79   sleep 1800"  -y
-0001abf0: 202d 6427 2c0a 2020 2020 2020 2020 2020   -d',.          
-0001ac00: 2020 2773 6c65 6570 2034 3030 272c 0a20    'sleep 400',. 
-0001ac10: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-0001ac20: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-0001ac30: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-0001ac40: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-0001ac50: 5255 4e4e 494e 4722 272c 0a20 2020 2020  RUNNING"',.     
-0001ac60: 2020 2020 2020 2066 2752 554e 5f49 443d         f'RUN_ID=
-0001ac70: 2428 736b 7920 7370 6f74 206c 6f67 7320  $(sky spot logs 
-0001ac80: 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f 2d66  -n {name} --no-f
-0001ac90: 6f6c 6c6f 7720 7c20 6772 6570 2053 4b59  ollow | grep SKY
-0001aca0: 5049 4c4f 545f 5441 534b 5f49 4420 7c20  PILOT_TASK_ID | 
-0001acb0: 6375 7420 2d64 3a20 2d66 3229 3b20 6563  cut -d: -f2); ec
-0001acc0: 686f 2022 2452 554e 5f49 4422 207c 2074  ho "$RUN_ID" | t
-0001acd0: 6565 202f 746d 702f 7b6e 616d 657d 2d72  ee /tmp/{name}-r
-0001ace0: 756e 2d69 6427 2c0a 2020 2020 2020 2020  un-id',.        
-0001acf0: 2020 2020 2320 5465 726d 696e 6174 6520      # Terminate 
-0001ad00: 7468 6520 776f 726b 6572 206d 616e 7561  the worker manua
-0001ad10: 6c6c 792e 0a20 2020 2020 2020 2020 2020  lly..           
-0001ad20: 2074 6572 6d69 6e61 7465 5f63 6d64 2c0a   terminate_cmd,.
-0001ad30: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-0001ad40: 6570 2035 3027 2c0a 2020 2020 2020 2020  ep 50',.        
-0001ad50: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-0001ad60: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-0001ad70: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
-0001ad80: 207c 2067 7265 7020 2252 4543 4f56 4552   | grep "RECOVER
-0001ad90: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
-0001ada0: 2020 2027 736c 6565 7020 3432 3027 2c0a     'sleep 420',.
-0001adb0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-0001adc0: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-0001add0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-0001ade0: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-0001adf0: 2252 554e 4e49 4e47 2227 2c0a 2020 2020  "RUNNING"',.    
-0001ae00: 2020 2020 2020 2020 6627 5255 4e5f 4944          f'RUN_ID
-0001ae10: 3d24 2863 6174 202f 746d 702f 7b6e 616d  =$(cat /tmp/{nam
-0001ae20: 657d 2d72 756e 2d69 6429 3b20 6563 686f  e}-run-id); echo
-0001ae30: 2024 5255 4e5f 4944 3b20 736b 7920 7370   $RUN_ID; sky sp
-0001ae40: 6f74 206c 6f67 7320 2d6e 207b 6e61 6d65  ot logs -n {name
-0001ae50: 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  } --no-follow | 
-0001ae60: 6772 6570 2053 4b59 5049 4c4f 545f 5441  grep SKYPILOT_TA
-0001ae70: 534b 5f49 4420 7c20 6375 7420 2d64 3a20  SK_ID | cut -d: 
-0001ae80: 2d66 3220 7c20 6772 6570 2022 2452 554e  -f2 | grep "$RUN
-0001ae90: 5f49 4422 272c 0a20 2020 2020 2020 205d  _ID"',.        ]
-0001aea0: 2c0a 2020 2020 2020 2020 5f53 504f 545f  ,.        _SPOT_
-0001aeb0: 4341 4e43 454c 5f57 4149 542e 666f 726d  CANCEL_WAIT.form
-0001aec0: 6174 286a 6f62 5f6e 616d 653d 6e61 6d65  at(job_name=name
-0001aed0: 292c 0a20 2020 2020 2020 2074 696d 656f  ),.        timeo
-0001aee0: 7574 3d32 3520 2a20 3630 2c0a 2020 2020  ut=25 * 60,.    
-0001aef0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-0001af00: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-0001af10: 7374 2e6d 6172 6b2e 6177 730a 4070 7974  st.mark.aws.@pyt
-0001af20: 6573 742e 6d61 726b 2e6d 616e 6167 6564  est.mark.managed
-0001af30: 5f73 706f 740a 6465 6620 7465 7374 5f73  _spot.def test_s
-0001af40: 706f 745f 6361 6e63 656c 6c61 7469 6f6e  pot_cancellation
-0001af50: 5f61 7773 2861 7773 5f63 6f6e 6669 675f  _aws(aws_config_
-0001af60: 7265 6769 6f6e 293a 0a20 2020 206e 616d  region):.    nam
-0001af70: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-0001af80: 5f6e 616d 6528 290a 2020 2020 6e61 6d65  _name().    name
-0001af90: 5f6f 6e5f 636c 6f75 6420 3d20 636f 6d6d  _on_cloud = comm
-0001afa0: 6f6e 5f75 7469 6c73 2e6d 616b 655f 636c  on_utils.make_cl
-0001afb0: 7573 7465 725f 6e61 6d65 5f6f 6e5f 636c  uster_name_on_cl
-0001afc0: 6f75 6428 0a20 2020 2020 2020 206e 616d  oud(.        nam
-0001afd0: 652c 2073 706f 742e 5350 4f54 5f43 4c55  e, spot.SPOT_CLU
-0001afe0: 5354 4552 5f4e 414d 455f 5052 4546 4958  STER_NAME_PREFIX
-0001aff0: 5f4c 454e 4754 482c 2061 6464 5f75 7365  _LENGTH, add_use
-0001b000: 725f 6861 7368 3d46 616c 7365 290a 2020  r_hash=False).  
-0001b010: 2020 6e61 6d65 5f32 5f6f 6e5f 636c 6f75    name_2_on_clou
-0001b020: 6420 3d20 636f 6d6d 6f6e 5f75 7469 6c73  d = common_utils
-0001b030: 2e6d 616b 655f 636c 7573 7465 725f 6e61  .make_cluster_na
-0001b040: 6d65 5f6f 6e5f 636c 6f75 6428 0a20 2020  me_on_cloud(.   
-0001b050: 2020 2020 2066 277b 6e61 6d65 7d2d 3227       f'{name}-2'
-0001b060: 2c20 7370 6f74 2e53 504f 545f 434c 5553  , spot.SPOT_CLUS
-0001b070: 5445 525f 4e41 4d45 5f50 5245 4649 585f  TER_NAME_PREFIX_
-0001b080: 4c45 4e47 5448 2c20 6164 645f 7573 6572  LENGTH, add_user
-0001b090: 5f68 6173 683d 4661 6c73 6529 0a20 2020  _hash=False).   
-0001b0a0: 206e 616d 655f 335f 6f6e 5f63 6c6f 7564   name_3_on_cloud
-0001b0b0: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
-0001b0c0: 6d61 6b65 5f63 6c75 7374 6572 5f6e 616d  make_cluster_nam
-0001b0d0: 655f 6f6e 5f63 6c6f 7564 280a 2020 2020  e_on_cloud(.    
-0001b0e0: 2020 2020 6627 7b6e 616d 657d 2d33 272c      f'{name}-3',
-0001b0f0: 2073 706f 742e 5350 4f54 5f43 4c55 5354   spot.SPOT_CLUST
-0001b100: 4552 5f4e 414d 455f 5052 4546 4958 5f4c  ER_NAME_PREFIX_L
-0001b110: 454e 4754 482c 2061 6464 5f75 7365 725f  ENGTH, add_user_
-0001b120: 6861 7368 3d46 616c 7365 290a 2020 2020  hash=False).    
-0001b130: 7265 6769 6f6e 203d 2061 7773 5f63 6f6e  region = aws_con
-0001b140: 6669 675f 7265 6769 6f6e 0a20 2020 2074  fig_region.    t
-0001b150: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-0001b160: 2020 2020 2773 706f 745f 6361 6e63 656c      'spot_cancel
-0001b170: 6c61 7469 6f6e 5f61 7773 272c 0a20 2020  lation_aws',.   
-0001b180: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-0001b190: 2020 2023 2054 6573 7420 6361 6e63 656c     # Test cancel
-0001b1a0: 6c61 7469 6f6e 2064 7572 696e 6720 7370  lation during sp
-0001b1b0: 6f74 2063 6c75 7374 6572 2062 6569 6e67  ot cluster being
-0001b1c0: 206c 6175 6e63 6865 642e 0a20 2020 2020   launched..     
-0001b1d0: 2020 2020 2020 2066 2773 6b79 2073 706f         f'sky spo
-0001b1e0: 7420 6c61 756e 6368 202d 2d63 6c6f 7564  t launch --cloud
-0001b1f0: 2061 7773 202d 2d72 6567 696f 6e20 7b72   aws --region {r
-0001b200: 6567 696f 6e7d 202d 6e20 7b6e 616d 657d  egion} -n {name}
-0001b210: 2022 736c 6565 7020 3130 3030 2220 202d   "sleep 1000"  -
-0001b220: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
-0001b230: 2020 2027 736c 6565 7020 3630 272c 0a20     'sleep 60',. 
-0001b240: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-0001b250: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-0001b260: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-0001b270: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-0001b280: 5354 4152 5449 4e47 2227 2c0a 2020 2020  STARTING"',.    
-0001b290: 2020 2020 2020 2020 5f53 504f 545f 4341          _SPOT_CA
-0001b2a0: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
-0001b2b0: 286a 6f62 5f6e 616d 653d 6e61 6d65 292c  (job_name=name),
-0001b2c0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0001b2d0: 6565 7020 3527 2c0a 2020 2020 2020 2020  eep 5',.        
-0001b2e0: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-0001b2f0: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-0001b300: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
-0001b310: 207c 2067 7265 7020 2243 414e 4345 4c4c   | grep "CANCELL
-0001b320: 494e 475c 7c43 414e 4345 4c4c 4544 2227  ING\|CANCELLED"'
-0001b330: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0001b340: 6c65 6570 2031 3230 272c 0a20 2020 2020  leep 120',.     
-0001b350: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-0001b360: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-0001b370: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
-0001b380: 2d6e 3120 7c20 6772 6570 2022 4341 4e43  -n1 | grep "CANC
-0001b390: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
-0001b3a0: 2020 2020 2028 6627 733d 2428 6177 7320       (f's=$(aws 
-0001b3b0: 6563 3220 6465 7363 7269 6265 2d69 6e73  ec2 describe-ins
-0001b3c0: 7461 6e63 6573 202d 2d72 6567 696f 6e20  tances --region 
-0001b3d0: 7b72 6567 696f 6e7d 2027 0a20 2020 2020  {region} '.     
-0001b3e0: 2020 2020 2020 2020 6627 2d2d 6669 6c74          f'--filt
-0001b3f0: 6572 7320 4e61 6d65 3d74 6167 3a72 6179  ers Name=tag:ray
-0001b400: 2d63 6c75 7374 6572 2d6e 616d 652c 5661  -cluster-name,Va
-0001b410: 6c75 6573 3d7b 6e61 6d65 5f6f 6e5f 636c  lues={name_on_cl
-0001b420: 6f75 647d 2d2a 2027 0a20 2020 2020 2020  oud}-* '.       
-0001b430: 2020 2020 2020 6627 2d2d 7175 6572 7920        f'--query 
-0001b440: 5265 7365 7276 6174 696f 6e73 5b5d 2e49  Reservations[].I
-0001b450: 6e73 7461 6e63 6573 5b5d 2e53 7461 7465  nstances[].State
-0001b460: 5b5d 2e4e 616d 6520 270a 2020 2020 2020  [].Name '.      
-0001b470: 2020 2020 2020 2027 2d2d 6f75 7470 7574         '--output
-0001b480: 2074 6578 7429 2026 2620 6563 686f 2022   text) && echo "
-0001b490: 2473 2220 2626 2065 6368 6f3b 205b 5b20  $s" && echo; [[ 
-0001b4a0: 2d7a 2022 2473 2220 5d5d 207c 7c20 5b5b  -z "$s" ]] || [[
-0001b4b0: 2022 2473 2220 3d20 2274 6572 6d69 6e61   "$s" = "termina
-0001b4c0: 7465 6422 205d 5d20 7c7c 205b 5b20 2224  ted" ]] || [[ "$
-0001b4d0: 7322 203d 2022 7368 7574 7469 6e67 2d64  s" = "shutting-d
-0001b4e0: 6f77 6e22 205d 5d27 0a20 2020 2020 2020  own" ]]'.       
-0001b4f0: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
-0001b500: 2020 2020 2320 5465 7374 2063 616e 6365      # Test cance
-0001b510: 6c6c 696e 6720 7468 6520 7370 6f74 2063  lling the spot c
-0001b520: 6c75 7374 6572 2064 7572 696e 6720 7370  luster during sp
-0001b530: 6f74 206a 6f62 2062 6569 6e67 2073 6574  ot job being set
-0001b540: 7570 2e0a 2020 2020 2020 2020 2020 2020  up..            
-0001b550: 6627 736b 7920 7370 6f74 206c 6175 6e63  f'sky spot launc
-0001b560: 6820 2d2d 636c 6f75 6420 6177 7320 2d2d  h --cloud aws --
-0001b570: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-0001b580: 2d6e 207b 6e61 6d65 7d2d 3220 7465 7374  -n {name}-2 test
-0001b590: 732f 7465 7374 5f79 616d 6c73 2f74 6573  s/test_yamls/tes
-0001b5a0: 745f 6c6f 6e67 5f73 6574 7570 2e79 616d  t_long_setup.yam
-0001b5b0: 6c20 202d 7920 2d64 272c 0a20 2020 2020  l  -y -d',.     
-0001b5c0: 2020 2020 2020 2027 736c 6565 7020 3330         'sleep 30
-0001b5d0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-0001b5e0: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
-0001b5f0: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
-0001b600: 653d 6627 7b6e 616d 657d 2d32 2729 2c0a  e=f'{name}-2'),.
-0001b610: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-0001b620: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
-0001b630: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-0001b640: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-0001b650: 616d 657d 2d32 207c 2068 6561 6420 2d6e  ame}-2 | head -n
-0001b660: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
-0001b670: 4c49 4e47 5c7c 4341 4e43 454c 4c45 4422  LING\|CANCELLED"
-0001b680: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-0001b690: 736c 6565 7020 3132 3027 2c0a 2020 2020  sleep 120',.    
-0001b6a0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-0001b6b0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-0001b6c0: 6570 207b 6e61 6d65 7d2d 3220 7c20 6865  ep {name}-2 | he
-0001b6d0: 6164 202d 6e31 207c 2067 7265 7020 2243  ad -n1 | grep "C
-0001b6e0: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
-0001b6f0: 2020 2020 2020 2020 2866 2773 3d24 2861          (f's=$(a
-0001b700: 7773 2065 6332 2064 6573 6372 6962 652d  ws ec2 describe-
-0001b710: 696e 7374 616e 6365 7320 2d2d 7265 6769  instances --regi
-0001b720: 6f6e 207b 7265 6769 6f6e 7d20 270a 2020  on {region} '.  
-0001b730: 2020 2020 2020 2020 2020 2066 272d 2d66             f'--f
-0001b740: 696c 7465 7273 204e 616d 653d 7461 673a  ilters Name=tag:
-0001b750: 7261 792d 636c 7573 7465 722d 6e61 6d65  ray-cluster-name
-0001b760: 2c56 616c 7565 733d 7b6e 616d 655f 325f  ,Values={name_2_
-0001b770: 6f6e 5f63 6c6f 7564 7d2d 2a20 270a 2020  on_cloud}-* '.  
-0001b780: 2020 2020 2020 2020 2020 2066 272d 2d71             f'--q
-0001b790: 7565 7279 2052 6573 6572 7661 7469 6f6e  uery Reservation
-0001b7a0: 735b 5d2e 496e 7374 616e 6365 735b 5d2e  s[].Instances[].
-0001b7b0: 5374 6174 655b 5d2e 4e61 6d65 2027 0a20  State[].Name '. 
-0001b7c0: 2020 2020 2020 2020 2020 2020 272d 2d6f              '--o
-0001b7d0: 7574 7075 7420 7465 7874 2920 2626 2065  utput text) && e
-0001b7e0: 6368 6f20 2224 7322 2026 2620 6563 686f  cho "$s" && echo
-0001b7f0: 3b20 5b5b 202d 7a20 2224 7322 205d 5d20  ; [[ -z "$s" ]] 
-0001b800: 7c7c 205b 5b20 2224 7322 203d 2022 7465  || [[ "$s" = "te
-0001b810: 726d 696e 6174 6564 2220 5d5d 207c 7c20  rminated" ]] || 
-0001b820: 5b5b 2022 2473 2220 3d20 2273 6875 7474  [[ "$s" = "shutt
-0001b830: 696e 672d 646f 776e 2220 5d5d 270a 2020  ing-down" ]]'.  
-0001b840: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
-0001b850: 2020 2020 2020 2020 2023 2054 6573 7420           # Test 
-0001b860: 6361 6e63 656c 6c61 7469 6f6e 2064 7572  cancellation dur
-0001b870: 696e 6720 7370 6f74 206a 6f62 2069 7320  ing spot job is 
-0001b880: 7265 636f 7665 7269 6e67 2e0a 2020 2020  recovering..    
-0001b890: 2020 2020 2020 2020 6627 736b 7920 7370          f'sky sp
-0001b8a0: 6f74 206c 6175 6e63 6820 2d2d 636c 6f75  ot launch --clou
-0001b8b0: 6420 6177 7320 2d2d 7265 6769 6f6e 207b  d aws --region {
-0001b8c0: 7265 6769 6f6e 7d20 2d6e 207b 6e61 6d65  region} -n {name
-0001b8d0: 7d2d 3320 2273 6c65 6570 2031 3030 3022  }-3 "sleep 1000"
-0001b8e0: 2020 2d79 202d 6427 2c0a 2020 2020 2020    -y -d',.      
-0001b8f0: 2020 2020 2020 2773 6c65 6570 2033 3030        'sleep 300
-0001b900: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001b910: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-0001b920: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-0001b930: 2d33 207c 2068 6561 6420 2d6e 3120 7c20  -3 | head -n1 | 
-0001b940: 6772 6570 2022 5255 4e4e 494e 4722 272c  grep "RUNNING"',
-0001b950: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-0001b960: 6572 6d69 6e61 7465 2074 6865 2063 6c75  erminate the clu
-0001b970: 7374 6572 206d 616e 7561 6c6c 792e 0a20  ster manually.. 
-0001b980: 2020 2020 2020 2020 2020 2028 6627 6177             (f'aw
-0001b990: 7320 6563 3220 7465 726d 696e 6174 652d  s ec2 terminate-
-0001b9a0: 696e 7374 616e 6365 7320 2d2d 7265 6769  instances --regi
-0001b9b0: 6f6e 207b 7265 6769 6f6e 7d20 2d2d 696e  on {region} --in
-0001b9c0: 7374 616e 6365 2d69 6473 2024 2827 0a20  stance-ids $('. 
-0001b9d0: 2020 2020 2020 2020 2020 2020 6627 6177              f'aw
-0001b9e0: 7320 6563 3220 6465 7363 7269 6265 2d69  s ec2 describe-i
-0001b9f0: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
-0001ba00: 6e20 7b72 6567 696f 6e7d 2027 0a20 2020  n {region} '.   
-0001ba10: 2020 2020 2020 2020 2020 6627 2d2d 6669            f'--fi
-0001ba20: 6c74 6572 7320 4e61 6d65 3d74 6167 3a72  lters Name=tag:r
-0001ba30: 6179 2d63 6c75 7374 6572 2d6e 616d 652c  ay-cluster-name,
-0001ba40: 5661 6c75 6573 3d7b 6e61 6d65 5f33 5f6f  Values={name_3_o
-0001ba50: 6e5f 636c 6f75 647d 2d2a 2027 0a20 2020  n_cloud}-* '.   
-0001ba60: 2020 2020 2020 2020 2020 6627 2d2d 7175            f'--qu
-0001ba70: 6572 7920 5265 7365 7276 6174 696f 6e73  ery Reservations
-0001ba80: 5b5d 2e49 6e73 7461 6e63 6573 5b5d 2e49  [].Instances[].I
-0001ba90: 6e73 7461 6e63 6549 6420 270a 2020 2020  nstanceId '.    
-0001baa0: 2020 2020 2020 2020 2027 2d2d 6f75 7470           '--outp
-0001bab0: 7574 2074 6578 7429 2729 2c0a 2020 2020  ut text)'),.    
-0001bac0: 2020 2020 2020 2020 2773 6c65 6570 2031          'sleep 1
-0001bad0: 3230 272c 0a20 2020 2020 2020 2020 2020  20',.           
-0001bae0: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-0001baf0: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
-0001bb00: 657d 2d33 207c 2068 6561 6420 2d6e 3120  e}-3 | head -n1 
-0001bb10: 7c20 6772 6570 2022 5245 434f 5645 5249  | grep "RECOVERI
-0001bb20: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
-0001bb30: 2020 5f53 504f 545f 4341 4e43 454c 5f57    _SPOT_CANCEL_W
-0001bb40: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
-0001bb50: 616d 653d 6627 7b6e 616d 657d 2d33 2729  ame=f'{name}-3')
-0001bb60: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0001bb70: 6c65 6570 2035 272c 0a20 2020 2020 2020  leep 5',.       
-0001bb80: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-0001bb90: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-0001bba0: 7b6e 616d 657d 2d33 207c 2068 6561 6420  {name}-3 | head 
-0001bbb0: 2d6e 3120 7c20 6772 6570 2022 4341 4e43  -n1 | grep "CANC
-0001bbc0: 454c 4c49 4e47 5c7c 4341 4e43 454c 4c45  ELLING\|CANCELLE
-0001bbd0: 4422 272c 0a20 2020 2020 2020 2020 2020  D"',.           
-0001bbe0: 2027 736c 6565 7020 3132 3027 2c0a 2020   'sleep 120',.  
-0001bbf0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-0001bc00: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-0001bc10: 6772 6570 207b 6e61 6d65 7d2d 3320 7c20  grep {name}-3 | 
-0001bc20: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-0001bc30: 2243 414e 4345 4c4c 4544 2227 2c0a 2020  "CANCELLED"',.  
-0001bc40: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
-0001bc50: 636c 7573 7465 7220 7368 6f75 6c64 2062  cluster should b
-0001bc60: 6520 7465 726d 696e 6174 6564 2028 7368  e terminated (sh
-0001bc70: 7574 7469 6e67 2d64 6f77 6e29 2061 6674  utting-down) aft
-0001bc80: 6572 2063 616e 6365 6c6c 6174 696f 6e2e  er cancellation.
-0001bc90: 2057 6520 646f 6e27 7420 7573 6520 7468   We don't use th
-0001bca0: 6520 603d 6020 6f70 6572 6174 6f72 2068  e `=` operator h
-0001bcb0: 6572 6520 6265 6361 7573 650a 2020 2020  ere because.    
-0001bcc0: 2020 2020 2020 2020 2320 7468 6572 6520          # there 
-0001bcd0: 6361 6e20 6265 206d 756c 7469 706c 6520  can be multiple 
-0001bce0: 564d 2077 6974 6820 7468 6520 7361 6d65  VM with the same
-0001bcf0: 206e 616d 6520 6475 6520 746f 2074 6865   name due to the
-0001bd00: 2072 6563 6f76 6572 792e 0a20 2020 2020   recovery..     
-0001bd10: 2020 2020 2020 2028 6627 733d 2428 6177         (f's=$(aw
-0001bd20: 7320 6563 3220 6465 7363 7269 6265 2d69  s ec2 describe-i
-0001bd30: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
-0001bd40: 6e20 7b72 6567 696f 6e7d 2027 0a20 2020  n {region} '.   
-0001bd50: 2020 2020 2020 2020 2020 6627 2d2d 6669            f'--fi
-0001bd60: 6c74 6572 7320 4e61 6d65 3d74 6167 3a72  lters Name=tag:r
-0001bd70: 6179 2d63 6c75 7374 6572 2d6e 616d 652c  ay-cluster-name,
-0001bd80: 5661 6c75 6573 3d7b 6e61 6d65 5f33 5f6f  Values={name_3_o
-0001bd90: 6e5f 636c 6f75 647d 2d2a 2027 0a20 2020  n_cloud}-* '.   
-0001bda0: 2020 2020 2020 2020 2020 6627 2d2d 7175            f'--qu
-0001bdb0: 6572 7920 5265 7365 7276 6174 696f 6e73  ery Reservations
-0001bdc0: 5b5d 2e49 6e73 7461 6e63 6573 5b5d 2e53  [].Instances[].S
-0001bdd0: 7461 7465 5b5d 2e4e 616d 6520 270a 2020  tate[].Name '.  
-0001bde0: 2020 2020 2020 2020 2020 2027 2d2d 6f75             '--ou
-0001bdf0: 7470 7574 2074 6578 7429 2026 2620 6563  tput text) && ec
-0001be00: 686f 2022 2473 2220 2626 2065 6368 6f3b  ho "$s" && echo;
-0001be10: 205b 5b20 2d7a 2022 2473 2220 5d5d 207c   [[ -z "$s" ]] |
-0001be20: 7c20 6563 686f 2022 2473 2220 7c20 6772  | echo "$s" | gr
-0001be30: 6570 202d 7620 2d45 2022 7065 6e64 696e  ep -v -E "pendin
-0001be40: 677c 7275 6e6e 696e 677c 7374 6f70 7065  g|running|stoppe
-0001be50: 647c 7374 6f70 7069 6e67 2227 0a20 2020  d|stopping"'.   
-0001be60: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
-0001be70: 2020 2020 5d2c 0a20 2020 2020 2020 2074      ],.        t
-0001be80: 696d 656f 7574 3d32 3520 2a20 3630 290a  imeout=25 * 60).
-0001be90: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-0001bea0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-0001beb0: 2e6d 6172 6b2e 6763 700a 4070 7974 6573  .mark.gcp.@pytes
-0001bec0: 742e 6d61 726b 2e6d 616e 6167 6564 5f73  t.mark.managed_s
-0001bed0: 706f 740a 6465 6620 7465 7374 5f73 706f  pot.def test_spo
-0001bee0: 745f 6361 6e63 656c 6c61 7469 6f6e 5f67  t_cancellation_g
-0001bef0: 6370 2829 3a0a 2020 2020 6e61 6d65 203d  cp():.    name =
-0001bf00: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-0001bf10: 6d65 2829 0a20 2020 206e 616d 655f 3320  me().    name_3 
-0001bf20: 3d20 6627 7b6e 616d 657d 2d33 270a 2020  = f'{name}-3'.  
-0001bf30: 2020 6e61 6d65 5f33 5f6f 6e5f 636c 6f75    name_3_on_clou
-0001bf40: 6420 3d20 636f 6d6d 6f6e 5f75 7469 6c73  d = common_utils
-0001bf50: 2e6d 616b 655f 636c 7573 7465 725f 6e61  .make_cluster_na
-0001bf60: 6d65 5f6f 6e5f 636c 6f75 6428 0a20 2020  me_on_cloud(.   
-0001bf70: 2020 2020 206e 616d 655f 332c 2073 706f       name_3, spo
-0001bf80: 742e 5350 4f54 5f43 4c55 5354 4552 5f4e  t.SPOT_CLUSTER_N
-0001bf90: 414d 455f 5052 4546 4958 5f4c 454e 4754  AME_PREFIX_LENGT
-0001bfa0: 482c 2061 6464 5f75 7365 725f 6861 7368  H, add_user_hash
-0001bfb0: 3d46 616c 7365 290a 2020 2020 7a6f 6e65  =False).    zone
-0001bfc0: 203d 2027 7573 2d77 6573 7433 2d62 270a   = 'us-west3-b'.
-0001bfd0: 2020 2020 7175 6572 795f 7374 6174 655f      query_state_
-0001bfe0: 636d 6420 3d20 280a 2020 2020 2020 2020  cmd = (.        
-0001bff0: 2767 636c 6f75 6420 636f 6d70 7574 6520  'gcloud compute 
-0001c000: 696e 7374 616e 6365 7320 6c69 7374 2027  instances list '
-0001c010: 0a20 2020 2020 2020 2066 272d 2d66 696c  .        f'--fil
-0001c020: 7465 723d 2228 6c61 6265 6c73 2e72 6179  ter="(labels.ray
-0001c030: 2d63 6c75 7374 6572 2d6e 616d 653a 7b6e  -cluster-name:{n
-0001c040: 616d 655f 335f 6f6e 5f63 6c6f 7564 7d29  ame_3_on_cloud})
-0001c050: 2220 270a 2020 2020 2020 2020 272d 2d66  " '.        '--f
-0001c060: 6f72 6d61 743d 2276 616c 7565 2873 7461  ormat="value(sta
-0001c070: 7475 7329 2227 290a 2020 2020 7175 6572  tus)"').    quer
-0001c080: 795f 636d 6420 3d20 2866 2767 636c 6f75  y_cmd = (f'gclou
-0001c090: 6420 636f 6d70 7574 6520 696e 7374 616e  d compute instan
-0001c0a0: 6365 7320 6c69 7374 202d 2d66 696c 7465  ces list --filte
-0001c0b0: 723d 270a 2020 2020 2020 2020 2020 2020  r='.            
-0001c0c0: 2020 2020 2066 2722 286c 6162 656c 732e       f'"(labels.
-0001c0d0: 7261 792d 636c 7573 7465 722d 6e61 6d65  ray-cluster-name
-0001c0e0: 3a7b 6e61 6d65 5f33 5f6f 6e5f 636c 6f75  :{name_3_on_clou
-0001c0f0: 647d 2922 2027 0a20 2020 2020 2020 2020  d})" '.         
-0001c100: 2020 2020 2020 2020 6627 2d2d 7a6f 6e65          f'--zone
-0001c110: 733d 7b7a 6f6e 657d 202d 2d66 6f72 6d61  s={zone} --forma
-0001c120: 743d 2276 616c 7565 286e 616d 6529 2227  t="value(name)"'
-0001c130: 290a 2020 2020 7465 726d 696e 6174 655f  ).    terminate_
-0001c140: 636d 6420 3d20 2866 2767 636c 6f75 6420  cmd = (f'gcloud 
-0001c150: 636f 6d70 7574 6520 696e 7374 616e 6365  compute instance
-0001c160: 7320 6465 6c65 7465 202d 2d7a 6f6e 653d  s delete --zone=
-0001c170: 7b7a 6f6e 657d 270a 2020 2020 2020 2020  {zone}'.        
-0001c180: 2020 2020 2020 2020 2020 2020 2066 2720               f' 
-0001c190: 2d2d 7175 6965 7420 2428 7b71 7565 7279  --quiet $({query
-0001c1a0: 5f63 6d64 7d29 2729 0a20 2020 2074 6573  _cmd})').    tes
-0001c1b0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-0001c1c0: 2020 2773 706f 745f 6361 6e63 656c 6c61    'spot_cancella
-0001c1d0: 7469 6f6e 5f67 6370 272c 0a20 2020 2020  tion_gcp',.     
-0001c1e0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-0001c1f0: 2023 2054 6573 7420 6361 6e63 656c 6c61   # Test cancella
-0001c200: 7469 6f6e 2064 7572 696e 6720 7370 6f74  tion during spot
-0001c210: 2063 6c75 7374 6572 2062 6569 6e67 206c   cluster being l
-0001c220: 6175 6e63 6865 642e 0a20 2020 2020 2020  aunched..       
-0001c230: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
-0001c240: 6c61 756e 6368 202d 2d63 6c6f 7564 2067  launch --cloud g
-0001c250: 6370 202d 2d7a 6f6e 6520 7b7a 6f6e 657d  cp --zone {zone}
-0001c260: 202d 6e20 7b6e 616d 657d 2022 736c 6565   -n {name} "slee
-0001c270: 7020 3130 3030 2220 202d 7920 2d64 272c  p 1000"  -y -d',
-0001c280: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0001c290: 6565 7020 3630 272c 0a20 2020 2020 2020  eep 60',.       
-0001c2a0: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-0001c2b0: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-0001c2c0: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
-0001c2d0: 3120 7c20 6772 6570 2022 5354 4152 5449  1 | grep "STARTI
-0001c2e0: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
-0001c2f0: 2020 5f53 504f 545f 4341 4e43 454c 5f57    _SPOT_CANCEL_W
-0001c300: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
-0001c310: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
-0001c320: 2020 2020 2020 2027 736c 6565 7020 3527         'sleep 5'
-0001c330: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001c340: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-0001c350: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
-0001c360: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-0001c370: 7020 2243 414e 4345 4c4c 494e 475c 7c43  p "CANCELLING\|C
-0001c380: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
-0001c390: 2020 2020 2020 2020 2773 6c65 6570 2031          'sleep 1
-0001c3a0: 3230 272c 0a20 2020 2020 2020 2020 2020  20',.           
-0001c3b0: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-0001c3c0: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
-0001c3d0: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
-0001c3e0: 6772 6570 2022 4341 4e43 454c 4c45 4422  grep "CANCELLED"
-0001c3f0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-0001c400: 2054 6573 7420 6361 6e63 656c 6c69 6e67   Test cancelling
-0001c410: 2074 6865 2073 706f 7420 636c 7573 7465   the spot cluste
-0001c420: 7220 6475 7269 6e67 2073 706f 7420 6a6f  r during spot jo
-0001c430: 6220 6265 696e 6720 7365 7475 702e 0a20  b being setup.. 
-0001c440: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0001c450: 2073 706f 7420 6c61 756e 6368 202d 2d63   spot launch --c
-0001c460: 6c6f 7564 2067 6370 202d 2d7a 6f6e 6520  loud gcp --zone 
-0001c470: 7b7a 6f6e 657d 202d 6e20 7b6e 616d 657d  {zone} -n {name}
-0001c480: 2d32 2074 6573 7473 2f74 6573 745f 7961  -2 tests/test_ya
-0001c490: 6d6c 732f 7465 7374 5f6c 6f6e 675f 7365  mls/test_long_se
-0001c4a0: 7475 702e 7961 6d6c 2020 2d79 202d 6427  tup.yaml  -y -d'
-0001c4b0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0001c4c0: 6c65 6570 2033 3030 272c 0a20 2020 2020  leep 300',.     
-0001c4d0: 2020 2020 2020 205f 5350 4f54 5f43 414e         _SPOT_CAN
-0001c4e0: 4345 4c5f 5741 4954 2e66 6f72 6d61 7428  CEL_WAIT.format(
-0001c4f0: 6a6f 625f 6e61 6d65 3d66 277b 6e61 6d65  job_name=f'{name
-0001c500: 7d2d 3227 292c 0a20 2020 2020 2020 2020  }-2'),.         
-0001c510: 2020 2027 736c 6565 7020 3527 2c0a 2020     'sleep 5',.  
-0001c520: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-0001c530: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-0001c540: 6772 6570 207b 6e61 6d65 7d2d 3220 7c20  grep {name}-2 | 
-0001c550: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-0001c560: 2243 414e 4345 4c4c 494e 475c 7c43 414e  "CANCELLING\|CAN
-0001c570: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
-0001c580: 2020 2020 2020 2773 6c65 6570 2031 3230        'sleep 120
-0001c590: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001c5a0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-0001c5b0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-0001c5c0: 2d32 207c 2068 6561 6420 2d6e 3120 7c20  -2 | head -n1 | 
-0001c5d0: 6772 6570 2022 4341 4e43 454c 4c45 4422  grep "CANCELLED"
-0001c5e0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-0001c5f0: 2054 6573 7420 6361 6e63 656c 6c61 7469   Test cancellati
-0001c600: 6f6e 2064 7572 696e 6720 7370 6f74 206a  on during spot j
-0001c610: 6f62 2069 7320 7265 636f 7665 7269 6e67  ob is recovering
-0001c620: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-0001c630: 736b 7920 7370 6f74 206c 6175 6e63 6820  sky spot launch 
-0001c640: 2d2d 636c 6f75 6420 6763 7020 2d2d 7a6f  --cloud gcp --zo
-0001c650: 6e65 207b 7a6f 6e65 7d20 2d6e 207b 6e61  ne {zone} -n {na
-0001c660: 6d65 7d2d 3320 2273 6c65 6570 2031 3030  me}-3 "sleep 100
-0001c670: 3022 2020 2d79 202d 6427 2c0a 2020 2020  0"  -y -d',.    
-0001c680: 2020 2020 2020 2020 2773 6c65 6570 2033          'sleep 3
-0001c690: 3030 272c 0a20 2020 2020 2020 2020 2020  00',.           
-0001c6a0: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-0001c6b0: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
-0001c6c0: 657d 2d33 207c 2068 6561 6420 2d6e 3120  e}-3 | head -n1 
-0001c6d0: 7c20 6772 6570 2022 5255 4e4e 494e 4722  | grep "RUNNING"
-0001c6e0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-0001c6f0: 2054 6572 6d69 6e61 7465 2074 6865 2063   Terminate the c
-0001c700: 6c75 7374 6572 206d 616e 7561 6c6c 792e  luster manually.
-0001c710: 0a20 2020 2020 2020 2020 2020 2074 6572  .            ter
-0001c720: 6d69 6e61 7465 5f63 6d64 2c0a 2020 2020  minate_cmd,.    
-0001c730: 2020 2020 2020 2020 2773 6c65 6570 2038          'sleep 8
-0001c740: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-0001c750: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-0001c760: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-0001c770: 7d2d 3320 7c20 6865 6164 202d 6e31 207c  }-3 | head -n1 |
-0001c780: 2067 7265 7020 2252 4543 4f56 4552 494e   grep "RECOVERIN
-0001c790: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
-0001c7a0: 205f 5350 4f54 5f43 414e 4345 4c5f 5741   _SPOT_CANCEL_WA
-0001c7b0: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
-0001c7c0: 6d65 3d66 277b 6e61 6d65 7d2d 3327 292c  me=f'{name}-3'),
-0001c7d0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0001c7e0: 6565 7020 3527 2c0a 2020 2020 2020 2020  eep 5',.        
-0001c7f0: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-0001c800: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-0001c810: 6e61 6d65 7d2d 3320 7c20 6865 6164 202d  name}-3 | head -
-0001c820: 6e31 207c 2067 7265 7020 2243 414e 4345  n1 | grep "CANCE
-0001c830: 4c4c 494e 475c 7c43 414e 4345 4c4c 4544  LLING\|CANCELLED
-0001c840: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-0001c850: 2773 6c65 6570 2031 3230 272c 0a20 2020  'sleep 120',.   
-0001c860: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-0001c870: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
-0001c880: 7265 7020 7b6e 616d 657d 2d33 207c 2068  rep {name}-3 | h
-0001c890: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-0001c8a0: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
-0001c8b0: 2020 2020 2020 2020 2023 2054 6865 2063           # The c
-0001c8c0: 6c75 7374 6572 2073 686f 756c 6420 6265  luster should be
-0001c8d0: 2074 6572 6d69 6e61 7465 6420 2853 544f   terminated (STO
-0001c8e0: 5050 494e 4729 2061 6674 6572 2063 616e  PPING) after can
-0001c8f0: 6365 6c6c 6174 696f 6e2e 2057 6520 646f  cellation. We do
-0001c900: 6e27 7420 7573 6520 7468 6520 603d 6020  n't use the `=` 
-0001c910: 6f70 6572 6174 6f72 2068 6572 6520 6265  operator here be
-0001c920: 6361 7573 650a 2020 2020 2020 2020 2020  cause.          
-0001c930: 2020 2320 7468 6572 6520 6361 6e20 6265    # there can be
-0001c940: 206d 756c 7469 706c 6520 564d 2077 6974   multiple VM wit
-0001c950: 6820 7468 6520 7361 6d65 206e 616d 6520  h the same name 
-0001c960: 6475 6520 746f 2074 6865 2072 6563 6f76  due to the recov
-0001c970: 6572 792e 0a20 2020 2020 2020 2020 2020  ery..           
-0001c980: 2028 6627 733d 2428 7b71 7565 7279 5f73   (f's=$({query_s
-0001c990: 7461 7465 5f63 6d64 7d29 2026 2620 6563  tate_cmd}) && ec
-0001c9a0: 686f 2022 2473 2220 2626 2065 6368 6f3b  ho "$s" && echo;
-0001c9b0: 205b 5b20 2d7a 2022 2473 2220 5d5d 207c   [[ -z "$s" ]] |
-0001c9c0: 7c20 6563 686f 2022 2473 2220 7c20 6772  | echo "$s" | gr
-0001c9d0: 6570 202d 7620 2d45 2022 5052 4f56 4953  ep -v -E "PROVIS
-0001c9e0: 494f 4e49 4e47 7c53 5441 4749 4e47 7c52  IONING|STAGING|R
-0001c9f0: 554e 4e49 4e47 7c52 4550 4149 5249 4e47  UNNING|REPAIRING
-0001ca00: 7c54 4552 4d49 4e41 5445 447c 5355 5350  |TERMINATED|SUSP
-0001ca10: 454e 4449 4e47 7c53 5553 5045 4e44 4544  ENDING|SUSPENDED
-0001ca20: 7c53 5553 5045 4e44 4544 2227 0a20 2020  |SUSPENDED"'.   
-0001ca30: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
-0001ca40: 2020 2020 5d2c 0a20 2020 2020 2020 2074      ],.        t
-0001ca50: 696d 656f 7574 3d32 3520 2a20 3630 290a  imeout=25 * 60).
-0001ca60: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-0001ca70: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
-0001ca80: 2d2d 2d2d 2d20 5465 7374 696e 6720 7374  ----- Testing st
-0001ca90: 6f72 6167 6520 666f 7220 6d61 6e61 6765  orage for manage
-0001caa0: 6420 7370 6f74 202d 2d2d 2d2d 2d2d 2d2d  d spot ---------
-0001cab0: 2d0a 4070 7974 6573 742e 6d61 726b 2e6e  -.@pytest.mark.n
-0001cac0: 6f5f 666c 7569 6473 7461 636b 2020 2320  o_fluidstack  # 
-0001cad0: 466c 7569 6473 7461 636b 2064 6f65 7320  Fluidstack does 
-0001cae0: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-0001caf0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-0001cb00: 7374 2e6d 6172 6b2e 6e6f 5f61 7a75 7265  st.mark.no_azure
-0001cb10: 2020 2320 417a 7572 6520 646f 6573 206e    # Azure does n
-0001cb20: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-0001cb30: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-0001cb40: 742e 6d61 726b 2e6e 6f5f 6c61 6d62 6461  t.mark.no_lambda
-0001cb50: 5f63 6c6f 7564 2020 2320 4c61 6d62 6461  _cloud  # Lambda
-0001cb60: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
-0001cb70: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
-0001cb80: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
-0001cb90: 6172 6b2e 6e6f 5f69 626d 2020 2320 4942  ark.no_ibm  # IB
-0001cba0: 4d20 436c 6f75 6420 646f 6573 206e 6f74  M Cloud does not
-0001cbb0: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-0001cbc0: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-0001cbd0: 6d61 726b 2e6e 6f5f 7061 7065 7273 7061  mark.no_paperspa
-0001cbe0: 6365 2020 2320 5061 7065 7273 7061 6365  ce  # Paperspace
-0001cbf0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-0001cc00: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-0001cc10: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-0001cc20: 5f73 6370 2020 2320 5343 5020 646f 6573  _scp  # SCP does
-0001cc30: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
-0001cc40: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-0001cc50: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
-0001cc60: 726e 6574 6573 2020 2320 4b75 6265 726e  rnetes  # Kubern
-0001cc70: 6574 6573 2064 6f65 7320 6e6f 7420 6861  etes does not ha
-0001cc80: 7665 2061 206e 6f74 696f 6e20 6f66 2073  ve a notion of s
-0001cc90: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
-0001cca0: 7974 6573 742e 6d61 726b 2e6d 616e 6167  ytest.mark.manag
-0001ccb0: 6564 5f73 706f 740a 6465 6620 7465 7374  ed_spot.def test
-0001ccc0: 5f73 706f 745f 7374 6f72 6167 6528 6765  _spot_storage(ge
-0001ccd0: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
-0001cce0: 293a 0a20 2020 2022 2222 5465 7374 2073  ):.    """Test s
-0001ccf0: 746f 7261 6765 2077 6974 6820 6d61 6e61  torage with mana
-0001cd00: 6765 6420 7370 6f74 2222 220a 2020 2020  ged spot""".    
-0001cd10: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-0001cd20: 7465 725f 6e61 6d65 2829 0a20 2020 2079  ter_name().    y
-0001cd30: 616d 6c5f 7374 7220 3d20 7061 7468 6c69  aml_str = pathli
-0001cd40: 622e 5061 7468 280a 2020 2020 2020 2020  b.Path(.        
-0001cd50: 2765 7861 6d70 6c65 732f 6d61 6e61 6765  'examples/manage
-0001cd60: 645f 7370 6f74 5f77 6974 685f 7374 6f72  d_spot_with_stor
-0001cd70: 6167 652e 7961 6d6c 2729 2e72 6561 645f  age.yaml').read_
-0001cd80: 7465 7874 2829 0a20 2020 2073 746f 7261  text().    stora
-0001cd90: 6765 5f6e 616d 6520 3d20 6627 736b 792d  ge_name = f'sky-
-0001cda0: 7465 7374 2d7b 696e 7428 7469 6d65 2e74  test-{int(time.t
-0001cdb0: 696d 6528 2929 7d27 0a0a 2020 2020 2320  ime())}'..    # 
-0001cdc0: 416c 736f 2070 6572 666f 726d 2072 6567  Also perform reg
-0001cdd0: 696f 6e20 7465 7374 696e 6720 666f 7220  ion testing for 
-0001cde0: 6275 636b 6574 2063 7265 6174 696f 6e20  bucket creation 
-0001cdf0: 746f 2076 616c 6964 6174 6520 6966 2062  to validate if b
-0001ce00: 7563 6b65 7473 2061 7265 0a20 2020 2023  uckets are.    #
-0001ce10: 2063 7265 6174 6564 2069 6e20 7468 6520   created in the 
-0001ce20: 636f 7272 6563 7420 7265 6769 6f6e 2061  correct region a
-0001ce30: 6e64 2063 6f72 7265 6374 6c79 206d 6f75  nd correctly mou
-0001ce40: 6e74 6564 2069 6e20 7370 6f74 206a 6f62  nted in spot job
-0001ce50: 732e 0a20 2020 2023 2048 6f77 6576 6572  s..    # However
-0001ce60: 2c20 7765 2069 6e6a 6563 7420 7468 6973  , we inject this
-0001ce70: 2074 6573 7469 6e67 206f 6e6c 7920 666f   testing only fo
-0001ce80: 7220 4157 5320 616e 6420 4743 5020 7369  r AWS and GCP si
-0001ce90: 6e63 6520 7468 6579 2061 7265 2074 6865  nce they are the
-0001cea0: 0a20 2020 2023 2073 7570 706f 7274 6564  .    # supported
-0001ceb0: 206f 626a 6563 7420 7374 6f72 6167 6520   object storage 
-0001cec0: 7072 6f76 6964 6572 7320 696e 2053 6b79  providers in Sky
-0001ced0: 5069 6c6f 742e 0a20 2020 2072 6567 696f  Pilot..    regio
-0001cee0: 6e5f 666c 6167 203d 2027 270a 2020 2020  n_flag = ''.    
-0001cef0: 7265 6769 6f6e 5f76 616c 6964 6174 696f  region_validatio
-0001cf00: 6e5f 636d 6420 3d20 2774 7275 6527 0a20  n_cmd = 'true'. 
-0001cf10: 2020 2069 6620 6765 6e65 7269 635f 636c     if generic_cl
-0001cf20: 6f75 6420 3d3d 2027 6177 7327 3a0a 2020  oud == 'aws':.  
-0001cf30: 2020 2020 2020 7265 6769 6f6e 203d 2027        region = '
-0001cf40: 6575 2d63 656e 7472 616c 2d31 270a 2020  eu-central-1'.  
-0001cf50: 2020 2020 2020 7265 6769 6f6e 5f66 6c61        region_fla
-0001cf60: 6720 3d20 6627 202d 2d72 6567 696f 6e20  g = f' --region 
-0001cf70: 7b72 6567 696f 6e7d 270a 2020 2020 2020  {region}'.      
-0001cf80: 2020 7265 6769 6f6e 5f63 6d64 203d 2054    region_cmd = T
-0001cf90: 6573 7453 746f 7261 6765 5769 7468 4372  estStorageWithCr
-0001cfa0: 6564 656e 7469 616c 732e 636c 695f 7265  edentials.cli_re
-0001cfb0: 6769 6f6e 5f63 6d64 280a 2020 2020 2020  gion_cmd(.      
-0001cfc0: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
-0001cfd0: 622e 5374 6f72 6554 7970 652e 5333 2c20  b.StoreType.S3, 
-0001cfe0: 7374 6f72 6167 655f 6e61 6d65 290a 2020  storage_name).  
-0001cff0: 2020 2020 2020 7265 6769 6f6e 5f76 616c        region_val
-0001d000: 6964 6174 696f 6e5f 636d 6420 3d20 6627  idation_cmd = f'
-0001d010: 7b72 6567 696f 6e5f 636d 647d 207c 2067  {region_cmd} | g
-0001d020: 7265 7020 7b72 6567 696f 6e7d 270a 2020  rep {region}'.  
-0001d030: 2020 656c 6966 2067 656e 6572 6963 5f63    elif generic_c
-0001d040: 6c6f 7564 203d 3d20 2767 6370 273a 0a20  loud == 'gcp':. 
-0001d050: 2020 2020 2020 2072 6567 696f 6e20 3d20         region = 
-0001d060: 2775 732d 7765 7374 3227 0a20 2020 2020  'us-west2'.     
-0001d070: 2020 2072 6567 696f 6e5f 666c 6167 203d     region_flag =
-0001d080: 2066 2720 2d2d 7265 6769 6f6e 207b 7265   f' --region {re
-0001d090: 6769 6f6e 7d27 0a20 2020 2020 2020 2072  gion}'.        r
-0001d0a0: 6567 696f 6e5f 636d 6420 3d20 5465 7374  egion_cmd = Test
-0001d0b0: 5374 6f72 6167 6557 6974 6843 7265 6465  StorageWithCrede
-0001d0c0: 6e74 6961 6c73 2e63 6c69 5f72 6567 696f  ntials.cli_regio
-0001d0d0: 6e5f 636d 6428 0a20 2020 2020 2020 2020  n_cmd(.         
-0001d0e0: 2020 2073 746f 7261 6765 5f6c 6962 2e53     storage_lib.S
-0001d0f0: 746f 7265 5479 7065 2e47 4353 2c20 7374  toreType.GCS, st
-0001d100: 6f72 6167 655f 6e61 6d65 290a 2020 2020  orage_name).    
-0001d110: 2020 2020 7265 6769 6f6e 5f76 616c 6964      region_valid
-0001d120: 6174 696f 6e5f 636d 6420 3d20 6627 7b72  ation_cmd = f'{r
-0001d130: 6567 696f 6e5f 636d 647d 207c 2067 7265  egion_cmd} | gre
-0001d140: 7020 7b72 6567 696f 6e7d 270a 0a20 2020  p {region}'..   
-0001d150: 2079 616d 6c5f 7374 7220 3d20 7961 6d6c   yaml_str = yaml
-0001d160: 5f73 7472 2e72 6570 6c61 6365 2827 736b  _str.replace('sk
-0001d170: 792d 776f 726b 6469 722d 7a68 7775 272c  y-workdir-zhwu',
-0001d180: 2073 746f 7261 6765 5f6e 616d 6529 0a20   storage_name). 
-0001d190: 2020 2077 6974 6820 7465 6d70 6669 6c65     with tempfile
-0001d1a0: 2e4e 616d 6564 5465 6d70 6f72 6172 7946  .NamedTemporaryF
-0001d1b0: 696c 6528 7375 6666 6978 3d27 2e79 616d  ile(suffix='.yam
-0001d1c0: 6c27 2c20 6d6f 6465 3d27 7727 2920 6173  l', mode='w') as
-0001d1d0: 2066 3a0a 2020 2020 2020 2020 662e 7772   f:.        f.wr
-0001d1e0: 6974 6528 7961 6d6c 5f73 7472 290a 2020  ite(yaml_str).  
-0001d1f0: 2020 2020 2020 662e 666c 7573 6828 290a        f.flush().
-0001d200: 2020 2020 2020 2020 6669 6c65 5f70 6174          file_pat
-0001d210: 6820 3d20 662e 6e61 6d65 0a20 2020 2020  h = f.name.     
-0001d220: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-0001d230: 2020 2020 2020 2020 2020 2020 2773 706f              'spo
-0001d240: 745f 7374 6f72 6167 6527 2c0a 2020 2020  t_storage',.    
-0001d250: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-0001d260: 2020 2020 2020 2020 2020 2a73 746f 7261            *stora
-0001d270: 6765 5f73 6574 7570 5f63 6f6d 6d61 6e64  ge_setup_command
-0001d280: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-0001d290: 2020 2066 2773 6b79 2073 706f 7420 6c61     f'sky spot la
-0001d2a0: 756e 6368 202d 6e20 7b6e 616d 657d 202d  unch -n {name} -
-0001d2b0: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-0001d2c0: 636c 6f75 647d 7b72 6567 696f 6e5f 666c  cloud}{region_fl
-0001d2d0: 6167 7d20 7b66 696c 655f 7061 7468 7d20  ag} {file_path} 
-0001d2e0: 2d79 272c 0a20 2020 2020 2020 2020 2020  -y',.           
-0001d2f0: 2020 2020 2072 6567 696f 6e5f 7661 6c69       region_vali
-0001d300: 6461 7469 6f6e 5f63 6d64 2c20 2023 2043  dation_cmd,  # C
-0001d310: 6865 636b 2069 6620 7468 6520 6275 636b  heck if the buck
-0001d320: 6574 2069 7320 6372 6561 7465 6420 696e  et is created in
-0001d330: 2074 6865 2063 6f72 7265 6374 2072 6567   the correct reg
-0001d340: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
-0001d350: 2020 2020 2773 6c65 6570 2036 3027 2c20      'sleep 60', 
-0001d360: 2023 2057 6169 7420 7468 6520 7370 6f74   # Wait the spot
-0001d370: 2071 7565 7565 2074 6f20 6265 2075 7064   queue to be upd
-0001d380: 6174 6564 0a20 2020 2020 2020 2020 2020  ated.           
-0001d390: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-0001d3a0: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-0001d3b0: 7b6e 616d 657d 207c 2067 7265 7020 5355  {name} | grep SU
-0001d3c0: 4343 4545 4445 4427 2c0a 2020 2020 2020  CCEEDED',.      
-0001d3d0: 2020 2020 2020 2020 2020 6627 5b20 2428            f'[ $(
-0001d3e0: 6177 7320 7333 6170 6920 6c69 7374 2d62  aws s3api list-b
-0001d3f0: 7563 6b65 7473 202d 2d71 7565 7279 2022  uckets --query "
-0001d400: 4275 636b 6574 735b 3f63 6f6e 7461 696e  Buckets[?contain
-0001d410: 7328 4e61 6d65 2c20 5c27 7b73 746f 7261  s(Name, \'{stora
-0001d420: 6765 5f6e 616d 657d 5c27 295d 2e4e 616d  ge_name}\')].Nam
-0001d430: 6522 202d 2d6f 7574 7075 7420 7465 7874  e" --output text
-0001d440: 207c 2077 6320 2d6c 2920 2d65 7120 3020   | wc -l) -eq 0 
-0001d450: 5d27 0a20 2020 2020 2020 2020 2020 205d  ]'.            ]
-0001d460: 2c0a 2020 2020 2020 2020 2020 2020 5f53  ,.            _S
-0001d470: 504f 545f 4341 4e43 454c 5f57 4149 542e  POT_CANCEL_WAIT.
-0001d480: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
-0001d490: 6e61 6d65 292c 0a20 2020 2020 2020 2020  name),.         
-0001d4a0: 2020 2023 2049 6e63 7265 6173 6520 7469     # Increase ti
-0001d4b0: 6d65 6f75 7420 7369 6e63 6520 736b 7920  meout since sky 
-0001d4c0: 7370 6f74 2071 7565 7565 202d 7220 6361  spot queue -r ca
-0001d4d0: 6e20 6265 2062 6c6f 636b 6564 2062 7920  n be blocked by 
-0001d4e0: 6f74 6865 7220 7370 6f74 2074 6573 7473  other spot tests
-0001d4f0: 2e0a 2020 2020 2020 2020 2020 2020 7469  ..            ti
-0001d500: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
-0001d510: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001d520: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-0001d530: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
-0001d540: 2d2d 2054 6573 7469 6e67 2073 706f 7420  -- Testing spot 
-0001d550: 5450 5520 2d2d 2d2d 2d2d 2d2d 2d2d 0a40  TPU ----------.@
-0001d560: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
-0001d570: 4070 7974 6573 742e 6d61 726b 2e6d 616e  @pytest.mark.man
-0001d580: 6167 6564 5f73 706f 740a 4070 7974 6573  aged_spot.@pytes
-0001d590: 742e 6d61 726b 2e74 7075 0a64 6566 2074  t.mark.tpu.def t
-0001d5a0: 6573 745f 7370 6f74 5f74 7075 2829 3a0a  est_spot_tpu():.
-0001d5b0: 2020 2020 2222 2254 6573 7420 6d61 6e61      """Test mana
-0001d5c0: 6765 6420 7370 6f74 206f 6e20 5450 552e  ged spot on TPU.
-0001d5d0: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
-0001d5e0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-0001d5f0: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-0001d600: 7374 280a 2020 2020 2020 2020 2774 6573  st(.        'tes
-0001d610: 742d 7370 6f74 2d74 7075 272c 0a20 2020  t-spot-tpu',.   
-0001d620: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-0001d630: 2020 2066 2773 6b79 2073 706f 7420 6c61     f'sky spot la
-0001d640: 756e 6368 202d 6e20 7b6e 616d 657d 2065  unch -n {name} e
-0001d650: 7861 6d70 6c65 732f 7470 752f 7470 7576  xamples/tpu/tpuv
-0001d660: 6d5f 6d6e 6973 742e 7961 6d6c 202d 7920  m_mnist.yaml -y 
-0001d670: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
-0001d680: 2027 736c 6565 7020 3527 2c0a 2020 2020   'sleep 5',.    
-0001d690: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-0001d6a0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-0001d6b0: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
-0001d6c0: 202d 6e31 207c 2067 7265 7020 5354 4152   -n1 | grep STAR
-0001d6d0: 5449 4e47 272c 0a20 2020 2020 2020 2020  TING',.         
-0001d6e0: 2020 2027 736c 6565 7020 3930 3027 2c20     'sleep 900', 
-0001d6f0: 2023 2054 5055 2074 616b 6573 2061 2077   # TPU takes a w
-0001d700: 6869 6c65 2074 6f20 6c61 756e 6368 0a20  hile to launch. 
-0001d710: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-0001d720: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-0001d730: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-0001d740: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-0001d750: 5255 4e4e 494e 475c 7c53 5543 4345 4544  RUNNING\|SUCCEED
-0001d760: 4544 2227 2c0a 2020 2020 2020 2020 5d2c  ED"',.        ],
-0001d770: 0a20 2020 2020 2020 205f 5350 4f54 5f43  .        _SPOT_C
-0001d780: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
-0001d790: 7428 6a6f 625f 6e61 6d65 3d6e 616d 6529  t(job_name=name)
-0001d7a0: 2c0a 2020 2020 2020 2020 2320 496e 6372  ,.        # Incr
-0001d7b0: 6561 7365 2074 696d 656f 7574 2073 696e  ease timeout sin
-0001d7c0: 6365 2073 6b79 2073 706f 7420 7175 6575  ce sky spot queu
-0001d7d0: 6520 2d72 2063 616e 2062 6520 626c 6f63  e -r can be bloc
-0001d7e0: 6b65 6420 6279 206f 7468 6572 2073 706f  ked by other spo
-0001d7f0: 7420 7465 7374 732e 0a20 2020 2020 2020  t tests..       
-0001d800: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
-0001d810: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-0001d820: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-0001d830: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
-0001d840: 7374 696e 6720 656e 7620 666f 7220 7370  sting env for sp
-0001d850: 6f74 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  ot ----------.@p
-0001d860: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
-0001d870: 7569 6473 7461 636b 2020 2320 466c 7569  uidstack  # Flui
-0001d880: 6473 7461 636b 2064 6f65 7320 6e6f 7420  dstack does not 
-0001d890: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
-0001d8a0: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
-0001d8b0: 6172 6b2e 6e6f 5f61 7a75 7265 2020 2320  ark.no_azure  # 
-0001d8c0: 417a 7572 6520 646f 6573 206e 6f74 2073  Azure does not s
-0001d8d0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-0001d8e0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-0001d8f0: 726b 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f  rk.no_lambda_clo
-0001d900: 7564 2020 2320 4c61 6d62 6461 2043 6c6f  ud  # Lambda Clo
-0001d910: 7564 2064 6f65 7320 6e6f 7420 7375 7070  ud does not supp
-0001d920: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
-0001d930: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-0001d940: 6e6f 5f69 626d 2020 2320 4942 4d20 436c  no_ibm  # IBM Cl
-0001d950: 6f75 6420 646f 6573 206e 6f74 2073 7570  oud does not sup
-0001d960: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
-0001d970: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
-0001d980: 2e6e 6f5f 7363 7020 2023 2053 4350 2064  .no_scp  # SCP d
-0001d990: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-0001d9a0: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-0001d9b0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f70  pytest.mark.no_p
-0001d9c0: 6170 6572 7370 6163 6520 2023 2050 6170  aperspace  # Pap
-0001d9d0: 6572 7370 6163 6520 646f 6573 206e 6f74  erspace does not
-0001d9e0: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-0001d9f0: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-0001da00: 6d61 726b 2e6e 6f5f 6b75 6265 726e 6574  mark.no_kubernet
-0001da10: 6573 2020 2320 4b75 6265 726e 6574 6573  es  # Kubernetes
-0001da20: 2064 6f65 7320 6e6f 7420 6861 7665 2061   does not have a
-0001da30: 206e 6f74 696f 6e20 6f66 2073 706f 7420   notion of spot 
-0001da40: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-0001da50: 742e 6d61 726b 2e6d 616e 6167 6564 5f73  t.mark.managed_s
-0001da60: 706f 740a 6465 6620 7465 7374 5f73 706f  pot.def test_spo
-0001da70: 745f 696e 6c69 6e65 5f65 6e76 2867 656e  t_inline_env(gen
-0001da80: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-0001da90: 3a0a 2020 2020 2222 2254 6573 7420 7370  :.    """Test sp
-0001daa0: 6f74 2065 6e76 2222 220a 2020 2020 6e61  ot env""".    na
-0001dab0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-0001dac0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-0001dad0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-0001dae0: 2020 2774 6573 742d 7370 6f74 2d69 6e6c    'test-spot-inl
-0001daf0: 696e 652d 656e 7627 2c0a 2020 2020 2020  ine-env',.      
-0001db00: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-0001db10: 6627 736b 7920 7370 6f74 206c 6175 6e63  f'sky spot launc
-0001db20: 6820 2d6e 207b 6e61 6d65 7d20 2d79 202d  h -n {name} -y -
-0001db30: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-0001db40: 636c 6f75 647d 202d 2d65 6e76 2054 4553  cloud} --env TES
-0001db50: 545f 454e 563d 2268 656c 6c6f 2077 6f72  T_ENV="hello wor
-0001db60: 6c64 2220 2d2d 2022 285b 5b20 2120 2d7a  ld" -- "([[ ! -z
-0001db70: 205c 5c22 5c24 5445 5354 5f45 4e56 5c5c   \\"\$TEST_ENV\\
-0001db80: 2220 5d5d 2026 2620 5b5b 2021 202d 7a20  " ]] && [[ ! -z 
-0001db90: 5c5c 225c 2453 4b59 5049 4c4f 545f 4e4f  \\"\$SKYPILOT_NO
-0001dba0: 4445 5f49 5053 5c5c 2220 5d5d 2026 2620  DE_IPS\\" ]] && 
-0001dbb0: 5b5b 2021 202d 7a20 5c5c 225c 2453 4b59  [[ ! -z \\"\$SKY
-0001dbc0: 5049 4c4f 545f 4e4f 4445 5f52 414e 4b5c  PILOT_NODE_RANK\
-0001dbd0: 5c22 205d 5d29 207c 7c20 6578 6974 2031  \" ]]) || exit 1
-0001dbe0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-0001dbf0: 2773 6c65 6570 2032 3027 2c0a 2020 2020  'sleep 20',.    
-0001dc00: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-0001dc10: 5f51 5545 5545 5f57 4149 547d 207c 2067  _QUEUE_WAIT} | g
-0001dc20: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-0001dc30: 7020 5355 4343 4545 4445 4427 2c0a 2020  p SUCCEEDED',.  
-0001dc40: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0001dc50: 205f 5350 4f54 5f43 414e 4345 4c5f 5741   _SPOT_CANCEL_WA
-0001dc60: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
-0001dc70: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
-0001dc80: 2020 2320 496e 6372 6561 7365 2074 696d    # Increase tim
-0001dc90: 656f 7574 2073 696e 6365 2073 6b79 2073  eout since sky s
-0001dca0: 706f 7420 7175 6575 6520 2d72 2063 616e  pot queue -r can
-0001dcb0: 2062 6520 626c 6f63 6b65 6420 6279 206f   be blocked by o
-0001dcc0: 7468 6572 2073 706f 7420 7465 7374 732e  ther spot tests.
-0001dcd0: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-0001dce0: 3d32 3020 2a20 3630 2c0a 2020 2020 290a  =20 * 60,.    ).
-0001dcf0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-0001dd00: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
-0001dd10: 2d2d 2d2d 2d20 5465 7374 696e 6720 656e  ----- Testing en
-0001dd20: 7620 2d2d 2d2d 2d2d 2d2d 2d2d 0a64 6566  v ----------.def
-0001dd30: 2074 6573 745f 696e 6c69 6e65 5f65 6e76   test_inline_env
-0001dd40: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
-0001dd50: 7374 7229 3a0a 2020 2020 2222 2254 6573  str):.    """Tes
-0001dd60: 7420 656e 7622 2222 0a20 2020 206e 616d  t env""".    nam
-0001dd70: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-0001dd80: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-0001dd90: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-0001dda0: 2027 7465 7374 2d69 6e6c 696e 652d 656e   'test-inline-en
-0001ddb0: 7627 2c0a 2020 2020 2020 2020 5b0a 2020  v',.        [.  
-0001ddc0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0001ddd0: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
-0001dde0: 202d 7920 2d2d 636c 6f75 6420 7b67 656e   -y --cloud {gen
-0001ddf0: 6572 6963 5f63 6c6f 7564 7d20 2d2d 656e  eric_cloud} --en
-0001de00: 7620 5445 5354 5f45 4e56 3d22 6865 6c6c  v TEST_ENV="hell
-0001de10: 6f20 776f 726c 6422 202d 2d20 2228 5b5b  o world" -- "([[
-0001de20: 2021 202d 7a20 5c5c 225c 2454 4553 545f   ! -z \\"\$TEST_
-0001de30: 454e 565c 5c22 205d 5d20 2626 205b 5b20  ENV\\" ]] && [[ 
-0001de40: 2120 2d7a 205c 5c22 5c24 534b 5950 494c  ! -z \\"\$SKYPIL
-0001de50: 4f54 5f4e 4f44 455f 4950 535c 5c22 205d  OT_NODE_IPS\\" ]
-0001de60: 5d20 2626 205b 5b20 2120 2d7a 205c 5c22  ] && [[ ! -z \\"
-0001de70: 5c24 534b 5950 494c 4f54 5f4e 4f44 455f  \$SKYPILOT_NODE_
-0001de80: 5241 4e4b 5c5c 2220 5d5d 2920 7c7c 2065  RANK\\" ]]) || e
-0001de90: 7869 7420 3122 272c 0a20 2020 2020 2020  xit 1"',.       
-0001dea0: 2020 2020 2027 736c 6565 7020 3230 272c       'sleep 20',
-0001deb0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0001dec0: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-0001ded0: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-0001dee0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-0001def0: 6563 207b 6e61 6d65 7d20 2d2d 656e 7620  ec {name} --env 
-0001df00: 5445 5354 5f45 4e56 323d 2273 7563 6365  TEST_ENV2="succe
-0001df10: 7373 2220 2228 5b5b 2021 202d 7a20 5c5c  ss" "([[ ! -z \\
-0001df20: 225c 2454 4553 545f 454e 5632 5c5c 2220  "\$TEST_ENV2\\" 
-0001df30: 5d5d 2026 2620 5b5b 2021 202d 7a20 5c5c  ]] && [[ ! -z \\
-0001df40: 225c 2453 4b59 5049 4c4f 545f 4e4f 4445  "\$SKYPILOT_NODE
-0001df50: 5f49 5053 5c5c 2220 5d5d 2026 2620 5b5b  _IPS\\" ]] && [[
-0001df60: 2021 202d 7a20 5c5c 225c 2453 4b59 5049   ! -z \\"\$SKYPI
-0001df70: 4c4f 545f 4e4f 4445 5f52 414e 4b5c 5c22  LOT_NODE_RANK\\"
-0001df80: 205d 5d29 207c 7c20 6578 6974 2031 2227   ]]) || exit 1"'
-0001df90: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001dfa0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0001dfb0: 3220 2d2d 7374 6174 7573 272c 0a20 2020  2 --status',.   
-0001dfc0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0001dfd0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-0001dfe0: 616d 657d 272c 0a20 2020 2020 2020 205f  ame}',.        _
-0001dff0: 6765 745f 7469 6d65 6f75 7428 6765 6e65  get_timeout(gene
-0001e000: 7269 635f 636c 6f75 6429 2c0a 2020 2020  ric_cloud),.    
-0001e010: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-0001e020: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-0001e030: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
-0001e040: 656e 7620 6669 6c65 202d 2d2d 2d2d 2d2d  env file -------
-0001e050: 2d2d 2d0a 6465 6620 7465 7374 5f69 6e6c  ---.def test_inl
-0001e060: 696e 655f 656e 765f 6669 6c65 2867 656e  ine_env_file(gen
-0001e070: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-0001e080: 3a0a 2020 2020 2222 2254 6573 7420 656e  :.    """Test en
-0001e090: 7622 2222 0a20 2020 206e 616d 6520 3d20  v""".    name = 
-0001e0a0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-0001e0b0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-0001e0c0: 6573 7428 0a20 2020 2020 2020 2027 7465  est(.        'te
-0001e0d0: 7374 2d69 6e6c 696e 652d 656e 762d 6669  st-inline-env-fi
-0001e0e0: 6c65 272c 0a20 2020 2020 2020 205b 0a20  le',.        [. 
-0001e0f0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0001e100: 206c 6175 6e63 6820 2d63 207b 6e61 6d65   launch -c {name
-0001e110: 7d20 2d79 202d 2d63 6c6f 7564 207b 6765  } -y --cloud {ge
-0001e120: 6e65 7269 635f 636c 6f75 647d 202d 2d65  neric_cloud} --e
-0001e130: 6e76 2054 4553 545f 454e 563d 2268 656c  nv TEST_ENV="hel
-0001e140: 6c6f 2077 6f72 6c64 2220 2d2d 2022 285b  lo world" -- "([
-0001e150: 5b20 2120 2d7a 205c 5c22 5c24 5445 5354  [ ! -z \\"\$TEST
-0001e160: 5f45 4e56 5c5c 2220 5d5d 2026 2620 5b5b  _ENV\\" ]] && [[
-0001e170: 2021 202d 7a20 5c5c 225c 2453 4b59 5049   ! -z \\"\$SKYPI
-0001e180: 4c4f 545f 4e4f 4445 5f49 5053 5c5c 2220  LOT_NODE_IPS\\" 
-0001e190: 5d5d 2026 2620 5b5b 2021 202d 7a20 5c5c  ]] && [[ ! -z \\
-0001e1a0: 225c 2453 4b59 5049 4c4f 545f 4e4f 4445  "\$SKYPILOT_NODE
-0001e1b0: 5f52 414e 4b5c 5c22 205d 5d29 207c 7c20  _RANK\\" ]]) || 
-0001e1c0: 6578 6974 2031 2227 2c0a 2020 2020 2020  exit 1"',.      
-0001e1d0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-0001e1e0: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
-0001e1f0: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-0001e200: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-0001e210: 657d 202d 2d65 6e76 2d66 696c 6520 6578  e} --env-file ex
-0001e220: 616d 706c 6573 2f73 616d 706c 655f 646f  amples/sample_do
-0001e230: 7465 6e76 2022 285b 5b20 2120 2d7a 205c  tenv "([[ ! -z \
-0001e240: 5c22 5c24 5445 5354 5f45 4e56 325c 5c22  \"\$TEST_ENV2\\"
-0001e250: 205d 5d20 2626 205b 5b20 2120 2d7a 205c   ]] && [[ ! -z \
-0001e260: 5c22 5c24 534b 5950 494c 4f54 5f4e 4f44  \"\$SKYPILOT_NOD
-0001e270: 455f 4950 535c 5c22 205d 5d20 2626 205b  E_IPS\\" ]] && [
-0001e280: 5b20 2120 2d7a 205c 5c22 5c24 534b 5950  [ ! -z \\"\$SKYP
-0001e290: 494c 4f54 5f4e 4f44 455f 5241 4e4b 5c5c  ILOT_NODE_RANK\\
-0001e2a0: 2220 5d5d 2920 7c7c 2065 7869 7420 3122  " ]]) || exit 1"
-0001e2b0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001e2c0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0001e2d0: 2032 202d 2d73 7461 7475 7327 2c0a 2020   2 --status',.  
-0001e2e0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0001e2f0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-0001e300: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
-0001e310: 5f67 6574 5f74 696d 656f 7574 2867 656e  _get_timeout(gen
-0001e320: 6572 6963 5f63 6c6f 7564 292c 0a20 2020  eric_cloud),.   
-0001e330: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-0001e340: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
-0001e350: 2d2d 2d2d 2d2d 2d2d 2054 6573 7469 6e67  -------- Testing
-0001e360: 2063 7573 746f 6d20 696d 6167 6520 2d2d   custom image --
-0001e370: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
-0001e380: 2e6d 6172 6b2e 6177 730a 6465 6620 7465  .mark.aws.def te
-0001e390: 7374 5f61 7773 5f63 7573 746f 6d5f 696d  st_aws_custom_im
-0001e3a0: 6167 6528 293a 0a20 2020 2022 2222 5465  age():.    """Te
-0001e3b0: 7374 2041 5753 2063 7573 746f 6d20 696d  st AWS custom im
-0001e3c0: 6167 6522 2222 0a20 2020 206e 616d 6520  age""".    name 
-0001e3d0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0001e3e0: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-0001e3f0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-0001e400: 7465 7374 2d61 7773 2d63 7573 746f 6d2d  test-aws-custom-
-0001e410: 696d 6167 6527 2c0a 2020 2020 2020 2020  image',.        
-0001e420: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-0001e430: 736b 7920 6c61 756e 6368 202d 6320 7b6e  sky launch -c {n
-0001e440: 616d 657d 202d 2d72 6574 7279 2d75 6e74  ame} --retry-unt
-0001e450: 696c 2d75 7020 2d79 2074 6573 7473 2f74  il-up -y tests/t
-0001e460: 6573 745f 7961 6d6c 732f 7465 7374 5f63  est_yamls/test_c
-0001e470: 7573 746f 6d5f 696d 6167 652e 7961 6d6c  ustom_image.yaml
-0001e480: 202d 2d63 6c6f 7564 2061 7773 202d 2d72   --cloud aws --r
-0001e490: 6567 696f 6e20 7573 2d65 6173 742d 3220  egion us-east-2 
-0001e4a0: 2d2d 696d 6167 652d 6964 2061 6d69 2d30  --image-id ami-0
-0001e4b0: 3632 6464 6439 3066 6236 6638 3236 3761  62ddd90fb6f8267a
-0001e4c0: 272c 2020 2320 4e76 6964 6961 2069 6d61  ',  # Nvidia ima
-0001e4d0: 6765 0a20 2020 2020 2020 2020 2020 2066  ge.            f
-0001e4e0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0001e4f0: 2031 202d 2d73 7461 7475 7327 2c0a 2020   1 --status',.  
-0001e500: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0001e510: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-0001e520: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
-0001e530: 7469 6d65 6f75 743d 3330 202a 2036 302c  timeout=30 * 60,
-0001e540: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-0001e550: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-0001e560: 4070 7974 6573 742e 6d61 726b 2e6b 7562  @pytest.mark.kub
-0001e570: 6572 6e65 7465 730a 4070 7974 6573 742e  ernetes.@pytest.
-0001e580: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
-0001e590: 280a 2020 2020 2269 6d61 6765 5f69 6422  (.    "image_id"
-0001e5a0: 2c0a 2020 2020 5b0a 2020 2020 2020 2020  ,.    [.        
-0001e5b0: 2264 6f63 6b65 723a 6e76 6964 6961 2f63  "docker:nvidia/c
-0001e5c0: 7564 613a 3131 2e38 2e30 2d64 6576 656c  uda:11.8.0-devel
-0001e5d0: 2d75 6275 6e74 7531 382e 3034 222c 0a20  -ubuntu18.04",. 
-0001e5e0: 2020 2020 2020 2022 646f 636b 6572 3a75         "docker:u
-0001e5f0: 6275 6e74 753a 3138 2e30 3422 2c0a 2020  buntu:18.04",.  
-0001e600: 2020 2020 2020 2320 5465 7374 206c 6174        # Test lat
-0001e610: 6573 7420 696d 6167 6520 7769 7468 2070  est image with p
-0001e620: 7974 686f 6e20 332e 3131 2069 6e73 7461  ython 3.11 insta
-0001e630: 6c6c 6564 2062 7920 6465 6661 756c 742e  lled by default.
-0001e640: 0a20 2020 2020 2020 2023 2044 6f65 7320  .        # Does 
-0001e650: 6e6f 7420 776f 726b 2066 6f72 2070 7974  not work for pyt
-0001e660: 686f 6e20 332e 3132 2064 7565 2074 6f20  hon 3.12 due to 
-0001e670: 7261 7927 7320 7265 7175 6972 656d 656e  ray's requiremen
-0001e680: 7420 666f 7220 332e 3131 2e0a 2020 2020  t for 3.11..    
-0001e690: 2020 2020 2764 6f63 6b65 723a 636f 6e74      'docker:cont
-0001e6a0: 696e 7575 6d69 6f2f 6d69 6e69 636f 6e64  inuumio/minicond
-0001e6b0: 6133 3a32 342e 312e 322d 3027 2c0a 2020  a3:24.1.2-0',.  
-0001e6c0: 2020 5d29 0a64 6566 2074 6573 745f 6b75    ]).def test_ku
-0001e6d0: 6265 726e 6574 6573 5f63 7573 746f 6d5f  bernetes_custom_
-0001e6e0: 696d 6167 6528 696d 6167 655f 6964 293a  image(image_id):
-0001e6f0: 0a20 2020 2022 2222 5465 7374 204b 7562  .    """Test Kub
-0001e700: 6572 6e65 7465 7320 6375 7374 6f6d 2069  ernetes custom i
-0001e710: 6d61 6765 2222 220a 2020 2020 6e61 6d65  mage""".    name
-0001e720: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-0001e730: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-0001e740: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-0001e750: 2774 6573 742d 6b75 6265 726e 6574 6573  'test-kubernetes
-0001e760: 2d63 7573 746f 6d2d 696d 6167 6527 2c0a  -custom-image',.
-0001e770: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-0001e780: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-0001e790: 6368 202d 6320 7b6e 616d 657d 202d 2d72  ch -c {name} --r
-0001e7a0: 6574 7279 2d75 6e74 696c 2d75 7020 2d79  etry-until-up -y
-0001e7b0: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-0001e7c0: 732f 7465 7374 5f63 7573 746f 6d5f 696d  s/test_custom_im
-0001e7d0: 6167 652e 7961 6d6c 202d 2d63 6c6f 7564  age.yaml --cloud
-0001e7e0: 206b 7562 6572 6e65 7465 7320 2d2d 696d   kubernetes --im
-0001e7f0: 6167 652d 6964 207b 696d 6167 655f 6964  age-id {image_id
-0001e800: 7d20 2d2d 7265 6769 6f6e 204e 6f6e 6520  } --region None 
-0001e810: 2d2d 6770 7573 2054 343a 3127 2c0a 2020  --gpus T4:1',.  
-0001e820: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0001e830: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
-0001e840: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-0001e850: 2020 2020 2023 2054 7279 2065 7865 6320       # Try exec 
-0001e860: 746f 2072 756e 2061 6761 696e 2061 6e64  to run again and
-0001e870: 2063 6865 636b 2069 6620 7468 6520 6c6f   check if the lo
-0001e880: 6773 2061 7265 2070 7269 6e74 6564 0a20  gs are printed. 
-0001e890: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0001e8a0: 2065 7865 6320 7b6e 616d 657d 2074 6573   exec {name} tes
-0001e8b0: 7473 2f74 6573 745f 7961 6d6c 732f 7465  ts/test_yamls/te
-0001e8c0: 7374 5f63 7573 746f 6d5f 696d 6167 652e  st_custom_image.
-0001e8d0: 7961 6d6c 202d 2d63 6c6f 7564 206b 7562  yaml --cloud kub
-0001e8e0: 6572 6e65 7465 7320 2d2d 696d 6167 652d  ernetes --image-
-0001e8f0: 6964 207b 696d 6167 655f 6964 7d20 2d2d  id {image_id} --
-0001e900: 7265 6769 6f6e 204e 6f6e 6520 2d2d 6770  region None --gp
-0001e910: 7573 2054 343a 3120 7c20 6772 6570 2022  us T4:1 | grep "
-0001e920: 4865 6c6c 6f20 3130 3022 272c 0a20 2020  Hello 100"',.   
-0001e930: 2020 2020 2020 2020 2023 204d 616b 6520           # Make 
-0001e940: 7375 7265 2073 7368 2069 7320 776f 726b  sure ssh is work
-0001e950: 696e 6720 7769 7468 2063 7573 746f 6d20  ing with custom 
-0001e960: 7573 6572 6e61 6d65 0a20 2020 2020 2020  username.       
-0001e970: 2020 2020 2066 2773 7368 207b 6e61 6d65       f'ssh {name
-0001e980: 7d20 6563 686f 2068 6920 7c20 6772 6570  } echo hi | grep
-0001e990: 2068 6927 2c0a 2020 2020 2020 2020 5d2c   hi',.        ],
-0001e9a0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-0001e9b0: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-0001e9c0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-0001e9d0: 3330 202a 2036 302c 0a20 2020 2029 0a20  30 * 60,.    ). 
-0001e9e0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-0001e9f0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-0001ea00: 6d61 726b 2e73 6c6f 770a 6465 6620 7465  mark.slow.def te
-0001ea10: 7374 5f61 7a75 7265 5f73 7461 7274 5f73  st_azure_start_s
-0001ea20: 746f 705f 7477 6f5f 6e6f 6465 7328 293a  top_two_nodes():
-0001ea30: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0001ea40: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0001ea50: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-0001ea60: 0a20 2020 2020 2020 2027 617a 7572 652d  .        'azure-
-0001ea70: 7374 6172 742d 7374 6f70 2d74 776f 2d6e  start-stop-two-n
-0001ea80: 6f64 6573 272c 0a20 2020 2020 2020 205b  odes',.        [
-0001ea90: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0001eaa0: 6b79 206c 6175 6e63 6820 2d2d 6e75 6d2d  ky launch --num-
-0001eab0: 6e6f 6465 733d 3220 2d79 202d 6320 7b6e  nodes=2 -y -c {n
-0001eac0: 616d 657d 2065 7861 6d70 6c65 732f 617a  ame} examples/az
-0001ead0: 7572 655f 7374 6172 745f 7374 6f70 2e79  ure_start_stop.y
-0001eae0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-0001eaf0: 2020 6627 736b 7920 6578 6563 202d 2d6e    f'sky exec --n
-0001eb00: 756d 2d6e 6f64 6573 3d32 207b 6e61 6d65  um-nodes=2 {name
-0001eb10: 7d20 6578 616d 706c 6573 2f61 7a75 7265  } examples/azure
-0001eb20: 5f73 7461 7274 5f73 746f 702e 7961 6d6c  _start_stop.yaml
-0001eb30: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001eb40: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0001eb50: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
-0001eb60: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-0001eb70: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-0001eb80: 2020 2020 2020 2066 2773 6b79 2073 746f         f'sky sto
-0001eb90: 7020 2d79 207b 6e61 6d65 7d27 2c0a 2020  p -y {name}',.  
-0001eba0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0001ebb0: 7374 6172 7420 2d79 207b 6e61 6d65 7d27  start -y {name}'
-0001ebc0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001ebd0: 736b 7920 6578 6563 202d 2d6e 756d 2d6e  sky exec --num-n
-0001ebe0: 6f64 6573 3d32 207b 6e61 6d65 7d20 6578  odes=2 {name} ex
-0001ebf0: 616d 706c 6573 2f61 7a75 7265 5f73 7461  amples/azure_sta
-0001ec00: 7274 5f73 746f 702e 7961 6d6c 272c 0a20  rt_stop.yaml',. 
-0001ec10: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0001ec20: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
-0001ec30: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
-0001ec40: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
-0001ec50: 6565 6465 642e 0a20 2020 2020 2020 205d  eeded..        ]
-0001ec60: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-0001ec70: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-0001ec80: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-0001ec90: 3d33 3020 2a20 3630 2c20 2023 2033 3020  =30 * 60,  # 30 
-0001eca0: 6d69 6e73 2020 2869 7420 7461 6b65 7320  mins  (it takes 
-0001ecb0: 6172 6f75 6e64 207e 3233 206d 696e 7329  around ~23 mins)
-0001ecc0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-0001ecd0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-0001ece0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
-0001ecf0: 7469 6e67 2065 6e76 2066 6f72 2064 6973  ting env for dis
-0001ed00: 6b20 7469 6572 202d 2d2d 2d2d 2d2d 2d2d  k tier ---------
-0001ed10: 2d0a 4070 7974 6573 742e 6d61 726b 2e61  -.@pytest.mark.a
-0001ed20: 7773 0a64 6566 2074 6573 745f 6177 735f  ws.def test_aws_
-0001ed30: 6469 736b 5f74 6965 7228 293a 0a0a 2020  disk_tier():..  
-0001ed40: 2020 6465 6620 5f67 6574 5f61 7773 5f71    def _get_aws_q
-0001ed50: 7565 7279 5f63 6f6d 6d61 6e64 2872 6567  uery_command(reg
-0001ed60: 696f 6e2c 2069 6e73 7461 6e63 655f 6964  ion, instance_id
-0001ed70: 2c20 6669 656c 642c 2065 7870 6563 7465  , field, expecte
-0001ed80: 6429 3a0a 2020 2020 2020 2020 7265 7475  d):.        retu
-0001ed90: 726e 2028 6627 6177 7320 6563 3220 6465  rn (f'aws ec2 de
-0001eda0: 7363 7269 6265 2d76 6f6c 756d 6573 202d  scribe-volumes -
-0001edb0: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
-0001edc0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0001edd0: 2020 2066 272d 2d66 696c 7465 7273 204e     f'--filters N
-0001ede0: 616d 653d 6174 7461 6368 6d65 6e74 2e69  ame=attachment.i
-0001edf0: 6e73 7461 6e63 652d 6964 2c56 616c 7565  nstance-id,Value
-0001ee00: 733d 7b69 6e73 7461 6e63 655f 6964 7d20  s={instance_id} 
-0001ee10: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001ee20: 2020 6627 2d2d 7175 6572 7920 566f 6c75    f'--query Volu
-0001ee30: 6d65 735b 2a5d 2e7b 6669 656c 647d 207c  mes[*].{field} |
-0001ee40: 2067 7265 7020 7b65 7870 6563 7465 647d   grep {expected}
-0001ee50: 203b 2027 290a 0a20 2020 2066 6f72 2064   ; ')..    for d
-0001ee60: 6973 6b5f 7469 6572 2069 6e20 6c69 7374  isk_tier in list
-0001ee70: 2872 6573 6f75 7263 6573 5f75 7469 6c73  (resources_utils
-0001ee80: 2e44 6973 6b54 6965 7229 3a0a 2020 2020  .DiskTier):.    
-0001ee90: 2020 2020 7370 6563 7320 3d20 4157 532e      specs = AWS.
-0001eea0: 5f67 6574 5f64 6973 6b5f 7370 6563 7328  _get_disk_specs(
-0001eeb0: 6469 736b 5f74 6965 7229 0a20 2020 2020  disk_tier).     
-0001eec0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-0001eed0: 6c75 7374 6572 5f6e 616d 6528 2920 2b20  luster_name() + 
-0001eee0: 272d 2720 2b20 6469 736b 5f74 6965 722e  '-' + disk_tier.
-0001eef0: 7661 6c75 650a 2020 2020 2020 2020 6e61  value.        na
-0001ef00: 6d65 5f6f 6e5f 636c 6f75 6420 3d20 636f  me_on_cloud = co
-0001ef10: 6d6d 6f6e 5f75 7469 6c73 2e6d 616b 655f  mmon_utils.make_
-0001ef20: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
-0001ef30: 636c 6f75 6428 0a20 2020 2020 2020 2020  cloud(.         
-0001ef40: 2020 206e 616d 652c 2073 6b79 2e41 5753     name, sky.AWS
-0001ef50: 2e6d 6178 5f63 6c75 7374 6572 5f6e 616d  .max_cluster_nam
-0001ef60: 655f 6c65 6e67 7468 2829 290a 2020 2020  e_length()).    
-0001ef70: 2020 2020 7265 6769 6f6e 203d 2027 7573      region = 'us
-0001ef80: 2d65 6173 742d 3227 0a20 2020 2020 2020  -east-2'.       
-0001ef90: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-0001efa0: 2020 2020 2020 2020 2020 2761 7773 2d64            'aws-d
-0001efb0: 6973 6b2d 7469 6572 2d27 202b 2064 6973  isk-tier-' + dis
-0001efc0: 6b5f 7469 6572 2e76 616c 7565 2c0a 2020  k_tier.value,.  
-0001efd0: 2020 2020 2020 2020 2020 5b0a 2020 2020            [.    
-0001efe0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0001eff0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-0001f000: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6177  name} --cloud aw
-0001f010: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
-0001f020: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
-0001f030: 2020 2020 2020 6627 2d2d 6469 736b 2d74        f'--disk-t
-0001f040: 6965 7220 7b64 6973 6b5f 7469 6572 2e76  ier {disk_tier.v
-0001f050: 616c 7565 7d20 6563 686f 2022 6865 6c6c  alue} echo "hell
-0001f060: 6f20 736b 7922 272c 0a20 2020 2020 2020  o sky"',.       
-0001f070: 2020 2020 2020 2020 2066 2769 643d 6061           f'id=`a
-0001f080: 7773 2065 6332 2064 6573 6372 6962 652d  ws ec2 describe-
-0001f090: 696e 7374 616e 6365 7320 2d2d 7265 6769  instances --regi
-0001f0a0: 6f6e 207b 7265 6769 6f6e 7d20 2d2d 6669  on {region} --fi
-0001f0b0: 6c74 6572 7320 270a 2020 2020 2020 2020  lters '.        
-0001f0c0: 2020 2020 2020 2020 6627 4e61 6d65 3d74          f'Name=t
-0001f0d0: 6167 3a72 6179 2d63 6c75 7374 6572 2d6e  ag:ray-cluster-n
-0001f0e0: 616d 652c 5661 6c75 6573 3d7b 6e61 6d65  ame,Values={name
-0001f0f0: 5f6f 6e5f 636c 6f75 647d 202d 2d71 7565  _on_cloud} --que
-0001f100: 7279 2027 0a20 2020 2020 2020 2020 2020  ry '.           
-0001f110: 2020 2020 2066 2752 6573 6572 7661 7469       f'Reservati
-0001f120: 6f6e 735b 5d2e 496e 7374 616e 6365 735b  ons[].Instances[
-0001f130: 5d2e 496e 7374 616e 6365 4964 202d 2d6f  ].InstanceId --o
-0001f140: 7574 7075 7420 7465 7874 603b 2027 202b  utput text`; ' +
-0001f150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f160: 205f 6765 745f 6177 735f 7175 6572 795f   _get_aws_query_
-0001f170: 636f 6d6d 616e 6428 7265 6769 6f6e 2c20  command(region, 
-0001f180: 2724 6964 272c 2027 566f 6c75 6d65 5479  '$id', 'VolumeTy
-0001f190: 7065 272c 0a20 2020 2020 2020 2020 2020  pe',.           
-0001f1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f1b0: 2020 2020 2020 2020 2020 2020 7370 6563              spec
-0001f1c0: 735b 2764 6973 6b5f 7469 6572 275d 2920  s['disk_tier']) 
-0001f1d0: 2b0a 2020 2020 2020 2020 2020 2020 2020  +.              
-0001f1e0: 2020 2827 2720 6966 2064 6973 6b5f 7469    ('' if disk_ti
-0001f1f0: 6572 203d 3d20 7265 736f 7572 6365 735f  er == resources_
-0001f200: 7574 696c 732e 4469 736b 5469 6572 2e4c  utils.DiskTier.L
-0001f210: 4f57 2065 6c73 650a 2020 2020 2020 2020  OW else.        
-0001f220: 2020 2020 2020 2020 2028 5f67 6574 5f61           (_get_a
-0001f230: 7773 5f71 7565 7279 5f63 6f6d 6d61 6e64  ws_query_command
-0001f240: 2872 6567 696f 6e2c 2027 2469 6427 2c20  (region, '$id', 
-0001f250: 2749 6f70 7327 2c0a 2020 2020 2020 2020  'Iops',.        
-0001f260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f280: 2073 7065 6373 5b27 6469 736b 5f69 6f70   specs['disk_iop
-0001f290: 7327 5d29 202b 0a20 2020 2020 2020 2020  s']) +.         
-0001f2a0: 2020 2020 2020 2020 205f 6765 745f 6177           _get_aw
-0001f2b0: 735f 7175 6572 795f 636f 6d6d 616e 6428  s_query_command(
-0001f2c0: 7265 6769 6f6e 2c20 2724 6964 272c 2027  region, '$id', '
-0001f2d0: 5468 726f 7567 6870 7574 272c 0a20 2020  Throughput',.   
-0001f2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f300: 2020 2020 2020 7370 6563 735b 2764 6973        specs['dis
-0001f310: 6b5f 7468 726f 7567 6870 7574 275d 2929  k_throughput']))
-0001f320: 292c 0a20 2020 2020 2020 2020 2020 205d  ),.            ]
-0001f330: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001f340: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-0001f350: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
-0001f360: 2074 696d 656f 7574 3d31 3020 2a20 3630   timeout=10 * 60
-0001f370: 2c20 2023 2031 3020 6d69 6e73 2020 2869  ,  # 10 mins  (i
-0001f380: 7420 7461 6b65 7320 6172 6f75 6e64 207e  t takes around ~
-0001f390: 3620 6d69 6e73 290a 2020 2020 2020 2020  6 mins).        
-0001f3a0: 290a 2020 2020 2020 2020 7275 6e5f 6f6e  ).        run_on
-0001f3b0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-0001f3c0: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
-0001f3d0: 6465 6620 7465 7374 5f67 6370 5f64 6973  def test_gcp_dis
-0001f3e0: 6b5f 7469 6572 2829 3a0a 2020 2020 666f  k_tier():.    fo
-0001f3f0: 7220 6469 736b 5f74 6965 7220 696e 206c  r disk_tier in l
-0001f400: 6973 7428 7265 736f 7572 6365 735f 7574  ist(resources_ut
-0001f410: 696c 732e 4469 736b 5469 6572 293a 0a20  ils.DiskTier):. 
-0001f420: 2020 2020 2020 2074 7970 6520 3d20 4743         type = GC
-0001f430: 502e 5f67 6574 5f64 6973 6b5f 7479 7065  P._get_disk_type
-0001f440: 2864 6973 6b5f 7469 6572 290a 2020 2020  (disk_tier).    
-0001f450: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-0001f460: 636c 7573 7465 725f 6e61 6d65 2829 202b  cluster_name() +
-0001f470: 2027 2d27 202b 2064 6973 6b5f 7469 6572   '-' + disk_tier
-0001f480: 2e76 616c 7565 0a20 2020 2020 2020 206e  .value.        n
-0001f490: 616d 655f 6f6e 5f63 6c6f 7564 203d 2063  ame_on_cloud = c
-0001f4a0: 6f6d 6d6f 6e5f 7574 696c 732e 6d61 6b65  ommon_utils.make
-0001f4b0: 5f63 6c75 7374 6572 5f6e 616d 655f 6f6e  _cluster_name_on
-0001f4c0: 5f63 6c6f 7564 280a 2020 2020 2020 2020  _cloud(.        
-0001f4d0: 2020 2020 6e61 6d65 2c20 736b 792e 4743      name, sky.GC
-0001f4e0: 502e 6d61 785f 636c 7573 7465 725f 6e61  P.max_cluster_na
-0001f4f0: 6d65 5f6c 656e 6774 6828 2929 0a20 2020  me_length()).   
-0001f500: 2020 2020 2072 6567 696f 6e20 3d20 2775       region = 'u
-0001f510: 732d 7765 7374 3227 0a20 2020 2020 2020  s-west2'.       
-0001f520: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-0001f530: 2020 2020 2020 2020 2020 2767 6370 2d64            'gcp-d
-0001f540: 6973 6b2d 7469 6572 2d27 202b 2064 6973  isk-tier-' + dis
-0001f550: 6b5f 7469 6572 2e76 616c 7565 2c0a 2020  k_tier.value,.  
-0001f560: 2020 2020 2020 2020 2020 5b0a 2020 2020            [.    
-0001f570: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0001f580: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-0001f590: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6763  name} --cloud gc
-0001f5a0: 7020 2d2d 7265 6769 6f6e 207b 7265 6769  p --region {regi
-0001f5b0: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
-0001f5c0: 2020 2020 2020 6627 2d2d 6469 736b 2d74        f'--disk-t
-0001f5d0: 6965 7220 7b64 6973 6b5f 7469 6572 2e76  ier {disk_tier.v
-0001f5e0: 616c 7565 7d20 6563 686f 2022 6865 6c6c  alue} echo "hell
-0001f5f0: 6f20 736b 7922 272c 0a20 2020 2020 2020  o sky"',.       
-0001f600: 2020 2020 2020 2020 2066 276e 616d 653d           f'name=
-0001f610: 6067 636c 6f75 6420 636f 6d70 7574 6520  `gcloud compute 
-0001f620: 696e 7374 616e 6365 7320 6c69 7374 202d  instances list -
-0001f630: 2d66 696c 7465 723d 270a 2020 2020 2020  -filter='.      
-0001f640: 2020 2020 2020 2020 2020 6627 226c 6162            f'"lab
-0001f650: 656c 732e 7261 792d 636c 7573 7465 722d  els.ray-cluster-
-0001f660: 6e61 6d65 3a7b 6e61 6d65 5f6f 6e5f 636c  name:{name_on_cl
-0001f670: 6f75 647d 2220 270a 2020 2020 2020 2020  oud}" '.        
-0001f680: 2020 2020 2020 2020 272d 2d66 6f72 6d61          '--forma
-0001f690: 743d 2276 616c 7565 286e 616d 6529 2260  t="value(name)"`
-0001f6a0: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-0001f6b0: 2020 2020 6627 6763 6c6f 7564 2063 6f6d      f'gcloud com
-0001f6c0: 7075 7465 2064 6973 6b73 206c 6973 7420  pute disks list 
-0001f6d0: 2d2d 6669 6c74 6572 3d22 6e61 6d65 3d24  --filter="name=$
-0001f6e0: 6e61 6d65 2220 270a 2020 2020 2020 2020  name" '.        
-0001f6f0: 2020 2020 2020 2020 6627 2d2d 666f 726d          f'--form
-0001f700: 6174 3d22 7661 6c75 6528 7479 7065 2922  at="value(type)"
-0001f710: 207c 2067 7265 7020 7b74 7970 657d 2027   | grep {type} '
-0001f720: 0a20 2020 2020 2020 2020 2020 205d 2c0a  .            ],.
-0001f730: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0001f740: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-0001f750: 272c 0a20 2020 2020 2020 2020 2020 2074  ',.            t
-0001f760: 696d 656f 7574 3d36 202a 2036 302c 2020  imeout=6 * 60,  
-0001f770: 2320 3620 6d69 6e73 2020 2869 7420 7461  # 6 mins  (it ta
-0001f780: 6b65 7320 6172 6f75 6e64 207e 3320 6d69  kes around ~3 mi
-0001f790: 6e73 290a 2020 2020 2020 2020 290a 2020  ns).        ).  
-0001f7a0: 2020 2020 2020 7275 6e5f 6f6e 655f 7465        run_one_te
-0001f7b0: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-0001f7c0: 7374 2e6d 6172 6b2e 617a 7572 650a 6465  st.mark.azure.de
-0001f7d0: 6620 7465 7374 5f61 7a75 7265 5f64 6973  f test_azure_dis
-0001f7e0: 6b5f 7469 6572 2829 3a0a 2020 2020 666f  k_tier():.    fo
-0001f7f0: 7220 6469 736b 5f74 6965 7220 696e 206c  r disk_tier in l
-0001f800: 6973 7428 7265 736f 7572 6365 735f 7574  ist(resources_ut
-0001f810: 696c 732e 4469 736b 5469 6572 293a 0a20  ils.DiskTier):. 
-0001f820: 2020 2020 2020 2069 6620 6469 736b 5f74         if disk_t
-0001f830: 6965 7220 3d3d 2072 6573 6f75 7263 6573  ier == resources
-0001f840: 5f75 7469 6c73 2e44 6973 6b54 6965 722e  _utils.DiskTier.
-0001f850: 4849 4748 3a0a 2020 2020 2020 2020 2020  HIGH:.          
-0001f860: 2020 2320 417a 7572 6520 646f 6573 206e    # Azure does n
-0001f870: 6f74 2073 7570 706f 7274 2068 6967 6820  ot support high 
-0001f880: 6469 736b 2074 6965 722e 0a20 2020 2020  disk tier..     
-0001f890: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-0001f8a0: 2020 2020 2020 2020 7479 7065 203d 2041          type = A
-0001f8b0: 7a75 7265 2e5f 6765 745f 6469 736b 5f74  zure._get_disk_t
-0001f8c0: 7970 6528 6469 736b 5f74 6965 7229 0a20  ype(disk_tier). 
-0001f8d0: 2020 2020 2020 206e 616d 6520 3d20 5f67         name = _g
-0001f8e0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-0001f8f0: 2920 2b20 272d 2720 2b20 6469 736b 5f74  ) + '-' + disk_t
-0001f900: 6965 722e 7661 6c75 650a 2020 2020 2020  ier.value.      
-0001f910: 2020 6e61 6d65 5f6f 6e5f 636c 6f75 6420    name_on_cloud 
-0001f920: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e6d  = common_utils.m
-0001f930: 616b 655f 636c 7573 7465 725f 6e61 6d65  ake_cluster_name
-0001f940: 5f6f 6e5f 636c 6f75 6428 0a20 2020 2020  _on_cloud(.     
-0001f950: 2020 2020 2020 206e 616d 652c 2073 6b79         name, sky
-0001f960: 2e41 7a75 7265 2e6d 6178 5f63 6c75 7374  .Azure.max_clust
-0001f970: 6572 5f6e 616d 655f 6c65 6e67 7468 2829  er_name_length()
-0001f980: 290a 2020 2020 2020 2020 7265 6769 6f6e  ).        region
-0001f990: 203d 2027 7765 7374 7573 3227 0a20 2020   = 'westus2'.   
-0001f9a0: 2020 2020 2074 6573 7420 3d20 5465 7374       test = Test
-0001f9b0: 280a 2020 2020 2020 2020 2020 2020 2761  (.            'a
-0001f9c0: 7a75 7265 2d64 6973 6b2d 7469 6572 2d27  zure-disk-tier-'
-0001f9d0: 202b 2064 6973 6b5f 7469 6572 2e76 616c   + disk_tier.val
-0001f9e0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-0001f9f0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-0001fa00: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-0001fa10: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
-0001fa20: 6f75 6420 617a 7572 6520 2d2d 7265 6769  oud azure --regi
-0001fa30: 6f6e 207b 7265 6769 6f6e 7d20 270a 2020  on {region} '.  
-0001fa40: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-0001fa50: 2d2d 6469 736b 2d74 6965 7220 7b64 6973  --disk-tier {dis
-0001fa60: 6b5f 7469 6572 2e76 616c 7565 7d20 6563  k_tier.value} ec
-0001fa70: 686f 2022 6865 6c6c 6f20 736b 7922 272c  ho "hello sky"',
-0001fa80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fa90: 2066 2761 7a20 7265 736f 7572 6365 206c   f'az resource l
-0001faa0: 6973 7420 2d2d 7461 6720 7261 792d 636c  ist --tag ray-cl
-0001fab0: 7573 7465 722d 6e61 6d65 3d7b 6e61 6d65  uster-name={name
-0001fac0: 5f6f 6e5f 636c 6f75 647d 202d 2d71 7565  _on_cloud} --que
-0001fad0: 7279 2027 0a20 2020 2020 2020 2020 2020  ry '.           
-0001fae0: 2020 2020 2066 2722 5b3f 7479 7065 3d3d       f'"[?type==
-0001faf0: 5c27 4d69 6372 6f73 6f66 742e 436f 6d70  \'Microsoft.Comp
-0001fb00: 7574 652f 6469 736b 735c 275d 2e73 6b75  ute/disks\'].sku
-0001fb10: 2e6e 616d 6522 2027 0a20 2020 2020 2020  .name" '.       
-0001fb20: 2020 2020 2020 2020 2066 272d 2d6f 7574           f'--out
-0001fb30: 7075 7420 7473 7620 7c20 6772 6570 207b  put tsv | grep {
-0001fb40: 7479 7065 7d27 0a20 2020 2020 2020 2020  type}'.         
-0001fb50: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
-0001fb60: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-0001fb70: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
-0001fb80: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
-0001fb90: 2a20 3630 2c20 2023 2032 3020 6d69 6e73  * 60,  # 20 mins
-0001fba0: 2020 2869 7420 7461 6b65 7320 6172 6f75    (it takes arou
-0001fbb0: 6e64 207e 3132 206d 696e 7329 0a20 2020  nd ~12 mins).   
-0001fbc0: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-0001fbd0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-0001fbe0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-0001fbf0: 2e61 7a75 7265 0a64 6566 2074 6573 745f  .azure.def test_
-0001fc00: 617a 7572 655f 6265 7374 5f74 6965 725f  azure_best_tier_
-0001fc10: 6661 696c 6f76 6572 2829 3a0a 2020 2020  failover():.    
-0001fc20: 7479 7065 203d 2041 7a75 7265 2e5f 6765  type = Azure._ge
-0001fc30: 745f 6469 736b 5f74 7970 6528 7265 736f  t_disk_type(reso
-0001fc40: 7572 6365 735f 7574 696c 732e 4469 736b  urces_utils.Disk
-0001fc50: 5469 6572 2e4c 4f57 290a 2020 2020 6e61  Tier.LOW).    na
-0001fc60: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-0001fc70: 725f 6e61 6d65 2829 0a20 2020 206e 616d  r_name().    nam
-0001fc80: 655f 6f6e 5f63 6c6f 7564 203d 2063 6f6d  e_on_cloud = com
-0001fc90: 6d6f 6e5f 7574 696c 732e 6d61 6b65 5f63  mon_utils.make_c
-0001fca0: 6c75 7374 6572 5f6e 616d 655f 6f6e 5f63  luster_name_on_c
-0001fcb0: 6c6f 7564 280a 2020 2020 2020 2020 6e61  loud(.        na
-0001fcc0: 6d65 2c20 736b 792e 417a 7572 652e 6d61  me, sky.Azure.ma
-0001fcd0: 785f 636c 7573 7465 725f 6e61 6d65 5f6c  x_cluster_name_l
-0001fce0: 656e 6774 6828 2929 0a20 2020 2072 6567  ength()).    reg
-0001fcf0: 696f 6e20 3d20 2777 6573 7475 7332 270a  ion = 'westus2'.
-0001fd00: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-0001fd10: 0a20 2020 2020 2020 2027 617a 7572 652d  .        'azure-
-0001fd20: 6265 7374 2d74 6965 722d 6661 696c 6f76  best-tier-failov
-0001fd30: 6572 272c 0a20 2020 2020 2020 205b 0a20  er',.        [. 
-0001fd40: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0001fd50: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-0001fd60: 616d 657d 202d 2d63 6c6f 7564 2061 7a75  ame} --cloud azu
-0001fd70: 7265 202d 2d72 6567 696f 6e20 7b72 6567  re --region {reg
-0001fd80: 696f 6e7d 2027 0a20 2020 2020 2020 2020  ion} '.         
-0001fd90: 2020 2066 272d 2d64 6973 6b2d 7469 6572     f'--disk-tier
-0001fda0: 2062 6573 7420 2d2d 696e 7374 616e 6365   best --instance
-0001fdb0: 2d74 7970 6520 5374 616e 6461 7264 5f44  -type Standard_D
-0001fdc0: 385f 7635 2065 6368 6f20 2268 656c 6c6f  8_v5 echo "hello
-0001fdd0: 2073 6b79 2227 2c0a 2020 2020 2020 2020   sky"',.        
-0001fde0: 2020 2020 6627 617a 2072 6573 6f75 7263      f'az resourc
-0001fdf0: 6520 6c69 7374 202d 2d74 6167 2072 6179  e list --tag ray
-0001fe00: 2d63 6c75 7374 6572 2d6e 616d 653d 7b6e  -cluster-name={n
-0001fe10: 616d 655f 6f6e 5f63 6c6f 7564 7d20 2d2d  ame_on_cloud} --
-0001fe20: 7175 6572 7920 270a 2020 2020 2020 2020  query '.        
-0001fe30: 2020 2020 6627 225b 3f74 7970 653d 3d5c      f'"[?type==\
-0001fe40: 274d 6963 726f 736f 6674 2e43 6f6d 7075  'Microsoft.Compu
-0001fe50: 7465 2f64 6973 6b73 5c27 5d2e 736b 752e  te/disks\'].sku.
-0001fe60: 6e61 6d65 2220 270a 2020 2020 2020 2020  name" '.        
-0001fe70: 2020 2020 6627 2d2d 6f75 7470 7574 2074      f'--output t
-0001fe80: 7376 207c 2067 7265 7020 7b74 7970 657d  sv | grep {type}
-0001fe90: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-0001fea0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-0001feb0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-0001fec0: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
-0001fed0: 2a20 3630 2c20 2023 2032 3020 6d69 6e73  * 60,  # 20 mins
-0001fee0: 2020 2869 7420 7461 6b65 7320 6172 6f75    (it takes arou
-0001fef0: 6e64 207e 3132 206d 696e 7329 0a20 2020  nd ~12 mins).   
-0001ff00: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-0001ff10: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
-0001ff20: 2d2d 2d2d 2054 6573 7469 6e67 205a 6572  ---- Testing Zer
-0001ff30: 6f20 5175 6f74 6120 4661 696c 6f76 6572  o Quota Failover
-0001ff40: 202d 2d2d 2d2d 2d0a 4070 7974 6573 742e   ------.@pytest.
-0001ff50: 6d61 726b 2e61 7773 0a64 6566 2074 6573  mark.aws.def tes
-0001ff60: 745f 6177 735f 7a65 726f 5f71 756f 7461  t_aws_zero_quota
-0001ff70: 5f66 6169 6c6f 7665 7228 293a 0a0a 2020  _failover():..  
-0001ff80: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-0001ff90: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-0001ffa0: 2072 6567 696f 6e20 3d20 6765 745f 6177   region = get_aw
-0001ffb0: 735f 7265 6769 6f6e 5f66 6f72 5f71 756f  s_region_for_quo
-0001ffc0: 7461 5f66 6169 6c6f 7665 7228 290a 0a20  ta_failover().. 
-0001ffd0: 2020 2069 6620 6e6f 7420 7265 6769 6f6e     if not region
-0001ffe0: 3a0a 2020 2020 2020 2020 7079 7465 7374  :.        pytest
-0001fff0: 2e78 6661 696c 280a 2020 2020 2020 2020  .xfail(.        
-00020000: 2020 2020 2755 6e61 626c 6520 746f 2074      'Unable to t
-00020010: 6573 7420 7a65 726f 2071 756f 7461 2066  est zero quota f
-00020020: 6169 6c6f 7665 7220 6f70 7469 6d69 7a61  ailover optimiza
-00020030: 7469 6f6e 20e2 8094 2071 756f 7461 7320  tion ... quotas 
-00020040: 270a 2020 2020 2020 2020 2020 2020 2766  '.            'f
-00020050: 6f72 2045 4332 2050 3320 696e 7374 616e  or EC2 P3 instan
-00020060: 6365 7320 7765 7265 2066 6f75 6e64 206f  ces were found o
-00020070: 6e20 616c 6c20 4157 5320 7265 6769 6f6e  n all AWS region
-00020080: 732e 2049 7320 7468 6973 2027 0a20 2020  s. Is this '.   
-00020090: 2020 2020 2020 2020 2027 6578 7065 6374           'expect
-000200a0: 6564 2066 6f72 2079 6f75 7220 6163 636f  ed for your acco
-000200b0: 756e 743f 2729 0a20 2020 2020 2020 2072  unt?').        r
-000200c0: 6574 7572 6e0a 0a20 2020 2074 6573 7420  eturn..    test 
-000200d0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-000200e0: 2761 7773 2d7a 6572 6f2d 7175 6f74 612d  'aws-zero-quota-
-000200f0: 6661 696c 6f76 6572 272c 0a20 2020 2020  failover',.     
-00020100: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00020110: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-00020120: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
-00020130: 7564 2061 7773 202d 2d72 6567 696f 6e20  ud aws --region 
-00020140: 7b72 6567 696f 6e7d 202d 2d67 7075 7320  {region} --gpus 
-00020150: 5631 3030 3a38 202d 2d75 7365 2d73 706f  V100:8 --use-spo
-00020160: 7420 7c20 6772 6570 2022 466f 756e 6420  t | grep "Found 
-00020170: 6e6f 2071 756f 7461 2227 2c0a 2020 2020  no quota"',.    
-00020180: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-00020190: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-000201a0: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-000201b0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-000201c0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-000201d0: 6b2e 6763 700a 6465 6620 7465 7374 5f67  k.gcp.def test_g
-000201e0: 6370 5f7a 6572 6f5f 7175 6f74 615f 6661  cp_zero_quota_fa
-000201f0: 696c 6f76 6572 2829 3a0a 0a20 2020 206e  ilover():..    n
-00020200: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00020210: 6572 5f6e 616d 6528 290a 2020 2020 7265  er_name().    re
-00020220: 6769 6f6e 203d 2067 6574 5f67 6370 5f72  gion = get_gcp_r
-00020230: 6567 696f 6e5f 666f 725f 7175 6f74 615f  egion_for_quota_
-00020240: 6661 696c 6f76 6572 2829 0a0a 2020 2020  failover()..    
-00020250: 6966 206e 6f74 2072 6567 696f 6e3a 0a20  if not region:. 
-00020260: 2020 2020 2020 2070 7974 6573 742e 7866         pytest.xf
-00020270: 6169 6c28 0a20 2020 2020 2020 2020 2020  ail(.           
-00020280: 2027 556e 6162 6c65 2074 6f20 7465 7374   'Unable to test
-00020290: 207a 6572 6f20 7175 6f74 6120 6661 696c   zero quota fail
-000202a0: 6f76 6572 206f 7074 696d 697a 6174 696f  over optimizatio
-000202b0: 6e20 e280 9420 7175 6f74 6173 2027 0a20  n ... quotas '. 
-000202c0: 2020 2020 2020 2020 2020 2027 666f 7220             'for 
-000202d0: 4131 3030 2d38 3047 4220 4750 5573 2077  A100-80GB GPUs w
-000202e0: 6572 6520 666f 756e 6420 6f6e 2061 6c6c  ere found on all
-000202f0: 2047 4350 2072 6567 696f 6e73 2e20 4973   GCP regions. Is
-00020300: 2074 6869 7320 270a 2020 2020 2020 2020   this '.        
-00020310: 2020 2020 2765 7870 6563 7465 6420 666f      'expected fo
-00020320: 7220 796f 7572 2061 6363 6f75 6e74 3f27  r your account?'
-00020330: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00020340: 0a0a 2020 2020 7465 7374 203d 2054 6573  ..    test = Tes
-00020350: 7428 0a20 2020 2020 2020 2027 6763 702d  t(.        'gcp-
-00020360: 7a65 726f 2d71 756f 7461 2d66 6169 6c6f  zero-quota-failo
-00020370: 7665 7227 2c0a 2020 2020 2020 2020 5b0a  ver',.        [.
-00020380: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00020390: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-000203a0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6763  name} --cloud gc
-000203b0: 7020 2d2d 7265 6769 6f6e 207b 7265 6769  p --region {regi
-000203c0: 6f6e 7d20 2d2d 6770 7573 2041 3130 302d  on} --gpus A100-
-000203d0: 3830 4742 3a31 202d 2d75 7365 2d73 706f  80GB:1 --use-spo
-000203e0: 7420 7c20 6772 6570 2022 466f 756e 6420  t | grep "Found 
-000203f0: 6e6f 2071 756f 7461 2227 2c0a 2020 2020  no quota"',.    
-00020400: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-00020410: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00020420: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-00020430: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00020440: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
-00020450: 2d20 5465 7374 696e 6720 736b 7973 6572  - Testing skyser
-00020460: 7665 202d 2d2d 2d2d 2d2d 2d2d 2d0a 0a0a  ve ----------...
-00020470: 6465 6620 5f67 6574 5f73 6572 7669 6365  def _get_service
-00020480: 5f6e 616d 6528 2920 2d3e 2073 7472 3a0a  _name() -> str:.
-00020490: 2020 2020 2222 2252 6574 7572 6e73 2061      """Returns a
-000204a0: 2075 7365 722d 756e 6971 7565 2073 6572   user-unique ser
-000204b0: 7669 6365 206e 616d 6520 666f 7220 6561  vice name for ea
-000204c0: 6368 2074 6573 745f 736b 7973 6572 7665  ch test_skyserve
-000204d0: 5f3c 6e61 6d65 3e28 292e 0a0a 2020 2020  _<name>()...    
-000204e0: 4d75 7374 2062 6520 6361 6c6c 6564 2066  Must be called f
-000204f0: 726f 6d20 6561 6368 2074 6573 745f 736b  rom each test_sk
-00020500: 7973 6572 7665 5f3c 6e61 6d65 3e28 292e  yserve_<name>().
-00020510: 0a20 2020 2022 2222 0a20 2020 2063 616c  .    """.    cal
-00020520: 6c65 725f 6675 6e63 5f6e 616d 6520 3d20  ler_func_name = 
-00020530: 696e 7370 6563 742e 7374 6163 6b28 295b  inspect.stack()[
-00020540: 315d 5b33 5d0a 2020 2020 7465 7374 5f6e  1][3].    test_n
-00020550: 616d 6520 3d20 6361 6c6c 6572 5f66 756e  ame = caller_fun
-00020560: 635f 6e61 6d65 2e72 6570 6c61 6365 2827  c_name.replace('
-00020570: 5f27 2c20 272d 2729 2e72 6570 6c61 6365  _', '-').replace
-00020580: 2827 7465 7374 2d27 2c20 2774 2d27 290a  ('test-', 't-').
-00020590: 2020 2020 7465 7374 5f6e 616d 6520 3d20      test_name = 
-000205a0: 7465 7374 5f6e 616d 652e 7265 706c 6163  test_name.replac
-000205b0: 6528 2773 6b79 7365 7276 652d 272c 2027  e('skyserve-', '
-000205c0: 7373 2d27 290a 2020 2020 7465 7374 5f6e  ss-').    test_n
-000205d0: 616d 6520 3d20 636f 6d6d 6f6e 5f75 7469  ame = common_uti
-000205e0: 6c73 2e6d 616b 655f 636c 7573 7465 725f  ls.make_cluster_
-000205f0: 6e61 6d65 5f6f 6e5f 636c 6f75 6428 7465  name_on_cloud(te
-00020600: 7374 5f6e 616d 652c 2032 3429 0a20 2020  st_name, 24).   
-00020610: 2072 6574 7572 6e20 6627 7b74 6573 745f   return f'{test_
-00020620: 6e61 6d65 7d2d 7b74 6573 745f 6964 7d27  name}-{test_id}'
-00020630: 0a0a 0a23 2057 6520 6368 6563 6b20 7468  ...# We check th
-00020640: 6520 6f75 7470 7574 206f 6620 7468 6520  e output of the 
-00020650: 736b 7973 6572 7665 2073 6572 7669 6365  skyserve service
-00020660: 2074 6f20 7365 6520 6966 2069 7420 6973   to see if it is
-00020670: 2072 6561 6479 2e20 4f75 7470 7574 206f   ready. Output o
-00020680: 660a 2320 6052 4550 4c49 4341 5360 2069  f.# `REPLICAS` i
-00020690: 7320 696e 2074 6865 2066 6f72 6d20 6f66  s in the form of
-000206a0: 2060 312f 3260 2077 6865 7265 2074 6865   `1/2` where the
-000206b0: 2066 6972 7374 206e 756d 6265 7220 6973   first number is
-000206c0: 2074 6865 206e 756d 6265 7220 6f66 0a23   the number of.#
-000206d0: 2072 6561 6479 2072 6570 6c69 6361 7320   ready replicas 
-000206e0: 616e 6420 7468 6520 7365 636f 6e64 206e  and the second n
-000206f0: 756d 6265 7220 6973 2074 6865 206e 756d  umber is the num
-00020700: 6265 7220 6f66 2074 6f74 616c 2072 6570  ber of total rep
-00020710: 6c69 6361 732e 2057 650a 2320 6772 6570  licas. We.# grep
-00020720: 2073 7563 6820 666f 726d 6174 2074 6f20   such format to 
-00020730: 656e 7375 7265 2074 6861 7420 7468 6520  ensure that the 
-00020740: 7365 7276 6963 6520 6973 2072 6561 6479  service is ready
-00020750: 2c20 616e 6420 6561 726c 7920 6578 6974  , and early exit
-00020760: 2069 6620 616e 790a 2320 6661 696c 7572   if any.# failur
-00020770: 6520 6465 7465 6374 6564 2e20 496e 2074  e detected. In t
-00020780: 6865 2065 6e64 2077 6520 736c 6565 7020  he end we sleep 
-00020790: 666f 720a 2320 7365 7276 652e 4c42 5f43  for.# serve.LB_C
-000207a0: 4f4e 5452 4f4c 4c45 525f 5359 4e43 5f49  ONTROLLER_SYNC_I
-000207b0: 4e54 4552 5641 4c5f 5345 434f 4e44 5320  NTERVAL_SECONDS 
-000207c0: 746f 206d 616b 6520 7375 7265 206c 6f61  to make sure loa
-000207d0: 6420 6261 6c61 6e63 6572 2068 6176 650a  d balancer have.
-000207e0: 2320 656e 6f75 6768 2074 696d 6520 746f  # enough time to
-000207f0: 2073 796e 6320 7769 7468 2074 6865 2063   sync with the c
-00020800: 6f6e 7472 6f6c 6c65 7220 616e 6420 6765  ontroller and ge
-00020810: 7420 616c 6c20 7265 6164 7920 7265 706c  t all ready repl
-00020820: 6963 6120 4950 732e 0a5f 5345 5256 455f  ica IPs.._SERVE_
-00020830: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
-00020840: 203d 2028 0a20 2020 2027 7b7b 2077 6869   = (.    '{{ whi
-00020850: 6c65 2074 7275 653b 2064 6f27 0a20 2020  le true; do'.   
-00020860: 2027 2020 2020 2073 3d24 2873 6b79 2073   '     s=$(sky s
-00020870: 6572 7665 2073 7461 7475 7320 7b6e 616d  erve status {nam
-00020880: 657d 293b 2065 6368 6f20 2224 7322 3b27  e}); echo "$s";'
-00020890: 0a20 2020 2027 2020 2020 2065 6368 6f20  .    '     echo 
-000208a0: 2224 7322 207c 2067 7265 7020 2d71 2022  "$s" | grep -q "
-000208b0: 7b72 6570 6c69 6361 5f6e 756d 7d2f 7b72  {replica_num}/{r
-000208c0: 6570 6c69 6361 5f6e 756d 7d22 2026 2620  eplica_num}" && 
-000208d0: 6272 6561 6b3b 270a 2020 2020 2720 2020  break;'.    '   
-000208e0: 2020 6563 686f 2022 2473 2220 7c20 6772    echo "$s" | gr
-000208f0: 6570 202d 7120 2246 4149 4c45 4422 2026  ep -q "FAILED" &
-00020900: 2620 6578 6974 2031 3b27 0a20 2020 2027  & exit 1;'.    '
-00020910: 2020 2020 2073 6c65 6570 2031 303b 270a       sleep 10;'.
-00020920: 2020 2020 2720 646f 6e65 3b20 7d7d 3b20      ' done; }}; 
-00020930: 6563 686f 2022 476f 7420 7365 7276 6963  echo "Got servic
-00020940: 6520 7374 6174 7573 2024 7322 3b27 0a20  e status $s";'. 
-00020950: 2020 2066 2773 6c65 6570 207b 7365 7276     f'sleep {serv
-00020960: 652e 4c42 5f43 4f4e 5452 4f4c 4c45 525f  e.LB_CONTROLLER_
-00020970: 5359 4e43 5f49 4e54 4552 5641 4c5f 5345  SYNC_INTERVAL_SE
-00020980: 434f 4e44 5320 2b20 327d 3b27 290a 5f49  CONDS + 2};')._I
-00020990: 505f 5245 4745 5820 3d20 7227 285b 302d  P_REGEX = r'([0-
-000209a0: 395d 7b31 2c33 7d5c 2e29 7b33 7d5b 302d  9]{1,3}\.){3}[0-
-000209b0: 395d 7b31 2c33 7d27 0a5f 4157 4b5f 414c  9]{1,3}'._AWK_AL
-000209c0: 4c5f 4c49 4e45 535f 4245 4c4f 575f 5245  L_LINES_BELOW_RE
-000209d0: 504c 4943 4153 203d 2072 272f 5265 706c  PLICAS = r'/Repl
-000209e0: 6963 6173 2f7b 666c 6167 3d31 3b20 6e65  icas/{flag=1; ne
-000209f0: 7874 7d20 666c 6167 270a 5f53 4552 5649  xt} flag'._SERVI
-00020a00: 4345 5f4c 4155 4e43 4849 4e47 5f53 5441  CE_LAUNCHING_STA
-00020a10: 5455 535f 5245 4745 5820 3d20 2750 524f  TUS_REGEX = 'PRO
-00020a20: 5649 5349 4f4e 494e 475c 7c53 5441 5254  VISIONING\|START
-00020a30: 494e 4727 0a23 2053 696e 6365 2077 6520  ING'.# Since we 
-00020a40: 646f 6e27 7420 616c 6c6f 7720 7465 726d  don't allow term
-00020a50: 696e 6174 6520 7468 6520 7365 7276 6963  inate the servic
-00020a60: 6520 6966 2074 6865 2063 6f6e 7472 6f6c  e if the control
-00020a70: 6c65 7220 6973 2049 4e49 542c 0a23 2077  ler is INIT,.# w
-00020a80: 6869 6368 2069 7320 636f 6d6d 6f6e 2066  hich is common f
-00020a90: 6f72 2073 696d 756c 7461 6e65 6f75 7320  or simultaneous 
-00020aa0: 7079 7465 7374 2c20 7765 206e 6565 6420  pytest, we need 
-00020ab0: 746f 2077 6169 7420 756e 7469 6c20 7468  to wait until th
-00020ac0: 650a 2320 636f 6e74 726f 6c6c 6572 2069  e.# controller i
-00020ad0: 7320 5550 2062 6566 6f72 6520 7765 2063  s UP before we c
-00020ae0: 616e 2074 6572 6d69 6e61 7465 2074 6865  an terminate the
-00020af0: 2073 6572 7669 6365 2e0a 2320 5468 6520   service..# The 
-00020b00: 7465 6172 646f 776e 2063 6f6d 6d61 6e64  teardown command
-00020b10: 2068 6173 2061 2031 302d 6d69 6e73 2074   has a 10-mins t
-00020b20: 696d 656f 7574 2c20 736f 2077 6520 646f  imeout, so we do
-00020b30: 6e27 7420 6e65 6564 2074 6f20 646f 0a23  n't need to do.#
-00020b40: 2074 6865 2074 696d 656f 7574 2068 6572   the timeout her
-00020b50: 652e 2053 6565 2069 6d70 6c65 6d65 6e74  e. See implement
-00020b60: 6174 696f 6e20 6f66 2072 756e 5f6f 6e65  ation of run_one
-00020b70: 5f74 6573 7428 2920 666f 7220 6465 7461  _test() for deta
-00020b80: 696c 732e 0a5f 5445 4152 444f 574e 5f53  ils.._TEARDOWN_S
-00020b90: 4552 5649 4345 203d 2028 0a20 2020 2027  ERVICE = (.    '
-00020ba0: 2866 6f72 2069 2069 6e20 6073 6571 2031  (for i in `seq 1
-00020bb0: 2032 3060 3b20 646f 270a 2020 2020 2720   20`; do'.    ' 
-00020bc0: 2020 2020 733d 2428 736b 7920 7365 7276      s=$(sky serv
-00020bd0: 6520 646f 776e 202d 7920 7b6e 616d 657d  e down -y {name}
-00020be0: 293b 270a 2020 2020 2720 2020 2020 6563  );'.    '     ec
-00020bf0: 686f 2022 5472 7969 6e67 2074 6f20 7465  ho "Trying to te
-00020c00: 726d 696e 6174 6520 7b6e 616d 657d 223b  rminate {name}";
-00020c10: 270a 2020 2020 2720 2020 2020 6563 686f  '.    '     echo
-00020c20: 2022 2473 223b 270a 2020 2020 2720 2020   "$s";'.    '   
-00020c30: 2020 6563 686f 2022 2473 2220 7c20 6772    echo "$s" | gr
-00020c40: 6570 202d 7120 2273 6368 6564 756c 6564  ep -q "scheduled
-00020c50: 2074 6f20 6265 2074 6572 6d69 6e61 7465   to be terminate
-00020c60: 645c 7c4e 6f20 7365 7276 6963 6520 746f  d\|No service to
-00020c70: 2074 6572 6d69 6e61 7465 2220 2626 2062   terminate" && b
-00020c80: 7265 616b 3b27 0a20 2020 2027 2020 2020  reak;'.    '    
-00020c90: 2073 6c65 6570 2031 303b 270a 2020 2020   sleep 10;'.    
-00020ca0: 2720 2020 2020 5b20 2469 202d 6571 2032  '     [ $i -eq 2
-00020cb0: 3020 5d20 2626 2065 6368 6f20 2246 6169  0 ] && echo "Fai
-00020cc0: 6c65 6420 746f 2074 6572 6d69 6e61 7465  led to terminate
-00020cd0: 2073 6572 7669 6365 207b 6e61 6d65 7d22   service {name}"
-00020ce0: 3b27 0a20 2020 2027 646f 6e65 2927 290a  ;'.    'done)').
-00020cf0: 0a5f 5345 5256 455f 454e 4450 4f49 4e54  ._SERVE_ENDPOINT
-00020d00: 5f57 4149 5420 3d20 280a 2020 2020 2765  _WAIT = (.    'e
-00020d10: 7870 6f72 7420 4f52 4947 494e 5f53 4b59  xport ORIGIN_SKY
-00020d20: 5049 4c4f 545f 4445 4255 473d 2453 4b59  PILOT_DEBUG=$SKY
-00020d30: 5049 4c4f 545f 4445 4255 473b 2065 7870  PILOT_DEBUG; exp
-00020d40: 6f72 7420 534b 5950 494c 4f54 5f44 4542  ort SKYPILOT_DEB
-00020d50: 5547 3d30 3b20 270a 2020 2020 2765 6e64  UG=0; '.    'end
-00020d60: 706f 696e 743d 2428 736b 7920 7365 7276  point=$(sky serv
-00020d70: 6520 7374 6174 7573 202d 2d65 6e64 706f  e status --endpo
-00020d80: 696e 7420 7b6e 616d 657d 293b 2027 0a20  int {name}); '. 
-00020d90: 2020 2027 756e 7469 6c20 2120 6563 686f     'until ! echo
-00020da0: 2022 2465 6e64 706f 696e 7422 207c 2067   "$endpoint" | g
-00020db0: 7265 7020 2243 6f6e 7472 6f6c 6c65 7220  rep "Controller 
-00020dc0: 6973 2069 6e69 7469 616c 697a 696e 6722  is initializing"
-00020dd0: 3b20 270a 2020 2020 2764 6f20 6563 686f  ; '.    'do echo
-00020de0: 2022 5761 6974 696e 6720 666f 7220 7365   "Waiting for se
-00020df0: 7276 6520 656e 6470 6f69 6e74 2074 6f20  rve endpoint to 
-00020e00: 6265 2072 6561 6479 2e2e 2e22 3b20 270a  be ready..."; '.
-00020e10: 2020 2020 2773 6c65 6570 2035 3b20 656e      'sleep 5; en
-00020e20: 6470 6f69 6e74 3d24 2873 6b79 2073 6572  dpoint=$(sky ser
-00020e30: 7665 2073 7461 7475 7320 2d2d 656e 6470  ve status --endp
-00020e40: 6f69 6e74 207b 6e61 6d65 7d29 3b20 646f  oint {name}); do
-00020e50: 6e65 3b20 270a 2020 2020 2765 7870 6f72  ne; '.    'expor
-00020e60: 7420 534b 5950 494c 4f54 5f44 4542 5547  t SKYPILOT_DEBUG
-00020e70: 3d24 4f52 4947 494e 5f53 4b59 5049 4c4f  =$ORIGIN_SKYPILO
-00020e80: 545f 4445 4255 473b 2065 6368 6f20 2224  T_DEBUG; echo "$
-00020e90: 656e 6470 6f69 6e74 2227 290a 0a5f 5345  endpoint"').._SE
-00020ea0: 5256 455f 5354 4154 5553 5f57 4149 5420  RVE_STATUS_WAIT 
-00020eb0: 3d20 2827 733d 2428 736b 7920 7365 7276  = ('s=$(sky serv
-00020ec0: 6520 7374 6174 7573 207b 6e61 6d65 7d29  e status {name})
-00020ed0: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-00020ee0: 2020 2020 2020 2020 2020 2775 6e74 696c            'until
-00020ef0: 2021 2065 6368 6f20 2224 7322 207c 2067   ! echo "$s" | g
-00020f00: 7265 7020 2243 6f6e 7472 6f6c 6c65 7220  rep "Controller 
-00020f10: 6973 2069 6e69 7469 616c 697a 696e 672e  is initializing.
-00020f20: 223b 2027 0a20 2020 2020 2020 2020 2020  "; '.           
-00020f30: 2020 2020 2020 2020 2020 2027 646f 2065             'do e
-00020f40: 6368 6f20 2257 6169 7469 6e67 2066 6f72  cho "Waiting for
-00020f50: 2073 6572 7665 2073 7461 7475 7320 746f   serve status to
-00020f60: 2062 6520 7265 6164 792e 2e2e 223b 2027   be ready..."; '
-00020f70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020f80: 2020 2020 2020 2027 736c 6565 7020 353b         'sleep 5;
-00020f90: 2073 3d24 2873 6b79 2073 6572 7665 2073   s=$(sky serve s
-00020fa0: 7461 7475 7320 7b6e 616d 657d 293b 2064  tatus {name}); d
-00020fb0: 6f6e 653b 2065 6368 6f20 2224 7322 2729  one; echo "$s"')
-00020fc0: 0a0a 0a64 6566 205f 6765 745f 7265 706c  ...def _get_repl
-00020fd0: 6963 615f 6970 286e 616d 653a 2073 7472  ica_ip(name: str
-00020fe0: 2c20 7265 706c 6963 615f 6964 3a20 696e  , replica_id: in
-00020ff0: 7429 202d 3e20 7374 723a 0a20 2020 2072  t) -> str:.    r
-00021000: 6574 7572 6e20 2866 2769 707b 7265 706c  eturn (f'ip{repl
-00021010: 6963 615f 6964 7d3d 2428 6563 686f 2022  ica_id}=$(echo "
-00021020: 2473 2220 7c20 270a 2020 2020 2020 2020  $s" | '.        
-00021030: 2020 2020 6627 6177 6b20 227b 5f41 574b      f'awk "{_AWK
-00021040: 5f41 4c4c 5f4c 494e 4553 5f42 454c 4f57  _ALL_LINES_BELOW
-00021050: 5f52 4550 4c49 4341 537d 2220 7c20 270a  _REPLICAS}" | '.
-00021060: 2020 2020 2020 2020 2020 2020 6627 6772              f'gr
-00021070: 6570 202d 4520 227b 6e61 6d65 7d5c 732b  ep -E "{name}\s+
-00021080: 7b72 6570 6c69 6361 5f69 647d 2220 7c20  {replica_id}" | 
-00021090: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
-000210a0: 6772 6570 202d 456f 2022 7b5f 4950 5f52  grep -Eo "{_IP_R
-000210b0: 4547 4558 7d22 2927 290a 0a0a 6465 6620  EGEX}")')...def 
-000210c0: 5f67 6574 5f73 6b79 7365 7276 655f 6874  _get_skyserve_ht
-000210d0: 7470 5f74 6573 7428 6e61 6d65 3a20 7374  tp_test(name: st
-000210e0: 722c 2063 6c6f 7564 3a20 7374 722c 0a20  r, cloud: str,. 
-000210f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021100: 2020 2020 2020 2020 2020 2074 696d 656f             timeo
-00021110: 7574 5f6d 696e 7574 6573 3a20 696e 7429  ut_minutes: int)
-00021120: 202d 3e20 5465 7374 3a0a 2020 2020 7465   -> Test:.    te
-00021130: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00021140: 2020 2066 2774 6573 742d 736b 7973 6572     f'test-skyser
-00021150: 7665 2d7b 636c 6f75 642e 7265 706c 6163  ve-{cloud.replac
-00021160: 6528 225f 222c 2022 2d22 297d 272c 0a20  e("_", "-")}',. 
-00021170: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00021180: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
-00021190: 2075 7020 2d6e 207b 6e61 6d65 7d20 2d79   up -n {name} -y
-000211a0: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
-000211b0: 6874 7470 2f7b 636c 6f75 647d 2e79 616d  http/{cloud}.yam
-000211c0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-000211d0: 5f53 4552 5645 5f57 4149 545f 554e 5449  _SERVE_WAIT_UNTI
-000211e0: 4c5f 5245 4144 592e 666f 726d 6174 286e  L_READY.format(n
-000211f0: 616d 653d 6e61 6d65 2c20 7265 706c 6963  ame=name, replic
-00021200: 615f 6e75 6d3d 3229 2c0a 2020 2020 2020  a_num=2),.      
-00021210: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
-00021220: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
-00021230: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
-00021240: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-00021250: 2763 7572 6c20 2d4c 2068 7474 703a 2f2f  'curl -L http://
-00021260: 2465 6e64 706f 696e 7420 7c20 6772 6570  $endpoint | grep
-00021270: 2022 4869 2c20 536b 7950 696c 6f74 2068   "Hi, SkyPilot h
-00021280: 6572 6522 272c 0a20 2020 2020 2020 205d  ere"',.        ]
-00021290: 2c0a 2020 2020 2020 2020 5f54 4541 5244  ,.        _TEARD
-000212a0: 4f57 4e5f 5345 5256 4943 452e 666f 726d  OWN_SERVICE.form
-000212b0: 6174 286e 616d 653d 6e61 6d65 292c 0a20  at(name=name),. 
-000212c0: 2020 2020 2020 2074 696d 656f 7574 3d74         timeout=t
-000212d0: 696d 656f 7574 5f6d 696e 7574 6573 202a  imeout_minutes *
-000212e0: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
-000212f0: 6574 7572 6e20 7465 7374 0a0a 0a64 6566  eturn test...def
-00021300: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
-00021310: 696e 5f73 7461 7475 7328 6e61 6d65 3a20  in_status(name: 
-00021320: 7374 722c 2063 6865 636b 5f74 7570 6c65  str, check_tuple
-00021330: 733a 204c 6973 745b 5475 706c 655b 696e  s: List[Tuple[in
-00021340: 742c 2062 6f6f 6c2c 0a20 2020 2020 2020  t, bool,.       
-00021350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021380: 2020 2020 2020 2020 2020 7374 725d 5d29            str]])
-00021390: 202d 3e20 7374 723a 0a20 2020 2022 2222   -> str:.    """
-000213a0: 4368 6563 6b20 7265 706c 6963 6173 2720  Check replicas' 
-000213b0: 7374 6174 7573 2061 6e64 2063 6f75 6e74  status and count
-000213c0: 2069 6e20 736b 7920 7365 7276 6520 7374   in sky serve st
-000213d0: 6174 7573 0a0a 2020 2020 5765 2077 696c  atus..    We wil
-000213e0: 6c20 6368 6563 6b20 7643 5055 3d32 2c20  l check vCPU=2, 
-000213f0: 6173 2061 6c6c 206f 7572 2074 6573 7473  as all our tests
-00021400: 2075 7365 2076 4350 553d 322e 0a20 2020   use vCPU=2..   
-00021410: 200a 2020 2020 4172 6773 3a0a 2020 2020   .    Args:.    
-00021420: 2020 2020 6e61 6d65 3a20 7468 6520 6e61      name: the na
-00021430: 6d65 206f 6620 7468 6520 7365 7276 6963  me of the servic
-00021440: 650a 2020 2020 2020 2020 6368 6563 6b5f  e.        check_
-00021450: 7475 706c 6573 3a20 4120 6c69 7374 206f  tuples: A list o
-00021460: 6620 7265 706c 6963 6120 7072 6f70 6572  f replica proper
-00021470: 7479 2074 6f20 6368 6563 6b2e 2045 6163  ty to check. Eac
-00021480: 6820 7475 706c 6520 6973 0a20 2020 2020  h tuple is.     
-00021490: 2020 2020 2020 2028 636f 756e 742c 2069         (count, i
-000214a0: 735f 7370 6f74 2c20 7374 6174 7573 290a  s_spot, status).
-000214b0: 2020 2020 2222 220a 2020 2020 6368 6563      """.    chec
-000214c0: 6b5f 636d 6420 3d20 2727 0a20 2020 2066  k_cmd = ''.    f
-000214d0: 6f72 2063 6865 636b 5f74 7570 6c65 2069  or check_tuple i
-000214e0: 6e20 6368 6563 6b5f 7475 706c 6573 3a0a  n check_tuples:.
-000214f0: 2020 2020 2020 2020 636f 756e 742c 2069          count, i
-00021500: 735f 7370 6f74 2c20 7374 6174 7573 203d  s_spot, status =
-00021510: 2063 6865 636b 5f74 7570 6c65 0a20 2020   check_tuple.   
-00021520: 2020 2020 2072 6573 6f75 7263 655f 7374       resource_st
-00021530: 7220 3d20 2727 0a20 2020 2020 2020 2069  r = ''.        i
-00021540: 6620 7374 6174 7573 206e 6f74 2069 6e20  f status not in 
-00021550: 5b27 5045 4e44 494e 4727 2c20 2753 4855  ['PENDING', 'SHU
-00021560: 5454 494e 475f 444f 574e 270a 2020 2020  TTING_DOWN'.    
-00021570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021580: 2020 2020 205d 2061 6e64 206e 6f74 2073       ] and not s
-00021590: 7461 7475 732e 7374 6172 7473 7769 7468  tatus.startswith
-000215a0: 2827 4641 494c 4544 2729 3a0a 2020 2020  ('FAILED'):.    
-000215b0: 2020 2020 2020 2020 7370 6f74 5f73 7472          spot_str
-000215c0: 203d 2027 270a 2020 2020 2020 2020 2020   = ''.          
-000215d0: 2020 6966 2069 735f 7370 6f74 3a0a 2020    if is_spot:.  
-000215e0: 2020 2020 2020 2020 2020 2020 2020 7370                sp
-000215f0: 6f74 5f73 7472 203d 2027 5c5b 5370 6f74  ot_str = '\[Spot
-00021600: 5c5d 270a 2020 2020 2020 2020 2020 2020  \]'.            
-00021610: 7265 736f 7572 6365 5f73 7472 203d 2066  resource_str = f
-00021620: 2728 7b73 706f 745f 7374 727d 7643 5055  '({spot_str}vCPU
-00021630: 3d32 2927 0a20 2020 2020 2020 2063 6865  =2)'.        che
-00021640: 636b 5f63 6d64 202b 3d20 2866 2720 6563  ck_cmd += (f' ec
-00021650: 686f 2022 2473 2220 7c20 6772 6570 2022  ho "$s" | grep "
-00021660: 7b72 6573 6f75 7263 655f 7374 727d 2220  {resource_str}" 
-00021670: 7c20 270a 2020 2020 2020 2020 2020 2020  | '.            
-00021680: 2020 2020 2020 2020 2020 6627 6772 6570            f'grep
-00021690: 2022 7b73 7461 7475 737d 2220 7c20 7763   "{status}" | wc
-000216a0: 202d 6c20 7c20 6772 6570 207b 636f 756e   -l | grep {coun
-000216b0: 747d 207c 7c20 6578 6974 2031 3b27 290a  t} || exit 1;').
-000216c0: 2020 2020 7265 7475 726e 2028 6627 7b5f      return (f'{_
-000216d0: 5345 5256 455f 5354 4154 5553 5f57 4149  SERVE_STATUS_WAI
-000216e0: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
-000216f0: 6d65 297d 3b20 6563 686f 2022 2473 223b  me)}; echo "$s";
-00021700: 2027 202b 2063 6865 636b 5f63 6d64 290a   ' + check_cmd).
-00021710: 0a0a 6465 6620 5f63 6865 636b 5f73 6572  ..def _check_ser
-00021720: 7669 6365 5f76 6572 7369 6f6e 2873 6572  vice_version(ser
-00021730: 7669 6365 5f6e 616d 653a 2073 7472 2c20  vice_name: str, 
-00021740: 7665 7273 696f 6e3a 2073 7472 2920 2d3e  version: str) ->
-00021750: 2073 7472 3a0a 2020 2020 2320 4772 6570   str:.    # Grep
-00021760: 2074 6865 206c 696e 6573 2062 6566 6f72   the lines befor
-00021770: 6520 2753 6572 7669 6365 2052 6570 6c69  e 'Service Repli
-00021780: 6361 7327 2061 6e64 2063 6865 636b 2069  cas' and check i
-00021790: 6620 7468 6520 7365 7276 6963 6520 7665  f the service ve
-000217a0: 7273 696f 6e0a 2020 2020 2320 6973 2063  rsion.    # is c
-000217b0: 6f72 7265 6374 2e0a 2020 2020 7265 7475  orrect..    retu
-000217c0: 726e 2028 6627 6563 686f 2022 2473 2220  rn (f'echo "$s" 
-000217d0: 7c20 6772 6570 202d 4231 3030 3020 2253  | grep -B1000 "S
-000217e0: 6572 7669 6365 2052 6570 6c69 6361 7322  ervice Replicas"
-000217f0: 207c 2027 0a20 2020 2020 2020 2020 2020   | '.           
-00021800: 2066 2767 7265 7020 2d45 2022 7b73 6572   f'grep -E "{ser
-00021810: 7669 6365 5f6e 616d 657d 5c73 2b7b 7665  vice_name}\s+{ve
-00021820: 7273 696f 6e7d 2220 7c7c 2065 7869 7420  rsion}" || exit 
-00021830: 313b 2027 290a 0a0a 4070 7974 6573 742e  1; ')...@pytest.
-00021840: 6d61 726b 2e67 6370 0a40 7079 7465 7374  mark.gcp.@pytest
-00021850: 2e6d 6172 6b2e 7365 7276 650a 6465 6620  .mark.serve.def 
-00021860: 7465 7374 5f73 6b79 7365 7276 655f 6763  test_skyserve_gc
-00021870: 705f 6874 7470 2829 3a0a 2020 2020 2222  p_http():.    ""
-00021880: 2254 6573 7420 736b 7973 6572 7665 206f  "Test skyserve o
-00021890: 6e20 4743 5022 2222 0a20 2020 206e 616d  n GCP""".    nam
-000218a0: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
-000218b0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-000218c0: 203d 205f 6765 745f 736b 7973 6572 7665   = _get_skyserve
-000218d0: 5f68 7474 705f 7465 7374 286e 616d 652c  _http_test(name,
-000218e0: 2027 6763 7027 2c20 3230 290a 2020 2020   'gcp', 20).    
-000218f0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00021900: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00021910: 6b2e 6177 730a 4070 7974 6573 742e 6d61  k.aws.@pytest.ma
-00021920: 726b 2e73 6572 7665 0a64 6566 2074 6573  rk.serve.def tes
-00021930: 745f 736b 7973 6572 7665 5f61 7773 5f68  t_skyserve_aws_h
-00021940: 7474 7028 293a 0a20 2020 2022 2222 5465  ttp():.    """Te
-00021950: 7374 2073 6b79 7365 7276 6520 6f6e 2041  st skyserve on A
-00021960: 5753 2222 220a 2020 2020 6e61 6d65 203d  WS""".    name =
-00021970: 205f 6765 745f 7365 7276 6963 655f 6e61   _get_service_na
-00021980: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-00021990: 5f67 6574 5f73 6b79 7365 7276 655f 6874  _get_skyserve_ht
-000219a0: 7470 5f74 6573 7428 6e61 6d65 2c20 2761  tp_test(name, 'a
-000219b0: 7773 272c 2032 3029 0a20 2020 2072 756e  ws', 20).    run
-000219c0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-000219d0: 0a0a 4070 7974 6573 742e 6d61 726b 2e61  ..@pytest.mark.a
-000219e0: 7a75 7265 0a40 7079 7465 7374 2e6d 6172  zure.@pytest.mar
-000219f0: 6b2e 7365 7276 650a 6465 6620 7465 7374  k.serve.def test
-00021a00: 5f73 6b79 7365 7276 655f 617a 7572 655f  _skyserve_azure_
-00021a10: 6874 7470 2829 3a0a 2020 2020 2222 2254  http():.    """T
-00021a20: 6573 7420 736b 7973 6572 7665 206f 6e20  est skyserve on 
-00021a30: 417a 7572 6522 2222 0a20 2020 206e 616d  Azure""".    nam
-00021a40: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
-00021a50: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00021a60: 203d 205f 6765 745f 736b 7973 6572 7665   = _get_skyserve
-00021a70: 5f68 7474 705f 7465 7374 286e 616d 652c  _http_test(name,
-00021a80: 2027 617a 7572 6527 2c20 3330 290a 2020   'azure', 30).  
-00021a90: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00021aa0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-00021ab0: 6172 6b2e 7365 7276 650a 4070 7974 6573  ark.serve.@pytes
-00021ac0: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
-00021ad0: 6574 6573 0a64 6566 2074 6573 745f 736b  etes.def test_sk
-00021ae0: 7973 6572 7665 5f6c 6c6d 2867 656e 6572  yserve_llm(gener
-00021af0: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
-00021b00: 2020 2020 2222 2254 6573 7420 736b 7973      """Test skys
-00021b10: 6572 7665 2077 6974 6820 7265 616c 204c  erve with real L
-00021b20: 4c4d 2075 7365 6361 7365 2222 220a 2020  LM usecase""".  
-00021b30: 2020 6e61 6d65 203d 205f 6765 745f 7365    name = _get_se
-00021b40: 7276 6963 655f 6e61 6d65 2829 0a0a 2020  rvice_name()..  
-00021b50: 2020 6465 6620 6765 6e65 7261 7465 5f6c    def generate_l
-00021b60: 6c6d 5f74 6573 745f 636f 6d6d 616e 6428  lm_test_command(
-00021b70: 7072 6f6d 7074 3a20 7374 722c 2065 7870  prompt: str, exp
-00021b80: 6563 7465 645f 6f75 7470 7574 3a20 7374  ected_output: st
-00021b90: 7229 202d 3e20 7374 723a 0a20 2020 2020  r) -> str:.     
-00021ba0: 2020 2070 726f 6d70 7420 3d20 7368 6c65     prompt = shle
-00021bb0: 782e 7175 6f74 6528 7072 6f6d 7074 290a  x.quote(prompt).
-00021bc0: 2020 2020 2020 2020 6578 7065 6374 6564          expected
-00021bd0: 5f6f 7574 7075 7420 3d20 7368 6c65 782e  _output = shlex.
-00021be0: 7175 6f74 6528 6578 7065 6374 6564 5f6f  quote(expected_o
-00021bf0: 7574 7075 7429 0a20 2020 2020 2020 2072  utput).        r
-00021c00: 6574 7572 6e20 280a 2020 2020 2020 2020  eturn (.        
-00021c10: 2020 2020 6627 7b5f 5345 5256 455f 454e      f'{_SERVE_EN
-00021c20: 4450 4f49 4e54 5f57 4149 542e 666f 726d  DPOINT_WAIT.form
-00021c30: 6174 286e 616d 653d 6e61 6d65 297d 3b20  at(name=name)}; 
-00021c40: 270a 2020 2020 2020 2020 2020 2020 2770  '.            'p
-00021c50: 7974 686f 6e20 7465 7374 732f 736b 7973  ython tests/skys
-00021c60: 6572 7665 2f6c 6c6d 2f67 6574 5f72 6573  erve/llm/get_res
-00021c70: 706f 6e73 652e 7079 202d 2d65 6e64 706f  ponse.py --endpo
-00021c80: 696e 7420 2465 6e64 706f 696e 7420 270a  int $endpoint '.
-00021c90: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
-00021ca0: 7072 6f6d 7074 207b 7072 6f6d 7074 7d20  prompt {prompt} 
-00021cb0: 7c20 6772 6570 207b 6578 7065 6374 6564  | grep {expected
-00021cc0: 5f6f 7574 7075 747d 2729 0a0a 2020 2020  _output}')..    
-00021cd0: 7769 7468 206f 7065 6e28 2774 6573 7473  with open('tests
-00021ce0: 2f73 6b79 7365 7276 652f 6c6c 6d2f 7072  /skyserve/llm/pr
-00021cf0: 6f6d 7074 5f6f 7574 7075 742e 6a73 6f6e  ompt_output.json
-00021d00: 272c 2027 7227 2c0a 2020 2020 2020 2020  ', 'r',.        
-00021d10: 2020 2020 2020 656e 636f 6469 6e67 3d27        encoding='
-00021d20: 7574 662d 3827 2920 6173 2066 3a0a 2020  utf-8') as f:.  
-00021d30: 2020 2020 2020 7072 6f6d 7074 326f 7574        prompt2out
-00021d40: 7075 7420 3d20 6a73 6f6e 2e6c 6f61 6428  put = json.load(
-00021d50: 6629 0a0a 2020 2020 7465 7374 203d 2054  f)..    test = T
-00021d60: 6573 7428 0a20 2020 2020 2020 2066 2774  est(.        f't
-00021d70: 6573 742d 736b 7973 6572 7665 2d6c 6c6d  est-skyserve-llm
-00021d80: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-00021d90: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-00021da0: 6572 7665 2075 7020 2d6e 207b 6e61 6d65  erve up -n {name
-00021db0: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
-00021dc0: 6963 5f63 6c6f 7564 7d20 2d79 2074 6573  ic_cloud} -y tes
-00021dd0: 7473 2f73 6b79 7365 7276 652f 6c6c 6d2f  ts/skyserve/llm/
-00021de0: 7365 7276 6963 652e 7961 6d6c 272c 0a20  service.yaml',. 
-00021df0: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
-00021e00: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
-00021e10: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
-00021e20: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
-00021e30: 3d31 292c 0a20 2020 2020 2020 2020 2020  =1),.           
-00021e40: 202a 5b0a 2020 2020 2020 2020 2020 2020   *[.            
-00021e50: 2020 2020 6765 6e65 7261 7465 5f6c 6c6d      generate_llm
-00021e60: 5f74 6573 745f 636f 6d6d 616e 6428 7072  _test_command(pr
-00021e70: 6f6d 7074 2c20 6f75 7470 7574 290a 2020  ompt, output).  
-00021e80: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00021e90: 7220 7072 6f6d 7074 2c20 6f75 7470 7574  r prompt, output
-00021ea0: 2069 6e20 7072 6f6d 7074 326f 7574 7075   in prompt2outpu
-00021eb0: 742e 6974 656d 7328 290a 2020 2020 2020  t.items().      
-00021ec0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00021ed0: 205d 2c0a 2020 2020 2020 2020 5f54 4541   ],.        _TEA
-00021ee0: 5244 4f57 4e5f 5345 5256 4943 452e 666f  RDOWN_SERVICE.fo
-00021ef0: 726d 6174 286e 616d 653d 6e61 6d65 292c  rmat(name=name),
-00021f00: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-00021f10: 3d32 3520 2a20 3630 2c0a 2020 2020 290a  =25 * 60,.    ).
-00021f20: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00021f30: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-00021f40: 2e6d 6172 6b2e 6763 700a 4070 7974 6573  .mark.gcp.@pytes
-00021f50: 742e 6d61 726b 2e73 6572 7665 0a64 6566  t.mark.serve.def
-00021f60: 2074 6573 745f 736b 7973 6572 7665 5f73   test_skyserve_s
-00021f70: 706f 745f 7265 636f 7665 7279 2829 3a0a  pot_recovery():.
-00021f80: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00021f90: 7365 7276 6963 655f 6e61 6d65 2829 0a20  service_name(). 
-00021fa0: 2020 207a 6f6e 6520 3d20 2775 732d 6365     zone = 'us-ce
-00021fb0: 6e74 7261 6c31 2d61 270a 0a20 2020 2074  ntral1-a'..    t
-00021fc0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-00021fd0: 2020 2020 6627 7465 7374 2d73 6b79 7365      f'test-skyse
-00021fe0: 7276 652d 7370 6f74 2d72 6563 6f76 6572  rve-spot-recover
-00021ff0: 792d 6763 7027 2c0a 2020 2020 2020 2020  y-gcp',.        
-00022000: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-00022010: 736b 7920 7365 7276 6520 7570 202d 6e20  sky serve up -n 
-00022020: 7b6e 616d 657d 202d 7920 7465 7374 732f  {name} -y tests/
-00022030: 736b 7973 6572 7665 2f73 706f 742f 7265  skyserve/spot/re
-00022040: 636f 7665 7279 2e79 616d 6c27 2c0a 2020  covery.yaml',.  
-00022050: 2020 2020 2020 2020 2020 5f53 4552 5645            _SERVE
-00022060: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
-00022070: 592e 666f 726d 6174 286e 616d 653d 6e61  Y.format(name=na
-00022080: 6d65 2c20 7265 706c 6963 615f 6e75 6d3d  me, replica_num=
-00022090: 3129 2c0a 2020 2020 2020 2020 2020 2020  1),.            
-000220a0: 6627 7b5f 5345 5256 455f 454e 4450 4f49  f'{_SERVE_ENDPOI
-000220b0: 4e54 5f57 4149 542e 666f 726d 6174 286e  NT_WAIT.format(n
-000220c0: 616d 653d 6e61 6d65 297d 3b20 270a 2020  ame=name)}; '.  
-000220d0: 2020 2020 2020 2020 2020 2763 7572 6c20            'curl 
-000220e0: 2d4c 2068 7474 703a 2f2f 2465 6e64 706f  -L http://$endpo
-000220f0: 696e 7420 7c20 6772 6570 2022 4869 2c20  int | grep "Hi, 
-00022100: 536b 7950 696c 6f74 2068 6572 6522 272c  SkyPilot here"',
-00022110: 0a20 2020 2020 2020 2020 2020 205f 7465  .            _te
-00022120: 726d 696e 6174 655f 6763 705f 7265 706c  rminate_gcp_repl
-00022130: 6963 6128 6e61 6d65 2c20 7a6f 6e65 2c20  ica(name, zone, 
-00022140: 3129 2c0a 2020 2020 2020 2020 2020 2020  1),.            
-00022150: 5f53 4552 5645 5f57 4149 545f 554e 5449  _SERVE_WAIT_UNTI
-00022160: 4c5f 5245 4144 592e 666f 726d 6174 286e  L_READY.format(n
-00022170: 616d 653d 6e61 6d65 2c20 7265 706c 6963  ame=name, replic
-00022180: 615f 6e75 6d3d 3129 2c0a 2020 2020 2020  a_num=1),.      
-00022190: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
-000221a0: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
-000221b0: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
-000221c0: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-000221d0: 2763 7572 6c20 2d4c 2068 7474 703a 2f2f  'curl -L http://
-000221e0: 2465 6e64 706f 696e 7420 7c20 6772 6570  $endpoint | grep
-000221f0: 2022 4869 2c20 536b 7950 696c 6f74 2068   "Hi, SkyPilot h
-00022200: 6572 6522 272c 0a20 2020 2020 2020 205d  ere"',.        ]
-00022210: 2c0a 2020 2020 2020 2020 5f54 4541 5244  ,.        _TEARD
-00022220: 4f57 4e5f 5345 5256 4943 452e 666f 726d  OWN_SERVICE.form
-00022230: 6174 286e 616d 653d 6e61 6d65 292c 0a20  at(name=name),. 
-00022240: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
-00022250: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
-00022260: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00022270: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-00022280: 6172 6b2e 7365 7276 650a 4070 7974 6573  ark.serve.@pytes
-00022290: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
-000222a0: 6574 6573 0a64 6566 2074 6573 745f 736b  etes.def test_sk
-000222b0: 7973 6572 7665 5f62 6173 655f 6f6e 6465  yserve_base_onde
-000222c0: 6d61 6e64 5f66 616c 6c62 6163 6b28 6765  mand_fallback(ge
-000222d0: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
-000222e0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-000222f0: 6574 5f73 6572 7669 6365 5f6e 616d 6528  et_service_name(
-00022300: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-00022310: 7428 0a20 2020 2020 2020 2066 2774 6573  t(.        f'tes
-00022320: 742d 736b 7973 6572 7665 2d62 6173 652d  t-skyserve-base-
-00022330: 6f6e 6465 6d61 6e64 2d66 616c 6c62 6163  ondemand-fallbac
-00022340: 6b27 2c0a 2020 2020 2020 2020 5b0a 2020  k',.        [.  
-00022350: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00022360: 7365 7276 6520 7570 202d 6e20 7b6e 616d  serve up -n {nam
-00022370: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
-00022380: 7269 635f 636c 6f75 647d 202d 7920 7465  ric_cloud} -y te
-00022390: 7374 732f 736b 7973 6572 7665 2f73 706f  sts/skyserve/spo
-000223a0: 742f 6261 7365 5f6f 6e64 656d 616e 645f  t/base_ondemand_
-000223b0: 6661 6c6c 6261 636b 2e79 616d 6c27 2c0a  fallback.yaml',.
-000223c0: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
-000223d0: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
-000223e0: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
-000223f0: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
-00022400: 6d3d 3229 2c0a 2020 2020 2020 2020 2020  m=2),.          
-00022410: 2020 5f63 6865 636b 5f72 6570 6c69 6361    _check_replica
-00022420: 5f69 6e5f 7374 6174 7573 286e 616d 652c  _in_status(name,
-00022430: 205b 2831 2c20 5472 7565 2c20 2752 4541   [(1, True, 'REA
-00022440: 4459 2729 2c0a 2020 2020 2020 2020 2020  DY'),.          
-00022450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022470: 2020 2831 2c20 4661 6c73 652c 2027 5245    (1, False, 'RE
-00022480: 4144 5927 295d 292c 0a20 2020 2020 2020  ADY')]),.       
-00022490: 205d 2c0a 2020 2020 2020 2020 5f54 4541   ],.        _TEA
-000224a0: 5244 4f57 4e5f 5345 5256 4943 452e 666f  RDOWN_SERVICE.fo
-000224b0: 726d 6174 286e 616d 653d 6e61 6d65 292c  rmat(name=name),
-000224c0: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-000224d0: 3d32 3020 2a20 3630 2c0a 2020 2020 290a  =20 * 60,.    ).
-000224e0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-000224f0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-00022500: 2e6d 6172 6b2e 6763 700a 4070 7974 6573  .mark.gcp.@pytes
-00022510: 742e 6d61 726b 2e73 6572 7665 0a64 6566  t.mark.serve.def
-00022520: 2074 6573 745f 736b 7973 6572 7665 5f64   test_skyserve_d
-00022530: 796e 616d 6963 5f6f 6e64 656d 616e 645f  ynamic_ondemand_
-00022540: 6661 6c6c 6261 636b 2829 3a0a 2020 2020  fallback():.    
-00022550: 6e61 6d65 203d 205f 6765 745f 7365 7276  name = _get_serv
-00022560: 6963 655f 6e61 6d65 2829 0a20 2020 207a  ice_name().    z
-00022570: 6f6e 6520 3d20 2775 732d 6365 6e74 7261  one = 'us-centra
-00022580: 6c31 2d61 270a 0a20 2020 2074 6573 7420  l1-a'..    test 
-00022590: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-000225a0: 6627 7465 7374 2d73 6b79 7365 7276 652d  f'test-skyserve-
-000225b0: 6479 6e61 6d69 632d 6f6e 6465 6d61 6e64  dynamic-ondemand
-000225c0: 2d66 616c 6c62 6163 6b27 2c0a 2020 2020  -fallback',.    
-000225d0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-000225e0: 2020 6627 736b 7920 7365 7276 6520 7570    f'sky serve up
-000225f0: 202d 6e20 7b6e 616d 657d 202d 2d63 6c6f   -n {name} --clo
-00022600: 7564 2067 6370 202d 7920 7465 7374 732f  ud gcp -y tests/
-00022610: 736b 7973 6572 7665 2f73 706f 742f 6479  skyserve/spot/dy
-00022620: 6e61 6d69 635f 6f6e 6465 6d61 6e64 5f66  namic_ondemand_f
-00022630: 616c 6c62 6163 6b2e 7961 6d6c 272c 0a20  allback.yaml',. 
-00022640: 2020 2020 2020 2020 2020 2066 2773 6c65             f'sle
-00022650: 6570 2034 3027 2c0a 2020 2020 2020 2020  ep 40',.        
-00022660: 2020 2020 2320 3220 6f6e 2d64 656d 616e      # 2 on-deman
-00022670: 6420 2870 726f 7669 7369 6f6e 696e 6729  d (provisioning)
-00022680: 202b 2032 2053 706f 7420 2870 726f 7669   + 2 Spot (provi
-00022690: 7369 6f6e 696e 6729 2e0a 2020 2020 2020  sioning)..      
-000226a0: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
-000226b0: 5354 4154 5553 5f57 4149 542e 666f 726d  STATUS_WAIT.form
-000226c0: 6174 286e 616d 653d 6e61 6d65 297d 3b20  at(name=name)}; 
-000226d0: 6563 686f 2022 2473 223b 270a 2020 2020  echo "$s";'.    
-000226e0: 2020 2020 2020 2020 2765 6368 6f20 2224          'echo "$
-000226f0: 7322 207c 2067 7265 7020 2d71 2022 302f  s" | grep -q "0/
-00022700: 3422 207c 7c20 6578 6974 2031 272c 0a20  4" || exit 1',. 
-00022710: 2020 2020 2020 2020 2020 2023 2057 6169             # Wai
-00022720: 7420 666f 7220 7468 6520 7072 6f76 6973  t for the provis
-00022730: 696f 6e69 6e67 2073 7461 7274 730a 2020  ioning starts.  
-00022740: 2020 2020 2020 2020 2020 6627 736c 6565            f'slee
-00022750: 7020 3430 272c 0a20 2020 2020 2020 2020  p 40',.         
-00022760: 2020 205f 6368 6563 6b5f 7265 706c 6963     _check_replic
-00022770: 615f 696e 5f73 7461 7475 7328 6e61 6d65  a_in_status(name
-00022780: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
-00022790: 2020 2020 2832 2c20 5472 7565 2c20 5f53      (2, True, _S
-000227a0: 4552 5649 4345 5f4c 4155 4e43 4849 4e47  ERVICE_LAUNCHING
-000227b0: 5f53 5441 5455 535f 5245 4745 5820 2b20  _STATUS_REGEX + 
-000227c0: 275c 7c52 4541 4459 2729 2c0a 2020 2020  '\|READY'),.    
-000227d0: 2020 2020 2020 2020 2020 2020 2832 2c20              (2, 
-000227e0: 4661 6c73 652c 205f 5345 5256 4943 455f  False, _SERVICE_
-000227f0: 4c41 554e 4348 494e 475f 5354 4154 5553  LAUNCHING_STATUS
-00022800: 5f52 4547 4558 202b 2027 5c7c 5348 5554  _REGEX + '\|SHUT
-00022810: 5449 4e47 5f44 4f57 4e27 290a 2020 2020  TING_DOWN').    
-00022820: 2020 2020 2020 2020 5d29 2c0a 0a20 2020          ]),..   
-00022830: 2020 2020 2020 2020 2023 2057 6169 7420           # Wait 
-00022840: 756e 7469 6c20 3220 7370 6f74 2069 6e73  until 2 spot ins
-00022850: 7461 6e63 6573 2061 7265 2072 6561 6479  tances are ready
-00022860: 2e0a 2020 2020 2020 2020 2020 2020 5f53  ..            _S
-00022870: 4552 5645 5f57 4149 545f 554e 5449 4c5f  ERVE_WAIT_UNTIL_
-00022880: 5245 4144 592e 666f 726d 6174 286e 616d  READY.format(nam
-00022890: 653d 6e61 6d65 2c20 7265 706c 6963 615f  e=name, replica_
-000228a0: 6e75 6d3d 3229 2c0a 2020 2020 2020 2020  num=2),.        
-000228b0: 2020 2020 5f63 6865 636b 5f72 6570 6c69      _check_repli
-000228c0: 6361 5f69 6e5f 7374 6174 7573 286e 616d  ca_in_status(nam
-000228d0: 652c 205b 2832 2c20 5472 7565 2c20 2752  e, [(2, True, 'R
-000228e0: 4541 4459 2729 2c0a 2020 2020 2020 2020  EADY'),.        
-000228f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022910: 2020 2020 2830 2c20 4661 6c73 652c 2027      (0, False, '
-00022920: 2729 5d29 2c0a 2020 2020 2020 2020 2020  ')]),.          
-00022930: 2020 5f74 6572 6d69 6e61 7465 5f67 6370    _terminate_gcp
-00022940: 5f72 6570 6c69 6361 286e 616d 652c 207a  _replica(name, z
-00022950: 6f6e 652c 2031 292c 0a20 2020 2020 2020  one, 1),.       
-00022960: 2020 2020 2066 2773 6c65 6570 2034 3027       f'sleep 40'
-00022970: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00022980: 3120 6f6e 2d64 656d 616e 6420 2870 726f  1 on-demand (pro
-00022990: 7669 7369 6f6e 696e 6729 202b 2031 2053  visioning) + 1 S
-000229a0: 706f 7420 2872 6561 6479 2920 2b20 3120  pot (ready) + 1 
-000229b0: 7370 6f74 2028 7072 6f76 6973 696f 6e69  spot (provisioni
-000229c0: 6e67 292e 0a20 2020 2020 2020 2020 2020  ng)..           
-000229d0: 2066 277b 5f53 4552 5645 5f53 5441 5455   f'{_SERVE_STATU
-000229e0: 535f 5741 4954 2e66 6f72 6d61 7428 6e61  S_WAIT.format(na
-000229f0: 6d65 3d6e 616d 6529 7d3b 2027 0a20 2020  me=name)}; '.   
-00022a00: 2020 2020 2020 2020 2027 6563 686f 2022           'echo "
-00022a10: 2473 2220 7c20 6772 6570 202d 7120 2231  $s" | grep -q "1
-00022a20: 2f33 2227 2c0a 2020 2020 2020 2020 2020  /3"',.          
-00022a30: 2020 5f63 6865 636b 5f72 6570 6c69 6361    _check_replica
-00022a40: 5f69 6e5f 7374 6174 7573 280a 2020 2020  _in_status(.    
-00022a50: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-00022a60: 2c20 5b28 312c 2054 7275 652c 2027 5245  , [(1, True, 'RE
-00022a70: 4144 5927 292c 0a20 2020 2020 2020 2020  ADY'),.         
-00022a80: 2020 2020 2020 2020 2020 2020 2020 2831                (1
-00022a90: 2c20 5472 7565 2c20 5f53 4552 5649 4345  , True, _SERVICE
-00022aa0: 5f4c 4155 4e43 4849 4e47 5f53 5441 5455  _LAUNCHING_STATU
-00022ab0: 535f 5245 4745 5829 2c0a 2020 2020 2020  S_REGEX),.      
-00022ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022ad0: 2028 312c 2046 616c 7365 2c20 5f53 4552   (1, False, _SER
-00022ae0: 5649 4345 5f4c 4155 4e43 4849 4e47 5f53  VICE_LAUNCHING_S
-00022af0: 5441 5455 535f 5245 4745 5829 5d29 2c0a  TATUS_REGEX)]),.
-00022b00: 0a20 2020 2020 2020 2020 2020 2023 2057  .            # W
-00022b10: 6169 7420 756e 7469 6c20 3220 7370 6f74  ait until 2 spot
-00022b20: 2069 6e73 7461 6e63 6573 2061 7265 2072   instances are r
-00022b30: 6561 6479 2e0a 2020 2020 2020 2020 2020  eady..          
-00022b40: 2020 5f53 4552 5645 5f57 4149 545f 554e    _SERVE_WAIT_UN
-00022b50: 5449 4c5f 5245 4144 592e 666f 726d 6174  TIL_READY.format
-00022b60: 286e 616d 653d 6e61 6d65 2c20 7265 706c  (name=name, repl
-00022b70: 6963 615f 6e75 6d3d 3229 2c0a 2020 2020  ica_num=2),.    
-00022b80: 2020 2020 2020 2020 5f63 6865 636b 5f72          _check_r
-00022b90: 6570 6c69 6361 5f69 6e5f 7374 6174 7573  eplica_in_status
-00022ba0: 286e 616d 652c 205b 2832 2c20 5472 7565  (name, [(2, True
-00022bb0: 2c20 2752 4541 4459 2729 2c0a 2020 2020  , 'READY'),.    
-00022bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022be0: 2020 2020 2020 2020 2830 2c20 4661 6c73          (0, Fals
-00022bf0: 652c 2027 2729 5d29 2c0a 2020 2020 2020  e, '')]),.      
-00022c00: 2020 5d2c 0a20 2020 2020 2020 205f 5445    ],.        _TE
-00022c10: 4152 444f 574e 5f53 4552 5649 4345 2e66  ARDOWN_SERVICE.f
-00022c20: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
-00022c30: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-00022c40: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
-00022c50: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00022c60: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00022c70: 742e 6d61 726b 2e73 6572 7665 0a40 7079  t.mark.serve.@py
-00022c80: 7465 7374 2e6d 6172 6b2e 6e6f 5f6b 7562  test.mark.no_kub
-00022c90: 6572 6e65 7465 730a 6465 6620 7465 7374  ernetes.def test
-00022ca0: 5f73 6b79 7365 7276 655f 7573 6572 5f62  _skyserve_user_b
-00022cb0: 7567 5f72 6573 7461 7274 2867 656e 6572  ug_restart(gener
-00022cc0: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
-00022cd0: 2020 2020 2222 2254 6573 7473 2074 6861      """Tests tha
-00022ce0: 7420 7765 2072 6573 7461 7274 2074 6865  t we restart the
-00022cf0: 2073 6572 7669 6365 2061 6674 6572 2075   service after u
-00022d00: 7365 7220 6275 672e 2222 220a 2020 2020  ser bug.""".    
-00022d10: 2320 544f 444f 287a 6877 7529 3a20 7468  # TODO(zhwu): th
-00022d20: 6973 2062 6568 6176 696f 7220 6e65 6564  is behavior need
-00022d30: 7320 736f 6d65 2072 6574 6869 6e6b 696e  s some rethinkin
-00022d40: 672e 0a20 2020 206e 616d 6520 3d20 5f67  g..    name = _g
-00022d50: 6574 5f73 6572 7669 6365 5f6e 616d 6528  et_service_name(
-00022d60: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-00022d70: 7428 0a20 2020 2020 2020 2066 2774 6573  t(.        f'tes
-00022d80: 742d 736b 7973 6572 7665 2d75 7365 722d  t-skyserve-user-
-00022d90: 6275 672d 7265 7374 6172 7427 2c0a 2020  bug-restart',.  
-00022da0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00022db0: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
-00022dc0: 7570 202d 6e20 7b6e 616d 657d 202d 2d63  up -n {name} --c
-00022dd0: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-00022de0: 6f75 647d 202d 7920 7465 7374 732f 736b  oud} -y tests/sk
-00022df0: 7973 6572 7665 2f72 6573 7461 7274 2f75  yserve/restart/u
-00022e00: 7365 725f 6275 672e 7961 6d6c 272c 0a20  ser_bug.yaml',. 
-00022e10: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-00022e20: 2873 6b79 2073 6572 7665 2073 7461 7475  (sky serve statu
-00022e30: 7320 7b6e 616d 657d 293b 2065 6368 6f20  s {name}); echo 
-00022e40: 2224 7322 3b27 0a20 2020 2020 2020 2020  "$s";'.         
-00022e50: 2020 2027 756e 7469 6c20 6563 686f 2022     'until echo "
-00022e60: 2473 2220 7c20 6772 6570 202d 4120 3130  $s" | grep -A 10
-00022e70: 3020 2253 6572 7669 6365 2052 6570 6c69  0 "Service Repli
-00022e80: 6361 7322 207c 2067 7265 7020 2253 4855  cas" | grep "SHU
-00022e90: 5454 494e 475f 444f 574e 223b 2027 0a20  TTING_DOWN"; '. 
-00022ea0: 2020 2020 2020 2020 2020 2027 646f 2065             'do e
-00022eb0: 6368 6f20 2257 6169 7469 6e67 2066 6f72  cho "Waiting for
-00022ec0: 2066 6972 7374 2073 6572 7669 6365 2074   first service t
-00022ed0: 6f20 6265 2053 4855 5454 494e 4720 444f  o be SHUTTING DO
-00022ee0: 574e 2e2e 2e22 3b20 270a 2020 2020 2020  WN..."; '.      
-00022ef0: 2020 2020 2020 6627 736c 6565 7020 353b        f'sleep 5;
-00022f00: 2073 3d24 2873 6b79 2073 6572 7665 2073   s=$(sky serve s
-00022f10: 7461 7475 7320 7b6e 616d 657d 293b 2065  tatus {name}); e
-00022f20: 6368 6f20 2224 7322 3b20 646f 6e65 3b20  cho "$s"; done; 
-00022f30: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00022f40: 2773 3d24 2873 6b79 2073 6572 7665 2073  's=$(sky serve s
-00022f50: 7461 7475 7320 7b6e 616d 657d 293b 2065  tatus {name}); e
-00022f60: 6368 6f20 2224 7322 3b27 0a20 2020 2020  cho "$s";'.     
-00022f70: 2020 2020 2020 2027 756e 7469 6c20 6563         'until ec
-00022f80: 686f 2022 2473 2220 7c20 6772 6570 202d  ho "$s" | grep -
-00022f90: 4120 3130 3020 2253 6572 7669 6365 2052  A 100 "Service R
-00022fa0: 6570 6c69 6361 7322 207c 2067 7265 7020  eplicas" | grep 
-00022fb0: 2246 4149 4c45 4422 3b20 270a 2020 2020  "FAILED"; '.    
-00022fc0: 2020 2020 2020 2020 2764 6f20 6563 686f          'do echo
-00022fd0: 2022 5761 6974 696e 6720 666f 7220 6669   "Waiting for fi
-00022fe0: 7273 7420 7365 7276 6963 6520 746f 2062  rst service to b
-00022ff0: 6520 4641 494c 4544 2e2e 2e22 3b20 270a  e FAILED..."; '.
-00023000: 2020 2020 2020 2020 2020 2020 6627 736c              f'sl
-00023010: 6565 7020 353b 2073 3d24 2873 6b79 2073  eep 5; s=$(sky s
-00023020: 6572 7665 2073 7461 7475 7320 7b6e 616d  erve status {nam
-00023030: 657d 293b 2065 6368 6f20 2224 7322 3b20  e}); echo "$s"; 
-00023040: 646f 6e65 3b20 6563 686f 2022 2473 223b  done; echo "$s";
-00023050: 2027 0a20 2020 2020 2020 2020 2020 202b   '.            +
-00023060: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
-00023070: 696e 5f73 7461 7475 7328 6e61 6d65 2c20  in_status(name, 
-00023080: 5b28 312c 2054 7275 652c 2027 4641 494c  [(1, True, 'FAIL
-00023090: 4544 2729 5d29 202b 0a20 2020 2020 2020  ED')]) +.       
-000230a0: 2020 2020 2023 2055 7365 7220 6275 6720       # User bug 
-000230b0: 6661 696c 7572 6520 7769 6c6c 2063 6175  failure will cau
-000230c0: 7365 206e 6f20 6675 7274 6865 7220 7363  se no further sc
-000230d0: 616c 696e 672e 0a20 2020 2020 2020 2020  aling..         
-000230e0: 2020 2066 2765 6368 6f20 2224 7322 207c     f'echo "$s" |
-000230f0: 2067 7265 7020 2d41 2031 3030 2022 5365   grep -A 100 "Se
-00023100: 7276 6963 6520 5265 706c 6963 6173 2220  rvice Replicas" 
-00023110: 7c20 6772 6570 2022 7b6e 616d 657d 2220  | grep "{name}" 
-00023120: 7c20 7763 202d 6c20 7c20 6772 6570 2031  | wc -l | grep 1
-00023130: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-00023140: 6627 6563 686f 2022 2473 2220 7c20 6772  f'echo "$s" | gr
-00023150: 6570 202d 4220 3130 3020 224e 4f5f 5245  ep -B 100 "NO_RE
-00023160: 504c 4943 4122 207c 2067 7265 7020 2230  PLICA" | grep "0
-00023170: 2f30 2227 2c0a 2020 2020 2020 2020 2020  /0"',.          
-00023180: 2020 6627 736b 7920 7365 7276 6520 7570    f'sky serve up
-00023190: 6461 7465 207b 6e61 6d65 7d20 2d2d 636c  date {name} --cl
-000231a0: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-000231b0: 7564 7d20 2d79 2074 6573 7473 2f73 6b79  ud} -y tests/sky
-000231c0: 7365 7276 652f 6175 746f 5f72 6573 7461  serve/auto_resta
-000231d0: 7274 2e79 616d 6c27 2c0a 2020 2020 2020  rt.yaml',.      
-000231e0: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
-000231f0: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
-00023200: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
-00023210: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-00023220: 2775 6e74 696c 2063 7572 6c20 2d4c 2068  'until curl -L h
-00023230: 7474 703a 2f2f 2465 6e64 706f 696e 7420  ttp://$endpoint 
-00023240: 7c20 6772 6570 2022 4869 2c20 536b 7950  | grep "Hi, SkyP
-00023250: 696c 6f74 2068 6572 6521 223b 2064 6f20  ilot here!"; do 
-00023260: 736c 6565 7020 323b 2064 6f6e 653b 2073  sleep 2; done; s
-00023270: 6c65 6570 2032 3b20 270a 2020 2020 2020  leep 2; '.      
-00023280: 2020 2020 2020 2b20 5f63 6865 636b 5f72        + _check_r
-00023290: 6570 6c69 6361 5f69 6e5f 7374 6174 7573  eplica_in_status
-000232a0: 286e 616d 652c 205b 2831 2c20 4661 6c73  (name, [(1, Fals
-000232b0: 652c 2027 5245 4144 5927 292c 0a20 2020  e, 'READY'),.   
-000232c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000232d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000232e0: 2020 2020 2020 2020 2020 2028 312c 2046             (1, F
-000232f0: 616c 7365 2c20 2746 4149 4c45 4427 295d  alse, 'FAILED')]
-00023300: 292c 0a20 2020 2020 2020 205d 2c0a 2020  ),.        ],.  
-00023310: 2020 2020 2020 5f54 4541 5244 4f57 4e5f        _TEARDOWN_
-00023320: 5345 5256 4943 452e 666f 726d 6174 286e  SERVICE.format(n
-00023330: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
-00023340: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
-00023350: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-00023360: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00023370: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00023380: 7365 7276 650a 4070 7974 6573 742e 6d61  serve.@pytest.ma
-00023390: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
-000233a0: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
-000233b0: 7665 5f6c 6f61 645f 6261 6c61 6e63 6572  ve_load_balancer
-000233c0: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
-000233d0: 7374 7229 3a0a 2020 2020 2222 2254 6573  str):.    """Tes
-000233e0: 7420 736b 7973 6572 7665 206c 6f61 6420  t skyserve load 
-000233f0: 6261 6c61 6e63 6572 2072 6f75 6e64 2d72  balancer round-r
-00023400: 6f62 696e 2070 6f6c 6963 7922 2222 0a20  obin policy""". 
-00023410: 2020 206e 616d 6520 3d20 5f67 6574 5f73     name = _get_s
-00023420: 6572 7669 6365 5f6e 616d 6528 290a 2020  ervice_name().  
-00023430: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00023440: 2020 2020 2020 2066 2774 6573 742d 736b         f'test-sk
-00023450: 7973 6572 7665 2d6c 6f61 642d 6261 6c61  yserve-load-bala
-00023460: 6e63 6572 272c 0a20 2020 2020 2020 205b  ncer',.        [
-00023470: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00023480: 6b79 2073 6572 7665 2075 7020 2d6e 207b  ky serve up -n {
-00023490: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
-000234a0: 656e 6572 6963 5f63 6c6f 7564 7d20 2d79  eneric_cloud} -y
-000234b0: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
-000234c0: 6c6f 6164 5f62 616c 616e 6365 722f 7365  load_balancer/se
-000234d0: 7276 6963 652e 7961 6d6c 272c 0a20 2020  rvice.yaml',.   
-000234e0: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
-000234f0: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
-00023500: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-00023510: 652c 2072 6570 6c69 6361 5f6e 756d 3d33  e, replica_num=3
-00023520: 292c 0a20 2020 2020 2020 2020 2020 2066  ),.            f
-00023530: 277b 5f53 4552 5645 5f45 4e44 504f 494e  '{_SERVE_ENDPOIN
-00023540: 545f 5741 4954 2e66 6f72 6d61 7428 6e61  T_WAIT.format(na
-00023550: 6d65 3d6e 616d 6529 7d3b 2027 0a20 2020  me=name)}; '.   
-00023560: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
-00023570: 5645 5f53 5441 5455 535f 5741 4954 2e66  VE_STATUS_WAIT.f
-00023580: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
-00023590: 7d3b 2027 0a20 2020 2020 2020 2020 2020  }; '.           
-000235a0: 2066 277b 5f67 6574 5f72 6570 6c69 6361   f'{_get_replica
-000235b0: 5f69 7028 6e61 6d65 2c20 3129 7d3b 2027  _ip(name, 1)}; '
-000235c0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-000235d0: 5f67 6574 5f72 6570 6c69 6361 5f69 7028  _get_replica_ip(
-000235e0: 6e61 6d65 2c20 3229 7d3b 207b 5f67 6574  name, 2)}; {_get
-000235f0: 5f72 6570 6c69 6361 5f69 7028 6e61 6d65  _replica_ip(name
-00023600: 2c20 3329 7d3b 2027 0a20 2020 2020 2020  , 3)}; '.       
-00023610: 2020 2020 2027 7079 7468 6f6e 2074 6573       'python tes
-00023620: 7473 2f73 6b79 7365 7276 652f 6c6f 6164  ts/skyserve/load
-00023630: 5f62 616c 616e 6365 722f 7465 7374 5f72  _balancer/test_r
-00023640: 6f75 6e64 5f72 6f62 696e 2e70 7920 270a  ound_robin.py '.
-00023650: 2020 2020 2020 2020 2020 2020 272d 2d65              '--e
-00023660: 6e64 706f 696e 7420 2465 6e64 706f 696e  ndpoint $endpoin
-00023670: 7420 2d2d 7265 706c 6963 612d 6e75 6d20  t --replica-num 
-00023680: 3320 2d2d 7265 706c 6963 612d 6970 7320  3 --replica-ips 
-00023690: 2469 7031 2024 6970 3220 2469 7033 272c  $ip1 $ip2 $ip3',
-000236a0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-000236b0: 2020 2020 5f54 4541 5244 4f57 4e5f 5345      _TEARDOWN_SE
-000236c0: 5256 4943 452e 666f 726d 6174 286e 616d  RVICE.format(nam
-000236d0: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
-000236e0: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
-000236f0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00023700: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00023710: 0a40 7079 7465 7374 2e6d 6172 6b2e 6763  .@pytest.mark.gc
-00023720: 700a 4070 7974 6573 742e 6d61 726b 2e73  p.@pytest.mark.s
-00023730: 6572 7665 0a40 7079 7465 7374 2e6d 6172  erve.@pytest.mar
-00023740: 6b2e 6e6f 5f6b 7562 6572 6e65 7465 730a  k.no_kubernetes.
-00023750: 6465 6620 7465 7374 5f73 6b79 7365 7276  def test_skyserv
-00023760: 655f 6175 746f 5f72 6573 7461 7274 2829  e_auto_restart()
-00023770: 3a0a 2020 2020 2222 2254 6573 7420 736b  :.    """Test sk
-00023780: 7973 6572 7665 2077 6974 6820 6175 746f  yserve with auto
-00023790: 2072 6573 7461 7274 2222 220a 2020 2020   restart""".    
-000237a0: 6e61 6d65 203d 205f 6765 745f 7365 7276  name = _get_serv
-000237b0: 6963 655f 6e61 6d65 2829 0a20 2020 207a  ice_name().    z
-000237c0: 6f6e 6520 3d20 2775 732d 6365 6e74 7261  one = 'us-centra
-000237d0: 6c31 2d61 270a 2020 2020 7465 7374 203d  l1-a'.    test =
-000237e0: 2054 6573 7428 0a20 2020 2020 2020 2066   Test(.        f
-000237f0: 2774 6573 742d 736b 7973 6572 7665 2d61  'test-skyserve-a
-00023800: 7574 6f2d 7265 7374 6172 7427 2c0a 2020  uto-restart',.  
-00023810: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00023820: 2020 2020 2320 544f 444f 2874 6961 6e29      # TODO(tian)
-00023830: 3a20 7765 2063 616e 2064 796e 616d 6963  : we can dynamic
-00023840: 616c 6c79 2067 656e 6572 6174 6520 5941  ally generate YA
-00023850: 4d4c 2066 726f 6d20 7465 6d70 6c61 7465  ML from template
-00023860: 2074 6f0a 2020 2020 2020 2020 2020 2020   to.            
-00023870: 2320 6176 6f69 6420 6d61 696e 7461 696e  # avoid maintain
-00023880: 696e 6720 746f 6f20 6d61 6e79 2059 414d  ing too many YAM
-00023890: 4c20 6669 6c65 730a 2020 2020 2020 2020  L files.        
-000238a0: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
-000238b0: 7570 202d 6e20 7b6e 616d 657d 202d 7920  up -n {name} -y 
-000238c0: 7465 7374 732f 736b 7973 6572 7665 2f61  tests/skyserve/a
-000238d0: 7574 6f5f 7265 7374 6172 742e 7961 6d6c  uto_restart.yaml
-000238e0: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
-000238f0: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
-00023900: 5f52 4541 4459 2e66 6f72 6d61 7428 6e61  _READY.format(na
-00023910: 6d65 3d6e 616d 652c 2072 6570 6c69 6361  me=name, replica
-00023920: 5f6e 756d 3d31 292c 0a20 2020 2020 2020  _num=1),.       
-00023930: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
-00023940: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
-00023950: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
-00023960: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-00023970: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
-00023980: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
-00023990: 2248 692c 2053 6b79 5069 6c6f 7420 6865  "Hi, SkyPilot he
-000239a0: 7265 2227 2c0a 2020 2020 2020 2020 2020  re"',.          
-000239b0: 2020 2320 736c 6565 7020 666f 7220 3230    # sleep for 20
-000239c0: 2073 6563 6f6e 6473 2028 696e 6974 6961   seconds (initia
-000239d0: 6c20 6465 6c61 7929 2074 6f20 6d61 6b65  l delay) to make
-000239e0: 2073 7572 6520 6974 2077 696c 6c0a 2020   sure it will.  
-000239f0: 2020 2020 2020 2020 2020 2320 6265 2072            # be r
-00023a00: 6573 7461 7274 6564 0a20 2020 2020 2020  estarted.       
-00023a10: 2020 2020 2066 2773 6c65 6570 2032 3027       f'sleep 20'
-00023a20: 2c0a 2020 2020 2020 2020 2020 2020 5f74  ,.            _t
-00023a30: 6572 6d69 6e61 7465 5f67 6370 5f72 6570  erminate_gcp_rep
-00023a40: 6c69 6361 286e 616d 652c 207a 6f6e 652c  lica(name, zone,
-00023a50: 2031 292c 0a20 2020 2020 2020 2020 2020   1),.           
-00023a60: 2023 2057 6169 7420 666f 7220 636f 6e73   # Wait for cons
-00023a70: 6563 7574 6976 6520 6661 696c 7572 6520  ecutive failure 
-00023a80: 7469 6d65 6f75 7420 7061 7373 6564 2e0a  timeout passed..
-00023a90: 2020 2020 2020 2020 2020 2020 2320 4966              # If
-00023aa0: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
-00023ab0: 6e6f 7420 7573 696e 6720 7370 6f74 2c20  not using spot, 
-00023ac0: 6974 2077 6f6e 2774 2063 6865 636b 2074  it won't check t
-00023ad0: 6865 2063 6c75 7374 6572 2073 7461 7475  he cluster statu
-00023ae0: 730a 2020 2020 2020 2020 2020 2020 2320  s.            # 
-00023af0: 6f6e 2074 6865 2063 6c6f 7564 2028 7369  on the cloud (si
-00023b00: 6e63 6520 6d61 6e75 616c 2073 6875 7464  nce manual shutd
-00023b10: 6f77 6e20 6973 206e 6f74 2061 2063 6f6d  own is not a com
-00023b20: 6d6f 6e20 6265 6861 7669 6f72 2061 6e64  mon behavior and
-00023b30: 2073 7563 680a 2020 2020 2020 2020 2020   such.          
-00023b40: 2020 2320 7175 6572 6965 7320 7461 6b65    # queries take
-00023b50: 7320 6120 6c6f 7420 6f66 2074 696d 6529  s a lot of time)
-00023b60: 2e20 496e 7374 6561 642c 2077 6520 7468  . Instead, we th
-00023b70: 696e 6b20 636f 6e74 696e 756f 7573 2033  ink continuous 3
-00023b80: 206d 696e 2070 726f 6265 0a20 2020 2020   min probe.     
-00023b90: 2020 2020 2020 2023 2066 6169 6c75 7265         # failure
-00023ba0: 2069 7320 6e6f 7420 6120 7465 6d70 6f72   is not a tempor
-00023bb0: 6172 7920 7072 6f62 6c65 6d20 6275 7420  ary problem but 
-00023bc0: 696e 6465 6564 2061 2066 6169 6c75 7265  indeed a failure
-00023bd0: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
-00023be0: 6c65 6570 2031 3830 272c 0a20 2020 2020  leep 180',.     
-00023bf0: 2020 2020 2020 2023 2057 6520 6361 6e6e         # We cann
-00023c00: 6f74 2075 7365 205f 5345 5256 455f 5741  ot use _SERVE_WA
-00023c10: 4954 5f55 4e54 494c 5f52 4541 4459 3b20  IT_UNTIL_READY; 
-00023c20: 7468 6572 6520 7769 6c6c 2062 6520 6120  there will be a 
-00023c30: 696e 7465 726d 6564 6961 7465 2074 696d  intermediate tim
-00023c40: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-00023c50: 7468 6174 2074 6865 206f 7574 7075 7420  that the output 
-00023c60: 6f66 2060 736b 7920 7365 7276 6520 7374  of `sky serve st
-00023c70: 6174 7573 6020 7368 6f77 7320 4641 494c  atus` shows FAIL
-00023c80: 4544 2061 6e64 2074 6869 7320 7374 6174  ED and this stat
-00023c90: 7573 2077 696c 6c0a 2020 2020 2020 2020  us will.        
-00023ca0: 2020 2020 2320 6361 7573 6520 5f53 4552      # cause _SER
-00023cb0: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
-00023cc0: 4144 5920 746f 2065 6172 6c79 2071 7569  ADY to early qui
-00023cd0: 742e 0a20 2020 2020 2020 2020 2020 2027  t..            '
-00023ce0: 2877 6869 6c65 2074 7275 653b 2064 6f27  (while true; do'
-00023cf0: 0a20 2020 2020 2020 2020 2020 2066 2720  .            f' 
-00023d00: 2020 206f 7574 7075 743d 2428 736b 7920     output=$(sky 
-00023d10: 7365 7276 6520 7374 6174 7573 207b 6e61  serve status {na
-00023d20: 6d65 7d29 3b27 0a20 2020 2020 2020 2020  me});'.         
-00023d30: 2020 2027 2020 2020 2065 6368 6f20 2224     '     echo "$
-00023d40: 6f75 7470 7574 2220 7c20 6772 6570 202d  output" | grep -
-00023d50: 7120 2231 2f31 2220 2626 2062 7265 616b  q "1/1" && break
-00023d60: 3b27 0a20 2020 2020 2020 2020 2020 2027  ;'.            '
-00023d70: 2020 2020 2073 6c65 6570 2031 303b 270a       sleep 10;'.
-00023d80: 2020 2020 2020 2020 2020 2020 6627 646f              f'do
-00023d90: 6e65 293b 2073 6c65 6570 207b 7365 7276  ne); sleep {serv
-00023da0: 652e 4c42 5f43 4f4e 5452 4f4c 4c45 525f  e.LB_CONTROLLER_
-00023db0: 5359 4e43 5f49 4e54 4552 5641 4c5f 5345  SYNC_INTERVAL_SE
-00023dc0: 434f 4e44 537d 3b27 2c0a 2020 2020 2020  CONDS};',.      
-00023dd0: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
-00023de0: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
-00023df0: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
-00023e00: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-00023e10: 2763 7572 6c20 2d4c 2068 7474 703a 2f2f  'curl -L http://
-00023e20: 2465 6e64 706f 696e 7420 7c20 6772 6570  $endpoint | grep
-00023e30: 2022 4869 2c20 536b 7950 696c 6f74 2068   "Hi, SkyPilot h
-00023e40: 6572 6522 272c 0a20 2020 2020 2020 205d  ere"',.        ]
-00023e50: 2c0a 2020 2020 2020 2020 5f54 4541 5244  ,.        _TEARD
-00023e60: 4f57 4e5f 5345 5256 4943 452e 666f 726d  OWN_SERVICE.form
-00023e70: 6174 286e 616d 653d 6e61 6d65 292c 0a20  at(name=name),. 
-00023e80: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
-00023e90: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
-00023ea0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00023eb0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-00023ec0: 6172 6b2e 7365 7276 650a 4070 7974 6573  ark.serve.@pytes
-00023ed0: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
-00023ee0: 6574 6573 0a64 6566 2074 6573 745f 736b  etes.def test_sk
-00023ef0: 7973 6572 7665 5f63 616e 6365 6c28 6765  yserve_cancel(ge
-00023f00: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
-00023f10: 293a 0a20 2020 2022 2222 5465 7374 2073  ):.    """Test s
-00023f20: 6b79 7365 7276 6520 7769 7468 2063 616e  kyserve with can
-00023f30: 6365 6c22 2222 0a20 2020 206e 616d 6520  cel""".    name 
-00023f40: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
-00023f50: 616d 6528 290a 0a20 2020 2074 6573 7420  ame()..    test 
-00023f60: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00023f70: 6627 7465 7374 2d73 6b79 7365 7276 652d  f'test-skyserve-
-00023f80: 6361 6e63 656c 272c 0a20 2020 2020 2020  cancel',.       
-00023f90: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00023fa0: 2773 6b79 2073 6572 7665 2075 7020 2d6e  'sky serve up -n
-00023fb0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-00023fc0: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
-00023fd0: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
-00023fe0: 652f 6361 6e63 656c 2f63 616e 6365 6c2e  e/cancel/cancel.
-00023ff0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00024000: 2020 205f 5345 5256 455f 5741 4954 5f55     _SERVE_WAIT_U
-00024010: 4e54 494c 5f52 4541 4459 2e66 6f72 6d61  NTIL_READY.forma
-00024020: 7428 6e61 6d65 3d6e 616d 652c 2072 6570  t(name=name, rep
-00024030: 6c69 6361 5f6e 756d 3d31 292c 0a20 2020  lica_num=1),.   
-00024040: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
-00024050: 5645 5f45 4e44 504f 494e 545f 5741 4954  VE_ENDPOINT_WAIT
-00024060: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-00024070: 6529 7d3b 2070 7974 686f 6e33 2027 0a20  e)}; python3 '. 
-00024080: 2020 2020 2020 2020 2020 2027 7465 7374             'test
-00024090: 732f 736b 7973 6572 7665 2f63 616e 6365  s/skyserve/cance
-000240a0: 6c2f 7365 6e64 5f63 616e 6365 6c5f 7265  l/send_cancel_re
-000240b0: 7175 6573 742e 7079 2027 0a20 2020 2020  quest.py '.     
-000240c0: 2020 2020 2020 2027 2d2d 656e 6470 6f69         '--endpoi
-000240d0: 6e74 2024 656e 6470 6f69 6e74 207c 2067  nt $endpoint | g
-000240e0: 7265 7020 2252 6571 7565 7374 2077 6173  rep "Request was
-000240f0: 2063 616e 6365 6c6c 6564 2227 2c0a 2020   cancelled"',.  
-00024100: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-00024110: 736b 7920 7365 7276 6520 6c6f 6773 207b  sky serve logs {
-00024120: 6e61 6d65 7d20 3120 2d2d 6e6f 2d66 6f6c  name} 1 --no-fol
-00024130: 6c6f 7729 3b20 270a 2020 2020 2020 2020  low); '.        
-00024140: 2020 2020 2775 6e74 696c 2021 2065 6368      'until ! ech
-00024150: 6f20 2224 7322 207c 2067 7265 7020 2250  o "$s" | grep "P
-00024160: 6c65 6173 6520 7761 6974 2066 6f72 2074  lease wait for t
-00024170: 6865 2063 6f6e 7472 6f6c 6c65 7220 746f  he controller to
-00024180: 2062 6522 3b20 270a 2020 2020 2020 2020   be"; '.        
-00024190: 2020 2020 2764 6f20 6563 686f 2022 5761      'do echo "Wa
-000241a0: 6974 696e 6720 666f 7220 7365 7276 6520  iting for serve 
-000241b0: 6c6f 6773 223b 2073 6c65 6570 2031 303b  logs"; sleep 10;
-000241c0: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
-000241d0: 2773 3d24 2873 6b79 2073 6572 7665 206c  's=$(sky serve l
-000241e0: 6f67 7320 7b6e 616d 657d 2031 202d 2d6e  ogs {name} 1 --n
-000241f0: 6f2d 666f 6c6c 6f77 293b 2064 6f6e 653b  o-follow); done;
-00024200: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-00024210: 6563 686f 2022 2473 223b 2065 6368 6f20  echo "$s"; echo 
-00024220: 2224 7322 207c 2067 7265 7020 2243 6c69  "$s" | grep "Cli
-00024230: 656e 7420 6469 7363 6f6e 6e65 6374 6564  ent disconnected
-00024240: 2c20 7374 6f70 7069 6e67 2063 6f6d 7075  , stopping compu
-00024250: 7461 7469 6f6e 2227 2c0a 2020 2020 2020  tation"',.      
-00024260: 2020 5d2c 0a20 2020 2020 2020 205f 5445    ],.        _TE
-00024270: 4152 444f 574e 5f53 4552 5649 4345 2e66  ARDOWN_SERVICE.f
-00024280: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
-00024290: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-000242a0: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
-000242b0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-000242c0: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-000242d0: 742e 6d61 726b 2e73 6572 7665 0a40 7079  t.mark.serve.@py
-000242e0: 7465 7374 2e6d 6172 6b2e 6e6f 5f6b 7562  test.mark.no_kub
-000242f0: 6572 6e65 7465 730a 6465 6620 7465 7374  ernetes.def test
-00024300: 5f73 6b79 7365 7276 655f 7570 6461 7465  _skyserve_update
-00024310: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
-00024320: 7374 7229 3a0a 2020 2020 2222 2254 6573  str):.    """Tes
-00024330: 7420 736b 7973 6572 7665 2077 6974 6820  t skyserve with 
-00024340: 7570 6461 7465 2222 220a 2020 2020 6e61  update""".    na
-00024350: 6d65 203d 205f 6765 745f 7365 7276 6963  me = _get_servic
-00024360: 655f 6e61 6d65 2829 0a20 2020 2074 6573  e_name().    tes
-00024370: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00024380: 2020 6627 7465 7374 2d73 6b79 7365 7276    f'test-skyserv
-00024390: 652d 7570 6461 7465 272c 0a20 2020 2020  e-update',.     
-000243a0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-000243b0: 2066 2773 6b79 2073 6572 7665 2075 7020   f'sky serve up 
-000243c0: 2d6e 207b 6e61 6d65 7d20 2d2d 636c 6f75  -n {name} --clou
-000243d0: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-000243e0: 7d20 2d79 2074 6573 7473 2f73 6b79 7365  } -y tests/skyse
-000243f0: 7276 652f 7570 6461 7465 2f6f 6c64 2e79  rve/update/old.y
-00024400: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00024410: 2020 5f53 4552 5645 5f57 4149 545f 554e    _SERVE_WAIT_UN
-00024420: 5449 4c5f 5245 4144 592e 666f 726d 6174  TIL_READY.format
-00024430: 286e 616d 653d 6e61 6d65 2c20 7265 706c  (name=name, repl
-00024440: 6963 615f 6e75 6d3d 3229 2c0a 2020 2020  ica_num=2),.    
-00024450: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
-00024460: 455f 454e 4450 4f49 4e54 5f57 4149 542e  E_ENDPOINT_WAIT.
-00024470: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-00024480: 297d 3b20 6375 726c 202d 4c20 6874 7470  )}; curl -L http
-00024490: 3a2f 2f24 656e 6470 6f69 6e74 207c 2067  ://$endpoint | g
-000244a0: 7265 7020 2248 692c 2053 6b79 5069 6c6f  rep "Hi, SkyPilo
-000244b0: 7420 6865 7265 2227 2c0a 2020 2020 2020  t here"',.      
-000244c0: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
-000244d0: 6520 7570 6461 7465 207b 6e61 6d65 7d20  e update {name} 
-000244e0: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-000244f0: 5f63 6c6f 7564 7d20 2d2d 6d6f 6465 2062  _cloud} --mode b
-00024500: 6c75 655f 6772 6565 6e20 2d79 2074 6573  lue_green -y tes
-00024510: 7473 2f73 6b79 7365 7276 652f 7570 6461  ts/skyserve/upda
-00024520: 7465 2f6e 6577 2e79 616d 6c27 2c0a 2020  te/new.yaml',.  
-00024530: 2020 2020 2020 2020 2020 2320 736c 6565            # slee
-00024540: 7020 6265 666f 7265 2075 7064 6174 6520  p before update 
-00024550: 6973 2072 6567 6973 7465 7265 642e 0a20  is registered.. 
-00024560: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00024570: 7020 3230 272c 0a20 2020 2020 2020 2020  p 20',.         
-00024580: 2020 2066 277b 5f53 4552 5645 5f45 4e44     f'{_SERVE_END
-00024590: 504f 494e 545f 5741 4954 2e66 6f72 6d61  POINT_WAIT.forma
-000245a0: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2027  t(name=name)}; '
-000245b0: 0a20 2020 2020 2020 2020 2020 2027 756e  .            'un
-000245c0: 7469 6c20 6375 726c 202d 4c20 6874 7470  til curl -L http
-000245d0: 3a2f 2f24 656e 6470 6f69 6e74 207c 2067  ://$endpoint | g
-000245e0: 7265 7020 2248 692c 206e 6577 2053 6b79  rep "Hi, new Sky
-000245f0: 5069 6c6f 7420 6865 7265 2122 3b20 646f  Pilot here!"; do
-00024600: 2073 6c65 6570 2032 3b20 646f 6e65 3b27   sleep 2; done;'
-00024610: 0a20 2020 2020 2020 2020 2020 2023 204d  .            # M
-00024620: 616b 6520 7375 7265 2074 6865 2074 7261  ake sure the tra
-00024630: 6666 6963 2069 7320 6e6f 7420 6d69 7865  ffic is not mixe
-00024640: 640a 2020 2020 2020 2020 2020 2020 2763  d.            'c
-00024650: 7572 6c20 2d4c 2068 7474 703a 2f2f 2465  url -L http://$e
-00024660: 6e64 706f 696e 7420 7c20 6772 6570 2022  ndpoint | grep "
-00024670: 4869 2c20 6e65 7720 536b 7950 696c 6f74  Hi, new SkyPilot
-00024680: 2068 6572 6522 272c 0a20 2020 2020 2020   here"',.       
-00024690: 2020 2020 2023 2054 6865 206c 6174 6573       # The lates
-000246a0: 7420 3220 7665 7273 696f 6e20 7368 6f75  t 2 version shou
-000246b0: 6c64 2062 6520 5245 4144 5920 616e 6420  ld be READY and 
-000246c0: 7468 6520 6f6c 6465 7220 7665 7273 696f  the older versio
-000246d0: 6e73 2073 686f 756c 6420 6265 2073 6875  ns should be shu
-000246e0: 7474 696e 6720 646f 776e 0a20 2020 2020  tting down.     
-000246f0: 2020 2020 2020 2028 5f63 6865 636b 5f72         (_check_r
-00024700: 6570 6c69 6361 5f69 6e5f 7374 6174 7573  eplica_in_status
-00024710: 286e 616d 652c 205b 2832 2c20 4661 6c73  (name, [(2, Fals
-00024720: 652c 2027 5245 4144 5927 292c 0a20 2020  e, 'READY'),.   
-00024730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024750: 2020 2020 2020 2020 2020 2832 2c20 4661            (2, Fa
-00024760: 6c73 652c 2027 5348 5554 5449 4e47 5f44  lse, 'SHUTTING_D
-00024770: 4f57 4e27 295d 2920 2b0a 2020 2020 2020  OWN')]) +.      
-00024780: 2020 2020 2020 205f 6368 6563 6b5f 7365         _check_se
-00024790: 7276 6963 655f 7665 7273 696f 6e28 6e61  rvice_version(na
-000247a0: 6d65 2c20 2232 2229 292c 0a20 2020 2020  me, "2")),.     
-000247b0: 2020 205d 2c0a 2020 2020 2020 2020 5f54     ],.        _T
-000247c0: 4541 5244 4f57 4e5f 5345 5256 4943 452e  EARDOWN_SERVICE.
-000247d0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-000247e0: 292c 0a20 2020 2020 2020 2074 696d 656f  ),.        timeo
-000247f0: 7574 3d32 3020 2a20 3630 2c0a 2020 2020  ut=20 * 60,.    
-00024800: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00024810: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-00024820: 7374 2e6d 6172 6b2e 7365 7276 650a 4070  st.mark.serve.@p
-00024830: 7974 6573 742e 6d61 726b 2e6e 6f5f 6b75  ytest.mark.no_ku
-00024840: 6265 726e 6574 6573 0a64 6566 2074 6573  bernetes.def tes
-00024850: 745f 736b 7973 6572 7665 5f72 6f6c 6c69  t_skyserve_rolli
-00024860: 6e67 5f75 7064 6174 6528 6765 6e65 7269  ng_update(generi
-00024870: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-00024880: 2020 2022 2222 5465 7374 2073 6b79 7365     """Test skyse
-00024890: 7276 6520 7769 7468 2072 6f6c 6c69 6e67  rve with rolling
-000248a0: 2075 7064 6174 6522 2222 0a20 2020 206e   update""".    n
-000248b0: 616d 6520 3d20 5f67 6574 5f73 6572 7669  ame = _get_servi
-000248c0: 6365 5f6e 616d 6528 290a 2020 2020 7369  ce_name().    si
-000248d0: 6e67 6c65 5f6e 6577 5f72 6570 6c69 6361  ngle_new_replica
-000248e0: 203d 205f 6368 6563 6b5f 7265 706c 6963   = _check_replic
-000248f0: 615f 696e 5f73 7461 7475 7328 0a20 2020  a_in_status(.   
-00024900: 2020 2020 206e 616d 652c 205b 2832 2c20       name, [(2, 
-00024910: 4661 6c73 652c 2027 5245 4144 5927 292c  False, 'READY'),
-00024920: 2028 312c 2046 616c 7365 2c20 5f53 4552   (1, False, _SER
-00024930: 5649 4345 5f4c 4155 4e43 4849 4e47 5f53  VICE_LAUNCHING_S
-00024940: 5441 5455 535f 5245 4745 5829 2c0a 2020  TATUS_REGEX),.  
-00024950: 2020 2020 2020 2020 2020 2020 2028 312c               (1,
-00024960: 2046 616c 7365 2c20 2753 4855 5454 494e   False, 'SHUTTIN
-00024970: 475f 444f 574e 2729 5d29 0a20 2020 2074  G_DOWN')]).    t
-00024980: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-00024990: 2020 2020 6627 7465 7374 2d73 6b79 7365      f'test-skyse
-000249a0: 7276 652d 726f 6c6c 696e 672d 7570 6461  rve-rolling-upda
-000249b0: 7465 272c 0a20 2020 2020 2020 205b 0a20  te',.        [. 
-000249c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000249d0: 2073 6572 7665 2075 7020 2d6e 207b 6e61   serve up -n {na
-000249e0: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-000249f0: 6572 6963 5f63 6c6f 7564 7d20 2d79 2074  eric_cloud} -y t
-00024a00: 6573 7473 2f73 6b79 7365 7276 652f 7570  ests/skyserve/up
-00024a10: 6461 7465 2f6f 6c64 2e79 616d 6c27 2c0a  date/old.yaml',.
-00024a20: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
-00024a30: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
-00024a40: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
-00024a50: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
-00024a60: 6d3d 3229 2c0a 2020 2020 2020 2020 2020  m=2),.          
-00024a70: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
-00024a80: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
-00024a90: 286e 616d 653d 6e61 6d65 297d 3b20 6375  (name=name)}; cu
-00024aa0: 726c 202d 4c20 6874 7470 3a2f 2f24 656e  rl -L http://$en
-00024ab0: 6470 6f69 6e74 207c 2067 7265 7020 2248  dpoint | grep "H
-00024ac0: 692c 2053 6b79 5069 6c6f 7420 6865 7265  i, SkyPilot here
-00024ad0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00024ae0: 6627 736b 7920 7365 7276 6520 7570 6461  f'sky serve upda
-00024af0: 7465 207b 6e61 6d65 7d20 2d2d 636c 6f75  te {name} --clou
-00024b00: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-00024b10: 7d20 2d79 2074 6573 7473 2f73 6b79 7365  } -y tests/skyse
-00024b20: 7276 652f 7570 6461 7465 2f6e 6577 2e79  rve/update/new.y
-00024b30: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00024b40: 2020 2320 4d61 6b65 2073 7572 6520 7468    # Make sure th
-00024b50: 6520 7472 6166 6669 6320 6973 206d 6978  e traffic is mix
-00024b60: 6564 2061 6372 6f73 7320 7477 6f20 7665  ed across two ve
-00024b70: 7273 696f 6e73 2c20 7468 6520 7265 706c  rsions, the repl
-00024b80: 6963 6173 0a20 2020 2020 2020 2020 2020  icas.           
-00024b90: 2023 2077 6974 6820 6576 656e 2069 6420   # with even id 
-00024ba0: 7769 6c6c 2073 6c65 6570 2036 3020 7365  will sleep 60 se
-00024bb0: 636f 6e64 7320 6265 666f 7265 2062 6569  conds before bei
-00024bc0: 6e67 2072 6561 6479 2c20 736f 2077 650a  ng ready, so we.
-00024bd0: 2020 2020 2020 2020 2020 2020 2320 7368              # sh
-00024be0: 6f75 6c64 2062 6520 6162 6c65 2074 6f20  ould be able to 
-00024bf0: 6765 7420 6f62 7365 7276 6520 7468 6520  get observe the 
-00024c00: 7065 7269 6f64 2074 6861 7420 7468 6520  period that the 
-00024c10: 7472 6166 6669 6320 6973 206d 6978 6564  traffic is mixed
-00024c20: 0a20 2020 2020 2020 2020 2020 2023 2061  .            # a
-00024c30: 6372 6f73 7320 7477 6f20 7665 7273 696f  cross two versio
-00024c40: 6e73 2e0a 2020 2020 2020 2020 2020 2020  ns..            
-00024c50: 6627 7b5f 5345 5256 455f 454e 4450 4f49  f'{_SERVE_ENDPOI
-00024c60: 4e54 5f57 4149 542e 666f 726d 6174 286e  NT_WAIT.format(n
-00024c70: 616d 653d 6e61 6d65 297d 3b20 270a 2020  ame=name)}; '.  
-00024c80: 2020 2020 2020 2020 2020 2775 6e74 696c            'until
-00024c90: 2063 7572 6c20 2d4c 2068 7474 703a 2f2f   curl -L http://
-00024ca0: 2465 6e64 706f 696e 7420 7c20 6772 6570  $endpoint | grep
-00024cb0: 2022 4869 2c20 6e65 7720 536b 7950 696c   "Hi, new SkyPil
-00024cc0: 6f74 2068 6572 6521 223b 2064 6f20 736c  ot here!"; do sl
-00024cd0: 6565 7020 323b 2064 6f6e 653b 2073 6c65  eep 2; done; sle
-00024ce0: 6570 2032 3b20 270a 2020 2020 2020 2020  ep 2; '.        
-00024cf0: 2020 2020 2320 5468 6520 6c61 7465 7374      # The latest
-00024d00: 2076 6572 7369 6f6e 2073 686f 756c 6420   version should 
-00024d10: 6861 7665 206f 6e65 2052 4541 4459 2061  have one READY a
-00024d20: 6e64 2074 6865 206f 6e65 206f 6620 7468  nd the one of th
-00024d30: 6520 6f6c 6465 7220 7665 7273 696f 6e73  e older versions
-00024d40: 2073 686f 756c 6420 6265 2073 6875 7474   should be shutt
-00024d50: 696e 6720 646f 776e 0a20 2020 2020 2020  ing down.       
-00024d60: 2020 2020 2066 277b 7369 6e67 6c65 5f6e       f'{single_n
-00024d70: 6577 5f72 6570 6c69 6361 7d20 7b5f 6368  ew_replica} {_ch
-00024d80: 6563 6b5f 7365 7276 6963 655f 7665 7273  eck_service_vers
-00024d90: 696f 6e28 6e61 6d65 2c20 2231 2c32 2229  ion(name, "1,2")
-00024da0: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
-00024db0: 2320 4368 6563 6b20 7468 6520 6f75 7470  # Check the outp
-00024dc0: 7574 2066 726f 6d20 7468 6520 6f6c 6420  ut from the old 
-00024dd0: 7665 7273 696f 6e2c 2069 6d6d 6564 6961  version, immedia
-00024de0: 7465 6c79 2061 6674 6572 2074 6865 0a20  tely after the. 
-00024df0: 2020 2020 2020 2020 2020 2023 206f 7574             # out
-00024e00: 7075 7420 6672 6f6d 2074 6865 206e 6577  put from the new
-00024e10: 2076 6572 7369 6f6e 2061 7070 6561 7273   version appears
-00024e20: 2e20 5468 6973 2069 7320 6775 6172 616e  . This is guaran
-00024e30: 7465 6564 2062 7920 7468 650a 2020 2020  teed by the.    
-00024e40: 2020 2020 2020 2020 2320 726f 756e 6420          # round 
-00024e50: 726f 6269 6e20 6c6f 6164 2062 616c 616e  robin load balan
-00024e60: 6369 6e67 2070 6f6c 6963 792e 0a20 2020  cing policy..   
-00024e70: 2020 2020 2020 2020 2023 2054 4f44 4f28           # TODO(
-00024e80: 7a68 7775 293a 2077 6520 7368 6f75 6c64  zhwu): we should
-00024e90: 2068 6176 6520 6120 6d6f 7265 2067 656e   have a more gen
-00024ea0: 6572 616c 697a 6564 2077 6179 2066 6f72  eralized way for
-00024eb0: 2063 6865 636b 696e 6720 7468 650a 2020   checking the.  
-00024ec0: 2020 2020 2020 2020 2020 2320 6d69 7865            # mixe
-00024ed0: 6420 7665 7273 696f 6e20 6f66 2072 6570  d version of rep
-00024ee0: 6c69 6361 7320 746f 2061 766f 6964 2064  licas to avoid d
-00024ef0: 6570 656e 6469 6e67 206f 6e20 7468 6520  epending on the 
-00024f00: 7370 6563 6966 6963 0a20 2020 2020 2020  specific.       
-00024f10: 2020 2020 2023 2072 6f75 6e64 2072 6f62       # round rob
-00024f20: 696e 206c 6f61 6420 6261 6c61 6e63 696e  in load balancin
-00024f30: 6720 706f 6c69 6379 2e0a 2020 2020 2020  g policy..      
-00024f40: 2020 2020 2020 2763 7572 6c20 2d4c 2068        'curl -L h
-00024f50: 7474 703a 2f2f 2465 6e64 706f 696e 7420  ttp://$endpoint 
-00024f60: 7c20 6772 6570 2022 4869 2c20 536b 7950  | grep "Hi, SkyP
-00024f70: 696c 6f74 2068 6572 6522 272c 0a20 2020  ilot here"',.   
-00024f80: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00024f90: 5f54 4541 5244 4f57 4e5f 5345 5256 4943  _TEARDOWN_SERVIC
-00024fa0: 452e 666f 726d 6174 286e 616d 653d 6e61  E.format(name=na
-00024fb0: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
-00024fc0: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
-00024fd0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00024fe0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-00024ff0: 7465 7374 2e6d 6172 6b2e 7365 7276 650a  test.mark.serve.
-00025000: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00025010: 6b75 6265 726e 6574 6573 0a64 6566 2074  kubernetes.def t
-00025020: 6573 745f 736b 7973 6572 7665 5f66 6173  est_skyserve_fas
-00025030: 745f 7570 6461 7465 2867 656e 6572 6963  t_update(generic
-00025040: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
-00025050: 2020 2222 2254 6573 7420 736b 7973 6572    """Test skyser
-00025060: 7665 2077 6974 6820 6661 7374 2075 7064  ve with fast upd
-00025070: 6174 6520 2849 6e63 7265 6d65 6e74 2076  ate (Increment v
-00025080: 6572 7369 6f6e 206f 6620 6f6c 6420 7265  ersion of old re
-00025090: 706c 6963 6173 2922 2222 0a20 2020 206e  plicas)""".    n
-000250a0: 616d 6520 3d20 5f67 6574 5f73 6572 7669  ame = _get_servi
-000250b0: 6365 5f6e 616d 6528 290a 0a20 2020 2074  ce_name()..    t
-000250c0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-000250d0: 2020 2020 6627 7465 7374 2d73 6b79 7365      f'test-skyse
-000250e0: 7276 652d 6661 7374 2d75 7064 6174 6527  rve-fast-update'
-000250f0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00025100: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
-00025110: 7276 6520 7570 202d 6e20 7b6e 616d 657d  rve up -n {name}
-00025120: 202d 7920 2d2d 636c 6f75 6420 7b67 656e   -y --cloud {gen
-00025130: 6572 6963 5f63 6c6f 7564 7d20 7465 7374  eric_cloud} test
-00025140: 732f 736b 7973 6572 7665 2f75 7064 6174  s/skyserve/updat
-00025150: 652f 6275 6d70 5f76 6572 7369 6f6e 5f62  e/bump_version_b
-00025160: 6566 6f72 652e 7961 6d6c 272c 0a20 2020  efore.yaml',.   
-00025170: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
-00025180: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
-00025190: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-000251a0: 652c 2072 6570 6c69 6361 5f6e 756d 3d32  e, replica_num=2
-000251b0: 292c 0a20 2020 2020 2020 2020 2020 2066  ),.            f
-000251c0: 277b 5f53 4552 5645 5f45 4e44 504f 494e  '{_SERVE_ENDPOIN
-000251d0: 545f 5741 4954 2e66 6f72 6d61 7428 6e61  T_WAIT.format(na
-000251e0: 6d65 3d6e 616d 6529 7d3b 2063 7572 6c20  me=name)}; curl 
-000251f0: 2d4c 2068 7474 703a 2f2f 2465 6e64 706f  -L http://$endpo
-00025200: 696e 7420 7c20 6772 6570 2022 4869 2c20  int | grep "Hi, 
-00025210: 536b 7950 696c 6f74 2068 6572 6522 272c  SkyPilot here"',
-00025220: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00025230: 6b79 2073 6572 7665 2075 7064 6174 6520  ky serve update 
-00025240: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
-00025250: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
-00025260: 2d6d 6f64 6520 626c 7565 5f67 7265 656e  -mode blue_green
-00025270: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
-00025280: 7665 2f75 7064 6174 652f 6275 6d70 5f76  ve/update/bump_v
-00025290: 6572 7369 6f6e 5f61 6674 6572 2e79 616d  ersion_after.yam
-000252a0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-000252b0: 2320 736c 6565 7020 746f 2077 6169 7420  # sleep to wait 
-000252c0: 666f 7220 7570 6461 7465 2074 6f20 6265  for update to be
-000252d0: 2072 6567 6973 7465 7265 642e 0a20 2020   registered..   
-000252e0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-000252f0: 3132 3027 2c0a 2020 2020 2020 2020 2020  120',.          
-00025300: 2020 2320 3220 6f6e 2d64 6561 6d6e 6420    # 2 on-deamnd 
-00025310: 2872 6561 6479 2920 2b20 3120 6f6e 2d64  (ready) + 1 on-d
-00025320: 656d 616e 6420 2870 726f 7669 7369 6f6e  emand (provision
-00025330: 696e 6729 2e0a 2020 2020 2020 2020 2020  ing)..          
-00025340: 2020 280a 2020 2020 2020 2020 2020 2020    (.            
-00025350: 2020 2020 5f63 6865 636b 5f72 6570 6c69      _check_repli
-00025360: 6361 5f69 6e5f 7374 6174 7573 280a 2020  ca_in_status(.  
-00025370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025380: 2020 6e61 6d65 2c20 5b28 322c 2046 616c    name, [(2, Fal
-00025390: 7365 2c20 2752 4541 4459 2729 2c0a 2020  se, 'READY'),.  
-000253a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000253b0: 2020 2020 2020 2020 2028 312c 2046 616c           (1, Fal
-000253c0: 7365 2c20 5f53 4552 5649 4345 5f4c 4155  se, _SERVICE_LAU
-000253d0: 4e43 4849 4e47 5f53 5441 5455 535f 5245  NCHING_STATUS_RE
-000253e0: 4745 5829 5d29 202b 0a20 2020 2020 2020  GEX)]) +.       
-000253f0: 2020 2020 2020 2020 2023 2046 6173 7420           # Fast 
-00025400: 7570 6461 7465 2077 696c 6c20 6469 7265  update will dire
-00025410: 6374 6c79 2068 6176 6520 7468 6520 6c61  ctly have the la
-00025420: 7465 7374 2076 6572 7369 6f6e 2072 6561  test version rea
-00025430: 6479 2e0a 2020 2020 2020 2020 2020 2020  dy..            
-00025440: 2020 2020 5f63 6865 636b 5f73 6572 7669      _check_servi
-00025450: 6365 5f76 6572 7369 6f6e 286e 616d 652c  ce_version(name,
-00025460: 2022 3222 2929 2c0a 2020 2020 2020 2020   "2")),.        
-00025470: 2020 2020 5f53 4552 5645 5f57 4149 545f      _SERVE_WAIT_
-00025480: 554e 5449 4c5f 5245 4144 592e 666f 726d  UNTIL_READY.form
-00025490: 6174 286e 616d 653d 6e61 6d65 2c20 7265  at(name=name, re
-000254a0: 706c 6963 615f 6e75 6d3d 3329 202b 0a20  plica_num=3) +. 
-000254b0: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
-000254c0: 6b5f 7365 7276 6963 655f 7665 7273 696f  k_service_versio
-000254d0: 6e28 6e61 6d65 2c20 2232 2229 2c0a 2020  n(name, "2"),.  
-000254e0: 2020 2020 2020 2020 2020 6627 7b5f 5345            f'{_SE
-000254f0: 5256 455f 454e 4450 4f49 4e54 5f57 4149  RVE_ENDPOINT_WAI
-00025500: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
-00025510: 6d65 297d 3b20 6375 726c 202d 4c20 6874  me)}; curl -L ht
-00025520: 7470 3a2f 2f24 656e 6470 6f69 6e74 207c  tp://$endpoint |
-00025530: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
-00025540: 6c6f 7420 6865 7265 2227 2c0a 2020 2020  lot here"',.    
-00025550: 2020 2020 2020 2020 2320 5465 7374 2072          # Test r
-00025560: 6f6c 6c69 6e67 2075 7064 6174 650a 2020  olling update.  
-00025570: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00025580: 7365 7276 6520 7570 6461 7465 207b 6e61  serve update {na
-00025590: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-000255a0: 6572 6963 5f63 6c6f 7564 7d20 2d79 2074  eric_cloud} -y t
-000255b0: 6573 7473 2f73 6b79 7365 7276 652f 7570  ests/skyserve/up
-000255c0: 6461 7465 2f62 756d 705f 7665 7273 696f  date/bump_versio
-000255d0: 6e5f 6265 666f 7265 2e79 616d 6c27 2c0a  n_before.yaml',.
-000255e0: 2020 2020 2020 2020 2020 2020 2320 736c              # sl
-000255f0: 6565 7020 746f 2077 6169 7420 666f 7220  eep to wait for 
-00025600: 7570 6461 7465 2074 6f20 6265 2072 6567  update to be reg
-00025610: 6973 7465 7265 642e 0a20 2020 2020 2020  istered..       
-00025620: 2020 2020 2027 736c 6565 7020 3330 272c       'sleep 30',
-00025630: 0a20 2020 2020 2020 2020 2020 2023 2032  .            # 2
-00025640: 206f 6e2d 6465 616d 6e64 2028 7265 6164   on-deamnd (read
-00025650: 7929 202b 2031 206f 6e2d 6465 6d61 6e64  y) + 1 on-demand
-00025660: 2028 7368 7574 7469 6e67 2064 6f77 6e29   (shutting down)
-00025670: 2e0a 2020 2020 2020 2020 2020 2020 5f63  ..            _c
-00025680: 6865 636b 5f72 6570 6c69 6361 5f69 6e5f  heck_replica_in_
-00025690: 7374 6174 7573 286e 616d 652c 205b 2832  status(name, [(2
-000256a0: 2c20 4661 6c73 652c 2027 5245 4144 5927  , False, 'READY'
-000256b0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-000256c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000256d0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-000256e0: 312c 2046 616c 7365 2c20 2753 4855 5454  1, False, 'SHUTT
-000256f0: 494e 475f 444f 574e 2729 5d29 2c0a 2020  ING_DOWN')]),.  
-00025700: 2020 2020 2020 2020 2020 5f53 4552 5645            _SERVE
-00025710: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
-00025720: 592e 666f 726d 6174 286e 616d 653d 6e61  Y.format(name=na
-00025730: 6d65 2c20 7265 706c 6963 615f 6e75 6d3d  me, replica_num=
-00025740: 3229 202b 0a20 2020 2020 2020 2020 2020  2) +.           
-00025750: 205f 6368 6563 6b5f 7365 7276 6963 655f   _check_service_
-00025760: 7665 7273 696f 6e28 6e61 6d65 2c20 2233  version(name, "3
-00025770: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-00025780: 6627 7b5f 5345 5256 455f 454e 4450 4f49  f'{_SERVE_ENDPOI
-00025790: 4e54 5f57 4149 542e 666f 726d 6174 286e  NT_WAIT.format(n
-000257a0: 616d 653d 6e61 6d65 297d 3b20 6375 726c  ame=name)}; curl
-000257b0: 202d 4c20 6874 7470 3a2f 2f24 656e 6470   -L http://$endp
-000257c0: 6f69 6e74 207c 2067 7265 7020 2248 692c  oint | grep "Hi,
-000257d0: 2053 6b79 5069 6c6f 7420 6865 7265 2227   SkyPilot here"'
-000257e0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-000257f0: 2020 2020 205f 5445 4152 444f 574e 5f53       _TEARDOWN_S
-00025800: 4552 5649 4345 2e66 6f72 6d61 7428 6e61  ERVICE.format(na
-00025810: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
-00025820: 2020 7469 6d65 6f75 743d 3330 202a 2036    timeout=30 * 6
-00025830: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
-00025840: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-00025850: 0a0a 4070 7974 6573 742e 6d61 726b 2e73  ..@pytest.mark.s
-00025860: 6572 7665 0a40 7079 7465 7374 2e6d 6172  erve.@pytest.mar
-00025870: 6b2e 6e6f 5f6b 7562 6572 6e65 7465 730a  k.no_kubernetes.
-00025880: 6465 6620 7465 7374 5f73 6b79 7365 7276  def test_skyserv
-00025890: 655f 7570 6461 7465 5f61 7574 6f73 6361  e_update_autosca
-000258a0: 6c65 2867 656e 6572 6963 5f63 6c6f 7564  le(generic_cloud
-000258b0: 3a20 7374 7229 3a0a 2020 2020 2222 2254  : str):.    """T
-000258c0: 6573 7420 736b 7973 6572 7665 2075 7064  est skyserve upd
-000258d0: 6174 6520 7769 7468 2061 7574 6f73 6361  ate with autosca
-000258e0: 6c65 2222 220a 2020 2020 6e61 6d65 203d  le""".    name =
-000258f0: 205f 6765 745f 7365 7276 6963 655f 6e61   _get_service_na
-00025900: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-00025910: 5465 7374 280a 2020 2020 2020 2020 6627  Test(.        f'
-00025920: 7465 7374 2d73 6b79 7365 7276 652d 7570  test-skyserve-up
-00025930: 6461 7465 2d61 7574 6f73 6361 6c65 272c  date-autoscale',
-00025940: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-00025950: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
-00025960: 7665 2075 7020 2d6e 207b 6e61 6d65 7d20  ve up -n {name} 
-00025970: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-00025980: 5f63 6c6f 7564 7d20 2d79 2074 6573 7473  _cloud} -y tests
-00025990: 2f73 6b79 7365 7276 652f 7570 6461 7465  /skyserve/update
-000259a0: 2f6e 756d 5f6d 696e 5f74 776f 2e79 616d  /num_min_two.yam
-000259b0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-000259c0: 5f53 4552 5645 5f57 4149 545f 554e 5449  _SERVE_WAIT_UNTI
-000259d0: 4c5f 5245 4144 592e 666f 726d 6174 286e  L_READY.format(n
-000259e0: 616d 653d 6e61 6d65 2c20 7265 706c 6963  ame=name, replic
-000259f0: 615f 6e75 6d3d 3229 202b 0a20 2020 2020  a_num=2) +.     
-00025a00: 2020 2020 2020 205f 6368 6563 6b5f 7365         _check_se
-00025a10: 7276 6963 655f 7665 7273 696f 6e28 6e61  rvice_version(na
-00025a20: 6d65 2c20 2231 2229 2c0a 2020 2020 2020  me, "1"),.      
-00025a30: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
-00025a40: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
-00025a50: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
-00025a60: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-00025a70: 2763 7572 6c20 2d4c 2068 7474 703a 2f2f  'curl -L http://
-00025a80: 2465 6e64 706f 696e 7420 7c20 6772 6570  $endpoint | grep
-00025a90: 2022 4869 2c20 536b 7950 696c 6f74 2068   "Hi, SkyPilot h
-00025aa0: 6572 6522 272c 0a20 2020 2020 2020 2020  ere"',.         
-00025ab0: 2020 2066 2773 6b79 2073 6572 7665 2075     f'sky serve u
-00025ac0: 7064 6174 6520 7b6e 616d 657d 202d 2d63  pdate {name} --c
-00025ad0: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-00025ae0: 6f75 647d 202d 2d6d 6f64 6520 626c 7565  oud} --mode blue
-00025af0: 5f67 7265 656e 202d 7920 7465 7374 732f  _green -y tests/
-00025b00: 736b 7973 6572 7665 2f75 7064 6174 652f  skyserve/update/
-00025b10: 6e75 6d5f 6d69 6e5f 6f6e 652e 7961 6d6c  num_min_one.yaml
-00025b20: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-00025b30: 2073 6c65 6570 2062 6566 6f72 6520 7570   sleep before up
-00025b40: 6461 7465 2069 7320 7265 6769 7374 6572  date is register
-00025b50: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-00025b60: 2773 6c65 6570 2032 3027 2c0a 2020 2020  'sleep 20',.    
-00025b70: 2020 2020 2020 2020 2320 5469 6d65 6f75          # Timeou
-00025b80: 7420 7769 6c6c 2062 6520 7472 6967 6765  t will be trigge
-00025b90: 7265 6420 7768 656e 2075 7064 6174 6520  red when update 
-00025ba0: 6661 696c 732e 0a20 2020 2020 2020 2020  fails..         
-00025bb0: 2020 205f 5345 5256 455f 5741 4954 5f55     _SERVE_WAIT_U
-00025bc0: 4e54 494c 5f52 4541 4459 2e66 6f72 6d61  NTIL_READY.forma
-00025bd0: 7428 6e61 6d65 3d6e 616d 652c 2072 6570  t(name=name, rep
-00025be0: 6c69 6361 5f6e 756d 3d31 2920 2b0a 2020  lica_num=1) +.  
-00025bf0: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
-00025c00: 5f73 6572 7669 6365 5f76 6572 7369 6f6e  _service_version
-00025c10: 286e 616d 652c 2022 3222 292c 0a20 2020  (name, "2"),.   
-00025c20: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
-00025c30: 5645 5f45 4e44 504f 494e 545f 5741 4954  VE_ENDPOINT_WAIT
-00025c40: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-00025c50: 6529 7d3b 2027 0a20 2020 2020 2020 2020  e)}; '.         
-00025c60: 2020 2027 6375 726c 202d 4c20 6874 7470     'curl -L http
-00025c70: 3a2f 2f24 656e 6470 6f69 6e74 207c 2067  ://$endpoint | g
-00025c80: 7265 7020 2248 692c 2053 6b79 5069 6c6f  rep "Hi, SkyPilo
-00025c90: 7420 6865 7265 2122 272c 0a20 2020 2020  t here!"',.     
-00025ca0: 2020 2020 2020 2023 2052 6f6c 6c69 6e67         # Rolling
-00025cb0: 2055 7064 6174 650a 2020 2020 2020 2020   Update.        
-00025cc0: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
-00025cd0: 7570 6461 7465 207b 6e61 6d65 7d20 2d2d  update {name} --
-00025ce0: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-00025cf0: 6c6f 7564 7d20 2d79 2074 6573 7473 2f73  loud} -y tests/s
-00025d00: 6b79 7365 7276 652f 7570 6461 7465 2f6e  kyserve/update/n
-00025d10: 756d 5f6d 696e 5f74 776f 2e79 616d 6c27  um_min_two.yaml'
-00025d20: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00025d30: 736c 6565 7020 6265 666f 7265 2075 7064  sleep before upd
-00025d40: 6174 6520 6973 2072 6567 6973 7465 7265  ate is registere
-00025d50: 642e 0a20 2020 2020 2020 2020 2020 2027  d..            '
-00025d60: 736c 6565 7020 3230 272c 0a20 2020 2020  sleep 20',.     
-00025d70: 2020 2020 2020 2023 2054 696d 656f 7574         # Timeout
-00025d80: 2077 696c 6c20 6265 2074 7269 6767 6572   will be trigger
-00025d90: 6564 2077 6865 6e20 7570 6461 7465 2066  ed when update f
-00025da0: 6169 6c73 2e0a 2020 2020 2020 2020 2020  ails..          
-00025db0: 2020 5f53 4552 5645 5f57 4149 545f 554e    _SERVE_WAIT_UN
-00025dc0: 5449 4c5f 5245 4144 592e 666f 726d 6174  TIL_READY.format
-00025dd0: 286e 616d 653d 6e61 6d65 2c20 7265 706c  (name=name, repl
-00025de0: 6963 615f 6e75 6d3d 3229 202b 0a20 2020  ica_num=2) +.   
-00025df0: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
-00025e00: 7365 7276 6963 655f 7665 7273 696f 6e28  service_version(
-00025e10: 6e61 6d65 2c20 2233 2229 2c0a 2020 2020  name, "3"),.    
-00025e20: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
-00025e30: 455f 454e 4450 4f49 4e54 5f57 4149 542e  E_ENDPOINT_WAIT.
-00025e40: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-00025e50: 297d 3b20 270a 2020 2020 2020 2020 2020  )}; '.          
-00025e60: 2020 2763 7572 6c20 2d4c 2068 7474 703a    'curl -L http:
-00025e70: 2f2f 2465 6e64 706f 696e 7420 7c20 6772  //$endpoint | gr
-00025e80: 6570 2022 4869 2c20 536b 7950 696c 6f74  ep "Hi, SkyPilot
-00025e90: 2068 6572 6521 2227 2c0a 2020 2020 2020   here!"',.      
-00025ea0: 2020 5d2c 0a20 2020 2020 2020 205f 5445    ],.        _TE
-00025eb0: 4152 444f 574e 5f53 4552 5649 4345 2e66  ARDOWN_SERVICE.f
-00025ec0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
-00025ed0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-00025ee0: 743d 3330 202a 2036 302c 0a20 2020 2029  t=30 * 60,.    )
-00025ef0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00025f00: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00025f10: 742e 6d61 726b 2e73 6572 7665 0a40 7079  t.mark.serve.@py
-00025f20: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
-00025f30: 7472 697a 6528 276d 6f64 6527 2c20 5b27  trize('mode', ['
-00025f40: 726f 6c6c 696e 6727 2c20 2762 6c75 655f  rolling', 'blue_
-00025f50: 6772 6565 6e27 5d29 0a40 7079 7465 7374  green']).@pytest
-00025f60: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
-00025f70: 7465 730a 6465 6620 7465 7374 5f73 6b79  tes.def test_sky
-00025f80: 7365 7276 655f 6e65 775f 6175 746f 7363  serve_new_autosc
-00025f90: 616c 6572 5f75 7064 6174 6528 6d6f 6465  aler_update(mode
-00025fa0: 3a20 7374 722c 2067 656e 6572 6963 5f63  : str, generic_c
-00025fb0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-00025fc0: 2222 2254 6573 7420 736b 7973 6572 7665  """Test skyserve
-00025fd0: 2077 6974 6820 7570 6461 7465 2074 6861   with update tha
-00025fe0: 7420 6368 616e 6765 7320 6175 746f 7363  t changes autosc
-00025ff0: 616c 6572 2222 220a 2020 2020 6e61 6d65  aler""".    name
-00026000: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
-00026010: 6e61 6d65 2829 202b 206d 6f64 650a 0a20  name() + mode.. 
-00026020: 2020 2066 6f75 725f 7370 6f74 5f75 705f     four_spot_up_
-00026030: 636d 6420 3d20 5f63 6865 636b 5f72 6570  cmd = _check_rep
-00026040: 6c69 6361 5f69 6e5f 7374 6174 7573 286e  lica_in_status(n
-00026050: 616d 652c 205b 2834 2c20 5472 7565 2c20  ame, [(4, True, 
-00026060: 2752 4541 4459 2729 5d29 0a20 2020 2075  'READY')]).    u
-00026070: 7064 6174 655f 6368 6563 6b20 3d20 5b66  pdate_check = [f
-00026080: 2775 6e74 696c 2028 7b66 6f75 725f 7370  'until ({four_sp
-00026090: 6f74 5f75 705f 636d 647d 293b 2064 6f20  ot_up_cmd}); do 
-000260a0: 736c 6565 7020 353b 2064 6f6e 653b 2073  sleep 5; done; s
-000260b0: 6c65 6570 2031 303b 275d 0a20 2020 2069  leep 10;'].    i
-000260c0: 6620 6d6f 6465 203d 3d20 2772 6f6c 6c69  f mode == 'rolli
-000260d0: 6e67 273a 0a20 2020 2020 2020 2023 2043  ng':.        # C
-000260e0: 6865 636b 2072 6f6c 6c69 6e67 2075 7064  heck rolling upd
-000260f0: 6174 652c 2069 7420 7769 6c6c 2074 6572  ate, it will ter
-00026100: 6d69 6e61 7465 206f 6e65 206f 6620 7468  minate one of th
-00026110: 6520 6f6c 6420 6f6e 2d64 656d 616e 640a  e old on-demand.
-00026120: 2020 2020 2020 2020 2320 696e 7374 616e          # instan
-00026130: 6365 732c 206f 6e63 6520 7468 6572 6520  ces, once there 
-00026140: 6172 6520 3420 7370 6f74 2069 6e73 7461  are 4 spot insta
-00026150: 6e63 6520 7265 6164 792e 0a20 2020 2020  nce ready..     
-00026160: 2020 2075 7064 6174 655f 6368 6563 6b20     update_check 
-00026170: 2b3d 205b 0a20 2020 2020 2020 2020 2020  += [.           
-00026180: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
-00026190: 696e 5f73 7461 7475 7328 0a20 2020 2020  in_status(.     
-000261a0: 2020 2020 2020 2020 2020 206e 616d 652c             name,
-000261b0: 205b 2831 2c20 4661 6c73 652c 205f 5345   [(1, False, _SE
-000261c0: 5256 4943 455f 4c41 554e 4348 494e 475f  RVICE_LAUNCHING_
-000261d0: 5354 4154 5553 5f52 4547 4558 292c 0a20  STATUS_REGEX),. 
-000261e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000261f0: 2020 2020 2020 2831 2c20 4661 6c73 652c        (1, False,
-00026200: 2027 5348 5554 5449 4e47 5f44 4f57 4e27   'SHUTTING_DOWN'
-00026210: 292c 2028 312c 2046 616c 7365 2c20 2752  ), (1, False, 'R
-00026220: 4541 4459 2729 5d29 202b 0a20 2020 2020  EADY')]) +.     
-00026230: 2020 2020 2020 205f 6368 6563 6b5f 7365         _check_se
-00026240: 7276 6963 655f 7665 7273 696f 6e28 6e61  rvice_version(na
-00026250: 6d65 2c20 2231 2c32 2229 2c0a 2020 2020  me, "1,2"),.    
-00026260: 2020 2020 5d0a 2020 2020 656c 7365 3a0a      ].    else:.
-00026270: 2020 2020 2020 2020 2320 4368 6563 6b20          # Check 
-00026280: 626c 7565 2067 7265 656e 2075 7064 6174  blue green updat
-00026290: 652c 2069 7420 7769 6c6c 206b 6565 7020  e, it will keep 
-000262a0: 626f 7468 206f 6c64 206f 6e2d 6465 6d61  both old on-dema
-000262b0: 6e64 2069 6e73 7461 6e63 6573 0a20 2020  nd instances.   
-000262c0: 2020 2020 2023 2072 756e 6e69 6e67 2c20       # running, 
-000262d0: 6f6e 6365 2074 6865 7265 2061 7265 2034  once there are 4
-000262e0: 2073 706f 7420 696e 7374 616e 6365 2072   spot instance r
-000262f0: 6561 6479 2e0a 2020 2020 2020 2020 7570  eady..        up
-00026300: 6461 7465 5f63 6865 636b 202b 3d20 5b0a  date_check += [.
-00026310: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
-00026320: 636b 5f72 6570 6c69 6361 5f69 6e5f 7374  ck_replica_in_st
-00026330: 6174 7573 280a 2020 2020 2020 2020 2020  atus(.          
-00026340: 2020 2020 2020 6e61 6d65 2c20 5b28 312c        name, [(1,
-00026350: 2046 616c 7365 2c20 5f53 4552 5649 4345   False, _SERVICE
-00026360: 5f4c 4155 4e43 4849 4e47 5f53 5441 5455  _LAUNCHING_STATU
-00026370: 535f 5245 4745 5829 2c0a 2020 2020 2020  S_REGEX),.      
-00026380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026390: 2028 322c 2046 616c 7365 2c20 2752 4541   (2, False, 'REA
-000263a0: 4459 2729 5d29 202b 0a20 2020 2020 2020  DY')]) +.       
-000263b0: 2020 2020 205f 6368 6563 6b5f 7365 7276       _check_serv
-000263c0: 6963 655f 7665 7273 696f 6e28 6e61 6d65  ice_version(name
-000263d0: 2c20 2231 2229 2c0a 2020 2020 2020 2020  , "1"),.        
-000263e0: 5d0a 2020 2020 7465 7374 203d 2054 6573  ].    test = Tes
-000263f0: 7428 0a20 2020 2020 2020 2027 7465 7374  t(.        'test
-00026400: 2d73 6b79 7365 7276 652d 6e65 772d 6175  -skyserve-new-au
-00026410: 746f 7363 616c 6572 2d75 7064 6174 6527  toscaler-update'
-00026420: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00026430: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
-00026440: 7276 6520 7570 202d 6e20 7b6e 616d 657d  rve up -n {name}
-00026450: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-00026460: 635f 636c 6f75 647d 202d 7920 7465 7374  c_cloud} -y test
-00026470: 732f 736b 7973 6572 7665 2f75 7064 6174  s/skyserve/updat
-00026480: 652f 6e65 775f 6175 746f 7363 616c 6572  e/new_autoscaler
-00026490: 5f62 6566 6f72 652e 7961 6d6c 272c 0a20  _before.yaml',. 
-000264a0: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
-000264b0: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
-000264c0: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
-000264d0: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
-000264e0: 3d32 2920 2b0a 2020 2020 2020 2020 2020  =2) +.          
-000264f0: 2020 5f63 6865 636b 5f73 6572 7669 6365    _check_service
-00026500: 5f76 6572 7369 6f6e 286e 616d 652c 2022  _version(name, "
-00026510: 3122 292c 0a20 2020 2020 2020 2020 2020  1"),.           
-00026520: 2066 277b 5f53 4552 5645 5f45 4e44 504f   f'{_SERVE_ENDPO
-00026530: 494e 545f 5741 4954 2e66 6f72 6d61 7428  INT_WAIT.format(
-00026540: 6e61 6d65 3d6e 616d 6529 7d3b 2027 0a20  name=name)}; '. 
-00026550: 2020 2020 2020 2020 2020 2027 733d 2428             's=$(
-00026560: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
-00026570: 656e 6470 6f69 6e74 293b 2065 6368 6f20  endpoint); echo 
-00026580: 2224 7322 3b20 6563 686f 2022 2473 2220  "$s"; echo "$s" 
-00026590: 7c20 6772 6570 2022 4869 2c20 536b 7950  | grep "Hi, SkyP
-000265a0: 696c 6f74 2068 6572 6522 272c 0a20 2020  ilot here"',.   
-000265b0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-000265c0: 6572 7665 2075 7064 6174 6520 7b6e 616d  erve update {nam
-000265d0: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
-000265e0: 7269 635f 636c 6f75 647d 202d 2d6d 6f64  ric_cloud} --mod
-000265f0: 6520 7b6d 6f64 657d 202d 7920 7465 7374  e {mode} -y test
-00026600: 732f 736b 7973 6572 7665 2f75 7064 6174  s/skyserve/updat
-00026610: 652f 6e65 775f 6175 746f 7363 616c 6572  e/new_autoscaler
-00026620: 5f61 6674 6572 2e79 616d 6c27 2c0a 2020  _after.yaml',.  
-00026630: 2020 2020 2020 2020 2020 2320 5761 6974            # Wait
-00026640: 2066 6f72 2075 7064 6174 6520 746f 2062   for update to b
-00026650: 6520 7265 6769 7374 6572 6564 0a20 2020  e registered.   
-00026660: 2020 2020 2020 2020 2066 2773 6c65 6570           f'sleep
-00026670: 2031 3230 272c 0a20 2020 2020 2020 2020   120',.         
-00026680: 2020 205f 6368 6563 6b5f 7265 706c 6963     _check_replic
-00026690: 615f 696e 5f73 7461 7475 7328 0a20 2020  a_in_status(.   
-000266a0: 2020 2020 2020 2020 2020 2020 206e 616d               nam
-000266b0: 652c 205b 2834 2c20 5472 7565 2c20 5f53  e, [(4, True, _S
-000266c0: 4552 5649 4345 5f4c 4155 4e43 4849 4e47  ERVICE_LAUNCHING
-000266d0: 5f53 5441 5455 535f 5245 4745 5820 2b20  _STATUS_REGEX + 
-000266e0: 275c 7c52 4541 4459 2729 2c0a 2020 2020  '\|READY'),.    
-000266f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026700: 2020 2028 312c 2046 616c 7365 2c20 5f53     (1, False, _S
-00026710: 4552 5649 4345 5f4c 4155 4e43 4849 4e47  ERVICE_LAUNCHING
-00026720: 5f53 5441 5455 535f 5245 4745 5829 2c0a  _STATUS_REGEX),.
-00026730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026740: 2020 2020 2020 2028 322c 2046 616c 7365         (2, False
-00026750: 2c20 2752 4541 4459 2729 5d29 2c0a 2020  , 'READY')]),.  
-00026760: 2020 2020 2020 2020 2020 2a75 7064 6174            *updat
-00026770: 655f 6368 6563 6b2c 0a20 2020 2020 2020  e_check,.       
-00026780: 2020 2020 205f 5345 5256 455f 5741 4954       _SERVE_WAIT
-00026790: 5f55 4e54 494c 5f52 4541 4459 2e66 6f72  _UNTIL_READY.for
-000267a0: 6d61 7428 6e61 6d65 3d6e 616d 652c 2072  mat(name=name, r
-000267b0: 6570 6c69 6361 5f6e 756d 3d35 292c 0a20  eplica_num=5),. 
-000267c0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-000267d0: 4552 5645 5f45 4e44 504f 494e 545f 5741  ERVE_ENDPOINT_WA
-000267e0: 4954 2e66 6f72 6d61 7428 6e61 6d65 3d6e  IT.format(name=n
-000267f0: 616d 6529 7d3b 2027 0a20 2020 2020 2020  ame)}; '.       
-00026800: 2020 2020 2027 6375 726c 202d 4c20 6874       'curl -L ht
-00026810: 7470 3a2f 2f24 656e 6470 6f69 6e74 207c  tp://$endpoint |
-00026820: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
-00026830: 6c6f 7420 6865 7265 2227 2c0a 2020 2020  lot here"',.    
-00026840: 2020 2020 2020 2020 5f63 6865 636b 5f72          _check_r
-00026850: 6570 6c69 6361 5f69 6e5f 7374 6174 7573  eplica_in_status
-00026860: 286e 616d 652c 205b 2834 2c20 5472 7565  (name, [(4, True
-00026870: 2c20 2752 4541 4459 2729 2c0a 2020 2020  , 'READY'),.    
-00026880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000268a0: 2020 2020 2020 2020 2831 2c20 4661 6c73          (1, Fals
-000268b0: 652c 2027 5245 4144 5927 295d 292c 0a20  e, 'READY')]),. 
-000268c0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-000268d0: 2020 5f54 4541 5244 4f57 4e5f 5345 5256    _TEARDOWN_SERV
-000268e0: 4943 452e 666f 726d 6174 286e 616d 653d  ICE.format(name=
-000268f0: 6e61 6d65 292c 0a20 2020 2020 2020 2074  name),.        t
-00026900: 696d 656f 7574 3d32 3020 2a20 3630 2c0a  imeout=20 * 60,.
-00026910: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00026920: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00026930: 7079 7465 7374 2e6d 6172 6b2e 7365 7276  pytest.mark.serv
-00026940: 650a 6465 6620 7465 7374 5f73 6b79 7365  e.def test_skyse
-00026950: 7276 655f 6661 696c 7572 6573 2867 656e  rve_failures(gen
-00026960: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-00026970: 3a0a 2020 2020 2222 2254 6573 7420 7265  :.    """Test re
-00026980: 706c 6963 6120 6661 696c 7572 6520 7374  plica failure st
-00026990: 6174 7573 6573 2222 220a 2020 2020 6e61  atuses""".    na
-000269a0: 6d65 203d 205f 6765 745f 7365 7276 6963  me = _get_servic
-000269b0: 655f 6e61 6d65 2829 0a0a 2020 2020 7465  e_name()..    te
-000269c0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-000269d0: 2020 2027 7465 7374 2d73 6b79 7365 7276     'test-skyserv
-000269e0: 652d 6661 696c 7572 6573 272c 0a20 2020  e-failures',.   
-000269f0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00026a00: 2020 2066 2773 6b79 2073 6572 7665 2075     f'sky serve u
-00026a10: 7020 2d6e 207b 6e61 6d65 7d20 2d2d 636c  p -n {name} --cl
-00026a20: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-00026a30: 7564 7d20 2d79 2074 6573 7473 2f73 6b79  ud} -y tests/sky
-00026a40: 7365 7276 652f 6661 696c 7572 6573 2f69  serve/failures/i
-00026a50: 6e69 7469 616c 5f64 656c 6179 2e79 616d  nitial_delay.yam
-00026a60: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00026a70: 6627 733d 2428 736b 7920 7365 7276 6520  f's=$(sky serve 
-00026a80: 7374 6174 7573 207b 6e61 6d65 7d29 3b20  status {name}); 
-00026a90: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
-00026aa0: 756e 7469 6c20 6563 686f 2022 2473 2220  until echo "$s" 
-00026ab0: 7c20 6772 6570 2022 4641 494c 4544 5f49  | grep "FAILED_I
-00026ac0: 4e49 5449 414c 5f44 454c 4159 223b 2064  NITIAL_DELAY"; d
-00026ad0: 6f20 270a 2020 2020 2020 2020 2020 2020  o '.            
-00026ae0: 2765 6368 6f20 2257 6169 7469 6e67 2066  'echo "Waiting f
-00026af0: 6f72 2072 6570 6c69 6361 2074 6f20 6265  or replica to be
-00026b00: 2066 6169 6c65 642e 2e2e 223b 2073 6c65   failed..."; sle
-00026b10: 6570 2035 3b20 270a 2020 2020 2020 2020  ep 5; '.        
-00026b20: 2020 2020 6627 733d 2428 736b 7920 7365      f's=$(sky se
-00026b30: 7276 6520 7374 6174 7573 207b 6e61 6d65  rve status {name
-00026b40: 7d29 3b20 6563 686f 2022 2473 223b 2064  }); echo "$s"; d
-00026b50: 6f6e 653b 272c 0a20 2020 2020 2020 2020  one;',.         
-00026b60: 2020 2027 736c 6565 7020 3630 272c 0a20     'sleep 60',. 
-00026b70: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00026b80: 4552 5645 5f53 5441 5455 535f 5741 4954  ERVE_STATUS_WAIT
-00026b90: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-00026ba0: 6529 7d3b 2065 6368 6f20 2224 7322 207c  e)}; echo "$s" |
-00026bb0: 2067 7265 7020 227b 6e61 6d65 7d22 207c   grep "{name}" |
-00026bc0: 2067 7265 7020 2246 4149 4c45 445f 494e   grep "FAILED_IN
-00026bd0: 4954 4941 4c5f 4445 4c41 5922 207c 2077  ITIAL_DELAY" | w
-00026be0: 6320 2d6c 207c 2067 7265 7020 323b 2027  c -l | grep 2; '
-00026bf0: 0a20 2020 2020 2020 2020 2020 2023 204d  .            # M
-00026c00: 616b 6520 7375 7265 206e 6f20 6e65 7720  ake sure no new 
-00026c10: 7265 706c 6963 6173 2061 7265 2073 7461  replicas are sta
-00026c20: 7274 6564 2066 6f72 2065 6172 6c79 2066  rted for early f
-00026c30: 6169 6c75 7265 2e0a 2020 2020 2020 2020  ailure..        
-00026c40: 2020 2020 6627 6563 686f 2022 2473 2220      f'echo "$s" 
-00026c50: 7c20 6772 6570 202d 4120 3130 3020 2253  | grep -A 100 "S
-00026c60: 6572 7669 6365 2052 6570 6c69 6361 7322  ervice Replicas"
-00026c70: 207c 2067 7265 7020 227b 6e61 6d65 7d22   | grep "{name}"
-00026c80: 207c 2077 6320 2d6c 207c 2067 7265 7020   | wc -l | grep 
-00026c90: 323b 272c 0a20 2020 2020 2020 2020 2020  2;',.           
-00026ca0: 2066 2773 6b79 2073 6572 7665 2075 7064   f'sky serve upd
-00026cb0: 6174 6520 7b6e 616d 657d 202d 2d63 6c6f  ate {name} --clo
-00026cc0: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
-00026cd0: 647d 202d 7920 7465 7374 732f 736b 7973  d} -y tests/skys
-00026ce0: 6572 7665 2f66 6169 6c75 7265 732f 7072  erve/failures/pr
-00026cf0: 6f62 696e 672e 7961 6d6c 272c 0a20 2020  obing.yaml',.   
-00026d00: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-00026d10: 6b79 2073 6572 7665 2073 7461 7475 7320  ky serve status 
-00026d20: 7b6e 616d 657d 293b 2027 0a20 2020 2020  {name}); '.     
-00026d30: 2020 2020 2020 2023 2057 6169 7420 666f         # Wait fo
-00026d40: 7220 7265 706c 6963 6120 746f 2062 6520  r replica to be 
-00026d50: 7265 6164 792e 0a20 2020 2020 2020 2020  ready..         
-00026d60: 2020 2066 2775 6e74 696c 2065 6368 6f20     f'until echo 
-00026d70: 2224 7322 207c 2067 7265 7020 2252 4541  "$s" | grep "REA
-00026d80: 4459 223b 2064 6f20 270a 2020 2020 2020  DY"; do '.      
-00026d90: 2020 2020 2020 2765 6368 6f20 2257 6169        'echo "Wai
-00026da0: 7469 6e67 2066 6f72 2072 6570 6c69 6361  ting for replica
-00026db0: 2074 6f20 6265 2066 6169 6c65 642e 2e2e   to be failed...
-00026dc0: 223b 2073 6c65 6570 2035 3b20 270a 2020  "; sleep 5; '.  
-00026dd0: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-00026de0: 736b 7920 7365 7276 6520 7374 6174 7573  sky serve status
-00026df0: 207b 6e61 6d65 7d29 3b20 6563 686f 2022   {name}); echo "
-00026e00: 2473 223b 2064 6f6e 653b 272c 0a20 2020  $s"; done;',.   
-00026e10: 2020 2020 2020 2020 2023 2057 6169 7420           # Wait 
-00026e20: 666f 7220 7265 706c 6963 6120 746f 2063  for replica to c
-00026e30: 6861 6e67 6520 746f 2046 4149 4c45 445f  hange to FAILED_
-00026e40: 5052 4f42 494e 470a 2020 2020 2020 2020  PROBING.        
-00026e50: 2020 2020 6627 733d 2428 736b 7920 7365      f's=$(sky se
-00026e60: 7276 6520 7374 6174 7573 207b 6e61 6d65  rve status {name
-00026e70: 7d29 3b20 270a 2020 2020 2020 2020 2020  }); '.          
-00026e80: 2020 6627 756e 7469 6c20 6563 686f 2022    f'until echo "
-00026e90: 2473 2220 7c20 6772 6570 2022 4641 494c  $s" | grep "FAIL
-00026ea0: 4544 5f50 524f 4249 4e47 223b 2064 6f20  ED_PROBING"; do 
-00026eb0: 270a 2020 2020 2020 2020 2020 2020 2765  '.            'e
-00026ec0: 6368 6f20 2257 6169 7469 6e67 2066 6f72  cho "Waiting for
-00026ed0: 2072 6570 6c69 6361 2074 6f20 6265 2066   replica to be f
-00026ee0: 6169 6c65 642e 2e2e 223b 2073 6c65 6570  ailed..."; sleep
-00026ef0: 2035 3b20 270a 2020 2020 2020 2020 2020   5; '.          
-00026f00: 2020 6627 733d 2428 736b 7920 7365 7276    f's=$(sky serv
-00026f10: 6520 7374 6174 7573 207b 6e61 6d65 7d29  e status {name})
-00026f20: 3b20 6563 686f 2022 2473 223b 2064 6f6e  ; echo "$s"; don
-00026f30: 653b 2720 2b0a 2020 2020 2020 2020 2020  e;' +.          
-00026f40: 2020 5f63 6865 636b 5f72 6570 6c69 6361    _check_replica
-00026f50: 5f69 6e5f 7374 6174 7573 280a 2020 2020  _in_status(.    
-00026f60: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-00026f70: 2c20 5b28 312c 2046 616c 7365 2c20 2746  , [(1, False, 'F
-00026f80: 4149 4c45 445f 5052 4f42 494e 4727 292c  AILED_PROBING'),
-00026f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00026fa0: 2020 2020 2020 2020 2831 2c20 4661 6c73          (1, Fals
-00026fb0: 652c 205f 5345 5256 4943 455f 4c41 554e  e, _SERVICE_LAUN
-00026fc0: 4348 494e 475f 5354 4154 5553 5f52 4547  CHING_STATUS_REG
-00026fd0: 4558 295d 292c 0a20 2020 2020 2020 2020  EX)]),.         
-00026fe0: 2020 2023 2054 4f44 4f28 7a68 7775 293a     # TODO(zhwu):
-00026ff0: 2061 6464 2074 6573 7420 666f 7220 4641   add test for FA
-00027000: 494c 4544 5f50 524f 5649 5349 4f4e 0a20  ILED_PROVISION. 
-00027010: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00027020: 2020 5f54 4541 5244 4f57 4e5f 5345 5256    _TEARDOWN_SERV
-00027030: 4943 452e 666f 726d 6174 286e 616d 653d  ICE.format(name=
-00027040: 6e61 6d65 292c 0a20 2020 2020 2020 2074  name),.        t
-00027050: 696d 656f 7574 3d32 3020 2a20 3630 2c0a  imeout=20 * 60,.
-00027060: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00027070: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
-00027080: 2054 4f44 4f28 5a69 6d69 6e67 2c20 5469   TODO(Ziming, Ti
-00027090: 616e 293a 2041 6464 2074 6573 7473 2066  an): Add tests f
-000270a0: 6f72 2061 7574 6f73 6361 6c69 6e67 2e0a  or autoscaling..
-000270b0: 0a0a 2320 2d2d 2d2d 2d2d 2d20 5465 7374  ..# ------- Test
-000270c0: 696e 6720 7573 6572 2072 6179 2063 6c75  ing user ray clu
-000270d0: 7374 6572 202d 2d2d 2d2d 2d2d 2d0a 6465  ster --------.de
-000270e0: 6620 7465 7374 5f75 7365 725f 7261 795f  f test_user_ray_
-000270f0: 636c 7573 7465 7228 6765 6e65 7269 635f  cluster(generic_
-00027100: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
-00027110: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00027120: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00027130: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00027140: 2020 2020 2027 7573 6572 2d72 6179 2d63       'user-ray-c
-00027150: 6c75 7374 6572 272c 0a20 2020 2020 2020  luster',.       
-00027160: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00027170: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00027180: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-00027190: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-000271a0: 2022 7261 7920 7374 6172 7420 2d2d 6865   "ray start --he
-000271b0: 6164 2227 2c0a 2020 2020 2020 2020 2020  ad"',.          
-000271c0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-000271d0: 6d65 7d20 2265 6368 6f20 6869 2227 2c0a  me} "echo hi"',.
-000271e0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000271f0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-00027200: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00027210: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
-00027220: 7475 7320 2d72 207b 6e61 6d65 7d20 7c20  tus -r {name} | 
-00027230: 6772 6570 2055 5027 2c0a 2020 2020 2020  grep UP',.      
-00027240: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-00027250: 207b 6e61 6d65 7d20 2265 6368 6f20 6279   {name} "echo by
-00027260: 6522 272c 0a20 2020 2020 2020 2020 2020  e"',.           
-00027270: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00027280: 657d 2032 202d 2d73 7461 7475 7327 2c0a  e} 2 --status',.
-00027290: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-000272a0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-000272b0: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
-000272c0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-000272d0: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
-000272e0: 2d2d 2054 6573 7469 6e67 2074 6865 2063  -- Testing the c
-000272f0: 6f72 6520 4150 4920 2d2d 2d2d 2d2d 2d2d  ore API --------
-00027300: 0a23 204d 6f73 7420 6f66 2074 6865 2063  .# Most of the c
-00027310: 6f72 6520 4150 4973 2068 6176 6520 6265  ore APIs have be
-00027320: 656e 2074 6573 7465 6420 696e 2074 6865  en tested in the
-00027330: 2043 4c49 2074 6573 7473 2e0a 2320 5468   CLI tests..# Th
-00027340: 6573 6520 7465 7374 7320 6172 6520 666f  ese tests are fo
-00027350: 7220 7465 7374 696e 6720 7468 6520 7265  r testing the re
-00027360: 7475 726e 2076 616c 7565 206f 6620 7468  turn value of th
-00027370: 6520 4150 4973 206e 6f74 2066 756c 6c79  e APIs not fully
-00027380: 2075 7365 6420 696e 2043 4c49 2e0a 0a0a   used in CLI....
-00027390: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
-000273a0: 0a64 6566 2074 6573 745f 636f 7265 5f61  .def test_core_a
-000273b0: 7069 5f73 6b79 5f6c 6175 6e63 685f 6578  pi_sky_launch_ex
-000273c0: 6563 2829 3a0a 2020 2020 6e61 6d65 203d  ec():.    name =
-000273d0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-000273e0: 6d65 2829 0a20 2020 2074 6173 6b20 3d20  me().    task = 
-000273f0: 736b 792e 5461 736b 2872 756e 3d22 7768  sky.Task(run="wh
-00027400: 6f61 6d69 2229 0a20 2020 2074 6173 6b2e  oami").    task.
-00027410: 7365 745f 7265 736f 7572 6365 7328 736b  set_resources(sk
-00027420: 792e 5265 736f 7572 6365 7328 636c 6f75  y.Resources(clou
-00027430: 643d 736b 792e 4743 5028 2929 290a 2020  d=sky.GCP())).  
-00027440: 2020 6a6f 625f 6964 2c20 6861 6e64 6c65    job_id, handle
-00027450: 203d 2073 6b79 2e6c 6175 6e63 6828 7461   = sky.launch(ta
-00027460: 736b 2c20 636c 7573 7465 725f 6e61 6d65  sk, cluster_name
-00027470: 3d6e 616d 6529 0a20 2020 2061 7373 6572  =name).    asser
-00027480: 7420 6a6f 625f 6964 203d 3d20 310a 2020  t job_id == 1.  
-00027490: 2020 6173 7365 7274 2068 616e 646c 6520    assert handle 
-000274a0: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
-000274b0: 6173 7365 7274 2068 616e 646c 652e 636c  assert handle.cl
-000274c0: 7573 7465 725f 6e61 6d65 203d 3d20 6e61  uster_name == na
-000274d0: 6d65 0a20 2020 2061 7373 6572 7420 6861  me.    assert ha
-000274e0: 6e64 6c65 2e6c 6175 6e63 6865 645f 7265  ndle.launched_re
-000274f0: 736f 7572 6365 732e 636c 6f75 642e 6973  sources.cloud.is
-00027500: 5f73 616d 655f 636c 6f75 6428 736b 792e  _same_cloud(sky.
-00027510: 4743 5028 2929 0a20 2020 206a 6f62 5f69  GCP()).    job_i
-00027520: 645f 6578 6563 2c20 6861 6e64 6c65 5f65  d_exec, handle_e
-00027530: 7865 6320 3d20 736b 792e 6578 6563 2874  xec = sky.exec(t
-00027540: 6173 6b2c 2063 6c75 7374 6572 5f6e 616d  ask, cluster_nam
-00027550: 653d 6e61 6d65 290a 2020 2020 6173 7365  e=name).    asse
-00027560: 7274 206a 6f62 5f69 645f 6578 6563 203d  rt job_id_exec =
-00027570: 3d20 320a 2020 2020 6173 7365 7274 2068  = 2.    assert h
-00027580: 616e 646c 655f 6578 6563 2069 7320 6e6f  andle_exec is no
-00027590: 7420 4e6f 6e65 0a20 2020 2061 7373 6572  t None.    asser
-000275a0: 7420 6861 6e64 6c65 5f65 7865 632e 636c  t handle_exec.cl
-000275b0: 7573 7465 725f 6e61 6d65 203d 3d20 6e61  uster_name == na
-000275c0: 6d65 0a20 2020 2061 7373 6572 7420 6861  me.    assert ha
-000275d0: 6e64 6c65 5f65 7865 632e 6c61 756e 6368  ndle_exec.launch
-000275e0: 6564 5f72 6573 6f75 7263 6573 2e63 6c6f  ed_resources.clo
-000275f0: 7564 2e69 735f 7361 6d65 5f63 6c6f 7564  ud.is_same_cloud
-00027600: 2873 6b79 2e47 4350 2829 290a 2020 2020  (sky.GCP()).    
-00027610: 2320 466f 7220 6475 6d6d 7920 7461 736b  # For dummy task
-00027620: 2028 692e 652e 2074 6173 6b2e 7275 6e20   (i.e. task.run 
-00027630: 6973 204e 6f6e 6529 2c20 7468 6520 6a6f  is None), the jo
-00027640: 6220 776f 6e27 7420 6265 2073 7562 6d69  b won't be submi
-00027650: 7474 6564 2e0a 2020 2020 6475 6d6d 795f  tted..    dummy_
-00027660: 7461 736b 203d 2073 6b79 2e54 6173 6b28  task = sky.Task(
-00027670: 290a 2020 2020 6a6f 625f 6964 5f64 756d  ).    job_id_dum
-00027680: 6d79 2c20 5f20 3d20 736b 792e 6578 6563  my, _ = sky.exec
-00027690: 2864 756d 6d79 5f74 6173 6b2c 2063 6c75  (dummy_task, clu
-000276a0: 7374 6572 5f6e 616d 653d 6e61 6d65 290a  ster_name=name).
-000276b0: 2020 2020 6173 7365 7274 206a 6f62 5f69      assert job_i
-000276c0: 645f 6475 6d6d 7920 6973 204e 6f6e 650a  d_dummy is None.
-000276d0: 2020 2020 736b 792e 646f 776e 286e 616d      sky.down(nam
-000276e0: 6529 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  e)...# ---------
-000276f0: 2d20 5465 7374 696e 6720 5374 6f72 6167  - Testing Storag
-00027700: 6520 2d2d 2d2d 2d2d 2d2d 2d2d 0a63 6c61  e ----------.cla
-00027710: 7373 2054 6573 7453 746f 7261 6765 5769  ss TestStorageWi
-00027720: 7468 4372 6564 656e 7469 616c 733a 0a20  thCredentials:. 
-00027730: 2020 2022 2222 5374 6f72 6167 6520 7465     """Storage te
-00027740: 7374 7320 7768 6963 6820 7265 7175 6972  sts which requir
-00027750: 6520 6372 6564 656e 7469 616c 7320 616e  e credentials an
-00027760: 6420 6e65 7477 6f72 6b20 636f 6e6e 6563  d network connec
-00027770: 7469 6f6e 2222 220a 0a20 2020 2041 5753  tion"""..    AWS
-00027780: 5f49 4e56 414c 4944 5f4e 414d 4553 203d  _INVALID_NAMES =
-00027790: 205b 0a20 2020 2020 2020 2027 6162 272c   [.        'ab',
-000277a0: 2020 2320 6c65 7373 2074 6861 6e20 3320    # less than 3 
-000277b0: 6368 6172 6163 7465 7273 0a20 2020 2020  characters.     
-000277c0: 2020 2027 6162 6364 6566 6768 696a 6b6c     'abcdefghijkl
-000277d0: 6d6e 6f70 7172 7374 7576 7778 797a 6162  mnopqrstuvwxyzab
-000277e0: 6364 6566 6768 696a 6b6c 6d6e 6f70 7172  cdefghijklmnopqr
-000277f0: 7374 7576 7778 797a 6162 6364 6566 6768  stuvwxyzabcdefgh
-00027800: 696a 6b6c 6d6e 6f70 7172 7374 7576 7778  ijklmnopqrstuvwx
-00027810: 797a 3127 2c0a 2020 2020 2020 2020 2320  yz1',.        # 
-00027820: 6d6f 7265 2074 6861 6e20 3633 2063 6861  more than 63 cha
-00027830: 7261 6374 6572 730a 2020 2020 2020 2020  racters.        
-00027840: 2741 6263 6465 6627 2c20 2023 2063 6f6e  'Abcdef',  # con
-00027850: 7461 696e 7320 616e 2075 7070 6572 6361  tains an upperca
-00027860: 7365 206c 6574 7465 720a 2020 2020 2020  se letter.      
-00027870: 2020 2761 6263 2064 6566 272c 2020 2320    'abc def',  # 
-00027880: 636f 6e74 6169 6e73 2061 2073 7061 6365  contains a space
-00027890: 0a20 2020 2020 2020 2027 6162 632e 2e64  .        'abc..d
-000278a0: 6566 272c 2020 2320 7477 6f20 6164 6a61  ef',  # two adja
-000278b0: 6365 6e74 2070 6572 696f 6473 0a20 2020  cent periods.   
-000278c0: 2020 2020 2027 3139 322e 3136 382e 352e       '192.168.5.
-000278d0: 3427 2c20 2023 2066 6f72 6d61 7474 6564  4',  # formatted
-000278e0: 2061 7320 616e 2049 5020 6164 6472 6573   as an IP addres
-000278f0: 730a 2020 2020 2020 2020 2778 6e2d 2d62  s.        'xn--b
-00027900: 7563 6b65 7427 2c20 2023 2073 7461 7274  ucket',  # start
-00027910: 7320 7769 7468 2027 786e 2d2d 2720 7072  s with 'xn--' pr
-00027920: 6566 6978 0a20 2020 2020 2020 2027 6275  efix.        'bu
-00027930: 636b 6574 2d73 3361 6c69 6173 272c 2020  cket-s3alias',  
-00027940: 2320 656e 6473 2077 6974 6820 272d 7333  # ends with '-s3
-00027950: 616c 6961 7327 2073 7566 6669 780a 2020  alias' suffix.  
-00027960: 2020 2020 2020 2762 7563 6b65 742d 2d6f        'bucket--o
-00027970: 6c2d 7333 272c 2020 2320 656e 6473 2077  l-s3',  # ends w
-00027980: 6974 6820 272d 2d6f 6c2d 7333 2720 7375  ith '--ol-s3' su
-00027990: 6666 6978 0a20 2020 2020 2020 2027 2e61  ffix.        '.a
-000279a0: 6263 272c 2020 2320 7374 6172 7473 2077  bc',  # starts w
-000279b0: 6974 6820 6120 646f 740a 2020 2020 2020  ith a dot.      
-000279c0: 2020 2761 6263 2e27 2c20 2023 2065 6e64    'abc.',  # end
-000279d0: 7320 7769 7468 2061 2064 6f74 0a20 2020  s with a dot.   
-000279e0: 2020 2020 2027 2d61 6263 272c 2020 2320       '-abc',  # 
-000279f0: 7374 6172 7473 2077 6974 6820 6120 6879  starts with a hy
-00027a00: 7068 656e 0a20 2020 2020 2020 2027 6162  phen.        'ab
-00027a10: 632d 272c 2020 2320 656e 6473 2077 6974  c-',  # ends wit
-00027a20: 6820 6120 6879 7068 656e 0a20 2020 205d  h a hyphen.    ]
-00027a30: 0a0a 2020 2020 4743 535f 494e 5641 4c49  ..    GCS_INVALI
-00027a40: 445f 4e41 4d45 5320 3d20 5b0a 2020 2020  D_NAMES = [.    
-00027a50: 2020 2020 2761 6227 2c20 2023 206c 6573      'ab',  # les
-00027a60: 7320 7468 616e 2033 2063 6861 7261 6374  s than 3 charact
-00027a70: 6572 730a 2020 2020 2020 2020 2761 6263  ers.        'abc
-00027a80: 6465 6667 6869 6a6b 6c6d 6e6f 7071 7273  defghijklmnopqrs
-00027a90: 7475 7677 7879 7a61 6263 6465 6667 6869  tuvwxyzabcdefghi
-00027aa0: 6a6b 6c6d 6e6f 7071 7273 7475 7677 7879  jklmnopqrstuvwxy
-00027ab0: 7a61 6263 6465 6667 6869 6a6b 6c6d 6e6f  zabcdefghijklmno
-00027ac0: 7071 7273 7475 7677 7879 7a31 272c 0a20  pqrstuvwxyz1',. 
-00027ad0: 2020 2020 2020 2023 206d 6f72 6520 7468         # more th
-00027ae0: 616e 2036 3320 6368 6172 6163 7465 7273  an 63 characters
-00027af0: 2028 7769 7468 6f75 7420 646f 7473 290a   (without dots).
-00027b00: 2020 2020 2020 2020 2741 6263 6465 6627          'Abcdef'
-00027b10: 2c20 2023 2063 6f6e 7461 696e 7320 616e  ,  # contains an
-00027b20: 2075 7070 6572 6361 7365 206c 6574 7465   uppercase lette
-00027b30: 720a 2020 2020 2020 2020 2761 6263 2064  r.        'abc d
-00027b40: 6566 272c 2020 2320 636f 6e74 6169 6e73  ef',  # contains
-00027b50: 2061 2073 7061 6365 0a20 2020 2020 2020   a space.       
-00027b60: 2027 6162 632e 2e64 6566 272c 2020 2320   'abc..def',  # 
-00027b70: 7477 6f20 6164 6a61 6365 6e74 2070 6572  two adjacent per
-00027b80: 696f 6473 0a20 2020 2020 2020 2027 6162  iods.        'ab
-00027b90: 635f 2e64 6566 2e67 6869 2e6a 6b6c 6d6e  c_.def.ghi.jklmn
-00027ba0: 6f70 7172 7374 7576 7778 797a 6162 6364  opqrstuvwxyzabcd
-00027bb0: 6566 6768 696a 6b6c 6d6e 6f70 7172 7374  efghijklmnopqrst
-00027bc0: 7576 7778 797a 6162 6364 6566 6768 696a  uvwxyzabcdefghij
-00027bd0: 6b6c 6d6e 6f70 7172 7374 7576 7778 797a  klmnopqrstuvwxyz
-00027be0: 3127 0a20 2020 2020 2020 2023 204d 6f72  1'.        # Mor
-00027bf0: 6520 7468 616e 2036 3320 6368 6172 6163  e than 63 charac
-00027c00: 7465 7273 2062 6574 7765 656e 2064 6f74  ters between dot
-00027c10: 730a 2020 2020 2020 2020 2761 6263 5f2e  s.        'abc_.
-00027c20: 6465 662e 6768 692e 6a6b 6c6d 6e6f 7071  def.ghi.jklmnopq
-00027c30: 7273 7475 7677 7879 7a61 6263 6465 6667  rstuvwxyzabcdefg
-00027c40: 6869 6a6b 6c6d 6e6f 7071 6667 6869 6a6b  hijklmnopqfghijk
-00027c50: 6c6d 6e6f 7071 7273 7475 7677 2720 2a20  lmnopqrstuvw' * 
-00027c60: 352c 0a20 2020 2020 2020 2023 206d 6f72  5,.        # mor
-00027c70: 6520 7468 616e 2032 3232 2063 6861 7261  e than 222 chara
-00027c80: 6374 6572 7320 2877 6974 6820 646f 7473  cters (with dots
-00027c90: 290a 2020 2020 2020 2020 2731 3932 2e31  ).        '192.1
-00027ca0: 3638 2e35 2e34 272c 2020 2320 666f 726d  68.5.4',  # form
-00027cb0: 6174 7465 6420 6173 2061 6e20 4950 2061  atted as an IP a
-00027cc0: 6464 7265 7373 0a20 2020 2020 2020 2027  ddress.        '
-00027cd0: 676f 6f67 6275 636b 6574 272c 2020 2320  googbucket',  # 
-00027ce0: 7374 6172 7473 2077 6974 6820 2767 6f6f  starts with 'goo
-00027cf0: 6727 2070 7265 6669 780a 2020 2020 2020  g' prefix.      
-00027d00: 2020 2767 6f6f 676c 6562 7563 6b65 7427    'googlebucket'
-00027d10: 2c20 2023 2063 6f6e 7461 696e 7320 2767  ,  # contains 'g
-00027d20: 6f6f 676c 6527 0a20 2020 2020 2020 2027  oogle'.        '
-00027d30: 6730 3067 6c65 6275 636b 6574 272c 2020  g00glebucket',  
-00027d40: 2320 7661 7269 616e 7420 6f66 2027 676f  # variant of 'go
-00027d50: 6f67 6c65 270a 2020 2020 2020 2020 2767  ogle'.        'g
-00027d60: 6f30 676c 6562 7563 6b65 7427 2c20 2023  o0glebucket',  #
-00027d70: 2076 6172 6961 6e74 206f 6620 2767 6f6f   variant of 'goo
-00027d80: 676c 6527 0a20 2020 2020 2020 2027 6730  gle'.        'g0
-00027d90: 6f67 6c65 6275 636b 6574 272c 2020 2320  oglebucket',  # 
-00027da0: 7661 7269 616e 7420 6f66 2027 676f 6f67  variant of 'goog
-00027db0: 6c65 270a 2020 2020 2020 2020 272e 6162  le'.        '.ab
-00027dc0: 6327 2c20 2023 2073 7461 7274 7320 7769  c',  # starts wi
-00027dd0: 7468 2061 2064 6f74 0a20 2020 2020 2020  th a dot.       
-00027de0: 2027 6162 632e 272c 2020 2320 656e 6473   'abc.',  # ends
-00027df0: 2077 6974 6820 6120 646f 740a 2020 2020   with a dot.    
-00027e00: 2020 2020 275f 6162 6327 2c20 2023 2073      '_abc',  # s
-00027e10: 7461 7274 7320 7769 7468 2061 6e20 756e  tarts with an un
-00027e20: 6465 7273 636f 7265 0a20 2020 2020 2020  derscore.       
-00027e30: 2027 6162 635f 272c 2020 2320 656e 6473   'abc_',  # ends
-00027e40: 2077 6974 6820 616e 2075 6e64 6572 7363   with an undersc
-00027e50: 6f72 650a 2020 2020 5d0a 0a20 2020 2049  ore.    ]..    I
-00027e60: 424d 5f49 4e56 414c 4944 5f4e 414d 4553  BM_INVALID_NAMES
-00027e70: 203d 205b 0a20 2020 2020 2020 2027 6162   = [.        'ab
-00027e80: 272c 2020 2320 6c65 7373 2074 6861 6e20  ',  # less than 
-00027e90: 3320 6368 6172 6163 7465 7273 0a20 2020  3 characters.   
-00027ea0: 2020 2020 2027 6162 6364 6566 6768 696a       'abcdefghij
-00027eb0: 6b6c 6d6e 6f70 7172 7374 7576 7778 797a  klmnopqrstuvwxyz
-00027ec0: 6162 6364 6566 6768 696a 6b6c 6d6e 6f70  abcdefghijklmnop
-00027ed0: 7172 7374 7576 7778 797a 6162 6364 6566  qrstuvwxyzabcdef
-00027ee0: 6768 696a 6b6c 6d6e 6f70 7172 7374 7576  ghijklmnopqrstuv
-00027ef0: 7778 797a 3127 2c0a 2020 2020 2020 2020  wxyz1',.        
-00027f00: 2320 6d6f 7265 2074 6861 6e20 3633 2063  # more than 63 c
-00027f10: 6861 7261 6374 6572 730a 2020 2020 2020  haracters.      
-00027f20: 2020 2741 6263 6465 6627 2c20 2023 2063    'Abcdef',  # c
-00027f30: 6f6e 7461 696e 7320 616e 2075 7070 6572  ontains an upper
-00027f40: 6361 7365 206c 6574 7465 720a 2020 2020  case letter.    
-00027f50: 2020 2020 2761 6263 2064 6566 272c 2020      'abc def',  
-00027f60: 2320 636f 6e74 6169 6e73 2061 2073 7061  # contains a spa
-00027f70: 6365 0a20 2020 2020 2020 2027 6162 632e  ce.        'abc.
-00027f80: 2e64 6566 272c 2020 2320 7477 6f20 6164  .def',  # two ad
-00027f90: 6a61 6365 6e74 2070 6572 696f 6473 0a20  jacent periods. 
-00027fa0: 2020 2020 2020 2027 3139 322e 3136 382e         '192.168.
-00027fb0: 352e 3427 2c20 2023 2066 6f72 6d61 7474  5.4',  # formatt
-00027fc0: 6564 2061 7320 616e 2049 5020 6164 6472  ed as an IP addr
-00027fd0: 6573 730a 2020 2020 2020 2020 2778 6e2d  ess.        'xn-
-00027fe0: 2d62 7563 6b65 7427 2c20 2023 2073 7461  -bucket',  # sta
-00027ff0: 7274 7320 7769 7468 2027 786e 2d2d 2720  rts with 'xn--' 
-00028000: 7072 6566 6978 0a20 2020 2020 2020 2027  prefix.        '
-00028010: 2e61 6263 272c 2020 2320 7374 6172 7473  .abc',  # starts
-00028020: 2077 6974 6820 6120 646f 740a 2020 2020   with a dot.    
-00028030: 2020 2020 2761 6263 2e27 2c20 2023 2065      'abc.',  # e
-00028040: 6e64 7320 7769 7468 2061 2064 6f74 0a20  nds with a dot. 
-00028050: 2020 2020 2020 2027 2d61 6263 272c 2020         '-abc',  
-00028060: 2320 7374 6172 7473 2077 6974 6820 6120  # starts with a 
-00028070: 6879 7068 656e 0a20 2020 2020 2020 2027  hyphen.        '
-00028080: 6162 632d 272c 2020 2320 656e 6473 2077  abc-',  # ends w
-00028090: 6974 6820 6120 6879 7068 656e 0a20 2020  ith a hyphen.   
-000280a0: 2020 2020 2027 612e 2d62 6327 2c20 2023       'a.-bc',  #
-000280b0: 2063 6f6e 7461 696e 7320 7468 6520 7365   contains the se
-000280c0: 7175 656e 6365 2027 2e2d 270a 2020 2020  quence '.-'.    
-000280d0: 2020 2020 2761 2d2e 6263 272c 2020 2320      'a-.bc',  # 
-000280e0: 636f 6e74 6169 6e73 2074 6865 2073 6571  contains the seq
-000280f0: 7565 6e63 6520 272d 2e27 0a20 2020 2020  uence '-.'.     
-00028100: 2020 2027 6126 6263 2720 2023 2063 6f6e     'a&bc'  # con
-00028110: 7461 696e 7320 7370 6563 6961 6c20 6368  tains special ch
-00028120: 6172 6163 7465 7273 0a20 2020 2020 2020  aracters.       
-00028130: 2027 6162 5e63 2720 2023 2063 6f6e 7461   'ab^c'  # conta
-00028140: 696e 7320 7370 6563 6961 6c20 6368 6172  ins special char
-00028150: 6163 7465 7273 0a20 2020 205d 0a20 2020  acters.    ].   
-00028160: 2047 4954 4947 4e4f 5245 5f53 594e 435f   GITIGNORE_SYNC_
-00028170: 5445 5354 5f44 4952 5f53 5452 5543 5455  TEST_DIR_STRUCTU
-00028180: 5245 203d 207b 0a20 2020 2020 2020 2027  RE = {.        '
-00028190: 646f 7562 6c65 5f61 7374 6572 6973 6b27  double_asterisk'
-000281a0: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-000281b0: 2764 6f75 626c 655f 6173 7465 7269 736b  'double_asterisk
-000281c0: 5f65 7863 6c75 6465 6427 3a20 4e6f 6e65  _excluded': None
-000281d0: 2c0a 2020 2020 2020 2020 2020 2020 2764  ,.            'd
-000281e0: 6f75 626c 655f 6173 7465 7269 736b 5f65  ouble_asterisk_e
-000281f0: 7863 6c75 6465 645f 6469 7227 3a20 7b0a  xcluded_dir': {.
-00028200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028210: 2764 6972 5f65 7863 6c75 6465 6427 3a20  'dir_excluded': 
-00028220: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-00028230: 2020 7d2c 0a20 2020 2020 2020 207d 2c0a    },.        },.
-00028240: 2020 2020 2020 2020 2764 6f75 626c 655f          'double_
-00028250: 6173 7465 7269 736b 5f70 6172 656e 7427  asterisk_parent'
-00028260: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-00028270: 2770 6172 656e 7427 3a20 7b0a 2020 2020  'parent': {.    
-00028280: 2020 2020 2020 2020 2020 2020 2761 6c73              'als
-00028290: 6f5f 6578 636c 7564 6564 2e74 7874 273a  o_excluded.txt':
-000282a0: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
-000282b0: 2020 2020 2020 2027 6368 696c 6427 3a20         'child': 
-000282c0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000282d0: 2020 2020 2020 2764 6f75 626c 655f 6173        'double_as
-000282e0: 7465 7269 736b 5f70 6172 656e 745f 6368  terisk_parent_ch
-000282f0: 696c 645f 6578 636c 7564 6564 2e74 7874  ild_excluded.txt
-00028300: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-00028310: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-00028320: 2020 2020 2020 2020 2020 2020 2764 6f75              'dou
-00028330: 626c 655f 6173 7465 7269 736b 5f70 6172  ble_asterisk_par
-00028340: 656e 745f 6578 636c 7564 6564 2e74 7874  ent_excluded.txt
-00028350: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-00028360: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-00028370: 7d2c 0a20 2020 2020 2020 2027 6578 636c  },.        'excl
-00028380: 7564 6564 2e6c 6f67 273a 204e 6f6e 652c  uded.log': None,
-00028390: 0a20 2020 2020 2020 2027 6578 636c 7564  .        'exclud
-000283a0: 6564 5f64 6972 273a 207b 0a20 2020 2020  ed_dir': {.     
-000283b0: 2020 2020 2020 2027 6578 636c 7564 6564         'excluded
-000283c0: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
-000283d0: 2020 2020 2020 2020 2027 6e65 7374 6564           'nested
-000283e0: 5f65 7863 6c75 6465 6427 3a20 7b0a 2020  _excluded': {.  
-000283f0: 2020 2020 2020 2020 2020 2020 2020 2765                'e
-00028400: 7863 6c75 6465 6427 3a20 4e6f 6e65 2c0a  xcluded': None,.
-00028410: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
-00028420: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-00028430: 2020 2765 7870 2d31 273a 207b 0a20 2020    'exp-1': {.   
-00028440: 2020 2020 2020 2020 2027 6265 5f65 7863           'be_exc
-00028450: 6c75 6465 6427 3a20 4e6f 6e65 2c0a 2020  luded': None,.  
-00028460: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-00028470: 2027 6578 702d 3227 3a20 7b0a 2020 2020   'exp-2': {.    
-00028480: 2020 2020 2020 2020 2762 655f 6578 636c          'be_excl
-00028490: 7564 6564 273a 204e 6f6e 652c 0a20 2020  uded': None,.   
-000284a0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-000284b0: 2766 726f 6e74 5f73 6c61 7368 5f65 7863  'front_slash_exc
-000284c0: 6c75 6465 6427 3a20 4e6f 6e65 2c0a 2020  luded': None,.  
-000284d0: 2020 2020 2020 2769 6e63 6c75 6465 642e        'included.
-000284e0: 6c6f 6727 3a20 4e6f 6e65 2c0a 2020 2020  log': None,.    
-000284f0: 2020 2020 2769 6e63 6c75 6465 642e 7478      'included.tx
-00028500: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
-00028510: 2020 2769 6e63 6c75 6465 5f64 6972 273a    'include_dir':
-00028520: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
-00028530: 6578 636c 7564 6564 2e6c 6f67 273a 204e  excluded.log': N
-00028540: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-00028550: 2027 696e 636c 7564 6564 2e6c 6f67 273a   'included.log':
-00028560: 204e 6f6e 652c 0a20 2020 2020 2020 207d   None,.        }
-00028570: 2c0a 2020 2020 2020 2020 276e 6573 7465  ,.        'neste
-00028580: 645f 646f 7562 6c65 5f61 7374 6572 6973  d_double_asteris
-00028590: 6b27 3a20 7b0a 2020 2020 2020 2020 2020  k': {.          
-000285a0: 2020 276f 6e65 273a 207b 0a20 2020 2020    'one': {.     
-000285b0: 2020 2020 2020 2020 2020 2027 616c 736f             'also
-000285c0: 5f65 7863 6c75 6465 2e74 7874 273a 204e  _exclude.txt': N
-000285d0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-000285e0: 207d 2c0a 2020 2020 2020 2020 2020 2020   },.            
-000285f0: 2774 776f 273a 207b 0a20 2020 2020 2020  'two': {.       
-00028600: 2020 2020 2020 2020 2027 616c 736f 5f65           'also_e
-00028610: 7863 6c75 6465 2e74 7874 273a 204e 6f6e  xclude.txt': Non
-00028620: 652c 0a20 2020 2020 2020 2020 2020 207d  e,.            }
-00028630: 2c0a 2020 2020 2020 2020 7d2c 0a20 2020  ,.        },.   
-00028640: 2020 2020 2027 6e65 7374 6564 5f77 696c       'nested_wil
-00028650: 6463 6172 645f 6469 7227 3a20 7b0a 2020  dcard_dir': {.  
-00028660: 2020 2020 2020 2020 2020 276d 6f6e 6461            'monda
-00028670: 7927 3a20 7b0a 2020 2020 2020 2020 2020  y': {.          
-00028680: 2020 2020 2020 2761 6c73 6f5f 6578 636c        'also_excl
-00028690: 7564 652e 7478 7427 3a20 4e6f 6e65 2c0a  ude.txt': None,.
-000286a0: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
-000286b0: 2020 2020 2020 2020 2020 2027 7475 6573             'tues
-000286c0: 6461 7927 3a20 7b0a 2020 2020 2020 2020  day': {.        
-000286d0: 2020 2020 2020 2020 2761 6c73 6f5f 6578          'also_ex
-000286e0: 636c 7564 652e 7478 7427 3a20 4e6f 6e65  clude.txt': None
-000286f0: 2c0a 2020 2020 2020 2020 2020 2020 7d2c  ,.            },
-00028700: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
-00028710: 2020 2020 276e 6f5f 736c 6173 685f 6578      'no_slash_ex
-00028720: 636c 7564 6564 273a 204e 6f6e 652c 0a20  cluded': None,. 
-00028730: 2020 2020 2020 2027 6e6f 5f73 6c61 7368         'no_slash
-00028740: 5f74 6573 7473 273a 207b 0a20 2020 2020  _tests': {.     
-00028750: 2020 2020 2020 2027 6e6f 5f73 6c61 7368         'no_slash
-00028760: 5f65 7863 6c75 6465 6427 3a20 7b0a 2020  _excluded': {.  
-00028770: 2020 2020 2020 2020 2020 2020 2020 2761                'a
-00028780: 6c73 6f5f 6578 636c 7564 6564 2e74 7874  lso_excluded.txt
-00028790: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-000287a0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-000287b0: 7d2c 0a20 2020 2020 2020 2027 7175 6573  },.        'ques
-000287c0: 7469 6f6e 5f6d 6172 6b27 3a20 7b0a 2020  tion_mark': {.  
-000287d0: 2020 2020 2020 2020 2020 2765 7863 6c75            'exclu
-000287e0: 6465 6431 2e74 7874 273a 204e 6f6e 652c  ded1.txt': None,
-000287f0: 0a20 2020 2020 2020 2020 2020 2027 6578  .            'ex
-00028800: 636c 7564 6564 402e 7478 7427 3a20 4e6f  cluded@.txt': No
-00028810: 6e65 2c0a 2020 2020 2020 2020 7d2c 0a20  ne,.        },. 
-00028820: 2020 2020 2020 2027 7371 7561 7265 5f62         'square_b
-00028830: 7261 636b 6574 273a 207b 0a20 2020 2020  racket': {.     
-00028840: 2020 2020 2020 2027 6578 636c 7564 6564         'excluded
-00028850: 312e 7478 7427 3a20 4e6f 6e65 2c0a 2020  1.txt': None,.  
-00028860: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-00028870: 2027 7371 7561 7265 5f62 7261 636b 6574   'square_bracket
-00028880: 5f61 6c70 6861 273a 207b 0a20 2020 2020  _alpha': {.     
-00028890: 2020 2020 2020 2027 6578 636c 7564 6564         'excluded
-000288a0: 7a2e 7478 7427 3a20 4e6f 6e65 2c0a 2020  z.txt': None,.  
-000288b0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-000288c0: 2027 7371 7561 7265 5f62 7261 636b 6574   'square_bracket
-000288d0: 5f65 7863 6c61 273a 207b 0a20 2020 2020  _excla': {.     
-000288e0: 2020 2020 2020 2027 6578 636c 7564 6564         'excluded
-000288f0: 322e 7478 7427 3a20 4e6f 6e65 2c0a 2020  2.txt': None,.  
-00028900: 2020 2020 2020 2020 2020 2765 7863 6c75            'exclu
-00028910: 6465 6440 2e74 7874 273a 204e 6f6e 652c  ded@.txt': None,
-00028920: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
-00028930: 2020 2020 2773 7175 6172 655f 6272 6163      'square_brac
-00028940: 6b65 745f 7369 6e67 6c65 273a 207b 0a20  ket_single': {. 
-00028950: 2020 2020 2020 2020 2020 2027 6578 636c             'excl
-00028960: 7564 6564 302e 7478 7427 3a20 4e6f 6e65  uded0.txt': None
-00028970: 2c0a 2020 2020 2020 2020 7d2c 0a20 2020  ,.        },.   
-00028980: 207d 0a0a 2020 2020 4073 7461 7469 636d   }..    @staticm
-00028990: 6574 686f 640a 2020 2020 6465 6620 6372  ethod.    def cr
-000289a0: 6561 7465 5f64 6972 5f73 7472 7563 7475  eate_dir_structu
-000289b0: 7265 2862 6173 655f 7061 7468 2c20 7374  re(base_path, st
-000289c0: 7275 6374 7572 6529 3a0a 2020 2020 2020  ructure):.      
-000289d0: 2020 2320 6372 6561 7465 7320 6120 6769    # creates a gi
-000289e0: 7665 6e20 6669 6c65 2053 5452 5543 5455  ven file STRUCTU
-000289f0: 5245 2069 6e20 4241 5345 5f50 4154 480a  RE in BASE_PATH.
-00028a00: 2020 2020 2020 2020 666f 7220 6e61 6d65          for name
-00028a10: 2c20 7375 6273 7472 7563 7475 7265 2069  , substructure i
-00028a20: 6e20 7374 7275 6374 7572 652e 6974 656d  n structure.item
-00028a30: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00028a40: 2070 6174 6820 3d20 6f73 2e70 6174 682e   path = os.path.
-00028a50: 6a6f 696e 2862 6173 655f 7061 7468 2c20  join(base_path, 
-00028a60: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
-00028a70: 2020 6966 2073 7562 7374 7275 6374 7572    if substructur
-00028a80: 6520 6973 204e 6f6e 653a 0a20 2020 2020  e is None:.     
-00028a90: 2020 2020 2020 2020 2020 2023 2043 7265             # Cre
-00028aa0: 6174 6520 6120 6669 6c65 0a20 2020 2020  ate a file.     
-00028ab0: 2020 2020 2020 2020 2020 206f 7065 6e28             open(
-00028ac0: 7061 7468 2c20 2761 272c 2065 6e63 6f64  path, 'a', encod
-00028ad0: 696e 673d 2775 7466 2d38 2729 2e63 6c6f  ing='utf-8').clo
-00028ae0: 7365 2829 0a20 2020 2020 2020 2020 2020  se().           
-00028af0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00028b00: 2020 2020 2020 2023 2043 7265 6174 6520         # Create 
-00028b10: 6120 7375 6264 6972 6563 746f 7279 0a20  a subdirectory. 
-00028b20: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00028b30: 732e 6d6b 6469 7228 7061 7468 290a 2020  s.mkdir(path).  
-00028b40: 2020 2020 2020 2020 2020 2020 2020 5465                Te
-00028b50: 7374 5374 6f72 6167 6557 6974 6843 7265  stStorageWithCre
-00028b60: 6465 6e74 6961 6c73 2e63 7265 6174 655f  dentials.create_
-00028b70: 6469 725f 7374 7275 6374 7572 6528 0a20  dir_structure(. 
-00028b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028b90: 2020 2070 6174 682c 2073 7562 7374 7275     path, substru
-00028ba0: 6374 7572 6529 0a0a 2020 2020 4073 7461  cture)..    @sta
-00028bb0: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
-00028bc0: 6620 636c 695f 6465 6c65 7465 5f63 6d64  f cli_delete_cmd
-00028bd0: 2873 746f 7265 5f74 7970 652c 2062 7563  (store_type, buc
-00028be0: 6b65 745f 6e61 6d65 293a 0a20 2020 2020  ket_name):.     
-00028bf0: 2020 2069 6620 7374 6f72 655f 7479 7065     if store_type
-00028c00: 203d 3d20 7374 6f72 6167 655f 6c69 622e   == storage_lib.
-00028c10: 5374 6f72 6554 7970 652e 5333 3a0a 2020  StoreType.S3:.  
-00028c20: 2020 2020 2020 2020 2020 7572 6c20 3d20            url = 
-00028c30: 6627 7333 3a2f 2f7b 6275 636b 6574 5f6e  f's3://{bucket_n
-00028c40: 616d 657d 270a 2020 2020 2020 2020 2020  ame}'.          
-00028c50: 2020 7265 7475 726e 2066 2761 7773 2073    return f'aws s
-00028c60: 3320 7262 207b 7572 6c7d 202d 2d66 6f72  3 rb {url} --for
-00028c70: 6365 270a 2020 2020 2020 2020 6966 2073  ce'.        if s
-00028c80: 746f 7265 5f74 7970 6520 3d3d 2073 746f  tore_type == sto
-00028c90: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-00028ca0: 7065 2e47 4353 3a0a 2020 2020 2020 2020  pe.GCS:.        
-00028cb0: 2020 2020 7572 6c20 3d20 6627 6773 3a2f      url = f'gs:/
-00028cc0: 2f7b 6275 636b 6574 5f6e 616d 657d 270a  /{bucket_name}'.
-00028cd0: 2020 2020 2020 2020 2020 2020 6773 7574              gsut
-00028ce0: 696c 5f61 6c69 6173 2c20 616c 6961 735f  il_alias, alias_
-00028cf0: 6765 6e20 3d20 6461 7461 5f75 7469 6c73  gen = data_utils
-00028d00: 2e67 6574 5f67 7375 7469 6c5f 636f 6d6d  .get_gsutil_comm
-00028d10: 616e 6428 290a 2020 2020 2020 2020 2020  and().          
-00028d20: 2020 7265 7475 726e 2066 277b 616c 6961    return f'{alia
-00028d30: 735f 6765 6e7d 3b20 7b67 7375 7469 6c5f  s_gen}; {gsutil_
-00028d40: 616c 6961 737d 2072 6d20 2d72 207b 7572  alias} rm -r {ur
-00028d50: 6c7d 270a 2020 2020 2020 2020 6966 2073  l}'.        if s
-00028d60: 746f 7265 5f74 7970 6520 3d3d 2073 746f  tore_type == sto
-00028d70: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-00028d80: 7065 2e52 323a 0a20 2020 2020 2020 2020  pe.R2:.         
-00028d90: 2020 2065 6e64 706f 696e 745f 7572 6c20     endpoint_url 
-00028da0: 3d20 636c 6f75 6466 6c61 7265 2e63 7265  = cloudflare.cre
-00028db0: 6174 655f 656e 6470 6f69 6e74 2829 0a20  ate_endpoint(). 
-00028dc0: 2020 2020 2020 2020 2020 2075 726c 203d             url =
-00028dd0: 2066 2773 333a 2f2f 7b62 7563 6b65 745f   f's3://{bucket_
-00028de0: 6e61 6d65 7d27 0a20 2020 2020 2020 2020  name}'.         
-00028df0: 2020 2072 6574 7572 6e20 6627 4157 535f     return f'AWS_
-00028e00: 5348 4152 4544 5f43 5245 4445 4e54 4941  SHARED_CREDENTIA
-00028e10: 4c53 5f46 494c 453d 7b63 6c6f 7564 666c  LS_FILE={cloudfl
-00028e20: 6172 652e 5232 5f43 5245 4445 4e54 4941  are.R2_CREDENTIA
-00028e30: 4c53 5f50 4154 487d 2061 7773 2073 3320  LS_PATH} aws s3 
-00028e40: 7262 207b 7572 6c7d 202d 2d66 6f72 6365  rb {url} --force
-00028e50: 202d 2d65 6e64 706f 696e 7420 7b65 6e64   --endpoint {end
-00028e60: 706f 696e 745f 7572 6c7d 202d 2d70 726f  point_url} --pro
-00028e70: 6669 6c65 3d72 3227 0a20 2020 2020 2020  file=r2'.       
-00028e80: 2069 6620 7374 6f72 655f 7479 7065 203d   if store_type =
-00028e90: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-00028ea0: 6f72 6554 7970 652e 4942 4d3a 0a20 2020  oreType.IBM:.   
-00028eb0: 2020 2020 2020 2020 2062 7563 6b65 745f           bucket_
-00028ec0: 7263 6c6f 6e65 5f70 726f 6669 6c65 203d  rclone_profile =
-00028ed0: 2052 636c 6f6e 652e 6765 6e65 7261 7465   Rclone.generate
-00028ee0: 5f72 636c 6f6e 655f 6275 636b 6574 5f70  _rclone_bucket_p
-00028ef0: 726f 6669 6c65 5f6e 616d 6528 0a20 2020  rofile_name(.   
-00028f00: 2020 2020 2020 2020 2020 2020 2062 7563               buc
-00028f10: 6b65 745f 6e61 6d65 2c20 5263 6c6f 6e65  ket_name, Rclone
-00028f20: 2e52 636c 6f6e 6543 6c6f 7564 732e 4942  .RcloneClouds.IB
-00028f30: 4d29 0a20 2020 2020 2020 2020 2020 2072  M).            r
-00028f40: 6574 7572 6e20 6627 7263 6c6f 6e65 2070  eturn f'rclone p
-00028f50: 7572 6765 207b 6275 636b 6574 5f72 636c  urge {bucket_rcl
-00028f60: 6f6e 655f 7072 6f66 696c 657d 3a7b 6275  one_profile}:{bu
-00028f70: 636b 6574 5f6e 616d 657d 2026 2620 7263  cket_name} && rc
-00028f80: 6c6f 6e65 2063 6f6e 6669 6720 6465 6c65  lone config dele
-00028f90: 7465 207b 6275 636b 6574 5f72 636c 6f6e  te {bucket_rclon
-00028fa0: 655f 7072 6f66 696c 657d 270a 0a20 2020  e_profile}'..   
-00028fb0: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
-00028fc0: 2020 2064 6566 2063 6c69 5f6c 735f 636d     def cli_ls_cm
-00028fd0: 6428 7374 6f72 655f 7479 7065 2c20 6275  d(store_type, bu
-00028fe0: 636b 6574 5f6e 616d 652c 2073 7566 6669  cket_name, suffi
-00028ff0: 783d 2727 293a 0a20 2020 2020 2020 2069  x=''):.        i
-00029000: 6620 7374 6f72 655f 7479 7065 203d 3d20  f store_type == 
-00029010: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-00029020: 6554 7970 652e 5333 3a0a 2020 2020 2020  eType.S3:.      
-00029030: 2020 2020 2020 6966 2073 7566 6669 783a        if suffix:
-00029040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029050: 2075 726c 203d 2066 2773 333a 2f2f 7b62   url = f's3://{b
-00029060: 7563 6b65 745f 6e61 6d65 7d2f 7b73 7566  ucket_name}/{suf
-00029070: 6669 787d 270a 2020 2020 2020 2020 2020  fix}'.          
-00029080: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00029090: 2020 2020 2020 2020 7572 6c20 3d20 6627          url = f'
-000290a0: 7333 3a2f 2f7b 6275 636b 6574 5f6e 616d  s3://{bucket_nam
-000290b0: 657d 270a 2020 2020 2020 2020 2020 2020  e}'.            
-000290c0: 7265 7475 726e 2066 2761 7773 2073 3320  return f'aws s3 
-000290d0: 6c73 207b 7572 6c7d 270a 2020 2020 2020  ls {url}'.      
-000290e0: 2020 6966 2073 746f 7265 5f74 7970 6520    if store_type 
-000290f0: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
-00029100: 746f 7265 5479 7065 2e47 4353 3a0a 2020  toreType.GCS:.  
-00029110: 2020 2020 2020 2020 2020 6966 2073 7566            if suf
-00029120: 6669 783a 0a20 2020 2020 2020 2020 2020  fix:.           
-00029130: 2020 2020 2075 726c 203d 2066 2767 733a       url = f'gs:
-00029140: 2f2f 7b62 7563 6b65 745f 6e61 6d65 7d2f  //{bucket_name}/
-00029150: 7b73 7566 6669 787d 270a 2020 2020 2020  {suffix}'.      
-00029160: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00029170: 2020 2020 2020 2020 2020 2020 7572 6c20              url 
-00029180: 3d20 6627 6773 3a2f 2f7b 6275 636b 6574  = f'gs://{bucket
-00029190: 5f6e 616d 657d 270a 2020 2020 2020 2020  _name}'.        
-000291a0: 2020 2020 7265 7475 726e 2066 2767 7375      return f'gsu
-000291b0: 7469 6c20 6c73 207b 7572 6c7d 270a 2020  til ls {url}'.  
-000291c0: 2020 2020 2020 6966 2073 746f 7265 5f74        if store_t
-000291d0: 7970 6520 3d3d 2073 746f 7261 6765 5f6c  ype == storage_l
-000291e0: 6962 2e53 746f 7265 5479 7065 2e52 323a  ib.StoreType.R2:
-000291f0: 0a20 2020 2020 2020 2020 2020 2065 6e64  .            end
-00029200: 706f 696e 745f 7572 6c20 3d20 636c 6f75  point_url = clou
-00029210: 6466 6c61 7265 2e63 7265 6174 655f 656e  dflare.create_en
-00029220: 6470 6f69 6e74 2829 0a20 2020 2020 2020  dpoint().       
-00029230: 2020 2020 2069 6620 7375 6666 6978 3a0a       if suffix:.
-00029240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029250: 7572 6c20 3d20 6627 7333 3a2f 2f7b 6275  url = f's3://{bu
-00029260: 636b 6574 5f6e 616d 657d 2f7b 7375 6666  cket_name}/{suff
-00029270: 6978 7d27 0a20 2020 2020 2020 2020 2020  ix}'.           
-00029280: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00029290: 2020 2020 2020 2075 726c 203d 2066 2773         url = f's
-000292a0: 333a 2f2f 7b62 7563 6b65 745f 6e61 6d65  3://{bucket_name
-000292b0: 7d27 0a20 2020 2020 2020 2020 2020 2072  }'.            r
-000292c0: 6574 7572 6e20 6627 4157 535f 5348 4152  eturn f'AWS_SHAR
-000292d0: 4544 5f43 5245 4445 4e54 4941 4c53 5f46  ED_CREDENTIALS_F
-000292e0: 494c 453d 7b63 6c6f 7564 666c 6172 652e  ILE={cloudflare.
-000292f0: 5232 5f43 5245 4445 4e54 4941 4c53 5f50  R2_CREDENTIALS_P
-00029300: 4154 487d 2061 7773 2073 3320 6c73 207b  ATH} aws s3 ls {
-00029310: 7572 6c7d 202d 2d65 6e64 706f 696e 7420  url} --endpoint 
-00029320: 7b65 6e64 706f 696e 745f 7572 6c7d 202d  {endpoint_url} -
-00029330: 2d70 726f 6669 6c65 3d72 3227 0a20 2020  -profile=r2'.   
-00029340: 2020 2020 2069 6620 7374 6f72 655f 7479       if store_ty
-00029350: 7065 203d 3d20 7374 6f72 6167 655f 6c69  pe == storage_li
-00029360: 622e 5374 6f72 6554 7970 652e 4942 4d3a  b.StoreType.IBM:
-00029370: 0a20 2020 2020 2020 2020 2020 2062 7563  .            buc
-00029380: 6b65 745f 7263 6c6f 6e65 5f70 726f 6669  ket_rclone_profi
-00029390: 6c65 203d 2052 636c 6f6e 652e 6765 6e65  le = Rclone.gene
-000293a0: 7261 7465 5f72 636c 6f6e 655f 6275 636b  rate_rclone_buck
-000293b0: 6574 5f70 726f 6669 6c65 5f6e 616d 6528  et_profile_name(
-000293c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000293d0: 2062 7563 6b65 745f 6e61 6d65 2c20 5263   bucket_name, Rc
-000293e0: 6c6f 6e65 2e52 636c 6f6e 6543 6c6f 7564  lone.RcloneCloud
-000293f0: 732e 4942 4d29 0a20 2020 2020 2020 2020  s.IBM).         
-00029400: 2020 2072 6574 7572 6e20 6627 7263 6c6f     return f'rclo
-00029410: 6e65 206c 7320 7b62 7563 6b65 745f 7263  ne ls {bucket_rc
-00029420: 6c6f 6e65 5f70 726f 6669 6c65 7d3a 7b62  lone_profile}:{b
-00029430: 7563 6b65 745f 6e61 6d65 7d2f 7b73 7566  ucket_name}/{suf
-00029440: 6669 787d 270a 0a20 2020 2040 7374 6174  fix}'..    @stat
-00029450: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
-00029460: 2063 6c69 5f72 6567 696f 6e5f 636d 6428   cli_region_cmd(
-00029470: 7374 6f72 655f 7479 7065 2c20 6275 636b  store_type, buck
-00029480: 6574 5f6e 616d 6529 3a0a 2020 2020 2020  et_name):.      
-00029490: 2020 6966 2073 746f 7265 5f74 7970 6520    if store_type 
-000294a0: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
-000294b0: 746f 7265 5479 7065 2e53 333a 0a20 2020  toreType.S3:.   
-000294c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000294d0: 2827 6177 7320 7333 6170 6920 6765 742d  ('aws s3api get-
-000294e0: 6275 636b 6574 2d6c 6f63 6174 696f 6e20  bucket-location 
-000294f0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00029500: 2020 2020 2020 6627 2d2d 6275 636b 6574        f'--bucket
-00029510: 207b 6275 636b 6574 5f6e 616d 657d 202d   {bucket_name} -
-00029520: 2d6f 7574 7075 7420 7465 7874 2729 0a20  -output text'). 
-00029530: 2020 2020 2020 2065 6c69 6620 7374 6f72         elif stor
-00029540: 655f 7479 7065 203d 3d20 7374 6f72 6167  e_type == storag
-00029550: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-00029560: 4743 533a 0a20 2020 2020 2020 2020 2020  GCS:.           
-00029570: 2072 6574 7572 6e20 2866 2767 7375 7469   return (f'gsuti
-00029580: 6c20 6c73 202d 4c20 2d62 2067 733a 2f2f  l ls -L -b gs://
-00029590: 7b62 7563 6b65 745f 6e61 6d65 7d2f 207c  {bucket_name}/ |
-000295a0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-000295b0: 2020 2020 2020 2027 6772 6570 2022 4c6f         'grep "Lo
-000295c0: 6361 7469 6f6e 2063 6f6e 7374 7261 696e  cation constrain
-000295d0: 7422 207c 2027 0a20 2020 2020 2020 2020  t" | '.         
-000295e0: 2020 2020 2020 2020 2020 2027 6177 6b20             'awk 
-000295f0: 5c27 7b70 7269 6e74 2074 6f6c 6f77 6572  \'{print tolower
-00029600: 2824 4e46 297d 5c27 2729 0a20 2020 2020  ($NF)}\'').     
-00029610: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00029620: 2020 2020 2072 6169 7365 204e 6f74 496d       raise NotIm
-00029630: 706c 656d 656e 7465 6445 7272 6f72 2866  plementedError(f
-00029640: 2752 6567 696f 6e20 636f 6d6d 616e 6420  'Region command 
-00029650: 6e6f 7420 696d 706c 656d 656e 7465 6420  not implemented 
-00029660: 666f 7220 270a 2020 2020 2020 2020 2020  for '.          
-00029670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029680: 2020 2020 2020 2020 2020 2020 6627 7b73              f'{s
-00029690: 746f 7265 5f74 7970 657d 2729 0a0a 2020  tore_type}')..  
-000296a0: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
-000296b0: 2020 2020 6465 6620 636c 695f 636f 756e      def cli_coun
-000296c0: 745f 6e61 6d65 5f69 6e5f 6275 636b 6574  t_name_in_bucket
-000296d0: 2873 746f 7265 5f74 7970 652c 2062 7563  (store_type, buc
-000296e0: 6b65 745f 6e61 6d65 2c20 6669 6c65 5f6e  ket_name, file_n
-000296f0: 616d 652c 2073 7566 6669 783d 2727 293a  ame, suffix=''):
-00029700: 0a20 2020 2020 2020 2069 6620 7374 6f72  .        if stor
-00029710: 655f 7479 7065 203d 3d20 7374 6f72 6167  e_type == storag
-00029720: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-00029730: 5333 3a0a 2020 2020 2020 2020 2020 2020  S3:.            
-00029740: 6966 2073 7566 6669 783a 0a20 2020 2020  if suffix:.     
-00029750: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00029760: 6e20 6627 6177 7320 7333 6170 6920 6c69  n f'aws s3api li
-00029770: 7374 2d6f 626a 6563 7473 202d 2d62 7563  st-objects --buc
-00029780: 6b65 7420 227b 6275 636b 6574 5f6e 616d  ket "{bucket_nam
-00029790: 657d 2220 2d2d 7072 6566 6978 207b 7375  e}" --prefix {su
-000297a0: 6666 6978 7d20 2d2d 7175 6572 7920 226c  ffix} --query "l
-000297b0: 656e 6774 6828 436f 6e74 656e 7473 5b3f  ength(Contents[?
-000297c0: 636f 6e74 6169 6e73 284b 6579 2c5c 277b  contains(Key,\'{
-000297d0: 6669 6c65 5f6e 616d 657d 5c27 295d 2e4b  file_name}\')].K
-000297e0: 6579 2922 270a 2020 2020 2020 2020 2020  ey)"'.          
-000297f0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00029800: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-00029810: 2761 7773 2073 3361 7069 206c 6973 742d  'aws s3api list-
-00029820: 6f62 6a65 6374 7320 2d2d 6275 636b 6574  objects --bucket
-00029830: 2022 7b62 7563 6b65 745f 6e61 6d65 7d22   "{bucket_name}"
-00029840: 202d 2d71 7565 7279 2022 6c65 6e67 7468   --query "length
-00029850: 2843 6f6e 7465 6e74 735b 3f63 6f6e 7461  (Contents[?conta
-00029860: 696e 7328 4b65 792c 5c27 7b66 696c 655f  ins(Key,\'{file_
-00029870: 6e61 6d65 7d5c 2729 5d2e 4b65 7929 2227  name}\')].Key)"'
-00029880: 0a20 2020 2020 2020 2065 6c69 6620 7374  .        elif st
-00029890: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
-000298a0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-000298b0: 652e 4743 533a 0a20 2020 2020 2020 2020  e.GCS:.         
-000298c0: 2020 2069 6620 7375 6666 6978 3a0a 2020     if suffix:.  
-000298d0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-000298e0: 7475 726e 2066 2767 7375 7469 6c20 6c73  turn f'gsutil ls
-000298f0: 202d 7220 6773 3a2f 2f7b 6275 636b 6574   -r gs://{bucket
-00029900: 5f6e 616d 657d 2f7b 7375 6666 6978 7d20  _name}/{suffix} 
-00029910: 7c20 6772 6570 2022 7b66 696c 655f 6e61  | grep "{file_na
-00029920: 6d65 7d22 207c 2077 6320 2d6c 270a 2020  me}" | wc -l'.  
-00029930: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00029940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029950: 7265 7475 726e 2066 2767 7375 7469 6c20  return f'gsutil 
-00029960: 6c73 202d 7220 6773 3a2f 2f7b 6275 636b  ls -r gs://{buck
-00029970: 6574 5f6e 616d 657d 207c 2067 7265 7020  et_name} | grep 
-00029980: 227b 6669 6c65 5f6e 616d 657d 2220 7c20  "{file_name}" | 
-00029990: 7763 202d 6c27 0a20 2020 2020 2020 2065  wc -l'.        e
-000299a0: 6c69 6620 7374 6f72 655f 7479 7065 203d  lif store_type =
-000299b0: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-000299c0: 6f72 6554 7970 652e 5232 3a0a 2020 2020  oreType.R2:.    
-000299d0: 2020 2020 2020 2020 656e 6470 6f69 6e74          endpoint
-000299e0: 5f75 726c 203d 2063 6c6f 7564 666c 6172  _url = cloudflar
-000299f0: 652e 6372 6561 7465 5f65 6e64 706f 696e  e.create_endpoin
-00029a00: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-00029a10: 6966 2073 7566 6669 783a 0a20 2020 2020  if suffix:.     
-00029a20: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00029a30: 6e20 6627 4157 535f 5348 4152 4544 5f43  n f'AWS_SHARED_C
-00029a40: 5245 4445 4e54 4941 4c53 5f46 494c 453d  REDENTIALS_FILE=
-00029a50: 7b63 6c6f 7564 666c 6172 652e 5232 5f43  {cloudflare.R2_C
-00029a60: 5245 4445 4e54 4941 4c53 5f50 4154 487d  REDENTIALS_PATH}
-00029a70: 2061 7773 2073 3361 7069 206c 6973 742d   aws s3api list-
-00029a80: 6f62 6a65 6374 7320 2d2d 6275 636b 6574  objects --bucket
-00029a90: 2022 7b62 7563 6b65 745f 6e61 6d65 7d22   "{bucket_name}"
-00029aa0: 202d 2d70 7265 6669 7820 7b73 7566 6669   --prefix {suffi
-00029ab0: 787d 202d 2d71 7565 7279 2022 6c65 6e67  x} --query "leng
-00029ac0: 7468 2843 6f6e 7465 6e74 735b 3f63 6f6e  th(Contents[?con
-00029ad0: 7461 696e 7328 4b65 792c 5c27 7b66 696c  tains(Key,\'{fil
-00029ae0: 655f 6e61 6d65 7d5c 2729 5d2e 4b65 7929  e_name}\')].Key)
-00029af0: 2220 2d2d 656e 6470 6f69 6e74 207b 656e  " --endpoint {en
-00029b00: 6470 6f69 6e74 5f75 726c 7d20 2d2d 7072  dpoint_url} --pr
-00029b10: 6f66 696c 653d 7232 270a 2020 2020 2020  ofile=r2'.      
-00029b20: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00029b30: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00029b40: 726e 2066 2741 5753 5f53 4841 5245 445f  rn f'AWS_SHARED_
-00029b50: 4352 4544 454e 5449 414c 535f 4649 4c45  CREDENTIALS_FILE
-00029b60: 3d7b 636c 6f75 6466 6c61 7265 2e52 325f  ={cloudflare.R2_
-00029b70: 4352 4544 454e 5449 414c 535f 5041 5448  CREDENTIALS_PATH
-00029b80: 7d20 6177 7320 7333 6170 6920 6c69 7374  } aws s3api list
-00029b90: 2d6f 626a 6563 7473 202d 2d62 7563 6b65  -objects --bucke
-00029ba0: 7420 227b 6275 636b 6574 5f6e 616d 657d  t "{bucket_name}
-00029bb0: 2220 2d2d 7175 6572 7920 226c 656e 6774  " --query "lengt
-00029bc0: 6828 436f 6e74 656e 7473 5b3f 636f 6e74  h(Contents[?cont
-00029bd0: 6169 6e73 284b 6579 2c5c 277b 6669 6c65  ains(Key,\'{file
-00029be0: 5f6e 616d 657d 5c27 295d 2e4b 6579 2922  _name}\')].Key)"
-00029bf0: 202d 2d65 6e64 706f 696e 7420 7b65 6e64   --endpoint {end
-00029c00: 706f 696e 745f 7572 6c7d 202d 2d70 726f  point_url} --pro
-00029c10: 6669 6c65 3d72 3227 0a0a 2020 2020 4073  file=r2'..    @s
-00029c20: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
-00029c30: 6465 6620 636c 695f 636f 756e 745f 6669  def cli_count_fi
-00029c40: 6c65 5f69 6e5f 6275 636b 6574 2873 746f  le_in_bucket(sto
-00029c50: 7265 5f74 7970 652c 2062 7563 6b65 745f  re_type, bucket_
-00029c60: 6e61 6d65 293a 0a20 2020 2020 2020 2069  name):.        i
-00029c70: 6620 7374 6f72 655f 7479 7065 203d 3d20  f store_type == 
-00029c80: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-00029c90: 6554 7970 652e 5333 3a0a 2020 2020 2020  eType.S3:.      
-00029ca0: 2020 2020 2020 7265 7475 726e 2066 2761        return f'a
-00029cb0: 7773 2073 3320 6c73 2073 333a 2f2f 7b62  ws s3 ls s3://{b
-00029cc0: 7563 6b65 745f 6e61 6d65 7d20 2d2d 7265  ucket_name} --re
-00029cd0: 6375 7273 6976 6520 7c20 7763 202d 6c27  cursive | wc -l'
-00029ce0: 0a20 2020 2020 2020 2065 6c69 6620 7374  .        elif st
-00029cf0: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
-00029d00: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-00029d10: 652e 4743 533a 0a20 2020 2020 2020 2020  e.GCS:.         
-00029d20: 2020 2072 6574 7572 6e20 6627 6773 7574     return f'gsut
-00029d30: 696c 206c 7320 2d72 2067 733a 2f2f 7b62  il ls -r gs://{b
-00029d40: 7563 6b65 745f 6e61 6d65 7d2f 2a2a 207c  ucket_name}/** |
-00029d50: 2077 6320 2d6c 270a 2020 2020 2020 2020   wc -l'.        
-00029d60: 656c 6966 2073 746f 7265 5f74 7970 6520  elif store_type 
-00029d70: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
-00029d80: 746f 7265 5479 7065 2e52 323a 0a20 2020  toreType.R2:.   
-00029d90: 2020 2020 2020 2020 2065 6e64 706f 696e           endpoin
-00029da0: 745f 7572 6c20 3d20 636c 6f75 6466 6c61  t_url = cloudfla
-00029db0: 7265 2e63 7265 6174 655f 656e 6470 6f69  re.create_endpoi
-00029dc0: 6e74 2829 0a20 2020 2020 2020 2020 2020  nt().           
-00029dd0: 2072 6574 7572 6e20 6627 4157 535f 5348   return f'AWS_SH
-00029de0: 4152 4544 5f43 5245 4445 4e54 4941 4c53  ARED_CREDENTIALS
-00029df0: 5f46 494c 453d 7b63 6c6f 7564 666c 6172  _FILE={cloudflar
-00029e00: 652e 5232 5f43 5245 4445 4e54 4941 4c53  e.R2_CREDENTIALS
-00029e10: 5f50 4154 487d 2061 7773 2073 3320 6c73  _PATH} aws s3 ls
-00029e20: 2073 333a 2f2f 7b62 7563 6b65 745f 6e61   s3://{bucket_na
-00029e30: 6d65 7d20 2d2d 7265 6375 7273 6976 6520  me} --recursive 
-00029e40: 2d2d 656e 6470 6f69 6e74 207b 656e 6470  --endpoint {endp
-00029e50: 6f69 6e74 5f75 726c 7d20 2d2d 7072 6f66  oint_url} --prof
-00029e60: 696c 653d 7232 207c 2077 6320 2d6c 270a  ile=r2 | wc -l'.
-00029e70: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
-00029e80: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
-00029e90: 5f73 6f75 7263 6528 7365 6c66 2c20 746d  _source(self, tm
-00029ea0: 705f 7061 7468 293a 0a20 2020 2020 2020  p_path):.       
-00029eb0: 2023 2043 7265 6174 6573 2061 2074 656d   # Creates a tem
-00029ec0: 706f 7261 7279 2064 6972 6563 746f 7279  porary directory
-00029ed0: 2077 6974 6820 6120 6669 6c65 2069 6e20   with a file in 
-00029ee0: 6974 0a20 2020 2020 2020 2074 6d70 5f64  it.        tmp_d
-00029ef0: 6972 203d 2074 6d70 5f70 6174 6820 2f20  ir = tmp_path / 
-00029f00: 2774 6d70 2d73 6f75 7263 6527 0a20 2020  'tmp-source'.   
-00029f10: 2020 2020 2074 6d70 5f64 6972 2e6d 6b64       tmp_dir.mkd
-00029f20: 6972 2829 0a20 2020 2020 2020 2074 6d70  ir().        tmp
-00029f30: 5f66 696c 6520 3d20 746d 705f 6469 7220  _file = tmp_dir 
-00029f40: 2f20 2774 6d70 2d66 696c 6527 0a20 2020  / 'tmp-file'.   
-00029f50: 2020 2020 2074 6d70 5f66 696c 652e 7772       tmp_file.wr
-00029f60: 6974 655f 7465 7874 2827 7465 7374 2729  ite_text('test')
-00029f70: 0a20 2020 2020 2020 2063 6972 636c 655f  .        circle_
-00029f80: 6c69 6e6b 203d 2074 6d70 5f64 6972 202f  link = tmp_dir /
-00029f90: 2027 6369 7263 6c65 2d6c 696e 6b27 0a20   'circle-link'. 
-00029fa0: 2020 2020 2020 2063 6972 636c 655f 6c69         circle_li
-00029fb0: 6e6b 2e73 796d 6c69 6e6b 5f74 6f28 746d  nk.symlink_to(tm
-00029fc0: 705f 6469 722c 2074 6172 6765 745f 6973  p_dir, target_is
-00029fd0: 5f64 6972 6563 746f 7279 3d54 7275 6529  _directory=True)
-00029fe0: 0a20 2020 2020 2020 2079 6965 6c64 2073  .        yield s
-00029ff0: 7472 2874 6d70 5f64 6972 290a 0a20 2020  tr(tmp_dir)..   
-0002a000: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
-0002a010: 2020 2064 6566 2067 656e 6572 6174 655f     def generate_
-0002a020: 6275 636b 6574 5f6e 616d 6528 293a 0a20  bucket_name():. 
-0002a030: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
-0002a040: 2061 2074 656d 706f 7261 7279 2062 7563   a temporary buc
-0002a050: 6b65 7420 6e61 6d65 0a20 2020 2020 2020  ket name.       
-0002a060: 2023 2074 696d 652e 7469 6d65 2829 2072   # time.time() r
-0002a070: 6574 7572 6e73 2076 6172 7969 6e67 2070  eturns varying p
-0002a080: 7265 6369 7369 6f6e 206f 6e20 6469 6666  recision on diff
-0002a090: 6572 656e 7420 7379 7374 656d 732c 2073  erent systems, s
-0002a0a0: 6f20 7765 0a20 2020 2020 2020 2023 2072  o we.        # r
-0002a0b0: 6570 6c61 6365 2074 6865 2064 6563 696d  eplace the decim
-0002a0c0: 616c 2070 6f69 6e74 2061 6e64 2075 7365  al point and use
-0002a0d0: 2077 6861 7465 7665 7220 7072 6563 6973   whatever precis
-0002a0e0: 696f 6e20 7765 2063 616e 2067 6574 2e0a  ion we can get..
-0002a0f0: 2020 2020 2020 2020 7469 6d65 7374 616d          timestam
-0002a100: 7020 3d20 7374 7228 7469 6d65 2e74 696d  p = str(time.tim
-0002a110: 6528 2929 2e72 6570 6c61 6365 2827 2e27  e()).replace('.'
-0002a120: 2c20 2727 290a 2020 2020 2020 2020 7265  , '').        re
-0002a130: 7475 726e 2066 2773 6b79 2d74 6573 742d  turn f'sky-test-
-0002a140: 7b74 696d 6573 7461 6d70 7d27 0a0a 2020  {timestamp}'..  
-0002a150: 2020 4070 7974 6573 742e 6669 7874 7572    @pytest.fixtur
-0002a160: 650a 2020 2020 6465 6620 746d 705f 6275  e.    def tmp_bu
-0002a170: 636b 6574 5f6e 616d 6528 7365 6c66 293a  cket_name(self):
-0002a180: 0a20 2020 2020 2020 2079 6965 6c64 2073  .        yield s
-0002a190: 656c 662e 6765 6e65 7261 7465 5f62 7563  elf.generate_buc
-0002a1a0: 6b65 745f 6e61 6d65 2829 0a0a 2020 2020  ket_name()..    
-0002a1b0: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
-0002a1c0: 2020 6465 6620 7969 656c 645f 7374 6f72    def yield_stor
-0002a1d0: 6167 655f 6f62 6a65 6374 280a 2020 2020  age_object(.    
-0002a1e0: 2020 2020 2020 2020 6e61 6d65 3a20 4f70          name: Op
-0002a1f0: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
-0002a200: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-0002a210: 736f 7572 6365 3a20 4f70 7469 6f6e 616c  source: Optional
-0002a220: 5b73 746f 7261 6765 5f6c 6962 2e50 6174  [storage_lib.Pat
-0002a230: 685d 203d 204e 6f6e 652c 0a20 2020 2020  h] = None,.     
-0002a240: 2020 2020 2020 2073 746f 7265 733a 204f         stores: O
-0002a250: 7074 696f 6e61 6c5b 4469 6374 5b73 746f  ptional[Dict[sto
-0002a260: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-0002a270: 7065 2c0a 2020 2020 2020 2020 2020 2020  pe,.            
-0002a280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a290: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
-0002a2a0: 622e 4162 7374 7261 6374 5374 6f72 655d  b.AbstractStore]
-0002a2b0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
-0002a2c0: 2020 2020 2020 7065 7273 6973 7465 6e74        persistent
-0002a2d0: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
-0002a2e0: 203d 2054 7275 652c 0a20 2020 2020 2020   = True,.       
-0002a2f0: 2020 2020 206d 6f64 653a 2073 746f 7261       mode: stora
-0002a300: 6765 5f6c 6962 2e53 746f 7261 6765 4d6f  ge_lib.StorageMo
-0002a310: 6465 203d 2073 746f 7261 6765 5f6c 6962  de = storage_lib
-0002a320: 2e53 746f 7261 6765 4d6f 6465 2e4d 4f55  .StorageMode.MOU
-0002a330: 4e54 293a 0a20 2020 2020 2020 2023 2043  NT):.        # C
-0002a340: 7265 6174 6573 2061 2074 656d 706f 7261  reates a tempora
-0002a350: 7279 2073 746f 7261 6765 206f 626a 6563  ry storage objec
-0002a360: 742e 2053 746f 7265 7320 6d75 7374 2062  t. Stores must b
-0002a370: 6520 6164 6465 6420 696e 2074 6865 2074  e added in the t
-0002a380: 6573 742e 0a20 2020 2020 2020 2073 746f  est..        sto
-0002a390: 7261 6765 5f6f 626a 203d 2073 746f 7261  rage_obj = stora
-0002a3a0: 6765 5f6c 6962 2e53 746f 7261 6765 286e  ge_lib.Storage(n
-0002a3b0: 616d 653d 6e61 6d65 2c0a 2020 2020 2020  ame=name,.      
-0002a3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a3e0: 2020 2020 736f 7572 6365 3d73 6f75 7263      source=sourc
-0002a3f0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0002a400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a410: 2020 2020 2020 2020 2020 2020 2073 746f               sto
-0002a420: 7265 733d 7374 6f72 6573 2c0a 2020 2020  res=stores,.    
-0002a430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a450: 2020 2020 2020 7065 7273 6973 7465 6e74        persistent
-0002a460: 3d70 6572 7369 7374 656e 742c 0a20 2020  =persistent,.   
-0002a470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a490: 2020 2020 2020 206d 6f64 653d 6d6f 6465         mode=mode
-0002a4a0: 290a 2020 2020 2020 2020 7969 656c 6420  ).        yield 
-0002a4b0: 7374 6f72 6167 655f 6f62 6a0a 2020 2020  storage_obj.    
-0002a4c0: 2020 2020 6861 6e64 6c65 203d 2067 6c6f      handle = glo
-0002a4d0: 6261 6c5f 7573 6572 5f73 7461 7465 2e67  bal_user_state.g
-0002a4e0: 6574 5f68 616e 646c 655f 6672 6f6d 5f73  et_handle_from_s
-0002a4f0: 746f 7261 6765 5f6e 616d 6528 0a20 2020  torage_name(.   
-0002a500: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-0002a510: 5f6f 626a 2e6e 616d 6529 0a20 2020 2020  _obj.name).     
-0002a520: 2020 2069 6620 6861 6e64 6c65 3a0a 2020     if handle:.  
-0002a530: 2020 2020 2020 2020 2020 2320 4966 2068            # If h
-0002a540: 616e 646c 6520 6578 6973 7473 2c20 6465  andle exists, de
-0002a550: 6c65 7465 206d 616e 7561 6c6c 790a 2020  lete manually.  
-0002a560: 2020 2020 2020 2020 2020 2320 544f 444f            # TODO
-0002a570: 2872 6f6d 696c 6229 3a20 5468 6973 2069  (romilb): This i
-0002a580: 7320 706f 7465 6e74 6961 6c6c 7920 7269  s potentially ri
-0002a590: 736b 7920 2d20 6966 2074 6865 2064 656c  sky - if the del
-0002a5a0: 6574 6520 6d65 7468 6f64 2068 6173 0a20  ete method has. 
-0002a5b0: 2020 2020 2020 2020 2020 2023 2020 2062             #   b
-0002a5c0: 7567 732c 2074 6869 7320 6361 6e20 6361  ugs, this can ca
-0002a5d0: 7573 6520 7265 736f 7572 6365 206c 6561  use resource lea
-0002a5e0: 6b73 2e20 4964 6561 6c6c 7920 7765 2073  ks. Ideally we s
-0002a5f0: 686f 756c 6420 6d61 6e75 616c 6c79 0a20  hould manually. 
-0002a600: 2020 2020 2020 2020 2020 2023 2020 2065             #   e
-0002a610: 6a65 6374 2073 746f 7261 6765 2066 726f  ject storage fro
-0002a620: 6d20 676c 6f62 616c 5f75 7365 725f 7374  m global_user_st
-0002a630: 6174 6520 616e 6420 6465 6c65 7465 2074  ate and delete t
-0002a640: 6865 2062 7563 6b65 7420 7573 696e 670a  he bucket using.
-0002a650: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-0002a660: 626f 746f 3320 6469 7265 6374 6c79 2e0a  boto3 directly..
-0002a670: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-0002a680: 6167 655f 6f62 6a2e 6465 6c65 7465 2829  age_obj.delete()
-0002a690: 0a0a 2020 2020 4070 7974 6573 742e 6669  ..    @pytest.fi
-0002a6a0: 7874 7572 650a 2020 2020 6465 6620 746d  xture.    def tm
-0002a6b0: 705f 7363 7261 7463 685f 7374 6f72 6167  p_scratch_storag
-0002a6c0: 655f 6f62 6a28 7365 6c66 2c20 746d 705f  e_obj(self, tmp_
-0002a6d0: 6275 636b 6574 5f6e 616d 6529 3a0a 2020  bucket_name):.  
-0002a6e0: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
-0002a6f0: 6120 7374 6f72 6167 6520 6f62 6a65 6374  a storage object
-0002a700: 2077 6974 6820 6e6f 2073 6f75 7263 6520   with no source 
-0002a710: 746f 2063 7265 6174 6520 6120 7363 7261  to create a scra
-0002a720: 7463 6820 7374 6f72 6167 652e 0a20 2020  tch storage..   
-0002a730: 2020 2020 2023 2053 746f 7265 7320 6d75       # Stores mu
-0002a740: 7374 2062 6520 6164 6465 6420 696e 2074  st be added in t
-0002a750: 6865 2074 6573 742e 0a20 2020 2020 2020  he test..       
-0002a760: 2079 6965 6c64 2066 726f 6d20 7365 6c66   yield from self
-0002a770: 2e79 6965 6c64 5f73 746f 7261 6765 5f6f  .yield_storage_o
-0002a780: 626a 6563 7428 6e61 6d65 3d74 6d70 5f62  bject(name=tmp_b
-0002a790: 7563 6b65 745f 6e61 6d65 290a 0a20 2020  ucket_name)..   
-0002a7a0: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
-0002a7b0: 0a20 2020 2064 6566 2074 6d70 5f6d 756c  .    def tmp_mul
-0002a7c0: 7469 706c 655f 7363 7261 7463 685f 7374  tiple_scratch_st
-0002a7d0: 6f72 6167 655f 6f62 6a28 7365 6c66 293a  orage_obj(self):
-0002a7e0: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
-0002a7f0: 6573 2061 206c 6973 7420 6f66 2035 2073  es a list of 5 s
-0002a800: 746f 7261 6765 206f 626a 6563 7473 2077  torage objects w
-0002a810: 6974 6820 6e6f 2073 6f75 7263 6520 746f  ith no source to
-0002a820: 2063 7265 6174 650a 2020 2020 2020 2020   create.        
-0002a830: 2320 6d75 6c74 6970 6c65 2073 6372 6174  # multiple scrat
-0002a840: 6368 2073 746f 7261 6765 732e 0a20 2020  ch storages..   
-0002a850: 2020 2020 2023 2053 746f 7265 7320 666f       # Stores fo
-0002a860: 7220 6561 6368 206f 626a 6563 7420 696e  r each object in
-0002a870: 2074 6865 206c 6973 7420 6d75 7374 2062   the list must b
-0002a880: 6520 6164 6465 6420 696e 2074 6865 2074  e added in the t
-0002a890: 6573 742e 0a20 2020 2020 2020 2073 746f  est..        sto
-0002a8a0: 7261 6765 5f6d 756c 745f 6f62 6a20 3d20  rage_mult_obj = 
-0002a8b0: 5b5d 0a20 2020 2020 2020 2066 6f72 205f  [].        for _
-0002a8c0: 2069 6e20 7261 6e67 6528 3529 3a0a 2020   in range(5):.  
-0002a8d0: 2020 2020 2020 2020 2020 7469 6d65 7374            timest
-0002a8e0: 616d 7020 3d20 7374 7228 7469 6d65 2e74  amp = str(time.t
-0002a8f0: 696d 6528 2929 2e72 6570 6c61 6365 2827  ime()).replace('
-0002a900: 2e27 2c20 2727 290a 2020 2020 2020 2020  .', '').        
-0002a910: 2020 2020 7374 6f72 655f 6f62 6a20 3d20      store_obj = 
-0002a920: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002a930: 6167 6528 6e61 6d65 3d66 2773 6b79 2d74  age(name=f'sky-t
-0002a940: 6573 742d 7b74 696d 6573 7461 6d70 7d27  est-{timestamp}'
-0002a950: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
-0002a960: 6f72 6167 655f 6d75 6c74 5f6f 626a 2e61  orage_mult_obj.a
-0002a970: 7070 656e 6428 7374 6f72 655f 6f62 6a29  ppend(store_obj)
-0002a980: 0a20 2020 2020 2020 2079 6965 6c64 2073  .        yield s
-0002a990: 746f 7261 6765 5f6d 756c 745f 6f62 6a0a  torage_mult_obj.
-0002a9a0: 2020 2020 2020 2020 666f 7220 7374 6f72          for stor
-0002a9b0: 6167 655f 6f62 6a20 696e 2073 746f 7261  age_obj in stora
-0002a9c0: 6765 5f6d 756c 745f 6f62 6a3a 0a20 2020  ge_mult_obj:.   
-0002a9d0: 2020 2020 2020 2020 2068 616e 646c 6520           handle 
-0002a9e0: 3d20 676c 6f62 616c 5f75 7365 725f 7374  = global_user_st
-0002a9f0: 6174 652e 6765 745f 6861 6e64 6c65 5f66  ate.get_handle_f
-0002aa00: 726f 6d5f 7374 6f72 6167 655f 6e61 6d65  rom_storage_name
-0002aa10: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0002aa20: 2020 7374 6f72 6167 655f 6f62 6a2e 6e61    storage_obj.na
-0002aa30: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-0002aa40: 6966 2068 616e 646c 653a 0a20 2020 2020  if handle:.     
-0002aa50: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
-0002aa60: 6861 6e64 6c65 2065 7869 7374 732c 2064  handle exists, d
-0002aa70: 656c 6574 6520 6d61 6e75 616c 6c79 0a20  elete manually. 
-0002aa80: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0002aa90: 2054 4f44 4f28 726f 6d69 6c62 293a 2054   TODO(romilb): T
-0002aaa0: 6869 7320 6973 2070 6f74 656e 7469 616c  his is potential
-0002aab0: 6c79 2072 6973 6b79 202d 2069 6620 7468  ly risky - if th
-0002aac0: 6520 6465 6c65 7465 206d 6574 686f 6420  e delete method 
-0002aad0: 6861 730a 2020 2020 2020 2020 2020 2020  has.            
-0002aae0: 2020 2020 2320 6275 6773 2c20 7468 6973      # bugs, this
-0002aaf0: 2063 616e 2063 6175 7365 2072 6573 6f75   can cause resou
-0002ab00: 7263 6520 6c65 616b 732e 2049 6465 616c  rce leaks. Ideal
-0002ab10: 6c79 2077 6520 7368 6f75 6c64 206d 616e  ly we should man
-0002ab20: 7561 6c6c 790a 2020 2020 2020 2020 2020  ually.          
-0002ab30: 2020 2020 2020 2320 656a 6563 7420 7374        # eject st
-0002ab40: 6f72 6167 6520 6672 6f6d 2067 6c6f 6261  orage from globa
-0002ab50: 6c5f 7573 6572 5f73 7461 7465 2061 6e64  l_user_state and
-0002ab60: 2064 656c 6574 6520 7468 6520 6275 636b   delete the buck
-0002ab70: 6574 2075 7369 6e67 0a20 2020 2020 2020  et using.       
-0002ab80: 2020 2020 2020 2020 2023 2062 6f74 6f33           # boto3
-0002ab90: 2064 6972 6563 746c 792e 0a20 2020 2020   directly..     
-0002aba0: 2020 2020 2020 2020 2020 2073 746f 7261             stora
-0002abb0: 6765 5f6f 626a 2e64 656c 6574 6528 290a  ge_obj.delete().
-0002abc0: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
-0002abd0: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
-0002abe0: 5f6d 756c 7469 706c 655f 6375 7374 6f6d  _multiple_custom
-0002abf0: 5f73 6f75 7263 655f 7374 6f72 6167 655f  _source_storage_
-0002ac00: 6f62 6a28 7365 6c66 293a 0a20 2020 2020  obj(self):.     
-0002ac10: 2020 2023 2043 7265 6174 6573 2061 206c     # Creates a l
-0002ac20: 6973 7420 6f66 2073 746f 7261 6765 206f  ist of storage o
-0002ac30: 626a 6563 7473 2077 6974 6820 6375 7374  bjects with cust
-0002ac40: 6f6d 2073 6f75 7263 6520 6e61 6d65 7320  om source names 
-0002ac50: 746f 0a20 2020 2020 2020 2023 2063 7265  to.        # cre
-0002ac60: 6174 6520 6d75 6c74 6970 6c65 2073 6372  ate multiple scr
-0002ac70: 6174 6368 2073 746f 7261 6765 732e 0a20  atch storages.. 
-0002ac80: 2020 2020 2020 2023 2053 746f 7265 7320         # Stores 
-0002ac90: 666f 7220 6561 6368 206f 626a 6563 7420  for each object 
-0002aca0: 696e 2074 6865 206c 6973 7420 6d75 7374  in the list must
-0002acb0: 2062 6520 6164 6465 6420 696e 2074 6865   be added in the
-0002acc0: 2074 6573 742e 0a20 2020 2020 2020 2063   test..        c
-0002acd0: 7573 746f 6d5f 736f 7572 6365 5f6e 616d  ustom_source_nam
-0002ace0: 6573 203d 205b 2722 7061 7468 2057 6974  es = ['"path Wit
-0002acf0: 6820 5370 6163 6573 2227 2c20 2770 6174  h Spaces"', 'pat
-0002ad00: 6820 5769 7468 2053 7061 6365 7327 5d0a  h With Spaces'].
-0002ad10: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-0002ad20: 6d75 6c74 5f6f 626a 203d 205b 5d0a 2020  mult_obj = [].  
-0002ad30: 2020 2020 2020 666f 7220 6e61 6d65 2069        for name i
-0002ad40: 6e20 6375 7374 6f6d 5f73 6f75 7263 655f  n custom_source_
-0002ad50: 6e61 6d65 733a 0a20 2020 2020 2020 2020  names:.         
-0002ad60: 2020 2073 7263 5f70 6174 6820 3d20 6f73     src_path = os
-0002ad70: 2e70 6174 682e 6578 7061 6e64 7573 6572  .path.expanduser
-0002ad80: 2866 277e 2f7b 6e61 6d65 7d27 290a 2020  (f'~/{name}').  
-0002ad90: 2020 2020 2020 2020 2020 7061 7468 6c69            pathli
-0002ada0: 622e 5061 7468 2873 7263 5f70 6174 6829  b.Path(src_path)
-0002adb0: 2e65 7870 616e 6475 7365 7228 292e 6d6b  .expanduser().mk
-0002adc0: 6469 7228 6578 6973 745f 6f6b 3d54 7275  dir(exist_ok=Tru
-0002add0: 6529 0a20 2020 2020 2020 2020 2020 2074  e).            t
-0002ade0: 696d 6573 7461 6d70 203d 2073 7472 2874  imestamp = str(t
-0002adf0: 696d 652e 7469 6d65 2829 292e 7265 706c  ime.time()).repl
-0002ae00: 6163 6528 272e 272c 2027 2729 0a20 2020  ace('.', '').   
-0002ae10: 2020 2020 2020 2020 2073 746f 7265 5f6f           store_o
-0002ae20: 626a 203d 2073 746f 7261 6765 5f6c 6962  bj = storage_lib
-0002ae30: 2e53 746f 7261 6765 286e 616d 653d 6627  .Storage(name=f'
-0002ae40: 736b 792d 7465 7374 2d7b 7469 6d65 7374  sky-test-{timest
-0002ae50: 616d 707d 272c 0a20 2020 2020 2020 2020  amp}',.         
-0002ae60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ae70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ae80: 2020 2073 6f75 7263 653d 7372 635f 7061     source=src_pa
-0002ae90: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
-0002aea0: 7374 6f72 6167 655f 6d75 6c74 5f6f 626a  storage_mult_obj
-0002aeb0: 2e61 7070 656e 6428 7374 6f72 655f 6f62  .append(store_ob
-0002aec0: 6a29 0a20 2020 2020 2020 2079 6965 6c64  j).        yield
-0002aed0: 2073 746f 7261 6765 5f6d 756c 745f 6f62   storage_mult_ob
-0002aee0: 6a0a 2020 2020 2020 2020 666f 7220 7374  j.        for st
-0002aef0: 6f72 6167 655f 6f62 6a20 696e 2073 746f  orage_obj in sto
-0002af00: 7261 6765 5f6d 756c 745f 6f62 6a3a 0a20  rage_mult_obj:. 
-0002af10: 2020 2020 2020 2020 2020 2068 616e 646c             handl
-0002af20: 6520 3d20 676c 6f62 616c 5f75 7365 725f  e = global_user_
-0002af30: 7374 6174 652e 6765 745f 6861 6e64 6c65  state.get_handle
-0002af40: 5f66 726f 6d5f 7374 6f72 6167 655f 6e61  _from_storage_na
-0002af50: 6d65 280a 2020 2020 2020 2020 2020 2020  me(.            
-0002af60: 2020 2020 7374 6f72 6167 655f 6f62 6a2e      storage_obj.
-0002af70: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
-0002af80: 2020 6966 2068 616e 646c 653a 0a20 2020    if handle:.   
-0002af90: 2020 2020 2020 2020 2020 2020 2073 746f               sto
-0002afa0: 7261 6765 5f6f 626a 2e64 656c 6574 6528  rage_obj.delete(
-0002afb0: 290a 0a20 2020 2040 7079 7465 7374 2e66  )..    @pytest.f
-0002afc0: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
-0002afd0: 6d70 5f6c 6f63 616c 5f73 746f 7261 6765  mp_local_storage
-0002afe0: 5f6f 626a 2873 656c 662c 2074 6d70 5f62  _obj(self, tmp_b
-0002aff0: 7563 6b65 745f 6e61 6d65 2c20 746d 705f  ucket_name, tmp_
-0002b000: 736f 7572 6365 293a 0a20 2020 2020 2020  source):.       
-0002b010: 2023 2043 7265 6174 6573 2061 2074 656d   # Creates a tem
-0002b020: 706f 7261 7279 2073 746f 7261 6765 206f  porary storage o
-0002b030: 626a 6563 742e 2053 746f 7265 7320 6d75  bject. Stores mu
-0002b040: 7374 2062 6520 6164 6465 6420 696e 2074  st be added in t
-0002b050: 6865 2074 6573 742e 0a20 2020 2020 2020  he test..       
-0002b060: 2079 6965 6c64 2066 726f 6d20 7365 6c66   yield from self
-0002b070: 2e79 6965 6c64 5f73 746f 7261 6765 5f6f  .yield_storage_o
-0002b080: 626a 6563 7428 6e61 6d65 3d74 6d70 5f62  bject(name=tmp_b
-0002b090: 7563 6b65 745f 6e61 6d65 2c0a 2020 2020  ucket_name,.    
-0002b0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012200: 2d2d 2d2d 2d2d 2d2d 2d20 4c61 6265 6c73  --------- Labels
+00012210: 2066 726f 6d20 7461 736b 206f 6e20 4157   from task on AW
+00012220: 5320 2869 6e73 7461 6e63 655f 7461 6773  S (instance_tags
+00012230: 2920 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  ) ----------.@py
+00012240: 7465 7374 2e6d 6172 6b2e 6177 730a 6465  test.mark.aws.de
+00012250: 6620 7465 7374 5f74 6173 6b5f 6c61 6265  f test_task_labe
+00012260: 6c73 5f61 7773 2829 3a0a 2020 2020 6e61  ls_aws():.    na
+00012270: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00012280: 725f 6e61 6d65 2829 0a20 2020 2074 656d  r_name().    tem
+00012290: 706c 6174 655f 7374 7220 3d20 7061 7468  plate_str = path
+000122a0: 6c69 622e 5061 7468 280a 2020 2020 2020  lib.Path(.      
+000122b0: 2020 2774 6573 7473 2f74 6573 745f 7961    'tests/test_ya
+000122c0: 6d6c 732f 7465 7374 5f6c 6162 656c 732e  mls/test_labels.
+000122d0: 7961 6d6c 2e6a 3227 292e 7265 6164 5f74  yaml.j2').read_t
+000122e0: 6578 7428 290a 2020 2020 7465 6d70 6c61  ext().    templa
+000122f0: 7465 203d 206a 696e 6a61 322e 5465 6d70  te = jinja2.Temp
+00012300: 6c61 7465 2874 656d 706c 6174 655f 7374  late(template_st
+00012310: 7229 0a20 2020 2063 6f6e 7465 6e74 203d  r).    content =
+00012320: 2074 656d 706c 6174 652e 7265 6e64 6572   template.render
+00012330: 2863 6c6f 7564 3d27 6177 7327 2c20 7265  (cloud='aws', re
+00012340: 6769 6f6e 3d27 7573 2d65 6173 742d 3127  gion='us-east-1'
+00012350: 290a 2020 2020 7769 7468 2074 656d 7066  ).    with tempf
+00012360: 696c 652e 4e61 6d65 6454 656d 706f 7261  ile.NamedTempora
+00012370: 7279 4669 6c65 2873 7566 6669 783d 272e  ryFile(suffix='.
+00012380: 7961 6d6c 272c 206d 6f64 653d 2777 2729  yaml', mode='w')
+00012390: 2061 7320 663a 0a20 2020 2020 2020 2066   as f:.        f
+000123a0: 2e77 7269 7465 2863 6f6e 7465 6e74 290a  .write(content).
+000123b0: 2020 2020 2020 2020 662e 666c 7573 6828          f.flush(
+000123c0: 290a 2020 2020 2020 2020 6669 6c65 5f70  ).        file_p
+000123d0: 6174 6820 3d20 662e 6e61 6d65 0a20 2020  ath = f.name.   
+000123e0: 2020 2020 2074 6573 7420 3d20 5465 7374       test = Test
+000123f0: 280a 2020 2020 2020 2020 2020 2020 2774  (.            't
+00012400: 6173 6b5f 6c61 6265 6c73 5f61 7773 272c  ask_labels_aws',
+00012410: 0a20 2020 2020 2020 2020 2020 205b 0a20  .            [. 
+00012420: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00012430: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00012440: 6320 7b6e 616d 657d 207b 6669 6c65 5f70  c {name} {file_p
+00012450: 6174 687d 272c 0a20 2020 2020 2020 2020  ath}',.         
+00012460: 2020 2020 2020 2023 2056 6572 6966 7920         # Verify 
+00012470: 7769 7468 2061 7773 2063 6c69 2074 6861  with aws cli tha
+00012480: 7420 7468 6520 7461 6773 2061 7265 2073  t the tags are s
+00012490: 6574 2e0a 2020 2020 2020 2020 2020 2020  et..            
+000124a0: 2020 2020 2761 7773 2065 6332 2064 6573      'aws ec2 des
+000124b0: 6372 6962 652d 696e 7374 616e 6365 7320  cribe-instances 
+000124c0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+000124d0: 2020 272d 2d71 7565 7279 2022 5265 7365    '--query "Rese
+000124e0: 7276 6174 696f 6e73 5b2a 5d2e 496e 7374  rvations[*].Inst
+000124f0: 616e 6365 735b 2a5d 2e49 6e73 7461 6e63  ances[*].Instanc
+00012500: 6549 6422 2027 0a20 2020 2020 2020 2020  eId" '.         
+00012510: 2020 2020 2020 2027 2d2d 6669 6c74 6572         '--filter
+00012520: 7320 224e 616d 653d 696e 7374 616e 6365  s "Name=instance
+00012530: 2d73 7461 7465 2d6e 616d 652c 5661 6c75  -state-name,Valu
+00012540: 6573 3d72 756e 6e69 6e67 2220 270a 2020  es=running" '.  
+00012550: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00012560: 2d2d 6669 6c74 6572 7320 224e 616d 653d  --filters "Name=
+00012570: 7461 673a 736b 7970 696c 6f74 2d63 6c75  tag:skypilot-clu
+00012580: 7374 6572 2d6e 616d 652c 5661 6c75 6573  ster-name,Values
+00012590: 3d7b 6e61 6d65 7d2a 2220 270a 2020 2020  ={name}*" '.    
+000125a0: 2020 2020 2020 2020 2020 2020 272d 2d66              '--f
+000125b0: 696c 7465 7273 2022 4e61 6d65 3d74 6167  ilters "Name=tag
+000125c0: 3a69 6e6c 696e 656c 6162 656c 312c 5661  :inlinelabel1,Va
+000125d0: 6c75 6573 3d69 6e6c 696e 6576 616c 7565  lues=inlinevalue
+000125e0: 3122 2027 0a20 2020 2020 2020 2020 2020  1" '.           
+000125f0: 2020 2020 2027 2d2d 6669 6c74 6572 7320       '--filters 
+00012600: 224e 616d 653d 7461 673a 696e 6c69 6e65  "Name=tag:inline
+00012610: 6c61 6265 6c32 2c56 616c 7565 733d 696e  label2,Values=in
+00012620: 6c69 6e65 7661 6c75 6532 2220 270a 2020  linevalue2" '.  
+00012630: 2020 2020 2020 2020 2020 2020 2020 272d                '-
+00012640: 2d72 6567 696f 6e20 7573 2d65 6173 742d  -region us-east-
+00012650: 3120 2d2d 6f75 7470 7574 2074 6578 7427  1 --output text'
+00012660: 2c0a 2020 2020 2020 2020 2020 2020 5d2c  ,.            ],
+00012670: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00012680: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00012690: 7d27 2c0a 2020 2020 2020 2020 290a 2020  }',.        ).  
+000126a0: 2020 2020 2020 7275 6e5f 6f6e 655f 7465        run_one_te
+000126b0: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
+000126c0: 2d2d 2d2d 2d2d 2d20 4c61 6265 6c73 2066  ------- Labels f
+000126d0: 726f 6d20 7461 736b 206f 6e20 4743 5020  rom task on GCP 
+000126e0: 286c 6162 656c 7329 202d 2d2d 2d2d 2d2d  (labels) -------
+000126f0: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
+00012700: 2e67 6370 0a64 6566 2074 6573 745f 7461  .gcp.def test_ta
+00012710: 736b 5f6c 6162 656c 735f 6763 7028 293a  sk_labels_gcp():
+00012720: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00012730: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00012740: 2020 2020 7465 6d70 6c61 7465 5f73 7472      template_str
+00012750: 203d 2070 6174 686c 6962 2e50 6174 6828   = pathlib.Path(
+00012760: 0a20 2020 2020 2020 2027 7465 7374 732f  .        'tests/
+00012770: 7465 7374 5f79 616d 6c73 2f74 6573 745f  test_yamls/test_
+00012780: 6c61 6265 6c73 2e79 616d 6c2e 6a32 2729  labels.yaml.j2')
+00012790: 2e72 6561 645f 7465 7874 2829 0a20 2020  .read_text().   
+000127a0: 2074 656d 706c 6174 6520 3d20 6a69 6e6a   template = jinj
+000127b0: 6132 2e54 656d 706c 6174 6528 7465 6d70  a2.Template(temp
+000127c0: 6c61 7465 5f73 7472 290a 2020 2020 636f  late_str).    co
+000127d0: 6e74 656e 7420 3d20 7465 6d70 6c61 7465  ntent = template
+000127e0: 2e72 656e 6465 7228 636c 6f75 643d 2767  .render(cloud='g
+000127f0: 6370 2729 0a20 2020 2077 6974 6820 7465  cp').    with te
+00012800: 6d70 6669 6c65 2e4e 616d 6564 5465 6d70  mpfile.NamedTemp
+00012810: 6f72 6172 7946 696c 6528 7375 6666 6978  oraryFile(suffix
+00012820: 3d27 2e79 616d 6c27 2c20 6d6f 6465 3d27  ='.yaml', mode='
+00012830: 7727 2920 6173 2066 3a0a 2020 2020 2020  w') as f:.      
+00012840: 2020 662e 7772 6974 6528 636f 6e74 656e    f.write(conten
+00012850: 7429 0a20 2020 2020 2020 2066 2e66 6c75  t).        f.flu
+00012860: 7368 2829 0a20 2020 2020 2020 2066 696c  sh().        fil
+00012870: 655f 7061 7468 203d 2066 2e6e 616d 650a  e_path = f.name.
+00012880: 2020 2020 2020 2020 7465 7374 203d 2054          test = T
+00012890: 6573 7428 0a20 2020 2020 2020 2020 2020  est(.           
+000128a0: 2027 7461 736b 5f6c 6162 656c 735f 6763   'task_labels_gc
+000128b0: 7027 2c0a 2020 2020 2020 2020 2020 2020  p',.            
+000128c0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+000128d0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+000128e0: 7920 2d63 207b 6e61 6d65 7d20 7b66 696c  y -c {name} {fil
+000128f0: 655f 7061 7468 7d27 2c0a 2020 2020 2020  e_path}',.      
+00012900: 2020 2020 2020 2020 2020 2320 5665 7269            # Veri
+00012910: 6679 2077 6974 6820 6763 6c6f 7564 2063  fy with gcloud c
+00012920: 6c69 2074 6861 7420 7468 6520 7461 6773  li that the tags
+00012930: 2061 7265 2073 6574 0a20 2020 2020 2020   are set.       
+00012940: 2020 2020 2020 2020 2066 2767 636c 6f75           f'gclou
+00012950: 6420 636f 6d70 7574 6520 696e 7374 616e  d compute instan
+00012960: 6365 7320 6c69 7374 202d 2d66 696c 7465  ces list --filte
+00012970: 723d 226e 616d 657e 5c27 5e7b 6e61 6d65  r="name~\'^{name
+00012980: 7d5c 2720 414e 4420 270a 2020 2020 2020  }\' AND '.      
+00012990: 2020 2020 2020 2020 2020 276c 6162 656c            'label
+000129a0: 732e 696e 6c69 6e65 6c61 6265 6c31 3d5c  s.inlinelabel1=\
+000129b0: 2769 6e6c 696e 6576 616c 7565 315c 2720  'inlinevalue1\' 
+000129c0: 414e 4420 270a 2020 2020 2020 2020 2020  AND '.          
+000129d0: 2020 2020 2020 276c 6162 656c 732e 696e        'labels.in
+000129e0: 6c69 6e65 6c61 6265 6c32 3d5c 2769 6e6c  linelabel2=\'inl
+000129f0: 696e 6576 616c 7565 325c 2722 2027 0a20  inevalue2\'" '. 
+00012a00: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00012a10: 2d2d 666f 726d 6174 3d22 7661 6c75 6528  --format="value(
+00012a20: 6e61 6d65 2922 207c 2067 7265 7020 2e27  name)" | grep .'
+00012a30: 2c0a 2020 2020 2020 2020 2020 2020 5d2c  ,.            ],
+00012a40: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00012a50: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00012a60: 7d27 2c0a 2020 2020 2020 2020 290a 2020  }',.        ).  
+00012a70: 2020 2020 2020 7275 6e5f 6f6e 655f 7465        run_one_te
+00012a80: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
+00012a90: 2d2d 2d2d 2d2d 2d20 4c61 6265 6c73 2066  ------- Labels f
+00012aa0: 726f 6d20 7461 736b 206f 6e20 4b75 6265  rom task on Kube
+00012ab0: 726e 6574 6573 2028 6c61 6265 6c73 2920  rnetes (labels) 
+00012ac0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
+00012ad0: 7374 2e6d 6172 6b2e 6b75 6265 726e 6574  st.mark.kubernet
+00012ae0: 6573 0a64 6566 2074 6573 745f 7461 736b  es.def test_task
+00012af0: 5f6c 6162 656c 735f 6b75 6265 726e 6574  _labels_kubernet
+00012b00: 6573 2829 3a0a 2020 2020 6e61 6d65 203d  es():.    name =
+00012b10: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00012b20: 6d65 2829 0a20 2020 2074 656d 706c 6174  me().    templat
+00012b30: 655f 7374 7220 3d20 7061 7468 6c69 622e  e_str = pathlib.
+00012b40: 5061 7468 280a 2020 2020 2020 2020 2774  Path(.        't
+00012b50: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+00012b60: 7465 7374 5f6c 6162 656c 732e 7961 6d6c  test_labels.yaml
+00012b70: 2e6a 3227 292e 7265 6164 5f74 6578 7428  .j2').read_text(
+00012b80: 290a 2020 2020 7465 6d70 6c61 7465 203d  ).    template =
+00012b90: 206a 696e 6a61 322e 5465 6d70 6c61 7465   jinja2.Template
+00012ba0: 2874 656d 706c 6174 655f 7374 7229 0a20  (template_str). 
+00012bb0: 2020 2063 6f6e 7465 6e74 203d 2074 656d     content = tem
+00012bc0: 706c 6174 652e 7265 6e64 6572 2863 6c6f  plate.render(clo
+00012bd0: 7564 3d27 6b75 6265 726e 6574 6573 2729  ud='kubernetes')
+00012be0: 0a20 2020 2077 6974 6820 7465 6d70 6669  .    with tempfi
+00012bf0: 6c65 2e4e 616d 6564 5465 6d70 6f72 6172  le.NamedTemporar
+00012c00: 7946 696c 6528 7375 6666 6978 3d27 2e79  yFile(suffix='.y
+00012c10: 616d 6c27 2c20 6d6f 6465 3d27 7727 2920  aml', mode='w') 
+00012c20: 6173 2066 3a0a 2020 2020 2020 2020 662e  as f:.        f.
+00012c30: 7772 6974 6528 636f 6e74 656e 7429 0a20  write(content). 
+00012c40: 2020 2020 2020 2066 2e66 6c75 7368 2829         f.flush()
+00012c50: 0a20 2020 2020 2020 2066 696c 655f 7061  .        file_pa
+00012c60: 7468 203d 2066 2e6e 616d 650a 2020 2020  th = f.name.    
+00012c70: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00012c80: 0a20 2020 2020 2020 2020 2020 2027 7461  .            'ta
+00012c90: 736b 5f6c 6162 656c 735f 6b75 6265 726e  sk_labels_kubern
+00012ca0: 6574 6573 272c 0a20 2020 2020 2020 2020  etes',.         
+00012cb0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00012cc0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00012cd0: 6820 2d79 202d 6320 7b6e 616d 657d 207b  h -y -c {name} {
+00012ce0: 6669 6c65 5f70 6174 687d 272c 0a20 2020  file_path}',.   
+00012cf0: 2020 2020 2020 2020 2020 2020 2023 2056               # V
+00012d00: 6572 6966 7920 7769 7468 206b 7562 6563  erify with kubec
+00012d10: 746c 2074 6861 7420 7468 6520 6c61 6265  tl that the labe
+00012d20: 6c73 2061 7265 2073 6574 2e0a 2020 2020  ls are set..    
+00012d30: 2020 2020 2020 2020 2020 2020 276b 7562              'kub
+00012d40: 6563 746c 2067 6574 2070 6f64 7320 270a  ectl get pods '.
+00012d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012d60: 272d 2d73 656c 6563 746f 7220 696e 6c69  '--selector inli
+00012d70: 6e65 6c61 6265 6c31 3d69 6e6c 696e 6576  nelabel1=inlinev
+00012d80: 616c 7565 3120 270a 2020 2020 2020 2020  alue1 '.        
+00012d90: 2020 2020 2020 2020 272d 2d73 656c 6563          '--selec
+00012da0: 746f 7220 696e 6c69 6e65 6c61 6265 6c32  tor inlinelabel2
+00012db0: 3d69 6e6c 696e 6576 616c 7565 3220 270a  =inlinevalue2 '.
+00012dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012dd0: 272d 6f20 6a73 6f6e 7061 7468 3d5c 277b  '-o jsonpath=\'{
+00012de0: 2e69 7465 6d73 5b2a 5d2e 6d65 7461 6461  .items[*].metada
+00012df0: 7461 2e6e 616d 657d 5c27 207c 2027 0a20  ta.name}\' | '. 
+00012e00: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00012e10: 2767 7265 7020 5c27 5e7b 6e61 6d65 7d5c  'grep \'^{name}\
+00012e20: 2727 0a20 2020 2020 2020 2020 2020 205d  ''.            ]
+00012e30: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00012e40: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+00012e50: 657d 272c 0a20 2020 2020 2020 2029 0a20  e}',.        ). 
+00012e60: 2020 2020 2020 2072 756e 5f6f 6e65 5f74         run_one_t
+00012e70: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+00012e80: 2d2d 2d2d 2d2d 2d2d 2054 6173 6b3a 206e  -------- Task: n
+00012e90: 3d32 206e 6f64 6573 2077 6974 6820 7365  =2 nodes with se
+00012ea0: 7475 7073 2e20 2d2d 2d2d 2d2d 2d2d 2d2d  tups. ----------
+00012eb0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00012ec0: 5f6c 616d 6264 615f 636c 6f75 6420 2023  _lambda_cloud  #
+00012ed0: 204c 616d 6264 6120 436c 6f75 6420 646f   Lambda Cloud do
+00012ee0: 6573 206e 6f74 2068 6176 6520 5631 3030  es not have V100
+00012ef0: 2067 7075 730a 4070 7974 6573 742e 6d61   gpus.@pytest.ma
+00012f00: 726b 2e6e 6f5f 6962 6d20 2023 2049 424d  rk.no_ibm  # IBM
+00012f10: 2063 6c6f 7564 2063 7572 7265 6e74 6c79   cloud currently
+00012f20: 2064 6f65 736e 2774 2070 726f 7669 6465   doesn't provide
+00012f30: 2070 7562 6c69 6320 696d 6167 6520 7769   public image wi
+00012f40: 7468 2043 5544 410a 4070 7974 6573 742e  th CUDA.@pytest.
+00012f50: 6d61 726b 2e6e 6f5f 7363 7020 2023 2053  mark.no_scp  # S
+00012f60: 4350 2064 6f65 7320 6e6f 7420 7375 7070  CP does not supp
+00012f70: 6f72 7420 6e75 6d5f 6e6f 6465 7320 3e20  ort num_nodes > 
+00012f80: 3120 7965 740a 4070 7974 6573 742e 6d61  1 yet.@pytest.ma
+00012f90: 726b 2e73 6b69 7028 0a20 2020 2072 6561  rk.skip(.    rea
+00012fa0: 736f 6e3d 0a20 2020 2027 5468 6520 7265  son=.    'The re
+00012fb0: 736e 6574 5f64 6973 7472 6962 7574 6564  snet_distributed
+00012fc0: 5f74 665f 6170 7020 6973 2066 6c61 6b79  _tf_app is flaky
+00012fd0: 2c20 6475 6520 746f 2069 7420 6661 696c  , due to it fail
+00012fe0: 696e 6720 746f 2064 6574 6563 7420 4750  ing to detect GP
+00012ff0: 5573 2e27 290a 6465 6620 7465 7374 5f64  Us.').def test_d
+00013000: 6973 7472 6962 7574 6564 5f74 6628 6765  istributed_tf(ge
+00013010: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+00013020: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+00013030: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+00013040: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+00013050: 7428 0a20 2020 2020 2020 2027 7265 736e  t(.        'resn
+00013060: 6574 5f64 6973 7472 6962 7574 6564 5f74  et_distributed_t
+00013070: 665f 6170 7027 2c0a 2020 2020 2020 2020  f_app',.        
+00013080: 5b0a 2020 2020 2020 2020 2020 2020 2320  [.            # 
+00013090: 4e4f 5445 3a20 7275 6e6e 696e 6720 6974  NOTE: running it
+000130a0: 2074 7769 6365 2077 696c 6c20 6861 6e67   twice will hang
+000130b0: 2028 736f 6d65 7469 6d65 733f 2920 2d20   (sometimes?) - 
+000130c0: 616e 2061 7070 2d6c 6576 656c 2062 7567  an app-level bug
+000130d0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+000130e0: 7079 7468 6f6e 2065 7861 6d70 6c65 732f  python examples/
+000130f0: 7265 736e 6574 5f64 6973 7472 6962 7574  resnet_distribut
+00013100: 6564 5f74 665f 6170 702e 7079 207b 6e61  ed_tf_app.py {na
+00013110: 6d65 7d20 7b67 656e 6572 6963 5f63 6c6f  me} {generic_clo
+00013120: 7564 7d27 2c0a 2020 2020 2020 2020 2020  ud}',.          
+00013130: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00013140: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+00013150: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+00013160: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+00013170: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00013180: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00013190: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
+000131a0: 7469 6d65 6f75 743d 3235 202a 2036 302c  timeout=25 * 60,
+000131b0: 2020 2320 3235 206d 696e 7320 2869 7420    # 25 mins (it 
+000131c0: 7461 6b65 7320 6172 6f75 6e64 207e 3139  takes around ~19
+000131d0: 206d 696e 7329 0a20 2020 2029 0a20 2020   mins).    ).   
+000131e0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+000131f0: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
+00013200: 2d2d 2054 6573 7469 6e67 2047 4350 2073  -- Testing GCP s
+00013210: 7461 7274 2061 6e64 2073 746f 7020 696e  tart and stop in
+00013220: 7374 616e 6365 7320 2d2d 2d2d 2d2d 2d2d  stances --------
+00013230: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
+00013240: 6763 700a 6465 6620 7465 7374 5f67 6370  gcp.def test_gcp
+00013250: 5f73 7461 7274 5f73 746f 7028 293a 0a20  _start_stop():. 
+00013260: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00013270: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00013280: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00013290: 2020 2020 2020 2027 6763 702d 7374 6172         'gcp-star
+000132a0: 742d 7374 6f70 272c 0a20 2020 2020 2020  t-stop',.       
+000132b0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+000132c0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+000132d0: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
+000132e0: 732f 6763 705f 7374 6172 745f 7374 6f70  s/gcp_start_stop
+000132f0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00013300: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00013310: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+00013320: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+00013330: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+00013340: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00013350: 7920 6578 6563 207b 6e61 6d65 7d20 6578  y exec {name} ex
+00013360: 616d 706c 6573 2f67 6370 5f73 7461 7274  amples/gcp_start
+00013370: 5f73 746f 702e 7961 6d6c 272c 0a20 2020  _stop.yaml',.   
+00013380: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00013390: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
+000133a0: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+000133b0: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
+000133c0: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
+000133d0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+000133e0: 657d 2022 7072 6c69 6d69 7420 2d6e 202d  e} "prlimit -n -
+000133f0: 2d70 6964 3d5c 2428 7067 7265 7020 2d66  -pid=\$(pgrep -f
+00013400: 205c 2772 6179 6c65 742f 7261 796c 6574   \'raylet/raylet
+00013410: 202d 2d72 6179 6c65 745f 736f 636b 6574   --raylet_socket
+00013420: 5f6e 616d 655c 2729 207c 2067 7265 7020  _name\') | grep 
+00013430: 5c27 225c 2731 3034 3835 3736 2031 3034  \'"\'1048576 104
+00013440: 3835 3736 5c27 225c 2722 272c 2020 2320  8576\'"\'"',  # 
+00013450: 456e 7375 7265 2074 6865 2072 6179 6c65  Ensure the rayle
+00013460: 7420 7072 6f63 6573 7320 6861 7320 7468  t process has th
+00013470: 6520 636f 7272 6563 7420 6669 6c65 2064  e correct file d
+00013480: 6573 6372 6970 746f 7220 6c69 6d69 742e  escriptor limit.
+00013490: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000134a0: 6b79 206c 6f67 7320 7b6e 616d 657d 2033  ky logs {name} 3
+000134b0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+000134c0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+000134d0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+000134e0: 2020 2020 2066 2773 6b79 2073 746f 7020       f'sky stop 
+000134f0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+00013500: 2020 2020 2020 2020 6627 736c 6565 7020          f'sleep 
+00013510: 3230 272c 0a20 2020 2020 2020 2020 2020  20',.           
+00013520: 2066 2773 6b79 2073 7461 7274 202d 7920   f'sky start -y 
+00013530: 7b6e 616d 657d 202d 6920 3127 2c0a 2020  {name} -i 1',.  
+00013540: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00013550: 6578 6563 207b 6e61 6d65 7d20 6578 616d  exec {name} exam
+00013560: 706c 6573 2f67 6370 5f73 7461 7274 5f73  ples/gcp_start_s
+00013570: 746f 702e 7961 6d6c 272c 0a20 2020 2020  top.yaml',.     
+00013580: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00013590: 7320 7b6e 616d 657d 2034 202d 2d73 7461  s {name} 4 --sta
+000135a0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+000135b0: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+000135c0: 642e 0a20 2020 2020 2020 2020 2020 2027  d..            '
+000135d0: 736c 6565 7020 3138 3027 2c0a 2020 2020  sleep 180',.    
+000135e0: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+000135f0: 6174 7573 202d 7220 7b6e 616d 657d 207c  atus -r {name} |
+00013600: 2067 7265 7020 2249 4e49 545c 7c53 544f   grep "INIT\|STO
+00013610: 5050 4544 2227 2c0a 2020 2020 2020 2020  PPED"',.        
+00013620: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+00013630: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+00013640: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+00013650: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00013660: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
+00013670: 7374 696e 6720 417a 7572 6520 7374 6172  sting Azure star
+00013680: 7420 616e 6420 7374 6f70 2069 6e73 7461  t and stop insta
+00013690: 6e63 6573 202d 2d2d 2d2d 2d2d 2d2d 2d0a  nces ----------.
+000136a0: 4070 7974 6573 742e 6d61 726b 2e61 7a75  @pytest.mark.azu
+000136b0: 7265 0a64 6566 2074 6573 745f 617a 7572  re.def test_azur
+000136c0: 655f 7374 6172 745f 7374 6f70 2829 3a0a  e_start_stop():.
+000136d0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+000136e0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+000136f0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00013700: 2020 2020 2020 2020 2761 7a75 7265 2d73          'azure-s
+00013710: 7461 7274 2d73 746f 7027 2c0a 2020 2020  tart-stop',.    
+00013720: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00013730: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00013740: 7920 2d63 207b 6e61 6d65 7d20 6578 616d  y -c {name} exam
+00013750: 706c 6573 2f61 7a75 7265 5f73 7461 7274  ples/azure_start
+00013760: 5f73 746f 702e 7961 6d6c 272c 0a20 2020  _stop.yaml',.   
+00013770: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+00013780: 7865 6320 7b6e 616d 657d 2065 7861 6d70  xec {name} examp
+00013790: 6c65 732f 617a 7572 655f 7374 6172 745f  les/azure_start_
+000137a0: 7374 6f70 2e79 616d 6c27 2c0a 2020 2020  stop.yaml',.    
+000137b0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+000137c0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+000137d0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+000137e0: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+000137f0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00013800: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00013810: 7d20 2270 726c 696d 6974 202d 6e20 2d2d  } "prlimit -n --
+00013820: 7069 643d 5c24 2870 6772 6570 202d 6620  pid=\$(pgrep -f 
+00013830: 5c27 7261 796c 6574 2f72 6179 6c65 7420  \'raylet/raylet 
+00013840: 2d2d 7261 796c 6574 5f73 6f63 6b65 745f  --raylet_socket_
+00013850: 6e61 6d65 5c27 2920 7c20 6772 6570 205c  name\') | grep \
+00013860: 2722 5c27 3130 3438 3537 3620 3130 3438  '"\'1048576 1048
+00013870: 3537 365c 2722 5c27 2227 2c20 2023 2045  576\'"\'"',  # E
+00013880: 6e73 7572 6520 7468 6520 7261 796c 6574  nsure the raylet
+00013890: 2070 726f 6365 7373 2068 6173 2074 6865   process has the
+000138a0: 2063 6f72 7265 6374 2066 696c 6520 6465   correct file de
+000138b0: 7363 7269 7074 6f72 206c 696d 6974 2e0a  scriptor limit..
+000138c0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000138d0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
+000138e0: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
+000138f0: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
+00013900: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+00013910: 2020 2020 6627 736b 7920 7374 6f70 202d      f'sky stop -
+00013920: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+00013930: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
+00013940: 7274 202d 7920 7b6e 616d 657d 202d 6920  rt -y {name} -i 
+00013950: 3127 2c0a 2020 2020 2020 2020 2020 2020  1',.            
+00013960: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00013970: 7d20 6578 616d 706c 6573 2f61 7a75 7265  } examples/azure
+00013980: 5f73 7461 7274 5f73 746f 702e 7961 6d6c  _start_stop.yaml
+00013990: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000139a0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+000139b0: 2033 202d 2d73 7461 7475 7327 2c20 2023   3 --status',  #
+000139c0: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+000139d0: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+000139e0: 2020 2020 2020 2027 736c 6565 7020 3230         'sleep 20
+000139f0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00013a00: 6627 733d 2428 736b 7920 7374 6174 7573  f's=$(sky status
+00013a10: 202d 7220 7b6e 616d 657d 2920 2626 2065   -r {name}) && e
+00013a20: 6368 6f20 2473 2026 2620 6563 686f 2024  cho $s && echo $
+00013a30: 7320 7c20 6772 6570 2022 494e 4954 5c7c  s | grep "INIT\|
+00013a40: 5354 4f50 5045 4422 270a 2020 2020 2020  STOPPED"'.      
+00013a50: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+00013a60: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00013a70: 7d27 2c0a 2020 2020 2020 2020 7469 6d65  }',.        time
+00013a80: 6f75 743d 3330 202a 2036 302c 2020 2320  out=30 * 60,  # 
+00013a90: 3330 206d 696e 730a 2020 2020 290a 2020  30 mins.    ).  
+00013aa0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00013ab0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
+00013ac0: 2d2d 2d20 5465 7374 696e 6720 4175 746f  --- Testing Auto
+00013ad0: 7374 6f70 7069 6e67 202d 2d2d 2d2d 2d2d  stopping -------
+00013ae0: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
+00013af0: 2e6e 6f5f 666c 7569 6473 7461 636b 2020  .no_fluidstack  
+00013b00: 2320 466c 7569 6453 7461 636b 2064 6f65  # FluidStack doe
+00013b10: 7320 6e6f 7420 7375 7070 6f72 7420 7374  s not support st
+00013b20: 6f70 7069 6e67 2069 6e20 536b 7950 696c  opping in SkyPil
+00013b30: 6f74 2069 6d70 6c65 6d65 6e74 6174 696f  ot implementatio
+00013b40: 6e0a 4070 7974 6573 742e 6d61 726b 2e6e  n.@pytest.mark.n
+00013b50: 6f5f 6c61 6d62 6461 5f63 6c6f 7564 2020  o_lambda_cloud  
+00013b60: 2320 4c61 6d62 6461 2043 6c6f 7564 2064  # Lambda Cloud d
+00013b70: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+00013b80: 7374 6f70 7069 6e67 2069 6e73 7461 6e63  stopping instanc
+00013b90: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
+00013ba0: 6e6f 5f69 626d 2020 2320 4649 5828 4942  no_ibm  # FIX(IB
+00013bb0: 4d29 2073 706f 7261 6469 6361 6c6c 7920  M) sporadically 
+00013bc0: 6661 696c 732c 2061 7320 7265 7374 6172  fails, as restar
+00013bd0: 7465 6420 776f 726b 6572 7320 7374 6179  ted workers stay
+00013be0: 2075 6e69 6e69 7469 616c 697a 6564 2069   uninitialized i
+00013bf0: 6e64 6566 696e 6974 656c 790a 4070 7974  ndefinitely.@pyt
+00013c00: 6573 742e 6d61 726b 2e6e 6f5f 7363 7020  est.mark.no_scp 
+00013c10: 2023 2053 4350 2064 6f65 7320 6e6f 7420   # SCP does not 
+00013c20: 7375 7070 6f72 7420 6e75 6d5f 6e6f 6465  support num_node
+00013c30: 7320 3e20 3120 7965 740a 4070 7974 6573  s > 1 yet.@pytes
+00013c40: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
+00013c50: 6574 6573 2020 2320 4b75 6265 726e 6574  etes  # Kubernet
+00013c60: 6573 2064 6f65 7320 6e6f 7420 6175 746f  es does not auto
+00013c70: 7374 6f70 2079 6574 0a64 6566 2074 6573  stop yet.def tes
+00013c80: 745f 6175 746f 7374 6f70 2867 656e 6572  t_autostop(gener
+00013c90: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+00013ca0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00013cb0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00013cc0: 2020 2023 2041 7a75 7265 2074 616b 6573     # Azure takes
+00013cd0: 207e 2037 6d31 3573 2028 3433 3573 2920   ~ 7m15s (435s) 
+00013ce0: 746f 2061 7574 6f73 746f 7020 6120 564d  to autostop a VM
+00013cf0: 2c20 736f 2068 6572 6520 7765 2075 7365  , so here we use
+00013d00: 2036 3030 2074 6f20 656e 7375 7265 0a20   600 to ensure. 
+00013d10: 2020 2023 2074 6865 2056 4d20 6973 2073     # the VM is s
+00013d20: 746f 7070 6564 2e0a 2020 2020 6175 746f  topped..    auto
+00013d30: 7374 6f70 5f74 696d 656f 7574 203d 2036  stop_timeout = 6
+00013d40: 3030 2069 6620 6765 6e65 7269 635f 636c  00 if generic_cl
+00013d50: 6f75 6420 3d3d 2027 617a 7572 6527 2065  oud == 'azure' e
+00013d60: 6c73 6520 3235 300a 2020 2020 2320 4c61  lse 250.    # La
+00013d70: 756e 6368 696e 6720 616e 6420 7374 6172  unching and star
+00013d80: 7469 6e67 2041 7a75 7265 2063 6c75 7374  ting Azure clust
+00013d90: 6572 7320 6361 6e20 7461 6b65 2061 206c  ers can take a l
+00013da0: 6f6e 6720 7469 6d65 2074 6f6f 2e20 652e  ong time too. e.
+00013db0: 672e 2c20 7265 7374 6172 740a 2020 2020  g., restart.    
+00013dc0: 2320 6120 7374 6f70 7065 6420 417a 7572  # a stopped Azur
+00013dd0: 6520 636c 7573 7465 7220 6361 6e20 7461  e cluster can ta
+00013de0: 6b65 2037 6d2e 2053 6f20 7765 2073 6574  ke 7m. So we set
+00013df0: 2074 6865 2074 6f74 616c 2074 696d 656f   the total timeo
+00013e00: 7574 2074 6f20 3730 6d2e 0a20 2020 2074  ut to 70m..    t
+00013e10: 6f74 616c 5f74 696d 656f 7574 5f6d 696e  otal_timeout_min
+00013e20: 7574 6573 203d 2037 3020 6966 2067 656e  utes = 70 if gen
+00013e30: 6572 6963 5f63 6c6f 7564 203d 3d20 2761  eric_cloud == 'a
+00013e40: 7a75 7265 2720 656c 7365 2032 300a 2020  zure' else 20.  
+00013e50: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00013e60: 2020 2020 2020 2027 6175 746f 7374 6f70         'autostop
+00013e70: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00013e80: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00013e90: 6175 6e63 6820 2d79 202d 6420 2d63 207b  aunch -y -d -c {
+00013ea0: 6e61 6d65 7d20 2d2d 6e75 6d2d 6e6f 6465  name} --num-node
+00013eb0: 7320 3220 2d2d 636c 6f75 6420 7b67 656e  s 2 --cloud {gen
+00013ec0: 6572 6963 5f63 6c6f 7564 7d20 7465 7374  eric_cloud} test
+00013ed0: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
+00013ee0: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
+00013ef0: 2020 2020 2020 2020 6627 736b 7920 6175          f'sky au
+00013f00: 746f 7374 6f70 202d 7920 7b6e 616d 657d  tostop -y {name}
+00013f10: 202d 6920 3127 2c0a 0a20 2020 2020 2020   -i 1',..       
+00013f20: 2020 2020 2023 2045 6e73 7572 6520 6175       # Ensure au
+00013f30: 746f 7374 6f70 2069 7320 7365 742e 0a20  tostop is set.. 
+00013f40: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00013f50: 2073 7461 7475 7320 7c20 6772 6570 207b   status | grep {
+00013f60: 6e61 6d65 7d20 7c20 6772 6570 2022 316d  name} | grep "1m
+00013f70: 2227 2c0a 0a20 2020 2020 2020 2020 2020  "',..           
+00013f80: 2023 2045 6e73 7572 6520 7468 6520 636c   # Ensure the cl
+00013f90: 7573 7465 7220 6973 206e 6f74 2073 746f  uster is not sto
+00013fa0: 7070 6564 2065 6172 6c79 2e0a 2020 2020  pped early..    
+00013fb0: 2020 2020 2020 2020 2773 6c65 6570 2034          'sleep 4
+00013fc0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00013fd0: 6627 733d 2428 736b 7920 7374 6174 7573  f's=$(sky status
+00013fe0: 207b 6e61 6d65 7d20 2d2d 7265 6672 6573   {name} --refres
+00013ff0: 6829 3b20 6563 686f 2022 2473 223b 2065  h); echo "$s"; e
+00014000: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
+00014010: 2224 7322 2020 7c20 6772 6570 207b 6e61  "$s"  | grep {na
+00014020: 6d65 7d20 7c20 6772 6570 2055 5027 2c0a  me} | grep UP',.
+00014030: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
+00014040: 6e73 7572 6520 7468 6520 636c 7573 7465  nsure the cluste
+00014050: 7220 6973 2053 544f 5050 4544 2e0a 2020  r is STOPPED..  
+00014060: 2020 2020 2020 2020 2020 6627 736c 6565            f'slee
+00014070: 7020 7b61 7574 6f73 746f 705f 7469 6d65  p {autostop_time
+00014080: 6f75 747d 272c 0a20 2020 2020 2020 2020  out}',.         
+00014090: 2020 2066 2773 3d24 2873 6b79 2073 7461     f's=$(sky sta
+000140a0: 7475 7320 7b6e 616d 657d 202d 2d72 6566  tus {name} --ref
+000140b0: 7265 7368 293b 2065 6368 6f20 2224 7322  resh); echo "$s"
+000140c0: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
+000140d0: 686f 2022 2473 2220 207c 2067 7265 7020  ho "$s"  | grep 
+000140e0: 7b6e 616d 657d 207c 2067 7265 7020 5354  {name} | grep ST
+000140f0: 4f50 5045 4427 2c0a 0a20 2020 2020 2020  OPPED',..       
+00014100: 2020 2020 2023 2045 6e73 7572 6520 7468       # Ensure th
+00014110: 6520 636c 7573 7465 7220 6973 2055 5020  e cluster is UP 
+00014120: 616e 6420 7468 6520 6175 746f 7374 6f70  and the autostop
+00014130: 2073 6574 7469 6e67 2069 7320 7265 7365   setting is rese
+00014140: 7420 2827 2d27 292e 0a20 2020 2020 2020  t ('-')..       
+00014150: 2020 2020 2066 2773 6b79 2073 7461 7274       f'sky start
+00014160: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00014170: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00014180: 7461 7475 7320 7c20 6772 6570 207b 6e61  tatus | grep {na
+00014190: 6d65 7d20 7c20 6772 6570 202d 4520 2255  me} | grep -E "U
+000141a0: 505c 732b 2d22 272c 0a0a 2020 2020 2020  P\s+-"',..      
+000141b0: 2020 2020 2020 2320 456e 7375 7265 2074        # Ensure t
+000141c0: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
+000141d0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+000141e0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+000141f0: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+00014200: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
+00014210: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00014220: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
+00014230: 2d2d 7374 6174 7573 272c 0a0a 2020 2020  --status',..    
+00014240: 2020 2020 2020 2020 2320 5465 7374 2072          # Test r
+00014250: 6573 7461 7274 696e 6720 7468 6520 6964  estarting the id
+00014260: 6c65 6e65 7373 2074 696d 6572 2076 6961  leness timer via
+00014270: 2072 6573 6574 3a0a 2020 2020 2020 2020   reset:.        
+00014280: 2020 2020 6627 736b 7920 6175 746f 7374      f'sky autost
+00014290: 6f70 202d 7920 7b6e 616d 657d 202d 6920  op -y {name} -i 
+000142a0: 3127 2c20 2023 2049 646c 656e 6573 7320  1',  # Idleness 
+000142b0: 7374 6172 7473 2063 6f75 6e74 696e 672e  starts counting.
+000142c0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+000142d0: 6565 7020 3430 272c 2020 2320 416c 6d6f  eep 40',  # Almo
+000142e0: 7374 2072 6561 6368 6564 2074 6865 2074  st reached the t
+000142f0: 6872 6573 686f 6c64 2e0a 2020 2020 2020  hreshold..      
+00014300: 2020 2020 2020 6627 736b 7920 6175 746f        f'sky auto
+00014310: 7374 6f70 202d 7920 7b6e 616d 657d 202d  stop -y {name} -
+00014320: 6920 3127 2c20 2023 2053 686f 756c 6420  i 1',  # Should 
+00014330: 7265 7374 6172 7420 7468 6520 7469 6d65  restart the time
+00014340: 722e 0a20 2020 2020 2020 2020 2020 2027  r..            '
+00014350: 736c 6565 7020 3430 272c 0a20 2020 2020  sleep 40',.     
+00014360: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+00014370: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
+00014380: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
+00014390: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
+000143a0: 3b20 6563 686f 2022 2473 2220 7c20 6772  ; echo "$s" | gr
+000143b0: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
+000143c0: 2055 5027 2c0a 2020 2020 2020 2020 2020   UP',.          
+000143d0: 2020 6627 736c 6565 7020 7b61 7574 6f73    f'sleep {autos
+000143e0: 746f 705f 7469 6d65 6f75 747d 272c 0a20  top_timeout}',. 
+000143f0: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+00014400: 2873 6b79 2073 7461 7475 7320 7b6e 616d  (sky status {nam
+00014410: 657d 202d 2d72 6566 7265 7368 293b 2065  e} --refresh); e
+00014420: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
+00014430: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
+00014440: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+00014450: 2067 7265 7020 5354 4f50 5045 4427 2c0a   grep STOPPED',.
+00014460: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+00014470: 6573 7420 7265 7374 6172 7469 6e67 2074  est restarting t
+00014480: 6865 2069 646c 656e 6573 7320 7469 6d65  he idleness time
+00014490: 7220 7669 6120 6578 6563 3a0a 2020 2020  r via exec:.    
+000144a0: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+000144b0: 6172 7420 2d79 207b 6e61 6d65 7d27 2c0a  art -y {name}',.
+000144c0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000144d0: 7920 7374 6174 7573 207c 2067 7265 7020  y status | grep 
+000144e0: 7b6e 616d 657d 207c 2067 7265 7020 2d45  {name} | grep -E
+000144f0: 2022 5550 5c73 2b2d 2227 2c0a 2020 2020   "UP\s+-"',.    
+00014500: 2020 2020 2020 2020 6627 736b 7920 6175          f'sky au
+00014510: 746f 7374 6f70 202d 7920 7b6e 616d 657d  tostop -y {name}
+00014520: 202d 6920 3127 2c20 2023 2049 646c 656e   -i 1',  # Idlen
+00014530: 6573 7320 7374 6172 7473 2063 6f75 6e74  ess starts count
+00014540: 696e 672e 0a20 2020 2020 2020 2020 2020  ing..           
+00014550: 2027 736c 6565 7020 3435 272c 2020 2320   'sleep 45',  # 
+00014560: 416c 6d6f 7374 2072 6561 6368 6564 2074  Almost reached t
+00014570: 6865 2074 6872 6573 686f 6c64 2e0a 2020  he threshold..  
+00014580: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00014590: 6578 6563 207b 6e61 6d65 7d20 6563 686f  exec {name} echo
+000145a0: 2068 6927 2c20 2023 2053 686f 756c 6420   hi',  # Should 
+000145b0: 7265 7374 6172 7420 7468 6520 7469 6d65  restart the time
+000145c0: 722e 0a20 2020 2020 2020 2020 2020 2027  r..            '
+000145d0: 736c 6565 7020 3435 272c 0a20 2020 2020  sleep 45',.     
+000145e0: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+000145f0: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
+00014600: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
+00014610: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
+00014620: 3b20 6563 686f 2022 2473 2220 207c 2067  ; echo "$s"  | g
+00014630: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+00014640: 7020 5550 272c 0a20 2020 2020 2020 2020  p UP',.         
+00014650: 2020 2066 2773 6c65 6570 207b 6175 746f     f'sleep {auto
+00014660: 7374 6f70 5f74 696d 656f 7574 7d27 2c0a  stop_timeout}',.
+00014670: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+00014680: 2428 736b 7920 7374 6174 7573 207b 6e61  $(sky status {na
+00014690: 6d65 7d20 2d2d 7265 6672 6573 6829 3b20  me} --refresh); 
+000146a0: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
+000146b0: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
+000146c0: 2020 7c20 6772 6570 207b 6e61 6d65 7d20    | grep {name} 
+000146d0: 7c20 6772 6570 2053 544f 5050 4544 272c  | grep STOPPED',
+000146e0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+000146f0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00014700: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+00014710: 2020 2074 696d 656f 7574 3d74 6f74 616c     timeout=total
+00014720: 5f74 696d 656f 7574 5f6d 696e 7574 6573  _timeout_minutes
+00014730: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
+00014740: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00014750: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
+00014760: 2d2d 2054 6573 7469 6e67 2041 7574 6f64  -- Testing Autod
+00014770: 6f77 6e69 6e67 202d 2d2d 2d2d 2d2d 2d2d  owning ---------
+00014780: 2d0a 4070 7974 6573 742e 6d61 726b 2e6e  -.@pytest.mark.n
+00014790: 6f5f 666c 7569 6473 7461 636b 2020 2320  o_fluidstack  # 
+000147a0: 466c 7569 6453 7461 636b 2064 6f65 7320  FluidStack does 
+000147b0: 6e6f 7420 7375 7070 6f72 7420 7374 6f70  not support stop
+000147c0: 7069 6e67 2069 6e20 536b 7950 696c 6f74  ping in SkyPilot
+000147d0: 2069 6d70 6c65 6d65 6e74 6174 696f 6e0a   implementation.
+000147e0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+000147f0: 7363 7020 2023 2053 4350 2064 6f65 7320  scp  # SCP does 
+00014800: 6e6f 7420 7375 7070 6f72 7420 6e75 6d5f  not support num_
+00014810: 6e6f 6465 7320 3e20 3120 7965 742e 2052  nodes > 1 yet. R
+00014820: 756e 2074 6573 745f 7363 705f 6175 746f  un test_scp_auto
+00014830: 646f 776e 2069 6e73 7465 6164 2e0a 6465  down instead..de
+00014840: 6620 7465 7374 5f61 7574 6f64 6f77 6e28  f test_autodown(
+00014850: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
+00014860: 7472 293a 0a20 2020 206e 616d 6520 3d20  tr):.    name = 
+00014870: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00014880: 6528 290a 2020 2020 2320 417a 7572 6520  e().    # Azure 
+00014890: 7461 6b65 7320 7e20 3133 6d33 3073 2028  takes ~ 13m30s (
+000148a0: 3831 3073 2920 746f 2061 7574 6f64 6f77  810s) to autodow
+000148b0: 6e20 6120 564d 2c20 736f 2068 6572 6520  n a VM, so here 
+000148c0: 7765 2075 7365 2039 3030 2074 6f20 656e  we use 900 to en
+000148d0: 7375 7265 0a20 2020 2023 2074 6865 2056  sure.    # the V
+000148e0: 4d20 6973 2074 6572 6d69 6e61 7465 642e  M is terminated.
+000148f0: 0a20 2020 2061 7574 6f64 6f77 6e5f 7469  .    autodown_ti
+00014900: 6d65 6f75 7420 3d20 3930 3020 6966 2067  meout = 900 if g
+00014910: 656e 6572 6963 5f63 6c6f 7564 203d 3d20  eneric_cloud == 
+00014920: 2761 7a75 7265 2720 656c 7365 2032 3430  'azure' else 240
+00014930: 0a20 2020 2074 6f74 616c 5f74 696d 656f  .    total_timeo
+00014940: 7574 5f6d 696e 7574 6573 203d 2039 3020  ut_minutes = 90 
+00014950: 6966 2067 656e 6572 6963 5f63 6c6f 7564  if generic_cloud
+00014960: 203d 3d20 2761 7a75 7265 2720 656c 7365   == 'azure' else
+00014970: 2032 300a 2020 2020 7465 7374 203d 2054   20.    test = T
+00014980: 6573 7428 0a20 2020 2020 2020 2027 6175  est(.        'au
+00014990: 746f 646f 776e 272c 0a20 2020 2020 2020  todown',.       
+000149a0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+000149b0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+000149c0: 6420 2d63 207b 6e61 6d65 7d20 2d2d 6e75  d -c {name} --nu
+000149d0: 6d2d 6e6f 6465 7320 3220 2d2d 636c 6f75  m-nodes 2 --clou
+000149e0: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+000149f0: 7d20 7465 7374 732f 7465 7374 5f79 616d  } tests/test_yam
+00014a00: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
+00014a10: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00014a20: 736b 7920 6175 746f 7374 6f70 202d 7920  sky autostop -y 
+00014a30: 7b6e 616d 657d 202d 2d64 6f77 6e20 2d69  {name} --down -i
+00014a40: 2031 272c 0a20 2020 2020 2020 2020 2020   1',.           
+00014a50: 2023 2045 6e73 7572 6520 6175 746f 7374   # Ensure autost
+00014a60: 6f70 2069 7320 7365 742e 0a20 2020 2020  op is set..     
+00014a70: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
+00014a80: 7475 7320 7c20 6772 6570 207b 6e61 6d65  tus | grep {name
+00014a90: 7d20 7c20 6772 6570 2022 316d 2028 646f  } | grep "1m (do
+00014aa0: 776e 2922 272c 0a20 2020 2020 2020 2020  wn)"',.         
+00014ab0: 2020 2023 2045 6e73 7572 6520 7468 6520     # Ensure the 
+00014ac0: 636c 7573 7465 7220 6973 206e 6f74 2074  cluster is not t
+00014ad0: 6572 6d69 6e61 7465 6420 6561 726c 792e  erminated early.
+00014ae0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+00014af0: 6565 7020 3430 272c 0a20 2020 2020 2020  eep 40',.       
+00014b00: 2020 2020 2066 2773 3d24 2873 6b79 2073       f's=$(sky s
+00014b10: 7461 7475 7320 7b6e 616d 657d 202d 2d72  tatus {name} --r
+00014b20: 6566 7265 7368 293b 2065 6368 6f20 2224  efresh); echo "$
+00014b30: 7322 3b20 6563 686f 3b20 6563 686f 3b20  s"; echo; echo; 
+00014b40: 6563 686f 2022 2473 2220 207c 2067 7265  echo "$s"  | gre
+00014b50: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
+00014b60: 5550 272c 0a20 2020 2020 2020 2020 2020  UP',.           
+00014b70: 2023 2045 6e73 7572 6520 7468 6520 636c   # Ensure the cl
+00014b80: 7573 7465 7220 6973 2074 6572 6d69 6e61  uster is termina
+00014b90: 7465 642e 0a20 2020 2020 2020 2020 2020  ted..           
+00014ba0: 2066 2773 6c65 6570 207b 6175 746f 646f   f'sleep {autodo
+00014bb0: 776e 5f74 696d 656f 7574 7d27 2c0a 2020  wn_timeout}',.  
+00014bc0: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+00014bd0: 534b 5950 494c 4f54 5f44 4542 5547 3d30  SKYPILOT_DEBUG=0
+00014be0: 2073 6b79 2073 7461 7475 7320 7b6e 616d   sky status {nam
+00014bf0: 657d 202d 2d72 6566 7265 7368 2920 2626  e} --refresh) &&
+00014c00: 2065 6368 6f20 2224 7322 2026 2620 7b7b   echo "$s" && {{
+00014c10: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+00014c20: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
+00014c30: 2241 7574 6f64 6f77 6e65 6420 636c 7573  "Autodowned clus
+00014c40: 7465 725c 7c74 6572 6d69 6e61 7465 6420  ter\|terminated 
+00014c50: 6f6e 2074 6865 2063 6c6f 7564 223b 207d  on the cloud"; }
+00014c60: 7d20 7c7c 207b 7b20 6563 686f 2022 2473  } || {{ echo "$s
+00014c70: 2220 7c20 6772 6570 207b 6e61 6d65 7d20  " | grep {name} 
+00014c80: 2626 2065 7869 7420 3120 7c7c 2065 7869  && exit 1 || exi
+00014c90: 7420 303b 207d 7d27 2c0a 2020 2020 2020  t 0; }}',.      
+00014ca0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00014cb0: 6368 202d 7920 2d64 202d 6320 7b6e 616d  ch -y -d -c {nam
+00014cc0: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
+00014cd0: 7269 635f 636c 6f75 647d 202d 2d6e 756d  ric_cloud} --num
+00014ce0: 2d6e 6f64 6573 2032 202d 2d64 6f77 6e20  -nodes 2 --down 
+00014cf0: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+00014d00: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
+00014d10: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00014d20: 7920 7374 6174 7573 207c 2067 7265 7020  y status | grep 
+00014d30: 7b6e 616d 657d 207c 2067 7265 7020 5550  {name} | grep UP
+00014d40: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+00014d50: 2063 6c75 7374 6572 2069 7320 5550 2e0a   cluster is UP..
+00014d60: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00014d70: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
+00014d80: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
+00014d90: 6c6f 7564 7d20 7465 7374 732f 7465 7374  loud} tests/test
+00014da0: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
+00014db0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00014dc0: 2020 6627 736b 7920 7374 6174 7573 207c    f'sky status |
+00014dd0: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
+00014de0: 7265 7020 2231 6d20 2864 6f77 6e29 2227  rep "1m (down)"'
+00014df0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00014e00: 736c 6565 7020 7b61 7574 6f64 6f77 6e5f  sleep {autodown_
+00014e10: 7469 6d65 6f75 747d 272c 0a20 2020 2020  timeout}',.     
+00014e20: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
+00014e30: 7468 6520 636c 7573 7465 7220 6973 2074  the cluster is t
+00014e40: 6572 6d69 6e61 7465 642e 0a20 2020 2020  erminated..     
+00014e50: 2020 2020 2020 2066 2773 3d24 2853 4b59         f's=$(SKY
+00014e60: 5049 4c4f 545f 4445 4255 473d 3020 736b  PILOT_DEBUG=0 sk
+00014e70: 7920 7374 6174 7573 207b 6e61 6d65 7d20  y status {name} 
+00014e80: 2d2d 7265 6672 6573 6829 2026 2620 6563  --refresh) && ec
+00014e90: 686f 2022 2473 2220 2626 207b 7b20 6563  ho "$s" && {{ ec
+00014ea0: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
+00014eb0: 6e61 6d65 7d20 7c20 6772 6570 2022 4175  name} | grep "Au
+00014ec0: 746f 646f 776e 6564 2063 6c75 7374 6572  todowned cluster
+00014ed0: 5c7c 7465 726d 696e 6174 6564 206f 6e20  \|terminated on 
+00014ee0: 7468 6520 636c 6f75 6422 3b20 7d7d 207c  the cloud"; }} |
+00014ef0: 7c20 7b7b 2065 6368 6f20 2224 7322 207c  | {{ echo "$s" |
+00014f00: 2067 7265 7020 7b6e 616d 657d 2026 2620   grep {name} && 
+00014f10: 6578 6974 2031 207c 7c20 6578 6974 2030  exit 1 || exit 0
+00014f20: 3b20 7d7d 272c 0a20 2020 2020 2020 2020  ; }}',.         
+00014f30: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00014f40: 2d79 202d 6420 2d63 207b 6e61 6d65 7d20  -y -d -c {name} 
+00014f50: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+00014f60: 5f63 6c6f 7564 7d20 2d2d 6e75 6d2d 6e6f  _cloud} --num-no
+00014f70: 6465 7320 3220 2d2d 646f 776e 2074 6573  des 2 --down tes
+00014f80: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
+00014f90: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
+00014fa0: 2020 2020 2020 2020 2066 2773 6b79 2061           f'sky a
+00014fb0: 7574 6f73 746f 7020 2d79 207b 6e61 6d65  utostop -y {name
+00014fc0: 7d20 2d2d 6361 6e63 656c 272c 0a20 2020  } --cancel',.   
+00014fd0: 2020 2020 2020 2020 2066 2773 6c65 6570           f'sleep
+00014fe0: 207b 6175 746f 646f 776e 5f74 696d 656f   {autodown_timeo
+00014ff0: 7574 7d27 2c0a 2020 2020 2020 2020 2020  ut}',.          
+00015000: 2020 2320 456e 7375 7265 2074 6865 2063    # Ensure the c
+00015010: 6c75 7374 6572 2069 7320 7374 696c 6c20  luster is still 
+00015020: 5550 2e0a 2020 2020 2020 2020 2020 2020  UP..            
+00015030: 6627 733d 2428 534b 5950 494c 4f54 5f44  f's=$(SKYPILOT_D
+00015040: 4542 5547 3d30 2073 6b79 2073 7461 7475  EBUG=0 sky statu
+00015050: 7320 7b6e 616d 657d 202d 2d72 6566 7265  s {name} --refre
+00015060: 7368 2920 2626 2065 6368 6f20 2224 7322  sh) && echo "$s"
+00015070: 2026 2620 6563 686f 2022 2473 2220 7c20   && echo "$s" | 
+00015080: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
+00015090: 6570 2055 5027 2c0a 2020 2020 2020 2020  ep UP',.        
+000150a0: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+000150b0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+000150c0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+000150d0: 743d 746f 7461 6c5f 7469 6d65 6f75 745f  t=total_timeout_
+000150e0: 6d69 6e75 7465 7320 2a20 3630 2c0a 2020  minutes * 60,.  
+000150f0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00015100: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00015110: 7465 7374 2e6d 6172 6b2e 7363 700a 6465  test.mark.scp.de
+00015120: 6620 7465 7374 5f73 6370 5f61 7574 6f64  f test_scp_autod
+00015130: 6f77 6e28 293a 0a20 2020 206e 616d 6520  own():.    name 
+00015140: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00015150: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+00015160: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+00015170: 5343 505f 6175 746f 646f 776e 272c 0a20  SCP_autodown',. 
+00015180: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00015190: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+000151a0: 6820 2d79 202d 6420 2d63 207b 6e61 6d65  h -y -d -c {name
+000151b0: 7d20 7b53 4350 5f54 5950 457d 2074 6573  } {SCP_TYPE} tes
+000151c0: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
+000151d0: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
+000151e0: 2020 2020 2020 2020 2066 2773 6b79 2061           f'sky a
+000151f0: 7574 6f73 746f 7020 2d79 207b 6e61 6d65  utostop -y {name
+00015200: 7d20 2d2d 646f 776e 202d 6920 3127 2c0a  } --down -i 1',.
+00015210: 2020 2020 2020 2020 2020 2020 2320 456e              # En
+00015220: 7375 7265 2061 7574 6f73 746f 7020 6973  sure autostop is
+00015230: 2073 6574 2e0a 2020 2020 2020 2020 2020   set..          
+00015240: 2020 6627 736b 7920 7374 6174 7573 207c    f'sky status |
+00015250: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
+00015260: 7265 7020 2231 6d20 2864 6f77 6e29 2227  rep "1m (down)"'
+00015270: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00015280: 456e 7375 7265 2074 6865 2063 6c75 7374  Ensure the clust
+00015290: 6572 2069 7320 6e6f 7420 7465 726d 696e  er is not termin
+000152a0: 6174 6564 2065 6172 6c79 2e0a 2020 2020  ated early..    
+000152b0: 2020 2020 2020 2020 2773 6c65 6570 2034          'sleep 4
+000152c0: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
+000152d0: 6627 736b 7920 7374 6174 7573 202d 2d72  f'sky status --r
+000152e0: 6566 7265 7368 207c 2067 7265 7020 7b6e  efresh | grep {n
+000152f0: 616d 657d 207c 2067 7265 7020 5550 272c  ame} | grep UP',
+00015300: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
+00015310: 6e73 7572 6520 7468 6520 636c 7573 7465  nsure the cluste
+00015320: 7220 6973 2074 6572 6d69 6e61 7465 642e  r is terminated.
+00015330: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+00015340: 6565 7020 3230 3027 2c0a 2020 2020 2020  eep 200',.      
+00015350: 2020 2020 2020 6627 733d 2428 534b 5950        f's=$(SKYP
+00015360: 494c 4f54 5f44 4542 5547 3d30 2073 6b79  ILOT_DEBUG=0 sky
+00015370: 2073 7461 7475 7320 2d2d 7265 6672 6573   status --refres
+00015380: 6829 2026 2620 7072 696e 7466 2022 2473  h) && printf "$s
+00015390: 2220 2626 207b 7b20 6563 686f 2022 2473  " && {{ echo "$s
+000153a0: 2220 7c20 6772 6570 207b 6e61 6d65 7d20  " | grep {name} 
+000153b0: 7c20 6772 6570 2022 4175 746f 646f 776e  | grep "Autodown
+000153c0: 6564 2063 6c75 7374 6572 5c7c 7465 726d  ed cluster\|term
+000153d0: 696e 6174 6564 206f 6e20 7468 6520 636c  inated on the cl
+000153e0: 6f75 6422 3b20 7d7d 207c 7c20 7b7b 2065  oud"; }} || {{ e
+000153f0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+00015400: 7b6e 616d 657d 2026 2620 6578 6974 2031  {name} && exit 1
+00015410: 207c 7c20 6578 6974 2030 3b20 7d7d 272c   || exit 0; }}',
+00015420: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00015430: 6b79 206c 6175 6e63 6820 2d79 202d 6420  ky launch -y -d 
+00015440: 2d63 207b 6e61 6d65 7d20 7b53 4350 5f54  -c {name} {SCP_T
+00015450: 5950 457d 202d 2d64 6f77 6e20 7465 7374  YPE} --down test
+00015460: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
+00015470: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
+00015480: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+00015490: 6174 7573 207c 2067 7265 7020 7b6e 616d  atus | grep {nam
+000154a0: 657d 207c 2067 7265 7020 5550 272c 2020  e} | grep UP',  
+000154b0: 2320 456e 7375 7265 2074 6865 2063 6c75  # Ensure the clu
+000154c0: 7374 6572 2069 7320 5550 2e0a 2020 2020  ster is UP..    
+000154d0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+000154e0: 6563 207b 6e61 6d65 7d20 7b53 4350 5f54  ec {name} {SCP_T
+000154f0: 5950 457d 2074 6573 7473 2f74 6573 745f  YPE} tests/test_
+00015500: 7961 6d6c 732f 6d69 6e69 6d61 6c2e 7961  yamls/minimal.ya
+00015510: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00015520: 2066 2773 6b79 2073 7461 7475 7320 7c20   f'sky status | 
+00015530: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
+00015540: 6570 2022 316d 2028 646f 776e 2922 272c  ep "1m (down)"',
+00015550: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+00015560: 6565 7020 3230 3027 2c0a 2020 2020 2020  eep 200',.      
+00015570: 2020 2020 2020 2320 456e 7375 7265 2074        # Ensure t
+00015580: 6865 2063 6c75 7374 6572 2069 7320 7465  he cluster is te
+00015590: 726d 696e 6174 6564 2e0a 2020 2020 2020  rminated..      
+000155a0: 2020 2020 2020 6627 733d 2428 534b 5950        f's=$(SKYP
+000155b0: 494c 4f54 5f44 4542 5547 3d30 2073 6b79  ILOT_DEBUG=0 sky
+000155c0: 2073 7461 7475 7320 2d2d 7265 6672 6573   status --refres
+000155d0: 6829 2026 2620 7072 696e 7466 2022 2473  h) && printf "$s
+000155e0: 2220 2626 207b 7b20 6563 686f 2022 2473  " && {{ echo "$s
+000155f0: 2220 7c20 6772 6570 207b 6e61 6d65 7d20  " | grep {name} 
+00015600: 7c20 6772 6570 2022 4175 746f 646f 776e  | grep "Autodown
+00015610: 6564 2063 6c75 7374 6572 5c7c 7465 726d  ed cluster\|term
+00015620: 696e 6174 6564 206f 6e20 7468 6520 636c  inated on the cl
+00015630: 6f75 6422 3b20 7d7d 207c 7c20 7b7b 2065  oud"; }} || {{ e
+00015640: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+00015650: 7b6e 616d 657d 2026 2620 6578 6974 2031  {name} && exit 1
+00015660: 207c 7c20 6578 6974 2030 3b20 7d7d 272c   || exit 0; }}',
+00015670: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00015680: 6b79 206c 6175 6e63 6820 2d79 202d 6420  ky launch -y -d 
+00015690: 2d63 207b 6e61 6d65 7d20 7b53 4350 5f54  -c {name} {SCP_T
+000156a0: 5950 457d 202d 2d64 6f77 6e20 7465 7374  YPE} --down test
+000156b0: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
+000156c0: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
+000156d0: 2020 2020 2020 2020 6627 736b 7920 6175          f'sky au
+000156e0: 746f 7374 6f70 202d 7920 7b6e 616d 657d  tostop -y {name}
+000156f0: 202d 2d63 616e 6365 6c27 2c0a 2020 2020   --cancel',.    
+00015700: 2020 2020 2020 2020 2773 6c65 6570 2032          'sleep 2
+00015710: 3030 272c 0a20 2020 2020 2020 2020 2020  00',.           
+00015720: 2023 2045 6e73 7572 6520 7468 6520 636c   # Ensure the cl
+00015730: 7573 7465 7220 6973 2073 7469 6c6c 2055  uster is still U
+00015740: 502e 0a20 2020 2020 2020 2020 2020 2066  P..            f
+00015750: 2773 3d24 2853 4b59 5049 4c4f 545f 4445  's=$(SKYPILOT_DE
+00015760: 4255 473d 3020 736b 7920 7374 6174 7573  BUG=0 sky status
+00015770: 202d 2d72 6566 7265 7368 2920 2626 2070   --refresh) && p
+00015780: 7269 6e74 6620 2224 7322 2026 2620 6563  rintf "$s" && ec
+00015790: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
+000157a0: 6e61 6d65 7d20 7c20 6772 6570 2055 5027  name} | grep UP'
+000157b0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+000157c0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+000157d0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+000157e0: 2020 2020 7469 6d65 6f75 743d 3235 202a      timeout=25 *
+000157f0: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+00015800: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00015810: 290a 0a0a 6465 6620 5f67 6574 5f63 616e  )...def _get_can
+00015820: 6365 6c5f 7461 736b 5f77 6974 685f 636c  cel_task_with_cl
+00015830: 6f75 6428 6e61 6d65 2c20 636c 6f75 642c  oud(name, cloud,
+00015840: 2074 696d 656f 7574 3d31 3520 2a20 3630   timeout=15 * 60
+00015850: 293a 0a20 2020 2074 6573 7420 3d20 5465  ):.    test = Te
+00015860: 7374 280a 2020 2020 2020 2020 6627 7b63  st(.        f'{c
+00015870: 6c6f 7564 7d2d 6361 6e63 656c 2d74 6173  loud}-cancel-tas
+00015880: 6b27 2c0a 2020 2020 2020 2020 5b0a 2020  k',.        [.  
+00015890: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000158a0: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
+000158b0: 2065 7861 6d70 6c65 732f 7265 736e 6574   examples/resnet
+000158c0: 5f61 7070 2e79 616d 6c20 2d2d 636c 6f75  _app.yaml --clou
+000158d0: 6420 7b63 6c6f 7564 7d20 2d79 202d 6427  d {cloud} -y -d'
+000158e0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+000158f0: 5761 6974 2074 6865 2047 5055 2070 726f  Wait the GPU pro
+00015900: 6365 7373 2074 6f20 7374 6172 742e 0a20  cess to start.. 
+00015910: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00015920: 7020 3630 272c 0a20 2020 2020 2020 2020  p 60',.         
+00015930: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00015940: 616d 657d 2022 6e76 6964 6961 2d73 6d69  ame} "nvidia-smi
+00015950: 207c 2067 7265 7020 7079 7468 6f6e 2227   | grep python"'
+00015960: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00015970: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00015980: 3220 2d2d 7374 6174 7573 272c 2020 2320  2 --status',  # 
+00015990: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
+000159a0: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
+000159b0: 2020 2020 2020 6627 736b 7920 6361 6e63        f'sky canc
+000159c0: 656c 202d 7920 7b6e 616d 657d 2031 272c  el -y {name} 1',
+000159d0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+000159e0: 6565 7020 3630 272c 0a20 2020 2020 2020  eep 60',.       
+000159f0: 2020 2020 2023 2063 6865 636b 2069 6620       # check if 
+00015a00: 7468 6520 7079 7468 6f6e 206a 6f62 2069  the python job i
+00015a10: 7320 676f 6e65 2e0a 2020 2020 2020 2020  s gone..        
+00015a20: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+00015a30: 6e61 6d65 7d20 2221 206e 7669 6469 612d  name} "! nvidia-
+00015a40: 736d 6920 7c20 6772 6570 2070 7974 686f  smi | grep pytho
+00015a50: 6e22 272c 0a20 2020 2020 2020 2020 2020  n"',.           
+00015a60: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00015a70: 657d 2033 202d 2d73 7461 7475 7327 2c20  e} 3 --status', 
+00015a80: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+00015a90: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
+00015aa0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00015ab0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+00015ac0: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
+00015ad0: 696d 656f 7574 3d74 696d 656f 7574 2c0a  imeout=timeout,.
+00015ae0: 2020 2020 290a 2020 2020 7265 7475 726e      ).    return
+00015af0: 2074 6573 740a 0a0a 2320 2d2d 2d2d 2d2d   test...# ------
+00015b00: 2d2d 2d2d 2054 6573 7469 6e67 2060 736b  ---- Testing `sk
+00015b10: 7920 6361 6e63 656c 6020 2d2d 2d2d 2d2d  y cancel` ------
+00015b20: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
+00015b30: 6b2e 6177 730a 4070 7974 6573 742e 6d61  k.aws.@pytest.ma
+00015b40: 726b 2e73 6b69 7028 0a20 2020 2072 6561  rk.skip(.    rea
+00015b50: 736f 6e3d 2754 6865 2072 6573 6e65 745f  son='The resnet_
+00015b60: 6170 7020 6973 2066 6c61 6b79 2c20 6475  app is flaky, du
+00015b70: 6520 746f 2054 4620 6661 696c 696e 6720  e to TF failing 
+00015b80: 746f 2064 6574 6563 7420 4750 5573 2e27  to detect GPUs.'
+00015b90: 290a 6465 6620 7465 7374 5f63 616e 6365  ).def test_cance
+00015ba0: 6c5f 6177 7328 293a 0a20 2020 206e 616d  l_aws():.    nam
+00015bb0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00015bc0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00015bd0: 203d 205f 6765 745f 6361 6e63 656c 5f74   = _get_cancel_t
+00015be0: 6173 6b5f 7769 7468 5f63 6c6f 7564 286e  ask_with_cloud(n
+00015bf0: 616d 652c 2027 6177 7327 290a 2020 2020  ame, 'aws').    
+00015c00: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00015c10: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00015c20: 6b2e 6763 700a 4070 7974 6573 742e 6d61  k.gcp.@pytest.ma
+00015c30: 726b 2e73 6b69 7028 0a20 2020 2072 6561  rk.skip(.    rea
+00015c40: 736f 6e3d 2754 6865 2072 6573 6e65 745f  son='The resnet_
+00015c50: 6170 7020 6973 2066 6c61 6b79 2c20 6475  app is flaky, du
+00015c60: 6520 746f 2054 4620 6661 696c 696e 6720  e to TF failing 
+00015c70: 746f 2064 6574 6563 7420 4750 5573 2e27  to detect GPUs.'
+00015c80: 290a 6465 6620 7465 7374 5f63 616e 6365  ).def test_cance
+00015c90: 6c5f 6763 7028 293a 0a20 2020 206e 616d  l_gcp():.    nam
+00015ca0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00015cb0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00015cc0: 203d 205f 6765 745f 6361 6e63 656c 5f74   = _get_cancel_t
+00015cd0: 6173 6b5f 7769 7468 5f63 6c6f 7564 286e  ask_with_cloud(n
+00015ce0: 616d 652c 2027 6763 7027 290a 2020 2020  ame, 'gcp').    
+00015cf0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00015d00: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00015d10: 6b2e 617a 7572 650a 4070 7974 6573 742e  k.azure.@pytest.
+00015d20: 6d61 726b 2e73 6b69 7028 0a20 2020 2072  mark.skip(.    r
+00015d30: 6561 736f 6e3d 2754 6865 2072 6573 6e65  eason='The resne
+00015d40: 745f 6170 7020 6973 2066 6c61 6b79 2c20  t_app is flaky, 
+00015d50: 6475 6520 746f 2054 4620 6661 696c 696e  due to TF failin
+00015d60: 6720 746f 2064 6574 6563 7420 4750 5573  g to detect GPUs
+00015d70: 2e27 290a 6465 6620 7465 7374 5f63 616e  .').def test_can
+00015d80: 6365 6c5f 617a 7572 6528 293a 0a20 2020  cel_azure():.   
+00015d90: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+00015da0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+00015db0: 7465 7374 203d 205f 6765 745f 6361 6e63  test = _get_canc
+00015dc0: 656c 5f74 6173 6b5f 7769 7468 5f63 6c6f  el_task_with_clo
+00015dd0: 7564 286e 616d 652c 2027 617a 7572 6527  ud(name, 'azure'
+00015de0: 2c20 7469 6d65 6f75 743d 3330 202a 2036  , timeout=30 * 6
+00015df0: 3029 0a20 2020 2072 756e 5f6f 6e65 5f74  0).    run_one_t
+00015e00: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+00015e10: 6573 742e 6d61 726b 2e6e 6f5f 6c61 6d62  est.mark.no_lamb
+00015e20: 6461 5f63 6c6f 7564 2020 2320 4c61 6d62  da_cloud  # Lamb
+00015e30: 6461 2043 6c6f 7564 2064 6f65 7320 6e6f  da Cloud does no
+00015e40: 7420 6861 7665 2056 3130 3020 6770 7573  t have V100 gpus
+00015e50: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00015e60: 5f69 626d 2020 2320 4942 4d20 636c 6f75  _ibm  # IBM clou
+00015e70: 6420 6375 7272 656e 746c 7920 646f 6573  d currently does
+00015e80: 6e27 7420 7072 6f76 6964 6520 7075 626c  n't provide publ
+00015e90: 6963 2069 6d61 6765 2077 6974 6820 4355  ic image with CU
+00015ea0: 4441 0a40 7079 7465 7374 2e6d 6172 6b2e  DA.@pytest.mark.
+00015eb0: 6e6f 5f70 6170 6572 7370 6163 6520 2023  no_paperspace  #
+00015ec0: 2050 6170 6572 7370 6163 6520 6861 7320   Paperspace has 
+00015ed0: 6067 6e6f 6d65 2d73 6865 6c6c 6020 6f6e  `gnome-shell` on
+00015ee0: 206e 7669 6469 612d 736d 690a 4070 7974   nvidia-smi.@pyt
+00015ef0: 6573 742e 6d61 726b 2e6e 6f5f 7363 7020  est.mark.no_scp 
+00015f00: 2023 2053 4350 2064 6f65 7320 6e6f 7420   # SCP does not 
+00015f10: 7375 7070 6f72 7420 6e75 6d5f 6e6f 6465  support num_node
+00015f20: 7320 3e20 3120 7965 740a 6465 6620 7465  s > 1 yet.def te
+00015f30: 7374 5f63 616e 6365 6c5f 7079 746f 7263  st_cancel_pytorc
+00015f40: 6828 6765 6e65 7269 635f 636c 6f75 643a  h(generic_cloud:
+00015f50: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
+00015f60: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00015f70: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+00015f80: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+00015f90: 6361 6e63 656c 2d70 7974 6f72 6368 272c  cancel-pytorch',
+00015fa0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00015fb0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+00015fc0: 6e63 6820 2d63 207b 6e61 6d65 7d20 2d2d  nch -c {name} --
+00015fd0: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
+00015fe0: 6c6f 7564 7d20 6578 616d 706c 6573 2f72  loud} examples/r
+00015ff0: 6573 6e65 745f 6469 7374 7269 6275 7465  esnet_distribute
+00016000: 645f 746f 7263 682e 7961 6d6c 202d 7920  d_torch.yaml -y 
+00016010: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
+00016020: 2023 2057 6169 7420 7468 6520 4750 5520   # Wait the GPU 
+00016030: 7072 6f63 6573 7320 746f 2073 7461 7274  process to start
+00016040: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
+00016050: 6c65 6570 2039 3027 2c0a 2020 2020 2020  leep 90',.      
+00016060: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00016070: 207b 6e61 6d65 7d20 2228 6e76 6964 6961   {name} "(nvidia
+00016080: 2d73 6d69 207c 2067 7265 7020 7079 7468  -smi | grep pyth
+00016090: 6f6e 2920 7c7c 2027 0a20 2020 2020 2020  on) || '.       
+000160a0: 2020 2020 2023 2057 6865 6e20 7275 6e20       # When run 
+000160b0: 696e 7369 6465 2063 6f6e 7461 696e 6572  inside container
+000160c0: 2f6b 3873 2c20 6e76 6964 6961 2d73 6d69  /k8s, nvidia-smi
+000160d0: 2063 616e 6e6f 7420 7368 6f77 2070 726f   cannot show pro
+000160e0: 6365 7373 2069 6473 2e0a 2020 2020 2020  cess ids..      
+000160f0: 2020 2020 2020 2320 5365 6520 6874 7470        # See http
+00016100: 733a 2f2f 6769 7468 7562 2e63 6f6d 2f4e  s://github.com/N
+00016110: 5649 4449 412f 6e76 6964 6961 2d64 6f63  VIDIA/nvidia-doc
+00016120: 6b65 722f 6973 7375 6573 2f31 3739 0a20  ker/issues/179. 
+00016130: 2020 2020 2020 2020 2020 2023 2054 6f20             # To 
+00016140: 776f 726b 2061 726f 756e 642c 2077 6520  work around, we 
+00016150: 6368 6563 6b20 6966 2047 5055 2075 7469  check if GPU uti
+00016160: 6c69 7a61 7469 6f6e 2069 7320 6772 6561  lization is grea
+00016170: 7465 7220 7468 616e 2030 2e0a 2020 2020  ter than 0..    
+00016180: 2020 2020 2020 2020 6627 5b20 5c24 286e          f'[ \$(n
+00016190: 7669 6469 612d 736d 6920 2d2d 7175 6572  vidia-smi --quer
+000161a0: 792d 6770 753d 7574 696c 697a 6174 696f  y-gpu=utilizatio
+000161b0: 6e2e 6770 7520 2d2d 666f 726d 6174 3d63  n.gpu --format=c
+000161c0: 7376 2c6e 6f68 6561 6465 722c 6e6f 756e  sv,noheader,noun
+000161d0: 6974 7329 202d 6774 2030 205d 2227 2c0a  its) -gt 0 ]"',.
+000161e0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000161f0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
+00016200: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
+00016210: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
+00016220: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+00016230: 2020 2020 6627 736b 7920 6361 6e63 656c      f'sky cancel
+00016240: 202d 7920 7b6e 616d 657d 2031 272c 0a20   -y {name} 1',. 
+00016250: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00016260: 7020 3630 272c 0a20 2020 2020 2020 2020  p 60',.         
+00016270: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00016280: 616d 657d 2022 286e 7669 6469 612d 736d  ame} "(nvidia-sm
+00016290: 6920 7c20 6772 6570 205c 274e 6f20 7275  i | grep \'No ru
+000162a0: 6e6e 696e 6720 7072 6f63 6573 735c 2729  nning process\')
+000162b0: 207c 7c20 270a 2020 2020 2020 2020 2020   || '.          
+000162c0: 2020 2320 456e 7375 7265 2058 6f72 6720    # Ensure Xorg 
+000162d0: 6973 2074 6865 206f 6e6c 7920 7072 6f63  is the only proc
+000162e0: 6573 7320 7275 6e6e 696e 672e 0a20 2020  ess running..   
+000162f0: 2020 2020 2020 2020 2027 5b20 5c24 286e           '[ \$(n
+00016300: 7669 6469 612d 736d 6920 7c20 6772 6570  vidia-smi | grep
+00016310: 202d 4120 3130 2050 726f 6365 7373 6573   -A 10 Processes
+00016320: 207c 2067 7265 7020 2d41 2031 3020 3d3d   | grep -A 10 ==
+00016330: 3d20 7c20 6772 6570 202d 7620 586f 7267  = | grep -v Xorg
+00016340: 2920 2d65 7120 3220 5d22 272c 0a20 2020  ) -eq 2 ]"',.   
+00016350: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00016360: 6f67 7320 7b6e 616d 657d 2033 202d 2d73  ogs {name} 3 --s
+00016370: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+00016380: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
+00016390: 6465 642e 0a20 2020 2020 2020 205d 2c0a  ded..        ],.
+000163a0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+000163b0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+000163c0: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+000163d0: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
+000163e0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+000163f0: 6573 7429 0a0a 0a23 2063 616e 2774 2075  est)...# can't u
+00016400: 7365 2060 5f67 6574 5f63 616e 6365 6c5f  se `_get_cancel_
+00016410: 7461 736b 5f77 6974 685f 636c 6f75 6428  task_with_cloud(
+00016420: 2960 2c20 6173 2063 6f6d 6d61 6e64 2060  )`, as command `
+00016430: 6e76 6964 6961 2d73 6d69 600a 2320 7265  nvidia-smi`.# re
+00016440: 7175 6972 6573 2061 2043 5544 4120 7075  quires a CUDA pu
+00016450: 626c 6963 2069 6d61 6765 2c20 7768 6963  blic image, whic
+00016460: 6820 4942 4d20 646f 6573 6e27 7420 6f66  h IBM doesn't of
+00016470: 6665 720a 4070 7974 6573 742e 6d61 726b  fer.@pytest.mark
+00016480: 2e69 626d 0a64 6566 2074 6573 745f 6361  .ibm.def test_ca
+00016490: 6e63 656c 5f69 626d 2829 3a0a 2020 2020  ncel_ibm():.    
+000164a0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+000164b0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+000164c0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+000164d0: 2020 2020 2769 626d 2d63 616e 6365 6c2d      'ibm-cancel-
+000164e0: 7461 736b 272c 0a20 2020 2020 2020 205b  task',.        [
+000164f0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00016500: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00016510: 7b6e 616d 657d 202d 2d63 6c6f 7564 2069  {name} --cloud i
+00016520: 626d 2065 7861 6d70 6c65 732f 6d69 6e69  bm examples/mini
+00016530: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
+00016540: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00016550: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
+00016560: 657d 2d31 202d 6420 2022 7768 696c 6520  e}-1 -d  "while 
+00016570: 7472 7565 3b20 646f 2065 6368 6f20 5c27  true; do echo \'
+00016580: 4865 6c6c 6f20 536b 7950 696c 6f74 5c27  Hello SkyPilot\'
+00016590: 3b20 736c 6565 7020 323b 2064 6f6e 6522  ; sleep 2; done"
+000165a0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+000165b0: 736c 6565 7020 3230 272c 0a20 2020 2020  sleep 20',.     
+000165c0: 2020 2020 2020 2066 2773 6b79 2071 7565         f'sky que
+000165d0: 7565 207b 6e61 6d65 7d20 7c20 6772 6570  ue {name} | grep
+000165e0: 207b 6e61 6d65 7d2d 3120 7c20 6772 6570   {name}-1 | grep
+000165f0: 2052 554e 4e49 4e47 272c 0a20 2020 2020   RUNNING',.     
+00016600: 2020 2020 2020 2066 2773 6b79 2063 616e         f'sky can
+00016610: 6365 6c20 2d79 207b 6e61 6d65 7d20 3227  cel -y {name} 2'
+00016620: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00016630: 736c 6565 7020 3527 2c0a 2020 2020 2020  sleep 5',.      
+00016640: 2020 2020 2020 6627 736b 7920 7175 6575        f'sky queu
+00016650: 6520 7b6e 616d 657d 207c 2067 7265 7020  e {name} | grep 
+00016660: 7b6e 616d 657d 2d31 207c 2067 7265 7020  {name}-1 | grep 
+00016670: 4341 4e43 454c 4c45 4427 2c0a 2020 2020  CANCELLED',.    
+00016680: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+00016690: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+000166a0: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+000166b0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+000166c0: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
+000166d0: 2d20 5465 7374 696e 6720 7573 652d 7370  - Testing use-sp
+000166e0: 6f74 206f 7074 696f 6e20 2d2d 2d2d 2d2d  ot option ------
+000166f0: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
+00016700: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b20  k.no_fluidstack 
+00016710: 2023 2046 6c75 6964 5374 6163 6b20 646f   # FluidStack do
+00016720: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
+00016730: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
+00016740: 7974 6573 742e 6d61 726b 2e6e 6f5f 617a  ytest.mark.no_az
+00016750: 7572 6520 2023 2041 7a75 7265 2064 6f65  ure  # Azure doe
+00016760: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
+00016770: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
+00016780: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
+00016790: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
+000167a0: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
+000167b0: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+000167c0: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+000167d0: 742e 6d61 726b 2e6e 6f5f 7061 7065 7273  t.mark.no_papers
+000167e0: 7061 6365 2020 2320 5061 7065 7273 7061  pace  # Paperspa
+000167f0: 6365 2064 6f65 7320 6e6f 7420 7375 7070  ce does not supp
+00016800: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
+00016810: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
+00016820: 6e6f 5f69 626d 2020 2320 4942 4d20 436c  no_ibm  # IBM Cl
+00016830: 6f75 6420 646f 6573 206e 6f74 2073 7570  oud does not sup
+00016840: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
+00016850: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+00016860: 2e6e 6f5f 7363 7020 2023 2053 4350 2064  .no_scp  # SCP d
+00016870: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+00016880: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
+00016890: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6b  pytest.mark.no_k
+000168a0: 7562 6572 6e65 7465 7320 2023 204b 7562  ubernetes  # Kub
+000168b0: 6572 6e65 7465 7320 646f 6573 206e 6f74  ernetes does not
+000168c0: 2068 6176 6520 6120 6e6f 7469 6f6e 206f   have a notion o
+000168d0: 6620 7370 6f74 2069 6e73 7461 6e63 6573  f spot instances
+000168e0: 0a64 6566 2074 6573 745f 7573 655f 7370  .def test_use_sp
+000168f0: 6f74 2867 656e 6572 6963 5f63 6c6f 7564  ot(generic_cloud
+00016900: 3a20 7374 7229 3a0a 2020 2020 2222 2254  : str):.    """T
+00016910: 6573 7420 7573 652d 7370 6f74 2061 6e64  est use-spot and
+00016920: 2073 6b79 2065 7865 632e 2222 220a 2020   sky exec.""".  
+00016930: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00016940: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00016950: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00016960: 2020 2020 2020 2775 7365 2d73 706f 7427        'use-spot'
+00016970: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00016980: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+00016990: 756e 6368 202d 6320 7b6e 616d 657d 202d  unch -c {name} -
+000169a0: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+000169b0: 636c 6f75 647d 2074 6573 7473 2f74 6573  cloud} tests/tes
+000169c0: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
+000169d0: 7961 6d6c 202d 2d75 7365 2d73 706f 7420  yaml --use-spot 
+000169e0: 2d79 272c 0a20 2020 2020 2020 2020 2020  -y',.           
+000169f0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00016a00: 657d 2031 202d 2d73 7461 7475 7327 2c0a  e} 1 --status',.
+00016a10: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00016a20: 7920 6578 6563 207b 6e61 6d65 7d20 6563  y exec {name} ec
+00016a30: 686f 2068 6927 2c0a 2020 2020 2020 2020  ho hi',.        
+00016a40: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00016a50: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
+00016a60: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+00016a70: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00016a80: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00016a90: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00016aa0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+00016ab0: 6573 742e 6d61 726b 2e67 6370 0a64 6566  est.mark.gcp.def
+00016ac0: 2074 6573 745f 7374 6f70 5f67 6370 5f73   test_stop_gcp_s
+00016ad0: 706f 7428 293a 0a20 2020 2022 2222 5465  pot():.    """Te
+00016ae0: 7374 2047 4350 2073 706f 7420 6361 6e20  st GCP spot can 
+00016af0: 6265 2073 746f 7070 6564 2c20 6175 746f  be stopped, auto
+00016b00: 7374 6f70 7065 642c 2072 6573 7461 7274  stopped, restart
+00016b10: 6564 2e22 2222 0a20 2020 206e 616d 6520  ed.""".    name 
+00016b20: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00016b30: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+00016b40: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+00016b50: 7374 6f70 5f67 6370 5f73 706f 7427 2c0a  stop_gcp_spot',.
+00016b60: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00016b70: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00016b80: 6368 202d 6320 7b6e 616d 657d 202d 2d63  ch -c {name} --c
+00016b90: 6c6f 7564 2067 6370 202d 2d75 7365 2d73  loud gcp --use-s
+00016ba0: 706f 7420 2d2d 6370 7573 2032 2b20 2d79  pot --cpus 2+ -y
+00016bb0: 202d 2d20 746f 7563 6820 6d79 6669 6c65   -- touch myfile
+00016bc0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+00016bd0: 2073 746f 7020 7368 6f75 6c64 2067 6f20   stop should go 
+00016be0: 7468 726f 7567 683a 0a20 2020 2020 2020  through:.       
+00016bf0: 2020 2020 2066 2773 6b79 2073 746f 7020       f'sky stop 
+00016c00: 7b6e 616d 657d 202d 7927 2c0a 2020 2020  {name} -y',.    
+00016c10: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+00016c20: 6172 7420 7b6e 616d 657d 202d 7927 2c0a  art {name} -y',.
+00016c30: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00016c40: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
+00016c50: 206c 7320 6d79 6669 6c65 272c 0a20 2020   ls myfile',.   
+00016c60: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00016c70: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
+00016c80: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+00016c90: 2020 2020 6627 736b 7920 6175 746f 7374      f'sky autost
+00016ca0: 6f70 207b 6e61 6d65 7d20 2d69 3020 2d79  op {name} -i0 -y
+00016cb0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+00016cc0: 736c 6565 7020 3930 272c 0a20 2020 2020  sleep 90',.     
+00016cd0: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+00016ce0: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
+00016cf0: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
+00016d00: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
+00016d10: 3b20 6563 686f 2022 2473 2220 207c 2067  ; echo "$s"  | g
+00016d20: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+00016d30: 7020 5354 4f50 5045 4427 2c0a 2020 2020  p STOPPED',.    
+00016d40: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+00016d50: 6172 7420 7b6e 616d 657d 202d 7927 2c0a  art {name} -y',.
+00016d60: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00016d70: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
+00016d80: 206c 7320 6d79 6669 6c65 272c 0a20 2020   ls myfile',.   
+00016d90: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00016da0: 6f67 7320 7b6e 616d 657d 2033 202d 2d73  ogs {name} 3 --s
+00016db0: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+00016dc0: 2020 2020 2320 2d69 206f 7074 696f 6e20      # -i option 
+00016dd0: 6174 206c 6175 6e63 6820 7368 6f75 6c64  at launch should
+00016de0: 2067 6f20 7468 726f 7567 683a 0a20 2020   go through:.   
+00016df0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00016e00: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
+00016e10: 2d69 3020 2d79 272c 0a20 2020 2020 2020  -i0 -y',.       
+00016e20: 2020 2020 2027 736c 6565 7020 3132 3027       'sleep 120'
+00016e30: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00016e40: 733d 2428 736b 7920 7374 6174 7573 207b  s=$(sky status {
+00016e50: 6e61 6d65 7d20 2d2d 7265 6672 6573 6829  name} --refresh)
+00016e60: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
+00016e70: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
+00016e80: 7322 2020 7c20 6772 6570 207b 6e61 6d65  s"  | grep {name
+00016e90: 7d20 7c20 6772 6570 2053 544f 5050 4544  } | grep STOPPED
+00016ea0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+00016eb0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00016ec0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00016ed0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00016ee0: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+00016ef0: 2d2d 2d2d 2d2d 2d2d 2054 6573 7469 6e67  -------- Testing
+00016f00: 206d 616e 6167 6564 2073 706f 7420 2d2d   managed spot --
+00016f10: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
+00016f20: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
+00016f30: 6163 6b20 2023 2046 6c75 6964 5374 6163  ack  # FluidStac
+00016f40: 6b20 646f 6573 206e 6f74 2073 7570 706f  k does not suppo
+00016f50: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
+00016f60: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
+00016f70: 6f5f 617a 7572 6520 2023 2041 7a75 7265  o_azure  # Azure
+00016f80: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+00016f90: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
+00016fa0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00016fb0: 5f6c 616d 6264 615f 636c 6f75 6420 2023  _lambda_cloud  #
+00016fc0: 204c 616d 6264 6120 436c 6f75 6420 646f   Lambda Cloud do
+00016fd0: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
+00016fe0: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
+00016ff0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6962  ytest.mark.no_ib
+00017000: 6d20 2023 2049 424d 2043 6c6f 7564 2064  m  # IBM Cloud d
+00017010: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+00017020: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
+00017030: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f73  pytest.mark.no_s
+00017040: 6370 2020 2320 5343 5020 646f 6573 206e  cp  # SCP does n
+00017050: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+00017060: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+00017070: 742e 6d61 726b 2e6e 6f5f 7061 7065 7273  t.mark.no_papers
+00017080: 7061 6365 2020 2320 5061 7070 6572 7370  pace  # Pappersp
+00017090: 6163 6520 646f 6573 206e 6f74 2073 7570  ace does not sup
+000170a0: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
+000170b0: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+000170c0: 2e6e 6f5f 6b75 6265 726e 6574 6573 2020  .no_kubernetes  
+000170d0: 2320 4b75 6265 726e 6574 6573 2064 6f65  # Kubernetes doe
+000170e0: 7320 6e6f 7420 6861 7665 2061 206e 6f74  s not have a not
+000170f0: 696f 6e20 6f66 2073 706f 7420 696e 7374  ion of spot inst
+00017100: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+00017110: 726b 2e6d 616e 6167 6564 5f73 706f 740a  rk.managed_spot.
+00017120: 6465 6620 7465 7374 5f73 706f 7428 6765  def test_spot(ge
+00017130: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+00017140: 293a 0a20 2020 2022 2222 5465 7374 2074  ):.    """Test t
+00017150: 6865 2073 706f 7420 7961 6d6c 2e22 2222  he spot yaml."""
+00017160: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00017170: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00017180: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00017190: 0a20 2020 2020 2020 2027 6d61 6e61 6765  .        'manage
+000171a0: 642d 7370 6f74 272c 0a20 2020 2020 2020  d-spot',.       
+000171b0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+000171c0: 2773 6b79 2073 706f 7420 6c61 756e 6368  'sky spot launch
+000171d0: 202d 6e20 7b6e 616d 657d 2d31 202d 2d63   -n {name}-1 --c
+000171e0: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+000171f0: 6f75 647d 2065 7861 6d70 6c65 732f 6d61  oud} examples/ma
+00017200: 6e61 6765 645f 7370 6f74 2e79 616d 6c20  naged_spot.yaml 
+00017210: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
+00017220: 2020 2020 6627 736b 7920 7370 6f74 206c      f'sky spot l
+00017230: 6175 6e63 6820 2d6e 207b 6e61 6d65 7d2d  aunch -n {name}-
+00017240: 3220 2d2d 636c 6f75 6420 7b67 656e 6572  2 --cloud {gener
+00017250: 6963 5f63 6c6f 7564 7d20 6578 616d 706c  ic_cloud} exampl
+00017260: 6573 2f6d 616e 6167 6564 5f73 706f 742e  es/managed_spot.
+00017270: 7961 6d6c 202d 7920 2d64 272c 0a20 2020  yaml -y -d',.   
+00017280: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00017290: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
+000172a0: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+000172b0: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+000172c0: 7d2d 3120 7c20 6865 6164 202d 6e31 207c  }-1 | head -n1 |
+000172d0: 2067 7265 7020 2253 5441 5254 494e 475c   grep "STARTING\
+000172e0: 7c52 554e 4e49 4e47 2227 2c0a 2020 2020  |RUNNING"',.    
+000172f0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+00017300: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+00017310: 6570 207b 6e61 6d65 7d2d 3220 7c20 6865  ep {name}-2 | he
+00017320: 6164 202d 6e31 207c 2067 7265 7020 2253  ad -n1 | grep "S
+00017330: 5441 5254 494e 475c 7c52 554e 4e49 4e47  TARTING\|RUNNING
+00017340: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00017350: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
+00017360: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
+00017370: 653d 6627 7b6e 616d 657d 2d31 2729 2c0a  e=f'{name}-1'),.
+00017380: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00017390: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
+000173a0: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
+000173b0: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+000173c0: 616d 657d 2d31 207c 2068 6561 6420 2d6e  ame}-1 | head -n
+000173d0: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
+000173e0: 4c49 4e47 5c7c 4341 4e43 454c 4c45 4422  LING\|CANCELLED"
+000173f0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+00017400: 736c 6565 7020 3230 3027 2c0a 2020 2020  sleep 200',.    
+00017410: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+00017420: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+00017430: 6570 207b 6e61 6d65 7d2d 3120 7c20 6865  ep {name}-1 | he
+00017440: 6164 202d 6e31 207c 2067 7265 7020 4341  ad -n1 | grep CA
+00017450: 4e43 454c 4c45 4427 2c0a 2020 2020 2020  NCELLED',.      
+00017460: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+00017470: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+00017480: 207b 6e61 6d65 7d2d 3220 7c20 6865 6164   {name}-2 | head
+00017490: 202d 6e31 207c 2067 7265 7020 2252 554e   -n1 | grep "RUN
+000174a0: 4e49 4e47 5c7c 5355 4343 4545 4445 4422  NING\|SUCCEEDED"
+000174b0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+000174c0: 2020 2020 2020 2320 544f 444f 287a 6877        # TODO(zhw
+000174d0: 7529 3a20 4368 616e 6765 2074 6f20 5f53  u): Change to _S
+000174e0: 504f 545f 4341 4e43 454c 5f57 4149 542e  POT_CANCEL_WAIT.
+000174f0: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
+00017500: 6627 7b6e 616d 657d 2d31 202d 6e20 7b6e  f'{name}-1 -n {n
+00017510: 616d 657d 2d32 2729 2077 6865 6e0a 2020  ame}-2') when.  
+00017520: 2020 2020 2020 2320 6361 6e63 656c 696e        # cancelin
+00017530: 6720 6d75 6c74 6970 6c65 206a 6f62 206e  g multiple job n
+00017540: 616d 6573 2069 7320 7375 7070 6f72 7465  ames is supporte
+00017550: 642e 0a20 2020 2020 2020 2028 5f53 504f  d..        (_SPO
+00017560: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
+00017570: 726d 6174 286a 6f62 5f6e 616d 653d 6627  rmat(job_name=f'
+00017580: 7b6e 616d 657d 2d31 2729 202b 2027 3b20  {name}-1') + '; 
+00017590: 2720 2b0a 2020 2020 2020 2020 205f 5350  ' +.         _SP
+000175a0: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
+000175b0: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d66  ormat(job_name=f
+000175c0: 277b 6e61 6d65 7d2d 3227 2929 2c0a 2020  '{name}-2')),.  
+000175d0: 2020 2020 2020 2320 496e 6372 6561 7365        # Increase
+000175e0: 2074 696d 656f 7574 2073 696e 6365 2073   timeout since s
+000175f0: 6b79 2073 706f 7420 7175 6575 6520 2d72  ky spot queue -r
+00017600: 2063 616e 2062 6520 626c 6f63 6b65 6420   can be blocked 
+00017610: 6279 206f 7468 6572 2073 706f 7420 7465  by other spot te
+00017620: 7374 732e 0a20 2020 2020 2020 2074 696d  sts..        tim
+00017630: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
+00017640: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00017650: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00017660: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
+00017670: 6964 7374 6163 6b20 2023 666c 7569 6473  idstack  #fluids
+00017680: 7461 636b 2064 6f65 7320 6e6f 7420 7375  tack does not su
+00017690: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+000176a0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+000176b0: 6b2e 6e6f 5f61 7a75 7265 2020 2320 417a  k.no_azure  # Az
+000176c0: 7572 6520 646f 6573 206e 6f74 2073 7570  ure does not sup
+000176d0: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
+000176e0: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+000176f0: 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f 7564  .no_lambda_cloud
+00017700: 2020 2320 4c61 6d62 6461 2043 6c6f 7564    # Lambda Cloud
+00017710: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+00017720: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
+00017730: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00017740: 5f69 626d 2020 2320 4942 4d20 436c 6f75  _ibm  # IBM Clou
+00017750: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
+00017760: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
+00017770: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
+00017780: 6f5f 7363 7020 2023 2053 4350 2064 6f65  o_scp  # SCP doe
+00017790: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
+000177a0: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
+000177b0: 7465 7374 2e6d 6172 6b2e 6e6f 5f70 6170  test.mark.no_pap
+000177c0: 6572 7370 6163 6520 2023 2050 6170 6572  erspace  # Paper
+000177d0: 7370 6163 6520 646f 6573 206e 6f74 2073  space does not s
+000177e0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+000177f0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+00017800: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
+00017810: 2020 2320 4b75 6265 726e 6574 6573 2064    # Kubernetes d
+00017820: 6f65 7320 6e6f 7420 6861 7665 2061 206e  oes not have a n
+00017830: 6f74 696f 6e20 6f66 2073 706f 7420 696e  otion of spot in
+00017840: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
+00017850: 6d61 726b 2e6d 616e 6167 6564 5f73 706f  mark.managed_spo
+00017860: 740a 6465 6620 7465 7374 5f73 706f 745f  t.def test_spot_
+00017870: 7069 7065 6c69 6e65 2867 656e 6572 6963  pipeline(generic
+00017880: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
+00017890: 2020 2222 2254 6573 7420 6120 7370 6f74    """Test a spot
+000178a0: 2070 6970 656c 696e 652e 2222 220a 2020   pipeline.""".  
+000178b0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+000178c0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+000178d0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+000178e0: 2020 2020 2020 2773 706f 742d 7069 7065        'spot-pipe
+000178f0: 6c69 6e65 272c 0a20 2020 2020 2020 205b  line',.        [
+00017900: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00017910: 6b79 2073 706f 7420 6c61 756e 6368 202d  ky spot launch -
+00017920: 6e20 7b6e 616d 657d 2074 6573 7473 2f74  n {name} tests/t
+00017930: 6573 745f 7961 6d6c 732f 7069 7065 6c69  est_yamls/pipeli
+00017940: 6e65 2e79 616d 6c20 2d79 202d 6427 2c0a  ne.yaml -y -d',.
+00017950: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00017960: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
+00017970: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
+00017980: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+00017990: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
+000179a0: 7c20 6772 6570 2022 5354 4152 5449 4e47  | grep "STARTING
+000179b0: 5c7c 5255 4e4e 494e 4722 272c 0a20 2020  \|RUNNING"',.   
+000179c0: 2020 2020 2020 2020 2023 2060 6772 6570           # `grep
+000179d0: 202d 4120 3420 7b6e 616d 657d 6020 6669   -A 4 {name}` fi
+000179e0: 6e64 7320 7468 6520 6a6f 6220 7769 7468  nds the job with
+000179f0: 207b 6e61 6d65 7d20 616e 6420 7468 6520   {name} and the 
+00017a00: 3420 6c69 6e65 730a 2020 2020 2020 2020  4 lines.        
+00017a10: 2020 2020 2320 6166 7465 7220 6974 2c20      # after it, 
+00017a20: 692e 652e 2074 6865 2034 2074 6173 6b73  i.e. the 4 tasks
+00017a30: 2077 6974 6869 6e20 7468 6520 6a6f 622e   within the job.
+00017a40: 0a20 2020 2020 2020 2020 2020 2023 2060  .            # `
+00017a50: 7365 6420 2d6e 2032 7060 2067 6574 7320  sed -n 2p` gets 
+00017a60: 7468 6520 7365 636f 6e64 206c 696e 6520  the second line 
+00017a70: 6f66 2074 6865 2034 206c 696e 6573 2c20  of the 4 lines, 
+00017a80: 692e 652e 2074 6865 2066 6972 7374 0a20  i.e. the first. 
+00017a90: 2020 2020 2020 2020 2020 2023 2074 6173             # tas
+00017aa0: 6b20 7769 7468 696e 2074 6865 206a 6f62  k within the job
+00017ab0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00017ac0: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+00017ad0: 547d 7c20 6772 6570 202d 4120 3420 7b6e  T}| grep -A 4 {n
+00017ae0: 616d 657d 7c20 7365 6420 2d6e 2032 7020  ame}| sed -n 2p 
+00017af0: 7c20 6772 6570 2022 5354 4152 5449 4e47  | grep "STARTING
+00017b00: 5c7c 5255 4e4e 494e 4722 272c 0a20 2020  \|RUNNING"',.   
+00017b10: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
+00017b20: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
+00017b30: 7265 7020 2d41 2034 207b 6e61 6d65 7d7c  rep -A 4 {name}|
+00017b40: 2073 6564 202d 6e20 3370 207c 2067 7265   sed -n 3p | gre
+00017b50: 7020 2250 454e 4449 4e47 2227 2c0a 2020  p "PENDING"',.  
+00017b60: 2020 2020 2020 2020 2020 5f53 504f 545f            _SPOT_
+00017b70: 4341 4e43 454c 5f57 4149 542e 666f 726d  CANCEL_WAIT.form
+00017b80: 6174 286a 6f62 5f6e 616d 653d 6627 7b6e  at(job_name=f'{n
+00017b90: 616d 657d 2729 2c0a 2020 2020 2020 2020  ame}'),.        
+00017ba0: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
+00017bb0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+00017bc0: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
+00017bd0: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
+00017be0: 7d7c 2073 6564 202d 6e20 3270 207c 2067  }| sed -n 2p | g
+00017bf0: 7265 7020 2243 414e 4345 4c4c 494e 475c  rep "CANCELLING\
+00017c00: 7c43 414e 4345 4c4c 4544 2227 2c0a 2020  |CANCELLED"',.  
+00017c10: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
+00017c20: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
+00017c30: 6772 6570 202d 4120 3420 7b6e 616d 657d  grep -A 4 {name}
+00017c40: 7c20 7365 6420 2d6e 2033 7020 7c20 6772  | sed -n 3p | gr
+00017c50: 6570 2022 4341 4e43 454c 4c49 4e47 5c7c  ep "CANCELLING\|
+00017c60: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
+00017c70: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
+00017c80: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
+00017c90: 7265 7020 2d41 2034 207b 6e61 6d65 7d7c  rep -A 4 {name}|
+00017ca0: 2073 6564 202d 6e20 3470 207c 2067 7265   sed -n 4p | gre
+00017cb0: 7020 2243 414e 4345 4c4c 494e 475c 7c43  p "CANCELLING\|C
+00017cc0: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
+00017cd0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+00017ce0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+00017cf0: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
+00017d00: 7365 6420 2d6e 2035 7020 7c20 6772 6570  sed -n 5p | grep
+00017d10: 2022 4341 4e43 454c 4c49 4e47 5c7c 4341   "CANCELLING\|CA
+00017d20: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
+00017d30: 2020 2020 2020 2027 736c 6565 7020 3230         'sleep 20
+00017d40: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00017d50: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+00017d60: 4149 547d 7c20 6772 6570 202d 4120 3420  AIT}| grep -A 4 
+00017d70: 7b6e 616d 657d 7c20 7365 6420 2d6e 2032  {name}| sed -n 2
+00017d80: 7020 7c20 6772 6570 2022 4341 4e43 454c  p | grep "CANCEL
+00017d90: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
+00017da0: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
+00017db0: 455f 5741 4954 7d7c 2067 7265 7020 2d41  E_WAIT}| grep -A
+00017dc0: 2034 207b 6e61 6d65 7d7c 2073 6564 202d   4 {name}| sed -
+00017dd0: 6e20 3370 207c 2067 7265 7020 2243 414e  n 3p | grep "CAN
+00017de0: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
+00017df0: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+00017e00: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+00017e10: 202d 4120 3420 7b6e 616d 657d 7c20 7365   -A 4 {name}| se
+00017e20: 6420 2d6e 2034 7020 7c20 6772 6570 2022  d -n 4p | grep "
+00017e30: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
+00017e40: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
+00017e50: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
+00017e60: 7265 7020 2d41 2034 207b 6e61 6d65 7d7c  rep -A 4 {name}|
+00017e70: 2073 6564 202d 6e20 3570 207c 2067 7265   sed -n 5p | gre
+00017e80: 7020 2243 414e 4345 4c4c 4544 2227 2c0a  p "CANCELLED"',.
+00017e90: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00017ea0: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
+00017eb0: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
+00017ec0: 6e61 6d65 3d66 277b 6e61 6d65 7d27 292c  name=f'{name}'),
+00017ed0: 0a20 2020 2020 2020 2023 2049 6e63 7265  .        # Incre
+00017ee0: 6173 6520 7469 6d65 6f75 7420 7369 6e63  ase timeout sinc
+00017ef0: 6520 736b 7920 7370 6f74 2071 7565 7565  e sky spot queue
+00017f00: 202d 7220 6361 6e20 6265 2062 6c6f 636b   -r can be block
+00017f10: 6564 2062 7920 6f74 6865 7220 7370 6f74  ed by other spot
+00017f20: 2074 6573 7473 2e0a 2020 2020 2020 2020   tests..        
+00017f30: 7469 6d65 6f75 743d 3330 202a 2036 302c  timeout=30 * 60,
+00017f40: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00017f50: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00017f60: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00017f70: 666c 7569 6473 7461 636b 2020 2366 6c75  fluidstack  #flu
+00017f80: 6964 7374 6163 6b20 646f 6573 206e 6f74  idstack does not
+00017f90: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
+00017fa0: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
+00017fb0: 6d61 726b 2e6e 6f5f 617a 7572 6520 2023  mark.no_azure  #
+00017fc0: 2041 7a75 7265 2064 6f65 7320 6e6f 7420   Azure does not 
+00017fd0: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
+00017fe0: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+00017ff0: 6172 6b2e 6e6f 5f6c 616d 6264 615f 636c  ark.no_lambda_cl
+00018000: 6f75 6420 2023 204c 616d 6264 6120 436c  oud  # Lambda Cl
+00018010: 6f75 6420 646f 6573 206e 6f74 2073 7570  oud does not sup
+00018020: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
+00018030: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+00018040: 2e6e 6f5f 6962 6d20 2023 2049 424d 2043  .no_ibm  # IBM C
+00018050: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
+00018060: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+00018070: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+00018080: 6b2e 6e6f 5f73 6370 2020 2320 5343 5020  k.no_scp  # SCP 
+00018090: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+000180a0: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
+000180b0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+000180c0: 7061 7065 7273 7061 6365 2020 2320 5061  paperspace  # Pa
+000180d0: 7065 7273 7061 6365 2064 6f65 7320 6e6f  perspace does no
+000180e0: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
+000180f0: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
+00018100: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
+00018110: 7465 7320 2023 204b 7562 6572 6e65 7465  tes  # Kubernete
+00018120: 7320 646f 6573 206e 6f74 2068 6176 6520  s does not have 
+00018130: 6120 6e6f 7469 6f6e 206f 6620 7370 6f74  a notion of spot
+00018140: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+00018150: 7374 2e6d 6172 6b2e 6d61 6e61 6765 645f  st.mark.managed_
+00018160: 7370 6f74 0a64 6566 2074 6573 745f 7370  spot.def test_sp
+00018170: 6f74 5f66 6169 6c65 645f 7365 7475 7028  ot_failed_setup(
+00018180: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
+00018190: 7472 293a 0a20 2020 2022 2222 5465 7374  tr):.    """Test
+000181a0: 206d 616e 6167 6564 2073 706f 7420 6a6f   managed spot jo
+000181b0: 6220 7769 7468 2066 6169 6c65 6420 7365  b with failed se
+000181c0: 7475 702e 2222 220a 2020 2020 6e61 6d65  tup.""".    name
+000181d0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+000181e0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+000181f0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00018200: 2773 706f 745f 6661 696c 6564 5f73 6574  'spot_failed_set
+00018210: 7570 272c 0a20 2020 2020 2020 205b 0a20  up',.        [. 
+00018220: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00018230: 2073 706f 7420 6c61 756e 6368 202d 6e20   spot launch -n 
+00018240: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
+00018250: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
+00018260: 7920 2d64 2074 6573 7473 2f74 6573 745f  y -d tests/test_
+00018270: 7961 6d6c 732f 6661 696c 6564 5f73 6574  yamls/failed_set
+00018280: 7570 2e79 616d 6c27 2c0a 2020 2020 2020  up.yaml',.      
+00018290: 2020 2020 2020 2773 6c65 6570 2033 3330        'sleep 330
+000182a0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+000182b0: 204d 616b 6520 7375 7265 2074 6865 206a   Make sure the j
+000182c0: 6f62 2066 6169 6c65 6420 7175 6963 6b6c  ob failed quickl
+000182d0: 792e 0a20 2020 2020 2020 2020 2020 2066  y..            f
+000182e0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+000182f0: 4954 7d20 7c20 6772 6570 207b 6e61 6d65  IT} | grep {name
+00018300: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
+00018310: 7265 7020 2246 4149 4c45 445f 5345 5455  rep "FAILED_SETU
+00018320: 5022 272c 0a20 2020 2020 2020 205d 2c0a  P"',.        ],.
+00018330: 2020 2020 2020 2020 5f53 504f 545f 4341          _SPOT_CA
+00018340: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
+00018350: 286a 6f62 5f6e 616d 653d 6e61 6d65 292c  (job_name=name),
+00018360: 0a20 2020 2020 2020 2023 2049 6e63 7265  .        # Incre
+00018370: 6173 6520 7469 6d65 6f75 7420 7369 6e63  ase timeout sinc
+00018380: 6520 736b 7920 7370 6f74 2071 7565 7565  e sky spot queue
+00018390: 202d 7220 6361 6e20 6265 2062 6c6f 636b   -r can be block
+000183a0: 6564 2062 7920 6f74 6865 7220 7370 6f74  ed by other spot
+000183b0: 2074 6573 7473 2e0a 2020 2020 2020 2020   tests..        
+000183c0: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
+000183d0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+000183e0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+000183f0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00018400: 666c 7569 6473 7461 636b 2020 2366 6c75  fluidstack  #flu
+00018410: 6964 7374 6163 6b20 646f 6573 206e 6f74  idstack does not
+00018420: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
+00018430: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
+00018440: 6d61 726b 2e6e 6f5f 617a 7572 6520 2023  mark.no_azure  #
+00018450: 2041 7a75 7265 2064 6f65 7320 6e6f 7420   Azure does not 
+00018460: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
+00018470: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+00018480: 6172 6b2e 6e6f 5f6c 616d 6264 615f 636c  ark.no_lambda_cl
+00018490: 6f75 6420 2023 204c 616d 6264 6120 436c  oud  # Lambda Cl
+000184a0: 6f75 6420 646f 6573 206e 6f74 2073 7570  oud does not sup
+000184b0: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
+000184c0: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+000184d0: 2e6e 6f5f 6962 6d20 2023 2049 424d 2043  .no_ibm  # IBM C
+000184e0: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
+000184f0: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+00018500: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+00018510: 6b2e 6e6f 5f73 6370 2020 2320 5343 5020  k.no_scp  # SCP 
+00018520: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+00018530: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
+00018540: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00018550: 7061 7065 7273 7061 6365 2020 2320 5061  paperspace  # Pa
+00018560: 7065 7273 7061 6365 2064 6f65 7320 6e6f  perspace does no
+00018570: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
+00018580: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
+00018590: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
+000185a0: 7465 7320 2023 204b 7562 6572 6e65 7465  tes  # Kubernete
+000185b0: 7320 646f 6573 206e 6f74 2068 6176 6520  s does not have 
+000185c0: 6120 6e6f 7469 6f6e 206f 6620 7370 6f74  a notion of spot
+000185d0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+000185e0: 7374 2e6d 6172 6b2e 6d61 6e61 6765 645f  st.mark.managed_
+000185f0: 7370 6f74 0a64 6566 2074 6573 745f 7370  spot.def test_sp
+00018600: 6f74 5f70 6970 656c 696e 655f 6661 696c  ot_pipeline_fail
+00018610: 6564 5f73 6574 7570 2867 656e 6572 6963  ed_setup(generic
+00018620: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
+00018630: 2020 2222 2254 6573 7420 6d61 6e61 6765    """Test manage
+00018640: 6420 7370 6f74 206a 6f62 2077 6974 6820  d spot job with 
+00018650: 6661 696c 6564 2073 6574 7570 2066 6f72  failed setup for
+00018660: 2061 2070 6970 656c 696e 652e 2222 220a   a pipeline.""".
+00018670: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00018680: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00018690: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+000186a0: 2020 2020 2020 2020 2773 706f 745f 7069          'spot_pi
+000186b0: 7065 6c69 6e65 5f66 6169 6c65 645f 7365  peline_failed_se
+000186c0: 7475 7027 2c0a 2020 2020 2020 2020 5b0a  tup',.        [.
+000186d0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000186e0: 7920 7370 6f74 206c 6175 6e63 6820 2d6e  y spot launch -n
+000186f0: 207b 6e61 6d65 7d20 2d79 202d 6420 7465   {name} -y -d te
+00018700: 7374 732f 7465 7374 5f79 616d 6c73 2f66  sts/test_yamls/f
+00018710: 6169 6c65 645f 7365 7475 705f 7069 7065  ailed_setup_pipe
+00018720: 6c69 6e65 2e79 616d 6c27 2c0a 2020 2020  line.yaml',.    
+00018730: 2020 2020 2020 2020 2773 6c65 6570 2038          'sleep 8
+00018740: 3030 272c 0a20 2020 2020 2020 2020 2020  00',.           
+00018750: 2023 204d 616b 6520 7375 7265 2074 6865   # Make sure the
+00018760: 206a 6f62 2066 6169 6c65 6420 7175 6963   job failed quic
+00018770: 6b6c 792e 0a20 2020 2020 2020 2020 2020  kly..           
+00018780: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
+00018790: 5741 4954 7d20 7c20 6772 6570 207b 6e61  WAIT} | grep {na
+000187a0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+000187b0: 2067 7265 7020 2246 4149 4c45 445f 5345   grep "FAILED_SE
+000187c0: 5455 5022 272c 0a20 2020 2020 2020 2020  TUP"',.         
+000187d0: 2020 2023 2054 6173 6b20 3020 7368 6f75     # Task 0 shou
+000187e0: 6c64 2062 6520 5355 4343 4545 4445 442e  ld be SUCCEEDED.
+000187f0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00018800: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+00018810: 7d20 7c20 6772 6570 202d 4120 3420 7b6e  } | grep -A 4 {n
+00018820: 616d 657d 7c20 7365 6420 2d6e 2032 7020  ame}| sed -n 2p 
+00018830: 7c20 6772 6570 2022 5355 4343 4545 4445  | grep "SUCCEEDE
+00018840: 4422 272c 0a20 2020 2020 2020 2020 2020  D"',.           
+00018850: 2023 2054 6173 6b20 3120 7368 6f75 6c64   # Task 1 should
+00018860: 2062 6520 4641 494c 4544 5f53 4554 5550   be FAILED_SETUP
+00018870: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00018880: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+00018890: 547d 207c 2067 7265 7020 2d41 2034 207b  T} | grep -A 4 {
+000188a0: 6e61 6d65 7d7c 2073 6564 202d 6e20 3370  name}| sed -n 3p
+000188b0: 207c 2067 7265 7020 2246 4149 4c45 445f   | grep "FAILED_
+000188c0: 5345 5455 5022 272c 0a20 2020 2020 2020  SETUP"',.       
+000188d0: 2020 2020 2023 2054 6173 6b20 3220 7368       # Task 2 sh
+000188e0: 6f75 6c64 2062 6520 4341 4e43 454c 4c45  ould be CANCELLE
+000188f0: 442e 0a20 2020 2020 2020 2020 2020 2066  D..            f
+00018900: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+00018910: 4954 7d20 7c20 6772 6570 202d 4120 3420  IT} | grep -A 4 
+00018920: 7b6e 616d 657d 7c20 7365 6420 2d6e 2034  {name}| sed -n 4
+00018930: 7020 7c20 6772 6570 2022 4341 4e43 454c  p | grep "CANCEL
+00018940: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
+00018950: 2020 2023 2054 6173 6b20 3320 7368 6f75     # Task 3 shou
+00018960: 6c64 2062 6520 4341 4e43 454c 4c45 442e  ld be CANCELLED.
+00018970: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00018980: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+00018990: 7d20 7c20 6772 6570 202d 4120 3420 7b6e  } | grep -A 4 {n
+000189a0: 616d 657d 7c20 7365 6420 2d6e 2035 7020  ame}| sed -n 5p 
+000189b0: 7c20 6772 6570 2022 4341 4e43 454c 4c45  | grep "CANCELLE
+000189c0: 4422 272c 0a20 2020 2020 2020 205d 2c0a  D"',.        ],.
+000189d0: 2020 2020 2020 2020 5f53 504f 545f 4341          _SPOT_CA
+000189e0: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
+000189f0: 286a 6f62 5f6e 616d 653d 6e61 6d65 292c  (job_name=name),
+00018a00: 0a20 2020 2020 2020 2023 2049 6e63 7265  .        # Incre
+00018a10: 6173 6520 7469 6d65 6f75 7420 7369 6e63  ase timeout sinc
+00018a20: 6520 736b 7920 7370 6f74 2071 7565 7565  e sky spot queue
+00018a30: 202d 7220 6361 6e20 6265 2062 6c6f 636b   -r can be block
+00018a40: 6564 2062 7920 6f74 6865 7220 7370 6f74  ed by other spot
+00018a50: 2074 6573 7473 2e0a 2020 2020 2020 2020   tests..        
+00018a60: 7469 6d65 6f75 743d 3330 202a 2036 302c  timeout=30 * 60,
+00018a70: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00018a80: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00018a90: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
+00018aa0: 7469 6e67 206d 616e 6167 6564 2073 706f  ting managed spo
+00018ab0: 7420 7265 636f 7665 7279 202d 2d2d 2d2d  t recovery -----
+00018ac0: 2d2d 2d2d 2d0a 0a0a 4070 7974 6573 742e  -----...@pytest.
+00018ad0: 6d61 726b 2e61 7773 0a40 7079 7465 7374  mark.aws.@pytest
+00018ae0: 2e6d 6172 6b2e 6d61 6e61 6765 645f 7370  .mark.managed_sp
+00018af0: 6f74 0a64 6566 2074 6573 745f 7370 6f74  ot.def test_spot
+00018b00: 5f72 6563 6f76 6572 795f 6177 7328 6177  _recovery_aws(aw
+00018b10: 735f 636f 6e66 6967 5f72 6567 696f 6e29  s_config_region)
+00018b20: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
+00018b30: 6e61 6765 6420 7370 6f74 2072 6563 6f76  naged spot recov
+00018b40: 6572 792e 2222 220a 2020 2020 6e61 6d65  ery.""".    name
+00018b50: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00018b60: 6e61 6d65 2829 0a20 2020 206e 616d 655f  name().    name_
+00018b70: 6f6e 5f63 6c6f 7564 203d 2063 6f6d 6d6f  on_cloud = commo
+00018b80: 6e5f 7574 696c 732e 6d61 6b65 5f63 6c75  n_utils.make_clu
+00018b90: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
+00018ba0: 7564 280a 2020 2020 2020 2020 6e61 6d65  ud(.        name
+00018bb0: 2c20 7370 6f74 2e53 504f 545f 434c 5553  , spot.SPOT_CLUS
+00018bc0: 5445 525f 4e41 4d45 5f50 5245 4649 585f  TER_NAME_PREFIX_
+00018bd0: 4c45 4e47 5448 2c20 6164 645f 7573 6572  LENGTH, add_user
+00018be0: 5f68 6173 683d 4661 6c73 6529 0a20 2020  _hash=False).   
+00018bf0: 2072 6567 696f 6e20 3d20 6177 735f 636f   region = aws_co
+00018c00: 6e66 6967 5f72 6567 696f 6e0a 2020 2020  nfig_region.    
+00018c10: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00018c20: 2020 2020 2027 7370 6f74 5f72 6563 6f76       'spot_recov
+00018c30: 6572 795f 6177 7327 2c0a 2020 2020 2020  ery_aws',.      
+00018c40: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00018c50: 6627 736b 7920 7370 6f74 206c 6175 6e63  f'sky spot launc
+00018c60: 6820 2d2d 636c 6f75 6420 6177 7320 2d2d  h --cloud aws --
+00018c70: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
+00018c80: 2d6e 207b 6e61 6d65 7d20 2265 6368 6f20  -n {name} "echo 
+00018c90: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
+00018ca0: 3a20 5c24 534b 5950 494c 4f54 5f54 4153  : \$SKYPILOT_TAS
+00018cb0: 4b5f 4944 3b20 736c 6565 7020 3138 3030  K_ID; sleep 1800
+00018cc0: 2220 202d 7920 2d64 272c 0a20 2020 2020  "  -y -d',.     
+00018cd0: 2020 2020 2020 2027 736c 6565 7020 3336         'sleep 36
+00018ce0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00018cf0: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+00018d00: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+00018d10: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
+00018d20: 7265 7020 2252 554e 4e49 4e47 2227 2c0a  rep "RUNNING"',.
+00018d30: 2020 2020 2020 2020 2020 2020 6627 5255              f'RU
+00018d40: 4e5f 4944 3d24 2873 6b79 2073 706f 7420  N_ID=$(sky spot 
+00018d50: 6c6f 6773 202d 6e20 7b6e 616d 657d 202d  logs -n {name} -
+00018d60: 2d6e 6f2d 666f 6c6c 6f77 207c 2067 7265  -no-follow | gre
+00018d70: 7020 534b 5950 494c 4f54 5f54 4153 4b5f  p SKYPILOT_TASK_
+00018d80: 4944 207c 2063 7574 202d 643a 202d 6632  ID | cut -d: -f2
+00018d90: 293b 2065 6368 6f20 2224 5255 4e5f 4944  ); echo "$RUN_ID
+00018da0: 2220 7c20 7465 6520 2f74 6d70 2f7b 6e61  " | tee /tmp/{na
+00018db0: 6d65 7d2d 7275 6e2d 6964 272c 0a20 2020  me}-run-id',.   
+00018dc0: 2020 2020 2020 2020 2023 2054 6572 6d69           # Termi
+00018dd0: 6e61 7465 2074 6865 2063 6c75 7374 6572  nate the cluster
+00018de0: 206d 616e 7561 6c6c 792e 0a20 2020 2020   manually..     
+00018df0: 2020 2020 2020 2028 6627 6177 7320 6563         (f'aws ec
+00018e00: 3220 7465 726d 696e 6174 652d 696e 7374  2 terminate-inst
+00018e10: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
+00018e20: 7265 6769 6f6e 7d20 2d2d 696e 7374 616e  region} --instan
+00018e30: 6365 2d69 6473 2024 2827 0a20 2020 2020  ce-ids $('.     
+00018e40: 2020 2020 2020 2020 6627 6177 7320 6563          f'aws ec
+00018e50: 3220 6465 7363 7269 6265 2d69 6e73 7461  2 describe-insta
+00018e60: 6e63 6573 202d 2d72 6567 696f 6e20 7b72  nces --region {r
+00018e70: 6567 696f 6e7d 2027 0a20 2020 2020 2020  egion} '.       
+00018e80: 2020 2020 2020 6627 2d2d 6669 6c74 6572        f'--filter
+00018e90: 7320 4e61 6d65 3d74 6167 3a72 6179 2d63  s Name=tag:ray-c
+00018ea0: 6c75 7374 6572 2d6e 616d 652c 5661 6c75  luster-name,Valu
+00018eb0: 6573 3d7b 6e61 6d65 5f6f 6e5f 636c 6f75  es={name_on_clou
+00018ec0: 647d 2a20 270a 2020 2020 2020 2020 2020  d}* '.          
+00018ed0: 2020 2066 272d 2d71 7565 7279 2052 6573     f'--query Res
+00018ee0: 6572 7661 7469 6f6e 735b 5d2e 496e 7374  ervations[].Inst
+00018ef0: 616e 6365 735b 5d2e 496e 7374 616e 6365  ances[].Instance
+00018f00: 4964 2027 0a20 2020 2020 2020 2020 2020  Id '.           
+00018f10: 2020 272d 2d6f 7574 7075 7420 7465 7874    '--output text
+00018f20: 2927 292c 0a20 2020 2020 2020 2020 2020  )'),.           
+00018f30: 2027 736c 6565 7020 3130 3027 2c0a 2020   'sleep 100',.  
+00018f40: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
+00018f50: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
+00018f60: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
+00018f70: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
+00018f80: 4543 4f56 4552 494e 4722 272c 0a20 2020  ECOVERING"',.   
+00018f90: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00018fa0: 3230 3027 2c0a 2020 2020 2020 2020 2020  200',.          
+00018fb0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+00018fc0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+00018fd0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+00018fe0: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
+00018ff0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00019000: 5255 4e5f 4944 3d24 2863 6174 202f 746d  RUN_ID=$(cat /tm
+00019010: 702f 7b6e 616d 657d 2d72 756e 2d69 6429  p/{name}-run-id)
+00019020: 3b20 6563 686f 2024 5255 4e5f 4944 3b20  ; echo $RUN_ID; 
+00019030: 736b 7920 7370 6f74 206c 6f67 7320 2d6e  sky spot logs -n
+00019040: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
+00019050: 6c6f 7720 7c20 6772 6570 2053 4b59 5049  low | grep SKYPI
+00019060: 4c4f 545f 5441 534b 5f49 4420 7c20 6772  LOT_TASK_ID | gr
+00019070: 6570 2022 2452 554e 5f49 4422 272c 0a20  ep "$RUN_ID"',. 
+00019080: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00019090: 2020 5f53 504f 545f 4341 4e43 454c 5f57    _SPOT_CANCEL_W
+000190a0: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
+000190b0: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
+000190c0: 2020 2074 696d 656f 7574 3d32 3520 2a20     timeout=25 * 
+000190d0: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
+000190e0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+000190f0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00019100: 6763 700a 4070 7974 6573 742e 6d61 726b  gcp.@pytest.mark
+00019110: 2e6d 616e 6167 6564 5f73 706f 740a 6465  .managed_spot.de
+00019120: 6620 7465 7374 5f73 706f 745f 7265 636f  f test_spot_reco
+00019130: 7665 7279 5f67 6370 2829 3a0a 2020 2020  very_gcp():.    
+00019140: 2222 2254 6573 7420 6d61 6e61 6765 6420  """Test managed 
+00019150: 7370 6f74 2072 6563 6f76 6572 792e 2222  spot recovery.""
+00019160: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
+00019170: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00019180: 0a20 2020 206e 616d 655f 6f6e 5f63 6c6f  .    name_on_clo
+00019190: 7564 203d 2063 6f6d 6d6f 6e5f 7574 696c  ud = common_util
+000191a0: 732e 6d61 6b65 5f63 6c75 7374 6572 5f6e  s.make_cluster_n
+000191b0: 616d 655f 6f6e 5f63 6c6f 7564 280a 2020  ame_on_cloud(.  
+000191c0: 2020 2020 2020 6e61 6d65 2c20 7370 6f74        name, spot
+000191d0: 2e53 504f 545f 434c 5553 5445 525f 4e41  .SPOT_CLUSTER_NA
+000191e0: 4d45 5f50 5245 4649 585f 4c45 4e47 5448  ME_PREFIX_LENGTH
+000191f0: 2c20 6164 645f 7573 6572 5f68 6173 683d  , add_user_hash=
+00019200: 4661 6c73 6529 0a20 2020 207a 6f6e 6520  False).    zone 
+00019210: 3d20 2775 732d 6561 7374 342d 6227 0a20  = 'us-east4-b'. 
+00019220: 2020 2071 7565 7279 5f63 6d64 203d 2028     query_cmd = (
+00019230: 0a20 2020 2020 2020 2066 2767 636c 6f75  .        f'gclou
+00019240: 6420 636f 6d70 7574 6520 696e 7374 616e  d compute instan
+00019250: 6365 7320 6c69 7374 202d 2d66 696c 7465  ces list --filte
+00019260: 723d 270a 2020 2020 2020 2020 2320 603a  r='.        # `:
+00019270: 6020 6d65 616e 7320 7072 6566 6978 206d  ` means prefix m
+00019280: 6174 6368 2e0a 2020 2020 2020 2020 6627  atch..        f'
+00019290: 2228 6c61 6265 6c73 2e72 6179 2d63 6c75  "(labels.ray-clu
+000192a0: 7374 6572 2d6e 616d 653a 7b6e 616d 655f  ster-name:{name_
+000192b0: 6f6e 5f63 6c6f 7564 7d29 2220 270a 2020  on_cloud})" '.  
+000192c0: 2020 2020 2020 6627 2d2d 7a6f 6e65 733d        f'--zones=
+000192d0: 7b7a 6f6e 657d 202d 2d66 6f72 6d61 743d  {zone} --format=
+000192e0: 2276 616c 7565 286e 616d 6529 2227 290a  "value(name)"').
+000192f0: 2020 2020 7465 726d 696e 6174 655f 636d      terminate_cm
+00019300: 6420 3d20 2866 2767 636c 6f75 6420 636f  d = (f'gcloud co
+00019310: 6d70 7574 6520 696e 7374 616e 6365 7320  mpute instances 
+00019320: 6465 6c65 7465 202d 2d7a 6f6e 653d 7b7a  delete --zone={z
+00019330: 6f6e 657d 270a 2020 2020 2020 2020 2020  one}'.          
+00019340: 2020 2020 2020 2020 2020 2066 2720 2d2d             f' --
+00019350: 7175 6965 7420 2428 7b71 7565 7279 5f63  quiet $({query_c
+00019360: 6d64 7d29 2729 0a20 2020 2074 6573 7420  md})').    test 
+00019370: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00019380: 2773 706f 745f 7265 636f 7665 7279 5f67  'spot_recovery_g
+00019390: 6370 272c 0a20 2020 2020 2020 205b 0a20  cp',.        [. 
+000193a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000193b0: 2073 706f 7420 6c61 756e 6368 202d 2d63   spot launch --c
+000193c0: 6c6f 7564 2067 6370 202d 2d7a 6f6e 6520  loud gcp --zone 
+000193d0: 7b7a 6f6e 657d 202d 6e20 7b6e 616d 657d  {zone} -n {name}
+000193e0: 202d 2d63 7075 7320 3220 2265 6368 6f20   --cpus 2 "echo 
+000193f0: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
+00019400: 3a20 5c24 534b 5950 494c 4f54 5f54 4153  : \$SKYPILOT_TAS
+00019410: 4b5f 4944 3b20 736c 6565 7020 3138 3030  K_ID; sleep 1800
+00019420: 2220 202d 7920 2d64 272c 0a20 2020 2020  "  -y -d',.     
+00019430: 2020 2020 2020 2027 736c 6565 7020 3336         'sleep 36
+00019440: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00019450: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+00019460: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+00019470: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
+00019480: 7265 7020 2252 554e 4e49 4e47 2227 2c0a  rep "RUNNING"',.
+00019490: 2020 2020 2020 2020 2020 2020 6627 5255              f'RU
+000194a0: 4e5f 4944 3d24 2873 6b79 2073 706f 7420  N_ID=$(sky spot 
+000194b0: 6c6f 6773 202d 6e20 7b6e 616d 657d 202d  logs -n {name} -
+000194c0: 2d6e 6f2d 666f 6c6c 6f77 207c 2067 7265  -no-follow | gre
+000194d0: 7020 534b 5950 494c 4f54 5f54 4153 4b5f  p SKYPILOT_TASK_
+000194e0: 4944 207c 2063 7574 202d 643a 202d 6632  ID | cut -d: -f2
+000194f0: 293b 2065 6368 6f20 2224 5255 4e5f 4944  ); echo "$RUN_ID
+00019500: 2220 7c20 7465 6520 2f74 6d70 2f7b 6e61  " | tee /tmp/{na
+00019510: 6d65 7d2d 7275 6e2d 6964 272c 0a20 2020  me}-run-id',.   
+00019520: 2020 2020 2020 2020 2023 2054 6572 6d69           # Termi
+00019530: 6e61 7465 2074 6865 2063 6c75 7374 6572  nate the cluster
+00019540: 206d 616e 7561 6c6c 792e 0a20 2020 2020   manually..     
+00019550: 2020 2020 2020 2074 6572 6d69 6e61 7465         terminate
+00019560: 5f63 6d64 2c0a 2020 2020 2020 2020 2020  _cmd,.          
+00019570: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
+00019580: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
+00019590: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
+000195a0: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
+000195b0: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
+000195c0: 4543 4f56 4552 494e 4722 272c 0a20 2020  ECOVERING"',.   
+000195d0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+000195e0: 3230 3027 2c0a 2020 2020 2020 2020 2020  200',.          
+000195f0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+00019600: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+00019610: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+00019620: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
+00019630: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00019640: 5255 4e5f 4944 3d24 2863 6174 202f 746d  RUN_ID=$(cat /tm
+00019650: 702f 7b6e 616d 657d 2d72 756e 2d69 6429  p/{name}-run-id)
+00019660: 3b20 6563 686f 2024 5255 4e5f 4944 3b20  ; echo $RUN_ID; 
+00019670: 736b 7920 7370 6f74 206c 6f67 7320 2d6e  sky spot logs -n
+00019680: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
+00019690: 6c6f 7720 7c20 6772 6570 2053 4b59 5049  low | grep SKYPI
+000196a0: 4c4f 545f 5441 534b 5f49 443a 207c 2067  LOT_TASK_ID: | g
+000196b0: 7265 7020 2224 5255 4e5f 4944 2227 2c0a  rep "$RUN_ID"',.
+000196c0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+000196d0: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
+000196e0: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
+000196f0: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
+00019700: 2020 2020 7469 6d65 6f75 743d 3235 202a      timeout=25 *
+00019710: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+00019720: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00019730: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+00019740: 2e61 7773 0a40 7079 7465 7374 2e6d 6172  .aws.@pytest.mar
+00019750: 6b2e 6d61 6e61 6765 645f 7370 6f74 0a64  k.managed_spot.d
+00019760: 6566 2074 6573 745f 7370 6f74 5f70 6970  ef test_spot_pip
+00019770: 656c 696e 655f 7265 636f 7665 7279 5f61  eline_recovery_a
+00019780: 7773 2861 7773 5f63 6f6e 6669 675f 7265  ws(aws_config_re
+00019790: 6769 6f6e 293a 0a20 2020 2022 2222 5465  gion):.    """Te
+000197a0: 7374 206d 616e 6167 6564 2073 706f 7420  st managed spot 
+000197b0: 7265 636f 7665 7279 2066 6f72 2061 2070  recovery for a p
+000197c0: 6970 656c 696e 652e 2222 220a 2020 2020  ipeline.""".    
+000197d0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+000197e0: 7465 725f 6e61 6d65 2829 0a20 2020 2075  ter_name().    u
+000197f0: 7365 725f 6861 7368 203d 2063 6f6d 6d6f  ser_hash = commo
+00019800: 6e5f 7574 696c 732e 6765 745f 7573 6572  n_utils.get_user
+00019810: 5f68 6173 6828 290a 2020 2020 7573 6572  _hash().    user
+00019820: 5f68 6173 6820 3d20 7573 6572 5f68 6173  _hash = user_has
+00019830: 685b 3a63 6f6d 6d6f 6e5f 7574 696c 732e  h[:common_utils.
+00019840: 5553 4552 5f48 4153 485f 4c45 4e47 5448  USER_HASH_LENGTH
+00019850: 5f49 4e5f 434c 5553 5445 525f 4e41 4d45  _IN_CLUSTER_NAME
+00019860: 5d0a 2020 2020 7265 6769 6f6e 203d 2061  ].    region = a
+00019870: 7773 5f63 6f6e 6669 675f 7265 6769 6f6e  ws_config_region
+00019880: 0a20 2020 2069 6620 7265 6769 6f6e 2021  .    if region !
+00019890: 3d20 2775 732d 6561 7374 2d32 273a 0a20  = 'us-east-2':. 
+000198a0: 2020 2020 2020 2070 7974 6573 742e 736b         pytest.sk
+000198b0: 6970 2827 4f6e 6c79 2072 756e 2073 706f  ip('Only run spo
+000198c0: 7420 7069 7065 6c69 6e65 2072 6563 6f76  t pipeline recov
+000198d0: 6572 7920 7465 7374 2069 6e20 7573 2d65  ery test in us-e
+000198e0: 6173 742d 3227 290a 2020 2020 7465 7374  ast-2').    test
+000198f0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00019900: 2027 7370 6f74 5f70 6970 656c 696e 655f   'spot_pipeline_
+00019910: 7265 636f 7665 7279 5f61 7773 272c 0a20  recovery_aws',. 
+00019920: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00019930: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
+00019940: 6c61 756e 6368 202d 6e20 7b6e 616d 657d  launch -n {name}
+00019950: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+00019960: 732f 7069 7065 6c69 6e65 5f61 7773 2e79  s/pipeline_aws.y
+00019970: 616d 6c20 202d 7920 2d64 272c 0a20 2020  aml  -y -d',.   
+00019980: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00019990: 3430 3027 2c0a 2020 2020 2020 2020 2020  400',.          
+000199a0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+000199b0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+000199c0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+000199d0: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
+000199e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000199f0: 5255 4e5f 4944 3d24 2873 6b79 2073 706f  RUN_ID=$(sky spo
+00019a00: 7420 6c6f 6773 202d 6e20 7b6e 616d 657d  t logs -n {name}
+00019a10: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
+00019a20: 7265 7020 534b 5950 494c 4f54 5f54 4153  rep SKYPILOT_TAS
+00019a30: 4b5f 4944 3a20 7c20 6375 7420 2d64 3a20  K_ID: | cut -d: 
+00019a40: 2d66 3229 3b20 6563 686f 2022 2452 554e  -f2); echo "$RUN
+00019a50: 5f49 4422 207c 2074 6565 202f 746d 702f  _ID" | tee /tmp/
+00019a60: 7b6e 616d 657d 2d72 756e 2d69 6427 2c0a  {name}-run-id',.
+00019a70: 2020 2020 2020 2020 2020 2020 6627 5255              f'RU
+00019a80: 4e5f 4944 533d 2428 736b 7920 7370 6f74  N_IDS=$(sky spot
+00019a90: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
+00019aa0: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
+00019ab0: 6570 202d 4120 3420 534b 5950 494c 4f54  ep -A 4 SKYPILOT
+00019ac0: 5f54 4153 4b5f 4944 5320 7c20 6375 7420  _TASK_IDS | cut 
+00019ad0: 2d64 2229 2220 2d66 3229 3b20 6563 686f  -d")" -f2); echo
+00019ae0: 2022 2452 554e 5f49 4453 2220 7c20 7465   "$RUN_IDS" | te
+00019af0: 6520 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  e /tmp/{name}-ru
+00019b00: 6e2d 6964 7327 2c0a 2020 2020 2020 2020  n-ids',.        
+00019b10: 2020 2020 2320 5465 726d 696e 6174 6520      # Terminate 
+00019b20: 7468 6520 636c 7573 7465 7220 6d61 6e75  the cluster manu
+00019b30: 616c 6c79 2e0a 2020 2020 2020 2020 2020  ally..          
+00019b40: 2020 2320 5468 6520 6063 6174 202e 2e2e    # The `cat ...
+00019b50: 7c20 7265 7660 2069 7320 746f 2072 6574  | rev` is to ret
+00019b60: 7269 6576 6520 7468 6520 6a6f 625f 6964  rieve the job_id
+00019b70: 2066 726f 6d20 7468 650a 2020 2020 2020   from the.      
+00019b80: 2020 2020 2020 2320 534b 5950 494c 4f54        # SKYPILOT
+00019b90: 5f54 4153 4b5f 4944 2c20 7768 6963 6820  _TASK_ID, which 
+00019ba0: 6765 7473 2074 6865 2073 6563 6f6e 6420  gets the second 
+00019bb0: 746f 206c 6173 7420 6669 656c 640a 2020  to last field.  
+00019bc0: 2020 2020 2020 2020 2020 2320 7365 7061            # sepa
+00019bd0: 7261 7465 6420 6279 2060 2d60 2e0a 2020  rated by `-`..  
+00019be0: 2020 2020 2020 2020 2020 280a 2020 2020            (.    
+00019bf0: 2020 2020 2020 2020 2020 2020 6627 5350              f'SP
+00019c00: 4f54 5f4a 4f42 5f49 443d 6063 6174 202f  OT_JOB_ID=`cat /
+00019c10: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
+00019c20: 6420 7c20 7265 7620 7c20 270a 2020 2020  d | rev | '.    
+00019c30: 2020 2020 2020 2020 2020 2020 2763 7574              'cut
+00019c40: 202d 645c 275f 5c27 202d 6631 207c 2072   -d\'_\' -f1 | r
+00019c50: 6576 207c 2063 7574 202d 645c 272d 5c27  ev | cut -d\'-\'
+00019c60: 202d 6631 603b 270a 2020 2020 2020 2020   -f1`;'.        
+00019c70: 2020 2020 2020 2020 6627 6177 7320 6563          f'aws ec
+00019c80: 3220 7465 726d 696e 6174 652d 696e 7374  2 terminate-inst
+00019c90: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
+00019ca0: 7265 6769 6f6e 7d20 2d2d 696e 7374 616e  region} --instan
+00019cb0: 6365 2d69 6473 2024 2827 0a20 2020 2020  ce-ids $('.     
+00019cc0: 2020 2020 2020 2020 2020 2066 2761 7773             f'aws
+00019cd0: 2065 6332 2064 6573 6372 6962 652d 696e   ec2 describe-in
+00019ce0: 7374 616e 6365 7320 2d2d 7265 6769 6f6e  stances --region
+00019cf0: 207b 7265 6769 6f6e 7d20 270a 2020 2020   {region} '.    
+00019d00: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
+00019d10: 444f 287a 6877 7529 3a20 6669 7820 7468  DO(zhwu): fix th
+00019d20: 6520 6e61 6d65 2066 6f72 2073 706f 7420  e name for spot 
+00019d30: 636c 7573 7465 722e 0a20 2020 2020 2020  cluster..       
+00019d40: 2020 2020 2020 2020 2027 2d2d 6669 6c74           '--filt
+00019d50: 6572 7320 4e61 6d65 3d74 6167 3a72 6179  ers Name=tag:ray
+00019d60: 2d63 6c75 7374 6572 2d6e 616d 652c 5661  -cluster-name,Va
+00019d70: 6c75 6573 3d2a 2d24 7b53 504f 545f 4a4f  lues=*-${SPOT_JO
+00019d80: 425f 4944 7d27 0a20 2020 2020 2020 2020  B_ID}'.         
+00019d90: 2020 2020 2020 2066 272d 7b75 7365 725f         f'-{user_
+00019da0: 6861 7368 7d20 270a 2020 2020 2020 2020  hash} '.        
+00019db0: 2020 2020 2020 2020 6627 2d2d 7175 6572          f'--quer
+00019dc0: 7920 5265 7365 7276 6174 696f 6e73 5b5d  y Reservations[]
+00019dd0: 2e49 6e73 7461 6e63 6573 5b5d 2e49 6e73  .Instances[].Ins
+00019de0: 7461 6e63 6549 6420 270a 2020 2020 2020  tanceId '.      
+00019df0: 2020 2020 2020 2020 2020 272d 2d6f 7574            '--out
+00019e00: 7075 7420 7465 7874 2927 292c 0a20 2020  put text)'),.   
+00019e10: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00019e20: 3130 3027 2c0a 2020 2020 2020 2020 2020  100',.          
+00019e30: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+00019e40: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+00019e50: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+00019e60: 2067 7265 7020 2252 4543 4f56 4552 494e   grep "RECOVERIN
+00019e70: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+00019e80: 2027 736c 6565 7020 3230 3027 2c0a 2020   'sleep 200',.  
+00019e90: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
+00019ea0: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
+00019eb0: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
+00019ec0: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
+00019ed0: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
+00019ee0: 2020 2020 2020 6627 5255 4e5f 4944 3d24        f'RUN_ID=$
+00019ef0: 2863 6174 202f 746d 702f 7b6e 616d 657d  (cat /tmp/{name}
+00019f00: 2d72 756e 2d69 6429 3b20 6563 686f 2024  -run-id); echo $
+00019f10: 5255 4e5f 4944 3b20 736b 7920 7370 6f74  RUN_ID; sky spot
+00019f20: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
+00019f30: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
+00019f40: 6570 2053 4b59 5049 4c4f 545f 5441 534b  ep SKYPILOT_TASK
+00019f50: 5f49 443a 207c 2067 7265 7020 2224 5255  _ID: | grep "$RU
+00019f60: 4e5f 4944 2227 2c0a 2020 2020 2020 2020  N_ID"',.        
+00019f70: 2020 2020 6627 5255 4e5f 4944 533d 2428      f'RUN_IDS=$(
+00019f80: 736b 7920 7370 6f74 206c 6f67 7320 2d6e  sky spot logs -n
+00019f90: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
+00019fa0: 6c6f 7720 7c20 6772 6570 202d 4120 3420  low | grep -A 4 
+00019fb0: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
+00019fc0: 5320 7c20 6375 7420 2d64 2229 2220 2d66  S | cut -d")" -f
+00019fd0: 3229 3b20 6563 686f 2022 2452 554e 5f49  2); echo "$RUN_I
+00019fe0: 4453 2220 7c20 7465 6520 2f74 6d70 2f7b  DS" | tee /tmp/{
+00019ff0: 6e61 6d65 7d2d 7275 6e2d 6964 732d 6e65  name}-run-ids-ne
+0001a000: 7727 2c0a 2020 2020 2020 2020 2020 2020  w',.            
+0001a010: 6627 6469 6666 202f 746d 702f 7b6e 616d  f'diff /tmp/{nam
+0001a020: 657d 2d72 756e 2d69 6473 202f 746d 702f  e}-run-ids /tmp/
+0001a030: 7b6e 616d 657d 2d72 756e 2d69 6473 2d6e  {name}-run-ids-n
+0001a040: 6577 272c 0a20 2020 2020 2020 2020 2020  ew',.           
+0001a050: 2066 2763 6174 202f 746d 702f 7b6e 616d   f'cat /tmp/{nam
+0001a060: 657d 2d72 756e 2d69 6473 207c 2073 6564  e}-run-ids | sed
+0001a070: 202d 6e20 3270 207c 2067 7265 7020 6063   -n 2p | grep `c
+0001a080: 6174 202f 746d 702f 7b6e 616d 657d 2d72  at /tmp/{name}-r
+0001a090: 756e 2d69 6460 272c 0a20 2020 2020 2020  un-id`',.       
+0001a0a0: 205d 2c0a 2020 2020 2020 2020 5f53 504f   ],.        _SPO
+0001a0b0: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
+0001a0c0: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
+0001a0d0: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
+0001a0e0: 656f 7574 3d32 3520 2a20 3630 2c0a 2020  eout=25 * 60,.  
+0001a0f0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+0001a100: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+0001a110: 7465 7374 2e6d 6172 6b2e 6763 700a 4070  test.mark.gcp.@p
+0001a120: 7974 6573 742e 6d61 726b 2e6d 616e 6167  ytest.mark.manag
+0001a130: 6564 5f73 706f 740a 6465 6620 7465 7374  ed_spot.def test
+0001a140: 5f73 706f 745f 7069 7065 6c69 6e65 5f72  _spot_pipeline_r
+0001a150: 6563 6f76 6572 795f 6763 7028 293a 0a20  ecovery_gcp():. 
+0001a160: 2020 2022 2222 5465 7374 206d 616e 6167     """Test manag
+0001a170: 6564 2073 706f 7420 7265 636f 7665 7279  ed spot recovery
+0001a180: 2066 6f72 2061 2070 6970 656c 696e 652e   for a pipeline.
+0001a190: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
+0001a1a0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+0001a1b0: 2829 0a20 2020 207a 6f6e 6520 3d20 2775  ().    zone = 'u
+0001a1c0: 732d 6561 7374 342d 6227 0a20 2020 2075  s-east4-b'.    u
+0001a1d0: 7365 725f 6861 7368 203d 2063 6f6d 6d6f  ser_hash = commo
+0001a1e0: 6e5f 7574 696c 732e 6765 745f 7573 6572  n_utils.get_user
+0001a1f0: 5f68 6173 6828 290a 2020 2020 7573 6572  _hash().    user
+0001a200: 5f68 6173 6820 3d20 7573 6572 5f68 6173  _hash = user_has
+0001a210: 685b 3a63 6f6d 6d6f 6e5f 7574 696c 732e  h[:common_utils.
+0001a220: 5553 4552 5f48 4153 485f 4c45 4e47 5448  USER_HASH_LENGTH
+0001a230: 5f49 4e5f 434c 5553 5445 525f 4e41 4d45  _IN_CLUSTER_NAME
+0001a240: 5d0a 2020 2020 7175 6572 795f 636d 6420  ].    query_cmd 
+0001a250: 3d20 2827 6763 6c6f 7564 2063 6f6d 7075  = ('gcloud compu
+0001a260: 7465 2069 6e73 7461 6e63 6573 206c 6973  te instances lis
+0001a270: 7420 2d2d 6669 6c74 6572 3d27 0a20 2020  t --filter='.   
+0001a280: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0001a290: 2228 6c61 6265 6c73 2e72 6179 2d63 6c75  "(labels.ray-clu
+0001a2a0: 7374 6572 2d6e 616d 653a 2a2d 247b 7b53  ster-name:*-${{S
+0001a2b0: 504f 545f 4a4f 425f 4944 7d7d 2d7b 7573  POT_JOB_ID}}-{us
+0001a2c0: 6572 5f68 6173 687d 2922 2027 0a20 2020  er_hash})" '.   
+0001a2d0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0001a2e0: 2d2d 7a6f 6e65 733d 7b7a 6f6e 657d 202d  --zones={zone} -
+0001a2f0: 2d66 6f72 6d61 743d 2276 616c 7565 286e  -format="value(n
+0001a300: 616d 6529 2227 290a 2020 2020 7465 726d  ame)"').    term
+0001a310: 696e 6174 655f 636d 6420 3d20 2866 2767  inate_cmd = (f'g
+0001a320: 636c 6f75 6420 636f 6d70 7574 6520 696e  cloud compute in
+0001a330: 7374 616e 6365 7320 6465 6c65 7465 202d  stances delete -
+0001a340: 2d7a 6f6e 653d 7b7a 6f6e 657d 270a 2020  -zone={zone}'.  
+0001a350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a360: 2020 2066 2720 2d2d 7175 6965 7420 2428     f' --quiet $(
+0001a370: 7b71 7565 7279 5f63 6d64 7d29 2729 0a20  {query_cmd})'). 
+0001a380: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+0001a390: 2020 2020 2020 2020 2773 706f 745f 7069          'spot_pi
+0001a3a0: 7065 6c69 6e65 5f72 6563 6f76 6572 795f  peline_recovery_
+0001a3b0: 6763 7027 2c0a 2020 2020 2020 2020 5b0a  gcp',.        [.
+0001a3c0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0001a3d0: 7920 7370 6f74 206c 6175 6e63 6820 2d6e  y spot launch -n
+0001a3e0: 207b 6e61 6d65 7d20 7465 7374 732f 7465   {name} tests/te
+0001a3f0: 7374 5f79 616d 6c73 2f70 6970 656c 696e  st_yamls/pipelin
+0001a400: 655f 6763 702e 7961 6d6c 2020 2d79 202d  e_gcp.yaml  -y -
+0001a410: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
+0001a420: 2773 6c65 6570 2034 3030 272c 0a20 2020  'sleep 400',.   
+0001a430: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
+0001a440: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
+0001a450: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
+0001a460: 6420 2d6e 3120 7c20 6772 6570 2022 5255  d -n1 | grep "RU
+0001a470: 4e4e 494e 4722 272c 0a20 2020 2020 2020  NNING"',.       
+0001a480: 2020 2020 2066 2752 554e 5f49 443d 2428       f'RUN_ID=$(
+0001a490: 736b 7920 7370 6f74 206c 6f67 7320 2d6e  sky spot logs -n
+0001a4a0: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
+0001a4b0: 6c6f 7720 7c20 6772 6570 2053 4b59 5049  low | grep SKYPI
+0001a4c0: 4c4f 545f 5441 534b 5f49 443a 207c 2063  LOT_TASK_ID: | c
+0001a4d0: 7574 202d 643a 202d 6632 293b 2065 6368  ut -d: -f2); ech
+0001a4e0: 6f20 2224 5255 4e5f 4944 2220 7c20 7465  o "$RUN_ID" | te
+0001a4f0: 6520 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  e /tmp/{name}-ru
+0001a500: 6e2d 6964 272c 0a20 2020 2020 2020 2020  n-id',.         
+0001a510: 2020 2066 2752 554e 5f49 4453 3d24 2873     f'RUN_IDS=$(s
+0001a520: 6b79 2073 706f 7420 6c6f 6773 202d 6e20  ky spot logs -n 
+0001a530: 7b6e 616d 657d 202d 2d6e 6f2d 666f 6c6c  {name} --no-foll
+0001a540: 6f77 207c 2067 7265 7020 2d41 2034 2053  ow | grep -A 4 S
+0001a550: 4b59 5049 4c4f 545f 5441 534b 5f49 4453  KYPILOT_TASK_IDS
+0001a560: 207c 2063 7574 202d 6422 2922 202d 6632   | cut -d")" -f2
+0001a570: 293b 2065 6368 6f20 2224 5255 4e5f 4944  ); echo "$RUN_ID
+0001a580: 5322 207c 2074 6565 202f 746d 702f 7b6e  S" | tee /tmp/{n
+0001a590: 616d 657d 2d72 756e 2d69 6473 272c 0a20  ame}-run-ids',. 
+0001a5a0: 2020 2020 2020 2020 2020 2023 2054 6572             # Ter
+0001a5b0: 6d69 6e61 7465 2074 6865 2063 6c75 7374  minate the clust
+0001a5c0: 6572 206d 616e 7561 6c6c 792e 0a20 2020  er manually..   
+0001a5d0: 2020 2020 2020 2020 2023 2054 6865 2060           # The `
+0001a5e0: 6361 7420 2e2e 2e7c 2072 6576 6020 6973  cat ...| rev` is
+0001a5f0: 2074 6f20 7265 7472 6965 7665 2074 6865   to retrieve the
+0001a600: 206a 6f62 5f69 6420 6672 6f6d 2074 6865   job_id from the
+0001a610: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
+0001a620: 4b59 5049 4c4f 545f 5441 534b 5f49 442c  KYPILOT_TASK_ID,
+0001a630: 2077 6869 6368 2067 6574 7320 7468 6520   which gets the 
+0001a640: 7365 636f 6e64 2074 6f20 6c61 7374 2066  second to last f
+0001a650: 6965 6c64 0a20 2020 2020 2020 2020 2020  ield.           
+0001a660: 2023 2073 6570 6172 6174 6564 2062 7920   # separated by 
+0001a670: 602d 602e 0a20 2020 2020 2020 2020 2020  `-`..           
+0001a680: 2028 6627 5350 4f54 5f4a 4f42 5f49 443d   (f'SPOT_JOB_ID=
+0001a690: 6063 6174 202f 746d 702f 7b6e 616d 657d  `cat /tmp/{name}
+0001a6a0: 2d72 756e 2d69 6420 7c20 7265 7620 7c20  -run-id | rev | 
+0001a6b0: 270a 2020 2020 2020 2020 2020 2020 2066  '.             f
+0001a6c0: 2763 7574 202d 645c 275f 5c27 202d 6631  'cut -d\'_\' -f1
+0001a6d0: 207c 2072 6576 207c 2063 7574 202d 645c   | rev | cut -d\
+0001a6e0: 272d 5c27 202d 6631 603b 207b 7465 726d  '-\' -f1`; {term
+0001a6f0: 696e 6174 655f 636d 647d 2729 2c0a 2020  inate_cmd}'),.  
+0001a700: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001a710: 2036 3027 2c0a 2020 2020 2020 2020 2020   60',.          
+0001a720: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+0001a730: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+0001a740: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+0001a750: 2067 7265 7020 2252 4543 4f56 4552 494e   grep "RECOVERIN
+0001a760: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+0001a770: 2027 736c 6565 7020 3230 3027 2c0a 2020   'sleep 200',.  
+0001a780: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
+0001a790: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
+0001a7a0: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
+0001a7b0: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
+0001a7c0: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
+0001a7d0: 2020 2020 2020 6627 5255 4e5f 4944 3d24        f'RUN_ID=$
+0001a7e0: 2863 6174 202f 746d 702f 7b6e 616d 657d  (cat /tmp/{name}
+0001a7f0: 2d72 756e 2d69 6429 3b20 6563 686f 2024  -run-id); echo $
+0001a800: 5255 4e5f 4944 3b20 736b 7920 7370 6f74  RUN_ID; sky spot
+0001a810: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
+0001a820: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
+0001a830: 6570 2053 4b59 5049 4c4f 545f 5441 534b  ep SKYPILOT_TASK
+0001a840: 5f49 443a 207c 2067 7265 7020 2224 5255  _ID: | grep "$RU
+0001a850: 4e5f 4944 2227 2c0a 2020 2020 2020 2020  N_ID"',.        
+0001a860: 2020 2020 6627 5255 4e5f 4944 533d 2428      f'RUN_IDS=$(
+0001a870: 736b 7920 7370 6f74 206c 6f67 7320 2d6e  sky spot logs -n
+0001a880: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
+0001a890: 6c6f 7720 7c20 6772 6570 202d 4120 3420  low | grep -A 4 
+0001a8a0: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
+0001a8b0: 5320 7c20 6375 7420 2d64 2229 2220 2d66  S | cut -d")" -f
+0001a8c0: 3229 3b20 6563 686f 2022 2452 554e 5f49  2); echo "$RUN_I
+0001a8d0: 4453 2220 7c20 7465 6520 2f74 6d70 2f7b  DS" | tee /tmp/{
+0001a8e0: 6e61 6d65 7d2d 7275 6e2d 6964 732d 6e65  name}-run-ids-ne
+0001a8f0: 7727 2c0a 2020 2020 2020 2020 2020 2020  w',.            
+0001a900: 6627 6469 6666 202f 746d 702f 7b6e 616d  f'diff /tmp/{nam
+0001a910: 657d 2d72 756e 2d69 6473 202f 746d 702f  e}-run-ids /tmp/
+0001a920: 7b6e 616d 657d 2d72 756e 2d69 6473 2d6e  {name}-run-ids-n
+0001a930: 6577 272c 0a20 2020 2020 2020 2020 2020  ew',.           
+0001a940: 2066 2763 6174 202f 746d 702f 7b6e 616d   f'cat /tmp/{nam
+0001a950: 657d 2d72 756e 2d69 6473 207c 2073 6564  e}-run-ids | sed
+0001a960: 202d 6e20 3270 207c 2067 7265 7020 6063   -n 2p | grep `c
+0001a970: 6174 202f 746d 702f 7b6e 616d 657d 2d72  at /tmp/{name}-r
+0001a980: 756e 2d69 6460 272c 0a20 2020 2020 2020  un-id`',.       
+0001a990: 205d 2c0a 2020 2020 2020 2020 5f53 504f   ],.        _SPO
+0001a9a0: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
+0001a9b0: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
+0001a9c0: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
+0001a9d0: 656f 7574 3d32 3520 2a20 3630 2c0a 2020  eout=25 * 60,.  
+0001a9e0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+0001a9f0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+0001aa00: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
+0001aa10: 6964 7374 6163 6b20 2023 2046 6c75 6964  idstack  # Fluid
+0001aa20: 7374 6163 6b20 646f 6573 206e 6f74 2073  stack does not s
+0001aa30: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+0001aa40: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+0001aa50: 726b 2e6e 6f5f 617a 7572 6520 2023 2041  rk.no_azure  # A
+0001aa60: 7a75 7265 2064 6f65 7320 6e6f 7420 7375  zure does not su
+0001aa70: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+0001aa80: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+0001aa90: 6b2e 6e6f 5f6c 616d 6264 615f 636c 6f75  k.no_lambda_clou
+0001aaa0: 6420 2023 204c 616d 6264 6120 436c 6f75  d  # Lambda Clou
+0001aab0: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
+0001aac0: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
+0001aad0: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
+0001aae0: 6f5f 6962 6d20 2023 2049 424d 2043 6c6f  o_ibm  # IBM Clo
+0001aaf0: 7564 2064 6f65 7320 6e6f 7420 7375 7070  ud does not supp
+0001ab00: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
+0001ab10: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
+0001ab20: 6e6f 5f73 6370 2020 2320 5343 5020 646f  no_scp  # SCP do
+0001ab30: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
+0001ab40: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
+0001ab50: 7974 6573 742e 6d61 726b 2e6e 6f5f 7061  ytest.mark.no_pa
+0001ab60: 7065 7273 7061 6365 2020 2320 5061 7065  perspace  # Pape
+0001ab70: 7273 7061 6365 2064 6f65 7320 6e6f 7420  rspace does not 
+0001ab80: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
+0001ab90: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+0001aba0: 6172 6b2e 6e6f 5f6b 7562 6572 6e65 7465  ark.no_kubernete
+0001abb0: 7320 2023 204b 7562 6572 6e65 7465 7320  s  # Kubernetes 
+0001abc0: 646f 6573 206e 6f74 2068 6176 6520 6120  does not have a 
+0001abd0: 6e6f 7469 6f6e 206f 6620 7370 6f74 2069  notion of spot i
+0001abe0: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
+0001abf0: 2e6d 6172 6b2e 6d61 6e61 6765 645f 7370  .mark.managed_sp
+0001ac00: 6f74 0a64 6566 2074 6573 745f 7370 6f74  ot.def test_spot
+0001ac10: 5f72 6563 6f76 6572 795f 6465 6661 756c  _recovery_defaul
+0001ac20: 745f 7265 736f 7572 6365 7328 6765 6e65  t_resources(gene
+0001ac30: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
+0001ac40: 0a20 2020 2022 2222 5465 7374 206d 616e  .    """Test man
+0001ac50: 6167 6564 2073 706f 7420 7265 636f 7665  aged spot recove
+0001ac60: 7279 2066 6f72 2064 6566 6175 6c74 2072  ry for default r
+0001ac70: 6573 6f75 7263 6573 2e22 2222 0a20 2020  esources.""".   
+0001ac80: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+0001ac90: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+0001aca0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+0001acb0: 2020 2020 2027 6d61 6e61 6765 642d 7370       'managed-sp
+0001acc0: 6f74 2d72 6563 6f76 6572 792d 6465 6661  ot-recovery-defa
+0001acd0: 756c 742d 7265 736f 7572 6365 7327 2c0a  ult-resources',.
+0001ace0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+0001acf0: 2020 2020 2020 6627 736b 7920 7370 6f74        f'sky spot
+0001ad00: 206c 6175 6e63 6820 2d6e 207b 6e61 6d65   launch -n {name
+0001ad10: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+0001ad20: 6963 5f63 6c6f 7564 7d20 2273 6c65 6570  ic_cloud} "sleep
+0001ad30: 2033 3020 2626 2073 7564 6f20 7368 7574   30 && sudo shut
+0001ad40: 646f 776e 206e 6f77 2026 2620 736c 6565  down now && slee
+0001ad50: 7020 3130 3030 2220 2d79 202d 6427 2c0a  p 1000" -y -d',.
+0001ad60: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0001ad70: 6570 2033 3630 272c 0a20 2020 2020 2020  ep 360',.       
+0001ad80: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+0001ad90: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+0001ada0: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+0001adb0: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
+0001adc0: 475c 7c52 4543 4f56 4552 494e 4722 272c  G\|RECOVERING"',
+0001add0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+0001ade0: 2020 2020 5f53 504f 545f 4341 4e43 454c      _SPOT_CANCEL
+0001adf0: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
+0001ae00: 5f6e 616d 653d 6e61 6d65 292c 0a20 2020  _name=name),.   
+0001ae10: 2020 2020 2074 696d 656f 7574 3d32 3520       timeout=25 
+0001ae20: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
+0001ae30: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+0001ae40: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+0001ae50: 6b2e 6177 730a 4070 7974 6573 742e 6d61  k.aws.@pytest.ma
+0001ae60: 726b 2e6d 616e 6167 6564 5f73 706f 740a  rk.managed_spot.
+0001ae70: 6465 6620 7465 7374 5f73 706f 745f 7265  def test_spot_re
+0001ae80: 636f 7665 7279 5f6d 756c 7469 5f6e 6f64  covery_multi_nod
+0001ae90: 655f 6177 7328 6177 735f 636f 6e66 6967  e_aws(aws_config
+0001aea0: 5f72 6567 696f 6e29 3a0a 2020 2020 2222  _region):.    ""
+0001aeb0: 2254 6573 7420 6d61 6e61 6765 6420 7370  "Test managed sp
+0001aec0: 6f74 2072 6563 6f76 6572 792e 2222 220a  ot recovery.""".
+0001aed0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+0001aee0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+0001aef0: 2020 206e 616d 655f 6f6e 5f63 6c6f 7564     name_on_cloud
+0001af00: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
+0001af10: 6d61 6b65 5f63 6c75 7374 6572 5f6e 616d  make_cluster_nam
+0001af20: 655f 6f6e 5f63 6c6f 7564 280a 2020 2020  e_on_cloud(.    
+0001af30: 2020 2020 6e61 6d65 2c20 7370 6f74 2e53      name, spot.S
+0001af40: 504f 545f 434c 5553 5445 525f 4e41 4d45  POT_CLUSTER_NAME
+0001af50: 5f50 5245 4649 585f 4c45 4e47 5448 2c20  _PREFIX_LENGTH, 
+0001af60: 6164 645f 7573 6572 5f68 6173 683d 4661  add_user_hash=Fa
+0001af70: 6c73 6529 0a20 2020 2072 6567 696f 6e20  lse).    region 
+0001af80: 3d20 6177 735f 636f 6e66 6967 5f72 6567  = aws_config_reg
+0001af90: 696f 6e0a 2020 2020 7465 7374 203d 2054  ion.    test = T
+0001afa0: 6573 7428 0a20 2020 2020 2020 2027 7370  est(.        'sp
+0001afb0: 6f74 5f72 6563 6f76 6572 795f 6d75 6c74  ot_recovery_mult
+0001afc0: 695f 6e6f 6465 5f61 7773 272c 0a20 2020  i_node_aws',.   
+0001afd0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+0001afe0: 2020 2066 2773 6b79 2073 706f 7420 6c61     f'sky spot la
+0001aff0: 756e 6368 202d 2d63 6c6f 7564 2061 7773  unch --cloud aws
+0001b000: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+0001b010: 6e7d 202d 6e20 7b6e 616d 657d 202d 2d6e  n} -n {name} --n
+0001b020: 756d 2d6e 6f64 6573 2032 2022 6563 686f  um-nodes 2 "echo
+0001b030: 2053 4b59 5049 4c4f 545f 5441 534b 5f49   SKYPILOT_TASK_I
+0001b040: 443a 205c 2453 4b59 5049 4c4f 545f 5441  D: \$SKYPILOT_TA
+0001b050: 534b 5f49 443b 2073 6c65 6570 2031 3830  SK_ID; sleep 180
+0001b060: 3022 2020 2d79 202d 6427 2c0a 2020 2020  0"  -y -d',.    
+0001b070: 2020 2020 2020 2020 2773 6c65 6570 2034          'sleep 4
+0001b080: 3530 272c 0a20 2020 2020 2020 2020 2020  50',.           
+0001b090: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
+0001b0a0: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
+0001b0b0: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
+0001b0c0: 6772 6570 2022 5255 4e4e 494e 4722 272c  grep "RUNNING"',
+0001b0d0: 0a20 2020 2020 2020 2020 2020 2066 2752  .            f'R
+0001b0e0: 554e 5f49 443d 2428 736b 7920 7370 6f74  UN_ID=$(sky spot
+0001b0f0: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
+0001b100: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
+0001b110: 6570 2053 4b59 5049 4c4f 545f 5441 534b  ep SKYPILOT_TASK
+0001b120: 5f49 4420 7c20 6375 7420 2d64 3a20 2d66  _ID | cut -d: -f
+0001b130: 3229 3b20 6563 686f 2022 2452 554e 5f49  2); echo "$RUN_I
+0001b140: 4422 207c 2074 6565 202f 746d 702f 7b6e  D" | tee /tmp/{n
+0001b150: 616d 657d 2d72 756e 2d69 6427 2c0a 2020  ame}-run-id',.  
+0001b160: 2020 2020 2020 2020 2020 2320 5465 726d            # Term
+0001b170: 696e 6174 6520 7468 6520 776f 726b 6572  inate the worker
+0001b180: 206d 616e 7561 6c6c 792e 0a20 2020 2020   manually..     
+0001b190: 2020 2020 2020 2028 6627 6177 7320 6563         (f'aws ec
+0001b1a0: 3220 7465 726d 696e 6174 652d 696e 7374  2 terminate-inst
+0001b1b0: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
+0001b1c0: 7265 6769 6f6e 7d20 2d2d 696e 7374 616e  region} --instan
+0001b1d0: 6365 2d69 6473 2024 2827 0a20 2020 2020  ce-ids $('.     
+0001b1e0: 2020 2020 2020 2020 6627 6177 7320 6563          f'aws ec
+0001b1f0: 3220 6465 7363 7269 6265 2d69 6e73 7461  2 describe-insta
+0001b200: 6e63 6573 202d 2d72 6567 696f 6e20 7b72  nces --region {r
+0001b210: 6567 696f 6e7d 2027 0a20 2020 2020 2020  egion} '.       
+0001b220: 2020 2020 2020 6627 2d2d 6669 6c74 6572        f'--filter
+0001b230: 7320 4e61 6d65 3d74 6167 3a72 6179 2d63  s Name=tag:ray-c
+0001b240: 6c75 7374 6572 2d6e 616d 652c 5661 6c75  luster-name,Valu
+0001b250: 6573 3d7b 6e61 6d65 5f6f 6e5f 636c 6f75  es={name_on_clou
+0001b260: 647d 2a20 270a 2020 2020 2020 2020 2020  d}* '.          
+0001b270: 2020 2027 4e61 6d65 3d74 6167 3a72 6179     'Name=tag:ray
+0001b280: 2d6e 6f64 652d 7479 7065 2c56 616c 7565  -node-type,Value
+0001b290: 733d 776f 726b 6572 2027 0a20 2020 2020  s=worker '.     
+0001b2a0: 2020 2020 2020 2020 6627 2d2d 7175 6572          f'--quer
+0001b2b0: 7920 5265 7365 7276 6174 696f 6e73 5b5d  y Reservations[]
+0001b2c0: 2e49 6e73 7461 6e63 6573 5b5d 2e49 6e73  .Instances[].Ins
+0001b2d0: 7461 6e63 6549 6420 270a 2020 2020 2020  tanceId '.      
+0001b2e0: 2020 2020 2020 2027 2d2d 6f75 7470 7574         '--output
+0001b2f0: 2074 6578 7429 2729 2c0a 2020 2020 2020   text)'),.      
+0001b300: 2020 2020 2020 2773 6c65 6570 2035 3027        'sleep 50'
+0001b310: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001b320: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+0001b330: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
+0001b340: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+0001b350: 7020 2252 4543 4f56 4552 494e 4722 272c  p "RECOVERING"',
+0001b360: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0001b370: 6565 7020 3536 3027 2c0a 2020 2020 2020  eep 560',.      
+0001b380: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+0001b390: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+0001b3a0: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+0001b3b0: 6e31 207c 2067 7265 7020 2252 554e 4e49  n1 | grep "RUNNI
+0001b3c0: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
+0001b3d0: 2020 6627 5255 4e5f 4944 3d24 2863 6174    f'RUN_ID=$(cat
+0001b3e0: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+0001b3f0: 2d69 6429 3b20 6563 686f 2024 5255 4e5f  -id); echo $RUN_
+0001b400: 4944 3b20 736b 7920 7370 6f74 206c 6f67  ID; sky spot log
+0001b410: 7320 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f  s -n {name} --no
+0001b420: 2d66 6f6c 6c6f 7720 7c20 6772 6570 2053  -follow | grep S
+0001b430: 4b59 5049 4c4f 545f 5441 534b 5f49 4420  KYPILOT_TASK_ID 
+0001b440: 7c20 6375 7420 2d64 3a20 2d66 3220 7c20  | cut -d: -f2 | 
+0001b450: 6772 6570 2022 2452 554e 5f49 4422 272c  grep "$RUN_ID"',
+0001b460: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+0001b470: 2020 2020 5f53 504f 545f 4341 4e43 454c      _SPOT_CANCEL
+0001b480: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
+0001b490: 5f6e 616d 653d 6e61 6d65 292c 0a20 2020  _name=name),.   
+0001b4a0: 2020 2020 2074 696d 656f 7574 3d33 3020       timeout=30 
+0001b4b0: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
+0001b4c0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+0001b4d0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+0001b4e0: 6b2e 6763 700a 4070 7974 6573 742e 6d61  k.gcp.@pytest.ma
+0001b4f0: 726b 2e6d 616e 6167 6564 5f73 706f 740a  rk.managed_spot.
+0001b500: 6465 6620 7465 7374 5f73 706f 745f 7265  def test_spot_re
+0001b510: 636f 7665 7279 5f6d 756c 7469 5f6e 6f64  covery_multi_nod
+0001b520: 655f 6763 7028 293a 0a20 2020 2022 2222  e_gcp():.    """
+0001b530: 5465 7374 206d 616e 6167 6564 2073 706f  Test managed spo
+0001b540: 7420 7265 636f 7665 7279 2e22 2222 0a20  t recovery.""". 
+0001b550: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+0001b560: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+0001b570: 2020 6e61 6d65 5f6f 6e5f 636c 6f75 6420    name_on_cloud 
+0001b580: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e6d  = common_utils.m
+0001b590: 616b 655f 636c 7573 7465 725f 6e61 6d65  ake_cluster_name
+0001b5a0: 5f6f 6e5f 636c 6f75 6428 0a20 2020 2020  _on_cloud(.     
+0001b5b0: 2020 206e 616d 652c 2073 706f 742e 5350     name, spot.SP
+0001b5c0: 4f54 5f43 4c55 5354 4552 5f4e 414d 455f  OT_CLUSTER_NAME_
+0001b5d0: 5052 4546 4958 5f4c 454e 4754 482c 2061  PREFIX_LENGTH, a
+0001b5e0: 6464 5f75 7365 725f 6861 7368 3d46 616c  dd_user_hash=Fal
+0001b5f0: 7365 290a 2020 2020 7a6f 6e65 203d 2027  se).    zone = '
+0001b600: 7573 2d77 6573 7432 2d61 270a 2020 2020  us-west2-a'.    
+0001b610: 2320 5573 6520 273a 2720 746f 206d 6174  # Use ':' to mat
+0001b620: 6368 2061 7320 7468 6520 636c 7573 7465  ch as the cluste
+0001b630: 7220 6e61 6d65 2077 696c 6c20 636f 6e74  r name will cont
+0001b640: 6169 6e20 7468 6520 7375 6666 6978 2077  ain the suffix w
+0001b650: 6974 6820 6a6f 6220 6964 0a20 2020 2071  ith job id.    q
+0001b660: 7565 7279 5f63 6d64 203d 2028 0a20 2020  uery_cmd = (.   
+0001b670: 2020 2020 2066 2767 636c 6f75 6420 636f       f'gcloud co
+0001b680: 6d70 7574 6520 696e 7374 616e 6365 7320  mpute instances 
+0001b690: 6c69 7374 202d 2d66 696c 7465 723d 270a  list --filter='.
+0001b6a0: 2020 2020 2020 2020 6627 2228 6c61 6265          f'"(labe
+0001b6b0: 6c73 2e72 6179 2d63 6c75 7374 6572 2d6e  ls.ray-cluster-n
+0001b6c0: 616d 653a 7b6e 616d 655f 6f6e 5f63 6c6f  ame:{name_on_clo
+0001b6d0: 7564 7d20 414e 4420 270a 2020 2020 2020  ud} AND '.      
+0001b6e0: 2020 6627 6c61 6265 6c73 2e72 6179 2d6e    f'labels.ray-n
+0001b6f0: 6f64 652d 7479 7065 3d77 6f72 6b65 7229  ode-type=worker)
+0001b700: 2220 2d2d 7a6f 6e65 733d 7b7a 6f6e 657d  " --zones={zone}
+0001b710: 202d 2d66 6f72 6d61 743d 2276 616c 7565   --format="value
+0001b720: 286e 616d 6529 2227 290a 2020 2020 7465  (name)"').    te
+0001b730: 726d 696e 6174 655f 636d 6420 3d20 2866  rminate_cmd = (f
+0001b740: 2767 636c 6f75 6420 636f 6d70 7574 6520  'gcloud compute 
+0001b750: 696e 7374 616e 6365 7320 6465 6c65 7465  instances delete
+0001b760: 202d 2d7a 6f6e 653d 7b7a 6f6e 657d 270a   --zone={zone}'.
+0001b770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b780: 2020 2020 2066 2720 2d2d 7175 6965 7420       f' --quiet 
+0001b790: 2428 7b71 7565 7279 5f63 6d64 7d29 2729  $({query_cmd})')
+0001b7a0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+0001b7b0: 280a 2020 2020 2020 2020 2773 706f 745f  (.        'spot_
+0001b7c0: 7265 636f 7665 7279 5f6d 756c 7469 5f6e  recovery_multi_n
+0001b7d0: 6f64 655f 6763 7027 2c0a 2020 2020 2020  ode_gcp',.      
+0001b7e0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+0001b7f0: 6627 736b 7920 7370 6f74 206c 6175 6e63  f'sky spot launc
+0001b800: 6820 2d2d 636c 6f75 6420 6763 7020 2d2d  h --cloud gcp --
+0001b810: 7a6f 6e65 207b 7a6f 6e65 7d20 2d6e 207b  zone {zone} -n {
+0001b820: 6e61 6d65 7d20 2d2d 6e75 6d2d 6e6f 6465  name} --num-node
+0001b830: 7320 3220 2265 6368 6f20 534b 5950 494c  s 2 "echo SKYPIL
+0001b840: 4f54 5f54 4153 4b5f 4944 3a20 5c24 534b  OT_TASK_ID: \$SK
+0001b850: 5950 494c 4f54 5f54 4153 4b5f 4944 3b20  YPILOT_TASK_ID; 
+0001b860: 736c 6565 7020 3138 3030 2220 202d 7920  sleep 1800"  -y 
+0001b870: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
+0001b880: 2027 736c 6565 7020 3430 3027 2c0a 2020   'sleep 400',.  
+0001b890: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
+0001b8a0: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
+0001b8b0: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
+0001b8c0: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
+0001b8d0: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
+0001b8e0: 2020 2020 2020 6627 5255 4e5f 4944 3d24        f'RUN_ID=$
+0001b8f0: 2873 6b79 2073 706f 7420 6c6f 6773 202d  (sky spot logs -
+0001b900: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
+0001b910: 6c6c 6f77 207c 2067 7265 7020 534b 5950  llow | grep SKYP
+0001b920: 494c 4f54 5f54 4153 4b5f 4944 207c 2063  ILOT_TASK_ID | c
+0001b930: 7574 202d 643a 202d 6632 293b 2065 6368  ut -d: -f2); ech
+0001b940: 6f20 2224 5255 4e5f 4944 2220 7c20 7465  o "$RUN_ID" | te
+0001b950: 6520 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  e /tmp/{name}-ru
+0001b960: 6e2d 6964 272c 0a20 2020 2020 2020 2020  n-id',.         
+0001b970: 2020 2023 2054 6572 6d69 6e61 7465 2074     # Terminate t
+0001b980: 6865 2077 6f72 6b65 7220 6d61 6e75 616c  he worker manual
+0001b990: 6c79 2e0a 2020 2020 2020 2020 2020 2020  ly..            
+0001b9a0: 7465 726d 696e 6174 655f 636d 642c 0a20  terminate_cmd,. 
+0001b9b0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0001b9c0: 7020 3530 272c 0a20 2020 2020 2020 2020  p 50',.         
+0001b9d0: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
+0001b9e0: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001b9f0: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
+0001ba00: 7c20 6772 6570 2022 5245 434f 5645 5249  | grep "RECOVERI
+0001ba10: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
+0001ba20: 2020 2773 6c65 6570 2034 3230 272c 0a20    'sleep 420',. 
+0001ba30: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+0001ba40: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
+0001ba50: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
+0001ba60: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
+0001ba70: 5255 4e4e 494e 4722 272c 0a20 2020 2020  RUNNING"',.     
+0001ba80: 2020 2020 2020 2066 2752 554e 5f49 443d         f'RUN_ID=
+0001ba90: 2428 6361 7420 2f74 6d70 2f7b 6e61 6d65  $(cat /tmp/{name
+0001baa0: 7d2d 7275 6e2d 6964 293b 2065 6368 6f20  }-run-id); echo 
+0001bab0: 2452 554e 5f49 443b 2073 6b79 2073 706f  $RUN_ID; sky spo
+0001bac0: 7420 6c6f 6773 202d 6e20 7b6e 616d 657d  t logs -n {name}
+0001bad0: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
+0001bae0: 7265 7020 534b 5950 494c 4f54 5f54 4153  rep SKYPILOT_TAS
+0001baf0: 4b5f 4944 207c 2063 7574 202d 643a 202d  K_ID | cut -d: -
+0001bb00: 6632 207c 2067 7265 7020 2224 5255 4e5f  f2 | grep "$RUN_
+0001bb10: 4944 2227 2c0a 2020 2020 2020 2020 5d2c  ID"',.        ],
+0001bb20: 0a20 2020 2020 2020 205f 5350 4f54 5f43  .        _SPOT_C
+0001bb30: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
+0001bb40: 7428 6a6f 625f 6e61 6d65 3d6e 616d 6529  t(job_name=name)
+0001bb50: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+0001bb60: 743d 3235 202a 2036 302c 0a20 2020 2029  t=25 * 60,.    )
+0001bb70: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+0001bb80: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+0001bb90: 742e 6d61 726b 2e61 7773 0a40 7079 7465  t.mark.aws.@pyte
+0001bba0: 7374 2e6d 6172 6b2e 6d61 6e61 6765 645f  st.mark.managed_
+0001bbb0: 7370 6f74 0a64 6566 2074 6573 745f 7370  spot.def test_sp
+0001bbc0: 6f74 5f63 616e 6365 6c6c 6174 696f 6e5f  ot_cancellation_
+0001bbd0: 6177 7328 6177 735f 636f 6e66 6967 5f72  aws(aws_config_r
+0001bbe0: 6567 696f 6e29 3a0a 2020 2020 6e61 6d65  egion):.    name
+0001bbf0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+0001bc00: 6e61 6d65 2829 0a20 2020 206e 616d 655f  name().    name_
+0001bc10: 6f6e 5f63 6c6f 7564 203d 2063 6f6d 6d6f  on_cloud = commo
+0001bc20: 6e5f 7574 696c 732e 6d61 6b65 5f63 6c75  n_utils.make_clu
+0001bc30: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
+0001bc40: 7564 280a 2020 2020 2020 2020 6e61 6d65  ud(.        name
+0001bc50: 2c20 7370 6f74 2e53 504f 545f 434c 5553  , spot.SPOT_CLUS
+0001bc60: 5445 525f 4e41 4d45 5f50 5245 4649 585f  TER_NAME_PREFIX_
+0001bc70: 4c45 4e47 5448 2c20 6164 645f 7573 6572  LENGTH, add_user
+0001bc80: 5f68 6173 683d 4661 6c73 6529 0a20 2020  _hash=False).   
+0001bc90: 206e 616d 655f 325f 6f6e 5f63 6c6f 7564   name_2_on_cloud
+0001bca0: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
+0001bcb0: 6d61 6b65 5f63 6c75 7374 6572 5f6e 616d  make_cluster_nam
+0001bcc0: 655f 6f6e 5f63 6c6f 7564 280a 2020 2020  e_on_cloud(.    
+0001bcd0: 2020 2020 6627 7b6e 616d 657d 2d32 272c      f'{name}-2',
+0001bce0: 2073 706f 742e 5350 4f54 5f43 4c55 5354   spot.SPOT_CLUST
+0001bcf0: 4552 5f4e 414d 455f 5052 4546 4958 5f4c  ER_NAME_PREFIX_L
+0001bd00: 454e 4754 482c 2061 6464 5f75 7365 725f  ENGTH, add_user_
+0001bd10: 6861 7368 3d46 616c 7365 290a 2020 2020  hash=False).    
+0001bd20: 6e61 6d65 5f33 5f6f 6e5f 636c 6f75 6420  name_3_on_cloud 
+0001bd30: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e6d  = common_utils.m
+0001bd40: 616b 655f 636c 7573 7465 725f 6e61 6d65  ake_cluster_name
+0001bd50: 5f6f 6e5f 636c 6f75 6428 0a20 2020 2020  _on_cloud(.     
+0001bd60: 2020 2066 277b 6e61 6d65 7d2d 3327 2c20     f'{name}-3', 
+0001bd70: 7370 6f74 2e53 504f 545f 434c 5553 5445  spot.SPOT_CLUSTE
+0001bd80: 525f 4e41 4d45 5f50 5245 4649 585f 4c45  R_NAME_PREFIX_LE
+0001bd90: 4e47 5448 2c20 6164 645f 7573 6572 5f68  NGTH, add_user_h
+0001bda0: 6173 683d 4661 6c73 6529 0a20 2020 2072  ash=False).    r
+0001bdb0: 6567 696f 6e20 3d20 6177 735f 636f 6e66  egion = aws_conf
+0001bdc0: 6967 5f72 6567 696f 6e0a 2020 2020 7465  ig_region.    te
+0001bdd0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+0001bde0: 2020 2027 7370 6f74 5f63 616e 6365 6c6c     'spot_cancell
+0001bdf0: 6174 696f 6e5f 6177 7327 2c0a 2020 2020  ation_aws',.    
+0001be00: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+0001be10: 2020 2320 5465 7374 2063 616e 6365 6c6c    # Test cancell
+0001be20: 6174 696f 6e20 6475 7269 6e67 2073 706f  ation during spo
+0001be30: 7420 636c 7573 7465 7220 6265 696e 6720  t cluster being 
+0001be40: 6c61 756e 6368 6564 2e0a 2020 2020 2020  launched..      
+0001be50: 2020 2020 2020 6627 736b 7920 7370 6f74        f'sky spot
+0001be60: 206c 6175 6e63 6820 2d2d 636c 6f75 6420   launch --cloud 
+0001be70: 6177 7320 2d2d 7265 6769 6f6e 207b 7265  aws --region {re
+0001be80: 6769 6f6e 7d20 2d6e 207b 6e61 6d65 7d20  gion} -n {name} 
+0001be90: 2273 6c65 6570 2031 3030 3022 2020 2d79  "sleep 1000"  -y
+0001bea0: 202d 6427 2c0a 2020 2020 2020 2020 2020   -d',.          
+0001beb0: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
+0001bec0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
+0001bed0: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
+0001bee0: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
+0001bef0: 6164 202d 6e31 207c 2067 7265 7020 2253  ad -n1 | grep "S
+0001bf00: 5441 5254 494e 4722 272c 0a20 2020 2020  TARTING"',.     
+0001bf10: 2020 2020 2020 205f 5350 4f54 5f43 414e         _SPOT_CAN
+0001bf20: 4345 4c5f 5741 4954 2e66 6f72 6d61 7428  CEL_WAIT.format(
+0001bf30: 6a6f 625f 6e61 6d65 3d6e 616d 6529 2c0a  job_name=name),.
+0001bf40: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0001bf50: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
+0001bf60: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
+0001bf70: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001bf80: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
+0001bf90: 7c20 6772 6570 2022 4341 4e43 454c 4c49  | grep "CANCELLI
+0001bfa0: 4e47 5c7c 4341 4e43 454c 4c45 4422 272c  NG\|CANCELLED"',
+0001bfb0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0001bfc0: 6565 7020 3132 3027 2c0a 2020 2020 2020  eep 120',.      
+0001bfd0: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+0001bfe0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+0001bff0: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+0001c000: 6e31 207c 2067 7265 7020 2243 414e 4345  n1 | grep "CANCE
+0001c010: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
+0001c020: 2020 2020 2866 2773 3d24 2861 7773 2065      (f's=$(aws e
+0001c030: 6332 2064 6573 6372 6962 652d 696e 7374  c2 describe-inst
+0001c040: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
+0001c050: 7265 6769 6f6e 7d20 270a 2020 2020 2020  region} '.      
+0001c060: 2020 2020 2020 2066 272d 2d66 696c 7465         f'--filte
+0001c070: 7273 204e 616d 653d 7461 673a 7261 792d  rs Name=tag:ray-
+0001c080: 636c 7573 7465 722d 6e61 6d65 2c56 616c  cluster-name,Val
+0001c090: 7565 733d 7b6e 616d 655f 6f6e 5f63 6c6f  ues={name_on_clo
+0001c0a0: 7564 7d2d 2a20 270a 2020 2020 2020 2020  ud}-* '.        
+0001c0b0: 2020 2020 2066 272d 2d71 7565 7279 2052       f'--query R
+0001c0c0: 6573 6572 7661 7469 6f6e 735b 5d2e 496e  eservations[].In
+0001c0d0: 7374 616e 6365 735b 5d2e 5374 6174 655b  stances[].State[
+0001c0e0: 5d2e 4e61 6d65 2027 0a20 2020 2020 2020  ].Name '.       
+0001c0f0: 2020 2020 2020 272d 2d6f 7574 7075 7420        '--output 
+0001c100: 7465 7874 2920 2626 2065 6368 6f20 2224  text) && echo "$
+0001c110: 7322 2026 2620 6563 686f 3b20 5b5b 202d  s" && echo; [[ -
+0001c120: 7a20 2224 7322 205d 5d20 7c7c 205b 5b20  z "$s" ]] || [[ 
+0001c130: 2224 7322 203d 2022 7465 726d 696e 6174  "$s" = "terminat
+0001c140: 6564 2220 5d5d 207c 7c20 5b5b 2022 2473  ed" ]] || [[ "$s
+0001c150: 2220 3d20 2273 6875 7474 696e 672d 646f  " = "shutting-do
+0001c160: 776e 2220 5d5d 270a 2020 2020 2020 2020  wn" ]]'.        
+0001c170: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
+0001c180: 2020 2023 2054 6573 7420 6361 6e63 656c     # Test cancel
+0001c190: 6c69 6e67 2074 6865 2073 706f 7420 636c  ling the spot cl
+0001c1a0: 7573 7465 7220 6475 7269 6e67 2073 706f  uster during spo
+0001c1b0: 7420 6a6f 6220 6265 696e 6720 7365 7475  t job being setu
+0001c1c0: 702e 0a20 2020 2020 2020 2020 2020 2066  p..            f
+0001c1d0: 2773 6b79 2073 706f 7420 6c61 756e 6368  'sky spot launch
+0001c1e0: 202d 2d63 6c6f 7564 2061 7773 202d 2d72   --cloud aws --r
+0001c1f0: 6567 696f 6e20 7b72 6567 696f 6e7d 202d  egion {region} -
+0001c200: 6e20 7b6e 616d 657d 2d32 2074 6573 7473  n {name}-2 tests
+0001c210: 2f74 6573 745f 7961 6d6c 732f 7465 7374  /test_yamls/test
+0001c220: 5f6c 6f6e 675f 7365 7475 702e 7961 6d6c  _long_setup.yaml
+0001c230: 2020 2d79 202d 6427 2c0a 2020 2020 2020    -y -d',.      
+0001c240: 2020 2020 2020 2773 6c65 6570 2033 3030        'sleep 300
+0001c250: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
+0001c260: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
+0001c270: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
+0001c280: 3d66 277b 6e61 6d65 7d2d 3227 292c 0a20  =f'{name}-2'),. 
+0001c290: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0001c2a0: 7020 3527 2c0a 2020 2020 2020 2020 2020  p 5',.          
+0001c2b0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+0001c2c0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+0001c2d0: 6d65 7d2d 3220 7c20 6865 6164 202d 6e31  me}-2 | head -n1
+0001c2e0: 207c 2067 7265 7020 2243 414e 4345 4c4c   | grep "CANCELL
+0001c2f0: 494e 475c 7c43 414e 4345 4c4c 4544 2227  ING\|CANCELLED"'
+0001c300: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0001c310: 6c65 6570 2031 3230 272c 0a20 2020 2020  leep 120',.     
+0001c320: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+0001c330: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+0001c340: 7020 7b6e 616d 657d 2d32 207c 2068 6561  p {name}-2 | hea
+0001c350: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
+0001c360: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
+0001c370: 2020 2020 2020 2028 6627 733d 2428 6177         (f's=$(aw
+0001c380: 7320 6563 3220 6465 7363 7269 6265 2d69  s ec2 describe-i
+0001c390: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
+0001c3a0: 6e20 7b72 6567 696f 6e7d 2027 0a20 2020  n {region} '.   
+0001c3b0: 2020 2020 2020 2020 2020 6627 2d2d 6669            f'--fi
+0001c3c0: 6c74 6572 7320 4e61 6d65 3d74 6167 3a72  lters Name=tag:r
+0001c3d0: 6179 2d63 6c75 7374 6572 2d6e 616d 652c  ay-cluster-name,
+0001c3e0: 5661 6c75 6573 3d7b 6e61 6d65 5f32 5f6f  Values={name_2_o
+0001c3f0: 6e5f 636c 6f75 647d 2d2a 2027 0a20 2020  n_cloud}-* '.   
+0001c400: 2020 2020 2020 2020 2020 6627 2d2d 7175            f'--qu
+0001c410: 6572 7920 5265 7365 7276 6174 696f 6e73  ery Reservations
+0001c420: 5b5d 2e49 6e73 7461 6e63 6573 5b5d 2e53  [].Instances[].S
+0001c430: 7461 7465 5b5d 2e4e 616d 6520 270a 2020  tate[].Name '.  
+0001c440: 2020 2020 2020 2020 2020 2027 2d2d 6f75             '--ou
+0001c450: 7470 7574 2074 6578 7429 2026 2620 6563  tput text) && ec
+0001c460: 686f 2022 2473 2220 2626 2065 6368 6f3b  ho "$s" && echo;
+0001c470: 205b 5b20 2d7a 2022 2473 2220 5d5d 207c   [[ -z "$s" ]] |
+0001c480: 7c20 5b5b 2022 2473 2220 3d20 2274 6572  | [[ "$s" = "ter
+0001c490: 6d69 6e61 7465 6422 205d 5d20 7c7c 205b  minated" ]] || [
+0001c4a0: 5b20 2224 7322 203d 2022 7368 7574 7469  [ "$s" = "shutti
+0001c4b0: 6e67 2d64 6f77 6e22 205d 5d27 0a20 2020  ng-down" ]]'.   
+0001c4c0: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+0001c4d0: 2020 2020 2020 2020 2320 5465 7374 2063          # Test c
+0001c4e0: 616e 6365 6c6c 6174 696f 6e20 6475 7269  ancellation duri
+0001c4f0: 6e67 2073 706f 7420 6a6f 6220 6973 2072  ng spot job is r
+0001c500: 6563 6f76 6572 696e 672e 0a20 2020 2020  ecovering..     
+0001c510: 2020 2020 2020 2066 2773 6b79 2073 706f         f'sky spo
+0001c520: 7420 6c61 756e 6368 202d 2d63 6c6f 7564  t launch --cloud
+0001c530: 2061 7773 202d 2d72 6567 696f 6e20 7b72   aws --region {r
+0001c540: 6567 696f 6e7d 202d 6e20 7b6e 616d 657d  egion} -n {name}
+0001c550: 2d33 2022 736c 6565 7020 3130 3030 2220  -3 "sleep 1000" 
+0001c560: 202d 7920 2d64 272c 0a20 2020 2020 2020   -y -d',.       
+0001c570: 2020 2020 2027 736c 6565 7020 3330 3027       'sleep 300'
+0001c580: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001c590: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+0001c5a0: 547d 7c20 6772 6570 207b 6e61 6d65 7d2d  T}| grep {name}-
+0001c5b0: 3320 7c20 6865 6164 202d 6e31 207c 2067  3 | head -n1 | g
+0001c5c0: 7265 7020 2252 554e 4e49 4e47 2227 2c0a  rep "RUNNING"',.
+0001c5d0: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
+0001c5e0: 726d 696e 6174 6520 7468 6520 636c 7573  rminate the clus
+0001c5f0: 7465 7220 6d61 6e75 616c 6c79 2e0a 2020  ter manually..  
+0001c600: 2020 2020 2020 2020 2020 2866 2761 7773            (f'aws
+0001c610: 2065 6332 2074 6572 6d69 6e61 7465 2d69   ec2 terminate-i
+0001c620: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
+0001c630: 6e20 7b72 6567 696f 6e7d 202d 2d69 6e73  n {region} --ins
+0001c640: 7461 6e63 652d 6964 7320 2428 270a 2020  tance-ids $('.  
+0001c650: 2020 2020 2020 2020 2020 2066 2761 7773             f'aws
+0001c660: 2065 6332 2064 6573 6372 6962 652d 696e   ec2 describe-in
+0001c670: 7374 616e 6365 7320 2d2d 7265 6769 6f6e  stances --region
+0001c680: 207b 7265 6769 6f6e 7d20 270a 2020 2020   {region} '.    
+0001c690: 2020 2020 2020 2020 2066 272d 2d66 696c           f'--fil
+0001c6a0: 7465 7273 204e 616d 653d 7461 673a 7261  ters Name=tag:ra
+0001c6b0: 792d 636c 7573 7465 722d 6e61 6d65 2c56  y-cluster-name,V
+0001c6c0: 616c 7565 733d 7b6e 616d 655f 335f 6f6e  alues={name_3_on
+0001c6d0: 5f63 6c6f 7564 7d2d 2a20 270a 2020 2020  _cloud}-* '.    
+0001c6e0: 2020 2020 2020 2020 2066 272d 2d71 7565           f'--que
+0001c6f0: 7279 2052 6573 6572 7661 7469 6f6e 735b  ry Reservations[
+0001c700: 5d2e 496e 7374 616e 6365 735b 5d2e 496e  ].Instances[].In
+0001c710: 7374 616e 6365 4964 2027 0a20 2020 2020  stanceId '.     
+0001c720: 2020 2020 2020 2020 272d 2d6f 7574 7075          '--outpu
+0001c730: 7420 7465 7874 2927 292c 0a20 2020 2020  t text)'),.     
+0001c740: 2020 2020 2020 2027 736c 6565 7020 3132         'sleep 12
+0001c750: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+0001c760: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+0001c770: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+0001c780: 7d2d 3320 7c20 6865 6164 202d 6e31 207c  }-3 | head -n1 |
+0001c790: 2067 7265 7020 2252 4543 4f56 4552 494e   grep "RECOVERIN
+0001c7a0: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+0001c7b0: 205f 5350 4f54 5f43 414e 4345 4c5f 5741   _SPOT_CANCEL_WA
+0001c7c0: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
+0001c7d0: 6d65 3d66 277b 6e61 6d65 7d2d 3327 292c  me=f'{name}-3'),
+0001c7e0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0001c7f0: 6565 7020 3527 2c0a 2020 2020 2020 2020  eep 5',.        
+0001c800: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
+0001c810: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+0001c820: 6e61 6d65 7d2d 3320 7c20 6865 6164 202d  name}-3 | head -
+0001c830: 6e31 207c 2067 7265 7020 2243 414e 4345  n1 | grep "CANCE
+0001c840: 4c4c 494e 475c 7c43 414e 4345 4c4c 4544  LLING\|CANCELLED
+0001c850: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0001c860: 2773 6c65 6570 2031 3230 272c 0a20 2020  'sleep 120',.   
+0001c870: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
+0001c880: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
+0001c890: 7265 7020 7b6e 616d 657d 2d33 207c 2068  rep {name}-3 | h
+0001c8a0: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
+0001c8b0: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
+0001c8c0: 2020 2020 2020 2020 2023 2054 6865 2063           # The c
+0001c8d0: 6c75 7374 6572 2073 686f 756c 6420 6265  luster should be
+0001c8e0: 2074 6572 6d69 6e61 7465 6420 2873 6875   terminated (shu
+0001c8f0: 7474 696e 672d 646f 776e 2920 6166 7465  tting-down) afte
+0001c900: 7220 6361 6e63 656c 6c61 7469 6f6e 2e20  r cancellation. 
+0001c910: 5765 2064 6f6e 2774 2075 7365 2074 6865  We don't use the
+0001c920: 2060 3d60 206f 7065 7261 746f 7220 6865   `=` operator he
+0001c930: 7265 2062 6563 6175 7365 0a20 2020 2020  re because.     
+0001c940: 2020 2020 2020 2023 2074 6865 7265 2063         # there c
+0001c950: 616e 2062 6520 6d75 6c74 6970 6c65 2056  an be multiple V
+0001c960: 4d20 7769 7468 2074 6865 2073 616d 6520  M with the same 
+0001c970: 6e61 6d65 2064 7565 2074 6f20 7468 6520  name due to the 
+0001c980: 7265 636f 7665 7279 2e0a 2020 2020 2020  recovery..      
+0001c990: 2020 2020 2020 2866 2773 3d24 2861 7773        (f's=$(aws
+0001c9a0: 2065 6332 2064 6573 6372 6962 652d 696e   ec2 describe-in
+0001c9b0: 7374 616e 6365 7320 2d2d 7265 6769 6f6e  stances --region
+0001c9c0: 207b 7265 6769 6f6e 7d20 270a 2020 2020   {region} '.    
+0001c9d0: 2020 2020 2020 2020 2066 272d 2d66 696c           f'--fil
+0001c9e0: 7465 7273 204e 616d 653d 7461 673a 7261  ters Name=tag:ra
+0001c9f0: 792d 636c 7573 7465 722d 6e61 6d65 2c56  y-cluster-name,V
+0001ca00: 616c 7565 733d 7b6e 616d 655f 335f 6f6e  alues={name_3_on
+0001ca10: 5f63 6c6f 7564 7d2d 2a20 270a 2020 2020  _cloud}-* '.    
+0001ca20: 2020 2020 2020 2020 2066 272d 2d71 7565           f'--que
+0001ca30: 7279 2052 6573 6572 7661 7469 6f6e 735b  ry Reservations[
+0001ca40: 5d2e 496e 7374 616e 6365 735b 5d2e 5374  ].Instances[].St
+0001ca50: 6174 655b 5d2e 4e61 6d65 2027 0a20 2020  ate[].Name '.   
+0001ca60: 2020 2020 2020 2020 2020 272d 2d6f 7574            '--out
+0001ca70: 7075 7420 7465 7874 2920 2626 2065 6368  put text) && ech
+0001ca80: 6f20 2224 7322 2026 2620 6563 686f 3b20  o "$s" && echo; 
+0001ca90: 5b5b 202d 7a20 2224 7322 205d 5d20 7c7c  [[ -z "$s" ]] ||
+0001caa0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+0001cab0: 7020 2d76 202d 4520 2270 656e 6469 6e67  p -v -E "pending
+0001cac0: 7c72 756e 6e69 6e67 7c73 746f 7070 6564  |running|stopped
+0001cad0: 7c73 746f 7070 696e 6722 270a 2020 2020  |stopping"'.    
+0001cae0: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
+0001caf0: 2020 205d 2c0a 2020 2020 2020 2020 7469     ],.        ti
+0001cb00: 6d65 6f75 743d 3235 202a 2036 3029 0a20  meout=25 * 60). 
+0001cb10: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+0001cb20: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+0001cb30: 6d61 726b 2e67 6370 0a40 7079 7465 7374  mark.gcp.@pytest
+0001cb40: 2e6d 6172 6b2e 6d61 6e61 6765 645f 7370  .mark.managed_sp
+0001cb50: 6f74 0a64 6566 2074 6573 745f 7370 6f74  ot.def test_spot
+0001cb60: 5f63 616e 6365 6c6c 6174 696f 6e5f 6763  _cancellation_gc
+0001cb70: 7028 293a 0a20 2020 206e 616d 6520 3d20  p():.    name = 
+0001cb80: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+0001cb90: 6528 290a 2020 2020 6e61 6d65 5f33 203d  e().    name_3 =
+0001cba0: 2066 277b 6e61 6d65 7d2d 3327 0a20 2020   f'{name}-3'.   
+0001cbb0: 206e 616d 655f 335f 6f6e 5f63 6c6f 7564   name_3_on_cloud
+0001cbc0: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
+0001cbd0: 6d61 6b65 5f63 6c75 7374 6572 5f6e 616d  make_cluster_nam
+0001cbe0: 655f 6f6e 5f63 6c6f 7564 280a 2020 2020  e_on_cloud(.    
+0001cbf0: 2020 2020 6e61 6d65 5f33 2c20 7370 6f74      name_3, spot
+0001cc00: 2e53 504f 545f 434c 5553 5445 525f 4e41  .SPOT_CLUSTER_NA
+0001cc10: 4d45 5f50 5245 4649 585f 4c45 4e47 5448  ME_PREFIX_LENGTH
+0001cc20: 2c20 6164 645f 7573 6572 5f68 6173 683d  , add_user_hash=
+0001cc30: 4661 6c73 6529 0a20 2020 207a 6f6e 6520  False).    zone 
+0001cc40: 3d20 2775 732d 7765 7374 332d 6227 0a20  = 'us-west3-b'. 
+0001cc50: 2020 2071 7565 7279 5f73 7461 7465 5f63     query_state_c
+0001cc60: 6d64 203d 2028 0a20 2020 2020 2020 2027  md = (.        '
+0001cc70: 6763 6c6f 7564 2063 6f6d 7075 7465 2069  gcloud compute i
+0001cc80: 6e73 7461 6e63 6573 206c 6973 7420 270a  nstances list '.
+0001cc90: 2020 2020 2020 2020 6627 2d2d 6669 6c74          f'--filt
+0001cca0: 6572 3d22 286c 6162 656c 732e 7261 792d  er="(labels.ray-
+0001ccb0: 636c 7573 7465 722d 6e61 6d65 3a7b 6e61  cluster-name:{na
+0001ccc0: 6d65 5f33 5f6f 6e5f 636c 6f75 647d 2922  me_3_on_cloud})"
+0001ccd0: 2027 0a20 2020 2020 2020 2027 2d2d 666f   '.        '--fo
+0001cce0: 726d 6174 3d22 7661 6c75 6528 7374 6174  rmat="value(stat
+0001ccf0: 7573 2922 2729 0a20 2020 2071 7565 7279  us)"').    query
+0001cd00: 5f63 6d64 203d 2028 6627 6763 6c6f 7564  _cmd = (f'gcloud
+0001cd10: 2063 6f6d 7075 7465 2069 6e73 7461 6e63   compute instanc
+0001cd20: 6573 206c 6973 7420 2d2d 6669 6c74 6572  es list --filter
+0001cd30: 3d27 0a20 2020 2020 2020 2020 2020 2020  ='.             
+0001cd40: 2020 2020 6627 2228 6c61 6265 6c73 2e72      f'"(labels.r
+0001cd50: 6179 2d63 6c75 7374 6572 2d6e 616d 653a  ay-cluster-name:
+0001cd60: 7b6e 616d 655f 335f 6f6e 5f63 6c6f 7564  {name_3_on_cloud
+0001cd70: 7d29 2220 270a 2020 2020 2020 2020 2020  })" '.          
+0001cd80: 2020 2020 2020 2066 272d 2d7a 6f6e 6573         f'--zones
+0001cd90: 3d7b 7a6f 6e65 7d20 2d2d 666f 726d 6174  ={zone} --format
+0001cda0: 3d22 7661 6c75 6528 6e61 6d65 2922 2729  ="value(name)"')
+0001cdb0: 0a20 2020 2074 6572 6d69 6e61 7465 5f63  .    terminate_c
+0001cdc0: 6d64 203d 2028 6627 6763 6c6f 7564 2063  md = (f'gcloud c
+0001cdd0: 6f6d 7075 7465 2069 6e73 7461 6e63 6573  ompute instances
+0001cde0: 2064 656c 6574 6520 2d2d 7a6f 6e65 3d7b   delete --zone={
+0001cdf0: 7a6f 6e65 7d27 0a20 2020 2020 2020 2020  zone}'.         
+0001ce00: 2020 2020 2020 2020 2020 2020 6627 202d              f' -
+0001ce10: 2d71 7569 6574 2024 287b 7175 6572 795f  -quiet $({query_
+0001ce20: 636d 647d 2927 290a 2020 2020 7465 7374  cmd})').    test
+0001ce30: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+0001ce40: 2027 7370 6f74 5f63 616e 6365 6c6c 6174   'spot_cancellat
+0001ce50: 696f 6e5f 6763 7027 2c0a 2020 2020 2020  ion_gcp',.      
+0001ce60: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+0001ce70: 2320 5465 7374 2063 616e 6365 6c6c 6174  # Test cancellat
+0001ce80: 696f 6e20 6475 7269 6e67 2073 706f 7420  ion during spot 
+0001ce90: 636c 7573 7465 7220 6265 696e 6720 6c61  cluster being la
+0001cea0: 756e 6368 6564 2e0a 2020 2020 2020 2020  unched..        
+0001ceb0: 2020 2020 6627 736b 7920 7370 6f74 206c      f'sky spot l
+0001cec0: 6175 6e63 6820 2d2d 636c 6f75 6420 6763  aunch --cloud gc
+0001ced0: 7020 2d2d 7a6f 6e65 207b 7a6f 6e65 7d20  p --zone {zone} 
+0001cee0: 2d6e 207b 6e61 6d65 7d20 2273 6c65 6570  -n {name} "sleep
+0001cef0: 2031 3030 3022 2020 2d79 202d 6427 2c0a   1000"  -y -d',.
+0001cf00: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0001cf10: 6570 2036 3027 2c0a 2020 2020 2020 2020  ep 60',.        
+0001cf20: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
+0001cf30: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+0001cf40: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
+0001cf50: 207c 2067 7265 7020 2253 5441 5254 494e   | grep "STARTIN
+0001cf60: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+0001cf70: 205f 5350 4f54 5f43 414e 4345 4c5f 5741   _SPOT_CANCEL_WA
+0001cf80: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
+0001cf90: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
+0001cfa0: 2020 2020 2020 2773 6c65 6570 2035 272c        'sleep 5',
+0001cfb0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+0001cfc0: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+0001cfd0: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+0001cfe0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+0001cff0: 2022 4341 4e43 454c 4c49 4e47 5c7c 4341   "CANCELLING\|CA
+0001d000: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
+0001d010: 2020 2020 2020 2027 736c 6565 7020 3132         'sleep 12
+0001d020: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+0001d030: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+0001d040: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+0001d050: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
+0001d060: 7265 7020 2243 414e 4345 4c4c 4544 2227  rep "CANCELLED"'
+0001d070: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+0001d080: 5465 7374 2063 616e 6365 6c6c 696e 6720  Test cancelling 
+0001d090: 7468 6520 7370 6f74 2063 6c75 7374 6572  the spot cluster
+0001d0a0: 2064 7572 696e 6720 7370 6f74 206a 6f62   during spot job
+0001d0b0: 2062 6569 6e67 2073 6574 7570 2e0a 2020   being setup..  
+0001d0c0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0001d0d0: 7370 6f74 206c 6175 6e63 6820 2d2d 636c  spot launch --cl
+0001d0e0: 6f75 6420 6763 7020 2d2d 7a6f 6e65 207b  oud gcp --zone {
+0001d0f0: 7a6f 6e65 7d20 2d6e 207b 6e61 6d65 7d2d  zone} -n {name}-
+0001d100: 3220 7465 7374 732f 7465 7374 5f79 616d  2 tests/test_yam
+0001d110: 6c73 2f74 6573 745f 6c6f 6e67 5f73 6574  ls/test_long_set
+0001d120: 7570 2e79 616d 6c20 202d 7920 2d64 272c  up.yaml  -y -d',
+0001d130: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0001d140: 6565 7020 3330 3027 2c0a 2020 2020 2020  eep 300',.      
+0001d150: 2020 2020 2020 5f53 504f 545f 4341 4e43        _SPOT_CANC
+0001d160: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
+0001d170: 6f62 5f6e 616d 653d 6627 7b6e 616d 657d  ob_name=f'{name}
+0001d180: 2d32 2729 2c0a 2020 2020 2020 2020 2020  -2'),.          
+0001d190: 2020 2773 6c65 6570 2035 272c 0a20 2020    'sleep 5',.   
+0001d1a0: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
+0001d1b0: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
+0001d1c0: 7265 7020 7b6e 616d 657d 2d32 207c 2068  rep {name}-2 | h
+0001d1d0: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
+0001d1e0: 4341 4e43 454c 4c49 4e47 5c7c 4341 4e43  CANCELLING\|CANC
+0001d1f0: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
+0001d200: 2020 2020 2027 736c 6565 7020 3132 3027       'sleep 120'
+0001d210: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001d220: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+0001d230: 547d 7c20 6772 6570 207b 6e61 6d65 7d2d  T}| grep {name}-
+0001d240: 3220 7c20 6865 6164 202d 6e31 207c 2067  2 | head -n1 | g
+0001d250: 7265 7020 2243 414e 4345 4c4c 4544 2227  rep "CANCELLED"'
+0001d260: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+0001d270: 5465 7374 2063 616e 6365 6c6c 6174 696f  Test cancellatio
+0001d280: 6e20 6475 7269 6e67 2073 706f 7420 6a6f  n during spot jo
+0001d290: 6220 6973 2072 6563 6f76 6572 696e 672e  b is recovering.
+0001d2a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0001d2b0: 6b79 2073 706f 7420 6c61 756e 6368 202d  ky spot launch -
+0001d2c0: 2d63 6c6f 7564 2067 6370 202d 2d7a 6f6e  -cloud gcp --zon
+0001d2d0: 6520 7b7a 6f6e 657d 202d 6e20 7b6e 616d  e {zone} -n {nam
+0001d2e0: 657d 2d33 2022 736c 6565 7020 3130 3030  e}-3 "sleep 1000
+0001d2f0: 2220 202d 7920 2d64 272c 0a20 2020 2020  "  -y -d',.     
+0001d300: 2020 2020 2020 2027 736c 6565 7020 3330         'sleep 30
+0001d310: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+0001d320: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+0001d330: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+0001d340: 7d2d 3320 7c20 6865 6164 202d 6e31 207c  }-3 | head -n1 |
+0001d350: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
+0001d360: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+0001d370: 5465 726d 696e 6174 6520 7468 6520 636c  Terminate the cl
+0001d380: 7573 7465 7220 6d61 6e75 616c 6c79 2e0a  uster manually..
+0001d390: 2020 2020 2020 2020 2020 2020 7465 726d              term
+0001d3a0: 696e 6174 655f 636d 642c 0a20 2020 2020  inate_cmd,.     
+0001d3b0: 2020 2020 2020 2027 736c 6565 7020 3830         'sleep 80
+0001d3c0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001d3d0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+0001d3e0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+0001d3f0: 2d33 207c 2068 6561 6420 2d6e 3120 7c20  -3 | head -n1 | 
+0001d400: 6772 6570 2022 5245 434f 5645 5249 4e47  grep "RECOVERING
+0001d410: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0001d420: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
+0001d430: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
+0001d440: 653d 6627 7b6e 616d 657d 2d33 2729 2c0a  e=f'{name}-3'),.
+0001d450: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0001d460: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
+0001d470: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
+0001d480: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001d490: 616d 657d 2d33 207c 2068 6561 6420 2d6e  ame}-3 | head -n
+0001d4a0: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
+0001d4b0: 4c49 4e47 5c7c 4341 4e43 454c 4c45 4422  LING\|CANCELLED"
+0001d4c0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+0001d4d0: 736c 6565 7020 3132 3027 2c0a 2020 2020  sleep 120',.    
+0001d4e0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+0001d4f0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+0001d500: 6570 207b 6e61 6d65 7d2d 3320 7c20 6865  ep {name}-3 | he
+0001d510: 6164 202d 6e31 207c 2067 7265 7020 2243  ad -n1 | grep "C
+0001d520: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
+0001d530: 2020 2020 2020 2020 2320 5468 6520 636c          # The cl
+0001d540: 7573 7465 7220 7368 6f75 6c64 2062 6520  uster should be 
+0001d550: 7465 726d 696e 6174 6564 2028 5354 4f50  terminated (STOP
+0001d560: 5049 4e47 2920 6166 7465 7220 6361 6e63  PING) after canc
+0001d570: 656c 6c61 7469 6f6e 2e20 5765 2064 6f6e  ellation. We don
+0001d580: 2774 2075 7365 2074 6865 2060 3d60 206f  't use the `=` o
+0001d590: 7065 7261 746f 7220 6865 7265 2062 6563  perator here bec
+0001d5a0: 6175 7365 0a20 2020 2020 2020 2020 2020  ause.           
+0001d5b0: 2023 2074 6865 7265 2063 616e 2062 6520   # there can be 
+0001d5c0: 6d75 6c74 6970 6c65 2056 4d20 7769 7468  multiple VM with
+0001d5d0: 2074 6865 2073 616d 6520 6e61 6d65 2064   the same name d
+0001d5e0: 7565 2074 6f20 7468 6520 7265 636f 7665  ue to the recove
+0001d5f0: 7279 2e0a 2020 2020 2020 2020 2020 2020  ry..            
+0001d600: 2866 2773 3d24 287b 7175 6572 795f 7374  (f's=$({query_st
+0001d610: 6174 655f 636d 647d 2920 2626 2065 6368  ate_cmd}) && ech
+0001d620: 6f20 2224 7322 2026 2620 6563 686f 3b20  o "$s" && echo; 
+0001d630: 5b5b 202d 7a20 2224 7322 205d 5d20 7c7c  [[ -z "$s" ]] ||
+0001d640: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+0001d650: 7020 2d76 202d 4520 2250 524f 5649 5349  p -v -E "PROVISI
+0001d660: 4f4e 494e 477c 5354 4147 494e 477c 5255  ONING|STAGING|RU
+0001d670: 4e4e 494e 477c 5245 5041 4952 494e 477c  NNING|REPAIRING|
+0001d680: 5445 524d 494e 4154 4544 7c53 5553 5045  TERMINATED|SUSPE
+0001d690: 4e44 494e 477c 5355 5350 454e 4445 447c  NDING|SUSPENDED|
+0001d6a0: 5355 5350 454e 4445 4422 270a 2020 2020  SUSPENDED"'.    
+0001d6b0: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
+0001d6c0: 2020 205d 2c0a 2020 2020 2020 2020 7469     ],.        ti
+0001d6d0: 6d65 6f75 743d 3235 202a 2036 3029 0a20  meout=25 * 60). 
+0001d6e0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+0001d6f0: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+0001d700: 2d2d 2d2d 2054 6573 7469 6e67 2073 746f  ---- Testing sto
+0001d710: 7261 6765 2066 6f72 206d 616e 6167 6564  rage for managed
+0001d720: 2073 706f 7420 2d2d 2d2d 2d2d 2d2d 2d2d   spot ----------
+0001d730: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+0001d740: 5f66 6c75 6964 7374 6163 6b20 2023 2046  _fluidstack  # F
+0001d750: 6c75 6964 7374 6163 6b20 646f 6573 206e  luidstack does n
+0001d760: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+0001d770: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+0001d780: 742e 6d61 726b 2e6e 6f5f 617a 7572 6520  t.mark.no_azure 
+0001d790: 2023 2041 7a75 7265 2064 6f65 7320 6e6f   # Azure does no
+0001d7a0: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
+0001d7b0: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
+0001d7c0: 2e6d 6172 6b2e 6e6f 5f6c 616d 6264 615f  .mark.no_lambda_
+0001d7d0: 636c 6f75 6420 2023 204c 616d 6264 6120  cloud  # Lambda 
+0001d7e0: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
+0001d7f0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+0001d800: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+0001d810: 726b 2e6e 6f5f 6962 6d20 2023 2049 424d  rk.no_ibm  # IBM
+0001d820: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
+0001d830: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
+0001d840: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+0001d850: 6172 6b2e 6e6f 5f70 6170 6572 7370 6163  ark.no_paperspac
+0001d860: 6520 2023 2050 6170 6572 7370 6163 6520  e  # Paperspace 
+0001d870: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+0001d880: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
+0001d890: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+0001d8a0: 7363 7020 2023 2053 4350 2064 6f65 7320  scp  # SCP does 
+0001d8b0: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+0001d8c0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+0001d8d0: 7374 2e6d 6172 6b2e 6e6f 5f6b 7562 6572  st.mark.no_kuber
+0001d8e0: 6e65 7465 7320 2023 204b 7562 6572 6e65  netes  # Kuberne
+0001d8f0: 7465 7320 646f 6573 206e 6f74 2068 6176  tes does not hav
+0001d900: 6520 6120 6e6f 7469 6f6e 206f 6620 7370  e a notion of sp
+0001d910: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
+0001d920: 7465 7374 2e6d 6172 6b2e 6d61 6e61 6765  test.mark.manage
+0001d930: 645f 7370 6f74 0a64 6566 2074 6573 745f  d_spot.def test_
+0001d940: 7370 6f74 5f73 746f 7261 6765 2867 656e  spot_storage(gen
+0001d950: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+0001d960: 3a0a 2020 2020 2222 2254 6573 7420 7374  :.    """Test st
+0001d970: 6f72 6167 6520 7769 7468 206d 616e 6167  orage with manag
+0001d980: 6564 2073 706f 7422 2222 0a20 2020 206e  ed spot""".    n
+0001d990: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+0001d9a0: 6572 5f6e 616d 6528 290a 2020 2020 7961  er_name().    ya
+0001d9b0: 6d6c 5f73 7472 203d 2070 6174 686c 6962  ml_str = pathlib
+0001d9c0: 2e50 6174 6828 0a20 2020 2020 2020 2027  .Path(.        '
+0001d9d0: 6578 616d 706c 6573 2f6d 616e 6167 6564  examples/managed
+0001d9e0: 5f73 706f 745f 7769 7468 5f73 746f 7261  _spot_with_stora
+0001d9f0: 6765 2e79 616d 6c27 292e 7265 6164 5f74  ge.yaml').read_t
+0001da00: 6578 7428 290a 2020 2020 7374 6f72 6167  ext().    storag
+0001da10: 655f 6e61 6d65 203d 2066 2773 6b79 2d74  e_name = f'sky-t
+0001da20: 6573 742d 7b69 6e74 2874 696d 652e 7469  est-{int(time.ti
+0001da30: 6d65 2829 297d 270a 0a20 2020 2023 2041  me())}'..    # A
+0001da40: 6c73 6f20 7065 7266 6f72 6d20 7265 6769  lso perform regi
+0001da50: 6f6e 2074 6573 7469 6e67 2066 6f72 2062  on testing for b
+0001da60: 7563 6b65 7420 6372 6561 7469 6f6e 2074  ucket creation t
+0001da70: 6f20 7661 6c69 6461 7465 2069 6620 6275  o validate if bu
+0001da80: 636b 6574 7320 6172 650a 2020 2020 2320  ckets are.    # 
+0001da90: 6372 6561 7465 6420 696e 2074 6865 2063  created in the c
+0001daa0: 6f72 7265 6374 2072 6567 696f 6e20 616e  orrect region an
+0001dab0: 6420 636f 7272 6563 746c 7920 6d6f 756e  d correctly moun
+0001dac0: 7465 6420 696e 2073 706f 7420 6a6f 6273  ted in spot jobs
+0001dad0: 2e0a 2020 2020 2320 486f 7765 7665 722c  ..    # However,
+0001dae0: 2077 6520 696e 6a65 6374 2074 6869 7320   we inject this 
+0001daf0: 7465 7374 696e 6720 6f6e 6c79 2066 6f72  testing only for
+0001db00: 2041 5753 2061 6e64 2047 4350 2073 696e   AWS and GCP sin
+0001db10: 6365 2074 6865 7920 6172 6520 7468 650a  ce they are the.
+0001db20: 2020 2020 2320 7375 7070 6f72 7465 6420      # supported 
+0001db30: 6f62 6a65 6374 2073 746f 7261 6765 2070  object storage p
+0001db40: 726f 7669 6465 7273 2069 6e20 536b 7950  roviders in SkyP
+0001db50: 696c 6f74 2e0a 2020 2020 7265 6769 6f6e  ilot..    region
+0001db60: 5f66 6c61 6720 3d20 2727 0a20 2020 2072  _flag = ''.    r
+0001db70: 6567 696f 6e5f 7661 6c69 6461 7469 6f6e  egion_validation
+0001db80: 5f63 6d64 203d 2027 7472 7565 270a 2020  _cmd = 'true'.  
+0001db90: 2020 6966 2067 656e 6572 6963 5f63 6c6f    if generic_clo
+0001dba0: 7564 203d 3d20 2761 7773 273a 0a20 2020  ud == 'aws':.   
+0001dbb0: 2020 2020 2072 6567 696f 6e20 3d20 2765       region = 'e
+0001dbc0: 752d 6365 6e74 7261 6c2d 3127 0a20 2020  u-central-1'.   
+0001dbd0: 2020 2020 2072 6567 696f 6e5f 666c 6167       region_flag
+0001dbe0: 203d 2066 2720 2d2d 7265 6769 6f6e 207b   = f' --region {
+0001dbf0: 7265 6769 6f6e 7d27 0a20 2020 2020 2020  region}'.       
+0001dc00: 2072 6567 696f 6e5f 636d 6420 3d20 5465   region_cmd = Te
+0001dc10: 7374 5374 6f72 6167 6557 6974 6843 7265  stStorageWithCre
+0001dc20: 6465 6e74 6961 6c73 2e63 6c69 5f72 6567  dentials.cli_reg
+0001dc30: 696f 6e5f 636d 6428 0a20 2020 2020 2020  ion_cmd(.       
+0001dc40: 2020 2020 2073 746f 7261 6765 5f6c 6962       storage_lib
+0001dc50: 2e53 746f 7265 5479 7065 2e53 332c 2073  .StoreType.S3, s
+0001dc60: 746f 7261 6765 5f6e 616d 6529 0a20 2020  torage_name).   
+0001dc70: 2020 2020 2072 6567 696f 6e5f 7661 6c69       region_vali
+0001dc80: 6461 7469 6f6e 5f63 6d64 203d 2066 277b  dation_cmd = f'{
+0001dc90: 7265 6769 6f6e 5f63 6d64 7d20 7c20 6772  region_cmd} | gr
+0001dca0: 6570 207b 7265 6769 6f6e 7d27 0a20 2020  ep {region}'.   
+0001dcb0: 2065 6c69 6620 6765 6e65 7269 635f 636c   elif generic_cl
+0001dcc0: 6f75 6420 3d3d 2027 6763 7027 3a0a 2020  oud == 'gcp':.  
+0001dcd0: 2020 2020 2020 7265 6769 6f6e 203d 2027        region = '
+0001dce0: 7573 2d77 6573 7432 270a 2020 2020 2020  us-west2'.      
+0001dcf0: 2020 7265 6769 6f6e 5f66 6c61 6720 3d20    region_flag = 
+0001dd00: 6627 202d 2d72 6567 696f 6e20 7b72 6567  f' --region {reg
+0001dd10: 696f 6e7d 270a 2020 2020 2020 2020 7265  ion}'.        re
+0001dd20: 6769 6f6e 5f63 6d64 203d 2054 6573 7453  gion_cmd = TestS
+0001dd30: 746f 7261 6765 5769 7468 4372 6564 656e  torageWithCreden
+0001dd40: 7469 616c 732e 636c 695f 7265 6769 6f6e  tials.cli_region
+0001dd50: 5f63 6d64 280a 2020 2020 2020 2020 2020  _cmd(.          
+0001dd60: 2020 7374 6f72 6167 655f 6c69 622e 5374    storage_lib.St
+0001dd70: 6f72 6554 7970 652e 4743 532c 2073 746f  oreType.GCS, sto
+0001dd80: 7261 6765 5f6e 616d 6529 0a20 2020 2020  rage_name).     
+0001dd90: 2020 2072 6567 696f 6e5f 7661 6c69 6461     region_valida
+0001dda0: 7469 6f6e 5f63 6d64 203d 2066 277b 7265  tion_cmd = f'{re
+0001ddb0: 6769 6f6e 5f63 6d64 7d20 7c20 6772 6570  gion_cmd} | grep
+0001ddc0: 207b 7265 6769 6f6e 7d27 0a0a 2020 2020   {region}'..    
+0001ddd0: 7961 6d6c 5f73 7472 203d 2079 616d 6c5f  yaml_str = yaml_
+0001dde0: 7374 722e 7265 706c 6163 6528 2773 6b79  str.replace('sky
+0001ddf0: 2d77 6f72 6b64 6972 2d7a 6877 7527 2c20  -workdir-zhwu', 
+0001de00: 7374 6f72 6167 655f 6e61 6d65 290a 2020  storage_name).  
+0001de10: 2020 7769 7468 2074 656d 7066 696c 652e    with tempfile.
+0001de20: 4e61 6d65 6454 656d 706f 7261 7279 4669  NamedTemporaryFi
+0001de30: 6c65 2873 7566 6669 783d 272e 7961 6d6c  le(suffix='.yaml
+0001de40: 272c 206d 6f64 653d 2777 2729 2061 7320  ', mode='w') as 
+0001de50: 663a 0a20 2020 2020 2020 2066 2e77 7269  f:.        f.wri
+0001de60: 7465 2879 616d 6c5f 7374 7229 0a20 2020  te(yaml_str).   
+0001de70: 2020 2020 2066 2e66 6c75 7368 2829 0a20       f.flush(). 
+0001de80: 2020 2020 2020 2066 696c 655f 7061 7468         file_path
+0001de90: 203d 2066 2e6e 616d 650a 2020 2020 2020   = f.name.      
+0001dea0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+0001deb0: 2020 2020 2020 2020 2020 2027 7370 6f74             'spot
+0001dec0: 5f73 746f 7261 6765 272c 0a20 2020 2020  _storage',.     
+0001ded0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+0001dee0: 2020 2020 2020 2020 202a 7374 6f72 6167           *storag
+0001def0: 655f 7365 7475 705f 636f 6d6d 616e 6473  e_setup_commands
+0001df00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001df10: 2020 6627 736b 7920 7370 6f74 206c 6175    f'sky spot lau
+0001df20: 6e63 6820 2d6e 207b 6e61 6d65 7d20 2d2d  nch -n {name} --
+0001df30: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
+0001df40: 6c6f 7564 7d7b 7265 6769 6f6e 5f66 6c61  loud}{region_fla
+0001df50: 677d 207b 6669 6c65 5f70 6174 687d 202d  g} {file_path} -
+0001df60: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
+0001df70: 2020 2020 7265 6769 6f6e 5f76 616c 6964      region_valid
+0001df80: 6174 696f 6e5f 636d 642c 2020 2320 4368  ation_cmd,  # Ch
+0001df90: 6563 6b20 6966 2074 6865 2062 7563 6b65  eck if the bucke
+0001dfa0: 7420 6973 2063 7265 6174 6564 2069 6e20  t is created in 
+0001dfb0: 7468 6520 636f 7272 6563 7420 7265 6769  the correct regi
+0001dfc0: 6f6e 0a20 2020 2020 2020 2020 2020 2020  on.             
+0001dfd0: 2020 2027 736c 6565 7020 3630 272c 2020     'sleep 60',  
+0001dfe0: 2320 5761 6974 2074 6865 2073 706f 7420  # Wait the spot 
+0001dff0: 7175 6575 6520 746f 2062 6520 7570 6461  queue to be upda
+0001e000: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
+0001e010: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
+0001e020: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+0001e030: 6e61 6d65 7d20 7c20 6772 6570 2053 5543  name} | grep SUC
+0001e040: 4345 4544 4544 272c 0a20 2020 2020 2020  CEEDED',.       
+0001e050: 2020 2020 2020 2020 2066 275b 2024 2861           f'[ $(a
+0001e060: 7773 2073 3361 7069 206c 6973 742d 6275  ws s3api list-bu
+0001e070: 636b 6574 7320 2d2d 7175 6572 7920 2242  ckets --query "B
+0001e080: 7563 6b65 7473 5b3f 636f 6e74 6169 6e73  uckets[?contains
+0001e090: 284e 616d 652c 205c 277b 7374 6f72 6167  (Name, \'{storag
+0001e0a0: 655f 6e61 6d65 7d5c 2729 5d2e 4e61 6d65  e_name}\')].Name
+0001e0b0: 2220 2d2d 6f75 7470 7574 2074 6578 7420  " --output text 
+0001e0c0: 7c20 7763 202d 6c29 202d 6571 2030 205d  | wc -l) -eq 0 ]
+0001e0d0: 270a 2020 2020 2020 2020 2020 2020 5d2c  '.            ],
+0001e0e0: 0a20 2020 2020 2020 2020 2020 205f 5350  .            _SP
+0001e0f0: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
+0001e100: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d6e  ormat(job_name=n
+0001e110: 616d 6529 2c0a 2020 2020 2020 2020 2020  ame),.          
+0001e120: 2020 2320 496e 6372 6561 7365 2074 696d    # Increase tim
+0001e130: 656f 7574 2073 696e 6365 2073 6b79 2073  eout since sky s
+0001e140: 706f 7420 7175 6575 6520 2d72 2063 616e  pot queue -r can
+0001e150: 2062 6520 626c 6f63 6b65 6420 6279 206f   be blocked by o
+0001e160: 7468 6572 2073 706f 7420 7465 7374 732e  ther spot tests.
+0001e170: 0a20 2020 2020 2020 2020 2020 2074 696d  .            tim
+0001e180: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
+0001e190: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0001e1a0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+0001e1b0: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
+0001e1c0: 2d20 5465 7374 696e 6720 7370 6f74 2054  - Testing spot T
+0001e1d0: 5055 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  PU ----------.@p
+0001e1e0: 7974 6573 742e 6d61 726b 2e67 6370 0a40  ytest.mark.gcp.@
+0001e1f0: 7079 7465 7374 2e6d 6172 6b2e 6d61 6e61  pytest.mark.mana
+0001e200: 6765 645f 7370 6f74 0a40 7079 7465 7374  ged_spot.@pytest
+0001e210: 2e6d 6172 6b2e 7470 750a 6465 6620 7465  .mark.tpu.def te
+0001e220: 7374 5f73 706f 745f 7470 7528 293a 0a20  st_spot_tpu():. 
+0001e230: 2020 2022 2222 5465 7374 206d 616e 6167     """Test manag
+0001e240: 6564 2073 706f 7420 6f6e 2054 5055 2e22  ed spot on TPU."
+0001e250: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
+0001e260: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+0001e270: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+0001e280: 7428 0a20 2020 2020 2020 2027 7465 7374  t(.        'test
+0001e290: 2d73 706f 742d 7470 7527 2c0a 2020 2020  -spot-tpu',.    
+0001e2a0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+0001e2b0: 2020 6627 736b 7920 7370 6f74 206c 6175    f'sky spot lau
+0001e2c0: 6e63 6820 2d6e 207b 6e61 6d65 7d20 6578  nch -n {name} ex
+0001e2d0: 616d 706c 6573 2f74 7075 2f74 7075 766d  amples/tpu/tpuvm
+0001e2e0: 5f6d 6e69 7374 2e79 616d 6c20 2d79 202d  _mnist.yaml -y -
+0001e2f0: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
+0001e300: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
+0001e310: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+0001e320: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+0001e330: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
+0001e340: 2d6e 3120 7c20 6772 6570 2053 5441 5254  -n1 | grep START
+0001e350: 494e 4727 2c0a 2020 2020 2020 2020 2020  ING',.          
+0001e360: 2020 2773 6c65 6570 2039 3030 272c 2020    'sleep 900',  
+0001e370: 2320 5450 5520 7461 6b65 7320 6120 7768  # TPU takes a wh
+0001e380: 696c 6520 746f 206c 6175 6e63 680a 2020  ile to launch.  
+0001e390: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
+0001e3a0: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
+0001e3b0: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
+0001e3c0: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
+0001e3d0: 554e 4e49 4e47 5c7c 5355 4343 4545 4445  UNNING\|SUCCEEDE
+0001e3e0: 4422 272c 0a20 2020 2020 2020 205d 2c0a  D"',.        ],.
+0001e3f0: 2020 2020 2020 2020 5f53 504f 545f 4341          _SPOT_CA
+0001e400: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
+0001e410: 286a 6f62 5f6e 616d 653d 6e61 6d65 292c  (job_name=name),
+0001e420: 0a20 2020 2020 2020 2023 2049 6e63 7265  .        # Incre
+0001e430: 6173 6520 7469 6d65 6f75 7420 7369 6e63  ase timeout sinc
+0001e440: 6520 736b 7920 7370 6f74 2071 7565 7565  e sky spot queue
+0001e450: 202d 7220 6361 6e20 6265 2062 6c6f 636b   -r can be block
+0001e460: 6564 2062 7920 6f74 6865 7220 7370 6f74  ed by other spot
+0001e470: 2074 6573 7473 2e0a 2020 2020 2020 2020   tests..        
+0001e480: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
+0001e490: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+0001e4a0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+0001e4b0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
+0001e4c0: 7469 6e67 2065 6e76 2066 6f72 2073 706f  ting env for spo
+0001e4d0: 7420 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  t ----------.@py
+0001e4e0: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
+0001e4f0: 6964 7374 6163 6b20 2023 2046 6c75 6964  idstack  # Fluid
+0001e500: 7374 6163 6b20 646f 6573 206e 6f74 2073  stack does not s
+0001e510: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+0001e520: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+0001e530: 726b 2e6e 6f5f 617a 7572 6520 2023 2041  rk.no_azure  # A
+0001e540: 7a75 7265 2064 6f65 7320 6e6f 7420 7375  zure does not su
+0001e550: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+0001e560: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+0001e570: 6b2e 6e6f 5f6c 616d 6264 615f 636c 6f75  k.no_lambda_clou
+0001e580: 6420 2023 204c 616d 6264 6120 436c 6f75  d  # Lambda Clou
+0001e590: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
+0001e5a0: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
+0001e5b0: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
+0001e5c0: 6f5f 6962 6d20 2023 2049 424d 2043 6c6f  o_ibm  # IBM Clo
+0001e5d0: 7564 2064 6f65 7320 6e6f 7420 7375 7070  ud does not supp
+0001e5e0: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
+0001e5f0: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
+0001e600: 6e6f 5f73 6370 2020 2320 5343 5020 646f  no_scp  # SCP do
+0001e610: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
+0001e620: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
+0001e630: 7974 6573 742e 6d61 726b 2e6e 6f5f 7061  ytest.mark.no_pa
+0001e640: 7065 7273 7061 6365 2020 2320 5061 7065  perspace  # Pape
+0001e650: 7273 7061 6365 2064 6f65 7320 6e6f 7420  rspace does not 
+0001e660: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
+0001e670: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+0001e680: 6172 6b2e 6e6f 5f6b 7562 6572 6e65 7465  ark.no_kubernete
+0001e690: 7320 2023 204b 7562 6572 6e65 7465 7320  s  # Kubernetes 
+0001e6a0: 646f 6573 206e 6f74 2068 6176 6520 6120  does not have a 
+0001e6b0: 6e6f 7469 6f6e 206f 6620 7370 6f74 2069  notion of spot i
+0001e6c0: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
+0001e6d0: 2e6d 6172 6b2e 6d61 6e61 6765 645f 7370  .mark.managed_sp
+0001e6e0: 6f74 0a64 6566 2074 6573 745f 7370 6f74  ot.def test_spot
+0001e6f0: 5f69 6e6c 696e 655f 656e 7628 6765 6e65  _inline_env(gene
+0001e700: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
+0001e710: 0a20 2020 2022 2222 5465 7374 2073 706f  .    """Test spo
+0001e720: 7420 656e 7622 2222 0a20 2020 206e 616d  t env""".    nam
+0001e730: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+0001e740: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+0001e750: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+0001e760: 2027 7465 7374 2d73 706f 742d 696e 6c69   'test-spot-inli
+0001e770: 6e65 2d65 6e76 272c 0a20 2020 2020 2020  ne-env',.       
+0001e780: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+0001e790: 2773 6b79 2073 706f 7420 6c61 756e 6368  'sky spot launch
+0001e7a0: 202d 6e20 7b6e 616d 657d 202d 7920 2d2d   -n {name} -y --
+0001e7b0: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
+0001e7c0: 6c6f 7564 7d20 2d2d 656e 7620 5445 5354  loud} --env TEST
+0001e7d0: 5f45 4e56 3d22 6865 6c6c 6f20 776f 726c  _ENV="hello worl
+0001e7e0: 6422 202d 2d20 2228 5b5b 2021 202d 7a20  d" -- "([[ ! -z 
+0001e7f0: 5c5c 225c 2454 4553 545f 454e 565c 5c22  \\"\$TEST_ENV\\"
+0001e800: 205d 5d20 2626 205b 5b20 2120 2d7a 205c   ]] && [[ ! -z \
+0001e810: 5c22 5c24 534b 5950 494c 4f54 5f4e 4f44  \"\$SKYPILOT_NOD
+0001e820: 455f 4950 535c 5c22 205d 5d20 2626 205b  E_IPS\\" ]] && [
+0001e830: 5b20 2120 2d7a 205c 5c22 5c24 534b 5950  [ ! -z \\"\$SKYP
+0001e840: 494c 4f54 5f4e 4f44 455f 5241 4e4b 5c5c  ILOT_NODE_RANK\\
+0001e850: 2220 5d5d 2920 7c7c 2065 7869 7420 3122  " ]]) || exit 1"
+0001e860: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+0001e870: 736c 6565 7020 3230 272c 0a20 2020 2020  sleep 20',.     
+0001e880: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+0001e890: 5155 4555 455f 5741 4954 7d20 7c20 6772  QUEUE_WAIT} | gr
+0001e8a0: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
+0001e8b0: 2053 5543 4345 4544 4544 272c 0a20 2020   SUCCEEDED',.   
+0001e8c0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+0001e8d0: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
+0001e8e0: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
+0001e8f0: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
+0001e900: 2023 2049 6e63 7265 6173 6520 7469 6d65   # Increase time
+0001e910: 6f75 7420 7369 6e63 6520 736b 7920 7370  out since sky sp
+0001e920: 6f74 2071 7565 7565 202d 7220 6361 6e20  ot queue -r can 
+0001e930: 6265 2062 6c6f 636b 6564 2062 7920 6f74  be blocked by ot
+0001e940: 6865 7220 7370 6f74 2074 6573 7473 2e0a  her spot tests..
+0001e950: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+0001e960: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
+0001e970: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+0001e980: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+0001e990: 2d2d 2d2d 2054 6573 7469 6e67 2065 6e76  ---- Testing env
+0001e9a0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 6465 6620   ----------.def 
+0001e9b0: 7465 7374 5f69 6e6c 696e 655f 656e 7628  test_inline_env(
+0001e9c0: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
+0001e9d0: 7472 293a 0a20 2020 2022 2222 5465 7374  tr):.    """Test
+0001e9e0: 2065 6e76 2222 220a 2020 2020 6e61 6d65   env""".    name
+0001e9f0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+0001ea00: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+0001ea10: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+0001ea20: 2774 6573 742d 696e 6c69 6e65 2d65 6e76  'test-inline-env
+0001ea30: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+0001ea40: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+0001ea50: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
+0001ea60: 2d79 202d 2d63 6c6f 7564 207b 6765 6e65  -y --cloud {gene
+0001ea70: 7269 635f 636c 6f75 647d 202d 2d65 6e76  ric_cloud} --env
+0001ea80: 2054 4553 545f 454e 563d 2268 656c 6c6f   TEST_ENV="hello
+0001ea90: 2077 6f72 6c64 2220 2d2d 2022 285b 5b20   world" -- "([[ 
+0001eaa0: 2120 2d7a 205c 5c22 5c24 5445 5354 5f45  ! -z \\"\$TEST_E
+0001eab0: 4e56 5c5c 2220 5d5d 2026 2620 5b5b 2021  NV\\" ]] && [[ !
+0001eac0: 202d 7a20 5c5c 225c 2453 4b59 5049 4c4f   -z \\"\$SKYPILO
+0001ead0: 545f 4e4f 4445 5f49 5053 5c5c 2220 5d5d  T_NODE_IPS\\" ]]
+0001eae0: 2026 2620 5b5b 2021 202d 7a20 5c5c 225c   && [[ ! -z \\"\
+0001eaf0: 2453 4b59 5049 4c4f 545f 4e4f 4445 5f52  $SKYPILOT_NODE_R
+0001eb00: 414e 4b5c 5c22 205d 5d29 207c 7c20 6578  ANK\\" ]]) || ex
+0001eb10: 6974 2031 2227 2c0a 2020 2020 2020 2020  it 1"',.        
+0001eb20: 2020 2020 2773 6c65 6570 2032 3027 2c0a      'sleep 20',.
+0001eb30: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0001eb40: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+0001eb50: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+0001eb60: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0001eb70: 6320 7b6e 616d 657d 202d 2d65 6e76 2054  c {name} --env T
+0001eb80: 4553 545f 454e 5632 3d22 7375 6363 6573  EST_ENV2="succes
+0001eb90: 7322 2022 285b 5b20 2120 2d7a 205c 5c22  s" "([[ ! -z \\"
+0001eba0: 5c24 5445 5354 5f45 4e56 325c 5c22 205d  \$TEST_ENV2\\" ]
+0001ebb0: 5d20 2626 205b 5b20 2120 2d7a 205c 5c22  ] && [[ ! -z \\"
+0001ebc0: 5c24 534b 5950 494c 4f54 5f4e 4f44 455f  \$SKYPILOT_NODE_
+0001ebd0: 4950 535c 5c22 205d 5d20 2626 205b 5b20  IPS\\" ]] && [[ 
+0001ebe0: 2120 2d7a 205c 5c22 5c24 534b 5950 494c  ! -z \\"\$SKYPIL
+0001ebf0: 4f54 5f4e 4f44 455f 5241 4e4b 5c5c 2220  OT_NODE_RANK\\" 
+0001ec00: 5d5d 2920 7c7c 2065 7869 7420 3122 272c  ]]) || exit 1"',
+0001ec10: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0001ec20: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
+0001ec30: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+0001ec40: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+0001ec50: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0001ec60: 6d65 7d27 2c0a 2020 2020 2020 2020 5f67  me}',.        _g
+0001ec70: 6574 5f74 696d 656f 7574 2867 656e 6572  et_timeout(gener
+0001ec80: 6963 5f63 6c6f 7564 292c 0a20 2020 2029  ic_cloud),.    )
+0001ec90: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+0001eca0: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+0001ecb0: 2d2d 2d2d 2d2d 2054 6573 7469 6e67 2065  ------ Testing e
+0001ecc0: 6e76 2066 696c 6520 2d2d 2d2d 2d2d 2d2d  nv file --------
+0001ecd0: 2d2d 0a64 6566 2074 6573 745f 696e 6c69  --.def test_inli
+0001ece0: 6e65 5f65 6e76 5f66 696c 6528 6765 6e65  ne_env_file(gene
+0001ecf0: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
+0001ed00: 0a20 2020 2022 2222 5465 7374 2065 6e76  .    """Test env
+0001ed10: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
+0001ed20: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+0001ed30: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+0001ed40: 7374 280a 2020 2020 2020 2020 2774 6573  st(.        'tes
+0001ed50: 742d 696e 6c69 6e65 2d65 6e76 2d66 696c  t-inline-env-fil
+0001ed60: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
+0001ed70: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0001ed80: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
+0001ed90: 202d 7920 2d2d 636c 6f75 6420 7b67 656e   -y --cloud {gen
+0001eda0: 6572 6963 5f63 6c6f 7564 7d20 2d2d 656e  eric_cloud} --en
+0001edb0: 7620 5445 5354 5f45 4e56 3d22 6865 6c6c  v TEST_ENV="hell
+0001edc0: 6f20 776f 726c 6422 202d 2d20 2228 5b5b  o world" -- "([[
+0001edd0: 2021 202d 7a20 5c5c 225c 2454 4553 545f   ! -z \\"\$TEST_
+0001ede0: 454e 565c 5c22 205d 5d20 2626 205b 5b20  ENV\\" ]] && [[ 
+0001edf0: 2120 2d7a 205c 5c22 5c24 534b 5950 494c  ! -z \\"\$SKYPIL
+0001ee00: 4f54 5f4e 4f44 455f 4950 535c 5c22 205d  OT_NODE_IPS\\" ]
+0001ee10: 5d20 2626 205b 5b20 2120 2d7a 205c 5c22  ] && [[ ! -z \\"
+0001ee20: 5c24 534b 5950 494c 4f54 5f4e 4f44 455f  \$SKYPILOT_NODE_
+0001ee30: 5241 4e4b 5c5c 2220 5d5d 2920 7c7c 2065  RANK\\" ]]) || e
+0001ee40: 7869 7420 3122 272c 0a20 2020 2020 2020  xit 1"',.       
+0001ee50: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+0001ee60: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+0001ee70: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+0001ee80: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+0001ee90: 7d20 2d2d 656e 762d 6669 6c65 2065 7861  } --env-file exa
+0001eea0: 6d70 6c65 732f 7361 6d70 6c65 5f64 6f74  mples/sample_dot
+0001eeb0: 656e 7620 2228 5b5b 2021 202d 7a20 5c5c  env "([[ ! -z \\
+0001eec0: 225c 2454 4553 545f 454e 5632 5c5c 2220  "\$TEST_ENV2\\" 
+0001eed0: 5d5d 2026 2620 5b5b 2021 202d 7a20 5c5c  ]] && [[ ! -z \\
+0001eee0: 225c 2453 4b59 5049 4c4f 545f 4e4f 4445  "\$SKYPILOT_NODE
+0001eef0: 5f49 5053 5c5c 2220 5d5d 2026 2620 5b5b  _IPS\\" ]] && [[
+0001ef00: 2021 202d 7a20 5c5c 225c 2453 4b59 5049   ! -z \\"\$SKYPI
+0001ef10: 4c4f 545f 4e4f 4445 5f52 414e 4b5c 5c22  LOT_NODE_RANK\\"
+0001ef20: 205d 5d29 207c 7c20 6578 6974 2031 2227   ]]) || exit 1"'
+0001ef30: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001ef40: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+0001ef50: 3220 2d2d 7374 6174 7573 272c 0a20 2020  2 --status',.   
+0001ef60: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+0001ef70: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+0001ef80: 616d 657d 272c 0a20 2020 2020 2020 205f  ame}',.        _
+0001ef90: 6765 745f 7469 6d65 6f75 7428 6765 6e65  get_timeout(gene
+0001efa0: 7269 635f 636c 6f75 6429 2c0a 2020 2020  ric_cloud),.    
+0001efb0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+0001efc0: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
+0001efd0: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
+0001efe0: 6375 7374 6f6d 2069 6d61 6765 202d 2d2d  custom image ---
+0001eff0: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
+0001f000: 6d61 726b 2e61 7773 0a64 6566 2074 6573  mark.aws.def tes
+0001f010: 745f 6177 735f 6375 7374 6f6d 5f69 6d61  t_aws_custom_ima
+0001f020: 6765 2829 3a0a 2020 2020 2222 2254 6573  ge():.    """Tes
+0001f030: 7420 4157 5320 6375 7374 6f6d 2069 6d61  t AWS custom ima
+0001f040: 6765 2222 220a 2020 2020 6e61 6d65 203d  ge""".    name =
+0001f050: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+0001f060: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+0001f070: 5465 7374 280a 2020 2020 2020 2020 2774  Test(.        't
+0001f080: 6573 742d 6177 732d 6375 7374 6f6d 2d69  est-aws-custom-i
+0001f090: 6d61 6765 272c 0a20 2020 2020 2020 205b  mage',.        [
+0001f0a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0001f0b0: 6b79 206c 6175 6e63 6820 2d63 207b 6e61  ky launch -c {na
+0001f0c0: 6d65 7d20 2d2d 7265 7472 792d 756e 7469  me} --retry-unti
+0001f0d0: 6c2d 7570 202d 7920 7465 7374 732f 7465  l-up -y tests/te
+0001f0e0: 7374 5f79 616d 6c73 2f74 6573 745f 6375  st_yamls/test_cu
+0001f0f0: 7374 6f6d 5f69 6d61 6765 2e79 616d 6c20  stom_image.yaml 
+0001f100: 2d2d 636c 6f75 6420 6177 7320 2d2d 7265  --cloud aws --re
+0001f110: 6769 6f6e 2075 732d 6561 7374 2d32 202d  gion us-east-2 -
+0001f120: 2d69 6d61 6765 2d69 6420 616d 692d 3036  -image-id ami-06
+0001f130: 3264 6464 3930 6662 3666 3832 3637 6127  2ddd90fb6f8267a'
+0001f140: 2c20 2023 204e 7669 6469 6120 696d 6167  ,  # Nvidia imag
+0001f150: 650a 2020 2020 2020 2020 2020 2020 6627  e.            f'
+0001f160: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+0001f170: 3120 2d2d 7374 6174 7573 272c 0a20 2020  1 --status',.   
+0001f180: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+0001f190: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+0001f1a0: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
+0001f1b0: 696d 656f 7574 3d33 3020 2a20 3630 2c0a  imeout=30 * 60,.
+0001f1c0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+0001f1d0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+0001f1e0: 7079 7465 7374 2e6d 6172 6b2e 6b75 6265  pytest.mark.kube
+0001f1f0: 726e 6574 6573 0a40 7079 7465 7374 2e6d  rnetes.@pytest.m
+0001f200: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
+0001f210: 0a20 2020 2022 696d 6167 655f 6964 222c  .    "image_id",
+0001f220: 0a20 2020 205b 0a20 2020 2020 2020 2022  .    [.        "
+0001f230: 646f 636b 6572 3a6e 7669 6469 612f 6375  docker:nvidia/cu
+0001f240: 6461 3a31 312e 382e 302d 6465 7665 6c2d  da:11.8.0-devel-
+0001f250: 7562 756e 7475 3138 2e30 3422 2c0a 2020  ubuntu18.04",.  
+0001f260: 2020 2020 2020 2264 6f63 6b65 723a 7562        "docker:ub
+0001f270: 756e 7475 3a31 382e 3034 222c 0a20 2020  untu:18.04",.   
+0001f280: 2020 2020 2023 2054 6573 7420 6c61 7465       # Test late
+0001f290: 7374 2069 6d61 6765 2077 6974 6820 7079  st image with py
+0001f2a0: 7468 6f6e 2033 2e31 3120 696e 7374 616c  thon 3.11 instal
+0001f2b0: 6c65 6420 6279 2064 6566 6175 6c74 2e0a  led by default..
+0001f2c0: 2020 2020 2020 2020 2320 446f 6573 206e          # Does n
+0001f2d0: 6f74 2077 6f72 6b20 666f 7220 7079 7468  ot work for pyth
+0001f2e0: 6f6e 2033 2e31 3220 6475 6520 746f 2072  on 3.12 due to r
+0001f2f0: 6179 2773 2072 6571 7569 7265 6d65 6e74  ay's requirement
+0001f300: 2066 6f72 2033 2e31 312e 0a20 2020 2020   for 3.11..     
+0001f310: 2020 2027 646f 636b 6572 3a63 6f6e 7469     'docker:conti
+0001f320: 6e75 756d 696f 2f6d 696e 6963 6f6e 6461  nuumio/miniconda
+0001f330: 333a 3234 2e31 2e32 2d30 272c 0a20 2020  3:24.1.2-0',.   
+0001f340: 205d 290a 6465 6620 7465 7374 5f6b 7562   ]).def test_kub
+0001f350: 6572 6e65 7465 735f 6375 7374 6f6d 5f69  ernetes_custom_i
+0001f360: 6d61 6765 2869 6d61 6765 5f69 6429 3a0a  mage(image_id):.
+0001f370: 2020 2020 2222 2254 6573 7420 4b75 6265      """Test Kube
+0001f380: 726e 6574 6573 2063 7573 746f 6d20 696d  rnetes custom im
+0001f390: 6167 6522 2222 0a20 2020 206e 616d 6520  age""".    name 
+0001f3a0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+0001f3b0: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+0001f3c0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+0001f3d0: 7465 7374 2d6b 7562 6572 6e65 7465 732d  test-kubernetes-
+0001f3e0: 6375 7374 6f6d 2d69 6d61 6765 272c 0a20  custom-image',. 
+0001f3f0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+0001f400: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+0001f410: 6820 2d63 207b 6e61 6d65 7d20 2d2d 7265  h -c {name} --re
+0001f420: 7472 792d 756e 7469 6c2d 7570 202d 7920  try-until-up -y 
+0001f430: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+0001f440: 2f74 6573 745f 6375 7374 6f6d 5f69 6d61  /test_custom_ima
+0001f450: 6765 2e79 616d 6c20 2d2d 636c 6f75 6420  ge.yaml --cloud 
+0001f460: 6b75 6265 726e 6574 6573 202d 2d69 6d61  kubernetes --ima
+0001f470: 6765 2d69 6420 7b69 6d61 6765 5f69 647d  ge-id {image_id}
+0001f480: 202d 2d72 6567 696f 6e20 4e6f 6e65 202d   --region None -
+0001f490: 2d67 7075 7320 5434 3a31 272c 0a20 2020  -gpus T4:1',.   
+0001f4a0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+0001f4b0: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
+0001f4c0: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+0001f4d0: 2020 2020 2320 5472 7920 6578 6563 2074      # Try exec t
+0001f4e0: 6f20 7275 6e20 6167 6169 6e20 616e 6420  o run again and 
+0001f4f0: 6368 6563 6b20 6966 2074 6865 206c 6f67  check if the log
+0001f500: 7320 6172 6520 7072 696e 7465 640a 2020  s are printed.  
+0001f510: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0001f520: 6578 6563 207b 6e61 6d65 7d20 7465 7374  exec {name} test
+0001f530: 732f 7465 7374 5f79 616d 6c73 2f74 6573  s/test_yamls/tes
+0001f540: 745f 6375 7374 6f6d 5f69 6d61 6765 2e79  t_custom_image.y
+0001f550: 616d 6c20 2d2d 636c 6f75 6420 6b75 6265  aml --cloud kube
+0001f560: 726e 6574 6573 202d 2d69 6d61 6765 2d69  rnetes --image-i
+0001f570: 6420 7b69 6d61 6765 5f69 647d 202d 2d72  d {image_id} --r
+0001f580: 6567 696f 6e20 4e6f 6e65 202d 2d67 7075  egion None --gpu
+0001f590: 7320 5434 3a31 207c 2067 7265 7020 2248  s T4:1 | grep "H
+0001f5a0: 656c 6c6f 2031 3030 2227 2c0a 2020 2020  ello 100"',.    
+0001f5b0: 2020 2020 2020 2020 2320 4d61 6b65 2073          # Make s
+0001f5c0: 7572 6520 7373 6820 6973 2077 6f72 6b69  ure ssh is worki
+0001f5d0: 6e67 2077 6974 6820 6375 7374 6f6d 2075  ng with custom u
+0001f5e0: 7365 726e 616d 650a 2020 2020 2020 2020  sername.        
+0001f5f0: 2020 2020 6627 7373 6820 7b6e 616d 657d      f'ssh {name}
+0001f600: 2065 6368 6f20 6869 207c 2067 7265 7020   echo hi | grep 
+0001f610: 6869 272c 0a20 2020 2020 2020 205d 2c0a  hi',.        ],.
+0001f620: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+0001f630: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+0001f640: 2020 2020 2020 2074 696d 656f 7574 3d33         timeout=3
+0001f650: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
+0001f660: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0001f670: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+0001f680: 6172 6b2e 736c 6f77 0a64 6566 2074 6573  ark.slow.def tes
+0001f690: 745f 617a 7572 655f 7374 6172 745f 7374  t_azure_start_st
+0001f6a0: 6f70 5f74 776f 5f6e 6f64 6573 2829 3a0a  op_two_nodes():.
+0001f6b0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+0001f6c0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+0001f6d0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+0001f6e0: 2020 2020 2020 2020 2761 7a75 7265 2d73          'azure-s
+0001f6f0: 7461 7274 2d73 746f 702d 7477 6f2d 6e6f  tart-stop-two-no
+0001f700: 6465 7327 2c0a 2020 2020 2020 2020 5b0a  des',.        [.
+0001f710: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0001f720: 7920 6c61 756e 6368 202d 2d6e 756d 2d6e  y launch --num-n
+0001f730: 6f64 6573 3d32 202d 7920 2d63 207b 6e61  odes=2 -y -c {na
+0001f740: 6d65 7d20 6578 616d 706c 6573 2f61 7a75  me} examples/azu
+0001f750: 7265 5f73 7461 7274 5f73 746f 702e 7961  re_start_stop.ya
+0001f760: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+0001f770: 2066 2773 6b79 2065 7865 6320 2d2d 6e75   f'sky exec --nu
+0001f780: 6d2d 6e6f 6465 733d 3220 7b6e 616d 657d  m-nodes=2 {name}
+0001f790: 2065 7861 6d70 6c65 732f 617a 7572 655f   examples/azure_
+0001f7a0: 7374 6172 745f 7374 6f70 2e79 616d 6c27  start_stop.yaml'
+0001f7b0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001f7c0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+0001f7d0: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
+0001f7e0: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
+0001f7f0: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
+0001f800: 2020 2020 2020 6627 736b 7920 7374 6f70        f'sky stop
+0001f810: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+0001f820: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+0001f830: 7461 7274 202d 7920 7b6e 616d 657d 272c  tart -y {name}',
+0001f840: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0001f850: 6b79 2065 7865 6320 2d2d 6e75 6d2d 6e6f  ky exec --num-no
+0001f860: 6465 733d 3220 7b6e 616d 657d 2065 7861  des=2 {name} exa
+0001f870: 6d70 6c65 732f 617a 7572 655f 7374 6172  mples/azure_star
+0001f880: 745f 7374 6f70 2e79 616d 6c27 2c0a 2020  t_stop.yaml',.  
+0001f890: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0001f8a0: 6c6f 6773 207b 6e61 6d65 7d20 3220 2d2d  logs {name} 2 --
+0001f8b0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+0001f8c0: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
+0001f8d0: 6564 6564 2e0a 2020 2020 2020 2020 5d2c  eded..        ],
+0001f8e0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+0001f8f0: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+0001f900: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+0001f910: 3330 202a 2036 302c 2020 2320 3330 206d  30 * 60,  # 30 m
+0001f920: 696e 7320 2028 6974 2074 616b 6573 2061  ins  (it takes a
+0001f930: 726f 756e 6420 7e32 3320 6d69 6e73 290a  round ~23 mins).
+0001f940: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+0001f950: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
+0001f960: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374   ---------- Test
+0001f970: 696e 6720 656e 7620 666f 7220 6469 736b  ing env for disk
+0001f980: 2074 6965 7220 2d2d 2d2d 2d2d 2d2d 2d2d   tier ----------
+0001f990: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
+0001f9a0: 730a 6465 6620 7465 7374 5f61 7773 5f64  s.def test_aws_d
+0001f9b0: 6973 6b5f 7469 6572 2829 3a0a 0a20 2020  isk_tier():..   
+0001f9c0: 2064 6566 205f 6765 745f 6177 735f 7175   def _get_aws_qu
+0001f9d0: 6572 795f 636f 6d6d 616e 6428 7265 6769  ery_command(regi
+0001f9e0: 6f6e 2c20 696e 7374 616e 6365 5f69 642c  on, instance_id,
+0001f9f0: 2066 6965 6c64 2c20 6578 7065 6374 6564   field, expected
+0001fa00: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+0001fa10: 6e20 2866 2761 7773 2065 6332 2064 6573  n (f'aws ec2 des
+0001fa20: 6372 6962 652d 766f 6c75 6d65 7320 2d2d  cribe-volumes --
+0001fa30: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
+0001fa40: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0001fa50: 2020 6627 2d2d 6669 6c74 6572 7320 4e61    f'--filters Na
+0001fa60: 6d65 3d61 7474 6163 686d 656e 742e 696e  me=attachment.in
+0001fa70: 7374 616e 6365 2d69 642c 5661 6c75 6573  stance-id,Values
+0001fa80: 3d7b 696e 7374 616e 6365 5f69 647d 2027  ={instance_id} '
+0001fa90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001faa0: 2066 272d 2d71 7565 7279 2056 6f6c 756d   f'--query Volum
+0001fab0: 6573 5b2a 5d2e 7b66 6965 6c64 7d20 7c20  es[*].{field} | 
+0001fac0: 6772 6570 207b 6578 7065 6374 6564 7d20  grep {expected} 
+0001fad0: 3b20 2729 0a0a 2020 2020 666f 7220 6469  ; ')..    for di
+0001fae0: 736b 5f74 6965 7220 696e 206c 6973 7428  sk_tier in list(
+0001faf0: 7265 736f 7572 6365 735f 7574 696c 732e  resources_utils.
+0001fb00: 4469 736b 5469 6572 293a 0a20 2020 2020  DiskTier):.     
+0001fb10: 2020 2073 7065 6373 203d 2041 5753 2e5f     specs = AWS._
+0001fb20: 6765 745f 6469 736b 5f73 7065 6373 2864  get_disk_specs(d
+0001fb30: 6973 6b5f 7469 6572 290a 2020 2020 2020  isk_tier).      
+0001fb40: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+0001fb50: 7573 7465 725f 6e61 6d65 2829 202b 2027  uster_name() + '
+0001fb60: 2d27 202b 2064 6973 6b5f 7469 6572 2e76  -' + disk_tier.v
+0001fb70: 616c 7565 0a20 2020 2020 2020 206e 616d  alue.        nam
+0001fb80: 655f 6f6e 5f63 6c6f 7564 203d 2063 6f6d  e_on_cloud = com
+0001fb90: 6d6f 6e5f 7574 696c 732e 6d61 6b65 5f63  mon_utils.make_c
+0001fba0: 6c75 7374 6572 5f6e 616d 655f 6f6e 5f63  luster_name_on_c
+0001fbb0: 6c6f 7564 280a 2020 2020 2020 2020 2020  loud(.          
+0001fbc0: 2020 6e61 6d65 2c20 736b 792e 4157 532e    name, sky.AWS.
+0001fbd0: 6d61 785f 636c 7573 7465 725f 6e61 6d65  max_cluster_name
+0001fbe0: 5f6c 656e 6774 6828 2929 0a20 2020 2020  _length()).     
+0001fbf0: 2020 2072 6567 696f 6e20 3d20 2775 732d     region = 'us-
+0001fc00: 6561 7374 2d32 270a 2020 2020 2020 2020  east-2'.        
+0001fc10: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+0001fc20: 2020 2020 2020 2020 2027 6177 732d 6469           'aws-di
+0001fc30: 736b 2d74 6965 722d 2720 2b20 6469 736b  sk-tier-' + disk
+0001fc40: 5f74 6965 722e 7661 6c75 652c 0a20 2020  _tier.value,.   
+0001fc50: 2020 2020 2020 2020 205b 0a20 2020 2020           [.     
+0001fc60: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001fc70: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+0001fc80: 616d 657d 202d 2d63 6c6f 7564 2061 7773  ame} --cloud aws
+0001fc90: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+0001fca0: 6e7d 2027 0a20 2020 2020 2020 2020 2020  n} '.           
+0001fcb0: 2020 2020 2066 272d 2d64 6973 6b2d 7469       f'--disk-ti
+0001fcc0: 6572 207b 6469 736b 5f74 6965 722e 7661  er {disk_tier.va
+0001fcd0: 6c75 657d 2065 6368 6f20 2268 656c 6c6f  lue} echo "hello
+0001fce0: 2073 6b79 2227 2c0a 2020 2020 2020 2020   sky"',.        
+0001fcf0: 2020 2020 2020 2020 6627 6964 3d60 6177          f'id=`aw
+0001fd00: 7320 6563 3220 6465 7363 7269 6265 2d69  s ec2 describe-i
+0001fd10: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
+0001fd20: 6e20 7b72 6567 696f 6e7d 202d 2d66 696c  n {region} --fil
+0001fd30: 7465 7273 2027 0a20 2020 2020 2020 2020  ters '.         
+0001fd40: 2020 2020 2020 2066 274e 616d 653d 7461         f'Name=ta
+0001fd50: 673a 7261 792d 636c 7573 7465 722d 6e61  g:ray-cluster-na
+0001fd60: 6d65 2c56 616c 7565 733d 7b6e 616d 655f  me,Values={name_
+0001fd70: 6f6e 5f63 6c6f 7564 7d20 2d2d 7175 6572  on_cloud} --quer
+0001fd80: 7920 270a 2020 2020 2020 2020 2020 2020  y '.            
+0001fd90: 2020 2020 6627 5265 7365 7276 6174 696f      f'Reservatio
+0001fda0: 6e73 5b5d 2e49 6e73 7461 6e63 6573 5b5d  ns[].Instances[]
+0001fdb0: 2e49 6e73 7461 6e63 6549 6420 2d2d 6f75  .InstanceId --ou
+0001fdc0: 7470 7574 2074 6578 7460 3b20 2720 2b0a  tput text`; ' +.
+0001fdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fde0: 5f67 6574 5f61 7773 5f71 7565 7279 5f63  _get_aws_query_c
+0001fdf0: 6f6d 6d61 6e64 2872 6567 696f 6e2c 2027  ommand(region, '
+0001fe00: 2469 6427 2c20 2756 6f6c 756d 6554 7970  $id', 'VolumeTyp
+0001fe10: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
+0001fe20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fe30: 2020 2020 2020 2020 2020 2073 7065 6373             specs
+0001fe40: 5b27 6469 736b 5f74 6965 7227 5d29 202b  ['disk_tier']) +
+0001fe50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001fe60: 2028 2727 2069 6620 6469 736b 5f74 6965   ('' if disk_tie
+0001fe70: 7220 3d3d 2072 6573 6f75 7263 6573 5f75  r == resources_u
+0001fe80: 7469 6c73 2e44 6973 6b54 6965 722e 4c4f  tils.DiskTier.LO
+0001fe90: 5720 656c 7365 0a20 2020 2020 2020 2020  W else.         
+0001fea0: 2020 2020 2020 2020 285f 6765 745f 6177          (_get_aw
+0001feb0: 735f 7175 6572 795f 636f 6d6d 616e 6428  s_query_command(
+0001fec0: 7265 6769 6f6e 2c20 2724 6964 272c 2027  region, '$id', '
+0001fed0: 496f 7073 272c 0a20 2020 2020 2020 2020  Iops',.         
+0001fee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ff00: 7370 6563 735b 2764 6973 6b5f 696f 7073  specs['disk_iops
+0001ff10: 275d 2920 2b0a 2020 2020 2020 2020 2020  ']) +.          
+0001ff20: 2020 2020 2020 2020 5f67 6574 5f61 7773          _get_aws
+0001ff30: 5f71 7565 7279 5f63 6f6d 6d61 6e64 2872  _query_command(r
+0001ff40: 6567 696f 6e2c 2027 2469 6427 2c20 2754  egion, '$id', 'T
+0001ff50: 6872 6f75 6768 7075 7427 2c0a 2020 2020  hroughput',.    
+0001ff60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ff70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ff80: 2020 2020 2073 7065 6373 5b27 6469 736b       specs['disk
+0001ff90: 5f74 6872 6f75 6768 7075 7427 5d29 2929  _throughput'])))
+0001ffa0: 2c0a 2020 2020 2020 2020 2020 2020 5d2c  ,.            ],
+0001ffb0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0001ffc0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+0001ffd0: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+0001ffe0: 7469 6d65 6f75 743d 3130 202a 2036 302c  timeout=10 * 60,
+0001fff0: 2020 2320 3130 206d 696e 7320 2028 6974    # 10 mins  (it
+00020000: 2074 616b 6573 2061 726f 756e 6420 7e36   takes around ~6
+00020010: 206d 696e 7329 0a20 2020 2020 2020 2029   mins).        )
+00020020: 0a20 2020 2020 2020 2072 756e 5f6f 6e65  .        run_one
+00020030: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+00020040: 7974 6573 742e 6d61 726b 2e67 6370 0a64  ytest.mark.gcp.d
+00020050: 6566 2074 6573 745f 6763 705f 6469 736b  ef test_gcp_disk
+00020060: 5f74 6965 7228 293a 0a20 2020 2066 6f72  _tier():.    for
+00020070: 2064 6973 6b5f 7469 6572 2069 6e20 6c69   disk_tier in li
+00020080: 7374 2872 6573 6f75 7263 6573 5f75 7469  st(resources_uti
+00020090: 6c73 2e44 6973 6b54 6965 7229 3a0a 2020  ls.DiskTier):.  
+000200a0: 2020 2020 2020 7479 7065 203d 2047 4350        type = GCP
+000200b0: 2e5f 6765 745f 6469 736b 5f74 7970 6528  ._get_disk_type(
+000200c0: 6469 736b 5f74 6965 7229 0a20 2020 2020  disk_tier).     
+000200d0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+000200e0: 6c75 7374 6572 5f6e 616d 6528 2920 2b20  luster_name() + 
+000200f0: 272d 2720 2b20 6469 736b 5f74 6965 722e  '-' + disk_tier.
+00020100: 7661 6c75 650a 2020 2020 2020 2020 6e61  value.        na
+00020110: 6d65 5f6f 6e5f 636c 6f75 6420 3d20 636f  me_on_cloud = co
+00020120: 6d6d 6f6e 5f75 7469 6c73 2e6d 616b 655f  mmon_utils.make_
+00020130: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
+00020140: 636c 6f75 6428 0a20 2020 2020 2020 2020  cloud(.         
+00020150: 2020 206e 616d 652c 2073 6b79 2e47 4350     name, sky.GCP
+00020160: 2e6d 6178 5f63 6c75 7374 6572 5f6e 616d  .max_cluster_nam
+00020170: 655f 6c65 6e67 7468 2829 290a 2020 2020  e_length()).    
+00020180: 2020 2020 7265 6769 6f6e 203d 2027 7573      region = 'us
+00020190: 2d77 6573 7432 270a 2020 2020 2020 2020  -west2'.        
+000201a0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+000201b0: 2020 2020 2020 2020 2027 6763 702d 6469           'gcp-di
+000201c0: 736b 2d74 6965 722d 2720 2b20 6469 736b  sk-tier-' + disk
+000201d0: 5f74 6965 722e 7661 6c75 652c 0a20 2020  _tier.value,.   
+000201e0: 2020 2020 2020 2020 205b 0a20 2020 2020           [.     
+000201f0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00020200: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+00020210: 616d 657d 202d 2d63 6c6f 7564 2067 6370  ame} --cloud gcp
+00020220: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+00020230: 6e7d 2027 0a20 2020 2020 2020 2020 2020  n} '.           
+00020240: 2020 2020 2066 272d 2d64 6973 6b2d 7469       f'--disk-ti
+00020250: 6572 207b 6469 736b 5f74 6965 722e 7661  er {disk_tier.va
+00020260: 6c75 657d 2065 6368 6f20 2268 656c 6c6f  lue} echo "hello
+00020270: 2073 6b79 2227 2c0a 2020 2020 2020 2020   sky"',.        
+00020280: 2020 2020 2020 2020 6627 6e61 6d65 3d60          f'name=`
+00020290: 6763 6c6f 7564 2063 6f6d 7075 7465 2069  gcloud compute i
+000202a0: 6e73 7461 6e63 6573 206c 6973 7420 2d2d  nstances list --
+000202b0: 6669 6c74 6572 3d27 0a20 2020 2020 2020  filter='.       
+000202c0: 2020 2020 2020 2020 2066 2722 6c61 6265           f'"labe
+000202d0: 6c73 2e72 6179 2d63 6c75 7374 6572 2d6e  ls.ray-cluster-n
+000202e0: 616d 653a 7b6e 616d 655f 6f6e 5f63 6c6f  ame:{name_on_clo
+000202f0: 7564 7d22 2027 0a20 2020 2020 2020 2020  ud}" '.         
+00020300: 2020 2020 2020 2027 2d2d 666f 726d 6174         '--format
+00020310: 3d22 7661 6c75 6528 6e61 6d65 2922 603b  ="value(name)"`;
+00020320: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00020330: 2020 2066 2767 636c 6f75 6420 636f 6d70     f'gcloud comp
+00020340: 7574 6520 6469 736b 7320 6c69 7374 202d  ute disks list -
+00020350: 2d66 696c 7465 723d 226e 616d 653d 246e  -filter="name=$n
+00020360: 616d 6522 2027 0a20 2020 2020 2020 2020  ame" '.         
+00020370: 2020 2020 2020 2066 272d 2d66 6f72 6d61         f'--forma
+00020380: 743d 2276 616c 7565 2874 7970 6529 2220  t="value(type)" 
+00020390: 7c20 6772 6570 207b 7479 7065 7d20 270a  | grep {type} '.
+000203a0: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
+000203b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000203c0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+000203d0: 2c0a 2020 2020 2020 2020 2020 2020 7469  ,.            ti
+000203e0: 6d65 6f75 743d 3620 2a20 3630 2c20 2023  meout=6 * 60,  #
+000203f0: 2036 206d 696e 7320 2028 6974 2074 616b   6 mins  (it tak
+00020400: 6573 2061 726f 756e 6420 7e33 206d 696e  es around ~3 min
+00020410: 7329 0a20 2020 2020 2020 2029 0a20 2020  s).        ).   
+00020420: 2020 2020 2072 756e 5f6f 6e65 5f74 6573       run_one_tes
+00020430: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00020440: 742e 6d61 726b 2e61 7a75 7265 0a64 6566  t.mark.azure.def
+00020450: 2074 6573 745f 617a 7572 655f 6469 736b   test_azure_disk
+00020460: 5f74 6965 7228 293a 0a20 2020 2066 6f72  _tier():.    for
+00020470: 2064 6973 6b5f 7469 6572 2069 6e20 6c69   disk_tier in li
+00020480: 7374 2872 6573 6f75 7263 6573 5f75 7469  st(resources_uti
+00020490: 6c73 2e44 6973 6b54 6965 7229 3a0a 2020  ls.DiskTier):.  
+000204a0: 2020 2020 2020 6966 2064 6973 6b5f 7469        if disk_ti
+000204b0: 6572 203d 3d20 7265 736f 7572 6365 735f  er == resources_
+000204c0: 7574 696c 732e 4469 736b 5469 6572 2e48  utils.DiskTier.H
+000204d0: 4947 483a 0a20 2020 2020 2020 2020 2020  IGH:.           
+000204e0: 2023 2041 7a75 7265 2064 6f65 7320 6e6f   # Azure does no
+000204f0: 7420 7375 7070 6f72 7420 6869 6768 2064  t support high d
+00020500: 6973 6b20 7469 6572 2e0a 2020 2020 2020  isk tier..      
+00020510: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+00020520: 2020 2020 2020 2074 7970 6520 3d20 417a         type = Az
+00020530: 7572 652e 5f67 6574 5f64 6973 6b5f 7479  ure._get_disk_ty
+00020540: 7065 2864 6973 6b5f 7469 6572 290a 2020  pe(disk_tier).  
+00020550: 2020 2020 2020 6e61 6d65 203d 205f 6765        name = _ge
+00020560: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00020570: 202b 2027 2d27 202b 2064 6973 6b5f 7469   + '-' + disk_ti
+00020580: 6572 2e76 616c 7565 0a20 2020 2020 2020  er.value.       
+00020590: 206e 616d 655f 6f6e 5f63 6c6f 7564 203d   name_on_cloud =
+000205a0: 2063 6f6d 6d6f 6e5f 7574 696c 732e 6d61   common_utils.ma
+000205b0: 6b65 5f63 6c75 7374 6572 5f6e 616d 655f  ke_cluster_name_
+000205c0: 6f6e 5f63 6c6f 7564 280a 2020 2020 2020  on_cloud(.      
+000205d0: 2020 2020 2020 6e61 6d65 2c20 736b 792e        name, sky.
+000205e0: 417a 7572 652e 6d61 785f 636c 7573 7465  Azure.max_cluste
+000205f0: 725f 6e61 6d65 5f6c 656e 6774 6828 2929  r_name_length())
+00020600: 0a20 2020 2020 2020 2072 6567 696f 6e20  .        region 
+00020610: 3d20 2777 6573 7475 7332 270a 2020 2020  = 'westus2'.    
+00020620: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00020630: 0a20 2020 2020 2020 2020 2020 2027 617a  .            'az
+00020640: 7572 652d 6469 736b 2d74 6965 722d 2720  ure-disk-tier-' 
+00020650: 2b20 6469 736b 5f74 6965 722e 7661 6c75  + disk_tier.valu
+00020660: 652c 0a20 2020 2020 2020 2020 2020 205b  e,.            [
+00020670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020680: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00020690: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
+000206a0: 7564 2061 7a75 7265 202d 2d72 6567 696f  ud azure --regio
+000206b0: 6e20 7b72 6567 696f 6e7d 2027 0a20 2020  n {region} '.   
+000206c0: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
+000206d0: 2d64 6973 6b2d 7469 6572 207b 6469 736b  -disk-tier {disk
+000206e0: 5f74 6965 722e 7661 6c75 657d 2065 6368  _tier.value} ech
+000206f0: 6f20 2268 656c 6c6f 2073 6b79 2227 2c0a  o "hello sky"',.
+00020700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020710: 6627 617a 2072 6573 6f75 7263 6520 6c69  f'az resource li
+00020720: 7374 202d 2d74 6167 2072 6179 2d63 6c75  st --tag ray-clu
+00020730: 7374 6572 2d6e 616d 653d 7b6e 616d 655f  ster-name={name_
+00020740: 6f6e 5f63 6c6f 7564 7d20 2d2d 7175 6572  on_cloud} --quer
+00020750: 7920 270a 2020 2020 2020 2020 2020 2020  y '.            
+00020760: 2020 2020 6627 225b 3f74 7970 653d 3d5c      f'"[?type==\
+00020770: 274d 6963 726f 736f 6674 2e43 6f6d 7075  'Microsoft.Compu
+00020780: 7465 2f64 6973 6b73 5c27 5d2e 736b 752e  te/disks\'].sku.
+00020790: 6e61 6d65 2220 270a 2020 2020 2020 2020  name" '.        
+000207a0: 2020 2020 2020 2020 6627 2d2d 6f75 7470          f'--outp
+000207b0: 7574 2074 7376 207c 2067 7265 7020 7b74  ut tsv | grep {t
+000207c0: 7970 657d 270a 2020 2020 2020 2020 2020  ype}'.          
+000207d0: 2020 5d2c 0a20 2020 2020 2020 2020 2020    ],.           
+000207e0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+000207f0: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
+00020800: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
+00020810: 2036 302c 2020 2320 3230 206d 696e 7320   60,  # 20 mins 
+00020820: 2028 6974 2074 616b 6573 2061 726f 756e   (it takes aroun
+00020830: 6420 7e31 3220 6d69 6e73 290a 2020 2020  d ~12 mins).    
+00020840: 2020 2020 290a 2020 2020 2020 2020 7275      ).        ru
+00020850: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00020860: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00020870: 617a 7572 650a 6465 6620 7465 7374 5f61  azure.def test_a
+00020880: 7a75 7265 5f62 6573 745f 7469 6572 5f66  zure_best_tier_f
+00020890: 6169 6c6f 7665 7228 293a 0a20 2020 2074  ailover():.    t
+000208a0: 7970 6520 3d20 417a 7572 652e 5f67 6574  ype = Azure._get
+000208b0: 5f64 6973 6b5f 7479 7065 2872 6573 6f75  _disk_type(resou
+000208c0: 7263 6573 5f75 7469 6c73 2e44 6973 6b54  rces_utils.DiskT
+000208d0: 6965 722e 4c4f 5729 0a20 2020 206e 616d  ier.LOW).    nam
+000208e0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+000208f0: 5f6e 616d 6528 290a 2020 2020 6e61 6d65  _name().    name
+00020900: 5f6f 6e5f 636c 6f75 6420 3d20 636f 6d6d  _on_cloud = comm
+00020910: 6f6e 5f75 7469 6c73 2e6d 616b 655f 636c  on_utils.make_cl
+00020920: 7573 7465 725f 6e61 6d65 5f6f 6e5f 636c  uster_name_on_cl
+00020930: 6f75 6428 0a20 2020 2020 2020 206e 616d  oud(.        nam
+00020940: 652c 2073 6b79 2e41 7a75 7265 2e6d 6178  e, sky.Azure.max
+00020950: 5f63 6c75 7374 6572 5f6e 616d 655f 6c65  _cluster_name_le
+00020960: 6e67 7468 2829 290a 2020 2020 7265 6769  ngth()).    regi
+00020970: 6f6e 203d 2027 7765 7374 7573 3227 0a20  on = 'westus2'. 
+00020980: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00020990: 2020 2020 2020 2020 2761 7a75 7265 2d62          'azure-b
+000209a0: 6573 742d 7469 6572 2d66 6169 6c6f 7665  est-tier-failove
+000209b0: 7227 2c0a 2020 2020 2020 2020 5b0a 2020  r',.        [.  
+000209c0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000209d0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+000209e0: 6d65 7d20 2d2d 636c 6f75 6420 617a 7572  me} --cloud azur
+000209f0: 6520 2d2d 7265 6769 6f6e 207b 7265 6769  e --region {regi
+00020a00: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
+00020a10: 2020 6627 2d2d 6469 736b 2d74 6965 7220    f'--disk-tier 
+00020a20: 6265 7374 202d 2d69 6e73 7461 6e63 652d  best --instance-
+00020a30: 7479 7065 2053 7461 6e64 6172 645f 4438  type Standard_D8
+00020a40: 5f76 3520 6563 686f 2022 6865 6c6c 6f20  _v5 echo "hello 
+00020a50: 736b 7922 272c 0a20 2020 2020 2020 2020  sky"',.         
+00020a60: 2020 2066 2761 7a20 7265 736f 7572 6365     f'az resource
+00020a70: 206c 6973 7420 2d2d 7461 6720 7261 792d   list --tag ray-
+00020a80: 636c 7573 7465 722d 6e61 6d65 3d7b 6e61  cluster-name={na
+00020a90: 6d65 5f6f 6e5f 636c 6f75 647d 202d 2d71  me_on_cloud} --q
+00020aa0: 7565 7279 2027 0a20 2020 2020 2020 2020  uery '.         
+00020ab0: 2020 2066 2722 5b3f 7479 7065 3d3d 5c27     f'"[?type==\'
+00020ac0: 4d69 6372 6f73 6f66 742e 436f 6d70 7574  Microsoft.Comput
+00020ad0: 652f 6469 736b 735c 275d 2e73 6b75 2e6e  e/disks\'].sku.n
+00020ae0: 616d 6522 2027 0a20 2020 2020 2020 2020  ame" '.         
+00020af0: 2020 2066 272d 2d6f 7574 7075 7420 7473     f'--output ts
+00020b00: 7620 7c20 6772 6570 207b 7479 7065 7d27  v | grep {type}'
+00020b10: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00020b20: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+00020b30: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+00020b40: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
+00020b50: 2036 302c 2020 2320 3230 206d 696e 7320   60,  # 20 mins 
+00020b60: 2028 6974 2074 616b 6573 2061 726f 756e   (it takes aroun
+00020b70: 6420 7e31 3220 6d69 6e73 290a 2020 2020  d ~12 mins).    
+00020b80: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00020b90: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
+00020ba0: 2d2d 2d20 5465 7374 696e 6720 5a65 726f  --- Testing Zero
+00020bb0: 2051 756f 7461 2046 6169 6c6f 7665 7220   Quota Failover 
+00020bc0: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
+00020bd0: 6172 6b2e 6177 730a 6465 6620 7465 7374  ark.aws.def test
+00020be0: 5f61 7773 5f7a 6572 6f5f 7175 6f74 615f  _aws_zero_quota_
+00020bf0: 6661 696c 6f76 6572 2829 3a0a 0a20 2020  failover():..   
+00020c00: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+00020c10: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+00020c20: 7265 6769 6f6e 203d 2067 6574 5f61 7773  region = get_aws
+00020c30: 5f72 6567 696f 6e5f 666f 725f 7175 6f74  _region_for_quot
+00020c40: 615f 6661 696c 6f76 6572 2829 0a0a 2020  a_failover()..  
+00020c50: 2020 6966 206e 6f74 2072 6567 696f 6e3a    if not region:
+00020c60: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
+00020c70: 7866 6169 6c28 0a20 2020 2020 2020 2020  xfail(.         
+00020c80: 2020 2027 556e 6162 6c65 2074 6f20 7465     'Unable to te
+00020c90: 7374 207a 6572 6f20 7175 6f74 6120 6661  st zero quota fa
+00020ca0: 696c 6f76 6572 206f 7074 696d 697a 6174  ilover optimizat
+00020cb0: 696f 6e20 e280 9420 7175 6f74 6173 2027  ion ... quotas '
+00020cc0: 0a20 2020 2020 2020 2020 2020 2027 666f  .            'fo
+00020cd0: 7220 4543 3220 5033 2069 6e73 7461 6e63  r EC2 P3 instanc
+00020ce0: 6573 2077 6572 6520 666f 756e 6420 6f6e  es were found on
+00020cf0: 2061 6c6c 2041 5753 2072 6567 696f 6e73   all AWS regions
+00020d00: 2e20 4973 2074 6869 7320 270a 2020 2020  . Is this '.    
+00020d10: 2020 2020 2020 2020 2765 7870 6563 7465          'expecte
+00020d20: 6420 666f 7220 796f 7572 2061 6363 6f75  d for your accou
+00020d30: 6e74 3f27 290a 2020 2020 2020 2020 7265  nt?').        re
+00020d40: 7475 726e 0a0a 2020 2020 7465 7374 203d  turn..    test =
+00020d50: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+00020d60: 6177 732d 7a65 726f 2d71 756f 7461 2d66  aws-zero-quota-f
+00020d70: 6169 6c6f 7665 7227 2c0a 2020 2020 2020  ailover',.      
+00020d80: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00020d90: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00020da0: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
+00020db0: 6420 6177 7320 2d2d 7265 6769 6f6e 207b  d aws --region {
+00020dc0: 7265 6769 6f6e 7d20 2d2d 6770 7573 2056  region} --gpus V
+00020dd0: 3130 303a 3820 2d2d 7573 652d 7370 6f74  100:8 --use-spot
+00020de0: 207c 2067 7265 7020 2246 6f75 6e64 206e   | grep "Found n
+00020df0: 6f20 7175 6f74 6122 272c 0a20 2020 2020  o quota"',.     
+00020e00: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+00020e10: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+00020e20: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
+00020e30: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00020e40: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+00020e50: 2e67 6370 0a64 6566 2074 6573 745f 6763  .gcp.def test_gc
+00020e60: 705f 7a65 726f 5f71 756f 7461 5f66 6169  p_zero_quota_fai
+00020e70: 6c6f 7665 7228 293a 0a0a 2020 2020 6e61  lover():..    na
+00020e80: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00020e90: 725f 6e61 6d65 2829 0a20 2020 2072 6567  r_name().    reg
+00020ea0: 696f 6e20 3d20 6765 745f 6763 705f 7265  ion = get_gcp_re
+00020eb0: 6769 6f6e 5f66 6f72 5f71 756f 7461 5f66  gion_for_quota_f
+00020ec0: 6169 6c6f 7665 7228 290a 0a20 2020 2069  ailover()..    i
+00020ed0: 6620 6e6f 7420 7265 6769 6f6e 3a0a 2020  f not region:.  
+00020ee0: 2020 2020 2020 7079 7465 7374 2e78 6661        pytest.xfa
+00020ef0: 696c 280a 2020 2020 2020 2020 2020 2020  il(.            
+00020f00: 2755 6e61 626c 6520 746f 2074 6573 7420  'Unable to test 
+00020f10: 7a65 726f 2071 756f 7461 2066 6169 6c6f  zero quota failo
+00020f20: 7665 7220 6f70 7469 6d69 7a61 7469 6f6e  ver optimization
+00020f30: 20e2 8094 2071 756f 7461 7320 270a 2020   ... quotas '.  
+00020f40: 2020 2020 2020 2020 2020 2766 6f72 2041            'for A
+00020f50: 3130 302d 3830 4742 2047 5055 7320 7765  100-80GB GPUs we
+00020f60: 7265 2066 6f75 6e64 206f 6e20 616c 6c20  re found on all 
+00020f70: 4743 5020 7265 6769 6f6e 732e 2049 7320  GCP regions. Is 
+00020f80: 7468 6973 2027 0a20 2020 2020 2020 2020  this '.         
+00020f90: 2020 2027 6578 7065 6374 6564 2066 6f72     'expected for
+00020fa0: 2079 6f75 7220 6163 636f 756e 743f 2729   your account?')
+00020fb0: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
+00020fc0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00020fd0: 280a 2020 2020 2020 2020 2767 6370 2d7a  (.        'gcp-z
+00020fe0: 6572 6f2d 7175 6f74 612d 6661 696c 6f76  ero-quota-failov
+00020ff0: 6572 272c 0a20 2020 2020 2020 205b 0a20  er',.        [. 
+00021000: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00021010: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+00021020: 616d 657d 202d 2d63 6c6f 7564 2067 6370  ame} --cloud gcp
+00021030: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+00021040: 6e7d 202d 2d67 7075 7320 4131 3030 2d38  n} --gpus A100-8
+00021050: 3047 423a 3120 2d2d 7573 652d 7370 6f74  0GB:1 --use-spot
+00021060: 207c 2067 7265 7020 2246 6f75 6e64 206e   | grep "Found n
+00021070: 6f20 7175 6f74 6122 272c 0a20 2020 2020  o quota"',.     
+00021080: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+00021090: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+000210a0: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
+000210b0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+000210c0: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
+000210d0: 2054 6573 7469 6e67 2073 6b79 7365 7276   Testing skyserv
+000210e0: 6520 2d2d 2d2d 2d2d 2d2d 2d2d 0a0a 0a64  e ----------...d
+000210f0: 6566 205f 6765 745f 7365 7276 6963 655f  ef _get_service_
+00021100: 6e61 6d65 2829 202d 3e20 7374 723a 0a20  name() -> str:. 
+00021110: 2020 2022 2222 5265 7475 726e 7320 6120     """Returns a 
+00021120: 7573 6572 2d75 6e69 7175 6520 7365 7276  user-unique serv
+00021130: 6963 6520 6e61 6d65 2066 6f72 2065 6163  ice name for eac
+00021140: 6820 7465 7374 5f73 6b79 7365 7276 655f  h test_skyserve_
+00021150: 3c6e 616d 653e 2829 2e0a 0a20 2020 204d  <name>()...    M
+00021160: 7573 7420 6265 2063 616c 6c65 6420 6672  ust be called fr
+00021170: 6f6d 2065 6163 6820 7465 7374 5f73 6b79  om each test_sky
+00021180: 7365 7276 655f 3c6e 616d 653e 2829 2e0a  serve_<name>()..
+00021190: 2020 2020 2222 220a 2020 2020 6361 6c6c      """.    call
+000211a0: 6572 5f66 756e 635f 6e61 6d65 203d 2069  er_func_name = i
+000211b0: 6e73 7065 6374 2e73 7461 636b 2829 5b31  nspect.stack()[1
+000211c0: 5d5b 335d 0a20 2020 2074 6573 745f 6e61  ][3].    test_na
+000211d0: 6d65 203d 2063 616c 6c65 725f 6675 6e63  me = caller_func
+000211e0: 5f6e 616d 652e 7265 706c 6163 6528 275f  _name.replace('_
+000211f0: 272c 2027 2d27 292e 7265 706c 6163 6528  ', '-').replace(
+00021200: 2774 6573 742d 272c 2027 742d 2729 0a20  'test-', 't-'). 
+00021210: 2020 2074 6573 745f 6e61 6d65 203d 2074     test_name = t
+00021220: 6573 745f 6e61 6d65 2e72 6570 6c61 6365  est_name.replace
+00021230: 2827 736b 7973 6572 7665 2d27 2c20 2773  ('skyserve-', 's
+00021240: 732d 2729 0a20 2020 2074 6573 745f 6e61  s-').    test_na
+00021250: 6d65 203d 2063 6f6d 6d6f 6e5f 7574 696c  me = common_util
+00021260: 732e 6d61 6b65 5f63 6c75 7374 6572 5f6e  s.make_cluster_n
+00021270: 616d 655f 6f6e 5f63 6c6f 7564 2874 6573  ame_on_cloud(tes
+00021280: 745f 6e61 6d65 2c20 3234 290a 2020 2020  t_name, 24).    
+00021290: 7265 7475 726e 2066 277b 7465 7374 5f6e  return f'{test_n
+000212a0: 616d 657d 2d7b 7465 7374 5f69 647d 270a  ame}-{test_id}'.
+000212b0: 0a0a 2320 5765 2063 6865 636b 2074 6865  ..# We check the
+000212c0: 206f 7574 7075 7420 6f66 2074 6865 2073   output of the s
+000212d0: 6b79 7365 7276 6520 7365 7276 6963 6520  kyserve service 
+000212e0: 746f 2073 6565 2069 6620 6974 2069 7320  to see if it is 
+000212f0: 7265 6164 792e 204f 7574 7075 7420 6f66  ready. Output of
+00021300: 0a23 2060 5245 504c 4943 4153 6020 6973  .# `REPLICAS` is
+00021310: 2069 6e20 7468 6520 666f 726d 206f 6620   in the form of 
+00021320: 6031 2f32 6020 7768 6572 6520 7468 6520  `1/2` where the 
+00021330: 6669 7273 7420 6e75 6d62 6572 2069 7320  first number is 
+00021340: 7468 6520 6e75 6d62 6572 206f 660a 2320  the number of.# 
+00021350: 7265 6164 7920 7265 706c 6963 6173 2061  ready replicas a
+00021360: 6e64 2074 6865 2073 6563 6f6e 6420 6e75  nd the second nu
+00021370: 6d62 6572 2069 7320 7468 6520 6e75 6d62  mber is the numb
+00021380: 6572 206f 6620 746f 7461 6c20 7265 706c  er of total repl
+00021390: 6963 6173 2e20 5765 0a23 2067 7265 7020  icas. We.# grep 
+000213a0: 7375 6368 2066 6f72 6d61 7420 746f 2065  such format to e
+000213b0: 6e73 7572 6520 7468 6174 2074 6865 2073  nsure that the s
+000213c0: 6572 7669 6365 2069 7320 7265 6164 792c  ervice is ready,
+000213d0: 2061 6e64 2065 6172 6c79 2065 7869 7420   and early exit 
+000213e0: 6966 2061 6e79 0a23 2066 6169 6c75 7265  if any.# failure
+000213f0: 2064 6574 6563 7465 642e 2049 6e20 7468   detected. In th
+00021400: 6520 656e 6420 7765 2073 6c65 6570 2066  e end we sleep f
+00021410: 6f72 0a23 2073 6572 7665 2e4c 425f 434f  or.# serve.LB_CO
+00021420: 4e54 524f 4c4c 4552 5f53 594e 435f 494e  NTROLLER_SYNC_IN
+00021430: 5445 5256 414c 5f53 4543 4f4e 4453 2074  TERVAL_SECONDS t
+00021440: 6f20 6d61 6b65 2073 7572 6520 6c6f 6164  o make sure load
+00021450: 2062 616c 616e 6365 7220 6861 7665 0a23   balancer have.#
+00021460: 2065 6e6f 7567 6820 7469 6d65 2074 6f20   enough time to 
+00021470: 7379 6e63 2077 6974 6820 7468 6520 636f  sync with the co
+00021480: 6e74 726f 6c6c 6572 2061 6e64 2067 6574  ntroller and get
+00021490: 2061 6c6c 2072 6561 6479 2072 6570 6c69   all ready repli
+000214a0: 6361 2049 5073 2e0a 5f53 4552 5645 5f57  ca IPs.._SERVE_W
+000214b0: 4149 545f 554e 5449 4c5f 5245 4144 5920  AIT_UNTIL_READY 
+000214c0: 3d20 280a 2020 2020 277b 7b20 7768 696c  = (.    '{{ whil
+000214d0: 6520 7472 7565 3b20 646f 270a 2020 2020  e true; do'.    
+000214e0: 2720 2020 2020 733d 2428 736b 7920 7365  '     s=$(sky se
+000214f0: 7276 6520 7374 6174 7573 207b 6e61 6d65  rve status {name
+00021500: 7d29 3b20 6563 686f 2022 2473 223b 270a  }); echo "$s";'.
+00021510: 2020 2020 2720 2020 2020 6563 686f 2022      '     echo "
+00021520: 2473 2220 7c20 6772 6570 202d 7120 227b  $s" | grep -q "{
+00021530: 7265 706c 6963 615f 6e75 6d7d 2f7b 7265  replica_num}/{re
+00021540: 706c 6963 615f 6e75 6d7d 2220 2626 2062  plica_num}" && b
+00021550: 7265 616b 3b27 0a20 2020 2027 2020 2020  reak;'.    '    
+00021560: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+00021570: 7020 2d71 2022 4641 494c 4544 2220 2626  p -q "FAILED" &&
+00021580: 2065 7869 7420 313b 270a 2020 2020 2720   exit 1;'.    ' 
+00021590: 2020 2020 736c 6565 7020 3130 3b27 0a20      sleep 10;'. 
+000215a0: 2020 2027 2064 6f6e 653b 207d 7d3b 2065     ' done; }}; e
+000215b0: 6368 6f20 2247 6f74 2073 6572 7669 6365  cho "Got service
+000215c0: 2073 7461 7475 7320 2473 223b 270a 2020   status $s";'.  
+000215d0: 2020 6627 736c 6565 7020 7b73 6572 7665    f'sleep {serve
+000215e0: 2e4c 425f 434f 4e54 524f 4c4c 4552 5f53  .LB_CONTROLLER_S
+000215f0: 594e 435f 494e 5445 5256 414c 5f53 4543  YNC_INTERVAL_SEC
+00021600: 4f4e 4453 202b 2032 7d3b 2729 0a5f 4950  ONDS + 2};')._IP
+00021610: 5f52 4547 4558 203d 2072 2728 5b30 2d39  _REGEX = r'([0-9
+00021620: 5d7b 312c 337d 5c2e 297b 337d 5b30 2d39  ]{1,3}\.){3}[0-9
+00021630: 5d7b 312c 337d 270a 5f41 574b 5f41 4c4c  ]{1,3}'._AWK_ALL
+00021640: 5f4c 494e 4553 5f42 454c 4f57 5f52 4550  _LINES_BELOW_REP
+00021650: 4c49 4341 5320 3d20 7227 2f52 6570 6c69  LICAS = r'/Repli
+00021660: 6361 732f 7b66 6c61 673d 313b 206e 6578  cas/{flag=1; nex
+00021670: 747d 2066 6c61 6727 0a5f 5345 5256 4943  t} flag'._SERVIC
+00021680: 455f 4c41 554e 4348 494e 475f 5354 4154  E_LAUNCHING_STAT
+00021690: 5553 5f52 4547 4558 203d 2027 5052 4f56  US_REGEX = 'PROV
+000216a0: 4953 494f 4e49 4e47 5c7c 5354 4152 5449  ISIONING\|STARTI
+000216b0: 4e47 270a 2320 5369 6e63 6520 7765 2064  NG'.# Since we d
+000216c0: 6f6e 2774 2061 6c6c 6f77 2074 6572 6d69  on't allow termi
+000216d0: 6e61 7465 2074 6865 2073 6572 7669 6365  nate the service
+000216e0: 2069 6620 7468 6520 636f 6e74 726f 6c6c   if the controll
+000216f0: 6572 2069 7320 494e 4954 2c0a 2320 7768  er is INIT,.# wh
+00021700: 6963 6820 6973 2063 6f6d 6d6f 6e20 666f  ich is common fo
+00021710: 7220 7369 6d75 6c74 616e 656f 7573 2070  r simultaneous p
+00021720: 7974 6573 742c 2077 6520 6e65 6564 2074  ytest, we need t
+00021730: 6f20 7761 6974 2075 6e74 696c 2074 6865  o wait until the
+00021740: 0a23 2063 6f6e 7472 6f6c 6c65 7220 6973  .# controller is
+00021750: 2055 5020 6265 666f 7265 2077 6520 6361   UP before we ca
+00021760: 6e20 7465 726d 696e 6174 6520 7468 6520  n terminate the 
+00021770: 7365 7276 6963 652e 0a23 2054 6865 2074  service..# The t
+00021780: 6561 7264 6f77 6e20 636f 6d6d 616e 6420  eardown command 
+00021790: 6861 7320 6120 3130 2d6d 696e 7320 7469  has a 10-mins ti
+000217a0: 6d65 6f75 742c 2073 6f20 7765 2064 6f6e  meout, so we don
+000217b0: 2774 206e 6565 6420 746f 2064 6f0a 2320  't need to do.# 
+000217c0: 7468 6520 7469 6d65 6f75 7420 6865 7265  the timeout here
+000217d0: 2e20 5365 6520 696d 706c 656d 656e 7461  . See implementa
+000217e0: 7469 6f6e 206f 6620 7275 6e5f 6f6e 655f  tion of run_one_
+000217f0: 7465 7374 2829 2066 6f72 2064 6574 6169  test() for detai
+00021800: 6c73 2e0a 5f54 4541 5244 4f57 4e5f 5345  ls.._TEARDOWN_SE
+00021810: 5256 4943 4520 3d20 280a 2020 2020 2728  RVICE = (.    '(
+00021820: 666f 7220 6920 696e 2060 7365 7120 3120  for i in `seq 1 
+00021830: 3230 603b 2064 6f27 0a20 2020 2027 2020  20`; do'.    '  
+00021840: 2020 2073 3d24 2873 6b79 2073 6572 7665     s=$(sky serve
+00021850: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d29   down -y {name})
+00021860: 3b27 0a20 2020 2027 2020 2020 2065 6368  ;'.    '     ech
+00021870: 6f20 2254 7279 696e 6720 746f 2074 6572  o "Trying to ter
+00021880: 6d69 6e61 7465 207b 6e61 6d65 7d22 3b27  minate {name}";'
+00021890: 0a20 2020 2027 2020 2020 2065 6368 6f20  .    '     echo 
+000218a0: 2224 7322 3b27 0a20 2020 2027 2020 2020  "$s";'.    '    
+000218b0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+000218c0: 7020 2d71 2022 7363 6865 6475 6c65 6420  p -q "scheduled 
+000218d0: 746f 2062 6520 7465 726d 696e 6174 6564  to be terminated
+000218e0: 5c7c 4e6f 2073 6572 7669 6365 2074 6f20  \|No service to 
+000218f0: 7465 726d 696e 6174 6522 2026 2620 6272  terminate" && br
+00021900: 6561 6b3b 270a 2020 2020 2720 2020 2020  eak;'.    '     
+00021910: 736c 6565 7020 3130 3b27 0a20 2020 2027  sleep 10;'.    '
+00021920: 2020 2020 205b 2024 6920 2d65 7120 3230       [ $i -eq 20
+00021930: 205d 2026 2620 6563 686f 2022 4661 696c   ] && echo "Fail
+00021940: 6564 2074 6f20 7465 726d 696e 6174 6520  ed to terminate 
+00021950: 7365 7276 6963 6520 7b6e 616d 657d 223b  service {name}";
+00021960: 270a 2020 2020 2764 6f6e 6529 2729 0a0a  '.    'done)')..
+00021970: 5f53 4552 5645 5f45 4e44 504f 494e 545f  _SERVE_ENDPOINT_
+00021980: 5741 4954 203d 2028 0a20 2020 2027 6578  WAIT = (.    'ex
+00021990: 706f 7274 204f 5249 4749 4e5f 534b 5950  port ORIGIN_SKYP
+000219a0: 494c 4f54 5f44 4542 5547 3d24 534b 5950  ILOT_DEBUG=$SKYP
+000219b0: 494c 4f54 5f44 4542 5547 3b20 6578 706f  ILOT_DEBUG; expo
+000219c0: 7274 2053 4b59 5049 4c4f 545f 4445 4255  rt SKYPILOT_DEBU
+000219d0: 473d 303b 2027 0a20 2020 2027 656e 6470  G=0; '.    'endp
+000219e0: 6f69 6e74 3d24 2873 6b79 2073 6572 7665  oint=$(sky serve
+000219f0: 2073 7461 7475 7320 2d2d 656e 6470 6f69   status --endpoi
+00021a00: 6e74 207b 6e61 6d65 7d29 3b20 270a 2020  nt {name}); '.  
+00021a10: 2020 2775 6e74 696c 2021 2065 6368 6f20    'until ! echo 
+00021a20: 2224 656e 6470 6f69 6e74 2220 7c20 6772  "$endpoint" | gr
+00021a30: 6570 2022 436f 6e74 726f 6c6c 6572 2069  ep "Controller i
+00021a40: 7320 696e 6974 6961 6c69 7a69 6e67 223b  s initializing";
+00021a50: 2027 0a20 2020 2027 646f 2065 6368 6f20   '.    'do echo 
+00021a60: 2257 6169 7469 6e67 2066 6f72 2073 6572  "Waiting for ser
+00021a70: 7665 2065 6e64 706f 696e 7420 746f 2062  ve endpoint to b
+00021a80: 6520 7265 6164 792e 2e2e 223b 2027 0a20  e ready..."; '. 
+00021a90: 2020 2027 736c 6565 7020 353b 2065 6e64     'sleep 5; end
+00021aa0: 706f 696e 743d 2428 736b 7920 7365 7276  point=$(sky serv
+00021ab0: 6520 7374 6174 7573 202d 2d65 6e64 706f  e status --endpo
+00021ac0: 696e 7420 7b6e 616d 657d 293b 2064 6f6e  int {name}); don
+00021ad0: 653b 2027 0a20 2020 2027 6578 706f 7274  e; '.    'export
+00021ae0: 2053 4b59 5049 4c4f 545f 4445 4255 473d   SKYPILOT_DEBUG=
+00021af0: 244f 5249 4749 4e5f 534b 5950 494c 4f54  $ORIGIN_SKYPILOT
+00021b00: 5f44 4542 5547 3b20 6563 686f 2022 2465  _DEBUG; echo "$e
+00021b10: 6e64 706f 696e 7422 2729 0a0a 5f53 4552  ndpoint"').._SER
+00021b20: 5645 5f53 5441 5455 535f 5741 4954 203d  VE_STATUS_WAIT =
+00021b30: 2028 2773 3d24 2873 6b79 2073 6572 7665   ('s=$(sky serve
+00021b40: 2073 7461 7475 7320 7b6e 616d 657d 293b   status {name});
+00021b50: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00021b60: 2020 2020 2020 2020 2027 756e 7469 6c20           'until 
+00021b70: 2120 6563 686f 2022 2473 2220 7c20 6772  ! echo "$s" | gr
+00021b80: 6570 2022 436f 6e74 726f 6c6c 6572 2069  ep "Controller i
+00021b90: 7320 696e 6974 6961 6c69 7a69 6e67 2e22  s initializing."
+00021ba0: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+00021bb0: 2020 2020 2020 2020 2020 2764 6f20 6563            'do ec
+00021bc0: 686f 2022 5761 6974 696e 6720 666f 7220  ho "Waiting for 
+00021bd0: 7365 7276 6520 7374 6174 7573 2074 6f20  serve status to 
+00021be0: 6265 2072 6561 6479 2e2e 2e22 3b20 270a  be ready..."; '.
+00021bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021c00: 2020 2020 2020 2773 6c65 6570 2035 3b20        'sleep 5; 
+00021c10: 733d 2428 736b 7920 7365 7276 6520 7374  s=$(sky serve st
+00021c20: 6174 7573 207b 6e61 6d65 7d29 3b20 646f  atus {name}); do
+00021c30: 6e65 3b20 6563 686f 2022 2473 2227 290a  ne; echo "$s"').
+00021c40: 0a0a 6465 6620 5f67 6574 5f72 6570 6c69  ..def _get_repli
+00021c50: 6361 5f69 7028 6e61 6d65 3a20 7374 722c  ca_ip(name: str,
+00021c60: 2072 6570 6c69 6361 5f69 643a 2069 6e74   replica_id: int
+00021c70: 2920 2d3e 2073 7472 3a0a 2020 2020 7265  ) -> str:.    re
+00021c80: 7475 726e 2028 6627 6970 7b72 6570 6c69  turn (f'ip{repli
+00021c90: 6361 5f69 647d 3d24 2865 6368 6f20 2224  ca_id}=$(echo "$
+00021ca0: 7322 207c 2027 0a20 2020 2020 2020 2020  s" | '.         
+00021cb0: 2020 2066 2761 776b 2022 7b5f 4157 4b5f     f'awk "{_AWK_
+00021cc0: 414c 4c5f 4c49 4e45 535f 4245 4c4f 575f  ALL_LINES_BELOW_
+00021cd0: 5245 504c 4943 4153 7d22 207c 2027 0a20  REPLICAS}" | '. 
+00021ce0: 2020 2020 2020 2020 2020 2066 2767 7265             f'gre
+00021cf0: 7020 2d45 2022 7b6e 616d 657d 5c73 2b7b  p -E "{name}\s+{
+00021d00: 7265 706c 6963 615f 6964 7d22 207c 2027  replica_id}" | '
+00021d10: 0a20 2020 2020 2020 2020 2020 2066 2767  .            f'g
+00021d20: 7265 7020 2d45 6f20 227b 5f49 505f 5245  rep -Eo "{_IP_RE
+00021d30: 4745 587d 2229 2729 0a0a 0a64 6566 205f  GEX}")')...def _
+00021d40: 6765 745f 736b 7973 6572 7665 5f68 7474  get_skyserve_htt
+00021d50: 705f 7465 7374 286e 616d 653a 2073 7472  p_test(name: str
+00021d60: 2c20 636c 6f75 643a 2073 7472 2c0a 2020  , cloud: str,.  
+00021d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021d80: 2020 2020 2020 2020 2020 7469 6d65 6f75            timeou
+00021d90: 745f 6d69 6e75 7465 733a 2069 6e74 2920  t_minutes: int) 
+00021da0: 2d3e 2054 6573 743a 0a20 2020 2074 6573  -> Test:.    tes
+00021db0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00021dc0: 2020 6627 7465 7374 2d73 6b79 7365 7276    f'test-skyserv
+00021dd0: 652d 7b63 6c6f 7564 2e72 6570 6c61 6365  e-{cloud.replace
+00021de0: 2822 5f22 2c20 222d 2229 7d27 2c0a 2020  ("_", "-")}',.  
+00021df0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00021e00: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
+00021e10: 7570 202d 6e20 7b6e 616d 657d 202d 7920  up -n {name} -y 
+00021e20: 7465 7374 732f 736b 7973 6572 7665 2f68  tests/skyserve/h
+00021e30: 7474 702f 7b63 6c6f 7564 7d2e 7961 6d6c  ttp/{cloud}.yaml
+00021e40: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
+00021e50: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
+00021e60: 5f52 4541 4459 2e66 6f72 6d61 7428 6e61  _READY.format(na
+00021e70: 6d65 3d6e 616d 652c 2072 6570 6c69 6361  me=name, replica
+00021e80: 5f6e 756d 3d32 292c 0a20 2020 2020 2020  _num=2),.       
+00021e90: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
+00021ea0: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
+00021eb0: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
+00021ec0: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
+00021ed0: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
+00021ee0: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
+00021ef0: 2248 692c 2053 6b79 5069 6c6f 7420 6865  "Hi, SkyPilot he
+00021f00: 7265 2227 2c0a 2020 2020 2020 2020 5d2c  re"',.        ],
+00021f10: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
+00021f20: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
+00021f30: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
+00021f40: 2020 2020 2020 7469 6d65 6f75 743d 7469        timeout=ti
+00021f50: 6d65 6f75 745f 6d69 6e75 7465 7320 2a20  meout_minutes * 
+00021f60: 3630 2c0a 2020 2020 290a 2020 2020 7265  60,.    ).    re
+00021f70: 7475 726e 2074 6573 740a 0a0a 6465 6620  turn test...def 
+00021f80: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
+00021f90: 6e5f 7374 6174 7573 286e 616d 653a 2073  n_status(name: s
+00021fa0: 7472 2c20 6368 6563 6b5f 7475 706c 6573  tr, check_tuples
+00021fb0: 3a20 4c69 7374 5b54 7570 6c65 5b69 6e74  : List[Tuple[int
+00021fc0: 2c20 626f 6f6c 2c0a 2020 2020 2020 2020  , bool,.        
+00021fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022000: 2020 2020 2020 2020 2073 7472 5d5d 2920           str]]) 
+00022010: 2d3e 2073 7472 3a0a 2020 2020 2222 2243  -> str:.    """C
+00022020: 6865 636b 2072 6570 6c69 6361 7327 2073  heck replicas' s
+00022030: 7461 7475 7320 616e 6420 636f 756e 7420  tatus and count 
+00022040: 696e 2073 6b79 2073 6572 7665 2073 7461  in sky serve sta
+00022050: 7475 730a 0a20 2020 2057 6520 7769 6c6c  tus..    We will
+00022060: 2063 6865 636b 2076 4350 553d 322c 2061   check vCPU=2, a
+00022070: 7320 616c 6c20 6f75 7220 7465 7374 7320  s all our tests 
+00022080: 7573 6520 7643 5055 3d32 2e0a 2020 2020  use vCPU=2..    
+00022090: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+000220a0: 2020 206e 616d 653a 2074 6865 206e 616d     name: the nam
+000220b0: 6520 6f66 2074 6865 2073 6572 7669 6365  e of the service
+000220c0: 0a20 2020 2020 2020 2063 6865 636b 5f74  .        check_t
+000220d0: 7570 6c65 733a 2041 206c 6973 7420 6f66  uples: A list of
+000220e0: 2072 6570 6c69 6361 2070 726f 7065 7274   replica propert
+000220f0: 7920 746f 2063 6865 636b 2e20 4561 6368  y to check. Each
+00022100: 2074 7570 6c65 2069 730a 2020 2020 2020   tuple is.      
+00022110: 2020 2020 2020 2863 6f75 6e74 2c20 6973        (count, is
+00022120: 5f73 706f 742c 2073 7461 7475 7329 0a20  _spot, status). 
+00022130: 2020 2022 2222 0a20 2020 2063 6865 636b     """.    check
+00022140: 5f63 6d64 203d 2027 270a 2020 2020 666f  _cmd = ''.    fo
+00022150: 7220 6368 6563 6b5f 7475 706c 6520 696e  r check_tuple in
+00022160: 2063 6865 636b 5f74 7570 6c65 733a 0a20   check_tuples:. 
+00022170: 2020 2020 2020 2063 6f75 6e74 2c20 6973         count, is
+00022180: 5f73 706f 742c 2073 7461 7475 7320 3d20  _spot, status = 
+00022190: 6368 6563 6b5f 7475 706c 650a 2020 2020  check_tuple.    
+000221a0: 2020 2020 7265 736f 7572 6365 5f73 7472      resource_str
+000221b0: 203d 2027 270a 2020 2020 2020 2020 6966   = ''.        if
+000221c0: 2073 7461 7475 7320 6e6f 7420 696e 205b   status not in [
+000221d0: 2750 454e 4449 4e47 272c 2027 5348 5554  'PENDING', 'SHUT
+000221e0: 5449 4e47 5f44 4f57 4e27 0a20 2020 2020  TING_DOWN'.     
+000221f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022200: 2020 2020 5d20 616e 6420 6e6f 7420 7374      ] and not st
+00022210: 6174 7573 2e73 7461 7274 7377 6974 6828  atus.startswith(
+00022220: 2746 4149 4c45 4427 293a 0a20 2020 2020  'FAILED'):.     
+00022230: 2020 2020 2020 2073 706f 745f 7374 7220         spot_str 
+00022240: 3d20 2727 0a20 2020 2020 2020 2020 2020  = ''.           
+00022250: 2069 6620 6973 5f73 706f 743a 0a20 2020   if is_spot:.   
+00022260: 2020 2020 2020 2020 2020 2020 2073 706f               spo
+00022270: 745f 7374 7220 3d20 275c 5b53 706f 745c  t_str = '\[Spot\
+00022280: 5d27 0a20 2020 2020 2020 2020 2020 2072  ]'.            r
+00022290: 6573 6f75 7263 655f 7374 7220 3d20 6627  esource_str = f'
+000222a0: 287b 7370 6f74 5f73 7472 7d76 4350 553d  ({spot_str}vCPU=
+000222b0: 3229 270a 2020 2020 2020 2020 6368 6563  2)'.        chec
+000222c0: 6b5f 636d 6420 2b3d 2028 6627 2065 6368  k_cmd += (f' ech
+000222d0: 6f20 2224 7322 207c 2067 7265 7020 227b  o "$s" | grep "{
+000222e0: 7265 736f 7572 6365 5f73 7472 7d22 207c  resource_str}" |
+000222f0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00022300: 2020 2020 2020 2020 2066 2767 7265 7020           f'grep 
+00022310: 227b 7374 6174 7573 7d22 207c 2077 6320  "{status}" | wc 
+00022320: 2d6c 207c 2067 7265 7020 7b63 6f75 6e74  -l | grep {count
+00022330: 7d20 7c7c 2065 7869 7420 313b 2729 0a20  } || exit 1;'). 
+00022340: 2020 2072 6574 7572 6e20 2866 277b 5f53     return (f'{_S
+00022350: 4552 5645 5f53 5441 5455 535f 5741 4954  ERVE_STATUS_WAIT
+00022360: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00022370: 6529 7d3b 2065 6368 6f20 2224 7322 3b20  e)}; echo "$s"; 
+00022380: 2720 2b20 6368 6563 6b5f 636d 6429 0a0a  ' + check_cmd)..
+00022390: 0a64 6566 205f 6368 6563 6b5f 7365 7276  .def _check_serv
+000223a0: 6963 655f 7665 7273 696f 6e28 7365 7276  ice_version(serv
+000223b0: 6963 655f 6e61 6d65 3a20 7374 722c 2076  ice_name: str, v
+000223c0: 6572 7369 6f6e 3a20 7374 7229 202d 3e20  ersion: str) -> 
+000223d0: 7374 723a 0a20 2020 2023 2047 7265 7020  str:.    # Grep 
+000223e0: 7468 6520 6c69 6e65 7320 6265 666f 7265  the lines before
+000223f0: 2027 5365 7276 6963 6520 5265 706c 6963   'Service Replic
+00022400: 6173 2720 616e 6420 6368 6563 6b20 6966  as' and check if
+00022410: 2074 6865 2073 6572 7669 6365 2076 6572   the service ver
+00022420: 7369 6f6e 0a20 2020 2023 2069 7320 636f  sion.    # is co
+00022430: 7272 6563 742e 0a20 2020 2072 6574 7572  rrect..    retur
+00022440: 6e20 2866 2765 6368 6f20 2224 7322 207c  n (f'echo "$s" |
+00022450: 2067 7265 7020 2d42 3130 3030 2022 5365   grep -B1000 "Se
+00022460: 7276 6963 6520 5265 706c 6963 6173 2220  rvice Replicas" 
+00022470: 7c20 270a 2020 2020 2020 2020 2020 2020  | '.            
+00022480: 6627 6772 6570 202d 4520 227b 7365 7276  f'grep -E "{serv
+00022490: 6963 655f 6e61 6d65 7d5c 732b 7b76 6572  ice_name}\s+{ver
+000224a0: 7369 6f6e 7d22 207c 7c20 6578 6974 2031  sion}" || exit 1
+000224b0: 3b20 2729 0a0a 0a40 7079 7465 7374 2e6d  ; ')...@pytest.m
+000224c0: 6172 6b2e 6763 700a 4070 7974 6573 742e  ark.gcp.@pytest.
+000224d0: 6d61 726b 2e73 6572 7665 0a64 6566 2074  mark.serve.def t
+000224e0: 6573 745f 736b 7973 6572 7665 5f67 6370  est_skyserve_gcp
+000224f0: 5f68 7474 7028 293a 0a20 2020 2022 2222  _http():.    """
+00022500: 5465 7374 2073 6b79 7365 7276 6520 6f6e  Test skyserve on
+00022510: 2047 4350 2222 220a 2020 2020 6e61 6d65   GCP""".    name
+00022520: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
+00022530: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+00022540: 3d20 5f67 6574 5f73 6b79 7365 7276 655f  = _get_skyserve_
+00022550: 6874 7470 5f74 6573 7428 6e61 6d65 2c20  http_test(name, 
+00022560: 2767 6370 272c 2032 3029 0a20 2020 2072  'gcp', 20).    r
+00022570: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00022580: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+00022590: 2e61 7773 0a40 7079 7465 7374 2e6d 6172  .aws.@pytest.mar
+000225a0: 6b2e 7365 7276 650a 6465 6620 7465 7374  k.serve.def test
+000225b0: 5f73 6b79 7365 7276 655f 6177 735f 6874  _skyserve_aws_ht
+000225c0: 7470 2829 3a0a 2020 2020 2222 2254 6573  tp():.    """Tes
+000225d0: 7420 736b 7973 6572 7665 206f 6e20 4157  t skyserve on AW
+000225e0: 5322 2222 0a20 2020 206e 616d 6520 3d20  S""".    name = 
+000225f0: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
+00022600: 6528 290a 2020 2020 7465 7374 203d 205f  e().    test = _
+00022610: 6765 745f 736b 7973 6572 7665 5f68 7474  get_skyserve_htt
+00022620: 705f 7465 7374 286e 616d 652c 2027 6177  p_test(name, 'aw
+00022630: 7327 2c20 3230 290a 2020 2020 7275 6e5f  s', 20).    run_
+00022640: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00022650: 0a40 7079 7465 7374 2e6d 6172 6b2e 617a  .@pytest.mark.az
+00022660: 7572 650a 4070 7974 6573 742e 6d61 726b  ure.@pytest.mark
+00022670: 2e73 6572 7665 0a64 6566 2074 6573 745f  .serve.def test_
+00022680: 736b 7973 6572 7665 5f61 7a75 7265 5f68  skyserve_azure_h
+00022690: 7474 7028 293a 0a20 2020 2022 2222 5465  ttp():.    """Te
+000226a0: 7374 2073 6b79 7365 7276 6520 6f6e 2041  st skyserve on A
+000226b0: 7a75 7265 2222 220a 2020 2020 6e61 6d65  zure""".    name
+000226c0: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
+000226d0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+000226e0: 3d20 5f67 6574 5f73 6b79 7365 7276 655f  = _get_skyserve_
+000226f0: 6874 7470 5f74 6573 7428 6e61 6d65 2c20  http_test(name, 
+00022700: 2761 7a75 7265 272c 2033 3029 0a20 2020  'azure', 30).   
+00022710: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00022720: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00022730: 726b 2e73 6572 7665 0a40 7079 7465 7374  rk.serve.@pytest
+00022740: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
+00022750: 7465 730a 6465 6620 7465 7374 5f73 6b79  tes.def test_sky
+00022760: 7365 7276 655f 6c6c 6d28 6765 6e65 7269  serve_llm(generi
+00022770: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+00022780: 2020 2022 2222 5465 7374 2073 6b79 7365     """Test skyse
+00022790: 7276 6520 7769 7468 2072 6561 6c20 4c4c  rve with real LL
+000227a0: 4d20 7573 6563 6173 6522 2222 0a20 2020  M usecase""".   
+000227b0: 206e 616d 6520 3d20 5f67 6574 5f73 6572   name = _get_ser
+000227c0: 7669 6365 5f6e 616d 6528 290a 0a20 2020  vice_name()..   
+000227d0: 2064 6566 2067 656e 6572 6174 655f 6c6c   def generate_ll
+000227e0: 6d5f 7465 7374 5f63 6f6d 6d61 6e64 2870  m_test_command(p
+000227f0: 726f 6d70 743a 2073 7472 2c20 6578 7065  rompt: str, expe
+00022800: 6374 6564 5f6f 7574 7075 743a 2073 7472  cted_output: str
+00022810: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
+00022820: 2020 7072 6f6d 7074 203d 2073 686c 6578    prompt = shlex
+00022830: 2e71 756f 7465 2870 726f 6d70 7429 0a20  .quote(prompt). 
+00022840: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
+00022850: 6f75 7470 7574 203d 2073 686c 6578 2e71  output = shlex.q
+00022860: 756f 7465 2865 7870 6563 7465 645f 6f75  uote(expected_ou
+00022870: 7470 7574 290a 2020 2020 2020 2020 7265  tput).        re
+00022880: 7475 726e 2028 0a20 2020 2020 2020 2020  turn (.         
+00022890: 2020 2066 277b 5f53 4552 5645 5f45 4e44     f'{_SERVE_END
+000228a0: 504f 494e 545f 5741 4954 2e66 6f72 6d61  POINT_WAIT.forma
+000228b0: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2027  t(name=name)}; '
+000228c0: 0a20 2020 2020 2020 2020 2020 2027 7079  .            'py
+000228d0: 7468 6f6e 2074 6573 7473 2f73 6b79 7365  thon tests/skyse
+000228e0: 7276 652f 6c6c 6d2f 6765 745f 7265 7370  rve/llm/get_resp
+000228f0: 6f6e 7365 2e70 7920 2d2d 656e 6470 6f69  onse.py --endpoi
+00022900: 6e74 2024 656e 6470 6f69 6e74 2027 0a20  nt $endpoint '. 
+00022910: 2020 2020 2020 2020 2020 2066 272d 2d70             f'--p
+00022920: 726f 6d70 7420 7b70 726f 6d70 747d 207c  rompt {prompt} |
+00022930: 2067 7265 7020 7b65 7870 6563 7465 645f   grep {expected_
+00022940: 6f75 7470 7574 7d27 290a 0a20 2020 2077  output}')..    w
+00022950: 6974 6820 6f70 656e 2827 7465 7374 732f  ith open('tests/
+00022960: 736b 7973 6572 7665 2f6c 6c6d 2f70 726f  skyserve/llm/pro
+00022970: 6d70 745f 6f75 7470 7574 2e6a 736f 6e27  mpt_output.json'
+00022980: 2c20 2772 272c 0a20 2020 2020 2020 2020  , 'r',.         
+00022990: 2020 2020 2065 6e63 6f64 696e 673d 2775       encoding='u
+000229a0: 7466 2d38 2729 2061 7320 663a 0a20 2020  tf-8') as f:.   
+000229b0: 2020 2020 2070 726f 6d70 7432 6f75 7470       prompt2outp
+000229c0: 7574 203d 206a 736f 6e2e 6c6f 6164 2866  ut = json.load(f
+000229d0: 290a 0a20 2020 2074 6573 7420 3d20 5465  )..    test = Te
+000229e0: 7374 280a 2020 2020 2020 2020 6627 7465  st(.        f'te
+000229f0: 7374 2d73 6b79 7365 7276 652d 6c6c 6d27  st-skyserve-llm'
+00022a00: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00022a10: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
+00022a20: 7276 6520 7570 202d 6e20 7b6e 616d 657d  rve up -n {name}
+00022a30: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+00022a40: 635f 636c 6f75 647d 202d 7920 7465 7374  c_cloud} -y test
+00022a50: 732f 736b 7973 6572 7665 2f6c 6c6d 2f73  s/skyserve/llm/s
+00022a60: 6572 7669 6365 2e79 616d 6c27 2c0a 2020  ervice.yaml',.  
+00022a70: 2020 2020 2020 2020 2020 5f53 4552 5645            _SERVE
+00022a80: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
+00022a90: 592e 666f 726d 6174 286e 616d 653d 6e61  Y.format(name=na
+00022aa0: 6d65 2c20 7265 706c 6963 615f 6e75 6d3d  me, replica_num=
+00022ab0: 3129 2c0a 2020 2020 2020 2020 2020 2020  1),.            
+00022ac0: 2a5b 0a20 2020 2020 2020 2020 2020 2020  *[.             
+00022ad0: 2020 2067 656e 6572 6174 655f 6c6c 6d5f     generate_llm_
+00022ae0: 7465 7374 5f63 6f6d 6d61 6e64 2870 726f  test_command(pro
+00022af0: 6d70 742c 206f 7574 7075 7429 0a20 2020  mpt, output).   
+00022b00: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00022b10: 2070 726f 6d70 742c 206f 7574 7075 7420   prompt, output 
+00022b20: 696e 2070 726f 6d70 7432 6f75 7470 7574  in prompt2output
+00022b30: 2e69 7465 6d73 2829 0a20 2020 2020 2020  .items().       
+00022b40: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00022b50: 5d2c 0a20 2020 2020 2020 205f 5445 4152  ],.        _TEAR
+00022b60: 444f 574e 5f53 4552 5649 4345 2e66 6f72  DOWN_SERVICE.for
+00022b70: 6d61 7428 6e61 6d65 3d6e 616d 6529 2c0a  mat(name=name),.
+00022b80: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00022b90: 3235 202a 2036 302c 0a20 2020 2029 0a20  25 * 60,.    ). 
+00022ba0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00022bb0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00022bc0: 6d61 726b 2e67 6370 0a40 7079 7465 7374  mark.gcp.@pytest
+00022bd0: 2e6d 6172 6b2e 7365 7276 650a 6465 6620  .mark.serve.def 
+00022be0: 7465 7374 5f73 6b79 7365 7276 655f 7370  test_skyserve_sp
+00022bf0: 6f74 5f72 6563 6f76 6572 7928 293a 0a20  ot_recovery():. 
+00022c00: 2020 206e 616d 6520 3d20 5f67 6574 5f73     name = _get_s
+00022c10: 6572 7669 6365 5f6e 616d 6528 290a 2020  ervice_name().  
+00022c20: 2020 7a6f 6e65 203d 2027 7573 2d63 656e    zone = 'us-cen
+00022c30: 7472 616c 312d 6127 0a0a 2020 2020 7465  tral1-a'..    te
+00022c40: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00022c50: 2020 2066 2774 6573 742d 736b 7973 6572     f'test-skyser
+00022c60: 7665 2d73 706f 742d 7265 636f 7665 7279  ve-spot-recovery
+00022c70: 2d67 6370 272c 0a20 2020 2020 2020 205b  -gcp',.        [
+00022c80: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00022c90: 6b79 2073 6572 7665 2075 7020 2d6e 207b  ky serve up -n {
+00022ca0: 6e61 6d65 7d20 2d79 2074 6573 7473 2f73  name} -y tests/s
+00022cb0: 6b79 7365 7276 652f 7370 6f74 2f72 6563  kyserve/spot/rec
+00022cc0: 6f76 6572 792e 7961 6d6c 272c 0a20 2020  overy.yaml',.   
+00022cd0: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
+00022ce0: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
+00022cf0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00022d00: 652c 2072 6570 6c69 6361 5f6e 756d 3d31  e, replica_num=1
+00022d10: 292c 0a20 2020 2020 2020 2020 2020 2066  ),.            f
+00022d20: 277b 5f53 4552 5645 5f45 4e44 504f 494e  '{_SERVE_ENDPOIN
+00022d30: 545f 5741 4954 2e66 6f72 6d61 7428 6e61  T_WAIT.format(na
+00022d40: 6d65 3d6e 616d 6529 7d3b 2027 0a20 2020  me=name)}; '.   
+00022d50: 2020 2020 2020 2020 2027 6375 726c 202d           'curl -
+00022d60: 4c20 6874 7470 3a2f 2f24 656e 6470 6f69  L http://$endpoi
+00022d70: 6e74 207c 2067 7265 7020 2248 692c 2053  nt | grep "Hi, S
+00022d80: 6b79 5069 6c6f 7420 6865 7265 2227 2c0a  kyPilot here"',.
+00022d90: 2020 2020 2020 2020 2020 2020 5f74 6572              _ter
+00022da0: 6d69 6e61 7465 5f67 6370 5f72 6570 6c69  minate_gcp_repli
+00022db0: 6361 286e 616d 652c 207a 6f6e 652c 2031  ca(name, zone, 1
+00022dc0: 292c 0a20 2020 2020 2020 2020 2020 205f  ),.            _
+00022dd0: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
+00022de0: 5f52 4541 4459 2e66 6f72 6d61 7428 6e61  _READY.format(na
+00022df0: 6d65 3d6e 616d 652c 2072 6570 6c69 6361  me=name, replica
+00022e00: 5f6e 756d 3d31 292c 0a20 2020 2020 2020  _num=1),.       
+00022e10: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
+00022e20: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
+00022e30: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
+00022e40: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
+00022e50: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
+00022e60: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
+00022e70: 2248 692c 2053 6b79 5069 6c6f 7420 6865  "Hi, SkyPilot he
+00022e80: 7265 2227 2c0a 2020 2020 2020 2020 5d2c  re"',.        ],
+00022e90: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
+00022ea0: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
+00022eb0: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
+00022ec0: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
+00022ed0: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
+00022ee0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00022ef0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00022f00: 726b 2e73 6572 7665 0a40 7079 7465 7374  rk.serve.@pytest
+00022f10: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
+00022f20: 7465 730a 6465 6620 7465 7374 5f73 6b79  tes.def test_sky
+00022f30: 7365 7276 655f 6261 7365 5f6f 6e64 656d  serve_base_ondem
+00022f40: 616e 645f 6661 6c6c 6261 636b 2867 656e  and_fallback(gen
+00022f50: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+00022f60: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+00022f70: 745f 7365 7276 6963 655f 6e61 6d65 2829  t_service_name()
+00022f80: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00022f90: 280a 2020 2020 2020 2020 6627 7465 7374  (.        f'test
+00022fa0: 2d73 6b79 7365 7276 652d 6261 7365 2d6f  -skyserve-base-o
+00022fb0: 6e64 656d 616e 642d 6661 6c6c 6261 636b  ndemand-fallback
+00022fc0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00022fd0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00022fe0: 6572 7665 2075 7020 2d6e 207b 6e61 6d65  erve up -n {name
+00022ff0: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+00023000: 6963 5f63 6c6f 7564 7d20 2d79 2074 6573  ic_cloud} -y tes
+00023010: 7473 2f73 6b79 7365 7276 652f 7370 6f74  ts/skyserve/spot
+00023020: 2f62 6173 655f 6f6e 6465 6d61 6e64 5f66  /base_ondemand_f
+00023030: 616c 6c62 6163 6b2e 7961 6d6c 272c 0a20  allback.yaml',. 
+00023040: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
+00023050: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
+00023060: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
+00023070: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
+00023080: 3d32 292c 0a20 2020 2020 2020 2020 2020  =2),.           
+00023090: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
+000230a0: 696e 5f73 7461 7475 7328 6e61 6d65 2c20  in_status(name, 
+000230b0: 5b28 312c 2054 7275 652c 2027 5245 4144  [(1, True, 'READ
+000230c0: 5927 292c 0a20 2020 2020 2020 2020 2020  Y'),.           
+000230d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000230e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000230f0: 2028 312c 2046 616c 7365 2c20 2752 4541   (1, False, 'REA
+00023100: 4459 2729 5d29 2c0a 2020 2020 2020 2020  DY')]),.        
+00023110: 5d2c 0a20 2020 2020 2020 205f 5445 4152  ],.        _TEAR
+00023120: 444f 574e 5f53 4552 5649 4345 2e66 6f72  DOWN_SERVICE.for
+00023130: 6d61 7428 6e61 6d65 3d6e 616d 6529 2c0a  mat(name=name),.
+00023140: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00023150: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
+00023160: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00023170: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00023180: 6d61 726b 2e67 6370 0a40 7079 7465 7374  mark.gcp.@pytest
+00023190: 2e6d 6172 6b2e 7365 7276 650a 6465 6620  .mark.serve.def 
+000231a0: 7465 7374 5f73 6b79 7365 7276 655f 6479  test_skyserve_dy
+000231b0: 6e61 6d69 635f 6f6e 6465 6d61 6e64 5f66  namic_ondemand_f
+000231c0: 616c 6c62 6163 6b28 293a 0a20 2020 206e  allback():.    n
+000231d0: 616d 6520 3d20 5f67 6574 5f73 6572 7669  ame = _get_servi
+000231e0: 6365 5f6e 616d 6528 290a 2020 2020 7a6f  ce_name().    zo
+000231f0: 6e65 203d 2027 7573 2d63 656e 7472 616c  ne = 'us-central
+00023200: 312d 6127 0a0a 2020 2020 7465 7374 203d  1-a'..    test =
+00023210: 2054 6573 7428 0a20 2020 2020 2020 2066   Test(.        f
+00023220: 2774 6573 742d 736b 7973 6572 7665 2d64  'test-skyserve-d
+00023230: 796e 616d 6963 2d6f 6e64 656d 616e 642d  ynamic-ondemand-
+00023240: 6661 6c6c 6261 636b 272c 0a20 2020 2020  fallback',.     
+00023250: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00023260: 2066 2773 6b79 2073 6572 7665 2075 7020   f'sky serve up 
+00023270: 2d6e 207b 6e61 6d65 7d20 2d2d 636c 6f75  -n {name} --clou
+00023280: 6420 6763 7020 2d79 2074 6573 7473 2f73  d gcp -y tests/s
+00023290: 6b79 7365 7276 652f 7370 6f74 2f64 796e  kyserve/spot/dyn
+000232a0: 616d 6963 5f6f 6e64 656d 616e 645f 6661  amic_ondemand_fa
+000232b0: 6c6c 6261 636b 2e79 616d 6c27 2c0a 2020  llback.yaml',.  
+000232c0: 2020 2020 2020 2020 2020 6627 736c 6565            f'slee
+000232d0: 7020 3430 272c 0a20 2020 2020 2020 2020  p 40',.         
+000232e0: 2020 2023 2032 206f 6e2d 6465 6d61 6e64     # 2 on-demand
+000232f0: 2028 7072 6f76 6973 696f 6e69 6e67 2920   (provisioning) 
+00023300: 2b20 3220 5370 6f74 2028 7072 6f76 6973  + 2 Spot (provis
+00023310: 696f 6e69 6e67 292e 0a20 2020 2020 2020  ioning)..       
+00023320: 2020 2020 2066 277b 5f53 4552 5645 5f53       f'{_SERVE_S
+00023330: 5441 5455 535f 5741 4954 2e66 6f72 6d61  TATUS_WAIT.forma
+00023340: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2065  t(name=name)}; e
+00023350: 6368 6f20 2224 7322 3b27 0a20 2020 2020  cho "$s";'.     
+00023360: 2020 2020 2020 2027 6563 686f 2022 2473         'echo "$s
+00023370: 2220 7c20 6772 6570 202d 7120 2230 2f34  " | grep -q "0/4
+00023380: 2220 7c7c 2065 7869 7420 3127 2c0a 2020  " || exit 1',.  
+00023390: 2020 2020 2020 2020 2020 2320 5761 6974            # Wait
+000233a0: 2066 6f72 2074 6865 2070 726f 7669 7369   for the provisi
+000233b0: 6f6e 696e 6720 7374 6172 7473 0a20 2020  oning starts.   
+000233c0: 2020 2020 2020 2020 2066 2773 6c65 6570           f'sleep
+000233d0: 2034 3027 2c0a 2020 2020 2020 2020 2020   40',.          
+000233e0: 2020 5f63 6865 636b 5f72 6570 6c69 6361    _check_replica
+000233f0: 5f69 6e5f 7374 6174 7573 286e 616d 652c  _in_status(name,
+00023400: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+00023410: 2020 2028 322c 2054 7275 652c 205f 5345     (2, True, _SE
+00023420: 5256 4943 455f 4c41 554e 4348 494e 475f  RVICE_LAUNCHING_
+00023430: 5354 4154 5553 5f52 4547 4558 202b 2027  STATUS_REGEX + '
+00023440: 5c7c 5245 4144 5927 292c 0a20 2020 2020  \|READY'),.     
+00023450: 2020 2020 2020 2020 2020 2028 322c 2046             (2, F
+00023460: 616c 7365 2c20 5f53 4552 5649 4345 5f4c  alse, _SERVICE_L
+00023470: 4155 4e43 4849 4e47 5f53 5441 5455 535f  AUNCHING_STATUS_
+00023480: 5245 4745 5820 2b20 275c 7c53 4855 5454  REGEX + '\|SHUTT
+00023490: 494e 475f 444f 574e 2729 0a20 2020 2020  ING_DOWN').     
+000234a0: 2020 2020 2020 205d 292c 0a0a 2020 2020         ]),..    
+000234b0: 2020 2020 2020 2020 2320 5761 6974 2075          # Wait u
+000234c0: 6e74 696c 2032 2073 706f 7420 696e 7374  ntil 2 spot inst
+000234d0: 616e 6365 7320 6172 6520 7265 6164 792e  ances are ready.
+000234e0: 0a20 2020 2020 2020 2020 2020 205f 5345  .            _SE
+000234f0: 5256 455f 5741 4954 5f55 4e54 494c 5f52  RVE_WAIT_UNTIL_R
+00023500: 4541 4459 2e66 6f72 6d61 7428 6e61 6d65  EADY.format(name
+00023510: 3d6e 616d 652c 2072 6570 6c69 6361 5f6e  =name, replica_n
+00023520: 756d 3d32 292c 0a20 2020 2020 2020 2020  um=2),.         
+00023530: 2020 205f 6368 6563 6b5f 7265 706c 6963     _check_replic
+00023540: 615f 696e 5f73 7461 7475 7328 6e61 6d65  a_in_status(name
+00023550: 2c20 5b28 322c 2054 7275 652c 2027 5245  , [(2, True, 'RE
+00023560: 4144 5927 292c 0a20 2020 2020 2020 2020  ADY'),.         
+00023570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023590: 2020 2028 302c 2046 616c 7365 2c20 2727     (0, False, ''
+000235a0: 295d 292c 0a20 2020 2020 2020 2020 2020  )]),.           
+000235b0: 205f 7465 726d 696e 6174 655f 6763 705f   _terminate_gcp_
+000235c0: 7265 706c 6963 6128 6e61 6d65 2c20 7a6f  replica(name, zo
+000235d0: 6e65 2c20 3129 2c0a 2020 2020 2020 2020  ne, 1),.        
+000235e0: 2020 2020 6627 736c 6565 7020 3430 272c      f'sleep 40',
+000235f0: 0a20 2020 2020 2020 2020 2020 2023 2031  .            # 1
+00023600: 206f 6e2d 6465 6d61 6e64 2028 7072 6f76   on-demand (prov
+00023610: 6973 696f 6e69 6e67 2920 2b20 3120 5370  isioning) + 1 Sp
+00023620: 6f74 2028 7265 6164 7929 202b 2031 2073  ot (ready) + 1 s
+00023630: 706f 7420 2870 726f 7669 7369 6f6e 696e  pot (provisionin
+00023640: 6729 2e0a 2020 2020 2020 2020 2020 2020  g)..            
+00023650: 6627 7b5f 5345 5256 455f 5354 4154 5553  f'{_SERVE_STATUS
+00023660: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
+00023670: 653d 6e61 6d65 297d 3b20 270a 2020 2020  e=name)}; '.    
+00023680: 2020 2020 2020 2020 2765 6368 6f20 2224          'echo "$
+00023690: 7322 207c 2067 7265 7020 2d71 2022 312f  s" | grep -q "1/
+000236a0: 3322 272c 0a20 2020 2020 2020 2020 2020  3"',.           
+000236b0: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
+000236c0: 696e 5f73 7461 7475 7328 0a20 2020 2020  in_status(.     
+000236d0: 2020 2020 2020 2020 2020 206e 616d 652c             name,
+000236e0: 205b 2831 2c20 5472 7565 2c20 2752 4541   [(1, True, 'REA
+000236f0: 4459 2729 2c0a 2020 2020 2020 2020 2020  DY'),.          
+00023700: 2020 2020 2020 2020 2020 2020 2028 312c               (1,
+00023710: 2054 7275 652c 205f 5345 5256 4943 455f   True, _SERVICE_
+00023720: 4c41 554e 4348 494e 475f 5354 4154 5553  LAUNCHING_STATUS
+00023730: 5f52 4547 4558 292c 0a20 2020 2020 2020  _REGEX),.       
+00023740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023750: 2831 2c20 4661 6c73 652c 205f 5345 5256  (1, False, _SERV
+00023760: 4943 455f 4c41 554e 4348 494e 475f 5354  ICE_LAUNCHING_ST
+00023770: 4154 5553 5f52 4547 4558 295d 292c 0a0a  ATUS_REGEX)]),..
+00023780: 2020 2020 2020 2020 2020 2020 2320 5761              # Wa
+00023790: 6974 2075 6e74 696c 2032 2073 706f 7420  it until 2 spot 
+000237a0: 696e 7374 616e 6365 7320 6172 6520 7265  instances are re
+000237b0: 6164 792e 0a20 2020 2020 2020 2020 2020  ady..           
+000237c0: 205f 5345 5256 455f 5741 4954 5f55 4e54   _SERVE_WAIT_UNT
+000237d0: 494c 5f52 4541 4459 2e66 6f72 6d61 7428  IL_READY.format(
+000237e0: 6e61 6d65 3d6e 616d 652c 2072 6570 6c69  name=name, repli
+000237f0: 6361 5f6e 756d 3d32 292c 0a20 2020 2020  ca_num=2),.     
+00023800: 2020 2020 2020 205f 6368 6563 6b5f 7265         _check_re
+00023810: 706c 6963 615f 696e 5f73 7461 7475 7328  plica_in_status(
+00023820: 6e61 6d65 2c20 5b28 322c 2054 7275 652c  name, [(2, True,
+00023830: 2027 5245 4144 5927 292c 0a20 2020 2020   'READY'),.     
+00023840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023860: 2020 2020 2020 2028 302c 2046 616c 7365         (0, False
+00023870: 2c20 2727 295d 292c 0a20 2020 2020 2020  , '')]),.       
+00023880: 205d 2c0a 2020 2020 2020 2020 5f54 4541   ],.        _TEA
+00023890: 5244 4f57 4e5f 5345 5256 4943 452e 666f  RDOWN_SERVICE.fo
+000238a0: 726d 6174 286e 616d 653d 6e61 6d65 292c  rmat(name=name),
+000238b0: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+000238c0: 3d32 3020 2a20 3630 2c0a 2020 2020 290a  =20 * 60,.    ).
+000238d0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+000238e0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+000238f0: 2e6d 6172 6b2e 7365 7276 650a 4070 7974  .mark.serve.@pyt
+00023900: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
+00023910: 726e 6574 6573 0a64 6566 2074 6573 745f  rnetes.def test_
+00023920: 736b 7973 6572 7665 5f75 7365 725f 6275  skyserve_user_bu
+00023930: 675f 7265 7374 6172 7428 6765 6e65 7269  g_restart(generi
+00023940: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+00023950: 2020 2022 2222 5465 7374 7320 7468 6174     """Tests that
+00023960: 2077 6520 7265 7374 6172 7420 7468 6520   we restart the 
+00023970: 7365 7276 6963 6520 6166 7465 7220 7573  service after us
+00023980: 6572 2062 7567 2e22 2222 0a20 2020 2023  er bug.""".    #
+00023990: 2054 4f44 4f28 7a68 7775 293a 2074 6869   TODO(zhwu): thi
+000239a0: 7320 6265 6861 7669 6f72 206e 6565 6473  s behavior needs
+000239b0: 2073 6f6d 6520 7265 7468 696e 6b69 6e67   some rethinking
+000239c0: 2e0a 2020 2020 6e61 6d65 203d 205f 6765  ..    name = _ge
+000239d0: 745f 7365 7276 6963 655f 6e61 6d65 2829  t_service_name()
+000239e0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+000239f0: 280a 2020 2020 2020 2020 6627 7465 7374  (.        f'test
+00023a00: 2d73 6b79 7365 7276 652d 7573 6572 2d62  -skyserve-user-b
+00023a10: 7567 2d72 6573 7461 7274 272c 0a20 2020  ug-restart',.   
+00023a20: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00023a30: 2020 2066 2773 6b79 2073 6572 7665 2075     f'sky serve u
+00023a40: 7020 2d6e 207b 6e61 6d65 7d20 2d2d 636c  p -n {name} --cl
+00023a50: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+00023a60: 7564 7d20 2d79 2074 6573 7473 2f73 6b79  ud} -y tests/sky
+00023a70: 7365 7276 652f 7265 7374 6172 742f 7573  serve/restart/us
+00023a80: 6572 5f62 7567 2e79 616d 6c27 2c0a 2020  er_bug.yaml',.  
+00023a90: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+00023aa0: 736b 7920 7365 7276 6520 7374 6174 7573  sky serve status
+00023ab0: 207b 6e61 6d65 7d29 3b20 6563 686f 2022   {name}); echo "
+00023ac0: 2473 223b 270a 2020 2020 2020 2020 2020  $s";'.          
+00023ad0: 2020 2775 6e74 696c 2065 6368 6f20 2224    'until echo "$
+00023ae0: 7322 207c 2067 7265 7020 2d41 2031 3030  s" | grep -A 100
+00023af0: 2022 5365 7276 6963 6520 5265 706c 6963   "Service Replic
+00023b00: 6173 2220 7c20 6772 6570 2022 5348 5554  as" | grep "SHUT
+00023b10: 5449 4e47 5f44 4f57 4e22 3b20 270a 2020  TING_DOWN"; '.  
+00023b20: 2020 2020 2020 2020 2020 2764 6f20 6563            'do ec
+00023b30: 686f 2022 5761 6974 696e 6720 666f 7220  ho "Waiting for 
+00023b40: 6669 7273 7420 7365 7276 6963 6520 746f  first service to
+00023b50: 2062 6520 5348 5554 5449 4e47 2044 4f57   be SHUTTING DOW
+00023b60: 4e2e 2e2e 223b 2027 0a20 2020 2020 2020  N..."; '.       
+00023b70: 2020 2020 2066 2773 6c65 6570 2035 3b20       f'sleep 5; 
+00023b80: 733d 2428 736b 7920 7365 7276 6520 7374  s=$(sky serve st
+00023b90: 6174 7573 207b 6e61 6d65 7d29 3b20 6563  atus {name}); ec
+00023ba0: 686f 2022 2473 223b 2064 6f6e 653b 2027  ho "$s"; done; '
+00023bb0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00023bc0: 733d 2428 736b 7920 7365 7276 6520 7374  s=$(sky serve st
+00023bd0: 6174 7573 207b 6e61 6d65 7d29 3b20 6563  atus {name}); ec
+00023be0: 686f 2022 2473 223b 270a 2020 2020 2020  ho "$s";'.      
+00023bf0: 2020 2020 2020 2775 6e74 696c 2065 6368        'until ech
+00023c00: 6f20 2224 7322 207c 2067 7265 7020 2d41  o "$s" | grep -A
+00023c10: 2031 3030 2022 5365 7276 6963 6520 5265   100 "Service Re
+00023c20: 706c 6963 6173 2220 7c20 6772 6570 2022  plicas" | grep "
+00023c30: 4641 494c 4544 223b 2027 0a20 2020 2020  FAILED"; '.     
+00023c40: 2020 2020 2020 2027 646f 2065 6368 6f20         'do echo 
+00023c50: 2257 6169 7469 6e67 2066 6f72 2066 6972  "Waiting for fir
+00023c60: 7374 2073 6572 7669 6365 2074 6f20 6265  st service to be
+00023c70: 2046 4149 4c45 442e 2e2e 223b 2027 0a20   FAILED..."; '. 
+00023c80: 2020 2020 2020 2020 2020 2066 2773 6c65             f'sle
+00023c90: 6570 2035 3b20 733d 2428 736b 7920 7365  ep 5; s=$(sky se
+00023ca0: 7276 6520 7374 6174 7573 207b 6e61 6d65  rve status {name
+00023cb0: 7d29 3b20 6563 686f 2022 2473 223b 2064  }); echo "$s"; d
+00023cc0: 6f6e 653b 2065 6368 6f20 2224 7322 3b20  one; echo "$s"; 
+00023cd0: 270a 2020 2020 2020 2020 2020 2020 2b20  '.            + 
+00023ce0: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
+00023cf0: 6e5f 7374 6174 7573 286e 616d 652c 205b  n_status(name, [
+00023d00: 2831 2c20 5472 7565 2c20 2746 4149 4c45  (1, True, 'FAILE
+00023d10: 4427 295d 2920 2b0a 2020 2020 2020 2020  D')]) +.        
+00023d20: 2020 2020 2320 5573 6572 2062 7567 2066      # User bug f
+00023d30: 6169 6c75 7265 2077 696c 6c20 6361 7573  ailure will caus
+00023d40: 6520 6e6f 2066 7572 7468 6572 2073 6361  e no further sca
+00023d50: 6c69 6e67 2e0a 2020 2020 2020 2020 2020  ling..          
+00023d60: 2020 6627 6563 686f 2022 2473 2220 7c20    f'echo "$s" | 
+00023d70: 6772 6570 202d 4120 3130 3020 2253 6572  grep -A 100 "Ser
+00023d80: 7669 6365 2052 6570 6c69 6361 7322 207c  vice Replicas" |
+00023d90: 2067 7265 7020 227b 6e61 6d65 7d22 207c   grep "{name}" |
+00023da0: 2077 6320 2d6c 207c 2067 7265 7020 313b   wc -l | grep 1;
+00023db0: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
+00023dc0: 2765 6368 6f20 2224 7322 207c 2067 7265  'echo "$s" | gre
+00023dd0: 7020 2d42 2031 3030 2022 4e4f 5f52 4550  p -B 100 "NO_REP
+00023de0: 4c49 4341 2220 7c20 6772 6570 2022 302f  LICA" | grep "0/
+00023df0: 3022 272c 0a20 2020 2020 2020 2020 2020  0"',.           
+00023e00: 2066 2773 6b79 2073 6572 7665 2075 7064   f'sky serve upd
+00023e10: 6174 6520 7b6e 616d 657d 202d 2d63 6c6f  ate {name} --clo
+00023e20: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
+00023e30: 647d 202d 7920 7465 7374 732f 736b 7973  d} -y tests/skys
+00023e40: 6572 7665 2f61 7574 6f5f 7265 7374 6172  erve/auto_restar
+00023e50: 742e 7961 6d6c 272c 0a20 2020 2020 2020  t.yaml',.       
+00023e60: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
+00023e70: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
+00023e80: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
+00023e90: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
+00023ea0: 756e 7469 6c20 6375 726c 202d 4c20 6874  until curl -L ht
+00023eb0: 7470 3a2f 2f24 656e 6470 6f69 6e74 207c  tp://$endpoint |
+00023ec0: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
+00023ed0: 6c6f 7420 6865 7265 2122 3b20 646f 2073  lot here!"; do s
+00023ee0: 6c65 6570 2032 3b20 646f 6e65 3b20 736c  leep 2; done; sl
+00023ef0: 6565 7020 323b 2027 0a20 2020 2020 2020  eep 2; '.       
+00023f00: 2020 2020 202b 205f 6368 6563 6b5f 7265       + _check_re
+00023f10: 706c 6963 615f 696e 5f73 7461 7475 7328  plica_in_status(
+00023f20: 6e61 6d65 2c20 5b28 312c 2046 616c 7365  name, [(1, False
+00023f30: 2c20 2752 4541 4459 2729 2c0a 2020 2020  , 'READY'),.    
+00023f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023f60: 2020 2020 2020 2020 2020 2831 2c20 4661            (1, Fa
+00023f70: 6c73 652c 2027 4641 494c 4544 2729 5d29  lse, 'FAILED')])
+00023f80: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00023f90: 2020 2020 205f 5445 4152 444f 574e 5f53       _TEARDOWN_S
+00023fa0: 4552 5649 4345 2e66 6f72 6d61 7428 6e61  ERVICE.format(na
+00023fb0: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
+00023fc0: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
+00023fd0: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
+00023fe0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00023ff0: 0a0a 4070 7974 6573 742e 6d61 726b 2e73  ..@pytest.mark.s
+00024000: 6572 7665 0a40 7079 7465 7374 2e6d 6172  erve.@pytest.mar
+00024010: 6b2e 6e6f 5f6b 7562 6572 6e65 7465 730a  k.no_kubernetes.
+00024020: 6465 6620 7465 7374 5f73 6b79 7365 7276  def test_skyserv
+00024030: 655f 6c6f 6164 5f62 616c 616e 6365 7228  e_load_balancer(
+00024040: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
+00024050: 7472 293a 0a20 2020 2022 2222 5465 7374  tr):.    """Test
+00024060: 2073 6b79 7365 7276 6520 6c6f 6164 2062   skyserve load b
+00024070: 616c 616e 6365 7220 726f 756e 642d 726f  alancer round-ro
+00024080: 6269 6e20 706f 6c69 6379 2222 220a 2020  bin policy""".  
+00024090: 2020 6e61 6d65 203d 205f 6765 745f 7365    name = _get_se
+000240a0: 7276 6963 655f 6e61 6d65 2829 0a20 2020  rvice_name().   
+000240b0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+000240c0: 2020 2020 2020 6627 7465 7374 2d73 6b79        f'test-sky
+000240d0: 7365 7276 652d 6c6f 6164 2d62 616c 616e  serve-load-balan
+000240e0: 6365 7227 2c0a 2020 2020 2020 2020 5b0a  cer',.        [.
+000240f0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00024100: 7920 7365 7276 6520 7570 202d 6e20 7b6e  y serve up -n {n
+00024110: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
+00024120: 6e65 7269 635f 636c 6f75 647d 202d 7920  neric_cloud} -y 
+00024130: 7465 7374 732f 736b 7973 6572 7665 2f6c  tests/skyserve/l
+00024140: 6f61 645f 6261 6c61 6e63 6572 2f73 6572  oad_balancer/ser
+00024150: 7669 6365 2e79 616d 6c27 2c0a 2020 2020  vice.yaml',.    
+00024160: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
+00024170: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
+00024180: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00024190: 2c20 7265 706c 6963 615f 6e75 6d3d 3329  , replica_num=3)
+000241a0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000241b0: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
+000241c0: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
+000241d0: 653d 6e61 6d65 297d 3b20 270a 2020 2020  e=name)}; '.    
+000241e0: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
+000241f0: 455f 5354 4154 5553 5f57 4149 542e 666f  E_STATUS_WAIT.fo
+00024200: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
+00024210: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+00024220: 6627 7b5f 6765 745f 7265 706c 6963 615f  f'{_get_replica_
+00024230: 6970 286e 616d 652c 2031 297d 3b20 270a  ip(name, 1)}; '.
+00024240: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00024250: 6765 745f 7265 706c 6963 615f 6970 286e  get_replica_ip(n
+00024260: 616d 652c 2032 297d 3b20 7b5f 6765 745f  ame, 2)}; {_get_
+00024270: 7265 706c 6963 615f 6970 286e 616d 652c  replica_ip(name,
+00024280: 2033 297d 3b20 270a 2020 2020 2020 2020   3)}; '.        
+00024290: 2020 2020 2770 7974 686f 6e20 7465 7374      'python test
+000242a0: 732f 736b 7973 6572 7665 2f6c 6f61 645f  s/skyserve/load_
+000242b0: 6261 6c61 6e63 6572 2f74 6573 745f 726f  balancer/test_ro
+000242c0: 756e 645f 726f 6269 6e2e 7079 2027 0a20  und_robin.py '. 
+000242d0: 2020 2020 2020 2020 2020 2027 2d2d 656e             '--en
+000242e0: 6470 6f69 6e74 2024 656e 6470 6f69 6e74  dpoint $endpoint
+000242f0: 202d 2d72 6570 6c69 6361 2d6e 756d 2033   --replica-num 3
+00024300: 202d 2d72 6570 6c69 6361 2d69 7073 2024   --replica-ips $
+00024310: 6970 3120 2469 7032 2024 6970 3327 2c0a  ip1 $ip2 $ip3',.
+00024320: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00024330: 2020 205f 5445 4152 444f 574e 5f53 4552     _TEARDOWN_SER
+00024340: 5649 4345 2e66 6f72 6d61 7428 6e61 6d65  VICE.format(name
+00024350: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
+00024360: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
+00024370: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00024380: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00024390: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
+000243a0: 0a40 7079 7465 7374 2e6d 6172 6b2e 7365  .@pytest.mark.se
+000243b0: 7276 650a 4070 7974 6573 742e 6d61 726b  rve.@pytest.mark
+000243c0: 2e6e 6f5f 6b75 6265 726e 6574 6573 0a64  .no_kubernetes.d
+000243d0: 6566 2074 6573 745f 736b 7973 6572 7665  ef test_skyserve
+000243e0: 5f61 7574 6f5f 7265 7374 6172 7428 293a  _auto_restart():
+000243f0: 0a20 2020 2022 2222 5465 7374 2073 6b79  .    """Test sky
+00024400: 7365 7276 6520 7769 7468 2061 7574 6f20  serve with auto 
+00024410: 7265 7374 6172 7422 2222 0a20 2020 206e  restart""".    n
+00024420: 616d 6520 3d20 5f67 6574 5f73 6572 7669  ame = _get_servi
+00024430: 6365 5f6e 616d 6528 290a 2020 2020 7a6f  ce_name().    zo
+00024440: 6e65 203d 2027 7573 2d63 656e 7472 616c  ne = 'us-central
+00024450: 312d 6127 0a20 2020 2074 6573 7420 3d20  1-a'.    test = 
+00024460: 5465 7374 280a 2020 2020 2020 2020 6627  Test(.        f'
+00024470: 7465 7374 2d73 6b79 7365 7276 652d 6175  test-skyserve-au
+00024480: 746f 2d72 6573 7461 7274 272c 0a20 2020  to-restart',.   
+00024490: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+000244a0: 2020 2023 2054 4f44 4f28 7469 616e 293a     # TODO(tian):
+000244b0: 2077 6520 6361 6e20 6479 6e61 6d69 6361   we can dynamica
+000244c0: 6c6c 7920 6765 6e65 7261 7465 2059 414d  lly generate YAM
+000244d0: 4c20 6672 6f6d 2074 656d 706c 6174 6520  L from template 
+000244e0: 746f 0a20 2020 2020 2020 2020 2020 2023  to.            #
+000244f0: 2061 766f 6964 206d 6169 6e74 6169 6e69   avoid maintaini
+00024500: 6e67 2074 6f6f 206d 616e 7920 5941 4d4c  ng too many YAML
+00024510: 2066 696c 6573 0a20 2020 2020 2020 2020   files.         
+00024520: 2020 2066 2773 6b79 2073 6572 7665 2075     f'sky serve u
+00024530: 7020 2d6e 207b 6e61 6d65 7d20 2d79 2074  p -n {name} -y t
+00024540: 6573 7473 2f73 6b79 7365 7276 652f 6175  ests/skyserve/au
+00024550: 746f 5f72 6573 7461 7274 2e79 616d 6c27  to_restart.yaml'
+00024560: 2c0a 2020 2020 2020 2020 2020 2020 5f53  ,.            _S
+00024570: 4552 5645 5f57 4149 545f 554e 5449 4c5f  ERVE_WAIT_UNTIL_
+00024580: 5245 4144 592e 666f 726d 6174 286e 616d  READY.format(nam
+00024590: 653d 6e61 6d65 2c20 7265 706c 6963 615f  e=name, replica_
+000245a0: 6e75 6d3d 3129 2c0a 2020 2020 2020 2020  num=1),.        
+000245b0: 2020 2020 6627 7b5f 5345 5256 455f 454e      f'{_SERVE_EN
+000245c0: 4450 4f49 4e54 5f57 4149 542e 666f 726d  DPOINT_WAIT.form
+000245d0: 6174 286e 616d 653d 6e61 6d65 297d 3b20  at(name=name)}; 
+000245e0: 270a 2020 2020 2020 2020 2020 2020 2763  '.            'c
+000245f0: 7572 6c20 2d4c 2068 7474 703a 2f2f 2465  url -L http://$e
+00024600: 6e64 706f 696e 7420 7c20 6772 6570 2022  ndpoint | grep "
+00024610: 4869 2c20 536b 7950 696c 6f74 2068 6572  Hi, SkyPilot her
+00024620: 6522 272c 0a20 2020 2020 2020 2020 2020  e"',.           
+00024630: 2023 2073 6c65 6570 2066 6f72 2032 3020   # sleep for 20 
+00024640: 7365 636f 6e64 7320 2869 6e69 7469 616c  seconds (initial
+00024650: 2064 656c 6179 2920 746f 206d 616b 6520   delay) to make 
+00024660: 7375 7265 2069 7420 7769 6c6c 0a20 2020  sure it will.   
+00024670: 2020 2020 2020 2020 2023 2062 6520 7265           # be re
+00024680: 7374 6172 7465 640a 2020 2020 2020 2020  started.        
+00024690: 2020 2020 6627 736c 6565 7020 3230 272c      f'sleep 20',
+000246a0: 0a20 2020 2020 2020 2020 2020 205f 7465  .            _te
+000246b0: 726d 696e 6174 655f 6763 705f 7265 706c  rminate_gcp_repl
+000246c0: 6963 6128 6e61 6d65 2c20 7a6f 6e65 2c20  ica(name, zone, 
+000246d0: 3129 2c0a 2020 2020 2020 2020 2020 2020  1),.            
+000246e0: 2320 5761 6974 2066 6f72 2063 6f6e 7365  # Wait for conse
+000246f0: 6375 7469 7665 2066 6169 6c75 7265 2074  cutive failure t
+00024700: 696d 656f 7574 2070 6173 7365 642e 0a20  imeout passed.. 
+00024710: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
+00024720: 7468 6520 636c 7573 7465 7220 6973 206e  the cluster is n
+00024730: 6f74 2075 7369 6e67 2073 706f 742c 2069  ot using spot, i
+00024740: 7420 776f 6e27 7420 6368 6563 6b20 7468  t won't check th
+00024750: 6520 636c 7573 7465 7220 7374 6174 7573  e cluster status
+00024760: 0a20 2020 2020 2020 2020 2020 2023 206f  .            # o
+00024770: 6e20 7468 6520 636c 6f75 6420 2873 696e  n the cloud (sin
+00024780: 6365 206d 616e 7561 6c20 7368 7574 646f  ce manual shutdo
+00024790: 776e 2069 7320 6e6f 7420 6120 636f 6d6d  wn is not a comm
+000247a0: 6f6e 2062 6568 6176 696f 7220 616e 6420  on behavior and 
+000247b0: 7375 6368 0a20 2020 2020 2020 2020 2020  such.           
+000247c0: 2023 2071 7565 7269 6573 2074 616b 6573   # queries takes
+000247d0: 2061 206c 6f74 206f 6620 7469 6d65 292e   a lot of time).
+000247e0: 2049 6e73 7465 6164 2c20 7765 2074 6869   Instead, we thi
+000247f0: 6e6b 2063 6f6e 7469 6e75 6f75 7320 3320  nk continuous 3 
+00024800: 6d69 6e20 7072 6f62 650a 2020 2020 2020  min probe.      
+00024810: 2020 2020 2020 2320 6661 696c 7572 6520        # failure 
+00024820: 6973 206e 6f74 2061 2074 656d 706f 7261  is not a tempora
+00024830: 7279 2070 726f 626c 656d 2062 7574 2069  ry problem but i
+00024840: 6e64 6565 6420 6120 6661 696c 7572 652e  ndeed a failure.
+00024850: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+00024860: 6565 7020 3138 3027 2c0a 2020 2020 2020  eep 180',.      
+00024870: 2020 2020 2020 2320 5765 2063 616e 6e6f        # We canno
+00024880: 7420 7573 6520 5f53 4552 5645 5f57 4149  t use _SERVE_WAI
+00024890: 545f 554e 5449 4c5f 5245 4144 593b 2074  T_UNTIL_READY; t
+000248a0: 6865 7265 2077 696c 6c20 6265 2061 2069  here will be a i
+000248b0: 6e74 6572 6d65 6469 6174 6520 7469 6d65  ntermediate time
+000248c0: 0a20 2020 2020 2020 2020 2020 2023 2074  .            # t
+000248d0: 6861 7420 7468 6520 6f75 7470 7574 206f  hat the output o
+000248e0: 6620 6073 6b79 2073 6572 7665 2073 7461  f `sky serve sta
+000248f0: 7475 7360 2073 686f 7773 2046 4149 4c45  tus` shows FAILE
+00024900: 4420 616e 6420 7468 6973 2073 7461 7475  D and this statu
+00024910: 7320 7769 6c6c 0a20 2020 2020 2020 2020  s will.         
+00024920: 2020 2023 2063 6175 7365 205f 5345 5256     # cause _SERV
+00024930: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
+00024940: 4459 2074 6f20 6561 726c 7920 7175 6974  DY to early quit
+00024950: 2e0a 2020 2020 2020 2020 2020 2020 2728  ..            '(
+00024960: 7768 696c 6520 7472 7565 3b20 646f 270a  while true; do'.
+00024970: 2020 2020 2020 2020 2020 2020 6627 2020              f'  
+00024980: 2020 6f75 7470 7574 3d24 2873 6b79 2073    output=$(sky s
+00024990: 6572 7665 2073 7461 7475 7320 7b6e 616d  erve status {nam
+000249a0: 657d 293b 270a 2020 2020 2020 2020 2020  e});'.          
+000249b0: 2020 2720 2020 2020 6563 686f 2022 246f    '     echo "$o
+000249c0: 7574 7075 7422 207c 2067 7265 7020 2d71  utput" | grep -q
+000249d0: 2022 312f 3122 2026 2620 6272 6561 6b3b   "1/1" && break;
+000249e0: 270a 2020 2020 2020 2020 2020 2020 2720  '.            ' 
+000249f0: 2020 2020 736c 6565 7020 3130 3b27 0a20      sleep 10;'. 
+00024a00: 2020 2020 2020 2020 2020 2066 2764 6f6e             f'don
+00024a10: 6529 3b20 736c 6565 7020 7b73 6572 7665  e); sleep {serve
+00024a20: 2e4c 425f 434f 4e54 524f 4c4c 4552 5f53  .LB_CONTROLLER_S
+00024a30: 594e 435f 494e 5445 5256 414c 5f53 4543  YNC_INTERVAL_SEC
+00024a40: 4f4e 4453 7d3b 272c 0a20 2020 2020 2020  ONDS};',.       
+00024a50: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
+00024a60: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
+00024a70: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
+00024a80: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
+00024a90: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
+00024aa0: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
+00024ab0: 2248 692c 2053 6b79 5069 6c6f 7420 6865  "Hi, SkyPilot he
+00024ac0: 7265 2227 2c0a 2020 2020 2020 2020 5d2c  re"',.        ],
+00024ad0: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
+00024ae0: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
+00024af0: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
+00024b00: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
+00024b10: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
+00024b20: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00024b30: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00024b40: 726b 2e73 6572 7665 0a40 7079 7465 7374  rk.serve.@pytest
+00024b50: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
+00024b60: 7465 730a 6465 6620 7465 7374 5f73 6b79  tes.def test_sky
+00024b70: 7365 7276 655f 6361 6e63 656c 2867 656e  serve_cancel(gen
+00024b80: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+00024b90: 3a0a 2020 2020 2222 2254 6573 7420 736b  :.    """Test sk
+00024ba0: 7973 6572 7665 2077 6974 6820 6361 6e63  yserve with canc
+00024bb0: 656c 2222 220a 2020 2020 6e61 6d65 203d  el""".    name =
+00024bc0: 205f 6765 745f 7365 7276 6963 655f 6e61   _get_service_na
+00024bd0: 6d65 2829 0a0a 2020 2020 7465 7374 203d  me()..    test =
+00024be0: 2054 6573 7428 0a20 2020 2020 2020 2066   Test(.        f
+00024bf0: 2774 6573 742d 736b 7973 6572 7665 2d63  'test-skyserve-c
+00024c00: 616e 6365 6c27 2c0a 2020 2020 2020 2020  ancel',.        
+00024c10: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00024c20: 736b 7920 7365 7276 6520 7570 202d 6e20  sky serve up -n 
+00024c30: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
+00024c40: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
+00024c50: 7920 7465 7374 732f 736b 7973 6572 7665  y tests/skyserve
+00024c60: 2f63 616e 6365 6c2f 6361 6e63 656c 2e79  /cancel/cancel.y
+00024c70: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00024c80: 2020 5f53 4552 5645 5f57 4149 545f 554e    _SERVE_WAIT_UN
+00024c90: 5449 4c5f 5245 4144 592e 666f 726d 6174  TIL_READY.format
+00024ca0: 286e 616d 653d 6e61 6d65 2c20 7265 706c  (name=name, repl
+00024cb0: 6963 615f 6e75 6d3d 3129 2c0a 2020 2020  ica_num=1),.    
+00024cc0: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
+00024cd0: 455f 454e 4450 4f49 4e54 5f57 4149 542e  E_ENDPOINT_WAIT.
+00024ce0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00024cf0: 297d 3b20 7079 7468 6f6e 3320 270a 2020  )}; python3 '.  
+00024d00: 2020 2020 2020 2020 2020 2774 6573 7473            'tests
+00024d10: 2f73 6b79 7365 7276 652f 6361 6e63 656c  /skyserve/cancel
+00024d20: 2f73 656e 645f 6361 6e63 656c 5f72 6571  /send_cancel_req
+00024d30: 7565 7374 2e70 7920 270a 2020 2020 2020  uest.py '.      
+00024d40: 2020 2020 2020 272d 2d65 6e64 706f 696e        '--endpoin
+00024d50: 7420 2465 6e64 706f 696e 7420 7c20 6772  t $endpoint | gr
+00024d60: 6570 2022 5265 7175 6573 7420 7761 7320  ep "Request was 
+00024d70: 6361 6e63 656c 6c65 6422 272c 0a20 2020  cancelled"',.   
+00024d80: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
+00024d90: 6b79 2073 6572 7665 206c 6f67 7320 7b6e  ky serve logs {n
+00024da0: 616d 657d 2031 202d 2d6e 6f2d 666f 6c6c  ame} 1 --no-foll
+00024db0: 6f77 293b 2027 0a20 2020 2020 2020 2020  ow); '.         
+00024dc0: 2020 2027 756e 7469 6c20 2120 6563 686f     'until ! echo
+00024dd0: 2022 2473 2220 7c20 6772 6570 2022 506c   "$s" | grep "Pl
+00024de0: 6561 7365 2077 6169 7420 666f 7220 7468  ease wait for th
+00024df0: 6520 636f 6e74 726f 6c6c 6572 2074 6f20  e controller to 
+00024e00: 6265 223b 2027 0a20 2020 2020 2020 2020  be"; '.         
+00024e10: 2020 2027 646f 2065 6368 6f20 2257 6169     'do echo "Wai
+00024e20: 7469 6e67 2066 6f72 2073 6572 7665 206c  ting for serve l
+00024e30: 6f67 7322 3b20 736c 6565 7020 3130 3b20  ogs"; sleep 10; 
+00024e40: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+00024e50: 733d 2428 736b 7920 7365 7276 6520 6c6f  s=$(sky serve lo
+00024e60: 6773 207b 6e61 6d65 7d20 3120 2d2d 6e6f  gs {name} 1 --no
+00024e70: 2d66 6f6c 6c6f 7729 3b20 646f 6e65 3b20  -follow); done; 
+00024e80: 270a 2020 2020 2020 2020 2020 2020 2765  '.            'e
+00024e90: 6368 6f20 2224 7322 3b20 6563 686f 2022  cho "$s"; echo "
+00024ea0: 2473 2220 7c20 6772 6570 2022 436c 6965  $s" | grep "Clie
+00024eb0: 6e74 2064 6973 636f 6e6e 6563 7465 642c  nt disconnected,
+00024ec0: 2073 746f 7070 696e 6720 636f 6d70 7574   stopping comput
+00024ed0: 6174 696f 6e22 272c 0a20 2020 2020 2020  ation"',.       
+00024ee0: 205d 2c0a 2020 2020 2020 2020 5f54 4541   ],.        _TEA
+00024ef0: 5244 4f57 4e5f 5345 5256 4943 452e 666f  RDOWN_SERVICE.fo
+00024f00: 726d 6174 286e 616d 653d 6e61 6d65 292c  rmat(name=name),
+00024f10: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+00024f20: 3d32 3020 2a20 3630 2c0a 2020 2020 290a  =20 * 60,.    ).
+00024f30: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00024f40: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00024f50: 2e6d 6172 6b2e 7365 7276 650a 4070 7974  .mark.serve.@pyt
+00024f60: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
+00024f70: 726e 6574 6573 0a64 6566 2074 6573 745f  rnetes.def test_
+00024f80: 736b 7973 6572 7665 5f75 7064 6174 6528  skyserve_update(
+00024f90: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
+00024fa0: 7472 293a 0a20 2020 2022 2222 5465 7374  tr):.    """Test
+00024fb0: 2073 6b79 7365 7276 6520 7769 7468 2075   skyserve with u
+00024fc0: 7064 6174 6522 2222 0a20 2020 206e 616d  pdate""".    nam
+00024fd0: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
+00024fe0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00024ff0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00025000: 2066 2774 6573 742d 736b 7973 6572 7665   f'test-skyserve
+00025010: 2d75 7064 6174 6527 2c0a 2020 2020 2020  -update',.      
+00025020: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00025030: 6627 736b 7920 7365 7276 6520 7570 202d  f'sky serve up -
+00025040: 6e20 7b6e 616d 657d 202d 2d63 6c6f 7564  n {name} --cloud
+00025050: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
+00025060: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
+00025070: 7665 2f75 7064 6174 652f 6f6c 642e 7961  ve/update/old.ya
+00025080: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00025090: 205f 5345 5256 455f 5741 4954 5f55 4e54   _SERVE_WAIT_UNT
+000250a0: 494c 5f52 4541 4459 2e66 6f72 6d61 7428  IL_READY.format(
+000250b0: 6e61 6d65 3d6e 616d 652c 2072 6570 6c69  name=name, repli
+000250c0: 6361 5f6e 756d 3d32 292c 0a20 2020 2020  ca_num=2),.     
+000250d0: 2020 2020 2020 2066 277b 5f53 4552 5645         f'{_SERVE
+000250e0: 5f45 4e44 504f 494e 545f 5741 4954 2e66  _ENDPOINT_WAIT.f
+000250f0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+00025100: 7d3b 2063 7572 6c20 2d4c 2068 7474 703a  }; curl -L http:
+00025110: 2f2f 2465 6e64 706f 696e 7420 7c20 6772  //$endpoint | gr
+00025120: 6570 2022 4869 2c20 536b 7950 696c 6f74  ep "Hi, SkyPilot
+00025130: 2068 6572 6522 272c 0a20 2020 2020 2020   here"',.       
+00025140: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
+00025150: 2075 7064 6174 6520 7b6e 616d 657d 202d   update {name} -
+00025160: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+00025170: 636c 6f75 647d 202d 2d6d 6f64 6520 626c  cloud} --mode bl
+00025180: 7565 5f67 7265 656e 202d 7920 7465 7374  ue_green -y test
+00025190: 732f 736b 7973 6572 7665 2f75 7064 6174  s/skyserve/updat
+000251a0: 652f 6e65 772e 7961 6d6c 272c 0a20 2020  e/new.yaml',.   
+000251b0: 2020 2020 2020 2020 2023 2073 6c65 6570           # sleep
+000251c0: 2062 6566 6f72 6520 7570 6461 7465 2069   before update i
+000251d0: 7320 7265 6769 7374 6572 6564 2e0a 2020  s registered..  
+000251e0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+000251f0: 2032 3027 2c0a 2020 2020 2020 2020 2020   20',.          
+00025200: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
+00025210: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
+00025220: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
+00025230: 2020 2020 2020 2020 2020 2020 2775 6e74              'unt
+00025240: 696c 2063 7572 6c20 2d4c 2068 7474 703a  il curl -L http:
+00025250: 2f2f 2465 6e64 706f 696e 7420 7c20 6772  //$endpoint | gr
+00025260: 6570 2022 4869 2c20 6e65 7720 536b 7950  ep "Hi, new SkyP
+00025270: 696c 6f74 2068 6572 6521 223b 2064 6f20  ilot here!"; do 
+00025280: 736c 6565 7020 323b 2064 6f6e 653b 270a  sleep 2; done;'.
+00025290: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
+000252a0: 6b65 2073 7572 6520 7468 6520 7472 6166  ke sure the traf
+000252b0: 6669 6320 6973 206e 6f74 206d 6978 6564  fic is not mixed
+000252c0: 0a20 2020 2020 2020 2020 2020 2027 6375  .            'cu
+000252d0: 726c 202d 4c20 6874 7470 3a2f 2f24 656e  rl -L http://$en
+000252e0: 6470 6f69 6e74 207c 2067 7265 7020 2248  dpoint | grep "H
+000252f0: 692c 206e 6577 2053 6b79 5069 6c6f 7420  i, new SkyPilot 
+00025300: 6865 7265 2227 2c0a 2020 2020 2020 2020  here"',.        
+00025310: 2020 2020 2320 5468 6520 6c61 7465 7374      # The latest
+00025320: 2032 2076 6572 7369 6f6e 2073 686f 756c   2 version shoul
+00025330: 6420 6265 2052 4541 4459 2061 6e64 2074  d be READY and t
+00025340: 6865 206f 6c64 6572 2076 6572 7369 6f6e  he older version
+00025350: 7320 7368 6f75 6c64 2062 6520 7368 7574  s should be shut
+00025360: 7469 6e67 2064 6f77 6e0a 2020 2020 2020  ting down.      
+00025370: 2020 2020 2020 285f 6368 6563 6b5f 7265        (_check_re
+00025380: 706c 6963 615f 696e 5f73 7461 7475 7328  plica_in_status(
+00025390: 6e61 6d65 2c20 5b28 322c 2046 616c 7365  name, [(2, False
+000253a0: 2c20 2752 4541 4459 2729 2c0a 2020 2020  , 'READY'),.    
+000253b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000253c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000253d0: 2020 2020 2020 2020 2028 322c 2046 616c           (2, Fal
+000253e0: 7365 2c20 2753 4855 5454 494e 475f 444f  se, 'SHUTTING_DO
+000253f0: 574e 2729 5d29 202b 0a20 2020 2020 2020  WN')]) +.       
+00025400: 2020 2020 2020 5f63 6865 636b 5f73 6572        _check_ser
+00025410: 7669 6365 5f76 6572 7369 6f6e 286e 616d  vice_version(nam
+00025420: 652c 2022 3222 2929 2c0a 2020 2020 2020  e, "2")),.      
+00025430: 2020 5d2c 0a20 2020 2020 2020 205f 5445    ],.        _TE
+00025440: 4152 444f 574e 5f53 4552 5649 4345 2e66  ARDOWN_SERVICE.f
+00025450: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+00025460: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+00025470: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
+00025480: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00025490: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+000254a0: 742e 6d61 726b 2e73 6572 7665 0a40 7079  t.mark.serve.@py
+000254b0: 7465 7374 2e6d 6172 6b2e 6e6f 5f6b 7562  test.mark.no_kub
+000254c0: 6572 6e65 7465 730a 6465 6620 7465 7374  ernetes.def test
+000254d0: 5f73 6b79 7365 7276 655f 726f 6c6c 696e  _skyserve_rollin
+000254e0: 675f 7570 6461 7465 2867 656e 6572 6963  g_update(generic
+000254f0: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
+00025500: 2020 2222 2254 6573 7420 736b 7973 6572    """Test skyser
+00025510: 7665 2077 6974 6820 726f 6c6c 696e 6720  ve with rolling 
+00025520: 7570 6461 7465 2222 220a 2020 2020 6e61  update""".    na
+00025530: 6d65 203d 205f 6765 745f 7365 7276 6963  me = _get_servic
+00025540: 655f 6e61 6d65 2829 0a20 2020 2073 696e  e_name().    sin
+00025550: 676c 655f 6e65 775f 7265 706c 6963 6120  gle_new_replica 
+00025560: 3d20 5f63 6865 636b 5f72 6570 6c69 6361  = _check_replica
+00025570: 5f69 6e5f 7374 6174 7573 280a 2020 2020  _in_status(.    
+00025580: 2020 2020 6e61 6d65 2c20 5b28 322c 2046      name, [(2, F
+00025590: 616c 7365 2c20 2752 4541 4459 2729 2c20  alse, 'READY'), 
+000255a0: 2831 2c20 4661 6c73 652c 205f 5345 5256  (1, False, _SERV
+000255b0: 4943 455f 4c41 554e 4348 494e 475f 5354  ICE_LAUNCHING_ST
+000255c0: 4154 5553 5f52 4547 4558 292c 0a20 2020  ATUS_REGEX),.   
+000255d0: 2020 2020 2020 2020 2020 2020 2831 2c20              (1, 
+000255e0: 4661 6c73 652c 2027 5348 5554 5449 4e47  False, 'SHUTTING
+000255f0: 5f44 4f57 4e27 295d 290a 2020 2020 7465  _DOWN')]).    te
+00025600: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00025610: 2020 2066 2774 6573 742d 736b 7973 6572     f'test-skyser
+00025620: 7665 2d72 6f6c 6c69 6e67 2d75 7064 6174  ve-rolling-updat
+00025630: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
+00025640: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00025650: 7365 7276 6520 7570 202d 6e20 7b6e 616d  serve up -n {nam
+00025660: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
+00025670: 7269 635f 636c 6f75 647d 202d 7920 7465  ric_cloud} -y te
+00025680: 7374 732f 736b 7973 6572 7665 2f75 7064  sts/skyserve/upd
+00025690: 6174 652f 6f6c 642e 7961 6d6c 272c 0a20  ate/old.yaml',. 
+000256a0: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
+000256b0: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
+000256c0: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
+000256d0: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
+000256e0: 3d32 292c 0a20 2020 2020 2020 2020 2020  =2),.           
+000256f0: 2066 277b 5f53 4552 5645 5f45 4e44 504f   f'{_SERVE_ENDPO
+00025700: 494e 545f 5741 4954 2e66 6f72 6d61 7428  INT_WAIT.format(
+00025710: 6e61 6d65 3d6e 616d 6529 7d3b 2063 7572  name=name)}; cur
+00025720: 6c20 2d4c 2068 7474 703a 2f2f 2465 6e64  l -L http://$end
+00025730: 706f 696e 7420 7c20 6772 6570 2022 4869  point | grep "Hi
+00025740: 2c20 536b 7950 696c 6f74 2068 6572 6522  , SkyPilot here"
+00025750: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00025760: 2773 6b79 2073 6572 7665 2075 7064 6174  'sky serve updat
+00025770: 6520 7b6e 616d 657d 202d 2d63 6c6f 7564  e {name} --cloud
+00025780: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
+00025790: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
+000257a0: 7665 2f75 7064 6174 652f 6e65 772e 7961  ve/update/new.ya
+000257b0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+000257c0: 2023 204d 616b 6520 7375 7265 2074 6865   # Make sure the
+000257d0: 2074 7261 6666 6963 2069 7320 6d69 7865   traffic is mixe
+000257e0: 6420 6163 726f 7373 2074 776f 2076 6572  d across two ver
+000257f0: 7369 6f6e 732c 2074 6865 2072 6570 6c69  sions, the repli
+00025800: 6361 730a 2020 2020 2020 2020 2020 2020  cas.            
+00025810: 2320 7769 7468 2065 7665 6e20 6964 2077  # with even id w
+00025820: 696c 6c20 736c 6565 7020 3630 2073 6563  ill sleep 60 sec
+00025830: 6f6e 6473 2062 6566 6f72 6520 6265 696e  onds before bein
+00025840: 6720 7265 6164 792c 2073 6f20 7765 0a20  g ready, so we. 
+00025850: 2020 2020 2020 2020 2020 2023 2073 686f             # sho
+00025860: 756c 6420 6265 2061 626c 6520 746f 2067  uld be able to g
+00025870: 6574 206f 6273 6572 7665 2074 6865 2070  et observe the p
+00025880: 6572 696f 6420 7468 6174 2074 6865 2074  eriod that the t
+00025890: 7261 6666 6963 2069 7320 6d69 7865 640a  raffic is mixed.
+000258a0: 2020 2020 2020 2020 2020 2020 2320 6163              # ac
+000258b0: 726f 7373 2074 776f 2076 6572 7369 6f6e  ross two version
+000258c0: 732e 0a20 2020 2020 2020 2020 2020 2066  s..            f
+000258d0: 277b 5f53 4552 5645 5f45 4e44 504f 494e  '{_SERVE_ENDPOIN
+000258e0: 545f 5741 4954 2e66 6f72 6d61 7428 6e61  T_WAIT.format(na
+000258f0: 6d65 3d6e 616d 6529 7d3b 2027 0a20 2020  me=name)}; '.   
+00025900: 2020 2020 2020 2020 2027 756e 7469 6c20           'until 
+00025910: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
+00025920: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
+00025930: 2248 692c 206e 6577 2053 6b79 5069 6c6f  "Hi, new SkyPilo
+00025940: 7420 6865 7265 2122 3b20 646f 2073 6c65  t here!"; do sle
+00025950: 6570 2032 3b20 646f 6e65 3b20 736c 6565  ep 2; done; slee
+00025960: 7020 323b 2027 0a20 2020 2020 2020 2020  p 2; '.         
+00025970: 2020 2023 2054 6865 206c 6174 6573 7420     # The latest 
+00025980: 7665 7273 696f 6e20 7368 6f75 6c64 2068  version should h
+00025990: 6176 6520 6f6e 6520 5245 4144 5920 616e  ave one READY an
+000259a0: 6420 7468 6520 6f6e 6520 6f66 2074 6865  d the one of the
+000259b0: 206f 6c64 6572 2076 6572 7369 6f6e 7320   older versions 
+000259c0: 7368 6f75 6c64 2062 6520 7368 7574 7469  should be shutti
+000259d0: 6e67 2064 6f77 6e0a 2020 2020 2020 2020  ng down.        
+000259e0: 2020 2020 6627 7b73 696e 676c 655f 6e65      f'{single_ne
+000259f0: 775f 7265 706c 6963 617d 207b 5f63 6865  w_replica} {_che
+00025a00: 636b 5f73 6572 7669 6365 5f76 6572 7369  ck_service_versi
+00025a10: 6f6e 286e 616d 652c 2022 312c 3222 297d  on(name, "1,2")}
+00025a20: 2027 0a20 2020 2020 2020 2020 2020 2023   '.            #
+00025a30: 2043 6865 636b 2074 6865 206f 7574 7075   Check the outpu
+00025a40: 7420 6672 6f6d 2074 6865 206f 6c64 2076  t from the old v
+00025a50: 6572 7369 6f6e 2c20 696d 6d65 6469 6174  ersion, immediat
+00025a60: 656c 7920 6166 7465 7220 7468 650a 2020  ely after the.  
+00025a70: 2020 2020 2020 2020 2020 2320 6f75 7470            # outp
+00025a80: 7574 2066 726f 6d20 7468 6520 6e65 7720  ut from the new 
+00025a90: 7665 7273 696f 6e20 6170 7065 6172 732e  version appears.
+00025aa0: 2054 6869 7320 6973 2067 7561 7261 6e74   This is guarant
+00025ab0: 6565 6420 6279 2074 6865 0a20 2020 2020  eed by the.     
+00025ac0: 2020 2020 2020 2023 2072 6f75 6e64 2072         # round r
+00025ad0: 6f62 696e 206c 6f61 6420 6261 6c61 6e63  obin load balanc
+00025ae0: 696e 6720 706f 6c69 6379 2e0a 2020 2020  ing policy..    
+00025af0: 2020 2020 2020 2020 2320 544f 444f 287a          # TODO(z
+00025b00: 6877 7529 3a20 7765 2073 686f 756c 6420  hwu): we should 
+00025b10: 6861 7665 2061 206d 6f72 6520 6765 6e65  have a more gene
+00025b20: 7261 6c69 7a65 6420 7761 7920 666f 7220  ralized way for 
+00025b30: 6368 6563 6b69 6e67 2074 6865 0a20 2020  checking the.   
+00025b40: 2020 2020 2020 2020 2023 206d 6978 6564           # mixed
+00025b50: 2076 6572 7369 6f6e 206f 6620 7265 706c   version of repl
+00025b60: 6963 6173 2074 6f20 6176 6f69 6420 6465  icas to avoid de
+00025b70: 7065 6e64 696e 6720 6f6e 2074 6865 2073  pending on the s
+00025b80: 7065 6369 6669 630a 2020 2020 2020 2020  pecific.        
+00025b90: 2020 2020 2320 726f 756e 6420 726f 6269      # round robi
+00025ba0: 6e20 6c6f 6164 2062 616c 616e 6369 6e67  n load balancing
+00025bb0: 2070 6f6c 6963 792e 0a20 2020 2020 2020   policy..       
+00025bc0: 2020 2020 2027 6375 726c 202d 4c20 6874       'curl -L ht
+00025bd0: 7470 3a2f 2f24 656e 6470 6f69 6e74 207c  tp://$endpoint |
+00025be0: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
+00025bf0: 6c6f 7420 6865 7265 2227 2c0a 2020 2020  lot here"',.    
+00025c00: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
+00025c10: 5445 4152 444f 574e 5f53 4552 5649 4345  TEARDOWN_SERVICE
+00025c20: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00025c30: 6529 2c0a 2020 2020 2020 2020 7469 6d65  e),.        time
+00025c40: 6f75 743d 3230 202a 2036 302c 0a20 2020  out=20 * 60,.   
+00025c50: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00025c60: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+00025c70: 6573 742e 6d61 726b 2e73 6572 7665 0a40  est.mark.serve.@
+00025c80: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6b  pytest.mark.no_k
+00025c90: 7562 6572 6e65 7465 730a 6465 6620 7465  ubernetes.def te
+00025ca0: 7374 5f73 6b79 7365 7276 655f 6661 7374  st_skyserve_fast
+00025cb0: 5f75 7064 6174 6528 6765 6e65 7269 635f  _update(generic_
+00025cc0: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+00025cd0: 2022 2222 5465 7374 2073 6b79 7365 7276   """Test skyserv
+00025ce0: 6520 7769 7468 2066 6173 7420 7570 6461  e with fast upda
+00025cf0: 7465 2028 496e 6372 656d 656e 7420 7665  te (Increment ve
+00025d00: 7273 696f 6e20 6f66 206f 6c64 2072 6570  rsion of old rep
+00025d10: 6c69 6361 7329 2222 220a 2020 2020 6e61  licas)""".    na
+00025d20: 6d65 203d 205f 6765 745f 7365 7276 6963  me = _get_servic
+00025d30: 655f 6e61 6d65 2829 0a0a 2020 2020 7465  e_name()..    te
+00025d40: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00025d50: 2020 2066 2774 6573 742d 736b 7973 6572     f'test-skyser
+00025d60: 7665 2d66 6173 742d 7570 6461 7465 272c  ve-fast-update',
+00025d70: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00025d80: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
+00025d90: 7665 2075 7020 2d6e 207b 6e61 6d65 7d20  ve up -n {name} 
+00025da0: 2d79 202d 2d63 6c6f 7564 207b 6765 6e65  -y --cloud {gene
+00025db0: 7269 635f 636c 6f75 647d 2074 6573 7473  ric_cloud} tests
+00025dc0: 2f73 6b79 7365 7276 652f 7570 6461 7465  /skyserve/update
+00025dd0: 2f62 756d 705f 7665 7273 696f 6e5f 6265  /bump_version_be
+00025de0: 666f 7265 2e79 616d 6c27 2c0a 2020 2020  fore.yaml',.    
+00025df0: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
+00025e00: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
+00025e10: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00025e20: 2c20 7265 706c 6963 615f 6e75 6d3d 3229  , replica_num=2)
+00025e30: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00025e40: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
+00025e50: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
+00025e60: 653d 6e61 6d65 297d 3b20 6375 726c 202d  e=name)}; curl -
+00025e70: 4c20 6874 7470 3a2f 2f24 656e 6470 6f69  L http://$endpoi
+00025e80: 6e74 207c 2067 7265 7020 2248 692c 2053  nt | grep "Hi, S
+00025e90: 6b79 5069 6c6f 7420 6865 7265 2227 2c0a  kyPilot here"',.
+00025ea0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00025eb0: 7920 7365 7276 6520 7570 6461 7465 207b  y serve update {
+00025ec0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+00025ed0: 656e 6572 6963 5f63 6c6f 7564 7d20 2d2d  eneric_cloud} --
+00025ee0: 6d6f 6465 2062 6c75 655f 6772 6565 6e20  mode blue_green 
+00025ef0: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
+00025f00: 652f 7570 6461 7465 2f62 756d 705f 7665  e/update/bump_ve
+00025f10: 7273 696f 6e5f 6166 7465 722e 7961 6d6c  rsion_after.yaml
+00025f20: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+00025f30: 2073 6c65 6570 2074 6f20 7761 6974 2066   sleep to wait f
+00025f40: 6f72 2075 7064 6174 6520 746f 2062 6520  or update to be 
+00025f50: 7265 6769 7374 6572 6564 2e0a 2020 2020  registered..    
+00025f60: 2020 2020 2020 2020 2773 6c65 6570 2031          'sleep 1
+00025f70: 3230 272c 0a20 2020 2020 2020 2020 2020  20',.           
+00025f80: 2023 2032 206f 6e2d 6465 616d 6e64 2028   # 2 on-deamnd (
+00025f90: 7265 6164 7929 202b 2031 206f 6e2d 6465  ready) + 1 on-de
+00025fa0: 6d61 6e64 2028 7072 6f76 6973 696f 6e69  mand (provisioni
+00025fb0: 6e67 292e 0a20 2020 2020 2020 2020 2020  ng)..           
+00025fc0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00025fd0: 2020 205f 6368 6563 6b5f 7265 706c 6963     _check_replic
+00025fe0: 615f 696e 5f73 7461 7475 7328 0a20 2020  a_in_status(.   
+00025ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026000: 206e 616d 652c 205b 2832 2c20 4661 6c73   name, [(2, Fals
+00026010: 652c 2027 5245 4144 5927 292c 0a20 2020  e, 'READY'),.   
+00026020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026030: 2020 2020 2020 2020 2831 2c20 4661 6c73          (1, Fals
+00026040: 652c 205f 5345 5256 4943 455f 4c41 554e  e, _SERVICE_LAUN
+00026050: 4348 494e 475f 5354 4154 5553 5f52 4547  CHING_STATUS_REG
+00026060: 4558 295d 2920 2b0a 2020 2020 2020 2020  EX)]) +.        
+00026070: 2020 2020 2020 2020 2320 4661 7374 2075          # Fast u
+00026080: 7064 6174 6520 7769 6c6c 2064 6972 6563  pdate will direc
+00026090: 746c 7920 6861 7665 2074 6865 206c 6174  tly have the lat
+000260a0: 6573 7420 7665 7273 696f 6e20 7265 6164  est version read
+000260b0: 792e 0a20 2020 2020 2020 2020 2020 2020  y..             
+000260c0: 2020 205f 6368 6563 6b5f 7365 7276 6963     _check_servic
+000260d0: 655f 7665 7273 696f 6e28 6e61 6d65 2c20  e_version(name, 
+000260e0: 2232 2229 292c 0a20 2020 2020 2020 2020  "2")),.         
+000260f0: 2020 205f 5345 5256 455f 5741 4954 5f55     _SERVE_WAIT_U
+00026100: 4e54 494c 5f52 4541 4459 2e66 6f72 6d61  NTIL_READY.forma
+00026110: 7428 6e61 6d65 3d6e 616d 652c 2072 6570  t(name=name, rep
+00026120: 6c69 6361 5f6e 756d 3d33 2920 2b0a 2020  lica_num=3) +.  
+00026130: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
+00026140: 5f73 6572 7669 6365 5f76 6572 7369 6f6e  _service_version
+00026150: 286e 616d 652c 2022 3222 292c 0a20 2020  (name, "2"),.   
+00026160: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
+00026170: 5645 5f45 4e44 504f 494e 545f 5741 4954  VE_ENDPOINT_WAIT
+00026180: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00026190: 6529 7d3b 2063 7572 6c20 2d4c 2068 7474  e)}; curl -L htt
+000261a0: 703a 2f2f 2465 6e64 706f 696e 7420 7c20  p://$endpoint | 
+000261b0: 6772 6570 2022 4869 2c20 536b 7950 696c  grep "Hi, SkyPil
+000261c0: 6f74 2068 6572 6522 272c 0a20 2020 2020  ot here"',.     
+000261d0: 2020 2020 2020 2023 2054 6573 7420 726f         # Test ro
+000261e0: 6c6c 696e 6720 7570 6461 7465 0a20 2020  lling update.   
+000261f0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00026200: 6572 7665 2075 7064 6174 6520 7b6e 616d  erve update {nam
+00026210: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
+00026220: 7269 635f 636c 6f75 647d 202d 7920 7465  ric_cloud} -y te
+00026230: 7374 732f 736b 7973 6572 7665 2f75 7064  sts/skyserve/upd
+00026240: 6174 652f 6275 6d70 5f76 6572 7369 6f6e  ate/bump_version
+00026250: 5f62 6566 6f72 652e 7961 6d6c 272c 0a20  _before.yaml',. 
+00026260: 2020 2020 2020 2020 2020 2023 2073 6c65             # sle
+00026270: 6570 2074 6f20 7761 6974 2066 6f72 2075  ep to wait for u
+00026280: 7064 6174 6520 746f 2062 6520 7265 6769  pdate to be regi
+00026290: 7374 6572 6564 2e0a 2020 2020 2020 2020  stered..        
+000262a0: 2020 2020 2773 6c65 6570 2033 3027 2c0a      'sleep 30',.
+000262b0: 2020 2020 2020 2020 2020 2020 2320 3220              # 2 
+000262c0: 6f6e 2d64 6561 6d6e 6420 2872 6561 6479  on-deamnd (ready
+000262d0: 2920 2b20 3120 6f6e 2d64 656d 616e 6420  ) + 1 on-demand 
+000262e0: 2873 6875 7474 696e 6720 646f 776e 292e  (shutting down).
+000262f0: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
+00026300: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
+00026310: 7461 7475 7328 6e61 6d65 2c20 5b28 322c  tatus(name, [(2,
+00026320: 2046 616c 7365 2c20 2752 4541 4459 2729   False, 'READY')
+00026330: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00026340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026350: 2020 2020 2020 2020 2020 2020 2020 2831                (1
+00026360: 2c20 4661 6c73 652c 2027 5348 5554 5449  , False, 'SHUTTI
+00026370: 4e47 5f44 4f57 4e27 295d 292c 0a20 2020  NG_DOWN')]),.   
+00026380: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
+00026390: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
+000263a0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+000263b0: 652c 2072 6570 6c69 6361 5f6e 756d 3d32  e, replica_num=2
+000263c0: 2920 2b0a 2020 2020 2020 2020 2020 2020  ) +.            
+000263d0: 5f63 6865 636b 5f73 6572 7669 6365 5f76  _check_service_v
+000263e0: 6572 7369 6f6e 286e 616d 652c 2022 3322  ersion(name, "3"
+000263f0: 292c 0a20 2020 2020 2020 2020 2020 2066  ),.            f
+00026400: 277b 5f53 4552 5645 5f45 4e44 504f 494e  '{_SERVE_ENDPOIN
+00026410: 545f 5741 4954 2e66 6f72 6d61 7428 6e61  T_WAIT.format(na
+00026420: 6d65 3d6e 616d 6529 7d3b 2063 7572 6c20  me=name)}; curl 
+00026430: 2d4c 2068 7474 703a 2f2f 2465 6e64 706f  -L http://$endpo
+00026440: 696e 7420 7c20 6772 6570 2022 4869 2c20  int | grep "Hi, 
+00026450: 536b 7950 696c 6f74 2068 6572 6522 272c  SkyPilot here"',
+00026460: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00026470: 2020 2020 5f54 4541 5244 4f57 4e5f 5345      _TEARDOWN_SE
+00026480: 5256 4943 452e 666f 726d 6174 286e 616d  RVICE.format(nam
+00026490: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
+000264a0: 2074 696d 656f 7574 3d33 3020 2a20 3630   timeout=30 * 60
+000264b0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+000264c0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+000264d0: 0a40 7079 7465 7374 2e6d 6172 6b2e 7365  .@pytest.mark.se
+000264e0: 7276 650a 4070 7974 6573 742e 6d61 726b  rve.@pytest.mark
+000264f0: 2e6e 6f5f 6b75 6265 726e 6574 6573 0a64  .no_kubernetes.d
+00026500: 6566 2074 6573 745f 736b 7973 6572 7665  ef test_skyserve
+00026510: 5f75 7064 6174 655f 6175 746f 7363 616c  _update_autoscal
+00026520: 6528 6765 6e65 7269 635f 636c 6f75 643a  e(generic_cloud:
+00026530: 2073 7472 293a 0a20 2020 2022 2222 5465   str):.    """Te
+00026540: 7374 2073 6b79 7365 7276 6520 7570 6461  st skyserve upda
+00026550: 7465 2077 6974 6820 6175 746f 7363 616c  te with autoscal
+00026560: 6522 2222 0a20 2020 206e 616d 6520 3d20  e""".    name = 
+00026570: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
+00026580: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+00026590: 6573 7428 0a20 2020 2020 2020 2066 2774  est(.        f't
+000265a0: 6573 742d 736b 7973 6572 7665 2d75 7064  est-skyserve-upd
+000265b0: 6174 652d 6175 746f 7363 616c 6527 2c0a  ate-autoscale',.
+000265c0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+000265d0: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
+000265e0: 6520 7570 202d 6e20 7b6e 616d 657d 202d  e up -n {name} -
+000265f0: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+00026600: 636c 6f75 647d 202d 7920 7465 7374 732f  cloud} -y tests/
+00026610: 736b 7973 6572 7665 2f75 7064 6174 652f  skyserve/update/
+00026620: 6e75 6d5f 6d69 6e5f 7477 6f2e 7961 6d6c  num_min_two.yaml
+00026630: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
+00026640: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
+00026650: 5f52 4541 4459 2e66 6f72 6d61 7428 6e61  _READY.format(na
+00026660: 6d65 3d6e 616d 652c 2072 6570 6c69 6361  me=name, replica
+00026670: 5f6e 756d 3d32 2920 2b0a 2020 2020 2020  _num=2) +.      
+00026680: 2020 2020 2020 5f63 6865 636b 5f73 6572        _check_ser
+00026690: 7669 6365 5f76 6572 7369 6f6e 286e 616d  vice_version(nam
+000266a0: 652c 2022 3122 292c 0a20 2020 2020 2020  e, "1"),.       
+000266b0: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
+000266c0: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
+000266d0: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
+000266e0: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
+000266f0: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
+00026700: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
+00026710: 2248 692c 2053 6b79 5069 6c6f 7420 6865  "Hi, SkyPilot he
+00026720: 7265 2227 2c0a 2020 2020 2020 2020 2020  re"',.          
+00026730: 2020 6627 736b 7920 7365 7276 6520 7570    f'sky serve up
+00026740: 6461 7465 207b 6e61 6d65 7d20 2d2d 636c  date {name} --cl
+00026750: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+00026760: 7564 7d20 2d2d 6d6f 6465 2062 6c75 655f  ud} --mode blue_
+00026770: 6772 6565 6e20 2d79 2074 6573 7473 2f73  green -y tests/s
+00026780: 6b79 7365 7276 652f 7570 6461 7465 2f6e  kyserve/update/n
+00026790: 756d 5f6d 696e 5f6f 6e65 2e79 616d 6c27  um_min_one.yaml'
+000267a0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+000267b0: 736c 6565 7020 6265 666f 7265 2075 7064  sleep before upd
+000267c0: 6174 6520 6973 2072 6567 6973 7465 7265  ate is registere
+000267d0: 642e 0a20 2020 2020 2020 2020 2020 2027  d..            '
+000267e0: 736c 6565 7020 3230 272c 0a20 2020 2020  sleep 20',.     
+000267f0: 2020 2020 2020 2023 2054 696d 656f 7574         # Timeout
+00026800: 2077 696c 6c20 6265 2074 7269 6767 6572   will be trigger
+00026810: 6564 2077 6865 6e20 7570 6461 7465 2066  ed when update f
+00026820: 6169 6c73 2e0a 2020 2020 2020 2020 2020  ails..          
+00026830: 2020 5f53 4552 5645 5f57 4149 545f 554e    _SERVE_WAIT_UN
+00026840: 5449 4c5f 5245 4144 592e 666f 726d 6174  TIL_READY.format
+00026850: 286e 616d 653d 6e61 6d65 2c20 7265 706c  (name=name, repl
+00026860: 6963 615f 6e75 6d3d 3129 202b 0a20 2020  ica_num=1) +.   
+00026870: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
+00026880: 7365 7276 6963 655f 7665 7273 696f 6e28  service_version(
+00026890: 6e61 6d65 2c20 2232 2229 2c0a 2020 2020  name, "2"),.    
+000268a0: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
+000268b0: 455f 454e 4450 4f49 4e54 5f57 4149 542e  E_ENDPOINT_WAIT.
+000268c0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+000268d0: 297d 3b20 270a 2020 2020 2020 2020 2020  )}; '.          
+000268e0: 2020 2763 7572 6c20 2d4c 2068 7474 703a    'curl -L http:
+000268f0: 2f2f 2465 6e64 706f 696e 7420 7c20 6772  //$endpoint | gr
+00026900: 6570 2022 4869 2c20 536b 7950 696c 6f74  ep "Hi, SkyPilot
+00026910: 2068 6572 6521 2227 2c0a 2020 2020 2020   here!"',.      
+00026920: 2020 2020 2020 2320 526f 6c6c 696e 6720        # Rolling 
+00026930: 5570 6461 7465 0a20 2020 2020 2020 2020  Update.         
+00026940: 2020 2066 2773 6b79 2073 6572 7665 2075     f'sky serve u
+00026950: 7064 6174 6520 7b6e 616d 657d 202d 2d63  pdate {name} --c
+00026960: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+00026970: 6f75 647d 202d 7920 7465 7374 732f 736b  oud} -y tests/sk
+00026980: 7973 6572 7665 2f75 7064 6174 652f 6e75  yserve/update/nu
+00026990: 6d5f 6d69 6e5f 7477 6f2e 7961 6d6c 272c  m_min_two.yaml',
+000269a0: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
+000269b0: 6c65 6570 2062 6566 6f72 6520 7570 6461  leep before upda
+000269c0: 7465 2069 7320 7265 6769 7374 6572 6564  te is registered
+000269d0: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
+000269e0: 6c65 6570 2032 3027 2c0a 2020 2020 2020  leep 20',.      
+000269f0: 2020 2020 2020 2320 5469 6d65 6f75 7420        # Timeout 
+00026a00: 7769 6c6c 2062 6520 7472 6967 6765 7265  will be triggere
+00026a10: 6420 7768 656e 2075 7064 6174 6520 6661  d when update fa
+00026a20: 696c 732e 0a20 2020 2020 2020 2020 2020  ils..           
+00026a30: 205f 5345 5256 455f 5741 4954 5f55 4e54   _SERVE_WAIT_UNT
+00026a40: 494c 5f52 4541 4459 2e66 6f72 6d61 7428  IL_READY.format(
+00026a50: 6e61 6d65 3d6e 616d 652c 2072 6570 6c69  name=name, repli
+00026a60: 6361 5f6e 756d 3d32 2920 2b0a 2020 2020  ca_num=2) +.    
+00026a70: 2020 2020 2020 2020 5f63 6865 636b 5f73          _check_s
+00026a80: 6572 7669 6365 5f76 6572 7369 6f6e 286e  ervice_version(n
+00026a90: 616d 652c 2022 3322 292c 0a20 2020 2020  ame, "3"),.     
+00026aa0: 2020 2020 2020 2066 277b 5f53 4552 5645         f'{_SERVE
+00026ab0: 5f45 4e44 504f 494e 545f 5741 4954 2e66  _ENDPOINT_WAIT.f
+00026ac0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+00026ad0: 7d3b 2027 0a20 2020 2020 2020 2020 2020  }; '.           
+00026ae0: 2027 6375 726c 202d 4c20 6874 7470 3a2f   'curl -L http:/
+00026af0: 2f24 656e 6470 6f69 6e74 207c 2067 7265  /$endpoint | gre
+00026b00: 7020 2248 692c 2053 6b79 5069 6c6f 7420  p "Hi, SkyPilot 
+00026b10: 6865 7265 2122 272c 0a20 2020 2020 2020  here!"',.       
+00026b20: 205d 2c0a 2020 2020 2020 2020 5f54 4541   ],.        _TEA
+00026b30: 5244 4f57 4e5f 5345 5256 4943 452e 666f  RDOWN_SERVICE.fo
+00026b40: 726d 6174 286e 616d 653d 6e61 6d65 292c  rmat(name=name),
+00026b50: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+00026b60: 3d33 3020 2a20 3630 2c0a 2020 2020 290a  =30 * 60,.    ).
+00026b70: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00026b80: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00026b90: 2e6d 6172 6b2e 7365 7276 650a 4070 7974  .mark.serve.@pyt
+00026ba0: 6573 742e 6d61 726b 2e70 6172 616d 6574  est.mark.paramet
+00026bb0: 7269 7a65 2827 6d6f 6465 272c 205b 2772  rize('mode', ['r
+00026bc0: 6f6c 6c69 6e67 272c 2027 626c 7565 5f67  olling', 'blue_g
+00026bd0: 7265 656e 275d 290a 4070 7974 6573 742e  reen']).@pytest.
+00026be0: 6d61 726b 2e6e 6f5f 6b75 6265 726e 6574  mark.no_kubernet
+00026bf0: 6573 0a64 6566 2074 6573 745f 736b 7973  es.def test_skys
+00026c00: 6572 7665 5f6e 6577 5f61 7574 6f73 6361  erve_new_autosca
+00026c10: 6c65 725f 7570 6461 7465 286d 6f64 653a  ler_update(mode:
+00026c20: 2073 7472 2c20 6765 6e65 7269 635f 636c   str, generic_cl
+00026c30: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
+00026c40: 2222 5465 7374 2073 6b79 7365 7276 6520  ""Test skyserve 
+00026c50: 7769 7468 2075 7064 6174 6520 7468 6174  with update that
+00026c60: 2063 6861 6e67 6573 2061 7574 6f73 6361   changes autosca
+00026c70: 6c65 7222 2222 0a20 2020 206e 616d 6520  ler""".    name 
+00026c80: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
+00026c90: 616d 6528 2920 2b20 6d6f 6465 0a0a 2020  ame() + mode..  
+00026ca0: 2020 666f 7572 5f73 706f 745f 7570 5f63    four_spot_up_c
+00026cb0: 6d64 203d 205f 6368 6563 6b5f 7265 706c  md = _check_repl
+00026cc0: 6963 615f 696e 5f73 7461 7475 7328 6e61  ica_in_status(na
+00026cd0: 6d65 2c20 5b28 342c 2054 7275 652c 2027  me, [(4, True, '
+00026ce0: 5245 4144 5927 295d 290a 2020 2020 7570  READY')]).    up
+00026cf0: 6461 7465 5f63 6865 636b 203d 205b 6627  date_check = [f'
+00026d00: 756e 7469 6c20 287b 666f 7572 5f73 706f  until ({four_spo
+00026d10: 745f 7570 5f63 6d64 7d29 3b20 646f 2073  t_up_cmd}); do s
+00026d20: 6c65 6570 2035 3b20 646f 6e65 3b20 736c  leep 5; done; sl
+00026d30: 6565 7020 3130 3b27 5d0a 2020 2020 6966  eep 10;'].    if
+00026d40: 206d 6f64 6520 3d3d 2027 726f 6c6c 696e   mode == 'rollin
+00026d50: 6727 3a0a 2020 2020 2020 2020 2320 4368  g':.        # Ch
+00026d60: 6563 6b20 726f 6c6c 696e 6720 7570 6461  eck rolling upda
+00026d70: 7465 2c20 6974 2077 696c 6c20 7465 726d  te, it will term
+00026d80: 696e 6174 6520 6f6e 6520 6f66 2074 6865  inate one of the
+00026d90: 206f 6c64 206f 6e2d 6465 6d61 6e64 0a20   old on-demand. 
+00026da0: 2020 2020 2020 2023 2069 6e73 7461 6e63         # instanc
+00026db0: 6573 2c20 6f6e 6365 2074 6865 7265 2061  es, once there a
+00026dc0: 7265 2034 2073 706f 7420 696e 7374 616e  re 4 spot instan
+00026dd0: 6365 2072 6561 6479 2e0a 2020 2020 2020  ce ready..      
+00026de0: 2020 7570 6461 7465 5f63 6865 636b 202b    update_check +
+00026df0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+00026e00: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
+00026e10: 6e5f 7374 6174 7573 280a 2020 2020 2020  n_status(.      
+00026e20: 2020 2020 2020 2020 2020 6e61 6d65 2c20            name, 
+00026e30: 5b28 312c 2046 616c 7365 2c20 5f53 4552  [(1, False, _SER
+00026e40: 5649 4345 5f4c 4155 4e43 4849 4e47 5f53  VICE_LAUNCHING_S
+00026e50: 5441 5455 535f 5245 4745 5829 2c0a 2020  TATUS_REGEX),.  
+00026e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026e70: 2020 2020 2028 312c 2046 616c 7365 2c20       (1, False, 
+00026e80: 2753 4855 5454 494e 475f 444f 574e 2729  'SHUTTING_DOWN')
+00026e90: 2c20 2831 2c20 4661 6c73 652c 2027 5245  , (1, False, 'RE
+00026ea0: 4144 5927 295d 2920 2b0a 2020 2020 2020  ADY')]) +.      
+00026eb0: 2020 2020 2020 5f63 6865 636b 5f73 6572        _check_ser
+00026ec0: 7669 6365 5f76 6572 7369 6f6e 286e 616d  vice_version(nam
+00026ed0: 652c 2022 312c 3222 292c 0a20 2020 2020  e, "1,2"),.     
+00026ee0: 2020 205d 0a20 2020 2065 6c73 653a 0a20     ].    else:. 
+00026ef0: 2020 2020 2020 2023 2043 6865 636b 2062         # Check b
+00026f00: 6c75 6520 6772 6565 6e20 7570 6461 7465  lue green update
+00026f10: 2c20 6974 2077 696c 6c20 6b65 6570 2062  , it will keep b
+00026f20: 6f74 6820 6f6c 6420 6f6e 2d64 656d 616e  oth old on-deman
+00026f30: 6420 696e 7374 616e 6365 730a 2020 2020  d instances.    
+00026f40: 2020 2020 2320 7275 6e6e 696e 672c 206f      # running, o
+00026f50: 6e63 6520 7468 6572 6520 6172 6520 3420  nce there are 4 
+00026f60: 7370 6f74 2069 6e73 7461 6e63 6520 7265  spot instance re
+00026f70: 6164 792e 0a20 2020 2020 2020 2075 7064  ady..        upd
+00026f80: 6174 655f 6368 6563 6b20 2b3d 205b 0a20  ate_check += [. 
+00026f90: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
+00026fa0: 6b5f 7265 706c 6963 615f 696e 5f73 7461  k_replica_in_sta
+00026fb0: 7475 7328 0a20 2020 2020 2020 2020 2020  tus(.           
+00026fc0: 2020 2020 206e 616d 652c 205b 2831 2c20       name, [(1, 
+00026fd0: 4661 6c73 652c 205f 5345 5256 4943 455f  False, _SERVICE_
+00026fe0: 4c41 554e 4348 494e 475f 5354 4154 5553  LAUNCHING_STATUS
+00026ff0: 5f52 4547 4558 292c 0a20 2020 2020 2020  _REGEX),.       
+00027000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027010: 2832 2c20 4661 6c73 652c 2027 5245 4144  (2, False, 'READ
+00027020: 5927 295d 2920 2b0a 2020 2020 2020 2020  Y')]) +.        
+00027030: 2020 2020 5f63 6865 636b 5f73 6572 7669      _check_servi
+00027040: 6365 5f76 6572 7369 6f6e 286e 616d 652c  ce_version(name,
+00027050: 2022 3122 292c 0a20 2020 2020 2020 205d   "1"),.        ]
+00027060: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00027070: 280a 2020 2020 2020 2020 2774 6573 742d  (.        'test-
+00027080: 736b 7973 6572 7665 2d6e 6577 2d61 7574  skyserve-new-aut
+00027090: 6f73 6361 6c65 722d 7570 6461 7465 272c  oscaler-update',
+000270a0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+000270b0: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
+000270c0: 7665 2075 7020 2d6e 207b 6e61 6d65 7d20  ve up -n {name} 
+000270d0: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+000270e0: 5f63 6c6f 7564 7d20 2d79 2074 6573 7473  _cloud} -y tests
+000270f0: 2f73 6b79 7365 7276 652f 7570 6461 7465  /skyserve/update
+00027100: 2f6e 6577 5f61 7574 6f73 6361 6c65 725f  /new_autoscaler_
+00027110: 6265 666f 7265 2e79 616d 6c27 2c0a 2020  before.yaml',.  
+00027120: 2020 2020 2020 2020 2020 5f53 4552 5645            _SERVE
+00027130: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
+00027140: 592e 666f 726d 6174 286e 616d 653d 6e61  Y.format(name=na
+00027150: 6d65 2c20 7265 706c 6963 615f 6e75 6d3d  me, replica_num=
+00027160: 3229 202b 0a20 2020 2020 2020 2020 2020  2) +.           
+00027170: 205f 6368 6563 6b5f 7365 7276 6963 655f   _check_service_
+00027180: 7665 7273 696f 6e28 6e61 6d65 2c20 2231  version(name, "1
+00027190: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+000271a0: 6627 7b5f 5345 5256 455f 454e 4450 4f49  f'{_SERVE_ENDPOI
+000271b0: 4e54 5f57 4149 542e 666f 726d 6174 286e  NT_WAIT.format(n
+000271c0: 616d 653d 6e61 6d65 297d 3b20 270a 2020  ame=name)}; '.  
+000271d0: 2020 2020 2020 2020 2020 2773 3d24 2863            's=$(c
+000271e0: 7572 6c20 2d4c 2068 7474 703a 2f2f 2465  url -L http://$e
+000271f0: 6e64 706f 696e 7429 3b20 6563 686f 2022  ndpoint); echo "
+00027200: 2473 223b 2065 6368 6f20 2224 7322 207c  $s"; echo "$s" |
+00027210: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
+00027220: 6c6f 7420 6865 7265 2227 2c0a 2020 2020  lot here"',.    
+00027230: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
+00027240: 7276 6520 7570 6461 7465 207b 6e61 6d65  rve update {name
+00027250: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+00027260: 6963 5f63 6c6f 7564 7d20 2d2d 6d6f 6465  ic_cloud} --mode
+00027270: 207b 6d6f 6465 7d20 2d79 2074 6573 7473   {mode} -y tests
+00027280: 2f73 6b79 7365 7276 652f 7570 6461 7465  /skyserve/update
+00027290: 2f6e 6577 5f61 7574 6f73 6361 6c65 725f  /new_autoscaler_
+000272a0: 6166 7465 722e 7961 6d6c 272c 0a20 2020  after.yaml',.   
+000272b0: 2020 2020 2020 2020 2023 2057 6169 7420           # Wait 
+000272c0: 666f 7220 7570 6461 7465 2074 6f20 6265  for update to be
+000272d0: 2072 6567 6973 7465 7265 640a 2020 2020   registered.    
+000272e0: 2020 2020 2020 2020 6627 736c 6565 7020          f'sleep 
+000272f0: 3132 3027 2c0a 2020 2020 2020 2020 2020  120',.          
+00027300: 2020 5f63 6865 636b 5f72 6570 6c69 6361    _check_replica
+00027310: 5f69 6e5f 7374 6174 7573 280a 2020 2020  _in_status(.    
+00027320: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00027330: 2c20 5b28 342c 2054 7275 652c 205f 5345  , [(4, True, _SE
+00027340: 5256 4943 455f 4c41 554e 4348 494e 475f  RVICE_LAUNCHING_
+00027350: 5354 4154 5553 5f52 4547 4558 202b 2027  STATUS_REGEX + '
+00027360: 5c7c 5245 4144 5927 292c 0a20 2020 2020  \|READY'),.     
+00027370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027380: 2020 2831 2c20 4661 6c73 652c 205f 5345    (1, False, _SE
+00027390: 5256 4943 455f 4c41 554e 4348 494e 475f  RVICE_LAUNCHING_
+000273a0: 5354 4154 5553 5f52 4547 4558 292c 0a20  STATUS_REGEX),. 
+000273b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000273c0: 2020 2020 2020 2832 2c20 4661 6c73 652c        (2, False,
+000273d0: 2027 5245 4144 5927 295d 292c 0a20 2020   'READY')]),.   
+000273e0: 2020 2020 2020 2020 202a 7570 6461 7465           *update
+000273f0: 5f63 6865 636b 2c0a 2020 2020 2020 2020  _check,.        
+00027400: 2020 2020 5f53 4552 5645 5f57 4149 545f      _SERVE_WAIT_
+00027410: 554e 5449 4c5f 5245 4144 592e 666f 726d  UNTIL_READY.form
+00027420: 6174 286e 616d 653d 6e61 6d65 2c20 7265  at(name=name, re
+00027430: 706c 6963 615f 6e75 6d3d 3529 2c0a 2020  plica_num=5),.  
+00027440: 2020 2020 2020 2020 2020 6627 7b5f 5345            f'{_SE
+00027450: 5256 455f 454e 4450 4f49 4e54 5f57 4149  RVE_ENDPOINT_WAI
+00027460: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
+00027470: 6d65 297d 3b20 270a 2020 2020 2020 2020  me)}; '.        
+00027480: 2020 2020 2763 7572 6c20 2d4c 2068 7474      'curl -L htt
+00027490: 703a 2f2f 2465 6e64 706f 696e 7420 7c20  p://$endpoint | 
+000274a0: 6772 6570 2022 4869 2c20 536b 7950 696c  grep "Hi, SkyPil
+000274b0: 6f74 2068 6572 6522 272c 0a20 2020 2020  ot here"',.     
+000274c0: 2020 2020 2020 205f 6368 6563 6b5f 7265         _check_re
+000274d0: 706c 6963 615f 696e 5f73 7461 7475 7328  plica_in_status(
+000274e0: 6e61 6d65 2c20 5b28 342c 2054 7275 652c  name, [(4, True,
+000274f0: 2027 5245 4144 5927 292c 0a20 2020 2020   'READY'),.     
+00027500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027520: 2020 2020 2020 2028 312c 2046 616c 7365         (1, False
+00027530: 2c20 2752 4541 4459 2729 5d29 2c0a 2020  , 'READY')]),.  
+00027540: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00027550: 205f 5445 4152 444f 574e 5f53 4552 5649   _TEARDOWN_SERVI
+00027560: 4345 2e66 6f72 6d61 7428 6e61 6d65 3d6e  CE.format(name=n
+00027570: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
+00027580: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
+00027590: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+000275a0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+000275b0: 7974 6573 742e 6d61 726b 2e73 6572 7665  ytest.mark.serve
+000275c0: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
+000275d0: 7665 5f66 6169 6c75 7265 7328 6765 6e65  ve_failures(gene
+000275e0: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
+000275f0: 0a20 2020 2022 2222 5465 7374 2072 6570  .    """Test rep
+00027600: 6c69 6361 2066 6169 6c75 7265 2073 7461  lica failure sta
+00027610: 7475 7365 7322 2222 0a20 2020 206e 616d  tuses""".    nam
+00027620: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
+00027630: 5f6e 616d 6528 290a 0a20 2020 2074 6573  _name()..    tes
+00027640: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00027650: 2020 2774 6573 742d 736b 7973 6572 7665    'test-skyserve
+00027660: 2d66 6169 6c75 7265 7327 2c0a 2020 2020  -failures',.    
+00027670: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00027680: 2020 6627 736b 7920 7365 7276 6520 7570    f'sky serve up
+00027690: 202d 6e20 7b6e 616d 657d 202d 2d63 6c6f   -n {name} --clo
+000276a0: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
+000276b0: 647d 202d 7920 7465 7374 732f 736b 7973  d} -y tests/skys
+000276c0: 6572 7665 2f66 6169 6c75 7265 732f 696e  erve/failures/in
+000276d0: 6974 6961 6c5f 6465 6c61 792e 7961 6d6c  itial_delay.yaml
+000276e0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000276f0: 2773 3d24 2873 6b79 2073 6572 7665 2073  's=$(sky serve s
+00027700: 7461 7475 7320 7b6e 616d 657d 293b 2027  tatus {name}); '
+00027710: 0a20 2020 2020 2020 2020 2020 2066 2775  .            f'u
+00027720: 6e74 696c 2065 6368 6f20 2224 7322 207c  ntil echo "$s" |
+00027730: 2067 7265 7020 2246 4149 4c45 445f 494e   grep "FAILED_IN
+00027740: 4954 4941 4c5f 4445 4c41 5922 3b20 646f  ITIAL_DELAY"; do
+00027750: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
+00027760: 6563 686f 2022 5761 6974 696e 6720 666f  echo "Waiting fo
+00027770: 7220 7265 706c 6963 6120 746f 2062 6520  r replica to be 
+00027780: 6661 696c 6564 2e2e 2e22 3b20 736c 6565  failed..."; slee
+00027790: 7020 353b 2027 0a20 2020 2020 2020 2020  p 5; '.         
+000277a0: 2020 2066 2773 3d24 2873 6b79 2073 6572     f's=$(sky ser
+000277b0: 7665 2073 7461 7475 7320 7b6e 616d 657d  ve status {name}
+000277c0: 293b 2065 6368 6f20 2224 7322 3b20 646f  ); echo "$s"; do
+000277d0: 6e65 3b27 2c0a 2020 2020 2020 2020 2020  ne;',.          
+000277e0: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
+000277f0: 2020 2020 2020 2020 2020 6627 7b5f 5345            f'{_SE
+00027800: 5256 455f 5354 4154 5553 5f57 4149 542e  RVE_STATUS_WAIT.
+00027810: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00027820: 297d 3b20 6563 686f 2022 2473 2220 7c20  )}; echo "$s" | 
+00027830: 6772 6570 2022 7b6e 616d 657d 2220 7c20  grep "{name}" | 
+00027840: 6772 6570 2022 4641 494c 4544 5f49 4e49  grep "FAILED_INI
+00027850: 5449 414c 5f44 454c 4159 2220 7c20 7763  TIAL_DELAY" | wc
+00027860: 202d 6c20 7c20 6772 6570 2032 3b20 270a   -l | grep 2; '.
+00027870: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
+00027880: 6b65 2073 7572 6520 6e6f 206e 6577 2072  ke sure no new r
+00027890: 6570 6c69 6361 7320 6172 6520 7374 6172  eplicas are star
+000278a0: 7465 6420 666f 7220 6561 726c 7920 6661  ted for early fa
+000278b0: 696c 7572 652e 0a20 2020 2020 2020 2020  ilure..         
+000278c0: 2020 2066 2765 6368 6f20 2224 7322 207c     f'echo "$s" |
+000278d0: 2067 7265 7020 2d41 2031 3030 2022 5365   grep -A 100 "Se
+000278e0: 7276 6963 6520 5265 706c 6963 6173 2220  rvice Replicas" 
+000278f0: 7c20 6772 6570 2022 7b6e 616d 657d 2220  | grep "{name}" 
+00027900: 7c20 7763 202d 6c20 7c20 6772 6570 2032  | wc -l | grep 2
+00027910: 3b27 2c0a 2020 2020 2020 2020 2020 2020  ;',.            
+00027920: 6627 736b 7920 7365 7276 6520 7570 6461  f'sky serve upda
+00027930: 7465 207b 6e61 6d65 7d20 2d2d 636c 6f75  te {name} --clou
+00027940: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+00027950: 7d20 2d79 2074 6573 7473 2f73 6b79 7365  } -y tests/skyse
+00027960: 7276 652f 6661 696c 7572 6573 2f70 726f  rve/failures/pro
+00027970: 6269 6e67 2e79 616d 6c27 2c0a 2020 2020  bing.yaml',.    
+00027980: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
+00027990: 7920 7365 7276 6520 7374 6174 7573 207b  y serve status {
+000279a0: 6e61 6d65 7d29 3b20 270a 2020 2020 2020  name}); '.      
+000279b0: 2020 2020 2020 2320 5761 6974 2066 6f72        # Wait for
+000279c0: 2072 6570 6c69 6361 2074 6f20 6265 2072   replica to be r
+000279d0: 6561 6479 2e0a 2020 2020 2020 2020 2020  eady..          
+000279e0: 2020 6627 756e 7469 6c20 6563 686f 2022    f'until echo "
+000279f0: 2473 2220 7c20 6772 6570 2022 5245 4144  $s" | grep "READ
+00027a00: 5922 3b20 646f 2027 0a20 2020 2020 2020  Y"; do '.       
+00027a10: 2020 2020 2027 6563 686f 2022 5761 6974       'echo "Wait
+00027a20: 696e 6720 666f 7220 7265 706c 6963 6120  ing for replica 
+00027a30: 746f 2062 6520 6661 696c 6564 2e2e 2e22  to be failed..."
+00027a40: 3b20 736c 6565 7020 353b 2027 0a20 2020  ; sleep 5; '.   
+00027a50: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
+00027a60: 6b79 2073 6572 7665 2073 7461 7475 7320  ky serve status 
+00027a70: 7b6e 616d 657d 293b 2065 6368 6f20 2224  {name}); echo "$
+00027a80: 7322 3b20 646f 6e65 3b27 2c0a 2020 2020  s"; done;',.    
+00027a90: 2020 2020 2020 2020 2320 5761 6974 2066          # Wait f
+00027aa0: 6f72 2072 6570 6c69 6361 2074 6f20 6368  or replica to ch
+00027ab0: 616e 6765 2074 6f20 4641 494c 4544 5f50  ange to FAILED_P
+00027ac0: 524f 4249 4e47 0a20 2020 2020 2020 2020  ROBING.         
+00027ad0: 2020 2066 2773 3d24 2873 6b79 2073 6572     f's=$(sky ser
+00027ae0: 7665 2073 7461 7475 7320 7b6e 616d 657d  ve status {name}
+00027af0: 293b 2027 0a20 2020 2020 2020 2020 2020  ); '.           
+00027b00: 2066 2775 6e74 696c 2065 6368 6f20 2224   f'until echo "$
+00027b10: 7322 207c 2067 7265 7020 2246 4149 4c45  s" | grep "FAILE
+00027b20: 445f 5052 4f42 494e 4722 3b20 646f 2027  D_PROBING"; do '
+00027b30: 0a20 2020 2020 2020 2020 2020 2027 6563  .            'ec
+00027b40: 686f 2022 5761 6974 696e 6720 666f 7220  ho "Waiting for 
+00027b50: 7265 706c 6963 6120 746f 2062 6520 6661  replica to be fa
+00027b60: 696c 6564 2e2e 2e22 3b20 736c 6565 7020  iled..."; sleep 
+00027b70: 353b 2027 0a20 2020 2020 2020 2020 2020  5; '.           
+00027b80: 2066 2773 3d24 2873 6b79 2073 6572 7665   f's=$(sky serve
+00027b90: 2073 7461 7475 7320 7b6e 616d 657d 293b   status {name});
+00027ba0: 2065 6368 6f20 2224 7322 3b20 646f 6e65   echo "$s"; done
+00027bb0: 3b27 202b 0a20 2020 2020 2020 2020 2020  ;' +.           
+00027bc0: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
+00027bd0: 696e 5f73 7461 7475 7328 0a20 2020 2020  in_status(.     
+00027be0: 2020 2020 2020 2020 2020 206e 616d 652c             name,
+00027bf0: 205b 2831 2c20 4661 6c73 652c 2027 4641   [(1, False, 'FA
+00027c00: 494c 4544 5f50 524f 4249 4e47 2729 2c0a  ILED_PROBING'),.
+00027c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027c20: 2020 2020 2020 2028 312c 2046 616c 7365         (1, False
+00027c30: 2c20 5f53 4552 5649 4345 5f4c 4155 4e43  , _SERVICE_LAUNC
+00027c40: 4849 4e47 5f53 5441 5455 535f 5245 4745  HING_STATUS_REGE
+00027c50: 5829 5d29 2c0a 2020 2020 2020 2020 2020  X)]),.          
+00027c60: 2020 2320 544f 444f 287a 6877 7529 3a20    # TODO(zhwu): 
+00027c70: 6164 6420 7465 7374 2066 6f72 2046 4149  add test for FAI
+00027c80: 4c45 445f 5052 4f56 4953 494f 4e0a 2020  LED_PROVISION.  
+00027c90: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00027ca0: 205f 5445 4152 444f 574e 5f53 4552 5649   _TEARDOWN_SERVI
+00027cb0: 4345 2e66 6f72 6d61 7428 6e61 6d65 3d6e  CE.format(name=n
+00027cc0: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
+00027cd0: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
+00027ce0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00027cf0: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+00027d00: 544f 444f 285a 696d 696e 672c 2054 6961  TODO(Ziming, Tia
+00027d10: 6e29 3a20 4164 6420 7465 7374 7320 666f  n): Add tests fo
+00027d20: 7220 6175 746f 7363 616c 696e 672e 0a0a  r autoscaling...
+00027d30: 0a23 202d 2d2d 2d2d 2d2d 2054 6573 7469  .# ------- Testi
+00027d40: 6e67 2075 7365 7220 7261 7920 636c 7573  ng user ray clus
+00027d50: 7465 7220 2d2d 2d2d 2d2d 2d2d 0a64 6566  ter --------.def
+00027d60: 2074 6573 745f 7573 6572 5f72 6179 5f63   test_user_ray_c
+00027d70: 6c75 7374 6572 2867 656e 6572 6963 5f63  luster(generic_c
+00027d80: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+00027d90: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00027da0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+00027db0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00027dc0: 2020 2020 2775 7365 722d 7261 792d 636c      'user-ray-cl
+00027dd0: 7573 7465 7227 2c0a 2020 2020 2020 2020  uster',.        
+00027de0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00027df0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00027e00: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00027e10: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+00027e20: 2272 6179 2073 7461 7274 202d 2d68 6561  "ray start --hea
+00027e30: 6422 272c 0a20 2020 2020 2020 2020 2020  d"',.           
+00027e40: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+00027e50: 657d 2022 6563 686f 2068 6922 272c 0a20  e} "echo hi"',. 
+00027e60: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00027e70: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+00027e80: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+00027e90: 2020 2020 2020 6627 736b 7920 7374 6174        f'sky stat
+00027ea0: 7573 202d 7220 7b6e 616d 657d 207c 2067  us -r {name} | g
+00027eb0: 7265 7020 5550 272c 0a20 2020 2020 2020  rep UP',.       
+00027ec0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00027ed0: 7b6e 616d 657d 2022 6563 686f 2062 7965  {name} "echo bye
+00027ee0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00027ef0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00027f00: 7d20 3220 2d2d 7374 6174 7573 272c 0a20  } 2 --status',. 
+00027f10: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00027f20: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00027f30: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00027f40: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00027f50: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+00027f60: 2d20 5465 7374 696e 6720 7468 6520 636f  - Testing the co
+00027f70: 7265 2041 5049 202d 2d2d 2d2d 2d2d 2d0a  re API --------.
+00027f80: 2320 4d6f 7374 206f 6620 7468 6520 636f  # Most of the co
+00027f90: 7265 2041 5049 7320 6861 7665 2062 6565  re APIs have bee
+00027fa0: 6e20 7465 7374 6564 2069 6e20 7468 6520  n tested in the 
+00027fb0: 434c 4920 7465 7374 732e 0a23 2054 6865  CLI tests..# The
+00027fc0: 7365 2074 6573 7473 2061 7265 2066 6f72  se tests are for
+00027fd0: 2074 6573 7469 6e67 2074 6865 2072 6574   testing the ret
+00027fe0: 7572 6e20 7661 6c75 6520 6f66 2074 6865  urn value of the
+00027ff0: 2041 5049 7320 6e6f 7420 6675 6c6c 7920   APIs not fully 
+00028000: 7573 6564 2069 6e20 434c 492e 0a0a 0a40  used in CLI....@
+00028010: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
+00028020: 6465 6620 7465 7374 5f63 6f72 655f 6170  def test_core_ap
+00028030: 695f 736b 795f 6c61 756e 6368 5f65 7865  i_sky_launch_exe
+00028040: 6328 293a 0a20 2020 206e 616d 6520 3d20  c():.    name = 
+00028050: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00028060: 6528 290a 2020 2020 7461 736b 203d 2073  e().    task = s
+00028070: 6b79 2e54 6173 6b28 7275 6e3d 2277 686f  ky.Task(run="who
+00028080: 616d 6922 290a 2020 2020 7461 736b 2e73  ami").    task.s
+00028090: 6574 5f72 6573 6f75 7263 6573 2873 6b79  et_resources(sky
+000280a0: 2e52 6573 6f75 7263 6573 2863 6c6f 7564  .Resources(cloud
+000280b0: 3d73 6b79 2e47 4350 2829 2929 0a20 2020  =sky.GCP())).   
+000280c0: 206a 6f62 5f69 642c 2068 616e 646c 6520   job_id, handle 
+000280d0: 3d20 736b 792e 6c61 756e 6368 2874 6173  = sky.launch(tas
+000280e0: 6b2c 2063 6c75 7374 6572 5f6e 616d 653d  k, cluster_name=
+000280f0: 6e61 6d65 290a 2020 2020 6173 7365 7274  name).    assert
+00028100: 206a 6f62 5f69 6420 3d3d 2031 0a20 2020   job_id == 1.   
+00028110: 2061 7373 6572 7420 6861 6e64 6c65 2069   assert handle i
+00028120: 7320 6e6f 7420 4e6f 6e65 0a20 2020 2061  s not None.    a
+00028130: 7373 6572 7420 6861 6e64 6c65 2e63 6c75  ssert handle.clu
+00028140: 7374 6572 5f6e 616d 6520 3d3d 206e 616d  ster_name == nam
+00028150: 650a 2020 2020 6173 7365 7274 2068 616e  e.    assert han
+00028160: 646c 652e 6c61 756e 6368 6564 5f72 6573  dle.launched_res
+00028170: 6f75 7263 6573 2e63 6c6f 7564 2e69 735f  ources.cloud.is_
+00028180: 7361 6d65 5f63 6c6f 7564 2873 6b79 2e47  same_cloud(sky.G
+00028190: 4350 2829 290a 2020 2020 6a6f 625f 6964  CP()).    job_id
+000281a0: 5f65 7865 632c 2068 616e 646c 655f 6578  _exec, handle_ex
+000281b0: 6563 203d 2073 6b79 2e65 7865 6328 7461  ec = sky.exec(ta
+000281c0: 736b 2c20 636c 7573 7465 725f 6e61 6d65  sk, cluster_name
+000281d0: 3d6e 616d 6529 0a20 2020 2061 7373 6572  =name).    asser
+000281e0: 7420 6a6f 625f 6964 5f65 7865 6320 3d3d  t job_id_exec ==
+000281f0: 2032 0a20 2020 2061 7373 6572 7420 6861   2.    assert ha
+00028200: 6e64 6c65 5f65 7865 6320 6973 206e 6f74  ndle_exec is not
+00028210: 204e 6f6e 650a 2020 2020 6173 7365 7274   None.    assert
+00028220: 2068 616e 646c 655f 6578 6563 2e63 6c75   handle_exec.clu
+00028230: 7374 6572 5f6e 616d 6520 3d3d 206e 616d  ster_name == nam
+00028240: 650a 2020 2020 6173 7365 7274 2068 616e  e.    assert han
+00028250: 646c 655f 6578 6563 2e6c 6175 6e63 6865  dle_exec.launche
+00028260: 645f 7265 736f 7572 6365 732e 636c 6f75  d_resources.clou
+00028270: 642e 6973 5f73 616d 655f 636c 6f75 6428  d.is_same_cloud(
+00028280: 736b 792e 4743 5028 2929 0a20 2020 2023  sky.GCP()).    #
+00028290: 2046 6f72 2064 756d 6d79 2074 6173 6b20   For dummy task 
+000282a0: 2869 2e65 2e20 7461 736b 2e72 756e 2069  (i.e. task.run i
+000282b0: 7320 4e6f 6e65 292c 2074 6865 206a 6f62  s None), the job
+000282c0: 2077 6f6e 2774 2062 6520 7375 626d 6974   won't be submit
+000282d0: 7465 642e 0a20 2020 2064 756d 6d79 5f74  ted..    dummy_t
+000282e0: 6173 6b20 3d20 736b 792e 5461 736b 2829  ask = sky.Task()
+000282f0: 0a20 2020 206a 6f62 5f69 645f 6475 6d6d  .    job_id_dumm
+00028300: 792c 205f 203d 2073 6b79 2e65 7865 6328  y, _ = sky.exec(
+00028310: 6475 6d6d 795f 7461 736b 2c20 636c 7573  dummy_task, clus
+00028320: 7465 725f 6e61 6d65 3d6e 616d 6529 0a20  ter_name=name). 
+00028330: 2020 2061 7373 6572 7420 6a6f 625f 6964     assert job_id
+00028340: 5f64 756d 6d79 2069 7320 4e6f 6e65 0a20  _dummy is None. 
+00028350: 2020 2073 6b79 2e64 6f77 6e28 6e61 6d65     sky.down(name
+00028360: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
+00028370: 2054 6573 7469 6e67 2053 746f 7261 6765   Testing Storage
+00028380: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 636c 6173   ----------.clas
+00028390: 7320 5465 7374 5374 6f72 6167 6557 6974  s TestStorageWit
+000283a0: 6843 7265 6465 6e74 6961 6c73 3a0a 2020  hCredentials:.  
+000283b0: 2020 2222 2253 746f 7261 6765 2074 6573    """Storage tes
+000283c0: 7473 2077 6869 6368 2072 6571 7569 7265  ts which require
+000283d0: 2063 7265 6465 6e74 6961 6c73 2061 6e64   credentials and
+000283e0: 206e 6574 776f 726b 2063 6f6e 6e65 6374   network connect
+000283f0: 696f 6e22 2222 0a0a 2020 2020 4157 535f  ion"""..    AWS_
+00028400: 494e 5641 4c49 445f 4e41 4d45 5320 3d20  INVALID_NAMES = 
+00028410: 5b0a 2020 2020 2020 2020 2761 6227 2c20  [.        'ab', 
+00028420: 2023 206c 6573 7320 7468 616e 2033 2063   # less than 3 c
+00028430: 6861 7261 6374 6572 730a 2020 2020 2020  haracters.      
+00028440: 2020 2761 6263 6465 6667 6869 6a6b 6c6d    'abcdefghijklm
+00028450: 6e6f 7071 7273 7475 7677 7879 7a61 6263  nopqrstuvwxyzabc
+00028460: 6465 6667 6869 6a6b 6c6d 6e6f 7071 7273  defghijklmnopqrs
+00028470: 7475 7677 7879 7a61 6263 6465 6667 6869  tuvwxyzabcdefghi
+00028480: 6a6b 6c6d 6e6f 7071 7273 7475 7677 7879  jklmnopqrstuvwxy
+00028490: 7a31 272c 0a20 2020 2020 2020 2023 206d  z1',.        # m
+000284a0: 6f72 6520 7468 616e 2036 3320 6368 6172  ore than 63 char
+000284b0: 6163 7465 7273 0a20 2020 2020 2020 2027  acters.        '
+000284c0: 4162 6364 6566 272c 2020 2320 636f 6e74  Abcdef',  # cont
+000284d0: 6169 6e73 2061 6e20 7570 7065 7263 6173  ains an uppercas
+000284e0: 6520 6c65 7474 6572 0a20 2020 2020 2020  e letter.       
+000284f0: 2027 6162 6320 6465 6627 2c20 2023 2063   'abc def',  # c
+00028500: 6f6e 7461 696e 7320 6120 7370 6163 650a  ontains a space.
+00028510: 2020 2020 2020 2020 2761 6263 2e2e 6465          'abc..de
+00028520: 6627 2c20 2023 2074 776f 2061 646a 6163  f',  # two adjac
+00028530: 656e 7420 7065 7269 6f64 730a 2020 2020  ent periods.    
+00028540: 2020 2020 2731 3932 2e31 3638 2e35 2e34      '192.168.5.4
+00028550: 272c 2020 2320 666f 726d 6174 7465 6420  ',  # formatted 
+00028560: 6173 2061 6e20 4950 2061 6464 7265 7373  as an IP address
+00028570: 0a20 2020 2020 2020 2027 786e 2d2d 6275  .        'xn--bu
+00028580: 636b 6574 272c 2020 2320 7374 6172 7473  cket',  # starts
+00028590: 2077 6974 6820 2778 6e2d 2d27 2070 7265   with 'xn--' pre
+000285a0: 6669 780a 2020 2020 2020 2020 2762 7563  fix.        'buc
+000285b0: 6b65 742d 7333 616c 6961 7327 2c20 2023  ket-s3alias',  #
+000285c0: 2065 6e64 7320 7769 7468 2027 2d73 3361   ends with '-s3a
+000285d0: 6c69 6173 2720 7375 6666 6978 0a20 2020  lias' suffix.   
+000285e0: 2020 2020 2027 6275 636b 6574 2d2d 6f6c       'bucket--ol
+000285f0: 2d73 3327 2c20 2023 2065 6e64 7320 7769  -s3',  # ends wi
+00028600: 7468 2027 2d2d 6f6c 2d73 3327 2073 7566  th '--ol-s3' suf
+00028610: 6669 780a 2020 2020 2020 2020 272e 6162  fix.        '.ab
+00028620: 6327 2c20 2023 2073 7461 7274 7320 7769  c',  # starts wi
+00028630: 7468 2061 2064 6f74 0a20 2020 2020 2020  th a dot.       
+00028640: 2027 6162 632e 272c 2020 2320 656e 6473   'abc.',  # ends
+00028650: 2077 6974 6820 6120 646f 740a 2020 2020   with a dot.    
+00028660: 2020 2020 272d 6162 6327 2c20 2023 2073      '-abc',  # s
+00028670: 7461 7274 7320 7769 7468 2061 2068 7970  tarts with a hyp
+00028680: 6865 6e0a 2020 2020 2020 2020 2761 6263  hen.        'abc
+00028690: 2d27 2c20 2023 2065 6e64 7320 7769 7468  -',  # ends with
+000286a0: 2061 2068 7970 6865 6e0a 2020 2020 5d0a   a hyphen.    ].
+000286b0: 0a20 2020 2047 4353 5f49 4e56 414c 4944  .    GCS_INVALID
+000286c0: 5f4e 414d 4553 203d 205b 0a20 2020 2020  _NAMES = [.     
+000286d0: 2020 2027 6162 272c 2020 2320 6c65 7373     'ab',  # less
+000286e0: 2074 6861 6e20 3320 6368 6172 6163 7465   than 3 characte
+000286f0: 7273 0a20 2020 2020 2020 2027 6162 6364  rs.        'abcd
+00028700: 6566 6768 696a 6b6c 6d6e 6f70 7172 7374  efghijklmnopqrst
+00028710: 7576 7778 797a 6162 6364 6566 6768 696a  uvwxyzabcdefghij
+00028720: 6b6c 6d6e 6f70 7172 7374 7576 7778 797a  klmnopqrstuvwxyz
+00028730: 6162 6364 6566 6768 696a 6b6c 6d6e 6f70  abcdefghijklmnop
+00028740: 7172 7374 7576 7778 797a 3127 2c0a 2020  qrstuvwxyz1',.  
+00028750: 2020 2020 2020 2320 6d6f 7265 2074 6861        # more tha
+00028760: 6e20 3633 2063 6861 7261 6374 6572 7320  n 63 characters 
+00028770: 2877 6974 686f 7574 2064 6f74 7329 0a20  (without dots). 
+00028780: 2020 2020 2020 2027 4162 6364 6566 272c         'Abcdef',
+00028790: 2020 2320 636f 6e74 6169 6e73 2061 6e20    # contains an 
+000287a0: 7570 7065 7263 6173 6520 6c65 7474 6572  uppercase letter
+000287b0: 0a20 2020 2020 2020 2027 6162 6320 6465  .        'abc de
+000287c0: 6627 2c20 2023 2063 6f6e 7461 696e 7320  f',  # contains 
+000287d0: 6120 7370 6163 650a 2020 2020 2020 2020  a space.        
+000287e0: 2761 6263 2e2e 6465 6627 2c20 2023 2074  'abc..def',  # t
+000287f0: 776f 2061 646a 6163 656e 7420 7065 7269  wo adjacent peri
+00028800: 6f64 730a 2020 2020 2020 2020 2761 6263  ods.        'abc
+00028810: 5f2e 6465 662e 6768 692e 6a6b 6c6d 6e6f  _.def.ghi.jklmno
+00028820: 7071 7273 7475 7677 7879 7a61 6263 6465  pqrstuvwxyzabcde
+00028830: 6667 6869 6a6b 6c6d 6e6f 7071 7273 7475  fghijklmnopqrstu
+00028840: 7677 7879 7a61 6263 6465 6667 6869 6a6b  vwxyzabcdefghijk
+00028850: 6c6d 6e6f 7071 7273 7475 7677 7879 7a31  lmnopqrstuvwxyz1
+00028860: 270a 2020 2020 2020 2020 2320 4d6f 7265  '.        # More
+00028870: 2074 6861 6e20 3633 2063 6861 7261 6374   than 63 charact
+00028880: 6572 7320 6265 7477 6565 6e20 646f 7473  ers between dots
+00028890: 0a20 2020 2020 2020 2027 6162 635f 2e64  .        'abc_.d
+000288a0: 6566 2e67 6869 2e6a 6b6c 6d6e 6f70 7172  ef.ghi.jklmnopqr
+000288b0: 7374 7576 7778 797a 6162 6364 6566 6768  stuvwxyzabcdefgh
+000288c0: 696a 6b6c 6d6e 6f70 7166 6768 696a 6b6c  ijklmnopqfghijkl
+000288d0: 6d6e 6f70 7172 7374 7576 7727 202a 2035  mnopqrstuvw' * 5
+000288e0: 2c0a 2020 2020 2020 2020 2320 6d6f 7265  ,.        # more
+000288f0: 2074 6861 6e20 3232 3220 6368 6172 6163   than 222 charac
+00028900: 7465 7273 2028 7769 7468 2064 6f74 7329  ters (with dots)
+00028910: 0a20 2020 2020 2020 2027 3139 322e 3136  .        '192.16
+00028920: 382e 352e 3427 2c20 2023 2066 6f72 6d61  8.5.4',  # forma
+00028930: 7474 6564 2061 7320 616e 2049 5020 6164  tted as an IP ad
+00028940: 6472 6573 730a 2020 2020 2020 2020 2767  dress.        'g
+00028950: 6f6f 6762 7563 6b65 7427 2c20 2023 2073  oogbucket',  # s
+00028960: 7461 7274 7320 7769 7468 2027 676f 6f67  tarts with 'goog
+00028970: 2720 7072 6566 6978 0a20 2020 2020 2020  ' prefix.       
+00028980: 2027 676f 6f67 6c65 6275 636b 6574 272c   'googlebucket',
+00028990: 2020 2320 636f 6e74 6169 6e73 2027 676f    # contains 'go
+000289a0: 6f67 6c65 270a 2020 2020 2020 2020 2767  ogle'.        'g
+000289b0: 3030 676c 6562 7563 6b65 7427 2c20 2023  00glebucket',  #
+000289c0: 2076 6172 6961 6e74 206f 6620 2767 6f6f   variant of 'goo
+000289d0: 676c 6527 0a20 2020 2020 2020 2027 676f  gle'.        'go
+000289e0: 3067 6c65 6275 636b 6574 272c 2020 2320  0glebucket',  # 
+000289f0: 7661 7269 616e 7420 6f66 2027 676f 6f67  variant of 'goog
+00028a00: 6c65 270a 2020 2020 2020 2020 2767 306f  le'.        'g0o
+00028a10: 676c 6562 7563 6b65 7427 2c20 2023 2076  glebucket',  # v
+00028a20: 6172 6961 6e74 206f 6620 2767 6f6f 676c  ariant of 'googl
+00028a30: 6527 0a20 2020 2020 2020 2027 2e61 6263  e'.        '.abc
+00028a40: 272c 2020 2320 7374 6172 7473 2077 6974  ',  # starts wit
+00028a50: 6820 6120 646f 740a 2020 2020 2020 2020  h a dot.        
+00028a60: 2761 6263 2e27 2c20 2023 2065 6e64 7320  'abc.',  # ends 
+00028a70: 7769 7468 2061 2064 6f74 0a20 2020 2020  with a dot.     
+00028a80: 2020 2027 5f61 6263 272c 2020 2320 7374     '_abc',  # st
+00028a90: 6172 7473 2077 6974 6820 616e 2075 6e64  arts with an und
+00028aa0: 6572 7363 6f72 650a 2020 2020 2020 2020  erscore.        
+00028ab0: 2761 6263 5f27 2c20 2023 2065 6e64 7320  'abc_',  # ends 
+00028ac0: 7769 7468 2061 6e20 756e 6465 7273 636f  with an undersco
+00028ad0: 7265 0a20 2020 205d 0a0a 2020 2020 4942  re.    ]..    IB
+00028ae0: 4d5f 494e 5641 4c49 445f 4e41 4d45 5320  M_INVALID_NAMES 
+00028af0: 3d20 5b0a 2020 2020 2020 2020 2761 6227  = [.        'ab'
+00028b00: 2c20 2023 206c 6573 7320 7468 616e 2033  ,  # less than 3
+00028b10: 2063 6861 7261 6374 6572 730a 2020 2020   characters.    
+00028b20: 2020 2020 2761 6263 6465 6667 6869 6a6b      'abcdefghijk
+00028b30: 6c6d 6e6f 7071 7273 7475 7677 7879 7a61  lmnopqrstuvwxyza
+00028b40: 6263 6465 6667 6869 6a6b 6c6d 6e6f 7071  bcdefghijklmnopq
+00028b50: 7273 7475 7677 7879 7a61 6263 6465 6667  rstuvwxyzabcdefg
+00028b60: 6869 6a6b 6c6d 6e6f 7071 7273 7475 7677  hijklmnopqrstuvw
+00028b70: 7879 7a31 272c 0a20 2020 2020 2020 2023  xyz1',.        #
+00028b80: 206d 6f72 6520 7468 616e 2036 3320 6368   more than 63 ch
+00028b90: 6172 6163 7465 7273 0a20 2020 2020 2020  aracters.       
+00028ba0: 2027 4162 6364 6566 272c 2020 2320 636f   'Abcdef',  # co
+00028bb0: 6e74 6169 6e73 2061 6e20 7570 7065 7263  ntains an upperc
+00028bc0: 6173 6520 6c65 7474 6572 0a20 2020 2020  ase letter.     
+00028bd0: 2020 2027 6162 6320 6465 6627 2c20 2023     'abc def',  #
+00028be0: 2063 6f6e 7461 696e 7320 6120 7370 6163   contains a spac
+00028bf0: 650a 2020 2020 2020 2020 2761 6263 2e2e  e.        'abc..
+00028c00: 6465 6627 2c20 2023 2074 776f 2061 646a  def',  # two adj
+00028c10: 6163 656e 7420 7065 7269 6f64 730a 2020  acent periods.  
+00028c20: 2020 2020 2020 2731 3932 2e31 3638 2e35        '192.168.5
+00028c30: 2e34 272c 2020 2320 666f 726d 6174 7465  .4',  # formatte
+00028c40: 6420 6173 2061 6e20 4950 2061 6464 7265  d as an IP addre
+00028c50: 7373 0a20 2020 2020 2020 2027 786e 2d2d  ss.        'xn--
+00028c60: 6275 636b 6574 272c 2020 2320 7374 6172  bucket',  # star
+00028c70: 7473 2077 6974 6820 2778 6e2d 2d27 2070  ts with 'xn--' p
+00028c80: 7265 6669 780a 2020 2020 2020 2020 272e  refix.        '.
+00028c90: 6162 6327 2c20 2023 2073 7461 7274 7320  abc',  # starts 
+00028ca0: 7769 7468 2061 2064 6f74 0a20 2020 2020  with a dot.     
+00028cb0: 2020 2027 6162 632e 272c 2020 2320 656e     'abc.',  # en
+00028cc0: 6473 2077 6974 6820 6120 646f 740a 2020  ds with a dot.  
+00028cd0: 2020 2020 2020 272d 6162 6327 2c20 2023        '-abc',  #
+00028ce0: 2073 7461 7274 7320 7769 7468 2061 2068   starts with a h
+00028cf0: 7970 6865 6e0a 2020 2020 2020 2020 2761  yphen.        'a
+00028d00: 6263 2d27 2c20 2023 2065 6e64 7320 7769  bc-',  # ends wi
+00028d10: 7468 2061 2068 7970 6865 6e0a 2020 2020  th a hyphen.    
+00028d20: 2020 2020 2761 2e2d 6263 272c 2020 2320      'a.-bc',  # 
+00028d30: 636f 6e74 6169 6e73 2074 6865 2073 6571  contains the seq
+00028d40: 7565 6e63 6520 272e 2d27 0a20 2020 2020  uence '.-'.     
+00028d50: 2020 2027 612d 2e62 6327 2c20 2023 2063     'a-.bc',  # c
+00028d60: 6f6e 7461 696e 7320 7468 6520 7365 7175  ontains the sequ
+00028d70: 656e 6365 2027 2d2e 270a 2020 2020 2020  ence '-.'.      
+00028d80: 2020 2761 2662 6327 2020 2320 636f 6e74    'a&bc'  # cont
+00028d90: 6169 6e73 2073 7065 6369 616c 2063 6861  ains special cha
+00028da0: 7261 6374 6572 730a 2020 2020 2020 2020  racters.        
+00028db0: 2761 625e 6327 2020 2320 636f 6e74 6169  'ab^c'  # contai
+00028dc0: 6e73 2073 7065 6369 616c 2063 6861 7261  ns special chara
+00028dd0: 6374 6572 730a 2020 2020 5d0a 2020 2020  cters.    ].    
+00028de0: 4749 5449 474e 4f52 455f 5359 4e43 5f54  GITIGNORE_SYNC_T
+00028df0: 4553 545f 4449 525f 5354 5255 4354 5552  EST_DIR_STRUCTUR
+00028e00: 4520 3d20 7b0a 2020 2020 2020 2020 2764  E = {.        'd
+00028e10: 6f75 626c 655f 6173 7465 7269 736b 273a  ouble_asterisk':
+00028e20: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
+00028e30: 646f 7562 6c65 5f61 7374 6572 6973 6b5f  double_asterisk_
+00028e40: 6578 636c 7564 6564 273a 204e 6f6e 652c  excluded': None,
+00028e50: 0a20 2020 2020 2020 2020 2020 2027 646f  .            'do
+00028e60: 7562 6c65 5f61 7374 6572 6973 6b5f 6578  uble_asterisk_ex
+00028e70: 636c 7564 6564 5f64 6972 273a 207b 0a20  cluded_dir': {. 
+00028e80: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00028e90: 6469 725f 6578 636c 7564 6564 273a 204e  dir_excluded': N
+00028ea0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00028eb0: 207d 2c0a 2020 2020 2020 2020 7d2c 0a20   },.        },. 
+00028ec0: 2020 2020 2020 2027 646f 7562 6c65 5f61         'double_a
+00028ed0: 7374 6572 6973 6b5f 7061 7265 6e74 273a  sterisk_parent':
+00028ee0: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
+00028ef0: 7061 7265 6e74 273a 207b 0a20 2020 2020  parent': {.     
+00028f00: 2020 2020 2020 2020 2020 2027 616c 736f             'also
+00028f10: 5f65 7863 6c75 6465 642e 7478 7427 3a20  _excluded.txt': 
+00028f20: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00028f30: 2020 2020 2020 2763 6869 6c64 273a 207b        'child': {
+00028f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028f50: 2020 2020 2027 646f 7562 6c65 5f61 7374       'double_ast
+00028f60: 6572 6973 6b5f 7061 7265 6e74 5f63 6869  erisk_parent_chi
+00028f70: 6c64 5f65 7863 6c75 6465 642e 7478 7427  ld_excluded.txt'
+00028f80: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+00028f90: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+00028fa0: 2020 2020 2020 2020 2020 2027 646f 7562             'doub
+00028fb0: 6c65 5f61 7374 6572 6973 6b5f 7061 7265  le_asterisk_pare
+00028fc0: 6e74 5f65 7863 6c75 6465 642e 7478 7427  nt_excluded.txt'
+00028fd0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+00028fe0: 2020 2020 7d2c 0a20 2020 2020 2020 207d      },.        }
+00028ff0: 2c0a 2020 2020 2020 2020 2765 7863 6c75  ,.        'exclu
+00029000: 6465 642e 6c6f 6727 3a20 4e6f 6e65 2c0a  ded.log': None,.
+00029010: 2020 2020 2020 2020 2765 7863 6c75 6465          'exclude
+00029020: 645f 6469 7227 3a20 7b0a 2020 2020 2020  d_dir': {.      
+00029030: 2020 2020 2020 2765 7863 6c75 6465 642e        'excluded.
+00029040: 7478 7427 3a20 4e6f 6e65 2c0a 2020 2020  txt': None,.    
+00029050: 2020 2020 2020 2020 276e 6573 7465 645f          'nested_
+00029060: 6578 636c 7564 6564 273a 207b 0a20 2020  excluded': {.   
+00029070: 2020 2020 2020 2020 2020 2020 2027 6578               'ex
+00029080: 636c 7564 6564 273a 204e 6f6e 652c 0a20  cluded': None,. 
+00029090: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
+000290a0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+000290b0: 2027 6578 702d 3127 3a20 7b0a 2020 2020   'exp-1': {.    
+000290c0: 2020 2020 2020 2020 2762 655f 6578 636c          'be_excl
+000290d0: 7564 6564 273a 204e 6f6e 652c 0a20 2020  uded': None,.   
+000290e0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+000290f0: 2765 7870 2d32 273a 207b 0a20 2020 2020  'exp-2': {.     
+00029100: 2020 2020 2020 2027 6265 5f65 7863 6c75         'be_exclu
+00029110: 6465 6427 3a20 4e6f 6e65 2c0a 2020 2020  ded': None,.    
+00029120: 2020 2020 7d2c 0a20 2020 2020 2020 2027      },.        '
+00029130: 6672 6f6e 745f 736c 6173 685f 6578 636c  front_slash_excl
+00029140: 7564 6564 273a 204e 6f6e 652c 0a20 2020  uded': None,.   
+00029150: 2020 2020 2027 696e 636c 7564 6564 2e6c       'included.l
+00029160: 6f67 273a 204e 6f6e 652c 0a20 2020 2020  og': None,.     
+00029170: 2020 2027 696e 636c 7564 6564 2e74 7874     'included.txt
+00029180: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
+00029190: 2027 696e 636c 7564 655f 6469 7227 3a20   'include_dir': 
+000291a0: 7b0a 2020 2020 2020 2020 2020 2020 2765  {.            'e
+000291b0: 7863 6c75 6465 642e 6c6f 6727 3a20 4e6f  xcluded.log': No
+000291c0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+000291d0: 2769 6e63 6c75 6465 642e 6c6f 6727 3a20  'included.log': 
+000291e0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7d2c  None,.        },
+000291f0: 0a20 2020 2020 2020 2027 6e65 7374 6564  .        'nested
+00029200: 5f64 6f75 626c 655f 6173 7465 7269 736b  _double_asterisk
+00029210: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+00029220: 2027 6f6e 6527 3a20 7b0a 2020 2020 2020   'one': {.      
+00029230: 2020 2020 2020 2020 2020 2761 6c73 6f5f            'also_
+00029240: 6578 636c 7564 652e 7478 7427 3a20 4e6f  exclude.txt': No
+00029250: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+00029260: 7d2c 0a20 2020 2020 2020 2020 2020 2027  },.            '
+00029270: 7477 6f27 3a20 7b0a 2020 2020 2020 2020  two': {.        
+00029280: 2020 2020 2020 2020 2761 6c73 6f5f 6578          'also_ex
+00029290: 636c 7564 652e 7478 7427 3a20 4e6f 6e65  clude.txt': None
+000292a0: 2c0a 2020 2020 2020 2020 2020 2020 7d2c  ,.            },
+000292b0: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
+000292c0: 2020 2020 276e 6573 7465 645f 7769 6c64      'nested_wild
+000292d0: 6361 7264 5f64 6972 273a 207b 0a20 2020  card_dir': {.   
+000292e0: 2020 2020 2020 2020 2027 6d6f 6e64 6179           'monday
+000292f0: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+00029300: 2020 2020 2027 616c 736f 5f65 7863 6c75       'also_exclu
+00029310: 6465 2e74 7874 273a 204e 6f6e 652c 0a20  de.txt': None,. 
+00029320: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
+00029330: 2020 2020 2020 2020 2020 2774 7565 7364            'tuesd
+00029340: 6179 273a 207b 0a20 2020 2020 2020 2020  ay': {.         
+00029350: 2020 2020 2020 2027 616c 736f 5f65 7863         'also_exc
+00029360: 6c75 6465 2e74 7874 273a 204e 6f6e 652c  lude.txt': None,
+00029370: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
+00029380: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+00029390: 2020 2027 6e6f 5f73 6c61 7368 5f65 7863     'no_slash_exc
+000293a0: 6c75 6465 6427 3a20 4e6f 6e65 2c0a 2020  luded': None,.  
+000293b0: 2020 2020 2020 276e 6f5f 736c 6173 685f        'no_slash_
+000293c0: 7465 7374 7327 3a20 7b0a 2020 2020 2020  tests': {.      
+000293d0: 2020 2020 2020 276e 6f5f 736c 6173 685f        'no_slash_
+000293e0: 6578 636c 7564 6564 273a 207b 0a20 2020  excluded': {.   
+000293f0: 2020 2020 2020 2020 2020 2020 2027 616c               'al
+00029400: 736f 5f65 7863 6c75 6465 642e 7478 7427  so_excluded.txt'
+00029410: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+00029420: 2020 2020 7d2c 0a20 2020 2020 2020 207d      },.        }
+00029430: 2c0a 2020 2020 2020 2020 2771 7565 7374  ,.        'quest
+00029440: 696f 6e5f 6d61 726b 273a 207b 0a20 2020  ion_mark': {.   
+00029450: 2020 2020 2020 2020 2027 6578 636c 7564           'exclud
+00029460: 6564 312e 7478 7427 3a20 4e6f 6e65 2c0a  ed1.txt': None,.
+00029470: 2020 2020 2020 2020 2020 2020 2765 7863              'exc
+00029480: 6c75 6465 6440 2e74 7874 273a 204e 6f6e  luded@.txt': Non
+00029490: 652c 0a20 2020 2020 2020 207d 2c0a 2020  e,.        },.  
+000294a0: 2020 2020 2020 2773 7175 6172 655f 6272        'square_br
+000294b0: 6163 6b65 7427 3a20 7b0a 2020 2020 2020  acket': {.      
+000294c0: 2020 2020 2020 2765 7863 6c75 6465 6431        'excluded1
+000294d0: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
+000294e0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+000294f0: 2773 7175 6172 655f 6272 6163 6b65 745f  'square_bracket_
+00029500: 616c 7068 6127 3a20 7b0a 2020 2020 2020  alpha': {.      
+00029510: 2020 2020 2020 2765 7863 6c75 6465 647a        'excludedz
+00029520: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
+00029530: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+00029540: 2773 7175 6172 655f 6272 6163 6b65 745f  'square_bracket_
+00029550: 6578 636c 6127 3a20 7b0a 2020 2020 2020  excla': {.      
+00029560: 2020 2020 2020 2765 7863 6c75 6465 6432        'excluded2
+00029570: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
+00029580: 2020 2020 2020 2020 2027 6578 636c 7564           'exclud
+00029590: 6564 402e 7478 7427 3a20 4e6f 6e65 2c0a  ed@.txt': None,.
+000295a0: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+000295b0: 2020 2027 7371 7561 7265 5f62 7261 636b     'square_brack
+000295c0: 6574 5f73 696e 676c 6527 3a20 7b0a 2020  et_single': {.  
+000295d0: 2020 2020 2020 2020 2020 2765 7863 6c75            'exclu
+000295e0: 6465 6430 2e74 7874 273a 204e 6f6e 652c  ded0.txt': None,
+000295f0: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
+00029600: 7d0a 0a20 2020 2040 7374 6174 6963 6d65  }..    @staticme
+00029610: 7468 6f64 0a20 2020 2064 6566 2063 7265  thod.    def cre
+00029620: 6174 655f 6469 725f 7374 7275 6374 7572  ate_dir_structur
+00029630: 6528 6261 7365 5f70 6174 682c 2073 7472  e(base_path, str
+00029640: 7563 7475 7265 293a 0a20 2020 2020 2020  ucture):.       
+00029650: 2023 2063 7265 6174 6573 2061 2067 6976   # creates a giv
+00029660: 656e 2066 696c 6520 5354 5255 4354 5552  en file STRUCTUR
+00029670: 4520 696e 2042 4153 455f 5041 5448 0a20  E in BASE_PATH. 
+00029680: 2020 2020 2020 2066 6f72 206e 616d 652c         for name,
+00029690: 2073 7562 7374 7275 6374 7572 6520 696e   substructure in
+000296a0: 2073 7472 7563 7475 7265 2e69 7465 6d73   structure.items
+000296b0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+000296c0: 7061 7468 203d 206f 732e 7061 7468 2e6a  path = os.path.j
+000296d0: 6f69 6e28 6261 7365 5f70 6174 682c 206e  oin(base_path, n
+000296e0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+000296f0: 2069 6620 7375 6273 7472 7563 7475 7265   if substructure
+00029700: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00029710: 2020 2020 2020 2020 2020 2320 4372 6561            # Crea
+00029720: 7465 2061 2066 696c 650a 2020 2020 2020  te a file.      
+00029730: 2020 2020 2020 2020 2020 6f70 656e 2870            open(p
+00029740: 6174 682c 2027 6127 2c20 656e 636f 6469  ath, 'a', encodi
+00029750: 6e67 3d27 7574 662d 3827 292e 636c 6f73  ng='utf-8').clos
+00029760: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+00029770: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00029780: 2020 2020 2020 2320 4372 6561 7465 2061        # Create a
+00029790: 2073 7562 6469 7265 6374 6f72 790a 2020   subdirectory.  
+000297a0: 2020 2020 2020 2020 2020 2020 2020 6f73                os
+000297b0: 2e6d 6b64 6972 2870 6174 6829 0a20 2020  .mkdir(path).   
+000297c0: 2020 2020 2020 2020 2020 2020 2054 6573               Tes
+000297d0: 7453 746f 7261 6765 5769 7468 4372 6564  tStorageWithCred
+000297e0: 656e 7469 616c 732e 6372 6561 7465 5f64  entials.create_d
+000297f0: 6972 5f73 7472 7563 7475 7265 280a 2020  ir_structure(.  
+00029800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029810: 2020 7061 7468 2c20 7375 6273 7472 7563    path, substruc
+00029820: 7475 7265 290a 0a20 2020 2040 7374 6174  ture)..    @stat
+00029830: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
+00029840: 2063 6c69 5f64 656c 6574 655f 636d 6428   cli_delete_cmd(
+00029850: 7374 6f72 655f 7479 7065 2c20 6275 636b  store_type, buck
+00029860: 6574 5f6e 616d 6529 3a0a 2020 2020 2020  et_name):.      
+00029870: 2020 6966 2073 746f 7265 5f74 7970 6520    if store_type 
+00029880: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
+00029890: 746f 7265 5479 7065 2e53 333a 0a20 2020  toreType.S3:.   
+000298a0: 2020 2020 2020 2020 2075 726c 203d 2066           url = f
+000298b0: 2773 333a 2f2f 7b62 7563 6b65 745f 6e61  's3://{bucket_na
+000298c0: 6d65 7d27 0a20 2020 2020 2020 2020 2020  me}'.           
+000298d0: 2072 6574 7572 6e20 6627 6177 7320 7333   return f'aws s3
+000298e0: 2072 6220 7b75 726c 7d20 2d2d 666f 7263   rb {url} --forc
+000298f0: 6527 0a20 2020 2020 2020 2069 6620 7374  e'.        if st
+00029900: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
+00029910: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+00029920: 652e 4743 533a 0a20 2020 2020 2020 2020  e.GCS:.         
+00029930: 2020 2075 726c 203d 2066 2767 733a 2f2f     url = f'gs://
+00029940: 7b62 7563 6b65 745f 6e61 6d65 7d27 0a20  {bucket_name}'. 
+00029950: 2020 2020 2020 2020 2020 2067 7375 7469             gsuti
+00029960: 6c5f 616c 6961 732c 2061 6c69 6173 5f67  l_alias, alias_g
+00029970: 656e 203d 2064 6174 615f 7574 696c 732e  en = data_utils.
+00029980: 6765 745f 6773 7574 696c 5f63 6f6d 6d61  get_gsutil_comma
+00029990: 6e64 2829 0a20 2020 2020 2020 2020 2020  nd().           
+000299a0: 2072 6574 7572 6e20 6627 7b61 6c69 6173   return f'{alias
+000299b0: 5f67 656e 7d3b 207b 6773 7574 696c 5f61  _gen}; {gsutil_a
+000299c0: 6c69 6173 7d20 726d 202d 7220 7b75 726c  lias} rm -r {url
+000299d0: 7d27 0a20 2020 2020 2020 2069 6620 7374  }'.        if st
+000299e0: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
+000299f0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+00029a00: 652e 5232 3a0a 2020 2020 2020 2020 2020  e.R2:.          
+00029a10: 2020 656e 6470 6f69 6e74 5f75 726c 203d    endpoint_url =
+00029a20: 2063 6c6f 7564 666c 6172 652e 6372 6561   cloudflare.crea
+00029a30: 7465 5f65 6e64 706f 696e 7428 290a 2020  te_endpoint().  
+00029a40: 2020 2020 2020 2020 2020 7572 6c20 3d20            url = 
+00029a50: 6627 7333 3a2f 2f7b 6275 636b 6574 5f6e  f's3://{bucket_n
+00029a60: 616d 657d 270a 2020 2020 2020 2020 2020  ame}'.          
+00029a70: 2020 7265 7475 726e 2066 2741 5753 5f53    return f'AWS_S
+00029a80: 4841 5245 445f 4352 4544 454e 5449 414c  HARED_CREDENTIAL
+00029a90: 535f 4649 4c45 3d7b 636c 6f75 6466 6c61  S_FILE={cloudfla
+00029aa0: 7265 2e52 325f 4352 4544 454e 5449 414c  re.R2_CREDENTIAL
+00029ab0: 535f 5041 5448 7d20 6177 7320 7333 2072  S_PATH} aws s3 r
+00029ac0: 6220 7b75 726c 7d20 2d2d 666f 7263 6520  b {url} --force 
+00029ad0: 2d2d 656e 6470 6f69 6e74 207b 656e 6470  --endpoint {endp
+00029ae0: 6f69 6e74 5f75 726c 7d20 2d2d 7072 6f66  oint_url} --prof
+00029af0: 696c 653d 7232 270a 2020 2020 2020 2020  ile=r2'.        
+00029b00: 6966 2073 746f 7265 5f74 7970 6520 3d3d  if store_type ==
+00029b10: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+00029b20: 7265 5479 7065 2e49 424d 3a0a 2020 2020  reType.IBM:.    
+00029b30: 2020 2020 2020 2020 6275 636b 6574 5f72          bucket_r
+00029b40: 636c 6f6e 655f 7072 6f66 696c 6520 3d20  clone_profile = 
+00029b50: 5263 6c6f 6e65 2e67 656e 6572 6174 655f  Rclone.generate_
+00029b60: 7263 6c6f 6e65 5f62 7563 6b65 745f 7072  rclone_bucket_pr
+00029b70: 6f66 696c 655f 6e61 6d65 280a 2020 2020  ofile_name(.    
+00029b80: 2020 2020 2020 2020 2020 2020 6275 636b              buck
+00029b90: 6574 5f6e 616d 652c 2052 636c 6f6e 652e  et_name, Rclone.
+00029ba0: 5263 6c6f 6e65 436c 6f75 6473 2e49 424d  RcloneClouds.IBM
+00029bb0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00029bc0: 7475 726e 2066 2772 636c 6f6e 6520 7075  turn f'rclone pu
+00029bd0: 7267 6520 7b62 7563 6b65 745f 7263 6c6f  rge {bucket_rclo
+00029be0: 6e65 5f70 726f 6669 6c65 7d3a 7b62 7563  ne_profile}:{buc
+00029bf0: 6b65 745f 6e61 6d65 7d20 2626 2072 636c  ket_name} && rcl
+00029c00: 6f6e 6520 636f 6e66 6967 2064 656c 6574  one config delet
+00029c10: 6520 7b62 7563 6b65 745f 7263 6c6f 6e65  e {bucket_rclone
+00029c20: 5f70 726f 6669 6c65 7d27 0a0a 2020 2020  _profile}'..    
+00029c30: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
+00029c40: 2020 6465 6620 636c 695f 6c73 5f63 6d64    def cli_ls_cmd
+00029c50: 2873 746f 7265 5f74 7970 652c 2062 7563  (store_type, buc
+00029c60: 6b65 745f 6e61 6d65 2c20 7375 6666 6978  ket_name, suffix
+00029c70: 3d27 2729 3a0a 2020 2020 2020 2020 6966  =''):.        if
+00029c80: 2073 746f 7265 5f74 7970 6520 3d3d 2073   store_type == s
+00029c90: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+00029ca0: 5479 7065 2e53 333a 0a20 2020 2020 2020  Type.S3:.       
+00029cb0: 2020 2020 2069 6620 7375 6666 6978 3a0a       if suffix:.
+00029cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029cd0: 7572 6c20 3d20 6627 7333 3a2f 2f7b 6275  url = f's3://{bu
+00029ce0: 636b 6574 5f6e 616d 657d 2f7b 7375 6666  cket_name}/{suff
+00029cf0: 6978 7d27 0a20 2020 2020 2020 2020 2020  ix}'.           
+00029d00: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00029d10: 2020 2020 2020 2075 726c 203d 2066 2773         url = f's
+00029d20: 333a 2f2f 7b62 7563 6b65 745f 6e61 6d65  3://{bucket_name
+00029d30: 7d27 0a20 2020 2020 2020 2020 2020 2072  }'.            r
+00029d40: 6574 7572 6e20 6627 6177 7320 7333 206c  eturn f'aws s3 l
+00029d50: 7320 7b75 726c 7d27 0a20 2020 2020 2020  s {url}'.       
+00029d60: 2069 6620 7374 6f72 655f 7479 7065 203d   if store_type =
+00029d70: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
+00029d80: 6f72 6554 7970 652e 4743 533a 0a20 2020  oreType.GCS:.   
+00029d90: 2020 2020 2020 2020 2069 6620 7375 6666           if suff
+00029da0: 6978 3a0a 2020 2020 2020 2020 2020 2020  ix:.            
+00029db0: 2020 2020 7572 6c20 3d20 6627 6773 3a2f      url = f'gs:/
+00029dc0: 2f7b 6275 636b 6574 5f6e 616d 657d 2f7b  /{bucket_name}/{
+00029dd0: 7375 6666 6978 7d27 0a20 2020 2020 2020  suffix}'.       
+00029de0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00029df0: 2020 2020 2020 2020 2020 2075 726c 203d             url =
+00029e00: 2066 2767 733a 2f2f 7b62 7563 6b65 745f   f'gs://{bucket_
+00029e10: 6e61 6d65 7d27 0a20 2020 2020 2020 2020  name}'.         
+00029e20: 2020 2072 6574 7572 6e20 6627 6773 7574     return f'gsut
+00029e30: 696c 206c 7320 7b75 726c 7d27 0a20 2020  il ls {url}'.   
+00029e40: 2020 2020 2069 6620 7374 6f72 655f 7479       if store_ty
+00029e50: 7065 203d 3d20 7374 6f72 6167 655f 6c69  pe == storage_li
+00029e60: 622e 5374 6f72 6554 7970 652e 5232 3a0a  b.StoreType.R2:.
+00029e70: 2020 2020 2020 2020 2020 2020 656e 6470              endp
+00029e80: 6f69 6e74 5f75 726c 203d 2063 6c6f 7564  oint_url = cloud
+00029e90: 666c 6172 652e 6372 6561 7465 5f65 6e64  flare.create_end
+00029ea0: 706f 696e 7428 290a 2020 2020 2020 2020  point().        
+00029eb0: 2020 2020 6966 2073 7566 6669 783a 0a20      if suffix:. 
+00029ec0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+00029ed0: 726c 203d 2066 2773 333a 2f2f 7b62 7563  rl = f's3://{buc
+00029ee0: 6b65 745f 6e61 6d65 7d2f 7b73 7566 6669  ket_name}/{suffi
+00029ef0: 787d 270a 2020 2020 2020 2020 2020 2020  x}'.            
+00029f00: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00029f10: 2020 2020 2020 7572 6c20 3d20 6627 7333        url = f's3
+00029f20: 3a2f 2f7b 6275 636b 6574 5f6e 616d 657d  ://{bucket_name}
+00029f30: 270a 2020 2020 2020 2020 2020 2020 7265  '.            re
+00029f40: 7475 726e 2066 2741 5753 5f53 4841 5245  turn f'AWS_SHARE
+00029f50: 445f 4352 4544 454e 5449 414c 535f 4649  D_CREDENTIALS_FI
+00029f60: 4c45 3d7b 636c 6f75 6466 6c61 7265 2e52  LE={cloudflare.R
+00029f70: 325f 4352 4544 454e 5449 414c 535f 5041  2_CREDENTIALS_PA
+00029f80: 5448 7d20 6177 7320 7333 206c 7320 7b75  TH} aws s3 ls {u
+00029f90: 726c 7d20 2d2d 656e 6470 6f69 6e74 207b  rl} --endpoint {
+00029fa0: 656e 6470 6f69 6e74 5f75 726c 7d20 2d2d  endpoint_url} --
+00029fb0: 7072 6f66 696c 653d 7232 270a 2020 2020  profile=r2'.    
+00029fc0: 2020 2020 6966 2073 746f 7265 5f74 7970      if store_typ
+00029fd0: 6520 3d3d 2073 746f 7261 6765 5f6c 6962  e == storage_lib
+00029fe0: 2e53 746f 7265 5479 7065 2e49 424d 3a0a  .StoreType.IBM:.
+00029ff0: 2020 2020 2020 2020 2020 2020 6275 636b              buck
+0002a000: 6574 5f72 636c 6f6e 655f 7072 6f66 696c  et_rclone_profil
+0002a010: 6520 3d20 5263 6c6f 6e65 2e67 656e 6572  e = Rclone.gener
+0002a020: 6174 655f 7263 6c6f 6e65 5f62 7563 6b65  ate_rclone_bucke
+0002a030: 745f 7072 6f66 696c 655f 6e61 6d65 280a  t_profile_name(.
+0002a040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a050: 6275 636b 6574 5f6e 616d 652c 2052 636c  bucket_name, Rcl
+0002a060: 6f6e 652e 5263 6c6f 6e65 436c 6f75 6473  one.RcloneClouds
+0002a070: 2e49 424d 290a 2020 2020 2020 2020 2020  .IBM).          
+0002a080: 2020 7265 7475 726e 2066 2772 636c 6f6e    return f'rclon
+0002a090: 6520 6c73 207b 6275 636b 6574 5f72 636c  e ls {bucket_rcl
+0002a0a0: 6f6e 655f 7072 6f66 696c 657d 3a7b 6275  one_profile}:{bu
+0002a0b0: 636b 6574 5f6e 616d 657d 2f7b 7375 6666  cket_name}/{suff
+0002a0c0: 6978 7d27 0a0a 2020 2020 4073 7461 7469  ix}'..    @stati
+0002a0d0: 636d 6574 686f 640a 2020 2020 6465 6620  cmethod.    def 
+0002a0e0: 636c 695f 7265 6769 6f6e 5f63 6d64 2873  cli_region_cmd(s
+0002a0f0: 746f 7265 5f74 7970 652c 2062 7563 6b65  tore_type, bucke
+0002a100: 745f 6e61 6d65 293a 0a20 2020 2020 2020  t_name):.       
+0002a110: 2069 6620 7374 6f72 655f 7479 7065 203d   if store_type =
+0002a120: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
+0002a130: 6f72 6554 7970 652e 5333 3a0a 2020 2020  oreType.S3:.    
+0002a140: 2020 2020 2020 2020 7265 7475 726e 2028          return (
+0002a150: 2761 7773 2073 3361 7069 2067 6574 2d62  'aws s3api get-b
+0002a160: 7563 6b65 742d 6c6f 6361 7469 6f6e 2027  ucket-location '
+0002a170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a180: 2020 2020 2066 272d 2d62 7563 6b65 7420       f'--bucket 
+0002a190: 7b62 7563 6b65 745f 6e61 6d65 7d20 2d2d  {bucket_name} --
+0002a1a0: 6f75 7470 7574 2074 6578 7427 290a 2020  output text').  
+0002a1b0: 2020 2020 2020 656c 6966 2073 746f 7265        elif store
+0002a1c0: 5f74 7970 6520 3d3d 2073 746f 7261 6765  _type == storage
+0002a1d0: 5f6c 6962 2e53 746f 7265 5479 7065 2e47  _lib.StoreType.G
+0002a1e0: 4353 3a0a 2020 2020 2020 2020 2020 2020  CS:.            
+0002a1f0: 7265 7475 726e 2028 6627 6773 7574 696c  return (f'gsutil
+0002a200: 206c 7320 2d4c 202d 6220 6773 3a2f 2f7b   ls -L -b gs://{
+0002a210: 6275 636b 6574 5f6e 616d 657d 2f20 7c20  bucket_name}/ | 
+0002a220: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0002a230: 2020 2020 2020 2767 7265 7020 224c 6f63        'grep "Loc
+0002a240: 6174 696f 6e20 636f 6e73 7472 6169 6e74  ation constraint
+0002a250: 2220 7c20 270a 2020 2020 2020 2020 2020  " | '.          
+0002a260: 2020 2020 2020 2020 2020 2761 776b 205c            'awk \
+0002a270: 277b 7072 696e 7420 746f 6c6f 7765 7228  '{print tolower(
+0002a280: 244e 4629 7d5c 2727 290a 2020 2020 2020  $NF)}\'').      
+0002a290: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0002a2a0: 2020 2020 7261 6973 6520 4e6f 7449 6d70      raise NotImp
+0002a2b0: 6c65 6d65 6e74 6564 4572 726f 7228 6627  lementedError(f'
+0002a2c0: 5265 6769 6f6e 2063 6f6d 6d61 6e64 206e  Region command n
+0002a2d0: 6f74 2069 6d70 6c65 6d65 6e74 6564 2066  ot implemented f
+0002a2e0: 6f72 2027 0a20 2020 2020 2020 2020 2020  or '.           
+0002a2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a300: 2020 2020 2020 2020 2020 2066 277b 7374             f'{st
+0002a310: 6f72 655f 7479 7065 7d27 290a 0a20 2020  ore_type}')..   
+0002a320: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
+0002a330: 2020 2064 6566 2063 6c69 5f63 6f75 6e74     def cli_count
+0002a340: 5f6e 616d 655f 696e 5f62 7563 6b65 7428  _name_in_bucket(
+0002a350: 7374 6f72 655f 7479 7065 2c20 6275 636b  store_type, buck
+0002a360: 6574 5f6e 616d 652c 2066 696c 655f 6e61  et_name, file_na
+0002a370: 6d65 2c20 7375 6666 6978 3d27 2729 3a0a  me, suffix=''):.
+0002a380: 2020 2020 2020 2020 6966 2073 746f 7265          if store
+0002a390: 5f74 7970 6520 3d3d 2073 746f 7261 6765  _type == storage
+0002a3a0: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
+0002a3b0: 333a 0a20 2020 2020 2020 2020 2020 2069  3:.            i
+0002a3c0: 6620 7375 6666 6978 3a0a 2020 2020 2020  f suffix:.      
+0002a3d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0002a3e0: 2066 2761 7773 2073 3361 7069 206c 6973   f'aws s3api lis
+0002a3f0: 742d 6f62 6a65 6374 7320 2d2d 6275 636b  t-objects --buck
+0002a400: 6574 2022 7b62 7563 6b65 745f 6e61 6d65  et "{bucket_name
+0002a410: 7d22 202d 2d70 7265 6669 7820 7b73 7566  }" --prefix {suf
+0002a420: 6669 787d 202d 2d71 7565 7279 2022 6c65  fix} --query "le
+0002a430: 6e67 7468 2843 6f6e 7465 6e74 735b 3f63  ngth(Contents[?c
+0002a440: 6f6e 7461 696e 7328 4b65 792c 5c27 7b66  ontains(Key,\'{f
+0002a450: 696c 655f 6e61 6d65 7d5c 2729 5d2e 4b65  ile_name}\')].Ke
+0002a460: 7929 2227 0a20 2020 2020 2020 2020 2020  y)"'.           
+0002a470: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0002a480: 2020 2020 2020 2072 6574 7572 6e20 6627         return f'
+0002a490: 6177 7320 7333 6170 6920 6c69 7374 2d6f  aws s3api list-o
+0002a4a0: 626a 6563 7473 202d 2d62 7563 6b65 7420  bjects --bucket 
+0002a4b0: 227b 6275 636b 6574 5f6e 616d 657d 2220  "{bucket_name}" 
+0002a4c0: 2d2d 7175 6572 7920 226c 656e 6774 6828  --query "length(
+0002a4d0: 436f 6e74 656e 7473 5b3f 636f 6e74 6169  Contents[?contai
+0002a4e0: 6e73 284b 6579 2c5c 277b 6669 6c65 5f6e  ns(Key,\'{file_n
+0002a4f0: 616d 657d 5c27 295d 2e4b 6579 2922 270a  ame}\')].Key)"'.
+0002a500: 2020 2020 2020 2020 656c 6966 2073 746f          elif sto
+0002a510: 7265 5f74 7970 6520 3d3d 2073 746f 7261  re_type == stora
+0002a520: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0002a530: 2e47 4353 3a0a 2020 2020 2020 2020 2020  .GCS:.          
+0002a540: 2020 6966 2073 7566 6669 783a 0a20 2020    if suffix:.   
+0002a550: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0002a560: 7572 6e20 6627 6773 7574 696c 206c 7320  urn f'gsutil ls 
+0002a570: 2d72 2067 733a 2f2f 7b62 7563 6b65 745f  -r gs://{bucket_
+0002a580: 6e61 6d65 7d2f 7b73 7566 6669 787d 207c  name}/{suffix} |
+0002a590: 2067 7265 7020 227b 6669 6c65 5f6e 616d   grep "{file_nam
+0002a5a0: 657d 2220 7c20 7763 202d 6c27 0a20 2020  e}" | wc -l'.   
+0002a5b0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0002a5c0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0002a5d0: 6574 7572 6e20 6627 6773 7574 696c 206c  eturn f'gsutil l
+0002a5e0: 7320 2d72 2067 733a 2f2f 7b62 7563 6b65  s -r gs://{bucke
+0002a5f0: 745f 6e61 6d65 7d20 7c20 6772 6570 2022  t_name} | grep "
+0002a600: 7b66 696c 655f 6e61 6d65 7d22 207c 2077  {file_name}" | w
+0002a610: 6320 2d6c 270a 2020 2020 2020 2020 656c  c -l'.        el
+0002a620: 6966 2073 746f 7265 5f74 7970 6520 3d3d  if store_type ==
+0002a630: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+0002a640: 7265 5479 7065 2e52 323a 0a20 2020 2020  reType.R2:.     
+0002a650: 2020 2020 2020 2065 6e64 706f 696e 745f         endpoint_
+0002a660: 7572 6c20 3d20 636c 6f75 6466 6c61 7265  url = cloudflare
+0002a670: 2e63 7265 6174 655f 656e 6470 6f69 6e74  .create_endpoint
+0002a680: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
+0002a690: 6620 7375 6666 6978 3a0a 2020 2020 2020  f suffix:.      
+0002a6a0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0002a6b0: 2066 2741 5753 5f53 4841 5245 445f 4352   f'AWS_SHARED_CR
+0002a6c0: 4544 454e 5449 414c 535f 4649 4c45 3d7b  EDENTIALS_FILE={
+0002a6d0: 636c 6f75 6466 6c61 7265 2e52 325f 4352  cloudflare.R2_CR
+0002a6e0: 4544 454e 5449 414c 535f 5041 5448 7d20  EDENTIALS_PATH} 
+0002a6f0: 6177 7320 7333 6170 6920 6c69 7374 2d6f  aws s3api list-o
+0002a700: 626a 6563 7473 202d 2d62 7563 6b65 7420  bjects --bucket 
+0002a710: 227b 6275 636b 6574 5f6e 616d 657d 2220  "{bucket_name}" 
+0002a720: 2d2d 7072 6566 6978 207b 7375 6666 6978  --prefix {suffix
+0002a730: 7d20 2d2d 7175 6572 7920 226c 656e 6774  } --query "lengt
+0002a740: 6828 436f 6e74 656e 7473 5b3f 636f 6e74  h(Contents[?cont
+0002a750: 6169 6e73 284b 6579 2c5c 277b 6669 6c65  ains(Key,\'{file
+0002a760: 5f6e 616d 657d 5c27 295d 2e4b 6579 2922  _name}\')].Key)"
+0002a770: 202d 2d65 6e64 706f 696e 7420 7b65 6e64   --endpoint {end
+0002a780: 706f 696e 745f 7572 6c7d 202d 2d70 726f  point_url} --pro
+0002a790: 6669 6c65 3d72 3227 0a20 2020 2020 2020  file=r2'.       
+0002a7a0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0002a7b0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0002a7c0: 6e20 6627 4157 535f 5348 4152 4544 5f43  n f'AWS_SHARED_C
+0002a7d0: 5245 4445 4e54 4941 4c53 5f46 494c 453d  REDENTIALS_FILE=
+0002a7e0: 7b63 6c6f 7564 666c 6172 652e 5232 5f43  {cloudflare.R2_C
+0002a7f0: 5245 4445 4e54 4941 4c53 5f50 4154 487d  REDENTIALS_PATH}
+0002a800: 2061 7773 2073 3361 7069 206c 6973 742d   aws s3api list-
+0002a810: 6f62 6a65 6374 7320 2d2d 6275 636b 6574  objects --bucket
+0002a820: 2022 7b62 7563 6b65 745f 6e61 6d65 7d22   "{bucket_name}"
+0002a830: 202d 2d71 7565 7279 2022 6c65 6e67 7468   --query "length
+0002a840: 2843 6f6e 7465 6e74 735b 3f63 6f6e 7461  (Contents[?conta
+0002a850: 696e 7328 4b65 792c 5c27 7b66 696c 655f  ins(Key,\'{file_
+0002a860: 6e61 6d65 7d5c 2729 5d2e 4b65 7929 2220  name}\')].Key)" 
+0002a870: 2d2d 656e 6470 6f69 6e74 207b 656e 6470  --endpoint {endp
+0002a880: 6f69 6e74 5f75 726c 7d20 2d2d 7072 6f66  oint_url} --prof
+0002a890: 696c 653d 7232 270a 0a20 2020 2040 7374  ile=r2'..    @st
+0002a8a0: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
+0002a8b0: 6566 2063 6c69 5f63 6f75 6e74 5f66 696c  ef cli_count_fil
+0002a8c0: 655f 696e 5f62 7563 6b65 7428 7374 6f72  e_in_bucket(stor
+0002a8d0: 655f 7479 7065 2c20 6275 636b 6574 5f6e  e_type, bucket_n
+0002a8e0: 616d 6529 3a0a 2020 2020 2020 2020 6966  ame):.        if
+0002a8f0: 2073 746f 7265 5f74 7970 6520 3d3d 2073   store_type == s
+0002a900: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+0002a910: 5479 7065 2e53 333a 0a20 2020 2020 2020  Type.S3:.       
+0002a920: 2020 2020 2072 6574 7572 6e20 6627 6177       return f'aw
+0002a930: 7320 7333 206c 7320 7333 3a2f 2f7b 6275  s s3 ls s3://{bu
+0002a940: 636b 6574 5f6e 616d 657d 202d 2d72 6563  cket_name} --rec
+0002a950: 7572 7369 7665 207c 2077 6320 2d6c 270a  ursive | wc -l'.
+0002a960: 2020 2020 2020 2020 656c 6966 2073 746f          elif sto
+0002a970: 7265 5f74 7970 6520 3d3d 2073 746f 7261  re_type == stora
+0002a980: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0002a990: 2e47 4353 3a0a 2020 2020 2020 2020 2020  .GCS:.          
+0002a9a0: 2020 7265 7475 726e 2066 2767 7375 7469    return f'gsuti
+0002a9b0: 6c20 6c73 202d 7220 6773 3a2f 2f7b 6275  l ls -r gs://{bu
+0002a9c0: 636b 6574 5f6e 616d 657d 2f2a 2a20 7c20  cket_name}/** | 
+0002a9d0: 7763 202d 6c27 0a20 2020 2020 2020 2065  wc -l'.        e
+0002a9e0: 6c69 6620 7374 6f72 655f 7479 7065 203d  lif store_type =
+0002a9f0: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
+0002aa00: 6f72 6554 7970 652e 5232 3a0a 2020 2020  oreType.R2:.    
+0002aa10: 2020 2020 2020 2020 656e 6470 6f69 6e74          endpoint
+0002aa20: 5f75 726c 203d 2063 6c6f 7564 666c 6172  _url = cloudflar
+0002aa30: 652e 6372 6561 7465 5f65 6e64 706f 696e  e.create_endpoin
+0002aa40: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+0002aa50: 7265 7475 726e 2066 2741 5753 5f53 4841  return f'AWS_SHA
+0002aa60: 5245 445f 4352 4544 454e 5449 414c 535f  RED_CREDENTIALS_
+0002aa70: 4649 4c45 3d7b 636c 6f75 6466 6c61 7265  FILE={cloudflare
+0002aa80: 2e52 325f 4352 4544 454e 5449 414c 535f  .R2_CREDENTIALS_
+0002aa90: 5041 5448 7d20 6177 7320 7333 206c 7320  PATH} aws s3 ls 
+0002aaa0: 7333 3a2f 2f7b 6275 636b 6574 5f6e 616d  s3://{bucket_nam
+0002aab0: 657d 202d 2d72 6563 7572 7369 7665 202d  e} --recursive -
+0002aac0: 2d65 6e64 706f 696e 7420 7b65 6e64 706f  -endpoint {endpo
+0002aad0: 696e 745f 7572 6c7d 202d 2d70 726f 6669  int_url} --profi
+0002aae0: 6c65 3d72 3220 7c20 7763 202d 6c27 0a0a  le=r2 | wc -l'..
+0002aaf0: 2020 2020 4070 7974 6573 742e 6669 7874      @pytest.fixt
+0002ab00: 7572 650a 2020 2020 6465 6620 746d 705f  ure.    def tmp_
+0002ab10: 736f 7572 6365 2873 656c 662c 2074 6d70  source(self, tmp
+0002ab20: 5f70 6174 6829 3a0a 2020 2020 2020 2020  _path):.        
+0002ab30: 2320 4372 6561 7465 7320 6120 7465 6d70  # Creates a temp
+0002ab40: 6f72 6172 7920 6469 7265 6374 6f72 7920  orary directory 
+0002ab50: 7769 7468 2061 2066 696c 6520 696e 2069  with a file in i
+0002ab60: 740a 2020 2020 2020 2020 746d 705f 6469  t.        tmp_di
+0002ab70: 7220 3d20 746d 705f 7061 7468 202f 2027  r = tmp_path / '
+0002ab80: 746d 702d 736f 7572 6365 270a 2020 2020  tmp-source'.    
+0002ab90: 2020 2020 746d 705f 6469 722e 6d6b 6469      tmp_dir.mkdi
+0002aba0: 7228 290a 2020 2020 2020 2020 746d 705f  r().        tmp_
+0002abb0: 6669 6c65 203d 2074 6d70 5f64 6972 202f  file = tmp_dir /
+0002abc0: 2027 746d 702d 6669 6c65 270a 2020 2020   'tmp-file'.    
+0002abd0: 2020 2020 746d 705f 6669 6c65 2e77 7269      tmp_file.wri
+0002abe0: 7465 5f74 6578 7428 2774 6573 7427 290a  te_text('test').
+0002abf0: 2020 2020 2020 2020 6369 7263 6c65 5f6c          circle_l
+0002ac00: 696e 6b20 3d20 746d 705f 6469 7220 2f20  ink = tmp_dir / 
+0002ac10: 2763 6972 636c 652d 6c69 6e6b 270a 2020  'circle-link'.  
+0002ac20: 2020 2020 2020 6369 7263 6c65 5f6c 696e        circle_lin
+0002ac30: 6b2e 7379 6d6c 696e 6b5f 746f 2874 6d70  k.symlink_to(tmp
+0002ac40: 5f64 6972 2c20 7461 7267 6574 5f69 735f  _dir, target_is_
+0002ac50: 6469 7265 6374 6f72 793d 5472 7565 290a  directory=True).
+0002ac60: 2020 2020 2020 2020 7969 656c 6420 7374          yield st
+0002ac70: 7228 746d 705f 6469 7229 0a0a 2020 2020  r(tmp_dir)..    
+0002ac80: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
+0002ac90: 2020 6465 6620 6765 6e65 7261 7465 5f62    def generate_b
+0002aca0: 7563 6b65 745f 6e61 6d65 2829 3a0a 2020  ucket_name():.  
+0002acb0: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
+0002acc0: 6120 7465 6d70 6f72 6172 7920 6275 636b  a temporary buck
+0002acd0: 6574 206e 616d 650a 2020 2020 2020 2020  et name.        
+0002ace0: 2320 7469 6d65 2e74 696d 6528 2920 7265  # time.time() re
+0002acf0: 7475 726e 7320 7661 7279 696e 6720 7072  turns varying pr
+0002ad00: 6563 6973 696f 6e20 6f6e 2064 6966 6665  ecision on diffe
+0002ad10: 7265 6e74 2073 7973 7465 6d73 2c20 736f  rent systems, so
+0002ad20: 2077 650a 2020 2020 2020 2020 2320 7265   we.        # re
+0002ad30: 706c 6163 6520 7468 6520 6465 6369 6d61  place the decima
+0002ad40: 6c20 706f 696e 7420 616e 6420 7573 6520  l point and use 
+0002ad50: 7768 6174 6576 6572 2070 7265 6369 7369  whatever precisi
+0002ad60: 6f6e 2077 6520 6361 6e20 6765 742e 0a20  on we can get.. 
+0002ad70: 2020 2020 2020 2074 696d 6573 7461 6d70         timestamp
+0002ad80: 203d 2073 7472 2874 696d 652e 7469 6d65   = str(time.time
+0002ad90: 2829 292e 7265 706c 6163 6528 272e 272c  ()).replace('.',
+0002ada0: 2027 2729 0a20 2020 2020 2020 2072 6574   '').        ret
+0002adb0: 7572 6e20 6627 736b 792d 7465 7374 2d7b  urn f'sky-test-{
+0002adc0: 7469 6d65 7374 616d 707d 270a 0a20 2020  timestamp}'..   
+0002add0: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
+0002ade0: 0a20 2020 2064 6566 2074 6d70 5f62 7563  .    def tmp_buc
+0002adf0: 6b65 745f 6e61 6d65 2873 656c 6629 3a0a  ket_name(self):.
+0002ae00: 2020 2020 2020 2020 7969 656c 6420 7365          yield se
+0002ae10: 6c66 2e67 656e 6572 6174 655f 6275 636b  lf.generate_buck
+0002ae20: 6574 5f6e 616d 6528 290a 0a20 2020 2040  et_name()..    @
+0002ae30: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
+0002ae40: 2064 6566 2079 6965 6c64 5f73 746f 7261   def yield_stora
+0002ae50: 6765 5f6f 626a 6563 7428 0a20 2020 2020  ge_object(.     
+0002ae60: 2020 2020 2020 206e 616d 653a 204f 7074         name: Opt
+0002ae70: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
+0002ae80: 652c 0a20 2020 2020 2020 2020 2020 2073  e,.            s
+0002ae90: 6f75 7263 653a 204f 7074 696f 6e61 6c5b  ource: Optional[
+0002aea0: 7374 6f72 6167 655f 6c69 622e 5061 7468  storage_lib.Path
+0002aeb0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0002aec0: 2020 2020 2020 7374 6f72 6573 3a20 4f70        stores: Op
+0002aed0: 7469 6f6e 616c 5b44 6963 745b 7374 6f72  tional[Dict[stor
+0002aee0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0002aef0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0002af00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002af10: 2020 2020 2073 746f 7261 6765 5f6c 6962       storage_lib
+0002af20: 2e41 6273 7472 6163 7453 746f 7265 5d5d  .AbstractStore]]
+0002af30: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+0002af40: 2020 2020 2070 6572 7369 7374 656e 743a       persistent:
+0002af50: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
+0002af60: 3d20 5472 7565 2c0a 2020 2020 2020 2020  = True,.        
+0002af70: 2020 2020 6d6f 6465 3a20 7374 6f72 6167      mode: storag
+0002af80: 655f 6c69 622e 5374 6f72 6167 654d 6f64  e_lib.StorageMod
+0002af90: 6520 3d20 7374 6f72 6167 655f 6c69 622e  e = storage_lib.
+0002afa0: 5374 6f72 6167 654d 6f64 652e 4d4f 554e  StorageMode.MOUN
+0002afb0: 5429 3a0a 2020 2020 2020 2020 2320 4372  T):.        # Cr
+0002afc0: 6561 7465 7320 6120 7465 6d70 6f72 6172  eates a temporar
+0002afd0: 7920 7374 6f72 6167 6520 6f62 6a65 6374  y storage object
+0002afe0: 2e20 5374 6f72 6573 206d 7573 7420 6265  . Stores must be
+0002aff0: 2061 6464 6564 2069 6e20 7468 6520 7465   added in the te
+0002b000: 7374 2e0a 2020 2020 2020 2020 7374 6f72  st..        stor
+0002b010: 6167 655f 6f62 6a20 3d20 7374 6f72 6167  age_obj = storag
+0002b020: 655f 6c69 622e 5374 6f72 6167 6528 6e61  e_lib.Storage(na
+0002b030: 6d65 3d6e 616d 652c 0a20 2020 2020 2020  me=name,.       
+0002b040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b060: 2020 2073 6f75 7263 653d 736f 7572 6365     source=source
+0002b070: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002b080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b090: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+0002b0a0: 6573 3d73 746f 7265 732c 0a20 2020 2020  es=stores,.     
 0002b0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b0c0: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
-0002b0d0: 746d 705f 736f 7572 6365 290a 0a20 2020  tmp_source)..   
-0002b0e0: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
-0002b0f0: 0a20 2020 2064 6566 2074 6d70 5f6c 6f63  .    def tmp_loc
-0002b100: 616c 5f6c 6973 745f 7374 6f72 6167 655f  al_list_storage_
-0002b110: 6f62 6a28 7365 6c66 2c20 746d 705f 6275  obj(self, tmp_bu
-0002b120: 636b 6574 5f6e 616d 652c 2074 6d70 5f73  cket_name, tmp_s
-0002b130: 6f75 7263 6529 3a0a 2020 2020 2020 2020  ource):.        
-0002b140: 2320 4372 6561 7465 7320 6120 7465 6d70  # Creates a temp
-0002b150: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
-0002b160: 7768 6963 6820 7573 6573 2061 206c 6973  which uses a lis
-0002b170: 7420 6f66 2070 6174 6873 2061 7320 736f  t of paths as so
-0002b180: 7572 6365 2e0a 2020 2020 2020 2020 2320  urce..        # 
-0002b190: 5374 6f72 6573 206d 7573 7420 6265 2061  Stores must be a
-0002b1a0: 6464 6564 2069 6e20 7468 6520 7465 7374  dded in the test
-0002b1b0: 2e20 4166 7465 7220 7570 6c6f 6164 2c20  . After upload, 
-0002b1c0: 7468 6520 6275 636b 6574 2073 686f 756c  the bucket shoul
-0002b1d0: 640a 2020 2020 2020 2020 2320 6861 7665  d.        # have
-0002b1e0: 2074 776f 2066 696c 6573 202d 202f 746d   two files - /tm
-0002b1f0: 702d 6669 6c65 2061 6e64 202f 746d 702d  p-file and /tmp-
-0002b200: 736f 7572 6365 2f74 6d70 2d66 696c 650a  source/tmp-file.
-0002b210: 2020 2020 2020 2020 6c69 7374 5f73 6f75          list_sou
-0002b220: 7263 6520 3d20 5b74 6d70 5f73 6f75 7263  rce = [tmp_sourc
-0002b230: 652c 2074 6d70 5f73 6f75 7263 6520 2b20  e, tmp_source + 
-0002b240: 272f 746d 702d 6669 6c65 275d 0a20 2020  '/tmp-file'].   
-0002b250: 2020 2020 2079 6965 6c64 2066 726f 6d20       yield from 
-0002b260: 7365 6c66 2e79 6965 6c64 5f73 746f 7261  self.yield_stora
-0002b270: 6765 5f6f 626a 6563 7428 6e61 6d65 3d74  ge_object(name=t
-0002b280: 6d70 5f62 7563 6b65 745f 6e61 6d65 2c0a  mp_bucket_name,.
-0002b290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b2b0: 2020 2020 2020 2020 2020 2020 2073 6f75               sou
-0002b2c0: 7263 653d 6c69 7374 5f73 6f75 7263 6529  rce=list_source)
-0002b2d0: 0a0a 2020 2020 4070 7974 6573 742e 6669  ..    @pytest.fi
-0002b2e0: 7874 7572 650a 2020 2020 6465 6620 746d  xture.    def tm
-0002b2f0: 705f 6275 6c6b 5f64 656c 5f73 746f 7261  p_bulk_del_stora
-0002b300: 6765 5f6f 626a 2873 656c 662c 2074 6d70  ge_obj(self, tmp
-0002b310: 5f62 7563 6b65 745f 6e61 6d65 293a 0a20  _bucket_name):. 
-0002b320: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
-0002b330: 2061 2074 656d 706f 7261 7279 2073 746f   a temporary sto
-0002b340: 7261 6765 206f 626a 6563 7420 666f 7220  rage object for 
-0002b350: 7465 7374 696e 6720 6275 6c6b 2064 656c  testing bulk del
-0002b360: 6574 696f 6e2e 0a20 2020 2020 2020 2023  etion..        #
-0002b370: 2053 746f 7265 7320 6d75 7374 2062 6520   Stores must be 
-0002b380: 6164 6465 6420 696e 2074 6865 2074 6573  added in the tes
-0002b390: 742e 0a20 2020 2020 2020 2077 6974 6820  t..        with 
-0002b3a0: 7465 6d70 6669 6c65 2e54 656d 706f 7261  tempfile.Tempora
-0002b3b0: 7279 4469 7265 6374 6f72 7928 2920 6173  ryDirectory() as
-0002b3c0: 2074 6d70 6469 723a 0a20 2020 2020 2020   tmpdir:.       
-0002b3d0: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
-0002b3e0: 6368 6563 6b5f 6f75 7470 7574 2866 276d  check_output(f'm
-0002b3f0: 6b64 6972 202d 7020 7b74 6d70 6469 727d  kdir -p {tmpdir}
-0002b400: 2f66 6f6c 6465 727b 7b30 3030 2e2e 3235  /folder{{000..25
-0002b410: 357d 7d27 2c0a 2020 2020 2020 2020 2020  5}}',.          
-0002b420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b430: 2020 2020 2020 2020 2020 7368 656c 6c3d            shell=
-0002b440: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
-0002b450: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
-0002b460: 636b 5f6f 7574 7075 7428 6627 746f 7563  ck_output(f'touc
-0002b470: 6820 7b74 6d70 6469 727d 2f74 6573 747b  h {tmpdir}/test{
-0002b480: 7b30 3030 2e2e 3235 357d 7d2e 7478 7427  {000..255}}.txt'
-0002b490: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002b4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b4b0: 2020 2020 2020 7368 656c 6c3d 5472 7565        shell=True
-0002b4c0: 290a 2020 2020 2020 2020 2020 2020 7375  ).            su
-0002b4d0: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
-0002b4e0: 7574 7075 7428 0a20 2020 2020 2020 2020  utput(.         
-0002b4f0: 2020 2020 2020 2066 2774 6f75 6368 207b         f'touch {
-0002b500: 746d 7064 6972 7d2f 666f 6c64 6572 7b7b  tmpdir}/folder{{
-0002b510: 3030 302e 2e32 3535 7d7d 2f74 6573 742e  000..255}}/test.
-0002b520: 7478 7427 2c20 7368 656c 6c3d 5472 7565  txt', shell=True
-0002b530: 290a 2020 2020 2020 2020 2020 2020 7969  ).            yi
-0002b540: 656c 6420 6672 6f6d 2073 656c 662e 7969  eld from self.yi
-0002b550: 656c 645f 7374 6f72 6167 655f 6f62 6a65  eld_storage_obje
-0002b560: 6374 286e 616d 653d 746d 705f 6275 636b  ct(name=tmp_buck
-0002b570: 6574 5f6e 616d 652c 0a20 2020 2020 2020  et_name,.       
-0002b580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b5a0: 2020 2020 2020 2020 2020 736f 7572 6365            source
-0002b5b0: 3d74 6d70 6469 7229 0a0a 2020 2020 4070  =tmpdir)..    @p
-0002b5c0: 7974 6573 742e 6669 7874 7572 650a 2020  ytest.fixture.  
-0002b5d0: 2020 6465 6620 746d 705f 636f 7079 5f6d    def tmp_copy_m
-0002b5e0: 6e74 5f65 7869 7374 696e 675f 7374 6f72  nt_existing_stor
-0002b5f0: 6167 655f 6f62 6a28 7365 6c66 2c20 746d  age_obj(self, tm
-0002b600: 705f 7363 7261 7463 685f 7374 6f72 6167  p_scratch_storag
-0002b610: 655f 6f62 6a29 3a0a 2020 2020 2020 2020  e_obj):.        
-0002b620: 2320 4372 6561 7465 7320 6120 636f 7079  # Creates a copy
-0002b630: 206d 6f75 6e74 2073 746f 7261 6765 2077   mount storage w
-0002b640: 6869 6368 2072 6575 7365 7320 616e 2065  hich reuses an e
-0002b650: 7869 7374 696e 6720 7374 6f72 6167 6520  xisting storage 
-0002b660: 6f62 6a65 6374 2e0a 2020 2020 2020 2020  object..        
-0002b670: 746d 705f 7363 7261 7463 685f 7374 6f72  tmp_scratch_stor
-0002b680: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
-0002b690: 6528 7374 6f72 6167 655f 6c69 622e 5374  e(storage_lib.St
-0002b6a0: 6f72 6554 7970 652e 5333 290a 2020 2020  oreType.S3).    
-0002b6b0: 2020 2020 7374 6f72 6167 655f 6e61 6d65      storage_name
-0002b6c0: 203d 2074 6d70 5f73 6372 6174 6368 5f73   = tmp_scratch_s
-0002b6d0: 746f 7261 6765 5f6f 626a 2e6e 616d 650a  torage_obj.name.
-0002b6e0: 0a20 2020 2020 2020 2023 2054 7279 2074  .        # Try t
-0002b6f0: 6f20 696e 6974 6961 6c69 7a65 2061 6e6f  o initialize ano
-0002b700: 7468 6572 2073 746f 7261 6765 2077 6974  ther storage wit
-0002b710: 6820 7468 6520 7374 6f72 6167 6520 6f62  h the storage ob
-0002b720: 6a65 6374 2063 7265 6174 6564 0a20 2020  ject created.   
-0002b730: 2020 2020 2023 2061 626f 7665 2c20 6275       # above, bu
-0002b740: 7420 6e6f 7720 696e 2043 4f50 5920 6d6f  t now in COPY mo
-0002b750: 6465 2e20 5468 6973 2073 686f 756c 6420  de. This should 
-0002b760: 7375 6363 6565 642e 0a20 2020 2020 2020  succeed..       
-0002b770: 2079 6965 6c64 2066 726f 6d20 7365 6c66   yield from self
-0002b780: 2e79 6965 6c64 5f73 746f 7261 6765 5f6f  .yield_storage_o
-0002b790: 626a 6563 7428 6e61 6d65 3d73 746f 7261  bject(name=stora
-0002b7a0: 6765 5f6e 616d 652c 0a20 2020 2020 2020  ge_name,.       
-0002b7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b7d0: 2020 2020 2020 6d6f 6465 3d73 746f 7261        mode=stora
-0002b7e0: 6765 5f6c 6962 2e53 746f 7261 6765 4d6f  ge_lib.StorageMo
-0002b7f0: 6465 2e43 4f50 5929 0a0a 2020 2020 4070  de.COPY)..    @p
-0002b800: 7974 6573 742e 6669 7874 7572 650a 2020  ytest.fixture.  
-0002b810: 2020 6465 6620 746d 705f 6769 7469 676e    def tmp_gitign
-0002b820: 6f72 655f 7374 6f72 6167 655f 6f62 6a28  ore_storage_obj(
-0002b830: 7365 6c66 2c20 746d 705f 6275 636b 6574  self, tmp_bucket
-0002b840: 5f6e 616d 652c 2067 6974 6967 6e6f 7265  _name, gitignore
-0002b850: 5f73 7472 7563 7475 7265 293a 0a20 2020  _structure):.   
-0002b860: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
-0002b870: 2074 656d 706f 7261 7279 2073 746f 7261   temporary stora
-0002b880: 6765 206f 626a 6563 7420 666f 7220 7465  ge object for te
-0002b890: 7374 696e 6720 2e67 6974 6967 6e6f 7265  sting .gitignore
-0002b8a0: 2066 696c 7465 722e 0a20 2020 2020 2020   filter..       
-0002b8b0: 2023 2047 4954 4947 494e 4f52 455f 5354   # GITIGINORE_ST
-0002b8c0: 5255 4354 5552 4520 6973 2072 6570 7265  RUCTURE is repre
-0002b8d0: 7365 6e74 696e 6720 6120 6669 6c65 2073  senting a file s
-0002b8e0: 7472 7563 7475 7265 2069 6e20 6120 6469  tructure in a di
-0002b8f0: 6374 696f 6e61 7279 0a20 2020 2020 2020  ctionary.       
-0002b900: 2023 2066 6f72 6d61 742e 2043 7265 6174   # format. Creat
-0002b910: 6564 2073 746f 7261 6765 206f 626a 6563  ed storage objec
-0002b920: 7420 7769 6c6c 2063 6f6e 7461 696e 2074  t will contain t
-0002b930: 6865 2066 696c 6520 7374 7275 6374 7572  he file structur
-0002b940: 6520 616c 6f6e 670a 2020 2020 2020 2020  e along.        
-0002b950: 2320 7769 7468 202e 6769 7469 676e 6f72  # with .gitignor
-0002b960: 6520 616e 6420 2e67 6974 2f69 6e66 6f2f  e and .git/info/
-0002b970: 6578 636c 7564 6520 6669 6c65 7320 746f  exclude files to
-0002b980: 2074 6573 7420 6578 636c 7564 6520 6669   test exclude fi
-0002b990: 6c74 6572 2e0a 2020 2020 2020 2020 2320  lter..        # 
-0002b9a0: 5374 6f72 6573 206d 7573 7420 6265 2061  Stores must be a
-0002b9b0: 6464 6564 2069 6e20 7468 6520 7465 7374  dded in the test
-0002b9c0: 2e0a 2020 2020 2020 2020 7769 7468 2074  ..        with t
-0002b9d0: 656d 7066 696c 652e 5465 6d70 6f72 6172  empfile.Temporar
-0002b9e0: 7944 6972 6563 746f 7279 2829 2061 7320  yDirectory() as 
-0002b9f0: 746d 7064 6972 3a0a 2020 2020 2020 2020  tmpdir:.        
-0002ba00: 2020 2020 2320 4372 6561 7465 7320 6669      # Creates fi
-0002ba10: 6c65 2073 7472 7563 7475 7265 2074 6f20  le structure to 
-0002ba20: 6265 2075 706c 6f61 6465 6420 696e 2074  be uploaded in t
-0002ba30: 6865 2053 746f 7261 6765 0a20 2020 2020  he Storage.     
-0002ba40: 2020 2020 2020 2073 656c 662e 6372 6561         self.crea
-0002ba50: 7465 5f64 6972 5f73 7472 7563 7475 7265  te_dir_structure
-0002ba60: 2874 6d70 6469 722c 2067 6974 6967 6e6f  (tmpdir, gitigno
-0002ba70: 7265 5f73 7472 7563 7475 7265 290a 0a20  re_structure).. 
-0002ba80: 2020 2020 2020 2020 2020 2023 2043 7265             # Cre
-0002ba90: 6174 6520 2e67 6974 6967 6e6f 7265 2061  ate .gitignore a
-0002baa0: 6e64 206c 6973 7420 6669 6c65 732f 6469  nd list files/di
-0002bab0: 7273 2074 6f20 6265 2065 7863 6c75 6465  rs to be exclude
-0002bac0: 6420 696e 2069 740a 2020 2020 2020 2020  d in it.        
-0002bad0: 2020 2020 736b 7970 696c 6f74 5f70 6174      skypilot_pat
-0002bae0: 6820 3d20 6f73 2e70 6174 682e 6469 726e  h = os.path.dirn
-0002baf0: 616d 6528 6f73 2e70 6174 682e 6469 726e  ame(os.path.dirn
-0002bb00: 616d 6528 736b 792e 5f5f 6669 6c65 5f5f  ame(sky.__file__
-0002bb10: 2929 0a20 2020 2020 2020 2020 2020 2074  )).            t
-0002bb20: 656d 705f 7061 7468 203d 2066 277b 746d  emp_path = f'{tm
-0002bb30: 7064 6972 7d2f 2e67 6974 6967 6e6f 7265  pdir}/.gitignore
-0002bb40: 270a 2020 2020 2020 2020 2020 2020 6669  '.            fi
-0002bb50: 6c65 5f70 6174 6820 3d20 6f73 2e70 6174  le_path = os.pat
-0002bb60: 682e 6a6f 696e 2873 6b79 7069 6c6f 745f  h.join(skypilot_
-0002bb70: 7061 7468 2c20 2774 6573 7473 2f67 6974  path, 'tests/git
-0002bb80: 6967 6e6f 7265 5f74 6573 7427 290a 2020  ignore_test').  
-0002bb90: 2020 2020 2020 2020 2020 7368 7574 696c            shutil
-0002bba0: 2e63 6f70 7966 696c 6528 6669 6c65 5f70  .copyfile(file_p
-0002bbb0: 6174 682c 2074 656d 705f 7061 7468 290a  ath, temp_path).
-0002bbc0: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
-0002bbd0: 7265 6174 6520 2e67 6974 2f69 6e66 6f2f  reate .git/info/
-0002bbe0: 6578 636c 7564 6520 616e 6420 6c69 7374  exclude and list
-0002bbf0: 2066 696c 6573 2f64 6972 7320 746f 2062   files/dirs to b
-0002bc00: 6520 6578 636c 7564 6564 2069 6e20 6974  e excluded in it
-0002bc10: 0a20 2020 2020 2020 2020 2020 2074 656d  .            tem
-0002bc20: 705f 7061 7468 203d 2066 277b 746d 7064  p_path = f'{tmpd
-0002bc30: 6972 7d2f 2e67 6974 2f69 6e66 6f2f 270a  ir}/.git/info/'.
-0002bc40: 2020 2020 2020 2020 2020 2020 6f73 2e6d              os.m
-0002bc50: 616b 6564 6972 7328 7465 6d70 5f70 6174  akedirs(temp_pat
-0002bc60: 6829 0a20 2020 2020 2020 2020 2020 2074  h).            t
-0002bc70: 656d 705f 6578 636c 7564 655f 7061 7468  emp_exclude_path
-0002bc80: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
-0002bc90: 7465 6d70 5f70 6174 682c 2027 6578 636c  temp_path, 'excl
-0002bca0: 7564 6527 290a 2020 2020 2020 2020 2020  ude').          
-0002bcb0: 2020 6669 6c65 5f70 6174 6820 3d20 6f73    file_path = os
-0002bcc0: 2e70 6174 682e 6a6f 696e 2873 6b79 7069  .path.join(skypi
-0002bcd0: 6c6f 745f 7061 7468 2c0a 2020 2020 2020  lot_path,.      
-0002bce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bcf0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0002bd00: 7465 7374 732f 6769 745f 696e 666f 5f65  tests/git_info_e
-0002bd10: 7863 6c75 6465 5f74 6573 7427 290a 2020  xclude_test').  
-0002bd20: 2020 2020 2020 2020 2020 7368 7574 696c            shutil
-0002bd30: 2e63 6f70 7966 696c 6528 6669 6c65 5f70  .copyfile(file_p
-0002bd40: 6174 682c 2074 656d 705f 6578 636c 7564  ath, temp_exclud
-0002bd50: 655f 7061 7468 290a 0a20 2020 2020 2020  e_path)..       
-0002bd60: 2020 2020 2023 2043 7265 6174 6520 736b       # Create sk
-0002bd70: 7920 5374 6f72 6167 6520 7769 7468 2074  y Storage with t
-0002bd80: 6865 2066 696c 6573 2063 7265 6174 6564  he files created
-0002bd90: 0a20 2020 2020 2020 2020 2020 2079 6965  .            yie
-0002bda0: 6c64 2066 726f 6d20 7365 6c66 2e79 6965  ld from self.yie
-0002bdb0: 6c64 5f73 746f 7261 6765 5f6f 626a 6563  ld_storage_objec
-0002bdc0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-0002bdd0: 2020 206e 616d 653d 746d 705f 6275 636b     name=tmp_buck
-0002bde0: 6574 5f6e 616d 652c 0a20 2020 2020 2020  et_name,.       
-0002bdf0: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
-0002be00: 746d 7064 6972 2c0a 2020 2020 2020 2020  tmpdir,.        
-0002be10: 2020 2020 2020 2020 6d6f 6465 3d73 746f          mode=sto
-0002be20: 7261 6765 5f6c 6962 2e53 746f 7261 6765  rage_lib.Storage
-0002be30: 4d6f 6465 2e43 4f50 5929 0a0a 2020 2020  Mode.COPY)..    
-0002be40: 4070 7974 6573 742e 6669 7874 7572 650a  @pytest.fixture.
-0002be50: 2020 2020 6465 6620 746d 705f 6177 7363      def tmp_awsc
-0002be60: 6c69 5f62 7563 6b65 7428 7365 6c66 2c20  li_bucket(self, 
-0002be70: 746d 705f 6275 636b 6574 5f6e 616d 6529  tmp_bucket_name)
-0002be80: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
-0002be90: 7465 7320 6120 7465 6d70 6f72 6172 7920  tes a temporary 
-0002bea0: 6275 636b 6574 2075 7369 6e67 2061 7773  bucket using aws
-0002beb0: 636c 690a 2020 2020 2020 2020 6275 636b  cli.        buck
-0002bec0: 6574 5f75 7269 203d 2066 2773 333a 2f2f  et_uri = f's3://
-0002bed0: 7b74 6d70 5f62 7563 6b65 745f 6e61 6d65  {tmp_bucket_name
-0002bee0: 7d27 0a20 2020 2020 2020 2073 7562 7072  }'.        subpr
-0002bef0: 6f63 6573 732e 6368 6563 6b5f 6361 6c6c  ocess.check_call
-0002bf00: 285b 2761 7773 272c 2027 7333 272c 2027  (['aws', 's3', '
-0002bf10: 6d62 272c 2062 7563 6b65 745f 7572 695d  mb', bucket_uri]
-0002bf20: 290a 2020 2020 2020 2020 7969 656c 6420  ).        yield 
-0002bf30: 746d 705f 6275 636b 6574 5f6e 616d 652c  tmp_bucket_name,
-0002bf40: 2062 7563 6b65 745f 7572 690a 2020 2020   bucket_uri.    
-0002bf50: 2020 2020 7375 6270 726f 6365 7373 2e63      subprocess.c
-0002bf60: 6865 636b 5f63 616c 6c28 5b27 6177 7327  heck_call(['aws'
-0002bf70: 2c20 2773 3327 2c20 2772 6227 2c20 6275  , 's3', 'rb', bu
-0002bf80: 636b 6574 5f75 7269 2c20 272d 2d66 6f72  cket_uri, '--for
-0002bf90: 6365 275d 290a 0a20 2020 2040 7079 7465  ce'])..    @pyte
-0002bfa0: 7374 2e66 6978 7475 7265 0a20 2020 2064  st.fixture.    d
-0002bfb0: 6566 2074 6d70 5f67 7375 7469 6c5f 6275  ef tmp_gsutil_bu
-0002bfc0: 636b 6574 2873 656c 662c 2074 6d70 5f62  cket(self, tmp_b
-0002bfd0: 7563 6b65 745f 6e61 6d65 293a 0a20 2020  ucket_name):.   
-0002bfe0: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
-0002bff0: 2074 656d 706f 7261 7279 2062 7563 6b65   temporary bucke
-0002c000: 7420 7573 696e 6720 6773 7574 696c 0a20  t using gsutil. 
-0002c010: 2020 2020 2020 2062 7563 6b65 745f 7572         bucket_ur
-0002c020: 6920 3d20 6627 6773 3a2f 2f7b 746d 705f  i = f'gs://{tmp_
-0002c030: 6275 636b 6574 5f6e 616d 657d 270a 2020  bucket_name}'.  
-0002c040: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
-0002c050: 2e63 6865 636b 5f63 616c 6c28 5b27 6773  .check_call(['gs
-0002c060: 7574 696c 272c 2027 6d62 272c 2062 7563  util', 'mb', buc
-0002c070: 6b65 745f 7572 695d 290a 2020 2020 2020  ket_uri]).      
-0002c080: 2020 7969 656c 6420 746d 705f 6275 636b    yield tmp_buck
-0002c090: 6574 5f6e 616d 652c 2062 7563 6b65 745f  et_name, bucket_
-0002c0a0: 7572 690a 2020 2020 2020 2020 7375 6270  uri.        subp
-0002c0b0: 726f 6365 7373 2e63 6865 636b 5f63 616c  rocess.check_cal
-0002c0c0: 6c28 5b27 6773 7574 696c 272c 2027 726d  l(['gsutil', 'rm
-0002c0d0: 272c 2027 2d72 272c 2062 7563 6b65 745f  ', '-r', bucket_
-0002c0e0: 7572 695d 290a 0a20 2020 2040 7079 7465  uri])..    @pyte
-0002c0f0: 7374 2e66 6978 7475 7265 0a20 2020 2064  st.fixture.    d
-0002c100: 6566 2074 6d70 5f61 7773 636c 695f 6275  ef tmp_awscli_bu
-0002c110: 636b 6574 5f72 3228 7365 6c66 2c20 746d  cket_r2(self, tm
-0002c120: 705f 6275 636b 6574 5f6e 616d 6529 3a0a  p_bucket_name):.
-0002c130: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
-0002c140: 7320 6120 7465 6d70 6f72 6172 7920 6275  s a temporary bu
-0002c150: 636b 6574 2075 7369 6e67 2061 7773 636c  cket using awscl
-0002c160: 690a 2020 2020 2020 2020 656e 6470 6f69  i.        endpoi
-0002c170: 6e74 5f75 726c 203d 2063 6c6f 7564 666c  nt_url = cloudfl
-0002c180: 6172 652e 6372 6561 7465 5f65 6e64 706f  are.create_endpo
-0002c190: 696e 7428 290a 2020 2020 2020 2020 6275  int().        bu
-0002c1a0: 636b 6574 5f75 7269 203d 2066 2773 333a  cket_uri = f's3:
-0002c1b0: 2f2f 7b74 6d70 5f62 7563 6b65 745f 6e61  //{tmp_bucket_na
-0002c1c0: 6d65 7d27 0a20 2020 2020 2020 2073 7562  me}'.        sub
-0002c1d0: 7072 6f63 6573 732e 6368 6563 6b5f 6361  process.check_ca
-0002c1e0: 6c6c 280a 2020 2020 2020 2020 2020 2020  ll(.            
-0002c1f0: 6627 4157 535f 5348 4152 4544 5f43 5245  f'AWS_SHARED_CRE
-0002c200: 4445 4e54 4941 4c53 5f46 494c 453d 7b63  DENTIALS_FILE={c
-0002c210: 6c6f 7564 666c 6172 652e 5232 5f43 5245  loudflare.R2_CRE
-0002c220: 4445 4e54 4941 4c53 5f50 4154 487d 2061  DENTIALS_PATH} a
-0002c230: 7773 2073 3320 6d62 207b 6275 636b 6574  ws s3 mb {bucket
-0002c240: 5f75 7269 7d20 2d2d 656e 6470 6f69 6e74  _uri} --endpoint
-0002c250: 207b 656e 6470 6f69 6e74 5f75 726c 7d20   {endpoint_url} 
-0002c260: 2d2d 7072 6f66 696c 653d 7232 272c 0a20  --profile=r2',. 
-0002c270: 2020 2020 2020 2020 2020 2073 6865 6c6c             shell
-0002c280: 3d54 7275 6529 0a20 2020 2020 2020 2079  =True).        y
-0002c290: 6965 6c64 2074 6d70 5f62 7563 6b65 745f  ield tmp_bucket_
-0002c2a0: 6e61 6d65 2c20 6275 636b 6574 5f75 7269  name, bucket_uri
-0002c2b0: 0a20 2020 2020 2020 2073 7562 7072 6f63  .        subproc
-0002c2c0: 6573 732e 6368 6563 6b5f 6361 6c6c 280a  ess.check_call(.
-0002c2d0: 2020 2020 2020 2020 2020 2020 6627 4157              f'AW
-0002c2e0: 535f 5348 4152 4544 5f43 5245 4445 4e54  S_SHARED_CREDENT
-0002c2f0: 4941 4c53 5f46 494c 453d 7b63 6c6f 7564  IALS_FILE={cloud
-0002c300: 666c 6172 652e 5232 5f43 5245 4445 4e54  flare.R2_CREDENT
-0002c310: 4941 4c53 5f50 4154 487d 2061 7773 2073  IALS_PATH} aws s
-0002c320: 3320 7262 207b 6275 636b 6574 5f75 7269  3 rb {bucket_uri
-0002c330: 7d20 2d2d 666f 7263 6520 2d2d 656e 6470  } --force --endp
-0002c340: 6f69 6e74 207b 656e 6470 6f69 6e74 5f75  oint {endpoint_u
-0002c350: 726c 7d20 2d2d 7072 6f66 696c 653d 7232  rl} --profile=r2
-0002c360: 272c 0a20 2020 2020 2020 2020 2020 2073  ',.            s
-0002c370: 6865 6c6c 3d54 7275 6529 0a0a 2020 2020  hell=True)..    
-0002c380: 4070 7974 6573 742e 6669 7874 7572 650a  @pytest.fixture.
-0002c390: 2020 2020 6465 6620 746d 705f 6962 6d5f      def tmp_ibm_
-0002c3a0: 636f 735f 6275 636b 6574 2873 656c 662c  cos_bucket(self,
-0002c3b0: 2074 6d70 5f62 7563 6b65 745f 6e61 6d65   tmp_bucket_name
-0002c3c0: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
-0002c3d0: 6174 6573 2061 2074 656d 706f 7261 7279  ates a temporary
-0002c3e0: 2062 7563 6b65 7420 7573 696e 6720 4942   bucket using IB
-0002c3f0: 4d20 434f 5320 4150 490a 2020 2020 2020  M COS API.      
-0002c400: 2020 7374 6f72 6167 655f 6f62 6a20 3d20    storage_obj = 
-0002c410: 7374 6f72 6167 655f 6c69 622e 4942 4d43  storage_lib.IBMC
-0002c420: 6f73 5374 6f72 6528 736f 7572 6365 3d22  osStore(source="
-0002c430: 222c 206e 616d 653d 746d 705f 6275 636b  ", name=tmp_buck
-0002c440: 6574 5f6e 616d 6529 0a20 2020 2020 2020  et_name).       
-0002c450: 2079 6965 6c64 2074 6d70 5f62 7563 6b65   yield tmp_bucke
-0002c460: 745f 6e61 6d65 0a20 2020 2020 2020 2073  t_name.        s
-0002c470: 746f 7261 6765 5f6f 626a 2e64 656c 6574  torage_obj.delet
-0002c480: 6528 290a 0a20 2020 2040 7079 7465 7374  e()..    @pytest
-0002c490: 2e66 6978 7475 7265 0a20 2020 2064 6566  .fixture.    def
-0002c4a0: 2074 6d70 5f70 7562 6c69 635f 7374 6f72   tmp_public_stor
-0002c4b0: 6167 655f 6f62 6a28 7365 6c66 2c20 7265  age_obj(self, re
-0002c4c0: 7175 6573 7429 3a0a 2020 2020 2020 2020  quest):.        
-0002c4d0: 2320 496e 6974 6961 6c69 7a65 7320 6120  # Initializes a 
-0002c4e0: 7374 6f72 6167 6520 6f62 6a65 6374 2077  storage object w
-0002c4f0: 6974 6820 6120 7075 626c 6963 2062 7563  ith a public buc
-0002c500: 6b65 740a 2020 2020 2020 2020 7374 6f72  ket.        stor
-0002c510: 6167 655f 6f62 6a20 3d20 7374 6f72 6167  age_obj = storag
-0002c520: 655f 6c69 622e 5374 6f72 6167 6528 736f  e_lib.Storage(so
-0002c530: 7572 6365 3d72 6571 7565 7374 2e70 6172  urce=request.par
-0002c540: 616d 290a 2020 2020 2020 2020 7969 656c  am).        yiel
-0002c550: 6420 7374 6f72 6167 655f 6f62 6a0a 2020  d storage_obj.  
-0002c560: 2020 2020 2020 2320 5468 6973 2064 6f65        # This doe
-0002c570: 7320 6e6f 7420 7265 7175 6972 6520 616e  s not require an
-0002c580: 7920 6465 6c65 7469 6f6e 206c 6f67 6963  y deletion logic
-0002c590: 2062 6563 6175 7365 2069 7420 6973 2061   because it is a
-0002c5a0: 2070 7562 6c69 6320 6275 636b 6574 0a20   public bucket. 
-0002c5b0: 2020 2020 2020 2023 2061 6e64 2073 686f         # and sho
-0002c5c0: 756c 6420 6e6f 7420 6765 7420 6164 6465  uld not get adde
-0002c5d0: 6420 746f 2067 6c6f 6261 6c5f 7573 6572  d to global_user
-0002c5e0: 5f73 7461 7465 2e0a 0a20 2020 2040 7079  _state...    @py
-0002c5f0: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
-0002c600: 6964 7374 6163 6b0a 2020 2020 4070 7974  idstack.    @pyt
-0002c610: 6573 742e 6d61 726b 2e70 6172 616d 6574  est.mark.paramet
-0002c620: 7269 7a65 2827 7374 6f72 655f 7479 7065  rize('store_type
-0002c630: 272c 205b 0a20 2020 2020 2020 2073 746f  ', [.        sto
-0002c640: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-0002c650: 7065 2e53 332c 2073 746f 7261 6765 5f6c  pe.S3, storage_l
-0002c660: 6962 2e53 746f 7265 5479 7065 2e47 4353  ib.StoreType.GCS
-0002c670: 2c0a 2020 2020 2020 2020 7079 7465 7374  ,.        pytest
-0002c680: 2e70 6172 616d 2873 746f 7261 6765 5f6c  .param(storage_l
-0002c690: 6962 2e53 746f 7265 5479 7065 2e49 424d  ib.StoreType.IBM
-0002c6a0: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
-0002c6b0: 6172 6b2e 6962 6d29 2c0a 2020 2020 2020  ark.ibm),.      
-0002c6c0: 2020 7079 7465 7374 2e70 6172 616d 2873    pytest.param(s
-0002c6d0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-0002c6e0: 5479 7065 2e52 322c 206d 6172 6b73 3d70  Type.R2, marks=p
-0002c6f0: 7974 6573 742e 6d61 726b 2e63 6c6f 7564  ytest.mark.cloud
-0002c700: 666c 6172 6529 0a20 2020 205d 290a 2020  flare).    ]).  
-0002c710: 2020 6465 6620 7465 7374 5f6e 6577 5f62    def test_new_b
-0002c720: 7563 6b65 745f 6372 6561 7469 6f6e 5f61  ucket_creation_a
-0002c730: 6e64 5f64 656c 6574 696f 6e28 7365 6c66  nd_deletion(self
-0002c740: 2c20 746d 705f 6c6f 6361 6c5f 7374 6f72  , tmp_local_stor
-0002c750: 6167 655f 6f62 6a2c 0a20 2020 2020 2020  age_obj,.       
-0002c760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c780: 2020 2020 2020 2073 746f 7265 5f74 7970         store_typ
-0002c790: 6529 3a0a 2020 2020 2020 2020 2320 4372  e):.        # Cr
-0002c7a0: 6561 7465 7320 6120 6e65 7720 6275 636b  eates a new buck
-0002c7b0: 6574 2077 6974 6820 6120 6c6f 6361 6c20  et with a local 
-0002c7c0: 736f 7572 6365 2c20 7570 6c6f 6164 7320  source, uploads 
-0002c7d0: 6669 6c65 7320 746f 2069 740a 2020 2020  files to it.    
-0002c7e0: 2020 2020 2320 616e 6420 6465 6c65 7465      # and delete
-0002c7f0: 7320 6974 2e0a 2020 2020 2020 2020 746d  s it..        tm
-0002c800: 705f 6c6f 6361 6c5f 7374 6f72 6167 655f  p_local_storage_
-0002c810: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
-0002c820: 6f72 655f 7479 7065 290a 0a20 2020 2020  ore_type)..     
-0002c830: 2020 2023 2052 756e 2073 6b79 2073 746f     # Run sky sto
-0002c840: 7261 6765 206c 7320 746f 2063 6865 636b  rage ls to check
-0002c850: 2069 6620 7374 6f72 6167 6520 6f62 6a65   if storage obje
-0002c860: 6374 2065 7869 7374 7320 696e 2074 6865  ct exists in the
-0002c870: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
-0002c880: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
-0002c890: 2e63 6865 636b 5f6f 7574 7075 7428 5b27  .check_output(['
-0002c8a0: 736b 7927 2c20 2773 746f 7261 6765 272c  sky', 'storage',
-0002c8b0: 2027 6c73 275d 290a 2020 2020 2020 2020   'ls']).        
-0002c8c0: 6173 7365 7274 2074 6d70 5f6c 6f63 616c  assert tmp_local
-0002c8d0: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
-0002c8e0: 6520 696e 206f 7574 2e64 6563 6f64 6528  e in out.decode(
-0002c8f0: 2775 7466 2d38 2729 0a0a 2020 2020 2020  'utf-8')..      
-0002c900: 2020 2320 5275 6e20 736b 7920 7374 6f72    # Run sky stor
-0002c910: 6167 6520 6465 6c65 7465 2074 6f20 6465  age delete to de
-0002c920: 6c65 7465 2074 6865 2073 746f 7261 6765  lete the storage
-0002c930: 206f 626a 6563 740a 2020 2020 2020 2020   object.        
-0002c940: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
-0002c950: 5f6f 7574 7075 7428 0a20 2020 2020 2020  _output(.       
-0002c960: 2020 2020 205b 2773 6b79 272c 2027 7374       ['sky', 'st
-0002c970: 6f72 6167 6527 2c20 2764 656c 6574 6527  orage', 'delete'
-0002c980: 2c20 746d 705f 6c6f 6361 6c5f 7374 6f72  , tmp_local_stor
-0002c990: 6167 655f 6f62 6a2e 6e61 6d65 2c20 272d  age_obj.name, '-
-0002c9a0: 2d79 6573 275d 290a 0a20 2020 2020 2020  -yes'])..       
-0002c9b0: 2023 2052 756e 2073 6b79 2073 746f 7261   # Run sky stora
-0002c9c0: 6765 206c 7320 746f 2063 6865 636b 2069  ge ls to check i
-0002c9d0: 6620 7374 6f72 6167 6520 6f62 6a65 6374  f storage object
-0002c9e0: 2069 7320 6465 6c65 7465 640a 2020 2020   is deleted.    
-0002c9f0: 2020 2020 6f75 7420 3d20 7375 6270 726f      out = subpro
-0002ca00: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
-0002ca10: 7428 5b27 736b 7927 2c20 2773 746f 7261  t(['sky', 'stora
-0002ca20: 6765 272c 2027 6c73 275d 290a 2020 2020  ge', 'ls']).    
-0002ca30: 2020 2020 6173 7365 7274 2074 6d70 5f6c      assert tmp_l
-0002ca40: 6f63 616c 5f73 746f 7261 6765 5f6f 626a  ocal_storage_obj
-0002ca50: 2e6e 616d 6520 6e6f 7420 696e 206f 7574  .name not in out
-0002ca60: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-0002ca70: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
-0002ca80: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
-0002ca90: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0002caa0: 6b2e 7864 6973 745f 6772 6f75 7028 276d  k.xdist_group('m
-0002cab0: 756c 7469 706c 655f 6275 636b 6574 5f64  ultiple_bucket_d
-0002cac0: 656c 6574 696f 6e27 290a 2020 2020 4070  eletion').    @p
-0002cad0: 7974 6573 742e 6d61 726b 2e70 6172 616d  ytest.mark.param
-0002cae0: 6574 7269 7a65 2827 7374 6f72 655f 7479  etrize('store_ty
-0002caf0: 7065 272c 205b 0a20 2020 2020 2020 2073  pe', [.        s
-0002cb00: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-0002cb10: 5479 7065 2e53 332c 2073 746f 7261 6765  Type.S3, storage
-0002cb20: 5f6c 6962 2e53 746f 7265 5479 7065 2e47  _lib.StoreType.G
-0002cb30: 4353 2c0a 2020 2020 2020 2020 7079 7465  CS,.        pyte
-0002cb40: 7374 2e70 6172 616d 2873 746f 7261 6765  st.param(storage
-0002cb50: 5f6c 6962 2e53 746f 7265 5479 7065 2e52  _lib.StoreType.R
-0002cb60: 322c 206d 6172 6b73 3d70 7974 6573 742e  2, marks=pytest.
-0002cb70: 6d61 726b 2e63 6c6f 7564 666c 6172 6529  mark.cloudflare)
-0002cb80: 2c0a 2020 2020 2020 2020 7079 7465 7374  ,.        pytest
-0002cb90: 2e70 6172 616d 2873 746f 7261 6765 5f6c  .param(storage_l
-0002cba0: 6962 2e53 746f 7265 5479 7065 2e49 424d  ib.StoreType.IBM
-0002cbb0: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
-0002cbc0: 6172 6b2e 6962 6d29 0a20 2020 205d 290a  ark.ibm).    ]).
-0002cbd0: 2020 2020 6465 6620 7465 7374 5f6d 756c      def test_mul
-0002cbe0: 7469 706c 655f 6275 636b 6574 735f 6372  tiple_buckets_cr
-0002cbf0: 6561 7469 6f6e 5f61 6e64 5f64 656c 6574  eation_and_delet
-0002cc00: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
-0002cc10: 2073 656c 662c 2074 6d70 5f6d 756c 7469   self, tmp_multi
-0002cc20: 706c 655f 7363 7261 7463 685f 7374 6f72  ple_scratch_stor
-0002cc30: 6167 655f 6f62 6a2c 2073 746f 7265 5f74  age_obj, store_t
-0002cc40: 7970 6529 3a0a 2020 2020 2020 2020 2320  ype):.        # 
-0002cc50: 4372 6561 7465 7320 6d75 6c74 6970 6c65  Creates multiple
-0002cc60: 206e 6577 2062 7563 6b65 7473 2835 2062   new buckets(5 b
-0002cc70: 7563 6b65 7473 2920 7769 7468 2061 206c  uckets) with a l
-0002cc80: 6f63 616c 2073 6f75 7263 650a 2020 2020  ocal source.    
-0002cc90: 2020 2020 2320 616e 6420 6465 6c65 7465      # and delete
-0002cca0: 7320 7468 656d 2e0a 2020 2020 2020 2020  s them..        
-0002ccb0: 7374 6f72 6167 655f 6f62 6a5f 6e61 6d65  storage_obj_name
-0002ccc0: 203d 205b 5d0a 2020 2020 2020 2020 666f   = [].        fo
-0002ccd0: 7220 7374 6f72 655f 6f62 6a20 696e 2074  r store_obj in t
-0002cce0: 6d70 5f6d 756c 7469 706c 655f 7363 7261  mp_multiple_scra
-0002ccf0: 7463 685f 7374 6f72 6167 655f 6f62 6a3a  tch_storage_obj:
-0002cd00: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
-0002cd10: 7265 5f6f 626a 2e61 6464 5f73 746f 7265  re_obj.add_store
-0002cd20: 2873 746f 7265 5f74 7970 6529 0a20 2020  (store_type).   
-0002cd30: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-0002cd40: 5f6f 626a 5f6e 616d 652e 6170 7065 6e64  _obj_name.append
-0002cd50: 2873 746f 7265 5f6f 626a 2e6e 616d 6529  (store_obj.name)
-0002cd60: 0a0a 2020 2020 2020 2020 2320 5275 6e20  ..        # Run 
-0002cd70: 736b 7920 7374 6f72 6167 6520 6c73 2074  sky storage ls t
-0002cd80: 6f20 6368 6563 6b20 6966 2061 6c6c 2073  o check if all s
-0002cd90: 746f 7261 6765 206f 626a 6563 7473 2065  torage objects e
-0002cda0: 7869 7374 7320 696e 2074 6865 0a20 2020  xists in the.   
-0002cdb0: 2020 2020 2023 206f 7574 7075 7420 6669       # output fi
-0002cdc0: 6c74 6572 6564 2062 7920 7374 6f72 6520  ltered by store 
-0002cdd0: 7479 7065 0a20 2020 2020 2020 206f 7574  type.        out
-0002cde0: 5f61 6c6c 203d 2073 7562 7072 6f63 6573  _all = subproces
-0002cdf0: 732e 6368 6563 6b5f 6f75 7470 7574 285b  s.check_output([
-0002ce00: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
-0002ce10: 2c20 276c 7327 5d29 0a20 2020 2020 2020  , 'ls']).       
-0002ce20: 206f 7574 203d 205b 0a20 2020 2020 2020   out = [.       
-0002ce30: 2020 2020 2069 7465 6d2e 7370 6c69 7428       item.split(
-0002ce40: 295b 305d 0a20 2020 2020 2020 2020 2020  )[0].           
-0002ce50: 2066 6f72 2069 7465 6d20 696e 206f 7574   for item in out
-0002ce60: 5f61 6c6c 2e64 6563 6f64 6528 2775 7466  _all.decode('utf
-0002ce70: 2d38 2729 2e73 706c 6974 6c69 6e65 7328  -8').splitlines(
-0002ce80: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0002ce90: 2073 746f 7265 5f74 7970 652e 7661 6c75   store_type.valu
-0002cea0: 6520 696e 2069 7465 6d0a 2020 2020 2020  e in item.      
-0002ceb0: 2020 5d0a 2020 2020 2020 2020 6173 7365    ].        asse
-0002cec0: 7274 2061 6c6c 285b 6974 656d 2069 6e20  rt all([item in 
-0002ced0: 6f75 7420 666f 7220 6974 656d 2069 6e20  out for item in 
-0002cee0: 7374 6f72 6167 655f 6f62 6a5f 6e61 6d65  storage_obj_name
-0002cef0: 5d29 0a0a 2020 2020 2020 2020 2320 5275  ])..        # Ru
-0002cf00: 6e20 736b 7920 7374 6f72 6167 6520 6465  n sky storage de
-0002cf10: 6c65 7465 2061 6c6c 2074 6f20 6465 6c65  lete all to dele
-0002cf20: 7465 2061 6c6c 2073 746f 7261 6765 206f  te all storage o
-0002cf30: 626a 6563 7473 0a20 2020 2020 2020 2064  bjects.        d
-0002cf40: 656c 6574 655f 636d 6420 3d20 5b27 736b  elete_cmd = ['sk
-0002cf50: 7927 2c20 2773 746f 7261 6765 272c 2027  y', 'storage', '
-0002cf60: 6465 6c65 7465 272c 2027 2d2d 7965 7327  delete', '--yes'
-0002cf70: 5d0a 2020 2020 2020 2020 6465 6c65 7465  ].        delete
-0002cf80: 5f63 6d64 202b 3d20 7374 6f72 6167 655f  _cmd += storage_
-0002cf90: 6f62 6a5f 6e61 6d65 0a20 2020 2020 2020  obj_name.       
-0002cfa0: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-0002cfb0: 6b5f 6f75 7470 7574 2864 656c 6574 655f  k_output(delete_
-0002cfc0: 636d 6429 0a0a 2020 2020 2020 2020 2320  cmd)..        # 
-0002cfd0: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
-0002cfe0: 6c73 2074 6f20 6368 6563 6b20 6966 2061  ls to check if a
-0002cff0: 6c6c 2073 746f 7261 6765 206f 626a 6563  ll storage objec
-0002d000: 7473 2066 696c 7465 7265 6420 6279 2073  ts filtered by s
-0002d010: 746f 7265 0a20 2020 2020 2020 2023 2074  tore.        # t
-0002d020: 7970 6520 6172 6520 6465 6c65 7465 640a  ype are deleted.
-0002d030: 2020 2020 2020 2020 6f75 745f 616c 6c20          out_all 
-0002d040: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
-0002d050: 636b 5f6f 7574 7075 7428 5b27 736b 7927  ck_output(['sky'
-0002d060: 2c20 2773 746f 7261 6765 272c 2027 6c73  , 'storage', 'ls
-0002d070: 275d 290a 2020 2020 2020 2020 6f75 7420  ']).        out 
-0002d080: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-0002d090: 6974 656d 2e73 706c 6974 2829 5b30 5d0a  item.split()[0].
-0002d0a0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0002d0b0: 6974 656d 2069 6e20 6f75 745f 616c 6c2e  item in out_all.
-0002d0c0: 6465 636f 6465 2827 7574 662d 3827 292e  decode('utf-8').
-0002d0d0: 7370 6c69 746c 696e 6573 2829 0a20 2020  splitlines().   
-0002d0e0: 2020 2020 2020 2020 2069 6620 7374 6f72           if stor
-0002d0f0: 655f 7479 7065 2e76 616c 7565 2069 6e20  e_type.value in 
-0002d100: 6974 656d 0a20 2020 2020 2020 205d 0a20  item.        ]. 
-0002d110: 2020 2020 2020 2061 7373 6572 7420 616c         assert al
-0002d120: 6c28 5b69 7465 6d20 6e6f 7420 696e 206f  l([item not in o
-0002d130: 7574 2066 6f72 2069 7465 6d20 696e 2073  ut for item in s
-0002d140: 746f 7261 6765 5f6f 626a 5f6e 616d 655d  torage_obj_name]
-0002d150: 290a 0a20 2020 2040 7079 7465 7374 2e6d  )..    @pytest.m
-0002d160: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
-0002d170: 6b0a 2020 2020 4070 7974 6573 742e 6d61  k.    @pytest.ma
-0002d180: 726b 2e70 6172 616d 6574 7269 7a65 2827  rk.parametrize('
-0002d190: 7374 6f72 655f 7479 7065 272c 205b 0a20  store_type', [. 
-0002d1a0: 2020 2020 2020 2073 746f 7261 6765 5f6c         storage_l
-0002d1b0: 6962 2e53 746f 7265 5479 7065 2e53 332c  ib.StoreType.S3,
-0002d1c0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-0002d1d0: 7265 5479 7065 2e47 4353 2c0a 2020 2020  reType.GCS,.    
-0002d1e0: 2020 2020 7079 7465 7374 2e70 6172 616d      pytest.param
-0002d1f0: 2873 746f 7261 6765 5f6c 6962 2e53 746f  (storage_lib.Sto
-0002d200: 7265 5479 7065 2e49 424d 2c20 6d61 726b  reType.IBM, mark
-0002d210: 733d 7079 7465 7374 2e6d 6172 6b2e 6962  s=pytest.mark.ib
-0002d220: 6d29 2c0a 2020 2020 2020 2020 7079 7465  m),.        pyte
-0002d230: 7374 2e70 6172 616d 2873 746f 7261 6765  st.param(storage
-0002d240: 5f6c 6962 2e53 746f 7265 5479 7065 2e52  _lib.StoreType.R
-0002d250: 322c 206d 6172 6b73 3d70 7974 6573 742e  2, marks=pytest.
-0002d260: 6d61 726b 2e63 6c6f 7564 666c 6172 6529  mark.cloudflare)
-0002d270: 0a20 2020 205d 290a 2020 2020 6465 6620  .    ]).    def 
-0002d280: 7465 7374 5f75 706c 6f61 645f 736f 7572  test_upload_sour
-0002d290: 6365 5f77 6974 685f 7370 6163 6573 2873  ce_with_spaces(s
-0002d2a0: 656c 662c 2073 746f 7265 5f74 7970 652c  elf, store_type,
-0002d2b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d2d0: 2020 2020 2020 2020 746d 705f 6d75 6c74          tmp_mult
-0002d2e0: 6970 6c65 5f63 7573 746f 6d5f 736f 7572  iple_custom_sour
-0002d2f0: 6365 5f73 746f 7261 6765 5f6f 626a 293a  ce_storage_obj):
-0002d300: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
-0002d310: 6573 2074 776f 2062 7563 6b65 7473 2077  es two buckets w
-0002d320: 6974 6820 7370 6563 6966 6965 6420 6c6f  ith specified lo
-0002d330: 6361 6c20 736f 7572 6365 730a 2020 2020  cal sources.    
-0002d340: 2020 2020 2320 7769 7468 2073 7061 6365      # with space
-0002d350: 7320 696e 2074 6865 206e 616d 650a 2020  s in the name.  
-0002d360: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
-0002d370: 6a5f 6e61 6d65 7320 3d20 5b5d 0a20 2020  j_names = [].   
-0002d380: 2020 2020 2066 6f72 2073 746f 7261 6765       for storage
-0002d390: 5f6f 626a 2069 6e20 746d 705f 6d75 6c74  _obj in tmp_mult
-0002d3a0: 6970 6c65 5f63 7573 746f 6d5f 736f 7572  iple_custom_sour
-0002d3b0: 6365 5f73 746f 7261 6765 5f6f 626a 3a0a  ce_storage_obj:.
-0002d3c0: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-0002d3d0: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
-0002d3e0: 6528 7374 6f72 655f 7479 7065 290a 2020  e(store_type).  
-0002d3f0: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
-0002d400: 655f 6f62 6a5f 6e61 6d65 732e 6170 7065  e_obj_names.appe
-0002d410: 6e64 2873 746f 7261 6765 5f6f 626a 2e6e  nd(storage_obj.n
-0002d420: 616d 6529 0a0a 2020 2020 2020 2020 2320  ame)..        # 
-0002d430: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
-0002d440: 6c73 2074 6f20 6368 6563 6b20 6966 2061  ls to check if a
-0002d450: 6c6c 2073 746f 7261 6765 206f 626a 6563  ll storage objec
-0002d460: 7473 2065 7869 7374 7320 696e 2074 6865  ts exists in the
-0002d470: 0a20 2020 2020 2020 2023 206f 7574 7075  .        # outpu
-0002d480: 7420 6669 6c74 6572 6564 2062 7920 7374  t filtered by st
-0002d490: 6f72 6520 7479 7065 0a20 2020 2020 2020  ore type.       
-0002d4a0: 206f 7574 5f61 6c6c 203d 2073 7562 7072   out_all = subpr
-0002d4b0: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-0002d4c0: 7574 285b 2773 6b79 272c 2027 7374 6f72  ut(['sky', 'stor
-0002d4d0: 6167 6527 2c20 276c 7327 5d29 0a20 2020  age', 'ls']).   
-0002d4e0: 2020 2020 206f 7574 203d 205b 0a20 2020       out = [.   
-0002d4f0: 2020 2020 2020 2020 2069 7465 6d2e 7370           item.sp
-0002d500: 6c69 7428 295b 305d 0a20 2020 2020 2020  lit()[0].       
-0002d510: 2020 2020 2066 6f72 2069 7465 6d20 696e       for item in
-0002d520: 206f 7574 5f61 6c6c 2e64 6563 6f64 6528   out_all.decode(
-0002d530: 2775 7466 2d38 2729 2e73 706c 6974 6c69  'utf-8').splitli
-0002d540: 6e65 7328 290a 2020 2020 2020 2020 2020  nes().          
-0002d550: 2020 6966 2073 746f 7265 5f74 7970 652e    if store_type.
-0002d560: 7661 6c75 6520 696e 2069 7465 6d0a 2020  value in item.  
-0002d570: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-0002d580: 6173 7365 7274 2061 6c6c 285b 6974 656d  assert all([item
-0002d590: 2069 6e20 6f75 7420 666f 7220 6974 656d   in out for item
-0002d5a0: 2069 6e20 7374 6f72 6167 655f 6f62 6a5f   in storage_obj_
-0002d5b0: 6e61 6d65 735d 290a 0a20 2020 2040 7079  names])..    @py
-0002d5c0: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
-0002d5d0: 6964 7374 6163 6b0a 2020 2020 4070 7974  idstack.    @pyt
-0002d5e0: 6573 742e 6d61 726b 2e70 6172 616d 6574  est.mark.paramet
-0002d5f0: 7269 7a65 2827 7374 6f72 655f 7479 7065  rize('store_type
-0002d600: 272c 205b 0a20 2020 2020 2020 2073 746f  ', [.        sto
-0002d610: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-0002d620: 7065 2e53 332c 2073 746f 7261 6765 5f6c  pe.S3, storage_l
-0002d630: 6962 2e53 746f 7265 5479 7065 2e47 4353  ib.StoreType.GCS
-0002d640: 2c0a 2020 2020 2020 2020 7079 7465 7374  ,.        pytest
-0002d650: 2e70 6172 616d 2873 746f 7261 6765 5f6c  .param(storage_l
-0002d660: 6962 2e53 746f 7265 5479 7065 2e49 424d  ib.StoreType.IBM
-0002d670: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
-0002d680: 6172 6b2e 6962 6d29 2c0a 2020 2020 2020  ark.ibm),.      
-0002d690: 2020 7079 7465 7374 2e70 6172 616d 2873    pytest.param(s
-0002d6a0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-0002d6b0: 5479 7065 2e52 322c 206d 6172 6b73 3d70  Type.R2, marks=p
-0002d6c0: 7974 6573 742e 6d61 726b 2e63 6c6f 7564  ytest.mark.cloud
-0002d6d0: 666c 6172 6529 0a20 2020 205d 290a 2020  flare).    ]).  
-0002d6e0: 2020 6465 6620 7465 7374 5f62 7563 6b65    def test_bucke
-0002d6f0: 745f 6578 7465 726e 616c 5f64 656c 6574  t_external_delet
-0002d700: 696f 6e28 7365 6c66 2c20 746d 705f 7363  ion(self, tmp_sc
-0002d710: 7261 7463 685f 7374 6f72 6167 655f 6f62  ratch_storage_ob
-0002d720: 6a2c 0a20 2020 2020 2020 2020 2020 2020  j,.             
-0002d730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d740: 2020 2020 2020 2020 2073 746f 7265 5f74           store_t
-0002d750: 7970 6529 3a0a 2020 2020 2020 2020 2320  ype):.        # 
-0002d760: 4372 6561 7465 7320 6120 6275 636b 6574  Creates a bucket
-0002d770: 2c20 6465 6c65 7465 7320 6974 2065 7874  , deletes it ext
-0002d780: 6572 6e61 6c6c 7920 7573 696e 6720 636c  ernally using cl
-0002d790: 6f75 6420 636c 6920 636f 6d6d 616e 6473  oud cli commands
-0002d7a0: 0a20 2020 2020 2020 2023 2061 6e64 2074  .        # and t
-0002d7b0: 6865 6e20 7472 6965 7320 746f 2064 656c  hen tries to del
-0002d7c0: 6574 6520 6974 2075 7369 6e67 2073 6b79  ete it using sky
-0002d7d0: 2073 746f 7261 6765 2064 656c 6574 652e   storage delete.
-0002d7e0: 0a20 2020 2020 2020 2074 6d70 5f73 6372  .        tmp_scr
-0002d7f0: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
-0002d800: 2e61 6464 5f73 746f 7265 2873 746f 7265  .add_store(store
-0002d810: 5f74 7970 6529 0a0a 2020 2020 2020 2020  _type)..        
-0002d820: 2320 5275 6e20 736b 7920 7374 6f72 6167  # Run sky storag
-0002d830: 6520 6c73 2074 6f20 6368 6563 6b20 6966  e ls to check if
-0002d840: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
-0002d850: 6578 6973 7473 2069 6e20 7468 6520 6f75  exists in the ou
-0002d860: 7470 7574 0a20 2020 2020 2020 206f 7574  tput.        out
-0002d870: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
-0002d880: 6563 6b5f 6f75 7470 7574 285b 2773 6b79  eck_output(['sky
-0002d890: 272c 2027 7374 6f72 6167 6527 2c20 276c  ', 'storage', 'l
-0002d8a0: 7327 5d29 0a20 2020 2020 2020 2061 7373  s']).        ass
-0002d8b0: 6572 7420 746d 705f 7363 7261 7463 685f  ert tmp_scratch_
-0002d8c0: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
-0002d8d0: 2069 6e20 6f75 742e 6465 636f 6465 2827   in out.decode('
-0002d8e0: 7574 662d 3827 290a 0a20 2020 2020 2020  utf-8')..       
-0002d8f0: 2023 2044 656c 6574 6520 6275 636b 6574   # Delete bucket
-0002d900: 2065 7874 6572 6e61 6c6c 790a 2020 2020   externally.    
-0002d910: 2020 2020 636d 6420 3d20 7365 6c66 2e63      cmd = self.c
-0002d920: 6c69 5f64 656c 6574 655f 636d 6428 7374  li_delete_cmd(st
-0002d930: 6f72 655f 7479 7065 2c20 746d 705f 7363  ore_type, tmp_sc
-0002d940: 7261 7463 685f 7374 6f72 6167 655f 6f62  ratch_storage_ob
-0002d950: 6a2e 6e61 6d65 290a 2020 2020 2020 2020  j.name).        
-0002d960: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
-0002d970: 5f6f 7574 7075 7428 636d 642c 2073 6865  _output(cmd, she
-0002d980: 6c6c 3d54 7275 6529 0a0a 2020 2020 2020  ll=True)..      
-0002d990: 2020 2320 5275 6e20 736b 7920 7374 6f72    # Run sky stor
-0002d9a0: 6167 6520 6465 6c65 7465 2074 6f20 6465  age delete to de
-0002d9b0: 6c65 7465 2074 6865 2073 746f 7261 6765  lete the storage
-0002d9c0: 206f 626a 6563 740a 2020 2020 2020 2020   object.        
-0002d9d0: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
-0002d9e0: 2e63 6865 636b 5f6f 7574 7075 7428 0a20  .check_output(. 
-0002d9f0: 2020 2020 2020 2020 2020 205b 2773 6b79             ['sky
-0002da00: 272c 2027 7374 6f72 6167 6527 2c20 2764  ', 'storage', 'd
-0002da10: 656c 6574 6527 2c20 746d 705f 7363 7261  elete', tmp_scra
-0002da20: 7463 685f 7374 6f72 6167 655f 6f62 6a2e  tch_storage_obj.
-0002da30: 6e61 6d65 2c20 272d 2d79 6573 275d 290a  name, '--yes']).
-0002da40: 2020 2020 2020 2020 2320 4d61 6b65 2073          # Make s
-0002da50: 7572 6520 6275 636b 6574 2077 6173 206e  ure bucket was n
-0002da60: 6f74 2063 7265 6174 6564 2064 7572 696e  ot created durin
-0002da70: 6720 6465 6c65 7469 6f6e 2028 7365 6520  g deletion (see 
-0002da80: 6973 7375 6520 2331 3332 3229 0a20 2020  issue #1322).   
-0002da90: 2020 2020 2061 7373 6572 7420 2763 7265       assert 'cre
-0002daa0: 6174 6564 2720 6e6f 7420 696e 206f 7574  ated' not in out
-0002dab0: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-0002dac0: 2e6c 6f77 6572 2829 0a0a 2020 2020 2020  .lower()..      
-0002dad0: 2020 2320 5275 6e20 736b 7920 7374 6f72    # Run sky stor
-0002dae0: 6167 6520 6c73 2074 6f20 6368 6563 6b20  age ls to check 
-0002daf0: 6966 2073 746f 7261 6765 206f 626a 6563  if storage objec
-0002db00: 7420 6973 2064 656c 6574 6564 0a20 2020  t is deleted.   
-0002db10: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
-0002db20: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-0002db30: 7574 285b 2773 6b79 272c 2027 7374 6f72  ut(['sky', 'stor
-0002db40: 6167 6527 2c20 276c 7327 5d29 0a20 2020  age', 'ls']).   
-0002db50: 2020 2020 2061 7373 6572 7420 746d 705f       assert tmp_
-0002db60: 7363 7261 7463 685f 7374 6f72 6167 655f  scratch_storage_
-0002db70: 6f62 6a2e 6e61 6d65 206e 6f74 2069 6e20  obj.name not in 
-0002db80: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
-0002db90: 3827 290a 0a20 2020 2040 7079 7465 7374  8')..    @pytest
-0002dba0: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
-0002dbb0: 6163 6b0a 2020 2020 4070 7974 6573 742e  ack.    @pytest.
-0002dbc0: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
-0002dbd0: 2827 7374 6f72 655f 7479 7065 272c 205b  ('store_type', [
-0002dbe0: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
-0002dbf0: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
-0002dc00: 332c 2073 746f 7261 6765 5f6c 6962 2e53  3, storage_lib.S
-0002dc10: 746f 7265 5479 7065 2e47 4353 2c0a 2020  toreType.GCS,.  
-0002dc20: 2020 2020 2020 7079 7465 7374 2e70 6172        pytest.par
-0002dc30: 616d 2873 746f 7261 6765 5f6c 6962 2e53  am(storage_lib.S
-0002dc40: 746f 7265 5479 7065 2e49 424d 2c20 6d61  toreType.IBM, ma
-0002dc50: 726b 733d 7079 7465 7374 2e6d 6172 6b2e  rks=pytest.mark.
-0002dc60: 6962 6d29 2c0a 2020 2020 2020 2020 7079  ibm),.        py
-0002dc70: 7465 7374 2e70 6172 616d 2873 746f 7261  test.param(stora
-0002dc80: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-0002dc90: 2e52 322c 206d 6172 6b73 3d70 7974 6573  .R2, marks=pytes
-0002dca0: 742e 6d61 726b 2e63 6c6f 7564 666c 6172  t.mark.cloudflar
-0002dcb0: 6529 0a20 2020 205d 290a 2020 2020 6465  e).    ]).    de
-0002dcc0: 6620 7465 7374 5f62 7563 6b65 745f 6275  f test_bucket_bu
-0002dcd0: 6c6b 5f64 656c 6574 696f 6e28 7365 6c66  lk_deletion(self
-0002dce0: 2c20 7374 6f72 655f 7479 7065 2c20 746d  , store_type, tm
-0002dcf0: 705f 6275 6c6b 5f64 656c 5f73 746f 7261  p_bulk_del_stora
-0002dd00: 6765 5f6f 626a 293a 0a20 2020 2020 2020  ge_obj):.       
-0002dd10: 2023 2043 7265 6174 6573 2061 2074 656d   # Creates a tem
-0002dd20: 7020 666f 6c64 6572 2077 6974 6820 6f76  p folder with ov
-0002dd30: 6572 2032 3536 2066 696c 6573 2061 6e64  er 256 files and
-0002dd40: 2066 6f6c 6465 7273 2c20 7570 6c6f 6164   folders, upload
-0002dd50: 0a20 2020 2020 2020 2023 2066 696c 6573  .        # files
-0002dd60: 2061 6e64 2066 6f6c 6465 7273 2074 6f20   and folders to 
-0002dd70: 6120 6e65 7720 6275 636b 6574 2c20 7468  a new bucket, th
-0002dd80: 656e 2064 656c 6574 6520 6275 636b 6574  en delete bucket
-0002dd90: 2e0a 2020 2020 2020 2020 746d 705f 6275  ..        tmp_bu
-0002dda0: 6c6b 5f64 656c 5f73 746f 7261 6765 5f6f  lk_del_storage_o
-0002ddb0: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
-0002ddc0: 7265 5f74 7970 6529 0a0a 2020 2020 2020  re_type)..      
-0002ddd0: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
-0002dde0: 636b 5f6f 7574 7075 7428 5b0a 2020 2020  ck_output([.    
-0002ddf0: 2020 2020 2020 2020 2773 6b79 272c 2027          'sky', '
-0002de00: 7374 6f72 6167 6527 2c20 2764 656c 6574  storage', 'delet
-0002de10: 6527 2c20 746d 705f 6275 6c6b 5f64 656c  e', tmp_bulk_del
-0002de20: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
-0002de30: 652c 2027 2d2d 7965 7327 0a20 2020 2020  e, '--yes'.     
-0002de40: 2020 205d 290a 0a20 2020 2020 2020 206f     ])..        o
-0002de50: 7574 7075 7420 3d20 7375 6270 726f 6365  utput = subproce
-0002de60: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
-0002de70: 5b27 736b 7927 2c20 2773 746f 7261 6765  ['sky', 'storage
-0002de80: 272c 2027 6c73 275d 290a 2020 2020 2020  ', 'ls']).      
-0002de90: 2020 6173 7365 7274 2074 6d70 5f62 756c    assert tmp_bul
-0002dea0: 6b5f 6465 6c5f 7374 6f72 6167 655f 6f62  k_del_storage_ob
-0002deb0: 6a2e 6e61 6d65 206e 6f74 2069 6e20 6f75  j.name not in ou
-0002dec0: 7470 7574 2e64 6563 6f64 6528 2775 7466  tput.decode('utf
-0002ded0: 2d38 2729 0a0a 2020 2020 4070 7974 6573  -8')..    @pytes
-0002dee0: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
-0002def0: 7461 636b 0a20 2020 2040 7079 7465 7374  tack.    @pytest
-0002df00: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
-0002df10: 6528 0a20 2020 2020 2020 2027 746d 705f  e(.        'tmp_
-0002df20: 7075 626c 6963 5f73 746f 7261 6765 5f6f  public_storage_o
-0002df30: 626a 2c20 7374 6f72 655f 7479 7065 272c  bj, store_type',
-0002df40: 0a20 2020 2020 2020 205b 2827 7333 3a2f  .        [('s3:/
-0002df50: 2f74 6367 612d 322d 6f70 656e 272c 2073  /tcga-2-open', s
-0002df60: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-0002df70: 5479 7065 2e53 3329 2c0a 2020 2020 2020  Type.S3),.      
-0002df80: 2020 2028 2773 333a 2f2f 6469 6769 7461     ('s3://digita
-0002df90: 6c63 6f72 706f 7261 272c 2073 746f 7261  lcorpora', stora
-0002dfa0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-0002dfb0: 2e53 3329 2c0a 2020 2020 2020 2020 2028  .S3),.         (
-0002dfc0: 2767 733a 2f2f 6763 702d 7075 626c 6963  'gs://gcp-public
-0002dfd0: 2d64 6174 612d 7365 6e74 696e 656c 2d32  -data-sentinel-2
-0002dfe0: 272c 2073 746f 7261 6765 5f6c 6962 2e53  ', storage_lib.S
-0002dff0: 746f 7265 5479 7065 2e47 4353 295d 2c0a  toreType.GCS)],.
-0002e000: 2020 2020 2020 2020 696e 6469 7265 6374          indirect
-0002e010: 3d5b 2774 6d70 5f70 7562 6c69 635f 7374  =['tmp_public_st
-0002e020: 6f72 6167 655f 6f62 6a27 5d29 0a20 2020  orage_obj']).   
-0002e030: 2064 6566 2074 6573 745f 7075 626c 6963   def test_public
-0002e040: 5f62 7563 6b65 7428 7365 6c66 2c20 746d  _bucket(self, tm
-0002e050: 705f 7075 626c 6963 5f73 746f 7261 6765  p_public_storage
-0002e060: 5f6f 626a 2c20 7374 6f72 655f 7479 7065  _obj, store_type
-0002e070: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
-0002e080: 6174 6573 2061 206e 6577 2062 7563 6b65  ates a new bucke
-0002e090: 7420 7769 7468 2061 2070 7562 6c69 6320  t with a public 
-0002e0a0: 736f 7572 6365 2061 6e64 2076 6572 6966  source and verif
-0002e0b0: 6965 7320 7468 6174 2069 7420 6973 206e  ies that it is n
-0002e0c0: 6f74 0a20 2020 2020 2020 2023 2061 6464  ot.        # add
-0002e0d0: 6564 2074 6f20 676c 6f62 616c 5f75 7365  ed to global_use
-0002e0e0: 725f 7374 6174 652e 0a20 2020 2020 2020  r_state..       
-0002e0f0: 2074 6d70 5f70 7562 6c69 635f 7374 6f72   tmp_public_stor
-0002e100: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
-0002e110: 6528 7374 6f72 655f 7479 7065 290a 0a20  e(store_type).. 
-0002e120: 2020 2020 2020 2023 2052 756e 2073 6b79         # Run sky
-0002e130: 2073 746f 7261 6765 206c 7320 746f 2063   storage ls to c
-0002e140: 6865 636b 2069 6620 7374 6f72 6167 6520  heck if storage 
-0002e150: 6f62 6a65 6374 2065 7869 7374 7320 696e  object exists in
-0002e160: 2074 6865 206f 7574 7075 740a 2020 2020   the output.    
-0002e170: 2020 2020 6f75 7420 3d20 7375 6270 726f      out = subpro
-0002e180: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
-0002e190: 7428 5b27 736b 7927 2c20 2773 746f 7261  t(['sky', 'stora
-0002e1a0: 6765 272c 2027 6c73 275d 290a 2020 2020  ge', 'ls']).    
-0002e1b0: 2020 2020 6173 7365 7274 2074 6d70 5f70      assert tmp_p
-0002e1c0: 7562 6c69 635f 7374 6f72 6167 655f 6f62  ublic_storage_ob
-0002e1d0: 6a2e 6e61 6d65 206e 6f74 2069 6e20 6f75  j.name not in ou
-0002e1e0: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
-0002e1f0: 290a 0a20 2020 2040 7079 7465 7374 2e6d  )..    @pytest.m
-0002e200: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
-0002e210: 6b0a 2020 2020 4070 7974 6573 742e 6d61  k.    @pytest.ma
-0002e220: 726b 2e70 6172 616d 6574 7269 7a65 2827  rk.parametrize('
-0002e230: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
-0002e240: 7572 6c27 2c20 5b0a 2020 2020 2020 2020  url', [.        
-0002e250: 2773 333a 2f2f 7b72 616e 646f 6d5f 6e61  's3://{random_na
-0002e260: 6d65 7d27 2c20 2767 733a 2f2f 7b72 616e  me}', 'gs://{ran
-0002e270: 646f 6d5f 6e61 6d65 7d27 2c0a 2020 2020  dom_name}',.    
-0002e280: 2020 2020 7079 7465 7374 2e70 6172 616d      pytest.param
-0002e290: 2827 636f 733a 2f2f 7573 2d65 6173 742f  ('cos://us-east/
-0002e2a0: 7b72 616e 646f 6d5f 6e61 6d65 7d27 2c20  {random_name}', 
-0002e2b0: 6d61 726b 733d 7079 7465 7374 2e6d 6172  marks=pytest.mar
-0002e2c0: 6b2e 6962 6d29 2c0a 2020 2020 2020 2020  k.ibm),.        
-0002e2d0: 7079 7465 7374 2e70 6172 616d 2827 7232  pytest.param('r2
-0002e2e0: 3a2f 2f7b 7261 6e64 6f6d 5f6e 616d 657d  ://{random_name}
-0002e2f0: 272c 206d 6172 6b73 3d70 7974 6573 742e  ', marks=pytest.
-0002e300: 6d61 726b 2e63 6c6f 7564 666c 6172 6529  mark.cloudflare)
-0002e310: 0a20 2020 205d 290a 2020 2020 6465 6620  .    ]).    def 
-0002e320: 7465 7374 5f6e 6f6e 6578 6973 7465 6e74  test_nonexistent
-0002e330: 5f62 7563 6b65 7428 7365 6c66 2c20 6e6f  _bucket(self, no
-0002e340: 6e65 7869 7374 5f62 7563 6b65 745f 7572  nexist_bucket_ur
-0002e350: 6c29 3a0a 2020 2020 2020 2020 2320 4174  l):.        # At
-0002e360: 7465 6d70 7473 2074 6f20 6372 6561 7465  tempts to create
-0002e370: 2066 6574 6368 2061 2073 7472 6f61 6765   fetch a stroage
-0002e380: 2077 6974 6820 6120 6e6f 6e2d 6578 6973   with a non-exis
-0002e390: 7465 6e74 2073 6f75 7263 652e 0a20 2020  tent source..   
-0002e3a0: 2020 2020 2023 2047 656e 6572 6174 6520       # Generate 
-0002e3b0: 6120 7261 6e64 6f6d 2062 7563 6b65 7420  a random bucket 
-0002e3c0: 6e61 6d65 2061 6e64 2076 6572 6966 7920  name and verify 
-0002e3d0: 6974 2064 6f65 736e 2774 2065 7869 7374  it doesn't exist
-0002e3e0: 3a0a 2020 2020 2020 2020 7265 7472 795f  :.        retry_
-0002e3f0: 636f 756e 7420 3d20 300a 2020 2020 2020  count = 0.      
-0002e400: 2020 7768 696c 6520 5472 7565 3a0a 2020    while True:.  
-0002e410: 2020 2020 2020 2020 2020 6e6f 6e65 7869            nonexi
-0002e420: 7374 5f62 7563 6b65 745f 6e61 6d65 203d  st_bucket_name =
-0002e430: 2073 7472 2875 7569 642e 7575 6964 3428   str(uuid.uuid4(
-0002e440: 2929 0a20 2020 2020 2020 2020 2020 2069  )).            i
-0002e450: 6620 6e6f 6e65 7869 7374 5f62 7563 6b65  f nonexist_bucke
-0002e460: 745f 7572 6c2e 7374 6172 7473 7769 7468  t_url.startswith
-0002e470: 2827 7333 2729 3a0a 2020 2020 2020 2020  ('s3'):.        
-0002e480: 2020 2020 2020 2020 636f 6d6d 616e 6420          command 
-0002e490: 3d20 6627 6177 7320 7333 6170 6920 6865  = f'aws s3api he
-0002e4a0: 6164 2d62 7563 6b65 7420 2d2d 6275 636b  ad-bucket --buck
-0002e4b0: 6574 207b 6e6f 6e65 7869 7374 5f62 7563  et {nonexist_buc
-0002e4c0: 6b65 745f 6e61 6d65 7d27 0a20 2020 2020  ket_name}'.     
-0002e4d0: 2020 2020 2020 2020 2020 2065 7870 6563             expec
-0002e4e0: 7465 645f 6f75 7470 7574 203d 2027 3430  ted_output = '40
-0002e4f0: 3427 0a20 2020 2020 2020 2020 2020 2065  4'.            e
-0002e500: 6c69 6620 6e6f 6e65 7869 7374 5f62 7563  lif nonexist_buc
-0002e510: 6b65 745f 7572 6c2e 7374 6172 7473 7769  ket_url.startswi
-0002e520: 7468 2827 6773 2729 3a0a 2020 2020 2020  th('gs'):.      
-0002e530: 2020 2020 2020 2020 2020 636f 6d6d 616e            comman
-0002e540: 6420 3d20 6627 6773 7574 696c 206c 7320  d = f'gsutil ls 
-0002e550: 7b6e 6f6e 6578 6973 745f 6275 636b 6574  {nonexist_bucket
-0002e560: 5f75 726c 2e66 6f72 6d61 7428 7261 6e64  _url.format(rand
-0002e570: 6f6d 5f6e 616d 653d 6e6f 6e65 7869 7374  om_name=nonexist
-0002e580: 5f62 7563 6b65 745f 6e61 6d65 297d 270a  _bucket_name)}'.
-0002e590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e5a0: 6578 7065 6374 6564 5f6f 7574 7075 7420  expected_output 
-0002e5b0: 3d20 2742 7563 6b65 744e 6f74 466f 756e  = 'BucketNotFoun
-0002e5c0: 6445 7863 6570 7469 6f6e 270a 2020 2020  dException'.    
-0002e5d0: 2020 2020 2020 2020 656c 6966 206e 6f6e          elif non
-0002e5e0: 6578 6973 745f 6275 636b 6574 5f75 726c  exist_bucket_url
-0002e5f0: 2e73 7461 7274 7377 6974 6828 2772 3227  .startswith('r2'
-0002e600: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0002e610: 2020 2065 6e64 706f 696e 745f 7572 6c20     endpoint_url 
-0002e620: 3d20 636c 6f75 6466 6c61 7265 2e63 7265  = cloudflare.cre
-0002e630: 6174 655f 656e 6470 6f69 6e74 2829 0a20  ate_endpoint(). 
-0002e640: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0002e650: 6f6d 6d61 6e64 203d 2066 2741 5753 5f53  ommand = f'AWS_S
-0002e660: 4841 5245 445f 4352 4544 454e 5449 414c  HARED_CREDENTIAL
-0002e670: 535f 4649 4c45 3d7b 636c 6f75 6466 6c61  S_FILE={cloudfla
-0002e680: 7265 2e52 325f 4352 4544 454e 5449 414c  re.R2_CREDENTIAL
-0002e690: 535f 5041 5448 7d20 6177 7320 7333 6170  S_PATH} aws s3ap
-0002e6a0: 6920 6865 6164 2d62 7563 6b65 7420 2d2d  i head-bucket --
-0002e6b0: 6275 636b 6574 207b 6e6f 6e65 7869 7374  bucket {nonexist
-0002e6c0: 5f62 7563 6b65 745f 6e61 6d65 7d20 2d2d  _bucket_name} --
-0002e6d0: 656e 6470 6f69 6e74 207b 656e 6470 6f69  endpoint {endpoi
-0002e6e0: 6e74 5f75 726c 7d20 2d2d 7072 6f66 696c  nt_url} --profil
-0002e6f0: 653d 7232 270a 2020 2020 2020 2020 2020  e=r2'.          
-0002e700: 2020 2020 2020 6578 7065 6374 6564 5f6f        expected_o
-0002e710: 7574 7075 7420 3d20 2734 3034 270a 2020  utput = '404'.  
-0002e720: 2020 2020 2020 2020 2020 656c 6966 206e            elif n
-0002e730: 6f6e 6578 6973 745f 6275 636b 6574 5f75  onexist_bucket_u
-0002e740: 726c 2e73 7461 7274 7377 6974 6828 2763  rl.startswith('c
-0002e750: 6f73 2729 3a0a 2020 2020 2020 2020 2020  os'):.          
-0002e760: 2020 2020 2020 2320 5573 696e 6720 4150        # Using AP
-0002e770: 4920 6361 6c6c 732c 2073 696e 6365 2075  I calls, since u
-0002e780: 7369 6e67 2072 636c 6f6e 6520 7265 7175  sing rclone requ
-0002e790: 6972 6573 2061 2070 726f 6669 6c65 2773  ires a profile's
-0002e7a0: 206e 616d 650a 2020 2020 2020 2020 2020   name.          
-0002e7b0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0002e7c0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0002e7d0: 7870 6563 7465 645f 6f75 7470 7574 203d  xpected_output =
-0002e7e0: 2063 6f6d 6d61 6e64 203d 2022 6563 686f   command = "echo
-0002e7f0: 2220 2023 2061 766f 6964 2075 6e72 656c  "  # avoid unrel
-0002e800: 6174 6564 2065 7863 6570 7469 6f6e 2069  ated exception i
-0002e810: 6e20 6361 7365 206f 6620 6661 696c 7572  n case of failur
-0002e820: 652e 0a20 2020 2020 2020 2020 2020 2020  e..             
-0002e830: 2020 2020 2020 2062 7563 6b65 745f 6e61         bucket_na
-0002e840: 6d65 203d 2075 726c 6c69 622e 7061 7273  me = urllib.pars
-0002e850: 652e 7572 6c73 706c 6974 280a 2020 2020  e.urlsplit(.    
-0002e860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e870: 2020 2020 6e6f 6e65 7869 7374 5f62 7563      nonexist_buc
-0002e880: 6b65 745f 7572 6c2e 666f 726d 6174 280a  ket_url.format(.
-0002e890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e8a0: 2020 2020 2020 2020 2020 2020 7261 6e64              rand
-0002e8b0: 6f6d 5f6e 616d 653d 6e6f 6e65 7869 7374  om_name=nonexist
-0002e8c0: 5f62 7563 6b65 745f 6e61 6d65 2929 2e70  _bucket_name)).p
-0002e8d0: 6174 682e 7374 7269 7028 272f 2729 0a20  ath.strip('/'). 
-0002e8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e8f0: 2020 2063 6c69 656e 7420 3d20 6962 6d2e     client = ibm.
-0002e900: 6765 745f 636f 735f 636c 6965 6e74 2827  get_cos_client('
-0002e910: 7573 2d65 6173 7427 290a 2020 2020 2020  us-east').      
-0002e920: 2020 2020 2020 2020 2020 2020 2020 636c                cl
-0002e930: 6965 6e74 2e68 6561 645f 6275 636b 6574  ient.head_bucket
-0002e940: 2842 7563 6b65 743d 6275 636b 6574 5f6e  (Bucket=bucket_n
-0002e950: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-0002e960: 2020 2020 2065 7863 6570 7420 6962 6d2e       except ibm.
-0002e970: 6962 6d5f 626f 746f 636f 7265 2e65 7863  ibm_botocore.exc
-0002e980: 6570 7469 6f6e 732e 436c 6965 6e74 4572  eptions.ClientEr
-0002e990: 726f 7220 6173 2065 3a0a 2020 2020 2020  ror as e:.      
-0002e9a0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0002e9b0: 2065 2e72 6573 706f 6e73 655b 2745 7272   e.response['Err
-0002e9c0: 6f72 275d 5b27 436f 6465 275d 203d 3d20  or']['Code'] == 
-0002e9d0: 2734 3034 273a 0a20 2020 2020 2020 2020  '404':.         
-0002e9e0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0002e9f0: 2073 7563 6365 7373 0a20 2020 2020 2020   success.       
-0002ea00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ea10: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-0002ea20: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0002ea30: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0002ea40: 5661 6c75 6545 7272 6f72 2827 556e 7375  ValueError('Unsu
-0002ea50: 7070 6f72 7465 6420 6275 636b 6574 2074  pported bucket t
-0002ea60: 7970 6520 270a 2020 2020 2020 2020 2020  ype '.          
-0002ea70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ea80: 2020 2020 2020 2066 277b 6e6f 6e65 7869         f'{nonexi
-0002ea90: 7374 5f62 7563 6b65 745f 7572 6c7d 2729  st_bucket_url}')
-0002eaa0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0002eab0: 4368 6563 6b20 6966 2062 7563 6b65 7420  Check if bucket 
-0002eac0: 6578 6973 7473 2075 7369 6e67 2074 6865  exists using the
-0002ead0: 2063 6c69 3a0a 2020 2020 2020 2020 2020   cli:.          
-0002eae0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0002eaf0: 2020 2020 2020 206f 7574 203d 2073 7562         out = sub
-0002eb00: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
-0002eb10: 7470 7574 2863 6f6d 6d61 6e64 2c0a 2020  tput(command,.  
-0002eb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002eb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002eb40: 2020 2020 2020 2020 2020 2020 7374 6465              stde
-0002eb50: 7272 3d73 7562 7072 6f63 6573 732e 5354  rr=subprocess.ST
-0002eb60: 444f 5554 2c0a 2020 2020 2020 2020 2020  DOUT,.          
-0002eb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002eb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002eb90: 2020 2020 7368 656c 6c3d 5472 7565 290a      shell=True).
-0002eba0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0002ebb0: 7074 2073 7562 7072 6f63 6573 732e 4361  pt subprocess.Ca
-0002ebc0: 6c6c 6564 5072 6f63 6573 7345 7272 6f72  lledProcessError
-0002ebd0: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-0002ebe0: 2020 2020 2020 206f 7574 203d 2065 2e6f         out = e.o
-0002ebf0: 7574 7075 740a 2020 2020 2020 2020 2020  utput.          
-0002ec00: 2020 6f75 7420 3d20 6f75 742e 6465 636f    out = out.deco
-0002ec10: 6465 2827 7574 662d 3827 290a 2020 2020  de('utf-8').    
-0002ec20: 2020 2020 2020 2020 6966 2065 7870 6563          if expec
-0002ec30: 7465 645f 6f75 7470 7574 2069 6e20 6f75  ted_output in ou
-0002ec40: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-0002ec50: 2020 2062 7265 616b 0a20 2020 2020 2020     break.       
-0002ec60: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0002ec70: 2020 2020 2020 2020 2020 2072 6574 7279             retry
-0002ec80: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
-0002ec90: 2020 2020 2020 2020 2020 2020 6966 2072              if r
-0002eca0: 6574 7279 5f63 6f75 6e74 203e 2033 3a0a  etry_count > 3:.
-0002ecb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ecc0: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
-0002ecd0: 6545 7272 6f72 2827 556e 6162 6c65 2074  eError('Unable t
-0002ece0: 6f20 6669 6e64 2061 206e 6f6e 6578 6973  o find a nonexis
-0002ecf0: 7465 6e74 2062 7563 6b65 7420 270a 2020  tent bucket '.  
-0002ed00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ed10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ed20: 2020 2020 2027 746f 2075 7365 2e20 5468       'to use. Th
-0002ed30: 6973 2069 7320 6869 676c 7920 756e 6c69  is is higly unli
-0002ed40: 6b65 6c79 202d 2027 0a20 2020 2020 2020  kely - '.       
-0002ed50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ed60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ed70: 2763 6865 636b 2069 6620 7468 6520 7465  'check if the te
-0002ed80: 7374 7320 6172 6520 636f 7272 6563 742e  sts are correct.
-0002ed90: 2729 0a0a 2020 2020 2020 2020 7769 7468  ')..        with
-0002eda0: 2070 7974 6573 742e 7261 6973 6573 280a   pytest.raises(.
-0002edb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002edc0: 736b 792e 6578 6365 7074 696f 6e73 2e53  sky.exceptions.S
-0002edd0: 746f 7261 6765 4275 636b 6574 4765 7445  torageBucketGetE
-0002ede0: 7272 6f72 2c0a 2020 2020 2020 2020 2020  rror,.          
-0002edf0: 2020 2020 2020 6d61 7463 683d 2741 7474        match='Att
-0002ee00: 656d 7074 6564 2074 6f20 7573 6520 6120  empted to use a 
-0002ee10: 6e6f 6e2d 6578 6973 7465 6e74 2062 7563  non-existent buc
-0002ee20: 6b65 7420 6173 2061 2073 6f75 7263 6527  ket as a source'
-0002ee30: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-0002ee40: 746f 7261 6765 5f6f 626a 203d 2073 746f  torage_obj = sto
-0002ee50: 7261 6765 5f6c 6962 2e53 746f 7261 6765  rage_lib.Storage
-0002ee60: 2873 6f75 7263 653d 6e6f 6e65 7869 7374  (source=nonexist
-0002ee70: 5f62 7563 6b65 745f 7572 6c2e 666f 726d  _bucket_url.form
-0002ee80: 6174 280a 2020 2020 2020 2020 2020 2020  at(.            
-0002ee90: 2020 2020 7261 6e64 6f6d 5f6e 616d 653d      random_name=
-0002eea0: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
-0002eeb0: 6e61 6d65 2929 0a0a 2020 2020 4070 7974  name))..    @pyt
-0002eec0: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
-0002eed0: 6473 7461 636b 0a20 2020 2040 7079 7465  dstack.    @pyte
-0002eee0: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
-0002eef0: 697a 6528 2770 7269 7661 7465 5f62 7563  ize('private_buc
-0002ef00: 6b65 7427 2c20 5b0a 2020 2020 2020 2020  ket', [.        
-0002ef10: 6627 7333 3a2f 2f69 6d61 6765 6e65 7427  f's3://imagenet'
-0002ef20: 2c20 6627 6773 3a2f 2f69 6d61 6765 6e65  , f'gs://imagene
-0002ef30: 7427 2c0a 2020 2020 2020 2020 7079 7465  t',.        pyte
-0002ef40: 7374 2e70 6172 616d 2827 636f 733a 2f2f  st.param('cos://
-0002ef50: 7573 2d65 6173 742f 6275 636b 6574 3127  us-east/bucket1'
-0002ef60: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
-0002ef70: 6172 6b2e 6962 6d29 0a20 2020 205d 290a  ark.ibm).    ]).
-0002ef80: 2020 2020 6465 6620 7465 7374 5f70 7269      def test_pri
-0002ef90: 7661 7465 5f62 7563 6b65 7428 7365 6c66  vate_bucket(self
-0002efa0: 2c20 7072 6976 6174 655f 6275 636b 6574  , private_bucket
-0002efb0: 293a 0a20 2020 2020 2020 2023 2041 7474  ):.        # Att
-0002efc0: 656d 7074 7320 746f 2061 6363 6573 7320  empts to access 
-0002efd0: 7072 6976 6174 6520 6275 636b 6574 7320  private buckets 
-0002efe0: 6e6f 7420 6265 6c6f 6e67 696e 6720 746f  not belonging to
-0002eff0: 2074 6865 2075 7365 722e 0a20 2020 2020   the user..     
-0002f000: 2020 2023 2054 6865 7365 2062 7563 6b65     # These bucke
-0002f010: 7473 2061 7265 206b 6e6f 776e 2074 6f20  ts are known to 
-0002f020: 6265 2070 7269 7661 7465 2c20 6275 7420  be private, but 
-0002f030: 6d61 7920 6e65 6564 2074 6f20 6265 2075  may need to be u
-0002f040: 7064 6174 6564 2069 660a 2020 2020 2020  pdated if.      
-0002f050: 2020 2320 7468 6579 2061 7265 2072 656d    # they are rem
-0002f060: 6f76 6564 2062 7920 7468 6569 7220 6f77  oved by their ow
-0002f070: 6e65 7273 2e0a 2020 2020 2020 2020 7072  ners..        pr
-0002f080: 6976 6174 655f 6275 636b 6574 5f6e 616d  ivate_bucket_nam
-0002f090: 6520 3d20 7572 6c6c 6962 2e70 6172 7365  e = urllib.parse
-0002f0a0: 2e75 726c 7370 6c69 7428 7072 6976 6174  .urlsplit(privat
-0002f0b0: 655f 6275 636b 6574 292e 6e65 746c 6f63  e_bucket).netloc
-0002f0c0: 2069 6620 5c0a 2020 2020 2020 2020 2020   if \.          
-0002f0d0: 2020 2020 7572 6c6c 6962 2e70 6172 7365      urllib.parse
-0002f0e0: 2e75 726c 7370 6c69 7428 7072 6976 6174  .urlsplit(privat
-0002f0f0: 655f 6275 636b 6574 292e 7363 6865 6d65  e_bucket).scheme
-0002f100: 2021 3d20 2763 6f73 2720 656c 7365 205c   != 'cos' else \
-0002f110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f120: 2020 2075 726c 6c69 622e 7061 7273 652e     urllib.parse.
-0002f130: 7572 6c73 706c 6974 2870 7269 7661 7465  urlsplit(private
-0002f140: 5f62 7563 6b65 7429 2e70 6174 682e 7374  _bucket).path.st
-0002f150: 7269 7028 272f 2729 0a20 2020 2020 2020  rip('/').       
-0002f160: 2077 6974 6820 7079 7465 7374 2e72 6169   with pytest.rai
-0002f170: 7365 7328 0a20 2020 2020 2020 2020 2020  ses(.           
-0002f180: 2020 2020 2073 6b79 2e65 7863 6570 7469       sky.excepti
-0002f190: 6f6e 732e 5374 6f72 6167 6542 7563 6b65  ons.StorageBucke
-0002f1a0: 7447 6574 4572 726f 722c 0a20 2020 2020  tGetError,.     
-0002f1b0: 2020 2020 2020 2020 2020 206d 6174 6368             match
-0002f1c0: 3d73 746f 7261 6765 5f6c 6962 2e5f 4255  =storage_lib._BU
-0002f1d0: 434b 4554 5f46 4149 4c5f 544f 5f43 4f4e  CKET_FAIL_TO_CON
-0002f1e0: 4e45 4354 5f4d 4553 5341 4745 2e66 6f72  NECT_MESSAGE.for
-0002f1f0: 6d61 7428 0a20 2020 2020 2020 2020 2020  mat(.           
-0002f200: 2020 2020 2020 2020 206e 616d 653d 7072           name=pr
-0002f210: 6976 6174 655f 6275 636b 6574 5f6e 616d  ivate_bucket_nam
-0002f220: 6529 293a 0a20 2020 2020 2020 2020 2020  e)):.           
-0002f230: 2073 746f 7261 6765 5f6f 626a 203d 2073   storage_obj = s
-0002f240: 746f 7261 6765 5f6c 6962 2e53 746f 7261  torage_lib.Stora
-0002f250: 6765 2873 6f75 7263 653d 7072 6976 6174  ge(source=privat
-0002f260: 655f 6275 636b 6574 290a 0a20 2020 2040  e_bucket)..    @
-0002f270: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
-0002f280: 6c75 6964 7374 6163 6b0a 2020 2020 4070  luidstack.    @p
-0002f290: 7974 6573 742e 6d61 726b 2e70 6172 616d  ytest.mark.param
-0002f2a0: 6574 7269 7a65 2827 6578 745f 6275 636b  etrize('ext_buck
-0002f2b0: 6574 5f66 6978 7475 7265 2c20 7374 6f72  et_fixture, stor
-0002f2c0: 655f 7479 7065 272c 0a20 2020 2020 2020  e_type',.       
-0002f2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f2e0: 2020 2020 2020 5b28 2774 6d70 5f61 7773        [('tmp_aws
-0002f2f0: 636c 695f 6275 636b 6574 272c 2073 746f  cli_bucket', sto
-0002f300: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-0002f310: 7065 2e53 3329 2c0a 2020 2020 2020 2020  pe.S3),.        
-0002f320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f330: 2020 2020 2020 2827 746d 705f 6773 7574        ('tmp_gsut
-0002f340: 696c 5f62 7563 6b65 7427 2c20 7374 6f72  il_bucket', stor
-0002f350: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0002f360: 652e 4743 5329 2c0a 2020 2020 2020 2020  e.GCS),.        
-0002f370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f380: 2020 2020 2020 7079 7465 7374 2e70 6172        pytest.par
-0002f390: 616d 2827 746d 705f 6962 6d5f 636f 735f  am('tmp_ibm_cos_
-0002f3a0: 6275 636b 6574 272c 0a20 2020 2020 2020  bucket',.       
-0002f3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f3d0: 2020 2020 7374 6f72 6167 655f 6c69 622e      storage_lib.
-0002f3e0: 5374 6f72 6554 7970 652e 4942 4d2c 0a20  StoreType.IBM,. 
-0002f3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f410: 2020 2020 2020 2020 2020 6d61 726b 733d            marks=
-0002f420: 7079 7465 7374 2e6d 6172 6b2e 6962 6d29  pytest.mark.ibm)
-0002f430: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002f440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f450: 7079 7465 7374 2e70 6172 616d 2827 746d  pytest.param('tm
-0002f460: 705f 6177 7363 6c69 5f62 7563 6b65 745f  p_awscli_bucket_
-0002f470: 7232 272c 0a20 2020 2020 2020 2020 2020  r2',.           
-0002f480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f4a0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002f4b0: 6554 7970 652e 5232 2c0a 2020 2020 2020  eType.R2,.      
-0002f4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f4e0: 2020 2020 206d 6172 6b73 3d70 7974 6573       marks=pytes
-0002f4f0: 742e 6d61 726b 2e63 6c6f 7564 666c 6172  t.mark.cloudflar
-0002f500: 6529 5d29 0a20 2020 2064 6566 2074 6573  e)]).    def tes
-0002f510: 745f 7570 6c6f 6164 5f74 6f5f 6578 6973  t_upload_to_exis
-0002f520: 7469 6e67 5f62 7563 6b65 7428 7365 6c66  ting_bucket(self
-0002f530: 2c20 6578 745f 6275 636b 6574 5f66 6978  , ext_bucket_fix
-0002f540: 7475 7265 2c20 7265 7175 6573 742c 0a20  ture, request,. 
-0002f550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b0d0: 2020 2020 2070 6572 7369 7374 656e 743d       persistent=
+0002b0e0: 7065 7273 6973 7465 6e74 2c0a 2020 2020  persistent,.    
+0002b0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b110: 2020 2020 2020 6d6f 6465 3d6d 6f64 6529        mode=mode)
+0002b120: 0a20 2020 2020 2020 2079 6965 6c64 2073  .        yield s
+0002b130: 746f 7261 6765 5f6f 626a 0a20 2020 2020  torage_obj.     
+0002b140: 2020 2068 616e 646c 6520 3d20 676c 6f62     handle = glob
+0002b150: 616c 5f75 7365 725f 7374 6174 652e 6765  al_user_state.ge
+0002b160: 745f 6861 6e64 6c65 5f66 726f 6d5f 7374  t_handle_from_st
+0002b170: 6f72 6167 655f 6e61 6d65 280a 2020 2020  orage_name(.    
+0002b180: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
+0002b190: 6f62 6a2e 6e61 6d65 290a 2020 2020 2020  obj.name).      
+0002b1a0: 2020 6966 2068 616e 646c 653a 0a20 2020    if handle:.   
+0002b1b0: 2020 2020 2020 2020 2023 2049 6620 6861           # If ha
+0002b1c0: 6e64 6c65 2065 7869 7374 732c 2064 656c  ndle exists, del
+0002b1d0: 6574 6520 6d61 6e75 616c 6c79 0a20 2020  ete manually.   
+0002b1e0: 2020 2020 2020 2020 2023 2054 4f44 4f28           # TODO(
+0002b1f0: 726f 6d69 6c62 293a 2054 6869 7320 6973  romilb): This is
+0002b200: 2070 6f74 656e 7469 616c 6c79 2072 6973   potentially ris
+0002b210: 6b79 202d 2069 6620 7468 6520 6465 6c65  ky - if the dele
+0002b220: 7465 206d 6574 686f 6420 6861 730a 2020  te method has.  
+0002b230: 2020 2020 2020 2020 2020 2320 2020 6275            #   bu
+0002b240: 6773 2c20 7468 6973 2063 616e 2063 6175  gs, this can cau
+0002b250: 7365 2072 6573 6f75 7263 6520 6c65 616b  se resource leak
+0002b260: 732e 2049 6465 616c 6c79 2077 6520 7368  s. Ideally we sh
+0002b270: 6f75 6c64 206d 616e 7561 6c6c 790a 2020  ould manually.  
+0002b280: 2020 2020 2020 2020 2020 2320 2020 656a            #   ej
+0002b290: 6563 7420 7374 6f72 6167 6520 6672 6f6d  ect storage from
+0002b2a0: 2067 6c6f 6261 6c5f 7573 6572 5f73 7461   global_user_sta
+0002b2b0: 7465 2061 6e64 2064 656c 6574 6520 7468  te and delete th
+0002b2c0: 6520 6275 636b 6574 2075 7369 6e67 0a20  e bucket using. 
+0002b2d0: 2020 2020 2020 2020 2020 2023 2020 2062             #   b
+0002b2e0: 6f74 6f33 2064 6972 6563 746c 792e 0a20  oto3 directly.. 
+0002b2f0: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+0002b300: 6765 5f6f 626a 2e64 656c 6574 6528 290a  ge_obj.delete().
+0002b310: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
+0002b320: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
+0002b330: 5f73 6372 6174 6368 5f73 746f 7261 6765  _scratch_storage
+0002b340: 5f6f 626a 2873 656c 662c 2074 6d70 5f62  _obj(self, tmp_b
+0002b350: 7563 6b65 745f 6e61 6d65 293a 0a20 2020  ucket_name):.   
+0002b360: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
+0002b370: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
+0002b380: 7769 7468 206e 6f20 736f 7572 6365 2074  with no source t
+0002b390: 6f20 6372 6561 7465 2061 2073 6372 6174  o create a scrat
+0002b3a0: 6368 2073 746f 7261 6765 2e0a 2020 2020  ch storage..    
+0002b3b0: 2020 2020 2320 5374 6f72 6573 206d 7573      # Stores mus
+0002b3c0: 7420 6265 2061 6464 6564 2069 6e20 7468  t be added in th
+0002b3d0: 6520 7465 7374 2e0a 2020 2020 2020 2020  e test..        
+0002b3e0: 7969 656c 6420 6672 6f6d 2073 656c 662e  yield from self.
+0002b3f0: 7969 656c 645f 7374 6f72 6167 655f 6f62  yield_storage_ob
+0002b400: 6a65 6374 286e 616d 653d 746d 705f 6275  ject(name=tmp_bu
+0002b410: 636b 6574 5f6e 616d 6529 0a0a 2020 2020  cket_name)..    
+0002b420: 4070 7974 6573 742e 6669 7874 7572 650a  @pytest.fixture.
+0002b430: 2020 2020 6465 6620 746d 705f 6d75 6c74      def tmp_mult
+0002b440: 6970 6c65 5f73 6372 6174 6368 5f73 746f  iple_scratch_sto
+0002b450: 7261 6765 5f6f 626a 2873 656c 6629 3a0a  rage_obj(self):.
+0002b460: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
+0002b470: 7320 6120 6c69 7374 206f 6620 3520 7374  s a list of 5 st
+0002b480: 6f72 6167 6520 6f62 6a65 6374 7320 7769  orage objects wi
+0002b490: 7468 206e 6f20 736f 7572 6365 2074 6f20  th no source to 
+0002b4a0: 6372 6561 7465 0a20 2020 2020 2020 2023  create.        #
+0002b4b0: 206d 756c 7469 706c 6520 7363 7261 7463   multiple scratc
+0002b4c0: 6820 7374 6f72 6167 6573 2e0a 2020 2020  h storages..    
+0002b4d0: 2020 2020 2320 5374 6f72 6573 2066 6f72      # Stores for
+0002b4e0: 2065 6163 6820 6f62 6a65 6374 2069 6e20   each object in 
+0002b4f0: 7468 6520 6c69 7374 206d 7573 7420 6265  the list must be
+0002b500: 2061 6464 6564 2069 6e20 7468 6520 7465   added in the te
+0002b510: 7374 2e0a 2020 2020 2020 2020 7374 6f72  st..        stor
+0002b520: 6167 655f 6d75 6c74 5f6f 626a 203d 205b  age_mult_obj = [
+0002b530: 5d0a 2020 2020 2020 2020 666f 7220 5f20  ].        for _ 
+0002b540: 696e 2072 616e 6765 2835 293a 0a20 2020  in range(5):.   
+0002b550: 2020 2020 2020 2020 2074 696d 6573 7461           timesta
+0002b560: 6d70 203d 2073 7472 2874 696d 652e 7469  mp = str(time.ti
+0002b570: 6d65 2829 292e 7265 706c 6163 6528 272e  me()).replace('.
+0002b580: 272c 2027 2729 0a20 2020 2020 2020 2020  ', '').         
+0002b590: 2020 2073 746f 7265 5f6f 626a 203d 2073     store_obj = s
+0002b5a0: 746f 7261 6765 5f6c 6962 2e53 746f 7261  torage_lib.Stora
+0002b5b0: 6765 286e 616d 653d 6627 736b 792d 7465  ge(name=f'sky-te
+0002b5c0: 7374 2d7b 7469 6d65 7374 616d 707d 2729  st-{timestamp}')
+0002b5d0: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
+0002b5e0: 7261 6765 5f6d 756c 745f 6f62 6a2e 6170  rage_mult_obj.ap
+0002b5f0: 7065 6e64 2873 746f 7265 5f6f 626a 290a  pend(store_obj).
+0002b600: 2020 2020 2020 2020 7969 656c 6420 7374          yield st
+0002b610: 6f72 6167 655f 6d75 6c74 5f6f 626a 0a20  orage_mult_obj. 
+0002b620: 2020 2020 2020 2066 6f72 2073 746f 7261         for stora
+0002b630: 6765 5f6f 626a 2069 6e20 7374 6f72 6167  ge_obj in storag
+0002b640: 655f 6d75 6c74 5f6f 626a 3a0a 2020 2020  e_mult_obj:.    
+0002b650: 2020 2020 2020 2020 6861 6e64 6c65 203d          handle =
+0002b660: 2067 6c6f 6261 6c5f 7573 6572 5f73 7461   global_user_sta
+0002b670: 7465 2e67 6574 5f68 616e 646c 655f 6672  te.get_handle_fr
+0002b680: 6f6d 5f73 746f 7261 6765 5f6e 616d 6528  om_storage_name(
+0002b690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b6a0: 2073 746f 7261 6765 5f6f 626a 2e6e 616d   storage_obj.nam
+0002b6b0: 6529 0a20 2020 2020 2020 2020 2020 2069  e).            i
+0002b6c0: 6620 6861 6e64 6c65 3a0a 2020 2020 2020  f handle:.      
+0002b6d0: 2020 2020 2020 2020 2020 2320 4966 2068            # If h
+0002b6e0: 616e 646c 6520 6578 6973 7473 2c20 6465  andle exists, de
+0002b6f0: 6c65 7465 206d 616e 7561 6c6c 790a 2020  lete manually.  
+0002b700: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0002b710: 544f 444f 2872 6f6d 696c 6229 3a20 5468  TODO(romilb): Th
+0002b720: 6973 2069 7320 706f 7465 6e74 6961 6c6c  is is potentiall
+0002b730: 7920 7269 736b 7920 2d20 6966 2074 6865  y risky - if the
+0002b740: 2064 656c 6574 6520 6d65 7468 6f64 2068   delete method h
+0002b750: 6173 0a20 2020 2020 2020 2020 2020 2020  as.             
+0002b760: 2020 2023 2062 7567 732c 2074 6869 7320     # bugs, this 
+0002b770: 6361 6e20 6361 7573 6520 7265 736f 7572  can cause resour
+0002b780: 6365 206c 6561 6b73 2e20 4964 6561 6c6c  ce leaks. Ideall
+0002b790: 7920 7765 2073 686f 756c 6420 6d61 6e75  y we should manu
+0002b7a0: 616c 6c79 0a20 2020 2020 2020 2020 2020  ally.           
+0002b7b0: 2020 2020 2023 2065 6a65 6374 2073 746f       # eject sto
+0002b7c0: 7261 6765 2066 726f 6d20 676c 6f62 616c  rage from global
+0002b7d0: 5f75 7365 725f 7374 6174 6520 616e 6420  _user_state and 
+0002b7e0: 6465 6c65 7465 2074 6865 2062 7563 6b65  delete the bucke
+0002b7f0: 7420 7573 696e 670a 2020 2020 2020 2020  t using.        
+0002b800: 2020 2020 2020 2020 2320 626f 746f 3320          # boto3 
+0002b810: 6469 7265 6374 6c79 2e0a 2020 2020 2020  directly..      
+0002b820: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+0002b830: 655f 6f62 6a2e 6465 6c65 7465 2829 0a0a  e_obj.delete()..
+0002b840: 2020 2020 4070 7974 6573 742e 6669 7874      @pytest.fixt
+0002b850: 7572 650a 2020 2020 6465 6620 746d 705f  ure.    def tmp_
+0002b860: 6d75 6c74 6970 6c65 5f63 7573 746f 6d5f  multiple_custom_
+0002b870: 736f 7572 6365 5f73 746f 7261 6765 5f6f  source_storage_o
+0002b880: 626a 2873 656c 6629 3a0a 2020 2020 2020  bj(self):.      
+0002b890: 2020 2320 4372 6561 7465 7320 6120 6c69    # Creates a li
+0002b8a0: 7374 206f 6620 7374 6f72 6167 6520 6f62  st of storage ob
+0002b8b0: 6a65 6374 7320 7769 7468 2063 7573 746f  jects with custo
+0002b8c0: 6d20 736f 7572 6365 206e 616d 6573 2074  m source names t
+0002b8d0: 6f0a 2020 2020 2020 2020 2320 6372 6561  o.        # crea
+0002b8e0: 7465 206d 756c 7469 706c 6520 7363 7261  te multiple scra
+0002b8f0: 7463 6820 7374 6f72 6167 6573 2e0a 2020  tch storages..  
+0002b900: 2020 2020 2020 2320 5374 6f72 6573 2066        # Stores f
+0002b910: 6f72 2065 6163 6820 6f62 6a65 6374 2069  or each object i
+0002b920: 6e20 7468 6520 6c69 7374 206d 7573 7420  n the list must 
+0002b930: 6265 2061 6464 6564 2069 6e20 7468 6520  be added in the 
+0002b940: 7465 7374 2e0a 2020 2020 2020 2020 6375  test..        cu
+0002b950: 7374 6f6d 5f73 6f75 7263 655f 6e61 6d65  stom_source_name
+0002b960: 7320 3d20 5b27 2270 6174 6820 5769 7468  s = ['"path With
+0002b970: 2053 7061 6365 7322 272c 2027 7061 7468   Spaces"', 'path
+0002b980: 2057 6974 6820 5370 6163 6573 275d 0a20   With Spaces']. 
+0002b990: 2020 2020 2020 2073 746f 7261 6765 5f6d         storage_m
+0002b9a0: 756c 745f 6f62 6a20 3d20 5b5d 0a20 2020  ult_obj = [].   
+0002b9b0: 2020 2020 2066 6f72 206e 616d 6520 696e       for name in
+0002b9c0: 2063 7573 746f 6d5f 736f 7572 6365 5f6e   custom_source_n
+0002b9d0: 616d 6573 3a0a 2020 2020 2020 2020 2020  ames:.          
+0002b9e0: 2020 7372 635f 7061 7468 203d 206f 732e    src_path = os.
+0002b9f0: 7061 7468 2e65 7870 616e 6475 7365 7228  path.expanduser(
+0002ba00: 6627 7e2f 7b6e 616d 657d 2729 0a20 2020  f'~/{name}').   
+0002ba10: 2020 2020 2020 2020 2070 6174 686c 6962           pathlib
+0002ba20: 2e50 6174 6828 7372 635f 7061 7468 292e  .Path(src_path).
+0002ba30: 6578 7061 6e64 7573 6572 2829 2e6d 6b64  expanduser().mkd
+0002ba40: 6972 2865 7869 7374 5f6f 6b3d 5472 7565  ir(exist_ok=True
+0002ba50: 290a 2020 2020 2020 2020 2020 2020 7469  ).            ti
+0002ba60: 6d65 7374 616d 7020 3d20 7374 7228 7469  mestamp = str(ti
+0002ba70: 6d65 2e74 696d 6528 2929 2e72 6570 6c61  me.time()).repla
+0002ba80: 6365 2827 2e27 2c20 2727 290a 2020 2020  ce('.', '').    
+0002ba90: 2020 2020 2020 2020 7374 6f72 655f 6f62          store_ob
+0002baa0: 6a20 3d20 7374 6f72 6167 655f 6c69 622e  j = storage_lib.
+0002bab0: 5374 6f72 6167 6528 6e61 6d65 3d66 2773  Storage(name=f's
+0002bac0: 6b79 2d74 6573 742d 7b74 696d 6573 7461  ky-test-{timesta
+0002bad0: 6d70 7d27 2c0a 2020 2020 2020 2020 2020  mp}',.          
+0002bae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002baf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bb00: 2020 736f 7572 6365 3d73 7263 5f70 6174    source=src_pat
+0002bb10: 6829 0a20 2020 2020 2020 2020 2020 2073  h).            s
+0002bb20: 746f 7261 6765 5f6d 756c 745f 6f62 6a2e  torage_mult_obj.
+0002bb30: 6170 7065 6e64 2873 746f 7265 5f6f 626a  append(store_obj
+0002bb40: 290a 2020 2020 2020 2020 7969 656c 6420  ).        yield 
+0002bb50: 7374 6f72 6167 655f 6d75 6c74 5f6f 626a  storage_mult_obj
+0002bb60: 0a20 2020 2020 2020 2066 6f72 2073 746f  .        for sto
+0002bb70: 7261 6765 5f6f 626a 2069 6e20 7374 6f72  rage_obj in stor
+0002bb80: 6167 655f 6d75 6c74 5f6f 626a 3a0a 2020  age_mult_obj:.  
+0002bb90: 2020 2020 2020 2020 2020 6861 6e64 6c65            handle
+0002bba0: 203d 2067 6c6f 6261 6c5f 7573 6572 5f73   = global_user_s
+0002bbb0: 7461 7465 2e67 6574 5f68 616e 646c 655f  tate.get_handle_
+0002bbc0: 6672 6f6d 5f73 746f 7261 6765 5f6e 616d  from_storage_nam
+0002bbd0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+0002bbe0: 2020 2073 746f 7261 6765 5f6f 626a 2e6e     storage_obj.n
+0002bbf0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+0002bc00: 2069 6620 6861 6e64 6c65 3a0a 2020 2020   if handle:.    
+0002bc10: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+0002bc20: 6167 655f 6f62 6a2e 6465 6c65 7465 2829  age_obj.delete()
+0002bc30: 0a0a 2020 2020 4070 7974 6573 742e 6669  ..    @pytest.fi
+0002bc40: 7874 7572 650a 2020 2020 6465 6620 746d  xture.    def tm
+0002bc50: 705f 6c6f 6361 6c5f 7374 6f72 6167 655f  p_local_storage_
+0002bc60: 6f62 6a28 7365 6c66 2c20 746d 705f 6275  obj(self, tmp_bu
+0002bc70: 636b 6574 5f6e 616d 652c 2074 6d70 5f73  cket_name, tmp_s
+0002bc80: 6f75 7263 6529 3a0a 2020 2020 2020 2020  ource):.        
+0002bc90: 2320 4372 6561 7465 7320 6120 7465 6d70  # Creates a temp
+0002bca0: 6f72 6172 7920 7374 6f72 6167 6520 6f62  orary storage ob
+0002bcb0: 6a65 6374 2e20 5374 6f72 6573 206d 7573  ject. Stores mus
+0002bcc0: 7420 6265 2061 6464 6564 2069 6e20 7468  t be added in th
+0002bcd0: 6520 7465 7374 2e0a 2020 2020 2020 2020  e test..        
+0002bce0: 7969 656c 6420 6672 6f6d 2073 656c 662e  yield from self.
+0002bcf0: 7969 656c 645f 7374 6f72 6167 655f 6f62  yield_storage_ob
+0002bd00: 6a65 6374 286e 616d 653d 746d 705f 6275  ject(name=tmp_bu
+0002bd10: 636b 6574 5f6e 616d 652c 0a20 2020 2020  cket_name,.     
+0002bd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bd40: 2020 2020 2020 2020 736f 7572 6365 3d74          source=t
+0002bd50: 6d70 5f73 6f75 7263 6529 0a0a 2020 2020  mp_source)..    
+0002bd60: 4070 7974 6573 742e 6669 7874 7572 650a  @pytest.fixture.
+0002bd70: 2020 2020 6465 6620 746d 705f 6c6f 6361      def tmp_loca
+0002bd80: 6c5f 6c69 7374 5f73 746f 7261 6765 5f6f  l_list_storage_o
+0002bd90: 626a 2873 656c 662c 2074 6d70 5f62 7563  bj(self, tmp_buc
+0002bda0: 6b65 745f 6e61 6d65 2c20 746d 705f 736f  ket_name, tmp_so
+0002bdb0: 7572 6365 293a 0a20 2020 2020 2020 2023  urce):.        #
+0002bdc0: 2043 7265 6174 6573 2061 2074 656d 7020   Creates a temp 
+0002bdd0: 7374 6f72 6167 6520 6f62 6a65 6374 2077  storage object w
+0002bde0: 6869 6368 2075 7365 7320 6120 6c69 7374  hich uses a list
+0002bdf0: 206f 6620 7061 7468 7320 6173 2073 6f75   of paths as sou
+0002be00: 7263 652e 0a20 2020 2020 2020 2023 2053  rce..        # S
+0002be10: 746f 7265 7320 6d75 7374 2062 6520 6164  tores must be ad
+0002be20: 6465 6420 696e 2074 6865 2074 6573 742e  ded in the test.
+0002be30: 2041 6674 6572 2075 706c 6f61 642c 2074   After upload, t
+0002be40: 6865 2062 7563 6b65 7420 7368 6f75 6c64  he bucket should
+0002be50: 0a20 2020 2020 2020 2023 2068 6176 6520  .        # have 
+0002be60: 7477 6f20 6669 6c65 7320 2d20 2f74 6d70  two files - /tmp
+0002be70: 2d66 696c 6520 616e 6420 2f74 6d70 2d73  -file and /tmp-s
+0002be80: 6f75 7263 652f 746d 702d 6669 6c65 0a20  ource/tmp-file. 
+0002be90: 2020 2020 2020 206c 6973 745f 736f 7572         list_sour
+0002bea0: 6365 203d 205b 746d 705f 736f 7572 6365  ce = [tmp_source
+0002beb0: 2c20 746d 705f 736f 7572 6365 202b 2027  , tmp_source + '
+0002bec0: 2f74 6d70 2d66 696c 6527 5d0a 2020 2020  /tmp-file'].    
+0002bed0: 2020 2020 7969 656c 6420 6672 6f6d 2073      yield from s
+0002bee0: 656c 662e 7969 656c 645f 7374 6f72 6167  elf.yield_storag
+0002bef0: 655f 6f62 6a65 6374 286e 616d 653d 746d  e_object(name=tm
+0002bf00: 705f 6275 636b 6574 5f6e 616d 652c 0a20  p_bucket_name,. 
+0002bf10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bf30: 2020 2020 2020 2020 2020 2020 736f 7572              sour
+0002bf40: 6365 3d6c 6973 745f 736f 7572 6365 290a  ce=list_source).
+0002bf50: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
+0002bf60: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
+0002bf70: 5f62 756c 6b5f 6465 6c5f 7374 6f72 6167  _bulk_del_storag
+0002bf80: 655f 6f62 6a28 7365 6c66 2c20 746d 705f  e_obj(self, tmp_
+0002bf90: 6275 636b 6574 5f6e 616d 6529 3a0a 2020  bucket_name):.  
+0002bfa0: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
+0002bfb0: 6120 7465 6d70 6f72 6172 7920 7374 6f72  a temporary stor
+0002bfc0: 6167 6520 6f62 6a65 6374 2066 6f72 2074  age object for t
+0002bfd0: 6573 7469 6e67 2062 756c 6b20 6465 6c65  esting bulk dele
+0002bfe0: 7469 6f6e 2e0a 2020 2020 2020 2020 2320  tion..        # 
+0002bff0: 5374 6f72 6573 206d 7573 7420 6265 2061  Stores must be a
+0002c000: 6464 6564 2069 6e20 7468 6520 7465 7374  dded in the test
+0002c010: 2e0a 2020 2020 2020 2020 7769 7468 2074  ..        with t
+0002c020: 656d 7066 696c 652e 5465 6d70 6f72 6172  empfile.Temporar
+0002c030: 7944 6972 6563 746f 7279 2829 2061 7320  yDirectory() as 
+0002c040: 746d 7064 6972 3a0a 2020 2020 2020 2020  tmpdir:.        
+0002c050: 2020 2020 7375 6270 726f 6365 7373 2e63      subprocess.c
+0002c060: 6865 636b 5f6f 7574 7075 7428 6627 6d6b  heck_output(f'mk
+0002c070: 6469 7220 2d70 207b 746d 7064 6972 7d2f  dir -p {tmpdir}/
+0002c080: 666f 6c64 6572 7b7b 3030 302e 2e32 3535  folder{{000..255
+0002c090: 7d7d 272c 0a20 2020 2020 2020 2020 2020  }}',.           
+0002c0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c0b0: 2020 2020 2020 2020 2073 6865 6c6c 3d54           shell=T
+0002c0c0: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
+0002c0d0: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+0002c0e0: 6b5f 6f75 7470 7574 2866 2774 6f75 6368  k_output(f'touch
+0002c0f0: 207b 746d 7064 6972 7d2f 7465 7374 7b7b   {tmpdir}/test{{
+0002c100: 3030 302e 2e32 3535 7d7d 2e74 7874 272c  000..255}}.txt',
+0002c110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002c120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c130: 2020 2020 2073 6865 6c6c 3d54 7275 6529       shell=True)
+0002c140: 0a20 2020 2020 2020 2020 2020 2073 7562  .            sub
+0002c150: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
+0002c160: 7470 7574 280a 2020 2020 2020 2020 2020  tput(.          
+0002c170: 2020 2020 2020 6627 746f 7563 6820 7b74        f'touch {t
+0002c180: 6d70 6469 727d 2f66 6f6c 6465 727b 7b30  mpdir}/folder{{0
+0002c190: 3030 2e2e 3235 357d 7d2f 7465 7374 2e74  00..255}}/test.t
+0002c1a0: 7874 272c 2073 6865 6c6c 3d54 7275 6529  xt', shell=True)
+0002c1b0: 0a20 2020 2020 2020 2020 2020 2079 6965  .            yie
+0002c1c0: 6c64 2066 726f 6d20 7365 6c66 2e79 6965  ld from self.yie
+0002c1d0: 6c64 5f73 746f 7261 6765 5f6f 626a 6563  ld_storage_objec
+0002c1e0: 7428 6e61 6d65 3d74 6d70 5f62 7563 6b65  t(name=tmp_bucke
+0002c1f0: 745f 6e61 6d65 2c0a 2020 2020 2020 2020  t_name,.        
+0002c200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c220: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
+0002c230: 746d 7064 6972 290a 0a20 2020 2040 7079  tmpdir)..    @py
+0002c240: 7465 7374 2e66 6978 7475 7265 0a20 2020  test.fixture.   
+0002c250: 2064 6566 2074 6d70 5f63 6f70 795f 6d6e   def tmp_copy_mn
+0002c260: 745f 6578 6973 7469 6e67 5f73 746f 7261  t_existing_stora
+0002c270: 6765 5f6f 626a 2873 656c 662c 2074 6d70  ge_obj(self, tmp
+0002c280: 5f73 6372 6174 6368 5f73 746f 7261 6765  _scratch_storage
+0002c290: 5f6f 626a 293a 0a20 2020 2020 2020 2023  _obj):.        #
+0002c2a0: 2043 7265 6174 6573 2061 2063 6f70 7920   Creates a copy 
+0002c2b0: 6d6f 756e 7420 7374 6f72 6167 6520 7768  mount storage wh
+0002c2c0: 6963 6820 7265 7573 6573 2061 6e20 6578  ich reuses an ex
+0002c2d0: 6973 7469 6e67 2073 746f 7261 6765 206f  isting storage o
+0002c2e0: 626a 6563 742e 0a20 2020 2020 2020 2074  bject..        t
+0002c2f0: 6d70 5f73 6372 6174 6368 5f73 746f 7261  mp_scratch_stora
+0002c300: 6765 5f6f 626a 2e61 6464 5f73 746f 7265  ge_obj.add_store
+0002c310: 2873 746f 7261 6765 5f6c 6962 2e53 746f  (storage_lib.Sto
+0002c320: 7265 5479 7065 2e53 3329 0a20 2020 2020  reType.S3).     
+0002c330: 2020 2073 746f 7261 6765 5f6e 616d 6520     storage_name 
+0002c340: 3d20 746d 705f 7363 7261 7463 685f 7374  = tmp_scratch_st
+0002c350: 6f72 6167 655f 6f62 6a2e 6e61 6d65 0a0a  orage_obj.name..
+0002c360: 2020 2020 2020 2020 2320 5472 7920 746f          # Try to
+0002c370: 2069 6e69 7469 616c 697a 6520 616e 6f74   initialize anot
+0002c380: 6865 7220 7374 6f72 6167 6520 7769 7468  her storage with
+0002c390: 2074 6865 2073 746f 7261 6765 206f 626a   the storage obj
+0002c3a0: 6563 7420 6372 6561 7465 640a 2020 2020  ect created.    
+0002c3b0: 2020 2020 2320 6162 6f76 652c 2062 7574      # above, but
+0002c3c0: 206e 6f77 2069 6e20 434f 5059 206d 6f64   now in COPY mod
+0002c3d0: 652e 2054 6869 7320 7368 6f75 6c64 2073  e. This should s
+0002c3e0: 7563 6365 6564 2e0a 2020 2020 2020 2020  ucceed..        
+0002c3f0: 7969 656c 6420 6672 6f6d 2073 656c 662e  yield from self.
+0002c400: 7969 656c 645f 7374 6f72 6167 655f 6f62  yield_storage_ob
+0002c410: 6a65 6374 286e 616d 653d 7374 6f72 6167  ject(name=storag
+0002c420: 655f 6e61 6d65 2c0a 2020 2020 2020 2020  e_name,.        
+0002c430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c450: 2020 2020 206d 6f64 653d 7374 6f72 6167       mode=storag
+0002c460: 655f 6c69 622e 5374 6f72 6167 654d 6f64  e_lib.StorageMod
+0002c470: 652e 434f 5059 290a 0a20 2020 2040 7079  e.COPY)..    @py
+0002c480: 7465 7374 2e66 6978 7475 7265 0a20 2020  test.fixture.   
+0002c490: 2064 6566 2074 6d70 5f67 6974 6967 6e6f   def tmp_gitigno
+0002c4a0: 7265 5f73 746f 7261 6765 5f6f 626a 2873  re_storage_obj(s
+0002c4b0: 656c 662c 2074 6d70 5f62 7563 6b65 745f  elf, tmp_bucket_
+0002c4c0: 6e61 6d65 2c20 6769 7469 676e 6f72 655f  name, gitignore_
+0002c4d0: 7374 7275 6374 7572 6529 3a0a 2020 2020  structure):.    
+0002c4e0: 2020 2020 2320 4372 6561 7465 7320 6120      # Creates a 
+0002c4f0: 7465 6d70 6f72 6172 7920 7374 6f72 6167  temporary storag
+0002c500: 6520 6f62 6a65 6374 2066 6f72 2074 6573  e object for tes
+0002c510: 7469 6e67 202e 6769 7469 676e 6f72 6520  ting .gitignore 
+0002c520: 6669 6c74 6572 2e0a 2020 2020 2020 2020  filter..        
+0002c530: 2320 4749 5449 4749 4e4f 5245 5f53 5452  # GITIGINORE_STR
+0002c540: 5543 5455 5245 2069 7320 7265 7072 6573  UCTURE is repres
+0002c550: 656e 7469 6e67 2061 2066 696c 6520 7374  enting a file st
+0002c560: 7275 6374 7572 6520 696e 2061 2064 6963  ructure in a dic
+0002c570: 7469 6f6e 6172 790a 2020 2020 2020 2020  tionary.        
+0002c580: 2320 666f 726d 6174 2e20 4372 6561 7465  # format. Create
+0002c590: 6420 7374 6f72 6167 6520 6f62 6a65 6374  d storage object
+0002c5a0: 2077 696c 6c20 636f 6e74 6169 6e20 7468   will contain th
+0002c5b0: 6520 6669 6c65 2073 7472 7563 7475 7265  e file structure
+0002c5c0: 2061 6c6f 6e67 0a20 2020 2020 2020 2023   along.        #
+0002c5d0: 2077 6974 6820 2e67 6974 6967 6e6f 7265   with .gitignore
+0002c5e0: 2061 6e64 202e 6769 742f 696e 666f 2f65   and .git/info/e
+0002c5f0: 7863 6c75 6465 2066 696c 6573 2074 6f20  xclude files to 
+0002c600: 7465 7374 2065 7863 6c75 6465 2066 696c  test exclude fil
+0002c610: 7465 722e 0a20 2020 2020 2020 2023 2053  ter..        # S
+0002c620: 746f 7265 7320 6d75 7374 2062 6520 6164  tores must be ad
+0002c630: 6465 6420 696e 2074 6865 2074 6573 742e  ded in the test.
+0002c640: 0a20 2020 2020 2020 2077 6974 6820 7465  .        with te
+0002c650: 6d70 6669 6c65 2e54 656d 706f 7261 7279  mpfile.Temporary
+0002c660: 4469 7265 6374 6f72 7928 2920 6173 2074  Directory() as t
+0002c670: 6d70 6469 723a 0a20 2020 2020 2020 2020  mpdir:.         
+0002c680: 2020 2023 2043 7265 6174 6573 2066 696c     # Creates fil
+0002c690: 6520 7374 7275 6374 7572 6520 746f 2062  e structure to b
+0002c6a0: 6520 7570 6c6f 6164 6564 2069 6e20 7468  e uploaded in th
+0002c6b0: 6520 5374 6f72 6167 650a 2020 2020 2020  e Storage.      
+0002c6c0: 2020 2020 2020 7365 6c66 2e63 7265 6174        self.creat
+0002c6d0: 655f 6469 725f 7374 7275 6374 7572 6528  e_dir_structure(
+0002c6e0: 746d 7064 6972 2c20 6769 7469 676e 6f72  tmpdir, gitignor
+0002c6f0: 655f 7374 7275 6374 7572 6529 0a0a 2020  e_structure)..  
+0002c700: 2020 2020 2020 2020 2020 2320 4372 6561            # Crea
+0002c710: 7465 202e 6769 7469 676e 6f72 6520 616e  te .gitignore an
+0002c720: 6420 6c69 7374 2066 696c 6573 2f64 6972  d list files/dir
+0002c730: 7320 746f 2062 6520 6578 636c 7564 6564  s to be excluded
+0002c740: 2069 6e20 6974 0a20 2020 2020 2020 2020   in it.         
+0002c750: 2020 2073 6b79 7069 6c6f 745f 7061 7468     skypilot_path
+0002c760: 203d 206f 732e 7061 7468 2e64 6972 6e61   = os.path.dirna
+0002c770: 6d65 286f 732e 7061 7468 2e64 6972 6e61  me(os.path.dirna
+0002c780: 6d65 2873 6b79 2e5f 5f66 696c 655f 5f29  me(sky.__file__)
+0002c790: 290a 2020 2020 2020 2020 2020 2020 7465  ).            te
+0002c7a0: 6d70 5f70 6174 6820 3d20 6627 7b74 6d70  mp_path = f'{tmp
+0002c7b0: 6469 727d 2f2e 6769 7469 676e 6f72 6527  dir}/.gitignore'
+0002c7c0: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
+0002c7d0: 655f 7061 7468 203d 206f 732e 7061 7468  e_path = os.path
+0002c7e0: 2e6a 6f69 6e28 736b 7970 696c 6f74 5f70  .join(skypilot_p
+0002c7f0: 6174 682c 2027 7465 7374 732f 6769 7469  ath, 'tests/giti
+0002c800: 676e 6f72 655f 7465 7374 2729 0a20 2020  gnore_test').   
+0002c810: 2020 2020 2020 2020 2073 6875 7469 6c2e           shutil.
+0002c820: 636f 7079 6669 6c65 2866 696c 655f 7061  copyfile(file_pa
+0002c830: 7468 2c20 7465 6d70 5f70 6174 6829 0a0a  th, temp_path)..
+0002c840: 2020 2020 2020 2020 2020 2020 2320 4372              # Cr
+0002c850: 6561 7465 202e 6769 742f 696e 666f 2f65  eate .git/info/e
+0002c860: 7863 6c75 6465 2061 6e64 206c 6973 7420  xclude and list 
+0002c870: 6669 6c65 732f 6469 7273 2074 6f20 6265  files/dirs to be
+0002c880: 2065 7863 6c75 6465 6420 696e 2069 740a   excluded in it.
+0002c890: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
+0002c8a0: 5f70 6174 6820 3d20 6627 7b74 6d70 6469  _path = f'{tmpdi
+0002c8b0: 727d 2f2e 6769 742f 696e 666f 2f27 0a20  r}/.git/info/'. 
+0002c8c0: 2020 2020 2020 2020 2020 206f 732e 6d61             os.ma
+0002c8d0: 6b65 6469 7273 2874 656d 705f 7061 7468  kedirs(temp_path
+0002c8e0: 290a 2020 2020 2020 2020 2020 2020 7465  ).            te
+0002c8f0: 6d70 5f65 7863 6c75 6465 5f70 6174 6820  mp_exclude_path 
+0002c900: 3d20 6f73 2e70 6174 682e 6a6f 696e 2874  = os.path.join(t
+0002c910: 656d 705f 7061 7468 2c20 2765 7863 6c75  emp_path, 'exclu
+0002c920: 6465 2729 0a20 2020 2020 2020 2020 2020  de').           
+0002c930: 2066 696c 655f 7061 7468 203d 206f 732e   file_path = os.
+0002c940: 7061 7468 2e6a 6f69 6e28 736b 7970 696c  path.join(skypil
+0002c950: 6f74 5f70 6174 682c 0a20 2020 2020 2020  ot_path,.       
+0002c960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c970: 2020 2020 2020 2020 2020 2020 2020 2774                't
+0002c980: 6573 7473 2f67 6974 5f69 6e66 6f5f 6578  ests/git_info_ex
+0002c990: 636c 7564 655f 7465 7374 2729 0a20 2020  clude_test').   
+0002c9a0: 2020 2020 2020 2020 2073 6875 7469 6c2e           shutil.
+0002c9b0: 636f 7079 6669 6c65 2866 696c 655f 7061  copyfile(file_pa
+0002c9c0: 7468 2c20 7465 6d70 5f65 7863 6c75 6465  th, temp_exclude
+0002c9d0: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
+0002c9e0: 2020 2020 2320 4372 6561 7465 2073 6b79      # Create sky
+0002c9f0: 2053 746f 7261 6765 2077 6974 6820 7468   Storage with th
+0002ca00: 6520 6669 6c65 7320 6372 6561 7465 640a  e files created.
+0002ca10: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
+0002ca20: 6420 6672 6f6d 2073 656c 662e 7969 656c  d from self.yiel
+0002ca30: 645f 7374 6f72 6167 655f 6f62 6a65 6374  d_storage_object
+0002ca40: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002ca50: 2020 6e61 6d65 3d74 6d70 5f62 7563 6b65    name=tmp_bucke
+0002ca60: 745f 6e61 6d65 2c0a 2020 2020 2020 2020  t_name,.        
+0002ca70: 2020 2020 2020 2020 736f 7572 6365 3d74          source=t
+0002ca80: 6d70 6469 722c 0a20 2020 2020 2020 2020  mpdir,.         
+0002ca90: 2020 2020 2020 206d 6f64 653d 7374 6f72         mode=stor
+0002caa0: 6167 655f 6c69 622e 5374 6f72 6167 654d  age_lib.StorageM
+0002cab0: 6f64 652e 434f 5059 290a 0a20 2020 2040  ode.COPY)..    @
+0002cac0: 7079 7465 7374 2e66 6978 7475 7265 0a20  pytest.fixture. 
+0002cad0: 2020 2064 6566 2074 6d70 5f61 7773 636c     def tmp_awscl
+0002cae0: 695f 6275 636b 6574 2873 656c 662c 2074  i_bucket(self, t
+0002caf0: 6d70 5f62 7563 6b65 745f 6e61 6d65 293a  mp_bucket_name):
+0002cb00: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
+0002cb10: 6573 2061 2074 656d 706f 7261 7279 2062  es a temporary b
+0002cb20: 7563 6b65 7420 7573 696e 6720 6177 7363  ucket using awsc
+0002cb30: 6c69 0a20 2020 2020 2020 2062 7563 6b65  li.        bucke
+0002cb40: 745f 7572 6920 3d20 6627 7333 3a2f 2f7b  t_uri = f's3://{
+0002cb50: 746d 705f 6275 636b 6574 5f6e 616d 657d  tmp_bucket_name}
+0002cb60: 270a 2020 2020 2020 2020 7375 6270 726f  '.        subpro
+0002cb70: 6365 7373 2e63 6865 636b 5f63 616c 6c28  cess.check_call(
+0002cb80: 5b27 6177 7327 2c20 2773 3327 2c20 276d  ['aws', 's3', 'm
+0002cb90: 6227 2c20 6275 636b 6574 5f75 7269 5d29  b', bucket_uri])
+0002cba0: 0a20 2020 2020 2020 2079 6965 6c64 2074  .        yield t
+0002cbb0: 6d70 5f62 7563 6b65 745f 6e61 6d65 2c20  mp_bucket_name, 
+0002cbc0: 6275 636b 6574 5f75 7269 0a20 2020 2020  bucket_uri.     
+0002cbd0: 2020 2073 7562 7072 6f63 6573 732e 6368     subprocess.ch
+0002cbe0: 6563 6b5f 6361 6c6c 285b 2761 7773 272c  eck_call(['aws',
+0002cbf0: 2027 7333 272c 2027 7262 272c 2062 7563   's3', 'rb', buc
+0002cc00: 6b65 745f 7572 692c 2027 2d2d 666f 7263  ket_uri, '--forc
+0002cc10: 6527 5d29 0a0a 2020 2020 4070 7974 6573  e'])..    @pytes
+0002cc20: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
+0002cc30: 6620 746d 705f 6773 7574 696c 5f62 7563  f tmp_gsutil_buc
+0002cc40: 6b65 7428 7365 6c66 2c20 746d 705f 6275  ket(self, tmp_bu
+0002cc50: 636b 6574 5f6e 616d 6529 3a0a 2020 2020  cket_name):.    
+0002cc60: 2020 2020 2320 4372 6561 7465 7320 6120      # Creates a 
+0002cc70: 7465 6d70 6f72 6172 7920 6275 636b 6574  temporary bucket
+0002cc80: 2075 7369 6e67 2067 7375 7469 6c0a 2020   using gsutil.  
+0002cc90: 2020 2020 2020 6275 636b 6574 5f75 7269        bucket_uri
+0002cca0: 203d 2066 2767 733a 2f2f 7b74 6d70 5f62   = f'gs://{tmp_b
+0002ccb0: 7563 6b65 745f 6e61 6d65 7d27 0a20 2020  ucket_name}'.   
+0002ccc0: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
+0002ccd0: 6368 6563 6b5f 6361 6c6c 285b 2767 7375  check_call(['gsu
+0002cce0: 7469 6c27 2c20 276d 6227 2c20 6275 636b  til', 'mb', buck
+0002ccf0: 6574 5f75 7269 5d29 0a20 2020 2020 2020  et_uri]).       
+0002cd00: 2079 6965 6c64 2074 6d70 5f62 7563 6b65   yield tmp_bucke
+0002cd10: 745f 6e61 6d65 2c20 6275 636b 6574 5f75  t_name, bucket_u
+0002cd20: 7269 0a20 2020 2020 2020 2073 7562 7072  ri.        subpr
+0002cd30: 6f63 6573 732e 6368 6563 6b5f 6361 6c6c  ocess.check_call
+0002cd40: 285b 2767 7375 7469 6c27 2c20 2772 6d27  (['gsutil', 'rm'
+0002cd50: 2c20 272d 7227 2c20 6275 636b 6574 5f75  , '-r', bucket_u
+0002cd60: 7269 5d29 0a0a 2020 2020 4070 7974 6573  ri])..    @pytes
+0002cd70: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
+0002cd80: 6620 746d 705f 6177 7363 6c69 5f62 7563  f tmp_awscli_buc
+0002cd90: 6b65 745f 7232 2873 656c 662c 2074 6d70  ket_r2(self, tmp
+0002cda0: 5f62 7563 6b65 745f 6e61 6d65 293a 0a20  _bucket_name):. 
+0002cdb0: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
+0002cdc0: 2061 2074 656d 706f 7261 7279 2062 7563   a temporary buc
+0002cdd0: 6b65 7420 7573 696e 6720 6177 7363 6c69  ket using awscli
+0002cde0: 0a20 2020 2020 2020 2065 6e64 706f 696e  .        endpoin
+0002cdf0: 745f 7572 6c20 3d20 636c 6f75 6466 6c61  t_url = cloudfla
+0002ce00: 7265 2e63 7265 6174 655f 656e 6470 6f69  re.create_endpoi
+0002ce10: 6e74 2829 0a20 2020 2020 2020 2062 7563  nt().        buc
+0002ce20: 6b65 745f 7572 6920 3d20 6627 7333 3a2f  ket_uri = f's3:/
+0002ce30: 2f7b 746d 705f 6275 636b 6574 5f6e 616d  /{tmp_bucket_nam
+0002ce40: 657d 270a 2020 2020 2020 2020 7375 6270  e}'.        subp
+0002ce50: 726f 6365 7373 2e63 6865 636b 5f63 616c  rocess.check_cal
+0002ce60: 6c28 0a20 2020 2020 2020 2020 2020 2066  l(.            f
+0002ce70: 2741 5753 5f53 4841 5245 445f 4352 4544  'AWS_SHARED_CRED
+0002ce80: 454e 5449 414c 535f 4649 4c45 3d7b 636c  ENTIALS_FILE={cl
+0002ce90: 6f75 6466 6c61 7265 2e52 325f 4352 4544  oudflare.R2_CRED
+0002cea0: 454e 5449 414c 535f 5041 5448 7d20 6177  ENTIALS_PATH} aw
+0002ceb0: 7320 7333 206d 6220 7b62 7563 6b65 745f  s s3 mb {bucket_
+0002cec0: 7572 697d 202d 2d65 6e64 706f 696e 7420  uri} --endpoint 
+0002ced0: 7b65 6e64 706f 696e 745f 7572 6c7d 202d  {endpoint_url} -
+0002cee0: 2d70 726f 6669 6c65 3d72 3227 2c0a 2020  -profile=r2',.  
+0002cef0: 2020 2020 2020 2020 2020 7368 656c 6c3d            shell=
+0002cf00: 5472 7565 290a 2020 2020 2020 2020 7969  True).        yi
+0002cf10: 656c 6420 746d 705f 6275 636b 6574 5f6e  eld tmp_bucket_n
+0002cf20: 616d 652c 2062 7563 6b65 745f 7572 690a  ame, bucket_uri.
+0002cf30: 2020 2020 2020 2020 7375 6270 726f 6365          subproce
+0002cf40: 7373 2e63 6865 636b 5f63 616c 6c28 0a20  ss.check_call(. 
+0002cf50: 2020 2020 2020 2020 2020 2066 2741 5753             f'AWS
+0002cf60: 5f53 4841 5245 445f 4352 4544 454e 5449  _SHARED_CREDENTI
+0002cf70: 414c 535f 4649 4c45 3d7b 636c 6f75 6466  ALS_FILE={cloudf
+0002cf80: 6c61 7265 2e52 325f 4352 4544 454e 5449  lare.R2_CREDENTI
+0002cf90: 414c 535f 5041 5448 7d20 6177 7320 7333  ALS_PATH} aws s3
+0002cfa0: 2072 6220 7b62 7563 6b65 745f 7572 697d   rb {bucket_uri}
+0002cfb0: 202d 2d66 6f72 6365 202d 2d65 6e64 706f   --force --endpo
+0002cfc0: 696e 7420 7b65 6e64 706f 696e 745f 7572  int {endpoint_ur
+0002cfd0: 6c7d 202d 2d70 726f 6669 6c65 3d72 3227  l} --profile=r2'
+0002cfe0: 2c0a 2020 2020 2020 2020 2020 2020 7368  ,.            sh
+0002cff0: 656c 6c3d 5472 7565 290a 0a20 2020 2040  ell=True)..    @
+0002d000: 7079 7465 7374 2e66 6978 7475 7265 0a20  pytest.fixture. 
+0002d010: 2020 2064 6566 2074 6d70 5f69 626d 5f63     def tmp_ibm_c
+0002d020: 6f73 5f62 7563 6b65 7428 7365 6c66 2c20  os_bucket(self, 
+0002d030: 746d 705f 6275 636b 6574 5f6e 616d 6529  tmp_bucket_name)
+0002d040: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
+0002d050: 7465 7320 6120 7465 6d70 6f72 6172 7920  tes a temporary 
+0002d060: 6275 636b 6574 2075 7369 6e67 2049 424d  bucket using IBM
+0002d070: 2043 4f53 2041 5049 0a20 2020 2020 2020   COS API.       
+0002d080: 2073 746f 7261 6765 5f6f 626a 203d 2073   storage_obj = s
+0002d090: 746f 7261 6765 5f6c 6962 2e49 424d 436f  torage_lib.IBMCo
+0002d0a0: 7353 746f 7265 2873 6f75 7263 653d 2222  sStore(source=""
+0002d0b0: 2c20 6e61 6d65 3d74 6d70 5f62 7563 6b65  , name=tmp_bucke
+0002d0c0: 745f 6e61 6d65 290a 2020 2020 2020 2020  t_name).        
+0002d0d0: 7969 656c 6420 746d 705f 6275 636b 6574  yield tmp_bucket
+0002d0e0: 5f6e 616d 650a 2020 2020 2020 2020 7374  _name.        st
+0002d0f0: 6f72 6167 655f 6f62 6a2e 6465 6c65 7465  orage_obj.delete
+0002d100: 2829 0a0a 2020 2020 4070 7974 6573 742e  ()..    @pytest.
+0002d110: 6669 7874 7572 650a 2020 2020 6465 6620  fixture.    def 
+0002d120: 746d 705f 7075 626c 6963 5f73 746f 7261  tmp_public_stora
+0002d130: 6765 5f6f 626a 2873 656c 662c 2072 6571  ge_obj(self, req
+0002d140: 7565 7374 293a 0a20 2020 2020 2020 2023  uest):.        #
+0002d150: 2049 6e69 7469 616c 697a 6573 2061 2073   Initializes a s
+0002d160: 746f 7261 6765 206f 626a 6563 7420 7769  torage object wi
+0002d170: 7468 2061 2070 7562 6c69 6320 6275 636b  th a public buck
+0002d180: 6574 0a20 2020 2020 2020 2073 746f 7261  et.        stora
+0002d190: 6765 5f6f 626a 203d 2073 746f 7261 6765  ge_obj = storage
+0002d1a0: 5f6c 6962 2e53 746f 7261 6765 2873 6f75  _lib.Storage(sou
+0002d1b0: 7263 653d 7265 7175 6573 742e 7061 7261  rce=request.para
+0002d1c0: 6d29 0a20 2020 2020 2020 2079 6965 6c64  m).        yield
+0002d1d0: 2073 746f 7261 6765 5f6f 626a 0a20 2020   storage_obj.   
+0002d1e0: 2020 2020 2023 2054 6869 7320 646f 6573       # This does
+0002d1f0: 206e 6f74 2072 6571 7569 7265 2061 6e79   not require any
+0002d200: 2064 656c 6574 696f 6e20 6c6f 6769 6320   deletion logic 
+0002d210: 6265 6361 7573 6520 6974 2069 7320 6120  because it is a 
+0002d220: 7075 626c 6963 2062 7563 6b65 740a 2020  public bucket.  
+0002d230: 2020 2020 2020 2320 616e 6420 7368 6f75        # and shou
+0002d240: 6c64 206e 6f74 2067 6574 2061 6464 6564  ld not get added
+0002d250: 2074 6f20 676c 6f62 616c 5f75 7365 725f   to global_user_
+0002d260: 7374 6174 652e 0a0a 2020 2020 4070 7974  state...    @pyt
+0002d270: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
+0002d280: 6473 7461 636b 0a20 2020 2040 7079 7465  dstack.    @pyte
+0002d290: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
+0002d2a0: 697a 6528 2773 746f 7265 5f74 7970 6527  ize('store_type'
+0002d2b0: 2c20 5b0a 2020 2020 2020 2020 7374 6f72  , [.        stor
+0002d2c0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0002d2d0: 652e 5333 2c20 7374 6f72 6167 655f 6c69  e.S3, storage_li
+0002d2e0: 622e 5374 6f72 6554 7970 652e 4743 532c  b.StoreType.GCS,
+0002d2f0: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
+0002d300: 7061 7261 6d28 7374 6f72 6167 655f 6c69  param(storage_li
+0002d310: 622e 5374 6f72 6554 7970 652e 4942 4d2c  b.StoreType.IBM,
+0002d320: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
+0002d330: 726b 2e69 626d 292c 0a20 2020 2020 2020  rk.ibm),.       
+0002d340: 2070 7974 6573 742e 7061 7261 6d28 7374   pytest.param(st
+0002d350: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002d360: 7970 652e 5232 2c20 6d61 726b 733d 7079  ype.R2, marks=py
+0002d370: 7465 7374 2e6d 6172 6b2e 636c 6f75 6466  test.mark.cloudf
+0002d380: 6c61 7265 290a 2020 2020 5d29 0a20 2020  lare).    ]).   
+0002d390: 2064 6566 2074 6573 745f 6e65 775f 6275   def test_new_bu
+0002d3a0: 636b 6574 5f63 7265 6174 696f 6e5f 616e  cket_creation_an
+0002d3b0: 645f 6465 6c65 7469 6f6e 2873 656c 662c  d_deletion(self,
+0002d3c0: 2074 6d70 5f6c 6f63 616c 5f73 746f 7261   tmp_local_stora
+0002d3d0: 6765 5f6f 626a 2c0a 2020 2020 2020 2020  ge_obj,.        
+0002d3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d400: 2020 2020 2020 7374 6f72 655f 7479 7065        store_type
+0002d410: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
+0002d420: 6174 6573 2061 206e 6577 2062 7563 6b65  ates a new bucke
+0002d430: 7420 7769 7468 2061 206c 6f63 616c 2073  t with a local s
+0002d440: 6f75 7263 652c 2075 706c 6f61 6473 2066  ource, uploads f
+0002d450: 696c 6573 2074 6f20 6974 0a20 2020 2020  iles to it.     
+0002d460: 2020 2023 2061 6e64 2064 656c 6574 6573     # and deletes
+0002d470: 2069 742e 0a20 2020 2020 2020 2074 6d70   it..        tmp
+0002d480: 5f6c 6f63 616c 5f73 746f 7261 6765 5f6f  _local_storage_o
+0002d490: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
+0002d4a0: 7265 5f74 7970 6529 0a0a 2020 2020 2020  re_type)..      
+0002d4b0: 2020 2320 5275 6e20 736b 7920 7374 6f72    # Run sky stor
+0002d4c0: 6167 6520 6c73 2074 6f20 6368 6563 6b20  age ls to check 
+0002d4d0: 6966 2073 746f 7261 6765 206f 626a 6563  if storage objec
+0002d4e0: 7420 6578 6973 7473 2069 6e20 7468 6520  t exists in the 
+0002d4f0: 6f75 7470 7574 0a20 2020 2020 2020 206f  output.        o
+0002d500: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
+0002d510: 6368 6563 6b5f 6f75 7470 7574 285b 2773  check_output(['s
+0002d520: 6b79 272c 2027 7374 6f72 6167 6527 2c20  ky', 'storage', 
+0002d530: 276c 7327 5d29 0a20 2020 2020 2020 2061  'ls']).        a
+0002d540: 7373 6572 7420 746d 705f 6c6f 6361 6c5f  ssert tmp_local_
+0002d550: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
+0002d560: 2069 6e20 6f75 742e 6465 636f 6465 2827   in out.decode('
+0002d570: 7574 662d 3827 290a 0a20 2020 2020 2020  utf-8')..       
+0002d580: 2023 2052 756e 2073 6b79 2073 746f 7261   # Run sky stora
+0002d590: 6765 2064 656c 6574 6520 746f 2064 656c  ge delete to del
+0002d5a0: 6574 6520 7468 6520 7374 6f72 6167 6520  ete the storage 
+0002d5b0: 6f62 6a65 6374 0a20 2020 2020 2020 2073  object.        s
+0002d5c0: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
+0002d5d0: 6f75 7470 7574 280a 2020 2020 2020 2020  output(.        
+0002d5e0: 2020 2020 5b27 736b 7927 2c20 2773 746f      ['sky', 'sto
+0002d5f0: 7261 6765 272c 2027 6465 6c65 7465 272c  rage', 'delete',
+0002d600: 2074 6d70 5f6c 6f63 616c 5f73 746f 7261   tmp_local_stora
+0002d610: 6765 5f6f 626a 2e6e 616d 652c 2027 2d2d  ge_obj.name, '--
+0002d620: 7965 7327 5d29 0a0a 2020 2020 2020 2020  yes'])..        
+0002d630: 2320 5275 6e20 736b 7920 7374 6f72 6167  # Run sky storag
+0002d640: 6520 6c73 2074 6f20 6368 6563 6b20 6966  e ls to check if
+0002d650: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
+0002d660: 6973 2064 656c 6574 6564 0a20 2020 2020  is deleted.     
+0002d670: 2020 206f 7574 203d 2073 7562 7072 6f63     out = subproc
+0002d680: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
+0002d690: 285b 2773 6b79 272c 2027 7374 6f72 6167  (['sky', 'storag
+0002d6a0: 6527 2c20 276c 7327 5d29 0a20 2020 2020  e', 'ls']).     
+0002d6b0: 2020 2061 7373 6572 7420 746d 705f 6c6f     assert tmp_lo
+0002d6c0: 6361 6c5f 7374 6f72 6167 655f 6f62 6a2e  cal_storage_obj.
+0002d6d0: 6e61 6d65 206e 6f74 2069 6e20 6f75 742e  name not in out.
+0002d6e0: 6465 636f 6465 2827 7574 662d 3827 290a  decode('utf-8').
+0002d6f0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+0002d700: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b0a  k.no_fluidstack.
+0002d710: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
+0002d720: 2e78 6469 7374 5f67 726f 7570 2827 6d75  .xdist_group('mu
+0002d730: 6c74 6970 6c65 5f62 7563 6b65 745f 6465  ltiple_bucket_de
+0002d740: 6c65 7469 6f6e 2729 0a20 2020 2040 7079  letion').    @py
+0002d750: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
+0002d760: 7472 697a 6528 2773 746f 7265 5f74 7970  trize('store_typ
+0002d770: 6527 2c20 5b0a 2020 2020 2020 2020 7374  e', [.        st
+0002d780: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002d790: 7970 652e 5333 2c20 7374 6f72 6167 655f  ype.S3, storage_
+0002d7a0: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
+0002d7b0: 532c 0a20 2020 2020 2020 2070 7974 6573  S,.        pytes
+0002d7c0: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
+0002d7d0: 6c69 622e 5374 6f72 6554 7970 652e 5232  lib.StoreType.R2
+0002d7e0: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
+0002d7f0: 6172 6b2e 636c 6f75 6466 6c61 7265 292c  ark.cloudflare),
+0002d800: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
+0002d810: 7061 7261 6d28 7374 6f72 6167 655f 6c69  param(storage_li
+0002d820: 622e 5374 6f72 6554 7970 652e 4942 4d2c  b.StoreType.IBM,
+0002d830: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
+0002d840: 726b 2e69 626d 290a 2020 2020 5d29 0a20  rk.ibm).    ]). 
+0002d850: 2020 2064 6566 2074 6573 745f 6d75 6c74     def test_mult
+0002d860: 6970 6c65 5f62 7563 6b65 7473 5f63 7265  iple_buckets_cre
+0002d870: 6174 696f 6e5f 616e 645f 6465 6c65 7469  ation_and_deleti
+0002d880: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+0002d890: 7365 6c66 2c20 746d 705f 6d75 6c74 6970  self, tmp_multip
+0002d8a0: 6c65 5f73 6372 6174 6368 5f73 746f 7261  le_scratch_stora
+0002d8b0: 6765 5f6f 626a 2c20 7374 6f72 655f 7479  ge_obj, store_ty
+0002d8c0: 7065 293a 0a20 2020 2020 2020 2023 2043  pe):.        # C
+0002d8d0: 7265 6174 6573 206d 756c 7469 706c 6520  reates multiple 
+0002d8e0: 6e65 7720 6275 636b 6574 7328 3520 6275  new buckets(5 bu
+0002d8f0: 636b 6574 7329 2077 6974 6820 6120 6c6f  ckets) with a lo
+0002d900: 6361 6c20 736f 7572 6365 0a20 2020 2020  cal source.     
+0002d910: 2020 2023 2061 6e64 2064 656c 6574 6573     # and deletes
+0002d920: 2074 6865 6d2e 0a20 2020 2020 2020 2073   them..        s
+0002d930: 746f 7261 6765 5f6f 626a 5f6e 616d 6520  torage_obj_name 
+0002d940: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
+0002d950: 2073 746f 7265 5f6f 626a 2069 6e20 746d   store_obj in tm
+0002d960: 705f 6d75 6c74 6970 6c65 5f73 6372 6174  p_multiple_scrat
+0002d970: 6368 5f73 746f 7261 6765 5f6f 626a 3a0a  ch_storage_obj:.
+0002d980: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+0002d990: 655f 6f62 6a2e 6164 645f 7374 6f72 6528  e_obj.add_store(
+0002d9a0: 7374 6f72 655f 7479 7065 290a 2020 2020  store_type).    
+0002d9b0: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
+0002d9c0: 6f62 6a5f 6e61 6d65 2e61 7070 656e 6428  obj_name.append(
+0002d9d0: 7374 6f72 655f 6f62 6a2e 6e61 6d65 290a  store_obj.name).
+0002d9e0: 0a20 2020 2020 2020 2023 2052 756e 2073  .        # Run s
+0002d9f0: 6b79 2073 746f 7261 6765 206c 7320 746f  ky storage ls to
+0002da00: 2063 6865 636b 2069 6620 616c 6c20 7374   check if all st
+0002da10: 6f72 6167 6520 6f62 6a65 6374 7320 6578  orage objects ex
+0002da20: 6973 7473 2069 6e20 7468 650a 2020 2020  ists in the.    
+0002da30: 2020 2020 2320 6f75 7470 7574 2066 696c      # output fil
+0002da40: 7465 7265 6420 6279 2073 746f 7265 2074  tered by store t
+0002da50: 7970 650a 2020 2020 2020 2020 6f75 745f  ype.        out_
+0002da60: 616c 6c20 3d20 7375 6270 726f 6365 7373  all = subprocess
+0002da70: 2e63 6865 636b 5f6f 7574 7075 7428 5b27  .check_output(['
+0002da80: 736b 7927 2c20 2773 746f 7261 6765 272c  sky', 'storage',
+0002da90: 2027 6c73 275d 290a 2020 2020 2020 2020   'ls']).        
+0002daa0: 6f75 7420 3d20 5b0a 2020 2020 2020 2020  out = [.        
+0002dab0: 2020 2020 6974 656d 2e73 706c 6974 2829      item.split()
+0002dac0: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+0002dad0: 666f 7220 6974 656d 2069 6e20 6f75 745f  for item in out_
+0002dae0: 616c 6c2e 6465 636f 6465 2827 7574 662d  all.decode('utf-
+0002daf0: 3827 292e 7370 6c69 746c 696e 6573 2829  8').splitlines()
+0002db00: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0002db10: 7374 6f72 655f 7479 7065 2e76 616c 7565  store_type.value
+0002db20: 2069 6e20 6974 656d 0a20 2020 2020 2020   in item.       
+0002db30: 205d 0a20 2020 2020 2020 2061 7373 6572   ].        asser
+0002db40: 7420 616c 6c28 5b69 7465 6d20 696e 206f  t all([item in o
+0002db50: 7574 2066 6f72 2069 7465 6d20 696e 2073  ut for item in s
+0002db60: 746f 7261 6765 5f6f 626a 5f6e 616d 655d  torage_obj_name]
+0002db70: 290a 0a20 2020 2020 2020 2023 2052 756e  )..        # Run
+0002db80: 2073 6b79 2073 746f 7261 6765 2064 656c   sky storage del
+0002db90: 6574 6520 616c 6c20 746f 2064 656c 6574  ete all to delet
+0002dba0: 6520 616c 6c20 7374 6f72 6167 6520 6f62  e all storage ob
+0002dbb0: 6a65 6374 730a 2020 2020 2020 2020 6465  jects.        de
+0002dbc0: 6c65 7465 5f63 6d64 203d 205b 2773 6b79  lete_cmd = ['sky
+0002dbd0: 272c 2027 7374 6f72 6167 6527 2c20 2764  ', 'storage', 'd
+0002dbe0: 656c 6574 6527 2c20 272d 2d79 6573 275d  elete', '--yes']
+0002dbf0: 0a20 2020 2020 2020 2064 656c 6574 655f  .        delete_
+0002dc00: 636d 6420 2b3d 2073 746f 7261 6765 5f6f  cmd += storage_o
+0002dc10: 626a 5f6e 616d 650a 2020 2020 2020 2020  bj_name.        
+0002dc20: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+0002dc30: 5f6f 7574 7075 7428 6465 6c65 7465 5f63  _output(delete_c
+0002dc40: 6d64 290a 0a20 2020 2020 2020 2023 2052  md)..        # R
+0002dc50: 756e 2073 6b79 2073 746f 7261 6765 206c  un sky storage l
+0002dc60: 7320 746f 2063 6865 636b 2069 6620 616c  s to check if al
+0002dc70: 6c20 7374 6f72 6167 6520 6f62 6a65 6374  l storage object
+0002dc80: 7320 6669 6c74 6572 6564 2062 7920 7374  s filtered by st
+0002dc90: 6f72 650a 2020 2020 2020 2020 2320 7479  ore.        # ty
+0002dca0: 7065 2061 7265 2064 656c 6574 6564 0a20  pe are deleted. 
+0002dcb0: 2020 2020 2020 206f 7574 5f61 6c6c 203d         out_all =
+0002dcc0: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+0002dcd0: 6b5f 6f75 7470 7574 285b 2773 6b79 272c  k_output(['sky',
+0002dce0: 2027 7374 6f72 6167 6527 2c20 276c 7327   'storage', 'ls'
+0002dcf0: 5d29 0a20 2020 2020 2020 206f 7574 203d  ]).        out =
+0002dd00: 205b 0a20 2020 2020 2020 2020 2020 2069   [.            i
+0002dd10: 7465 6d2e 7370 6c69 7428 295b 305d 0a20  tem.split()[0]. 
+0002dd20: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+0002dd30: 7465 6d20 696e 206f 7574 5f61 6c6c 2e64  tem in out_all.d
+0002dd40: 6563 6f64 6528 2775 7466 2d38 2729 2e73  ecode('utf-8').s
+0002dd50: 706c 6974 6c69 6e65 7328 290a 2020 2020  plitlines().    
+0002dd60: 2020 2020 2020 2020 6966 2073 746f 7265          if store
+0002dd70: 5f74 7970 652e 7661 6c75 6520 696e 2069  _type.value in i
+0002dd80: 7465 6d0a 2020 2020 2020 2020 5d0a 2020  tem.        ].  
+0002dd90: 2020 2020 2020 6173 7365 7274 2061 6c6c        assert all
+0002dda0: 285b 6974 656d 206e 6f74 2069 6e20 6f75  ([item not in ou
+0002ddb0: 7420 666f 7220 6974 656d 2069 6e20 7374  t for item in st
+0002ddc0: 6f72 6167 655f 6f62 6a5f 6e61 6d65 5d29  orage_obj_name])
+0002ddd0: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
+0002dde0: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
+0002ddf0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+0002de00: 6b2e 7061 7261 6d65 7472 697a 6528 2773  k.parametrize('s
+0002de10: 746f 7265 5f74 7970 6527 2c20 5b0a 2020  tore_type', [.  
+0002de20: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
+0002de30: 622e 5374 6f72 6554 7970 652e 5333 2c20  b.StoreType.S3, 
+0002de40: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002de50: 6554 7970 652e 4743 532c 0a20 2020 2020  eType.GCS,.     
+0002de60: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
+0002de70: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002de80: 6554 7970 652e 4942 4d2c 206d 6172 6b73  eType.IBM, marks
+0002de90: 3d70 7974 6573 742e 6d61 726b 2e69 626d  =pytest.mark.ibm
+0002dea0: 292c 0a20 2020 2020 2020 2070 7974 6573  ),.        pytes
+0002deb0: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
+0002dec0: 6c69 622e 5374 6f72 6554 7970 652e 5232  lib.StoreType.R2
+0002ded0: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
+0002dee0: 6172 6b2e 636c 6f75 6466 6c61 7265 290a  ark.cloudflare).
+0002def0: 2020 2020 5d29 0a20 2020 2064 6566 2074      ]).    def t
+0002df00: 6573 745f 7570 6c6f 6164 5f73 6f75 7263  est_upload_sourc
+0002df10: 655f 7769 7468 5f73 7061 6365 7328 7365  e_with_spaces(se
+0002df20: 6c66 2c20 7374 6f72 655f 7479 7065 2c0a  lf, store_type,.
+0002df30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002df40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002df50: 2020 2020 2020 2074 6d70 5f6d 756c 7469         tmp_multi
+0002df60: 706c 655f 6375 7374 6f6d 5f73 6f75 7263  ple_custom_sourc
+0002df70: 655f 7374 6f72 6167 655f 6f62 6a29 3a0a  e_storage_obj):.
+0002df80: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
+0002df90: 7320 7477 6f20 6275 636b 6574 7320 7769  s two buckets wi
+0002dfa0: 7468 2073 7065 6369 6669 6564 206c 6f63  th specified loc
+0002dfb0: 616c 2073 6f75 7263 6573 0a20 2020 2020  al sources.     
+0002dfc0: 2020 2023 2077 6974 6820 7370 6163 6573     # with spaces
+0002dfd0: 2069 6e20 7468 6520 6e61 6d65 0a20 2020   in the name.   
+0002dfe0: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
+0002dff0: 5f6e 616d 6573 203d 205b 5d0a 2020 2020  _names = [].    
+0002e000: 2020 2020 666f 7220 7374 6f72 6167 655f      for storage_
+0002e010: 6f62 6a20 696e 2074 6d70 5f6d 756c 7469  obj in tmp_multi
+0002e020: 706c 655f 6375 7374 6f6d 5f73 6f75 7263  ple_custom_sourc
+0002e030: 655f 7374 6f72 6167 655f 6f62 6a3a 0a20  e_storage_obj:. 
+0002e040: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+0002e050: 6765 5f6f 626a 2e61 6464 5f73 746f 7265  ge_obj.add_store
+0002e060: 2873 746f 7265 5f74 7970 6529 0a20 2020  (store_type).   
+0002e070: 2020 2020 2020 2020 2073 746f 7261 6765           storage
+0002e080: 5f6f 626a 5f6e 616d 6573 2e61 7070 656e  _obj_names.appen
+0002e090: 6428 7374 6f72 6167 655f 6f62 6a2e 6e61  d(storage_obj.na
+0002e0a0: 6d65 290a 0a20 2020 2020 2020 2023 2052  me)..        # R
+0002e0b0: 756e 2073 6b79 2073 746f 7261 6765 206c  un sky storage l
+0002e0c0: 7320 746f 2063 6865 636b 2069 6620 616c  s to check if al
+0002e0d0: 6c20 7374 6f72 6167 6520 6f62 6a65 6374  l storage object
+0002e0e0: 7320 6578 6973 7473 2069 6e20 7468 650a  s exists in the.
+0002e0f0: 2020 2020 2020 2020 2320 6f75 7470 7574          # output
+0002e100: 2066 696c 7465 7265 6420 6279 2073 746f   filtered by sto
+0002e110: 7265 2074 7970 650a 2020 2020 2020 2020  re type.        
+0002e120: 6f75 745f 616c 6c20 3d20 7375 6270 726f  out_all = subpro
+0002e130: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
+0002e140: 7428 5b27 736b 7927 2c20 2773 746f 7261  t(['sky', 'stora
+0002e150: 6765 272c 2027 6c73 275d 290a 2020 2020  ge', 'ls']).    
+0002e160: 2020 2020 6f75 7420 3d20 5b0a 2020 2020      out = [.    
+0002e170: 2020 2020 2020 2020 6974 656d 2e73 706c          item.spl
+0002e180: 6974 2829 5b30 5d0a 2020 2020 2020 2020  it()[0].        
+0002e190: 2020 2020 666f 7220 6974 656d 2069 6e20      for item in 
+0002e1a0: 6f75 745f 616c 6c2e 6465 636f 6465 2827  out_all.decode('
+0002e1b0: 7574 662d 3827 292e 7370 6c69 746c 696e  utf-8').splitlin
+0002e1c0: 6573 2829 0a20 2020 2020 2020 2020 2020  es().           
+0002e1d0: 2069 6620 7374 6f72 655f 7479 7065 2e76   if store_type.v
+0002e1e0: 616c 7565 2069 6e20 6974 656d 0a20 2020  alue in item.   
+0002e1f0: 2020 2020 205d 0a20 2020 2020 2020 2061       ].        a
+0002e200: 7373 6572 7420 616c 6c28 5b69 7465 6d20  ssert all([item 
+0002e210: 696e 206f 7574 2066 6f72 2069 7465 6d20  in out for item 
+0002e220: 696e 2073 746f 7261 6765 5f6f 626a 5f6e  in storage_obj_n
+0002e230: 616d 6573 5d29 0a0a 2020 2020 4070 7974  ames])..    @pyt
+0002e240: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
+0002e250: 6473 7461 636b 0a20 2020 2040 7079 7465  dstack.    @pyte
+0002e260: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
+0002e270: 697a 6528 2773 746f 7265 5f74 7970 6527  ize('store_type'
+0002e280: 2c20 5b0a 2020 2020 2020 2020 7374 6f72  , [.        stor
+0002e290: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0002e2a0: 652e 5333 2c20 7374 6f72 6167 655f 6c69  e.S3, storage_li
+0002e2b0: 622e 5374 6f72 6554 7970 652e 4743 532c  b.StoreType.GCS,
+0002e2c0: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
+0002e2d0: 7061 7261 6d28 7374 6f72 6167 655f 6c69  param(storage_li
+0002e2e0: 622e 5374 6f72 6554 7970 652e 4942 4d2c  b.StoreType.IBM,
+0002e2f0: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
+0002e300: 726b 2e69 626d 292c 0a20 2020 2020 2020  rk.ibm),.       
+0002e310: 2070 7974 6573 742e 7061 7261 6d28 7374   pytest.param(st
+0002e320: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002e330: 7970 652e 5232 2c20 6d61 726b 733d 7079  ype.R2, marks=py
+0002e340: 7465 7374 2e6d 6172 6b2e 636c 6f75 6466  test.mark.cloudf
+0002e350: 6c61 7265 290a 2020 2020 5d29 0a20 2020  lare).    ]).   
+0002e360: 2064 6566 2074 6573 745f 6275 636b 6574   def test_bucket
+0002e370: 5f65 7874 6572 6e61 6c5f 6465 6c65 7469  _external_deleti
+0002e380: 6f6e 2873 656c 662c 2074 6d70 5f73 6372  on(self, tmp_scr
+0002e390: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
+0002e3a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002e3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e3c0: 2020 2020 2020 2020 7374 6f72 655f 7479          store_ty
+0002e3d0: 7065 293a 0a20 2020 2020 2020 2023 2043  pe):.        # C
+0002e3e0: 7265 6174 6573 2061 2062 7563 6b65 742c  reates a bucket,
+0002e3f0: 2064 656c 6574 6573 2069 7420 6578 7465   deletes it exte
+0002e400: 726e 616c 6c79 2075 7369 6e67 2063 6c6f  rnally using clo
+0002e410: 7564 2063 6c69 2063 6f6d 6d61 6e64 730a  ud cli commands.
+0002e420: 2020 2020 2020 2020 2320 616e 6420 7468          # and th
+0002e430: 656e 2074 7269 6573 2074 6f20 6465 6c65  en tries to dele
+0002e440: 7465 2069 7420 7573 696e 6720 736b 7920  te it using sky 
+0002e450: 7374 6f72 6167 6520 6465 6c65 7465 2e0a  storage delete..
+0002e460: 2020 2020 2020 2020 746d 705f 7363 7261          tmp_scra
+0002e470: 7463 685f 7374 6f72 6167 655f 6f62 6a2e  tch_storage_obj.
+0002e480: 6164 645f 7374 6f72 6528 7374 6f72 655f  add_store(store_
+0002e490: 7479 7065 290a 0a20 2020 2020 2020 2023  type)..        #
+0002e4a0: 2052 756e 2073 6b79 2073 746f 7261 6765   Run sky storage
+0002e4b0: 206c 7320 746f 2063 6865 636b 2069 6620   ls to check if 
+0002e4c0: 7374 6f72 6167 6520 6f62 6a65 6374 2065  storage object e
+0002e4d0: 7869 7374 7320 696e 2074 6865 206f 7574  xists in the out
+0002e4e0: 7075 740a 2020 2020 2020 2020 6f75 7420  put.        out 
+0002e4f0: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
+0002e500: 636b 5f6f 7574 7075 7428 5b27 736b 7927  ck_output(['sky'
+0002e510: 2c20 2773 746f 7261 6765 272c 2027 6c73  , 'storage', 'ls
+0002e520: 275d 290a 2020 2020 2020 2020 6173 7365  ']).        asse
+0002e530: 7274 2074 6d70 5f73 6372 6174 6368 5f73  rt tmp_scratch_s
+0002e540: 746f 7261 6765 5f6f 626a 2e6e 616d 6520  torage_obj.name 
+0002e550: 696e 206f 7574 2e64 6563 6f64 6528 2775  in out.decode('u
+0002e560: 7466 2d38 2729 0a0a 2020 2020 2020 2020  tf-8')..        
+0002e570: 2320 4465 6c65 7465 2062 7563 6b65 7420  # Delete bucket 
+0002e580: 6578 7465 726e 616c 6c79 0a20 2020 2020  externally.     
+0002e590: 2020 2063 6d64 203d 2073 656c 662e 636c     cmd = self.cl
+0002e5a0: 695f 6465 6c65 7465 5f63 6d64 2873 746f  i_delete_cmd(sto
+0002e5b0: 7265 5f74 7970 652c 2074 6d70 5f73 6372  re_type, tmp_scr
+0002e5c0: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
+0002e5d0: 2e6e 616d 6529 0a20 2020 2020 2020 2073  .name).        s
+0002e5e0: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
+0002e5f0: 6f75 7470 7574 2863 6d64 2c20 7368 656c  output(cmd, shel
+0002e600: 6c3d 5472 7565 290a 0a20 2020 2020 2020  l=True)..       
+0002e610: 2023 2052 756e 2073 6b79 2073 746f 7261   # Run sky stora
+0002e620: 6765 2064 656c 6574 6520 746f 2064 656c  ge delete to del
+0002e630: 6574 6520 7468 6520 7374 6f72 6167 6520  ete the storage 
+0002e640: 6f62 6a65 6374 0a20 2020 2020 2020 206f  object.        o
+0002e650: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
+0002e660: 6368 6563 6b5f 6f75 7470 7574 280a 2020  check_output(.  
+0002e670: 2020 2020 2020 2020 2020 5b27 736b 7927            ['sky'
+0002e680: 2c20 2773 746f 7261 6765 272c 2027 6465  , 'storage', 'de
+0002e690: 6c65 7465 272c 2074 6d70 5f73 6372 6174  lete', tmp_scrat
+0002e6a0: 6368 5f73 746f 7261 6765 5f6f 626a 2e6e  ch_storage_obj.n
+0002e6b0: 616d 652c 2027 2d2d 7965 7327 5d29 0a20  ame, '--yes']). 
+0002e6c0: 2020 2020 2020 2023 204d 616b 6520 7375         # Make su
+0002e6d0: 7265 2062 7563 6b65 7420 7761 7320 6e6f  re bucket was no
+0002e6e0: 7420 6372 6561 7465 6420 6475 7269 6e67  t created during
+0002e6f0: 2064 656c 6574 696f 6e20 2873 6565 2069   deletion (see i
+0002e700: 7373 7565 2023 3133 3232 290a 2020 2020  ssue #1322).    
+0002e710: 2020 2020 6173 7365 7274 2027 6372 6561      assert 'crea
+0002e720: 7465 6427 206e 6f74 2069 6e20 6f75 742e  ted' not in out.
+0002e730: 6465 636f 6465 2827 7574 662d 3827 292e  decode('utf-8').
+0002e740: 6c6f 7765 7228 290a 0a20 2020 2020 2020  lower()..       
+0002e750: 2023 2052 756e 2073 6b79 2073 746f 7261   # Run sky stora
+0002e760: 6765 206c 7320 746f 2063 6865 636b 2069  ge ls to check i
+0002e770: 6620 7374 6f72 6167 6520 6f62 6a65 6374  f storage object
+0002e780: 2069 7320 6465 6c65 7465 640a 2020 2020   is deleted.    
+0002e790: 2020 2020 6f75 7420 3d20 7375 6270 726f      out = subpro
+0002e7a0: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
+0002e7b0: 7428 5b27 736b 7927 2c20 2773 746f 7261  t(['sky', 'stora
+0002e7c0: 6765 272c 2027 6c73 275d 290a 2020 2020  ge', 'ls']).    
+0002e7d0: 2020 2020 6173 7365 7274 2074 6d70 5f73      assert tmp_s
+0002e7e0: 6372 6174 6368 5f73 746f 7261 6765 5f6f  cratch_storage_o
+0002e7f0: 626a 2e6e 616d 6520 6e6f 7420 696e 206f  bj.name not in o
+0002e800: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
+0002e810: 2729 0a0a 2020 2020 4070 7974 6573 742e  ')..    @pytest.
+0002e820: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
+0002e830: 636b 0a20 2020 2040 7079 7465 7374 2e6d  ck.    @pytest.m
+0002e840: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
+0002e850: 2773 746f 7265 5f74 7970 6527 2c20 5b0a  'store_type', [.
+0002e860: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
+0002e870: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
+0002e880: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
+0002e890: 6f72 6554 7970 652e 4743 532c 0a20 2020  oreType.GCS,.   
+0002e8a0: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
+0002e8b0: 6d28 7374 6f72 6167 655f 6c69 622e 5374  m(storage_lib.St
+0002e8c0: 6f72 6554 7970 652e 4942 4d2c 206d 6172  oreType.IBM, mar
+0002e8d0: 6b73 3d70 7974 6573 742e 6d61 726b 2e69  ks=pytest.mark.i
+0002e8e0: 626d 292c 0a20 2020 2020 2020 2070 7974  bm),.        pyt
+0002e8f0: 6573 742e 7061 7261 6d28 7374 6f72 6167  est.param(storag
+0002e900: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0002e910: 5232 2c20 6d61 726b 733d 7079 7465 7374  R2, marks=pytest
+0002e920: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
+0002e930: 290a 2020 2020 5d29 0a20 2020 2064 6566  ).    ]).    def
+0002e940: 2074 6573 745f 6275 636b 6574 5f62 756c   test_bucket_bul
+0002e950: 6b5f 6465 6c65 7469 6f6e 2873 656c 662c  k_deletion(self,
+0002e960: 2073 746f 7265 5f74 7970 652c 2074 6d70   store_type, tmp
+0002e970: 5f62 756c 6b5f 6465 6c5f 7374 6f72 6167  _bulk_del_storag
+0002e980: 655f 6f62 6a29 3a0a 2020 2020 2020 2020  e_obj):.        
+0002e990: 2320 4372 6561 7465 7320 6120 7465 6d70  # Creates a temp
+0002e9a0: 2066 6f6c 6465 7220 7769 7468 206f 7665   folder with ove
+0002e9b0: 7220 3235 3620 6669 6c65 7320 616e 6420  r 256 files and 
+0002e9c0: 666f 6c64 6572 732c 2075 706c 6f61 640a  folders, upload.
+0002e9d0: 2020 2020 2020 2020 2320 6669 6c65 7320          # files 
+0002e9e0: 616e 6420 666f 6c64 6572 7320 746f 2061  and folders to a
+0002e9f0: 206e 6577 2062 7563 6b65 742c 2074 6865   new bucket, the
+0002ea00: 6e20 6465 6c65 7465 2062 7563 6b65 742e  n delete bucket.
+0002ea10: 0a20 2020 2020 2020 2074 6d70 5f62 756c  .        tmp_bul
+0002ea20: 6b5f 6465 6c5f 7374 6f72 6167 655f 6f62  k_del_storage_ob
+0002ea30: 6a2e 6164 645f 7374 6f72 6528 7374 6f72  j.add_store(stor
+0002ea40: 655f 7479 7065 290a 0a20 2020 2020 2020  e_type)..       
+0002ea50: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+0002ea60: 6b5f 6f75 7470 7574 285b 0a20 2020 2020  k_output([.     
+0002ea70: 2020 2020 2020 2027 736b 7927 2c20 2773         'sky', 's
+0002ea80: 746f 7261 6765 272c 2027 6465 6c65 7465  torage', 'delete
+0002ea90: 272c 2074 6d70 5f62 756c 6b5f 6465 6c5f  ', tmp_bulk_del_
+0002eaa0: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
+0002eab0: 2c20 272d 2d79 6573 270a 2020 2020 2020  , '--yes'.      
+0002eac0: 2020 5d29 0a0a 2020 2020 2020 2020 6f75    ])..        ou
+0002ead0: 7470 7574 203d 2073 7562 7072 6f63 6573  tput = subproces
+0002eae0: 732e 6368 6563 6b5f 6f75 7470 7574 285b  s.check_output([
+0002eaf0: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
+0002eb00: 2c20 276c 7327 5d29 0a20 2020 2020 2020  , 'ls']).       
+0002eb10: 2061 7373 6572 7420 746d 705f 6275 6c6b   assert tmp_bulk
+0002eb20: 5f64 656c 5f73 746f 7261 6765 5f6f 626a  _del_storage_obj
+0002eb30: 2e6e 616d 6520 6e6f 7420 696e 206f 7574  .name not in out
+0002eb40: 7075 742e 6465 636f 6465 2827 7574 662d  put.decode('utf-
+0002eb50: 3827 290a 0a20 2020 2040 7079 7465 7374  8')..    @pytest
+0002eb60: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
+0002eb70: 6163 6b0a 2020 2020 4070 7974 6573 742e  ack.    @pytest.
+0002eb80: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
+0002eb90: 280a 2020 2020 2020 2020 2774 6d70 5f70  (.        'tmp_p
+0002eba0: 7562 6c69 635f 7374 6f72 6167 655f 6f62  ublic_storage_ob
+0002ebb0: 6a2c 2073 746f 7265 5f74 7970 6527 2c0a  j, store_type',.
+0002ebc0: 2020 2020 2020 2020 5b28 2773 333a 2f2f          [('s3://
+0002ebd0: 7463 6761 2d32 2d6f 7065 6e27 2c20 7374  tcga-2-open', st
+0002ebe0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002ebf0: 7970 652e 5333 292c 0a20 2020 2020 2020  ype.S3),.       
+0002ec00: 2020 2827 7333 3a2f 2f64 6967 6974 616c    ('s3://digital
+0002ec10: 636f 7270 6f72 6127 2c20 7374 6f72 6167  corpora', storag
+0002ec20: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0002ec30: 5333 292c 0a20 2020 2020 2020 2020 2827  S3),.         ('
+0002ec40: 6773 3a2f 2f67 6370 2d70 7562 6c69 632d  gs://gcp-public-
+0002ec50: 6461 7461 2d73 656e 7469 6e65 6c2d 3227  data-sentinel-2'
+0002ec60: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
+0002ec70: 6f72 6554 7970 652e 4743 5329 5d2c 0a20  oreType.GCS)],. 
+0002ec80: 2020 2020 2020 2069 6e64 6972 6563 743d         indirect=
+0002ec90: 5b27 746d 705f 7075 626c 6963 5f73 746f  ['tmp_public_sto
+0002eca0: 7261 6765 5f6f 626a 275d 290a 2020 2020  rage_obj']).    
+0002ecb0: 6465 6620 7465 7374 5f70 7562 6c69 635f  def test_public_
+0002ecc0: 6275 636b 6574 2873 656c 662c 2074 6d70  bucket(self, tmp
+0002ecd0: 5f70 7562 6c69 635f 7374 6f72 6167 655f  _public_storage_
+0002ece0: 6f62 6a2c 2073 746f 7265 5f74 7970 6529  obj, store_type)
+0002ecf0: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
+0002ed00: 7465 7320 6120 6e65 7720 6275 636b 6574  tes a new bucket
+0002ed10: 2077 6974 6820 6120 7075 626c 6963 2073   with a public s
+0002ed20: 6f75 7263 6520 616e 6420 7665 7269 6669  ource and verifi
+0002ed30: 6573 2074 6861 7420 6974 2069 7320 6e6f  es that it is no
+0002ed40: 740a 2020 2020 2020 2020 2320 6164 6465  t.        # adde
+0002ed50: 6420 746f 2067 6c6f 6261 6c5f 7573 6572  d to global_user
+0002ed60: 5f73 7461 7465 2e0a 2020 2020 2020 2020  _state..        
+0002ed70: 746d 705f 7075 626c 6963 5f73 746f 7261  tmp_public_stora
+0002ed80: 6765 5f6f 626a 2e61 6464 5f73 746f 7265  ge_obj.add_store
+0002ed90: 2873 746f 7265 5f74 7970 6529 0a0a 2020  (store_type)..  
+0002eda0: 2020 2020 2020 2320 5275 6e20 736b 7920        # Run sky 
+0002edb0: 7374 6f72 6167 6520 6c73 2074 6f20 6368  storage ls to ch
+0002edc0: 6563 6b20 6966 2073 746f 7261 6765 206f  eck if storage o
+0002edd0: 626a 6563 7420 6578 6973 7473 2069 6e20  bject exists in 
+0002ede0: 7468 6520 6f75 7470 7574 0a20 2020 2020  the output.     
+0002edf0: 2020 206f 7574 203d 2073 7562 7072 6f63     out = subproc
+0002ee00: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
+0002ee10: 285b 2773 6b79 272c 2027 7374 6f72 6167  (['sky', 'storag
+0002ee20: 6527 2c20 276c 7327 5d29 0a20 2020 2020  e', 'ls']).     
+0002ee30: 2020 2061 7373 6572 7420 746d 705f 7075     assert tmp_pu
+0002ee40: 626c 6963 5f73 746f 7261 6765 5f6f 626a  blic_storage_obj
+0002ee50: 2e6e 616d 6520 6e6f 7420 696e 206f 7574  .name not in out
+0002ee60: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+0002ee70: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
+0002ee80: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
+0002ee90: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+0002eea0: 6b2e 7061 7261 6d65 7472 697a 6528 276e  k.parametrize('n
+0002eeb0: 6f6e 6578 6973 745f 6275 636b 6574 5f75  onexist_bucket_u
+0002eec0: 726c 272c 205b 0a20 2020 2020 2020 2027  rl', [.        '
+0002eed0: 7333 3a2f 2f7b 7261 6e64 6f6d 5f6e 616d  s3://{random_nam
+0002eee0: 657d 272c 2027 6773 3a2f 2f7b 7261 6e64  e}', 'gs://{rand
+0002eef0: 6f6d 5f6e 616d 657d 272c 0a20 2020 2020  om_name}',.     
+0002ef00: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
+0002ef10: 2763 6f73 3a2f 2f75 732d 6561 7374 2f7b  'cos://us-east/{
+0002ef20: 7261 6e64 6f6d 5f6e 616d 657d 272c 206d  random_name}', m
+0002ef30: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
+0002ef40: 2e69 626d 292c 0a20 2020 2020 2020 2070  .ibm),.        p
+0002ef50: 7974 6573 742e 7061 7261 6d28 2772 323a  ytest.param('r2:
+0002ef60: 2f2f 7b72 616e 646f 6d5f 6e61 6d65 7d27  //{random_name}'
+0002ef70: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
+0002ef80: 6172 6b2e 636c 6f75 6466 6c61 7265 290a  ark.cloudflare).
+0002ef90: 2020 2020 5d29 0a20 2020 2064 6566 2074      ]).    def t
+0002efa0: 6573 745f 6e6f 6e65 7869 7374 656e 745f  est_nonexistent_
+0002efb0: 6275 636b 6574 2873 656c 662c 206e 6f6e  bucket(self, non
+0002efc0: 6578 6973 745f 6275 636b 6574 5f75 726c  exist_bucket_url
+0002efd0: 293a 0a20 2020 2020 2020 2023 2041 7474  ):.        # Att
+0002efe0: 656d 7074 7320 746f 2063 7265 6174 6520  empts to create 
+0002eff0: 6665 7463 6820 6120 7374 726f 6167 6520  fetch a stroage 
+0002f000: 7769 7468 2061 206e 6f6e 2d65 7869 7374  with a non-exist
+0002f010: 656e 7420 736f 7572 6365 2e0a 2020 2020  ent source..    
+0002f020: 2020 2020 2320 4765 6e65 7261 7465 2061      # Generate a
+0002f030: 2072 616e 646f 6d20 6275 636b 6574 206e   random bucket n
+0002f040: 616d 6520 616e 6420 7665 7269 6679 2069  ame and verify i
+0002f050: 7420 646f 6573 6e27 7420 6578 6973 743a  t doesn't exist:
+0002f060: 0a20 2020 2020 2020 2072 6574 7279 5f63  .        retry_c
+0002f070: 6f75 6e74 203d 2030 0a20 2020 2020 2020  ount = 0.       
+0002f080: 2077 6869 6c65 2054 7275 653a 0a20 2020   while True:.   
+0002f090: 2020 2020 2020 2020 206e 6f6e 6578 6973           nonexis
+0002f0a0: 745f 6275 636b 6574 5f6e 616d 6520 3d20  t_bucket_name = 
+0002f0b0: 7374 7228 7575 6964 2e75 7569 6434 2829  str(uuid.uuid4()
+0002f0c0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0002f0d0: 206e 6f6e 6578 6973 745f 6275 636b 6574   nonexist_bucket
+0002f0e0: 5f75 726c 2e73 7461 7274 7377 6974 6828  _url.startswith(
+0002f0f0: 2773 3327 293a 0a20 2020 2020 2020 2020  's3'):.         
+0002f100: 2020 2020 2020 2063 6f6d 6d61 6e64 203d         command =
+0002f110: 2066 2761 7773 2073 3361 7069 2068 6561   f'aws s3api hea
+0002f120: 642d 6275 636b 6574 202d 2d62 7563 6b65  d-bucket --bucke
+0002f130: 7420 7b6e 6f6e 6578 6973 745f 6275 636b  t {nonexist_buck
+0002f140: 6574 5f6e 616d 657d 270a 2020 2020 2020  et_name}'.      
+0002f150: 2020 2020 2020 2020 2020 6578 7065 6374            expect
+0002f160: 6564 5f6f 7574 7075 7420 3d20 2734 3034  ed_output = '404
+0002f170: 270a 2020 2020 2020 2020 2020 2020 656c  '.            el
+0002f180: 6966 206e 6f6e 6578 6973 745f 6275 636b  if nonexist_buck
+0002f190: 6574 5f75 726c 2e73 7461 7274 7377 6974  et_url.startswit
+0002f1a0: 6828 2767 7327 293a 0a20 2020 2020 2020  h('gs'):.       
+0002f1b0: 2020 2020 2020 2020 2063 6f6d 6d61 6e64           command
+0002f1c0: 203d 2066 2767 7375 7469 6c20 6c73 207b   = f'gsutil ls {
+0002f1d0: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
+0002f1e0: 7572 6c2e 666f 726d 6174 2872 616e 646f  url.format(rando
+0002f1f0: 6d5f 6e61 6d65 3d6e 6f6e 6578 6973 745f  m_name=nonexist_
+0002f200: 6275 636b 6574 5f6e 616d 6529 7d27 0a20  bucket_name)}'. 
+0002f210: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0002f220: 7870 6563 7465 645f 6f75 7470 7574 203d  xpected_output =
+0002f230: 2027 4275 636b 6574 4e6f 7446 6f75 6e64   'BucketNotFound
+0002f240: 4578 6365 7074 696f 6e27 0a20 2020 2020  Exception'.     
+0002f250: 2020 2020 2020 2065 6c69 6620 6e6f 6e65         elif none
+0002f260: 7869 7374 5f62 7563 6b65 745f 7572 6c2e  xist_bucket_url.
+0002f270: 7374 6172 7473 7769 7468 2827 7232 2729  startswith('r2')
+0002f280: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002f290: 2020 656e 6470 6f69 6e74 5f75 726c 203d    endpoint_url =
+0002f2a0: 2063 6c6f 7564 666c 6172 652e 6372 6561   cloudflare.crea
+0002f2b0: 7465 5f65 6e64 706f 696e 7428 290a 2020  te_endpoint().  
+0002f2c0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0002f2d0: 6d6d 616e 6420 3d20 6627 4157 535f 5348  mmand = f'AWS_SH
+0002f2e0: 4152 4544 5f43 5245 4445 4e54 4941 4c53  ARED_CREDENTIALS
+0002f2f0: 5f46 494c 453d 7b63 6c6f 7564 666c 6172  _FILE={cloudflar
+0002f300: 652e 5232 5f43 5245 4445 4e54 4941 4c53  e.R2_CREDENTIALS
+0002f310: 5f50 4154 487d 2061 7773 2073 3361 7069  _PATH} aws s3api
+0002f320: 2068 6561 642d 6275 636b 6574 202d 2d62   head-bucket --b
+0002f330: 7563 6b65 7420 7b6e 6f6e 6578 6973 745f  ucket {nonexist_
+0002f340: 6275 636b 6574 5f6e 616d 657d 202d 2d65  bucket_name} --e
+0002f350: 6e64 706f 696e 7420 7b65 6e64 706f 696e  ndpoint {endpoin
+0002f360: 745f 7572 6c7d 202d 2d70 726f 6669 6c65  t_url} --profile
+0002f370: 3d72 3227 0a20 2020 2020 2020 2020 2020  =r2'.           
+0002f380: 2020 2020 2065 7870 6563 7465 645f 6f75       expected_ou
+0002f390: 7470 7574 203d 2027 3430 3427 0a20 2020  tput = '404'.   
+0002f3a0: 2020 2020 2020 2020 2065 6c69 6620 6e6f           elif no
+0002f3b0: 6e65 7869 7374 5f62 7563 6b65 745f 7572  nexist_bucket_ur
+0002f3c0: 6c2e 7374 6172 7473 7769 7468 2827 636f  l.startswith('co
+0002f3d0: 7327 293a 0a20 2020 2020 2020 2020 2020  s'):.           
+0002f3e0: 2020 2020 2023 2055 7369 6e67 2041 5049       # Using API
+0002f3f0: 2063 616c 6c73 2c20 7369 6e63 6520 7573   calls, since us
+0002f400: 696e 6720 7263 6c6f 6e65 2072 6571 7569  ing rclone requi
+0002f410: 7265 7320 6120 7072 6f66 696c 6527 7320  res a profile's 
+0002f420: 6e61 6d65 0a20 2020 2020 2020 2020 2020  name.           
+0002f430: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0002f440: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+0002f450: 7065 6374 6564 5f6f 7574 7075 7420 3d20  pected_output = 
+0002f460: 636f 6d6d 616e 6420 3d20 2265 6368 6f22  command = "echo"
+0002f470: 2020 2320 6176 6f69 6420 756e 7265 6c61    # avoid unrela
+0002f480: 7465 6420 6578 6365 7074 696f 6e20 696e  ted exception in
+0002f490: 2063 6173 6520 6f66 2066 6169 6c75 7265   case of failure
+0002f4a0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0002f4b0: 2020 2020 2020 6275 636b 6574 5f6e 616d        bucket_nam
+0002f4c0: 6520 3d20 7572 6c6c 6962 2e70 6172 7365  e = urllib.parse
+0002f4d0: 2e75 726c 7370 6c69 7428 0a20 2020 2020  .urlsplit(.     
+0002f4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f4f0: 2020 206e 6f6e 6578 6973 745f 6275 636b     nonexist_buck
+0002f500: 6574 5f75 726c 2e66 6f72 6d61 7428 0a20  et_url.format(. 
+0002f510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f520: 2020 2020 2020 2020 2020 2072 616e 646f             rando
+0002f530: 6d5f 6e61 6d65 3d6e 6f6e 6578 6973 745f  m_name=nonexist_
+0002f540: 6275 636b 6574 5f6e 616d 6529 292e 7061  bucket_name)).pa
+0002f550: 7468 2e73 7472 6970 2827 2f27 290a 2020  th.strip('/').  
 0002f560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f570: 2020 2020 2020 746d 705f 736f 7572 6365        tmp_source
-0002f580: 2c20 7374 6f72 655f 7479 7065 293a 0a20  , store_type):. 
-0002f590: 2020 2020 2020 2023 2054 7269 6573 2075         # Tries u
-0002f5a0: 706c 6f61 6469 6e67 2065 7869 7374 696e  ploading existin
-0002f5b0: 6720 6669 6c65 7320 746f 206e 6577 6c79  g files to newly
-0002f5c0: 2063 7265 6174 6564 2062 7563 6b65 7420   created bucket 
-0002f5d0: 286f 7574 7369 6465 206f 660a 2020 2020  (outside of.    
-0002f5e0: 2020 2020 2320 736b 7929 2061 6e64 2076      # sky) and v
-0002f5f0: 6572 6966 6965 7320 7468 6174 2066 696c  erifies that fil
-0002f600: 6573 2061 7265 2077 7269 7474 656e 2e0a  es are written..
-0002f610: 2020 2020 2020 2020 6275 636b 6574 5f6e          bucket_n
-0002f620: 616d 652c 205f 203d 2072 6571 7565 7374  ame, _ = request
-0002f630: 2e67 6574 6669 7874 7572 6576 616c 7565  .getfixturevalue
-0002f640: 2865 7874 5f62 7563 6b65 745f 6669 7874  (ext_bucket_fixt
-0002f650: 7572 6529 0a20 2020 2020 2020 2073 746f  ure).        sto
-0002f660: 7261 6765 5f6f 626a 203d 2073 746f 7261  rage_obj = stora
-0002f670: 6765 5f6c 6962 2e53 746f 7261 6765 286e  ge_lib.Storage(n
-0002f680: 616d 653d 6275 636b 6574 5f6e 616d 652c  ame=bucket_name,
-0002f690: 2073 6f75 7263 653d 746d 705f 736f 7572   source=tmp_sour
-0002f6a0: 6365 290a 2020 2020 2020 2020 7374 6f72  ce).        stor
-0002f6b0: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
-0002f6c0: 6528 7374 6f72 655f 7479 7065 290a 0a20  e(store_type).. 
-0002f6d0: 2020 2020 2020 2023 2043 6865 636b 2069         # Check i
-0002f6e0: 6620 746d 705f 736f 7572 6365 2f74 6d70  f tmp_source/tmp
-0002f6f0: 2d66 696c 6520 6578 6973 7473 2069 6e20  -file exists in 
-0002f700: 7468 6520 6275 636b 6574 2075 7369 6e67  the bucket using
-0002f710: 2061 7773 2063 6c69 0a20 2020 2020 2020   aws cli.       
-0002f720: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
-0002f730: 732e 6368 6563 6b5f 6f75 7470 7574 2873  s.check_output(s
-0002f740: 656c 662e 636c 695f 6c73 5f63 6d64 2873  elf.cli_ls_cmd(s
-0002f750: 746f 7265 5f74 7970 652c 2062 7563 6b65  tore_type, bucke
-0002f760: 745f 6e61 6d65 292c 0a20 2020 2020 2020  t_name),.       
-0002f770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f780: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002f790: 6865 6c6c 3d54 7275 6529 0a20 2020 2020  hell=True).     
-0002f7a0: 2020 2061 7373 6572 7420 2774 6d70 2d66     assert 'tmp-f
-0002f7b0: 696c 6527 2069 6e20 6f75 742e 6465 636f  ile' in out.deco
-0002f7c0: 6465 2827 7574 662d 3827 292c 205c 0a20  de('utf-8'), \. 
-0002f7d0: 2020 2020 2020 2020 2020 2027 4669 6c65             'File
-0002f7e0: 206e 6f74 2066 6f75 6e64 2069 6e20 6275   not found in bu
-0002f7f0: 636b 6574 202d 206f 7574 7075 7420 7761  cket - output wa
-0002f800: 7320 3a20 7b7d 272e 666f 726d 6174 286f  s : {}'.format(o
-0002f810: 7574 2e64 6563 6f64 650a 2020 2020 2020  ut.decode.      
-0002f820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f850: 2020 2020 2020 2020 2020 2827 7574 662d            ('utf-
-0002f860: 3827 2929 0a0a 2020 2020 2020 2020 2320  8'))..        # 
-0002f870: 4368 6563 6b20 7379 6d6c 696e 6b73 202d  Check symlinks -
-0002f880: 2073 796d 6c69 6e6b 7320 646f 6e27 7420   symlinks don't 
-0002f890: 6765 7420 636f 7069 6564 2062 7920 736b  get copied by sk
-0002f8a0: 7920 7374 6f72 6167 650a 2020 2020 2020  y storage.      
-0002f8b0: 2020 6173 7365 7274 2028 7061 7468 6c69    assert (pathli
-0002f8c0: 622e 5061 7468 2874 6d70 5f73 6f75 7263  b.Path(tmp_sourc
-0002f8d0: 6529 202f 2027 6369 7263 6c65 2d6c 696e  e) / 'circle-lin
-0002f8e0: 6b27 292e 6973 5f73 796d 6c69 6e6b 2829  k').is_symlink()
-0002f8f0: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
-0002f900: 2763 6972 636c 652d 6c69 6e6b 2077 6173  'circle-link was
-0002f910: 206e 6f74 2066 6f75 6e64 2069 6e20 7468   not found in th
-0002f920: 6520 7570 6c6f 6164 2073 6f75 7263 6520  e upload source 
-0002f930: 2d20 270a 2020 2020 2020 2020 2020 2020  - '.            
-0002f940: 2761 7265 2074 6865 2074 6573 7420 6669  'are the test fi
-0002f950: 7874 7572 6573 2063 6f72 7265 6374 3f27  xtures correct?'
-0002f960: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-0002f970: 2027 6369 7263 6c65 2d6c 696e 6b27 206e   'circle-link' n
-0002f980: 6f74 2069 6e20 6f75 742e 6465 636f 6465  ot in out.decode
-0002f990: 2827 7574 662d 3827 292c 2028 0a20 2020  ('utf-8'), (.   
-0002f9a0: 2020 2020 2020 2020 2027 5379 6d6c 696e           'Symlin
-0002f9b0: 6b20 666f 756e 6420 696e 2062 7563 6b65  k found in bucke
-0002f9c0: 7420 2d20 6c73 206f 7574 7075 7420 7761  t - ls output wa
-0002f9d0: 7320 3a20 7b7d 272e 666f 726d 6174 280a  s : {}'.format(.
-0002f9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f9f0: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
-0002fa00: 3827 2929 290a 0a20 2020 2020 2020 2023  8')))..        #
-0002fa10: 2052 756e 2073 6b79 2073 746f 7261 6765   Run sky storage
-0002fa20: 206c 7320 746f 2063 6865 636b 2069 6620   ls to check if 
-0002fa30: 7374 6f72 6167 6520 6f62 6a65 6374 2065  storage object e
-0002fa40: 7869 7374 7320 696e 2074 6865 206f 7574  xists in the out
-0002fa50: 7075 742e 0a20 2020 2020 2020 2023 2049  put..        # I
-0002fa60: 7420 7368 6f75 6c64 206e 6f74 2065 7869  t should not exi
-0002fa70: 7374 2062 6563 6175 7365 2074 6865 2062  st because the b
-0002fa80: 7563 6b65 7420 7761 7320 6372 6561 7465  ucket was create
-0002fa90: 6420 6578 7465 726e 616c 6c79 2e0a 2020  d externally..  
-0002faa0: 2020 2020 2020 6f75 7420 3d20 7375 6270        out = subp
-0002fab0: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
-0002fac0: 7075 7428 5b27 736b 7927 2c20 2773 746f  put(['sky', 'sto
-0002fad0: 7261 6765 272c 2027 6c73 275d 290a 2020  rage', 'ls']).  
-0002fae0: 2020 2020 2020 6173 7365 7274 2073 746f        assert sto
-0002faf0: 7261 6765 5f6f 626a 2e6e 616d 6520 6e6f  rage_obj.name no
-0002fb00: 7420 696e 206f 7574 2e64 6563 6f64 6528  t in out.decode(
-0002fb10: 2775 7466 2d38 2729 0a0a 2020 2020 4070  'utf-8')..    @p
-0002fb20: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
-0002fb30: 7569 6473 7461 636b 0a20 2020 2064 6566  uidstack.    def
-0002fb40: 2074 6573 745f 636f 7079 5f6d 6f75 6e74   test_copy_mount
-0002fb50: 5f65 7869 7374 696e 675f 7374 6f72 6167  _existing_storag
-0002fb60: 6528 7365 6c66 2c0a 2020 2020 2020 2020  e(self,.        
-0002fb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fb90: 2074 6d70 5f63 6f70 795f 6d6e 745f 6578   tmp_copy_mnt_ex
-0002fba0: 6973 7469 6e67 5f73 746f 7261 6765 5f6f  isting_storage_o
-0002fbb0: 626a 293a 0a20 2020 2020 2020 2023 2043  bj):.        # C
-0002fbc0: 7265 6174 6573 2061 2062 7563 6b65 7420  reates a bucket 
-0002fbd0: 7769 7468 206e 6f20 736f 7572 6365 2069  with no source i
-0002fbe0: 6e20 4d4f 554e 5420 6d6f 6465 2028 656d  n MOUNT mode (em
-0002fbf0: 7074 7920 6275 636b 6574 292c 2061 6e64  pty bucket), and
-0002fc00: 0a20 2020 2020 2020 2023 2074 6865 6e20  .        # then 
-0002fc10: 7472 6965 7320 746f 206c 6f61 6420 7468  tries to load th
-0002fc20: 6520 7361 6d65 2073 746f 7261 6765 2069  e same storage i
-0002fc30: 6e20 434f 5059 206d 6f64 652e 0a20 2020  n COPY mode..   
-0002fc40: 2020 2020 2074 6d70 5f63 6f70 795f 6d6e       tmp_copy_mn
-0002fc50: 745f 6578 6973 7469 6e67 5f73 746f 7261  t_existing_stora
-0002fc60: 6765 5f6f 626a 2e61 6464 5f73 746f 7265  ge_obj.add_store
-0002fc70: 2873 746f 7261 6765 5f6c 6962 2e53 746f  (storage_lib.Sto
-0002fc80: 7265 5479 7065 2e53 3329 0a20 2020 2020  reType.S3).     
-0002fc90: 2020 2073 746f 7261 6765 5f6e 616d 6520     storage_name 
-0002fca0: 3d20 746d 705f 636f 7079 5f6d 6e74 5f65  = tmp_copy_mnt_e
-0002fcb0: 7869 7374 696e 675f 7374 6f72 6167 655f  xisting_storage_
-0002fcc0: 6f62 6a2e 6e61 6d65 0a0a 2020 2020 2020  obj.name..      
-0002fcd0: 2020 2320 4368 6563 6b20 6073 6b79 2073    # Check `sky s
-0002fce0: 746f 7261 6765 206c 7360 2074 6f20 656e  torage ls` to en
-0002fcf0: 7375 7265 2073 746f 7261 6765 206f 626a  sure storage obj
-0002fd00: 6563 7420 6578 6973 7473 0a20 2020 2020  ect exists.     
-0002fd10: 2020 206f 7574 203d 2073 7562 7072 6f63     out = subproc
-0002fd20: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
-0002fd30: 285b 2773 6b79 272c 2027 7374 6f72 6167  (['sky', 'storag
-0002fd40: 6527 2c20 276c 7327 5d29 2e64 6563 6f64  e', 'ls']).decod
-0002fd50: 6528 2775 7466 2d38 2729 0a20 2020 2020  e('utf-8').     
-0002fd60: 2020 2061 7373 6572 7420 7374 6f72 6167     assert storag
-0002fd70: 655f 6e61 6d65 2069 6e20 6f75 742c 2066  e_name in out, f
-0002fd80: 2753 746f 7261 6765 207b 7374 6f72 6167  'Storage {storag
-0002fd90: 655f 6e61 6d65 7d20 6e6f 7420 666f 756e  e_name} not foun
-0002fda0: 6420 696e 2073 6b79 2073 746f 7261 6765  d in sky storage
-0002fdb0: 206c 732e 270a 0a20 2020 2040 7079 7465   ls.'..    @pyte
-0002fdc0: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
-0002fdd0: 7374 6163 6b0a 2020 2020 4070 7974 6573  stack.    @pytes
-0002fde0: 742e 6d61 726b 2e70 6172 616d 6574 7269  t.mark.parametri
-0002fdf0: 7a65 2827 7374 6f72 655f 7479 7065 272c  ze('store_type',
-0002fe00: 205b 0a20 2020 2020 2020 2073 746f 7261   [.        stora
-0002fe10: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-0002fe20: 2e53 332c 2073 746f 7261 6765 5f6c 6962  .S3, storage_lib
-0002fe30: 2e53 746f 7265 5479 7065 2e47 4353 2c0a  .StoreType.GCS,.
-0002fe40: 2020 2020 2020 2020 7079 7465 7374 2e70          pytest.p
-0002fe50: 6172 616d 2873 746f 7261 6765 5f6c 6962  aram(storage_lib
-0002fe60: 2e53 746f 7265 5479 7065 2e49 424d 2c20  .StoreType.IBM, 
-0002fe70: 6d61 726b 733d 7079 7465 7374 2e6d 6172  marks=pytest.mar
-0002fe80: 6b2e 6962 6d29 2c0a 2020 2020 2020 2020  k.ibm),.        
-0002fe90: 7079 7465 7374 2e70 6172 616d 2873 746f  pytest.param(sto
-0002fea0: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-0002feb0: 7065 2e52 322c 206d 6172 6b73 3d70 7974  pe.R2, marks=pyt
-0002fec0: 6573 742e 6d61 726b 2e63 6c6f 7564 666c  est.mark.cloudfl
-0002fed0: 6172 6529 0a20 2020 205d 290a 2020 2020  are).    ]).    
-0002fee0: 6465 6620 7465 7374 5f6c 6973 745f 736f  def test_list_so
-0002fef0: 7572 6365 2873 656c 662c 2074 6d70 5f6c  urce(self, tmp_l
-0002ff00: 6f63 616c 5f6c 6973 745f 7374 6f72 6167  ocal_list_storag
-0002ff10: 655f 6f62 6a2c 2073 746f 7265 5f74 7970  e_obj, store_typ
-0002ff20: 6529 3a0a 2020 2020 2020 2020 2320 5573  e):.        # Us
-0002ff30: 6573 2061 206c 6973 7420 696e 2074 6865  es a list in the
-0002ff40: 2073 6f75 7263 6520 6669 656c 6420 746f   source field to
-0002ff50: 2073 7065 6369 6679 2061 2066 696c 6520   specify a file 
-0002ff60: 616e 6420 6120 6469 7265 6374 6f72 7920  and a directory 
-0002ff70: 746f 0a20 2020 2020 2020 2023 2062 6520  to.        # be 
-0002ff80: 7570 6c6f 6164 6564 2074 6f20 7468 6520  uploaded to the 
-0002ff90: 7374 6f72 6167 6520 6f62 6a65 6374 2e0a  storage object..
-0002ffa0: 2020 2020 2020 2020 746d 705f 6c6f 6361          tmp_loca
-0002ffb0: 6c5f 6c69 7374 5f73 746f 7261 6765 5f6f  l_list_storage_o
-0002ffc0: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
-0002ffd0: 7265 5f74 7970 6529 0a0a 2020 2020 2020  re_type)..      
-0002ffe0: 2020 2320 4368 6563 6b20 6966 2074 6d70    # Check if tmp
-0002fff0: 2d66 696c 6520 6578 6973 7473 2069 6e20  -file exists in 
-00030000: 7468 6520 6275 636b 6574 2072 6f6f 7420  the bucket root 
-00030010: 7573 696e 6720 636c 690a 2020 2020 2020  using cli.      
-00030020: 2020 6f75 7420 3d20 7375 6270 726f 6365    out = subproce
-00030030: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
-00030040: 7365 6c66 2e63 6c69 5f6c 735f 636d 6428  self.cli_ls_cmd(
-00030050: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
-00030060: 7265 5f74 7970 652c 2074 6d70 5f6c 6f63  re_type, tmp_loc
-00030070: 616c 5f6c 6973 745f 7374 6f72 6167 655f  al_list_storage_
-00030080: 6f62 6a2e 6e61 6d65 292c 0a20 2020 2020  obj.name),.     
-00030090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000300a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000300b0: 2073 6865 6c6c 3d54 7275 6529 0a20 2020   shell=True).   
-000300c0: 2020 2020 2061 7373 6572 7420 2774 6d70       assert 'tmp
-000300d0: 2d66 696c 6527 2069 6e20 6f75 742e 6465  -file' in out.de
-000300e0: 636f 6465 2827 7574 662d 3827 292c 205c  code('utf-8'), \
-000300f0: 0a20 2020 2020 2020 2020 2020 2027 4669  .            'Fi
-00030100: 6c65 206e 6f74 2066 6f75 6e64 2069 6e20  le not found in 
-00030110: 6275 636b 6574 202d 206f 7574 7075 7420  bucket - output 
-00030120: 7761 7320 3a20 7b7d 272e 666f 726d 6174  was : {}'.format
-00030130: 286f 7574 2e64 6563 6f64 650a 2020 2020  (out.decode.    
+0002f570: 2020 636c 6965 6e74 203d 2069 626d 2e67    client = ibm.g
+0002f580: 6574 5f63 6f73 5f63 6c69 656e 7428 2775  et_cos_client('u
+0002f590: 732d 6561 7374 2729 0a20 2020 2020 2020  s-east').       
+0002f5a0: 2020 2020 2020 2020 2020 2020 2063 6c69               cli
+0002f5b0: 656e 742e 6865 6164 5f62 7563 6b65 7428  ent.head_bucket(
+0002f5c0: 4275 636b 6574 3d62 7563 6b65 745f 6e61  Bucket=bucket_na
+0002f5d0: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
+0002f5e0: 2020 2020 6578 6365 7074 2069 626d 2e69      except ibm.i
+0002f5f0: 626d 5f62 6f74 6f63 6f72 652e 6578 6365  bm_botocore.exce
+0002f600: 7074 696f 6e73 2e43 6c69 656e 7445 7272  ptions.ClientErr
+0002f610: 6f72 2061 7320 653a 0a20 2020 2020 2020  or as e:.       
+0002f620: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0002f630: 652e 7265 7370 6f6e 7365 5b27 4572 726f  e.response['Erro
+0002f640: 7227 5d5b 2743 6f64 6527 5d20 3d3d 2027  r']['Code'] == '
+0002f650: 3430 3427 3a0a 2020 2020 2020 2020 2020  404':.          
+0002f660: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0002f670: 7375 6363 6573 730a 2020 2020 2020 2020  success.        
+0002f680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f690: 7265 7475 726e 0a20 2020 2020 2020 2020  return.         
+0002f6a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0002f6b0: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+0002f6c0: 616c 7565 4572 726f 7228 2755 6e73 7570  alueError('Unsup
+0002f6d0: 706f 7274 6564 2062 7563 6b65 7420 7479  ported bucket ty
+0002f6e0: 7065 2027 0a20 2020 2020 2020 2020 2020  pe '.           
+0002f6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f700: 2020 2020 2020 6627 7b6e 6f6e 6578 6973        f'{nonexis
+0002f710: 745f 6275 636b 6574 5f75 726c 7d27 290a  t_bucket_url}').
+0002f720: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
+0002f730: 6865 636b 2069 6620 6275 636b 6574 2065  heck if bucket e
+0002f740: 7869 7374 7320 7573 696e 6720 7468 6520  xists using the 
+0002f750: 636c 693a 0a20 2020 2020 2020 2020 2020  cli:.           
+0002f760: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0002f770: 2020 2020 2020 6f75 7420 3d20 7375 6270        out = subp
+0002f780: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+0002f790: 7075 7428 636f 6d6d 616e 642c 0a20 2020  put(command,.   
+0002f7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f7c0: 2020 2020 2020 2020 2020 2073 7464 6572             stder
+0002f7d0: 723d 7375 6270 726f 6365 7373 2e53 5444  r=subprocess.STD
+0002f7e0: 4f55 542c 0a20 2020 2020 2020 2020 2020  OUT,.           
+0002f7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f810: 2020 2073 6865 6c6c 3d54 7275 6529 0a20     shell=True). 
+0002f820: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0002f830: 7420 7375 6270 726f 6365 7373 2e43 616c  t subprocess.Cal
+0002f840: 6c65 6450 726f 6365 7373 4572 726f 7220  ledProcessError 
+0002f850: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+0002f860: 2020 2020 2020 6f75 7420 3d20 652e 6f75        out = e.ou
+0002f870: 7470 7574 0a20 2020 2020 2020 2020 2020  tput.           
+0002f880: 206f 7574 203d 206f 7574 2e64 6563 6f64   out = out.decod
+0002f890: 6528 2775 7466 2d38 2729 0a20 2020 2020  e('utf-8').     
+0002f8a0: 2020 2020 2020 2069 6620 6578 7065 6374         if expect
+0002f8b0: 6564 5f6f 7574 7075 7420 696e 206f 7574  ed_output in out
+0002f8c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002f8d0: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
+0002f8e0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0002f8f0: 2020 2020 2020 2020 2020 7265 7472 795f            retry_
+0002f900: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
+0002f910: 2020 2020 2020 2020 2020 2069 6620 7265             if re
+0002f920: 7472 795f 636f 756e 7420 3e20 333a 0a20  try_count > 3:. 
+0002f930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f940: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
+0002f950: 4572 726f 7228 2755 6e61 626c 6520 746f  Error('Unable to
+0002f960: 2066 696e 6420 6120 6e6f 6e65 7869 7374   find a nonexist
+0002f970: 656e 7420 6275 636b 6574 2027 0a20 2020  ent bucket '.   
+0002f980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f9a0: 2020 2020 2774 6f20 7573 652e 2054 6869      'to use. Thi
+0002f9b0: 7320 6973 2068 6967 6c79 2075 6e6c 696b  s is higly unlik
+0002f9c0: 656c 7920 2d20 270a 2020 2020 2020 2020  ely - '.        
+0002f9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f9e0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0002f9f0: 6368 6563 6b20 6966 2074 6865 2074 6573  check if the tes
+0002fa00: 7473 2061 7265 2063 6f72 7265 6374 2e27  ts are correct.'
+0002fa10: 290a 0a20 2020 2020 2020 2077 6974 6820  )..        with 
+0002fa20: 7079 7465 7374 2e72 6169 7365 7328 0a20  pytest.raises(. 
+0002fa30: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0002fa40: 6b79 2e65 7863 6570 7469 6f6e 732e 5374  ky.exceptions.St
+0002fa50: 6f72 6167 6542 7563 6b65 7447 6574 4572  orageBucketGetEr
+0002fa60: 726f 722c 0a20 2020 2020 2020 2020 2020  ror,.           
+0002fa70: 2020 2020 206d 6174 6368 3d27 4174 7465       match='Atte
+0002fa80: 6d70 7465 6420 746f 2075 7365 2061 206e  mpted to use a n
+0002fa90: 6f6e 2d65 7869 7374 656e 7420 6275 636b  on-existent buck
+0002faa0: 6574 2061 7320 6120 736f 7572 6365 2729  et as a source')
+0002fab0: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
+0002fac0: 6f72 6167 655f 6f62 6a20 3d20 7374 6f72  orage_obj = stor
+0002fad0: 6167 655f 6c69 622e 5374 6f72 6167 6528  age_lib.Storage(
+0002fae0: 736f 7572 6365 3d6e 6f6e 6578 6973 745f  source=nonexist_
+0002faf0: 6275 636b 6574 5f75 726c 2e66 6f72 6d61  bucket_url.forma
+0002fb00: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+0002fb10: 2020 2072 616e 646f 6d5f 6e61 6d65 3d6e     random_name=n
+0002fb20: 6f6e 6578 6973 745f 6275 636b 6574 5f6e  onexist_bucket_n
+0002fb30: 616d 6529 290a 0a20 2020 2040 7079 7465  ame))..    @pyte
+0002fb40: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
+0002fb50: 7374 6163 6b0a 2020 2020 4070 7974 6573  stack.    @pytes
+0002fb60: 742e 6d61 726b 2e70 6172 616d 6574 7269  t.mark.parametri
+0002fb70: 7a65 2827 7072 6976 6174 655f 6275 636b  ze('private_buck
+0002fb80: 6574 272c 205b 0a20 2020 2020 2020 2066  et', [.        f
+0002fb90: 2773 333a 2f2f 696d 6167 656e 6574 272c  's3://imagenet',
+0002fba0: 2066 2767 733a 2f2f 696d 6167 656e 6574   f'gs://imagenet
+0002fbb0: 272c 0a20 2020 2020 2020 2070 7974 6573  ',.        pytes
+0002fbc0: 742e 7061 7261 6d28 2763 6f73 3a2f 2f75  t.param('cos://u
+0002fbd0: 732d 6561 7374 2f62 7563 6b65 7431 272c  s-east/bucket1',
+0002fbe0: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
+0002fbf0: 726b 2e69 626d 290a 2020 2020 5d29 0a20  rk.ibm).    ]). 
+0002fc00: 2020 2064 6566 2074 6573 745f 7072 6976     def test_priv
+0002fc10: 6174 655f 6275 636b 6574 2873 656c 662c  ate_bucket(self,
+0002fc20: 2070 7269 7661 7465 5f62 7563 6b65 7429   private_bucket)
+0002fc30: 3a0a 2020 2020 2020 2020 2320 4174 7465  :.        # Atte
+0002fc40: 6d70 7473 2074 6f20 6163 6365 7373 2070  mpts to access p
+0002fc50: 7269 7661 7465 2062 7563 6b65 7473 206e  rivate buckets n
+0002fc60: 6f74 2062 656c 6f6e 6769 6e67 2074 6f20  ot belonging to 
+0002fc70: 7468 6520 7573 6572 2e0a 2020 2020 2020  the user..      
+0002fc80: 2020 2320 5468 6573 6520 6275 636b 6574    # These bucket
+0002fc90: 7320 6172 6520 6b6e 6f77 6e20 746f 2062  s are known to b
+0002fca0: 6520 7072 6976 6174 652c 2062 7574 206d  e private, but m
+0002fcb0: 6179 206e 6565 6420 746f 2062 6520 7570  ay need to be up
+0002fcc0: 6461 7465 6420 6966 0a20 2020 2020 2020  dated if.       
+0002fcd0: 2023 2074 6865 7920 6172 6520 7265 6d6f   # they are remo
+0002fce0: 7665 6420 6279 2074 6865 6972 206f 776e  ved by their own
+0002fcf0: 6572 732e 0a20 2020 2020 2020 2070 7269  ers..        pri
+0002fd00: 7661 7465 5f62 7563 6b65 745f 6e61 6d65  vate_bucket_name
+0002fd10: 203d 2075 726c 6c69 622e 7061 7273 652e   = urllib.parse.
+0002fd20: 7572 6c73 706c 6974 2870 7269 7661 7465  urlsplit(private
+0002fd30: 5f62 7563 6b65 7429 2e6e 6574 6c6f 6320  _bucket).netloc 
+0002fd40: 6966 205c 0a20 2020 2020 2020 2020 2020  if \.           
+0002fd50: 2020 2075 726c 6c69 622e 7061 7273 652e     urllib.parse.
+0002fd60: 7572 6c73 706c 6974 2870 7269 7661 7465  urlsplit(private
+0002fd70: 5f62 7563 6b65 7429 2e73 6368 656d 6520  _bucket).scheme 
+0002fd80: 213d 2027 636f 7327 2065 6c73 6520 5c0a  != 'cos' else \.
+0002fd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fda0: 2020 7572 6c6c 6962 2e70 6172 7365 2e75    urllib.parse.u
+0002fdb0: 726c 7370 6c69 7428 7072 6976 6174 655f  rlsplit(private_
+0002fdc0: 6275 636b 6574 292e 7061 7468 2e73 7472  bucket).path.str
+0002fdd0: 6970 2827 2f27 290a 2020 2020 2020 2020  ip('/').        
+0002fde0: 7769 7468 2070 7974 6573 742e 7261 6973  with pytest.rais
+0002fdf0: 6573 280a 2020 2020 2020 2020 2020 2020  es(.            
+0002fe00: 2020 2020 736b 792e 6578 6365 7074 696f      sky.exceptio
+0002fe10: 6e73 2e53 746f 7261 6765 4275 636b 6574  ns.StorageBucket
+0002fe20: 4765 7445 7272 6f72 2c0a 2020 2020 2020  GetError,.      
+0002fe30: 2020 2020 2020 2020 2020 6d61 7463 683d            match=
+0002fe40: 7374 6f72 6167 655f 6c69 622e 5f42 5543  storage_lib._BUC
+0002fe50: 4b45 545f 4641 494c 5f54 4f5f 434f 4e4e  KET_FAIL_TO_CONN
+0002fe60: 4543 545f 4d45 5353 4147 452e 666f 726d  ECT_MESSAGE.form
+0002fe70: 6174 280a 2020 2020 2020 2020 2020 2020  at(.            
+0002fe80: 2020 2020 2020 2020 6e61 6d65 3d70 7269          name=pri
+0002fe90: 7661 7465 5f62 7563 6b65 745f 6e61 6d65  vate_bucket_name
+0002fea0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+0002feb0: 7374 6f72 6167 655f 6f62 6a20 3d20 7374  storage_obj = st
+0002fec0: 6f72 6167 655f 6c69 622e 5374 6f72 6167  orage_lib.Storag
+0002fed0: 6528 736f 7572 6365 3d70 7269 7661 7465  e(source=private
+0002fee0: 5f62 7563 6b65 7429 0a0a 2020 2020 4070  _bucket)..    @p
+0002fef0: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
+0002ff00: 7569 6473 7461 636b 0a20 2020 2040 7079  uidstack.    @py
+0002ff10: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
+0002ff20: 7472 697a 6528 2765 7874 5f62 7563 6b65  trize('ext_bucke
+0002ff30: 745f 6669 7874 7572 652c 2073 746f 7265  t_fixture, store
+0002ff40: 5f74 7970 6527 2c0a 2020 2020 2020 2020  _type',.        
+0002ff50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ff60: 2020 2020 205b 2827 746d 705f 6177 7363       [('tmp_awsc
+0002ff70: 6c69 5f62 7563 6b65 7427 2c20 7374 6f72  li_bucket', stor
+0002ff80: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0002ff90: 652e 5333 292c 0a20 2020 2020 2020 2020  e.S3),.         
+0002ffa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ffb0: 2020 2020 2028 2774 6d70 5f67 7375 7469       ('tmp_gsuti
+0002ffc0: 6c5f 6275 636b 6574 272c 2073 746f 7261  l_bucket', stora
+0002ffd0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0002ffe0: 2e47 4353 292c 0a20 2020 2020 2020 2020  .GCS),.         
+0002fff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030000: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
+00030010: 6d28 2774 6d70 5f69 626d 5f63 6f73 5f62  m('tmp_ibm_cos_b
+00030020: 7563 6b65 7427 2c0a 2020 2020 2020 2020  ucket',.        
+00030030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030050: 2020 2073 746f 7261 6765 5f6c 6962 2e53     storage_lib.S
+00030060: 746f 7265 5479 7065 2e49 424d 2c0a 2020  toreType.IBM,.  
+00030070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030090: 2020 2020 2020 2020 206d 6172 6b73 3d70           marks=p
+000300a0: 7974 6573 742e 6d61 726b 2e69 626d 292c  ytest.mark.ibm),
+000300b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000300c0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+000300d0: 7974 6573 742e 7061 7261 6d28 2774 6d70  ytest.param('tmp
+000300e0: 5f61 7773 636c 695f 6275 636b 6574 5f72  _awscli_bucket_r
+000300f0: 3227 2c0a 2020 2020 2020 2020 2020 2020  2',.            
+00030100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030110: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00030120: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+00030130: 5479 7065 2e52 322c 0a20 2020 2020 2020  Type.R2,.       
 00030140: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00030150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030170: 2020 2020 2020 2020 2020 2020 2827 7574              ('ut
-00030180: 662d 3827 2929 0a0a 2020 2020 2020 2020  f-8'))..        
-00030190: 2320 4368 6563 6b20 6966 2074 6d70 2d66  # Check if tmp-f
-000301a0: 696c 6520 6578 6973 7473 2069 6e20 7468  ile exists in th
-000301b0: 6520 6275 636b 6574 2f74 6d70 2d73 6f75  e bucket/tmp-sou
-000301c0: 7263 6520 7573 696e 6720 636c 690a 2020  rce using cli.  
-000301d0: 2020 2020 2020 6f75 7420 3d20 7375 6270        out = subp
-000301e0: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
-000301f0: 7075 7428 7365 6c66 2e63 6c69 5f6c 735f  put(self.cli_ls_
-00030200: 636d 6428 0a20 2020 2020 2020 2020 2020  cmd(.           
-00030210: 2073 746f 7265 5f74 7970 652c 2074 6d70   store_type, tmp
-00030220: 5f6c 6f63 616c 5f6c 6973 745f 7374 6f72  _local_list_stor
-00030230: 6167 655f 6f62 6a2e 6e61 6d65 2c20 2774  age_obj.name, 't
-00030240: 6d70 2d73 6f75 7263 652f 2729 2c0a 2020  mp-source/'),.  
-00030250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030270: 2020 2020 7368 656c 6c3d 5472 7565 290a      shell=True).
-00030280: 2020 2020 2020 2020 6173 7365 7274 2027          assert '
-00030290: 746d 702d 6669 6c65 2720 696e 206f 7574  tmp-file' in out
-000302a0: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-000302b0: 2c20 5c0a 2020 2020 2020 2020 2020 2020  , \.            
-000302c0: 2746 696c 6520 6e6f 7420 666f 756e 6420  'File not found 
-000302d0: 696e 2062 7563 6b65 7420 2d20 6f75 7470  in bucket - outp
-000302e0: 7574 2077 6173 203a 207b 7d27 2e66 6f72  ut was : {}'.for
-000302f0: 6d61 7428 6f75 742e 6465 636f 6465 0a20  mat(out.decode. 
-00030300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030330: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00030340: 2775 7466 2d38 2729 290a 0a20 2020 2040  'utf-8'))..    @
-00030350: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
-00030360: 6c75 6964 7374 6163 6b0a 2020 2020 4070  luidstack.    @p
-00030370: 7974 6573 742e 6d61 726b 2e70 6172 616d  ytest.mark.param
-00030380: 6574 7269 7a65 2827 696e 7661 6c69 645f  etrize('invalid_
-00030390: 6e61 6d65 5f6c 6973 742c 2073 746f 7265  name_list, store
-000303a0: 5f74 7970 6527 2c0a 2020 2020 2020 2020  _type',.        
-000303b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000303c0: 2020 2020 205b 2841 5753 5f49 4e56 414c       [(AWS_INVAL
-000303d0: 4944 5f4e 414d 4553 2c20 7374 6f72 6167  ID_NAMES, storag
-000303e0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-000303f0: 5333 292c 0a20 2020 2020 2020 2020 2020  S3),.           
-00030400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030410: 2020 2028 4743 535f 494e 5641 4c49 445f     (GCS_INVALID_
-00030420: 4e41 4d45 532c 2073 746f 7261 6765 5f6c  NAMES, storage_l
-00030430: 6962 2e53 746f 7265 5479 7065 2e47 4353  ib.StoreType.GCS
-00030440: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00030450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030460: 2070 7974 6573 742e 7061 7261 6d28 4942   pytest.param(IB
-00030470: 4d5f 494e 5641 4c49 445f 4e41 4d45 532c  M_INVALID_NAMES,
-00030480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000304a0: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-000304b0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-000304c0: 652e 4942 4d2c 0a20 2020 2020 2020 2020  e.IBM,.         
-000304d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000304e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000304f0: 2020 6d61 726b 733d 7079 7465 7374 2e6d    marks=pytest.m
-00030500: 6172 6b2e 6962 6d29 2c0a 2020 2020 2020  ark.ibm),.      
-00030510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030520: 2020 2020 2020 2020 7079 7465 7374 2e70          pytest.p
-00030530: 6172 616d 2841 5753 5f49 4e56 414c 4944  aram(AWS_INVALID
-00030540: 5f4e 414d 4553 2c0a 2020 2020 2020 2020  _NAMES,.        
-00030550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030570: 2020 2073 746f 7261 6765 5f6c 6962 2e53     storage_lib.S
-00030580: 746f 7265 5479 7065 2e52 322c 0a20 2020  toreType.R2,.   
-00030590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000305a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000305b0: 2020 2020 2020 2020 6d61 726b 733d 7079          marks=py
-000305c0: 7465 7374 2e6d 6172 6b2e 636c 6f75 6466  test.mark.cloudf
-000305d0: 6c61 7265 295d 290a 2020 2020 6465 6620  lare)]).    def 
-000305e0: 7465 7374 5f69 6e76 616c 6964 5f6e 616d  test_invalid_nam
-000305f0: 6573 2873 656c 662c 2069 6e76 616c 6964  es(self, invalid
-00030600: 5f6e 616d 655f 6c69 7374 2c20 7374 6f72  _name_list, stor
-00030610: 655f 7479 7065 293a 0a20 2020 2020 2020  e_type):.       
-00030620: 2023 2055 7365 7320 6120 6c69 7374 2069   # Uses a list i
-00030630: 6e20 7468 6520 736f 7572 6365 2066 6965  n the source fie
-00030640: 6c64 2074 6f20 7370 6563 6966 7920 6120  ld to specify a 
-00030650: 6669 6c65 2061 6e64 2061 2064 6972 6563  file and a direc
-00030660: 746f 7279 2074 6f0a 2020 2020 2020 2020  tory to.        
-00030670: 2320 6265 2075 706c 6f61 6465 6420 746f  # be uploaded to
-00030680: 2074 6865 2073 746f 7261 6765 206f 626a   the storage obj
-00030690: 6563 742e 0a20 2020 2020 2020 2066 6f72  ect..        for
-000306a0: 206e 616d 6520 696e 2069 6e76 616c 6964   name in invalid
-000306b0: 5f6e 616d 655f 6c69 7374 3a0a 2020 2020  _name_list:.    
-000306c0: 2020 2020 2020 2020 7769 7468 2070 7974          with pyt
-000306d0: 6573 742e 7261 6973 6573 2873 6b79 2e65  est.raises(sky.e
-000306e0: 7863 6570 7469 6f6e 732e 5374 6f72 6167  xceptions.Storag
-000306f0: 654e 616d 6545 7272 6f72 293a 0a20 2020  eNameError):.   
-00030700: 2020 2020 2020 2020 2020 2020 2073 746f               sto
-00030710: 7261 6765 5f6f 626a 203d 2073 746f 7261  rage_obj = stora
-00030720: 6765 5f6c 6962 2e53 746f 7261 6765 286e  ge_lib.Storage(n
-00030730: 616d 653d 6e61 6d65 290a 2020 2020 2020  ame=name).      
-00030740: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
-00030750: 655f 6f62 6a2e 6164 645f 7374 6f72 6528  e_obj.add_store(
-00030760: 7374 6f72 655f 7479 7065 290a 0a20 2020  store_type)..   
-00030770: 2040 7079 7465 7374 2e6d 6172 6b2e 6e6f   @pytest.mark.no
-00030780: 5f66 6c75 6964 7374 6163 6b0a 2020 2020  _fluidstack.    
-00030790: 4070 7974 6573 742e 6d61 726b 2e70 6172  @pytest.mark.par
-000307a0: 616d 6574 7269 7a65 280a 2020 2020 2020  ametrize(.      
-000307b0: 2020 2767 6974 6967 6e6f 7265 5f73 7472    'gitignore_str
-000307c0: 7563 7475 7265 2c20 7374 6f72 655f 7479  ucture, store_ty
-000307d0: 7065 272c 0a20 2020 2020 2020 205b 2847  pe',.        [(G
-000307e0: 4954 4947 4e4f 5245 5f53 594e 435f 5445  ITIGNORE_SYNC_TE
-000307f0: 5354 5f44 4952 5f53 5452 5543 5455 5245  ST_DIR_STRUCTURE
-00030800: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
-00030810: 6f72 6554 7970 652e 5333 292c 0a20 2020  oreType.S3),.   
-00030820: 2020 2020 2020 2847 4954 4947 4e4f 5245        (GITIGNORE
-00030830: 5f53 594e 435f 5445 5354 5f44 4952 5f53  _SYNC_TEST_DIR_S
-00030840: 5452 5543 5455 5245 2c20 7374 6f72 6167  TRUCTURE, storag
-00030850: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-00030860: 4743 5329 2c0a 2020 2020 2020 2020 2070  GCS),.         p
-00030870: 7974 6573 742e 7061 7261 6d28 4749 5449  ytest.param(GITI
-00030880: 474e 4f52 455f 5359 4e43 5f54 4553 545f  GNORE_SYNC_TEST_
-00030890: 4449 525f 5354 5255 4354 5552 452c 0a20  DIR_STRUCTURE,. 
-000308a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000308b0: 2020 2020 2073 746f 7261 6765 5f6c 6962       storage_lib
-000308c0: 2e53 746f 7265 5479 7065 2e52 322c 0a20  .StoreType.R2,. 
-000308d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000308e0: 2020 2020 206d 6172 6b73 3d70 7974 6573       marks=pytes
-000308f0: 742e 6d61 726b 2e63 6c6f 7564 666c 6172  t.mark.cloudflar
-00030900: 6529 5d29 0a20 2020 2064 6566 2074 6573  e)]).    def tes
-00030910: 745f 6578 636c 7564 6564 5f66 696c 655f  t_excluded_file_
-00030920: 636c 6f75 645f 7374 6f72 6167 655f 7570  cloud_storage_up
-00030930: 6c6f 6164 5f63 6f70 7928 7365 6c66 2c20  load_copy(self, 
-00030940: 6769 7469 676e 6f72 655f 7374 7275 6374  gitignore_struct
-00030950: 7572 652c 0a20 2020 2020 2020 2020 2020  ure,.           
-00030960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030980: 2020 2020 2020 2020 2020 7374 6f72 655f            store_
-00030990: 7479 7065 2c0a 2020 2020 2020 2020 2020  type,.          
-000309a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000309b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000309c0: 2020 2020 2020 2020 2020 2074 6d70 5f67             tmp_g
-000309d0: 6974 6967 6e6f 7265 5f73 746f 7261 6765  itignore_storage
-000309e0: 5f6f 626a 293a 0a20 2020 2020 2020 2023  _obj):.        #
-000309f0: 2074 6573 7473 2069 6620 6669 6c65 7320   tests if files 
-00030a00: 696e 636c 7564 6564 2069 6e20 2e67 6974  included in .git
-00030a10: 6967 6e6f 7265 2061 6e64 202e 6769 742f  ignore and .git/
-00030a20: 696e 666f 2f65 7863 6c75 6465 2061 7265  info/exclude are
-00030a30: 0a20 2020 2020 2020 2023 2065 7863 6c75  .        # exclu
-00030a40: 6465 6420 6672 6f6d 2062 6569 6e67 2074  ded from being t
-00030a50: 7261 6e73 6665 7272 6564 2074 6f20 5374  ransferred to St
-00030a60: 6f72 6167 650a 0a20 2020 2020 2020 2074  orage..        t
-00030a70: 6d70 5f67 6974 6967 6e6f 7265 5f73 746f  mp_gitignore_sto
-00030a80: 7261 6765 5f6f 626a 2e61 6464 5f73 746f  rage_obj.add_sto
-00030a90: 7265 2873 746f 7265 5f74 7970 6529 0a0a  re(store_type)..
-00030aa0: 2020 2020 2020 2020 7570 6c6f 6164 5f66          upload_f
-00030ab0: 696c 655f 6e61 6d65 203d 2027 696e 636c  ile_name = 'incl
-00030ac0: 7564 6564 270a 2020 2020 2020 2020 2320  uded'.        # 
-00030ad0: 436f 756e 7420 7468 6520 6e75 6d62 6572  Count the number
-00030ae0: 206f 6620 6669 6c65 7320 7769 7468 2074   of files with t
-00030af0: 6865 2067 6976 656e 2066 696c 6520 6e61  he given file na
-00030b00: 6d65 0a20 2020 2020 2020 2075 705f 636d  me.        up_cm
-00030b10: 6420 3d20 7365 6c66 2e63 6c69 5f63 6f75  d = self.cli_cou
-00030b20: 6e74 5f6e 616d 655f 696e 5f62 7563 6b65  nt_name_in_bucke
-00030b30: 7428 7374 6f72 655f 7479 7065 2c20 5c0a  t(store_type, \.
-00030b40: 2020 2020 2020 2020 2020 2020 746d 705f              tmp_
-00030b50: 6769 7469 676e 6f72 655f 7374 6f72 6167  gitignore_storag
-00030b60: 655f 6f62 6a2e 6e61 6d65 2c20 6669 6c65  e_obj.name, file
-00030b70: 5f6e 616d 653d 7570 6c6f 6164 5f66 696c  _name=upload_fil
-00030b80: 655f 6e61 6d65 290a 2020 2020 2020 2020  e_name).        
-00030b90: 6769 745f 6578 636c 7564 655f 636d 6420  git_exclude_cmd 
-00030ba0: 3d20 7365 6c66 2e63 6c69 5f63 6f75 6e74  = self.cli_count
-00030bb0: 5f6e 616d 655f 696e 5f62 7563 6b65 7428  _name_in_bucket(
-00030bc0: 7374 6f72 655f 7479 7065 2c20 5c0a 2020  store_type, \.  
-00030bd0: 2020 2020 2020 2020 2020 746d 705f 6769            tmp_gi
-00030be0: 7469 676e 6f72 655f 7374 6f72 6167 655f  tignore_storage_
-00030bf0: 6f62 6a2e 6e61 6d65 2c20 6669 6c65 5f6e  obj.name, file_n
-00030c00: 616d 653d 272e 6769 7427 290a 2020 2020  ame='.git').    
-00030c10: 2020 2020 636e 745f 6e75 6d5f 6669 6c65      cnt_num_file
-00030c20: 5f63 6d64 203d 2073 656c 662e 636c 695f  _cmd = self.cli_
-00030c30: 636f 756e 745f 6669 6c65 5f69 6e5f 6275  count_file_in_bu
-00030c40: 636b 6574 280a 2020 2020 2020 2020 2020  cket(.          
-00030c50: 2020 7374 6f72 655f 7479 7065 2c20 746d    store_type, tm
-00030c60: 705f 6769 7469 676e 6f72 655f 7374 6f72  p_gitignore_stor
-00030c70: 6167 655f 6f62 6a2e 6e61 6d65 290a 0a20  age_obj.name).. 
-00030c80: 2020 2020 2020 2075 705f 6f75 7470 7574         up_output
-00030c90: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
-00030ca0: 6563 6b5f 6f75 7470 7574 2875 705f 636d  eck_output(up_cm
-00030cb0: 642c 2073 6865 6c6c 3d54 7275 6529 0a20  d, shell=True). 
-00030cc0: 2020 2020 2020 2067 6974 5f65 7863 6c75         git_exclu
-00030cd0: 6465 5f6f 7574 7075 7420 3d20 7375 6270  de_output = subp
-00030ce0: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
-00030cf0: 7075 7428 6769 745f 6578 636c 7564 655f  put(git_exclude_
-00030d00: 636d 642c 0a20 2020 2020 2020 2020 2020  cmd,.           
+00030160: 2020 2020 6d61 726b 733d 7079 7465 7374      marks=pytest
+00030170: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
+00030180: 295d 290a 2020 2020 6465 6620 7465 7374  )]).    def test
+00030190: 5f75 706c 6f61 645f 746f 5f65 7869 7374  _upload_to_exist
+000301a0: 696e 675f 6275 636b 6574 2873 656c 662c  ing_bucket(self,
+000301b0: 2065 7874 5f62 7563 6b65 745f 6669 7874   ext_bucket_fixt
+000301c0: 7572 652c 2072 6571 7565 7374 2c0a 2020  ure, request,.  
+000301d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000301e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000301f0: 2020 2020 2074 6d70 5f73 6f75 7263 652c       tmp_source,
+00030200: 2073 746f 7265 5f74 7970 6529 3a0a 2020   store_type):.  
+00030210: 2020 2020 2020 2320 5472 6965 7320 7570        # Tries up
+00030220: 6c6f 6164 696e 6720 6578 6973 7469 6e67  loading existing
+00030230: 2066 696c 6573 2074 6f20 6e65 776c 7920   files to newly 
+00030240: 6372 6561 7465 6420 6275 636b 6574 2028  created bucket (
+00030250: 6f75 7473 6964 6520 6f66 0a20 2020 2020  outside of.     
+00030260: 2020 2023 2073 6b79 2920 616e 6420 7665     # sky) and ve
+00030270: 7269 6669 6573 2074 6861 7420 6669 6c65  rifies that file
+00030280: 7320 6172 6520 7772 6974 7465 6e2e 0a20  s are written.. 
+00030290: 2020 2020 2020 2062 7563 6b65 745f 6e61         bucket_na
+000302a0: 6d65 2c20 5f20 3d20 7265 7175 6573 742e  me, _ = request.
+000302b0: 6765 7466 6978 7475 7265 7661 6c75 6528  getfixturevalue(
+000302c0: 6578 745f 6275 636b 6574 5f66 6978 7475  ext_bucket_fixtu
+000302d0: 7265 290a 2020 2020 2020 2020 7374 6f72  re).        stor
+000302e0: 6167 655f 6f62 6a20 3d20 7374 6f72 6167  age_obj = storag
+000302f0: 655f 6c69 622e 5374 6f72 6167 6528 6e61  e_lib.Storage(na
+00030300: 6d65 3d62 7563 6b65 745f 6e61 6d65 2c20  me=bucket_name, 
+00030310: 736f 7572 6365 3d74 6d70 5f73 6f75 7263  source=tmp_sourc
+00030320: 6529 0a20 2020 2020 2020 2073 746f 7261  e).        stora
+00030330: 6765 5f6f 626a 2e61 6464 5f73 746f 7265  ge_obj.add_store
+00030340: 2873 746f 7265 5f74 7970 6529 0a0a 2020  (store_type)..  
+00030350: 2020 2020 2020 2320 4368 6563 6b20 6966        # Check if
+00030360: 2074 6d70 5f73 6f75 7263 652f 746d 702d   tmp_source/tmp-
+00030370: 6669 6c65 2065 7869 7374 7320 696e 2074  file exists in t
+00030380: 6865 2062 7563 6b65 7420 7573 696e 6720  he bucket using 
+00030390: 6177 7320 636c 690a 2020 2020 2020 2020  aws cli.        
+000303a0: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
+000303b0: 2e63 6865 636b 5f6f 7574 7075 7428 7365  .check_output(se
+000303c0: 6c66 2e63 6c69 5f6c 735f 636d 6428 7374  lf.cli_ls_cmd(st
+000303d0: 6f72 655f 7479 7065 2c20 6275 636b 6574  ore_type, bucket
+000303e0: 5f6e 616d 6529 2c0a 2020 2020 2020 2020  _name),.        
+000303f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030400: 2020 2020 2020 2020 2020 2020 2020 7368                sh
+00030410: 656c 6c3d 5472 7565 290a 2020 2020 2020  ell=True).      
+00030420: 2020 6173 7365 7274 2027 746d 702d 6669    assert 'tmp-fi
+00030430: 6c65 2720 696e 206f 7574 2e64 6563 6f64  le' in out.decod
+00030440: 6528 2775 7466 2d38 2729 2c20 5c0a 2020  e('utf-8'), \.  
+00030450: 2020 2020 2020 2020 2020 2746 696c 6520            'File 
+00030460: 6e6f 7420 666f 756e 6420 696e 2062 7563  not found in buc
+00030470: 6b65 7420 2d20 6f75 7470 7574 2077 6173  ket - output was
+00030480: 203a 207b 7d27 2e66 6f72 6d61 7428 6f75   : {}'.format(ou
+00030490: 742e 6465 636f 6465 0a20 2020 2020 2020  t.decode.       
+000304a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000304b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000304c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000304d0: 2020 2020 2020 2020 2028 2775 7466 2d38           ('utf-8
+000304e0: 2729 290a 0a20 2020 2020 2020 2023 2043  '))..        # C
+000304f0: 6865 636b 2073 796d 6c69 6e6b 7320 2d20  heck symlinks - 
+00030500: 7379 6d6c 696e 6b73 2064 6f6e 2774 2067  symlinks don't g
+00030510: 6574 2063 6f70 6965 6420 6279 2073 6b79  et copied by sky
+00030520: 2073 746f 7261 6765 0a20 2020 2020 2020   storage.       
+00030530: 2061 7373 6572 7420 2870 6174 686c 6962   assert (pathlib
+00030540: 2e50 6174 6828 746d 705f 736f 7572 6365  .Path(tmp_source
+00030550: 2920 2f20 2763 6972 636c 652d 6c69 6e6b  ) / 'circle-link
+00030560: 2729 2e69 735f 7379 6d6c 696e 6b28 292c  ').is_symlink(),
+00030570: 2028 0a20 2020 2020 2020 2020 2020 2027   (.            '
+00030580: 6369 7263 6c65 2d6c 696e 6b20 7761 7320  circle-link was 
+00030590: 6e6f 7420 666f 756e 6420 696e 2074 6865  not found in the
+000305a0: 2075 706c 6f61 6420 736f 7572 6365 202d   upload source -
+000305b0: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
+000305c0: 6172 6520 7468 6520 7465 7374 2066 6978  are the test fix
+000305d0: 7475 7265 7320 636f 7272 6563 743f 2729  tures correct?')
+000305e0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+000305f0: 2763 6972 636c 652d 6c69 6e6b 2720 6e6f  'circle-link' no
+00030600: 7420 696e 206f 7574 2e64 6563 6f64 6528  t in out.decode(
+00030610: 2775 7466 2d38 2729 2c20 280a 2020 2020  'utf-8'), (.    
+00030620: 2020 2020 2020 2020 2753 796d 6c69 6e6b          'Symlink
+00030630: 2066 6f75 6e64 2069 6e20 6275 636b 6574   found in bucket
+00030640: 202d 206c 7320 6f75 7470 7574 2077 6173   - ls output was
+00030650: 203a 207b 7d27 2e66 6f72 6d61 7428 0a20   : {}'.format(. 
+00030660: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00030670: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
+00030680: 2729 2929 0a0a 2020 2020 2020 2020 2320  ')))..        # 
+00030690: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
+000306a0: 6c73 2074 6f20 6368 6563 6b20 6966 2073  ls to check if s
+000306b0: 746f 7261 6765 206f 626a 6563 7420 6578  torage object ex
+000306c0: 6973 7473 2069 6e20 7468 6520 6f75 7470  ists in the outp
+000306d0: 7574 2e0a 2020 2020 2020 2020 2320 4974  ut..        # It
+000306e0: 2073 686f 756c 6420 6e6f 7420 6578 6973   should not exis
+000306f0: 7420 6265 6361 7573 6520 7468 6520 6275  t because the bu
+00030700: 636b 6574 2077 6173 2063 7265 6174 6564  cket was created
+00030710: 2065 7874 6572 6e61 6c6c 792e 0a20 2020   externally..   
+00030720: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
+00030730: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+00030740: 7574 285b 2773 6b79 272c 2027 7374 6f72  ut(['sky', 'stor
+00030750: 6167 6527 2c20 276c 7327 5d29 0a20 2020  age', 'ls']).   
+00030760: 2020 2020 2061 7373 6572 7420 7374 6f72       assert stor
+00030770: 6167 655f 6f62 6a2e 6e61 6d65 206e 6f74  age_obj.name not
+00030780: 2069 6e20 6f75 742e 6465 636f 6465 2827   in out.decode('
+00030790: 7574 662d 3827 290a 0a20 2020 2040 7079  utf-8')..    @py
+000307a0: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
+000307b0: 6964 7374 6163 6b0a 2020 2020 6465 6620  idstack.    def 
+000307c0: 7465 7374 5f63 6f70 795f 6d6f 756e 745f  test_copy_mount_
+000307d0: 6578 6973 7469 6e67 5f73 746f 7261 6765  existing_storage
+000307e0: 2873 656c 662c 0a20 2020 2020 2020 2020  (self,.         
+000307f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030810: 746d 705f 636f 7079 5f6d 6e74 5f65 7869  tmp_copy_mnt_exi
+00030820: 7374 696e 675f 7374 6f72 6167 655f 6f62  sting_storage_ob
+00030830: 6a29 3a0a 2020 2020 2020 2020 2320 4372  j):.        # Cr
+00030840: 6561 7465 7320 6120 6275 636b 6574 2077  eates a bucket w
+00030850: 6974 6820 6e6f 2073 6f75 7263 6520 696e  ith no source in
+00030860: 204d 4f55 4e54 206d 6f64 6520 2865 6d70   MOUNT mode (emp
+00030870: 7479 2062 7563 6b65 7429 2c20 616e 640a  ty bucket), and.
+00030880: 2020 2020 2020 2020 2320 7468 656e 2074          # then t
+00030890: 7269 6573 2074 6f20 6c6f 6164 2074 6865  ries to load the
+000308a0: 2073 616d 6520 7374 6f72 6167 6520 696e   same storage in
+000308b0: 2043 4f50 5920 6d6f 6465 2e0a 2020 2020   COPY mode..    
+000308c0: 2020 2020 746d 705f 636f 7079 5f6d 6e74      tmp_copy_mnt
+000308d0: 5f65 7869 7374 696e 675f 7374 6f72 6167  _existing_storag
+000308e0: 655f 6f62 6a2e 6164 645f 7374 6f72 6528  e_obj.add_store(
+000308f0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+00030900: 6554 7970 652e 5333 290a 2020 2020 2020  eType.S3).      
+00030910: 2020 7374 6f72 6167 655f 6e61 6d65 203d    storage_name =
+00030920: 2074 6d70 5f63 6f70 795f 6d6e 745f 6578   tmp_copy_mnt_ex
+00030930: 6973 7469 6e67 5f73 746f 7261 6765 5f6f  isting_storage_o
+00030940: 626a 2e6e 616d 650a 0a20 2020 2020 2020  bj.name..       
+00030950: 2023 2043 6865 636b 2060 736b 7920 7374   # Check `sky st
+00030960: 6f72 6167 6520 6c73 6020 746f 2065 6e73  orage ls` to ens
+00030970: 7572 6520 7374 6f72 6167 6520 6f62 6a65  ure storage obje
+00030980: 6374 2065 7869 7374 730a 2020 2020 2020  ct exists.      
+00030990: 2020 6f75 7420 3d20 7375 6270 726f 6365    out = subproce
+000309a0: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
+000309b0: 5b27 736b 7927 2c20 2773 746f 7261 6765  ['sky', 'storage
+000309c0: 272c 2027 6c73 275d 292e 6465 636f 6465  ', 'ls']).decode
+000309d0: 2827 7574 662d 3827 290a 2020 2020 2020  ('utf-8').      
+000309e0: 2020 6173 7365 7274 2073 746f 7261 6765    assert storage
+000309f0: 5f6e 616d 6520 696e 206f 7574 2c20 6627  _name in out, f'
+00030a00: 5374 6f72 6167 6520 7b73 746f 7261 6765  Storage {storage
+00030a10: 5f6e 616d 657d 206e 6f74 2066 6f75 6e64  _name} not found
+00030a20: 2069 6e20 736b 7920 7374 6f72 6167 6520   in sky storage 
+00030a30: 6c73 2e27 0a0a 2020 2020 4070 7974 6573  ls.'..    @pytes
+00030a40: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
+00030a50: 7461 636b 0a20 2020 2040 7079 7465 7374  tack.    @pytest
+00030a60: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
+00030a70: 6528 2773 746f 7265 5f74 7970 6527 2c20  e('store_type', 
+00030a80: 5b0a 2020 2020 2020 2020 7374 6f72 6167  [.        storag
+00030a90: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+00030aa0: 5333 2c20 7374 6f72 6167 655f 6c69 622e  S3, storage_lib.
+00030ab0: 5374 6f72 6554 7970 652e 4743 532c 0a20  StoreType.GCS,. 
+00030ac0: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
+00030ad0: 7261 6d28 7374 6f72 6167 655f 6c69 622e  ram(storage_lib.
+00030ae0: 5374 6f72 6554 7970 652e 4942 4d2c 206d  StoreType.IBM, m
+00030af0: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
+00030b00: 2e69 626d 292c 0a20 2020 2020 2020 2070  .ibm),.        p
+00030b10: 7974 6573 742e 7061 7261 6d28 7374 6f72  ytest.param(stor
+00030b20: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+00030b30: 652e 5232 2c20 6d61 726b 733d 7079 7465  e.R2, marks=pyte
+00030b40: 7374 2e6d 6172 6b2e 636c 6f75 6466 6c61  st.mark.cloudfla
+00030b50: 7265 290a 2020 2020 5d29 0a20 2020 2064  re).    ]).    d
+00030b60: 6566 2074 6573 745f 6c69 7374 5f73 6f75  ef test_list_sou
+00030b70: 7263 6528 7365 6c66 2c20 746d 705f 6c6f  rce(self, tmp_lo
+00030b80: 6361 6c5f 6c69 7374 5f73 746f 7261 6765  cal_list_storage
+00030b90: 5f6f 626a 2c20 7374 6f72 655f 7479 7065  _obj, store_type
+00030ba0: 293a 0a20 2020 2020 2020 2023 2055 7365  ):.        # Use
+00030bb0: 7320 6120 6c69 7374 2069 6e20 7468 6520  s a list in the 
+00030bc0: 736f 7572 6365 2066 6965 6c64 2074 6f20  source field to 
+00030bd0: 7370 6563 6966 7920 6120 6669 6c65 2061  specify a file a
+00030be0: 6e64 2061 2064 6972 6563 746f 7279 2074  nd a directory t
+00030bf0: 6f0a 2020 2020 2020 2020 2320 6265 2075  o.        # be u
+00030c00: 706c 6f61 6465 6420 746f 2074 6865 2073  ploaded to the s
+00030c10: 746f 7261 6765 206f 626a 6563 742e 0a20  torage object.. 
+00030c20: 2020 2020 2020 2074 6d70 5f6c 6f63 616c         tmp_local
+00030c30: 5f6c 6973 745f 7374 6f72 6167 655f 6f62  _list_storage_ob
+00030c40: 6a2e 6164 645f 7374 6f72 6528 7374 6f72  j.add_store(stor
+00030c50: 655f 7479 7065 290a 0a20 2020 2020 2020  e_type)..       
+00030c60: 2023 2043 6865 636b 2069 6620 746d 702d   # Check if tmp-
+00030c70: 6669 6c65 2065 7869 7374 7320 696e 2074  file exists in t
+00030c80: 6865 2062 7563 6b65 7420 726f 6f74 2075  he bucket root u
+00030c90: 7369 6e67 2063 6c69 0a20 2020 2020 2020  sing cli.       
+00030ca0: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
+00030cb0: 732e 6368 6563 6b5f 6f75 7470 7574 2873  s.check_output(s
+00030cc0: 656c 662e 636c 695f 6c73 5f63 6d64 280a  elf.cli_ls_cmd(.
+00030cd0: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+00030ce0: 655f 7479 7065 2c20 746d 705f 6c6f 6361  e_type, tmp_loca
+00030cf0: 6c5f 6c69 7374 5f73 746f 7261 6765 5f6f  l_list_storage_o
+00030d00: 626a 2e6e 616d 6529 2c0a 2020 2020 2020  bj.name),.      
 00030d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00030d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030d30: 2020 2020 2020 2020 2020 7368 656c 6c3d            shell=
-00030d40: 5472 7565 290a 2020 2020 2020 2020 636e  True).        cn
-00030d50: 745f 6f75 7470 7574 203d 2073 7562 7072  t_output = subpr
-00030d60: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-00030d70: 7574 2863 6e74 5f6e 756d 5f66 696c 655f  ut(cnt_num_file_
-00030d80: 636d 642c 2073 6865 6c6c 3d54 7275 6529  cmd, shell=True)
-00030d90: 0a0a 2020 2020 2020 2020 6173 7365 7274  ..        assert
-00030da0: 2027 3327 2069 6e20 7570 5f6f 7574 7075   '3' in up_outpu
-00030db0: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
-00030dc0: 292c 205c 0a20 2020 2020 2020 2020 2020  ), \.           
-00030dd0: 2020 2020 2027 4669 6c65 7320 746f 2062       'Files to b
-00030de0: 6520 696e 636c 7564 6564 2061 7265 206e  e included are n
-00030df0: 6f74 2063 6f6d 706c 6574 656c 7920 7570  ot completely up
-00030e00: 6c6f 6164 6564 2e27 0a20 2020 2020 2020  loaded.'.       
-00030e10: 2023 2031 2069 7320 7265 6164 2061 7320   # 1 is read as 
-00030e20: 2e67 6974 6967 6e6f 7265 2069 7320 7570  .gitignore is up
-00030e30: 6c6f 6164 6564 0a20 2020 2020 2020 2061  loaded.        a
-00030e40: 7373 6572 7420 2731 2720 696e 2067 6974  ssert '1' in git
-00030e50: 5f65 7863 6c75 6465 5f6f 7574 7075 742e  _exclude_output.
-00030e60: 6465 636f 6465 2827 7574 662d 3827 292c  decode('utf-8'),
-00030e70: 205c 0a20 2020 2020 2020 2020 2020 2020   \.             
-00030e80: 2020 272e 6769 7420 6469 7265 6374 6f72    '.git director
-00030e90: 7920 7368 6f75 6c64 206e 6f74 2062 6520  y should not be 
-00030ea0: 7570 6c6f 6164 6564 2e27 0a20 2020 2020  uploaded.'.     
-00030eb0: 2020 2023 2034 2066 696c 6573 2069 6e63     # 4 files inc
-00030ec0: 6c75 6465 202e 6769 7469 676e 6f72 652c  lude .gitignore,
-00030ed0: 2069 6e63 6c75 6465 642e 6c6f 672c 2069   included.log, i
-00030ee0: 6e63 6c75 6465 642e 7478 742c 2069 6e63  ncluded.txt, inc
-00030ef0: 6c75 6465 5f64 6972 2f69 6e63 6c75 6465  lude_dir/include
-00030f00: 642e 6c6f 670a 2020 2020 2020 2020 6173  d.log.        as
-00030f10: 7365 7274 2027 3427 2069 6e20 636e 745f  sert '4' in cnt_
-00030f20: 6f75 7470 7574 2e64 6563 6f64 6528 2775  output.decode('u
-00030f30: 7466 2d38 2729 2c20 5c0a 2020 2020 2020  tf-8'), \.      
-00030f40: 2020 2020 2020 2020 2027 536f 6d65 2069           'Some i
-00030f50: 7465 6d73 206c 6973 7465 6420 696e 202e  tems listed in .
-00030f60: 6769 7469 676e 6f72 6520 616e 6420 2e67  gitignore and .g
-00030f70: 6974 2f69 6e66 6f2f 6578 636c 7564 6520  it/info/exclude 
-00030f80: 6172 6520 6e6f 7420 6578 636c 7564 6564  are not excluded
-00030f90: 2e27 0a0a 2020 2020 4070 7974 6573 742e  .'..    @pytest.
-00030fa0: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
-00030fb0: 2827 6578 745f 6275 636b 6574 5f66 6978  ('ext_bucket_fix
-00030fc0: 7475 7265 2c20 7374 6f72 655f 7479 7065  ture, store_type
-00030fd0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00030fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030ff0: 5b28 2774 6d70 5f61 7773 636c 695f 6275  [('tmp_awscli_bu
-00031000: 636b 6574 272c 2073 746f 7261 6765 5f6c  cket', storage_l
-00031010: 6962 2e53 746f 7265 5479 7065 2e53 3329  ib.StoreType.S3)
-00031020: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00030d30: 7368 656c 6c3d 5472 7565 290a 2020 2020  shell=True).    
+00030d40: 2020 2020 6173 7365 7274 2027 746d 702d      assert 'tmp-
+00030d50: 6669 6c65 2720 696e 206f 7574 2e64 6563  file' in out.dec
+00030d60: 6f64 6528 2775 7466 2d38 2729 2c20 5c0a  ode('utf-8'), \.
+00030d70: 2020 2020 2020 2020 2020 2020 2746 696c              'Fil
+00030d80: 6520 6e6f 7420 666f 756e 6420 696e 2062  e not found in b
+00030d90: 7563 6b65 7420 2d20 6f75 7470 7574 2077  ucket - output w
+00030da0: 6173 203a 207b 7d27 2e66 6f72 6d61 7428  as : {}'.format(
+00030db0: 6f75 742e 6465 636f 6465 0a20 2020 2020  out.decode.     
+00030dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030df0: 2020 2020 2020 2020 2020 2028 2775 7466             ('utf
+00030e00: 2d38 2729 290a 0a20 2020 2020 2020 2023  -8'))..        #
+00030e10: 2043 6865 636b 2069 6620 746d 702d 6669   Check if tmp-fi
+00030e20: 6c65 2065 7869 7374 7320 696e 2074 6865  le exists in the
+00030e30: 2062 7563 6b65 742f 746d 702d 736f 7572   bucket/tmp-sour
+00030e40: 6365 2075 7369 6e67 2063 6c69 0a20 2020  ce using cli.   
+00030e50: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
+00030e60: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+00030e70: 7574 2873 656c 662e 636c 695f 6c73 5f63  ut(self.cli_ls_c
+00030e80: 6d64 280a 2020 2020 2020 2020 2020 2020  md(.            
+00030e90: 7374 6f72 655f 7479 7065 2c20 746d 705f  store_type, tmp_
+00030ea0: 6c6f 6361 6c5f 6c69 7374 5f73 746f 7261  local_list_stora
+00030eb0: 6765 5f6f 626a 2e6e 616d 652c 2027 746d  ge_obj.name, 'tm
+00030ec0: 702d 736f 7572 6365 2f27 292c 0a20 2020  p-source/'),.   
+00030ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030ef0: 2020 2073 6865 6c6c 3d54 7275 6529 0a20     shell=True). 
+00030f00: 2020 2020 2020 2061 7373 6572 7420 2774         assert 't
+00030f10: 6d70 2d66 696c 6527 2069 6e20 6f75 742e  mp-file' in out.
+00030f20: 6465 636f 6465 2827 7574 662d 3827 292c  decode('utf-8'),
+00030f30: 205c 0a20 2020 2020 2020 2020 2020 2027   \.            '
+00030f40: 4669 6c65 206e 6f74 2066 6f75 6e64 2069  File not found i
+00030f50: 6e20 6275 636b 6574 202d 206f 7574 7075  n bucket - outpu
+00030f60: 7420 7761 7320 3a20 7b7d 272e 666f 726d  t was : {}'.form
+00030f70: 6174 286f 7574 2e64 6563 6f64 650a 2020  at(out.decode.  
+00030f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030fb0: 2020 2020 2020 2020 2020 2020 2020 2827                ('
+00030fc0: 7574 662d 3827 2929 0a0a 2020 2020 4070  utf-8'))..    @p
+00030fd0: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
+00030fe0: 7569 6473 7461 636b 0a20 2020 2040 7079  uidstack.    @py
+00030ff0: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
+00031000: 7472 697a 6528 2769 6e76 616c 6964 5f6e  trize('invalid_n
+00031010: 616d 655f 6c69 7374 2c20 7374 6f72 655f  ame_list, store_
+00031020: 7479 7065 272c 0a20 2020 2020 2020 2020  type',.         
 00031030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031040: 2827 746d 705f 6773 7574 696c 5f62 7563  ('tmp_gsutil_buc
-00031050: 6b65 7427 2c20 7374 6f72 6167 655f 6c69  ket', storage_li
-00031060: 622e 5374 6f72 6554 7970 652e 4743 5329  b.StoreType.GCS)
-00031070: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00031040: 2020 2020 5b28 4157 535f 494e 5641 4c49      [(AWS_INVALI
+00031050: 445f 4e41 4d45 532c 2073 746f 7261 6765  D_NAMES, storage
+00031060: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
+00031070: 3329 2c0a 2020 2020 2020 2020 2020 2020  3),.            
 00031080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031090: 7079 7465 7374 2e70 6172 616d 2827 746d  pytest.param('tm
-000310a0: 705f 6177 7363 6c69 5f62 7563 6b65 745f  p_awscli_bucket_
-000310b0: 7232 272c 0a20 2020 2020 2020 2020 2020  r2',.           
-000310c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031090: 2020 2847 4353 5f49 4e56 414c 4944 5f4e    (GCS_INVALID_N
+000310a0: 414d 4553 2c20 7374 6f72 6167 655f 6c69  AMES, storage_li
+000310b0: 622e 5374 6f72 6554 7970 652e 4743 5329  b.StoreType.GCS)
+000310c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 000310d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000310e0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-000310f0: 6554 7970 652e 5232 2c0a 2020 2020 2020  eType.R2,.      
+000310e0: 7079 7465 7374 2e70 6172 616d 2849 424d  pytest.param(IBM
+000310f0: 5f49 4e56 414c 4944 5f4e 414d 4553 2c0a  _INVALID_NAMES,.
 00031100: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00031110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031120: 2020 2020 206d 6172 6b73 3d70 7974 6573       marks=pytes
-00031130: 742e 6d61 726b 2e63 6c6f 7564 666c 6172  t.mark.cloudflar
-00031140: 6529 5d29 0a20 2020 2064 6566 2074 6573  e)]).    def tes
-00031150: 745f 6578 7465 726e 616c 6c79 5f63 7265  t_externally_cre
-00031160: 6174 6564 5f62 7563 6b65 745f 6d6f 756e  ated_bucket_moun
-00031170: 745f 7769 7468 6f75 745f 736f 7572 6365  t_without_source
-00031180: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
-00031190: 6c66 2c20 6578 745f 6275 636b 6574 5f66  lf, ext_bucket_f
-000311a0: 6978 7475 7265 2c20 7265 7175 6573 742c  ixture, request,
-000311b0: 2073 746f 7265 5f74 7970 6529 3a0a 2020   store_type):.  
-000311c0: 2020 2020 2020 2320 4e6f 6e2d 736b 7920        # Non-sky 
-000311d0: 6d61 6e61 6765 6420 6275 636b 6574 7328  managed buckets(
-000311e0: 6275 636b 6574 7320 6372 6561 7465 6420  buckets created 
-000311f0: 6f75 7473 6964 6520 6f66 2053 6b79 7069  outside of Skypi
-00031200: 6c6f 7420 434c 4929 0a20 2020 2020 2020  lot CLI).       
-00031210: 2023 2061 7265 2061 6c6c 6f77 6564 2074   # are allowed t
-00031220: 6f20 6265 204d 4f55 4e54 6564 2062 7920  o be MOUNTed by 
-00031230: 7370 6563 6966 7969 6e67 2074 6865 2055  specifying the U
-00031240: 5249 206f 6620 7468 6520 6275 636b 6574  RI of the bucket
-00031250: 2074 6f0a 2020 2020 2020 2020 2320 736f   to.        # so
-00031260: 7572 6365 2066 6965 6c64 206f 6e6c 792e  urce field only.
-00031270: 2057 6865 6e20 6974 2069 7320 6174 7465   When it is atte
-00031280: 6d70 7465 6420 6279 2073 7065 6369 6679  mpted by specify
-00031290: 696e 6720 7468 6520 6e61 6d65 206f 660a  ing the name of.
-000312a0: 2020 2020 2020 2020 2320 7468 6520 6275          # the bu
-000312b0: 636b 6574 206f 6e6c 792c 2069 7420 7368  cket only, it sh
-000312c0: 6f75 6c64 2065 7272 6f72 206f 7574 2e0a  ould error out..
-000312d0: 2020 2020 2020 2020 230a 2020 2020 2020          #.      
-000312e0: 2020 2320 544f 444f 2864 6f79 6f75 6e67    # TODO(doyoung
-000312f0: 293a 2041 6464 2074 6573 7420 666f 7220  ): Add test for 
-00031300: 4942 4d20 434f 532e 2043 7572 7265 6e74  IBM COS. Current
-00031310: 6c79 2c20 7468 6973 2069 7320 626c 6f63  ly, this is bloc
-00031320: 6b65 640a 2020 2020 2020 2020 2320 6173  ked.        # as
-00031330: 2072 636c 6f6e 6520 7573 6564 2074 6f20   rclone used to 
-00031340: 696e 7465 7261 6374 2077 6974 6820 4942  interact with IB
-00031350: 4d20 434f 5320 646f 6573 206e 6f74 2073  M COS does not s
-00031360: 7570 706f 7274 2066 6561 7475 7265 2074  upport feature t
-00031370: 6f0a 2020 2020 2020 2020 2320 6372 6561  o.        # crea
-00031380: 7465 2061 2062 7563 6b65 742c 2061 6e64  te a bucket, and
-00031390: 2074 6865 2069 626d 636c 6f75 6420 434c   the ibmcloud CL
-000313a0: 4920 6973 206e 6f74 2073 7570 706f 7274  I is not support
-000313b0: 6564 2069 6e20 536b 7970 696c 6f74 2e0a  ed in Skypilot..
-000313c0: 2020 2020 2020 2020 2320 4569 7468 6572          # Either
-000313d0: 206f 6620 7468 6520 6665 6174 7572 6520   of the feature 
-000313e0: 6973 206e 6563 6573 7361 7279 2074 6f20  is necessary to 
-000313f0: 7369 6d75 6c61 7465 2061 6e20 6578 7465  simulate an exte
-00031400: 726e 616c 2062 7563 6b65 740a 2020 2020  rnal bucket.    
-00031410: 2020 2020 2320 6372 6561 7469 6f6e 2066      # creation f
-00031420: 6f72 2049 424d 2043 4f53 2e0a 2020 2020  or IBM COS..    
-00031430: 2020 2020 2320 6874 7470 733a 2f2f 6769      # https://gi
-00031440: 7468 7562 2e63 6f6d 2f73 6b79 7069 6c6f  thub.com/skypilo
-00031450: 742d 6f72 672f 736b 7970 696c 6f74 2f70  t-org/skypilot/p
-00031460: 756c 6c2f 3139 3636 2f66 696c 6573 2372  ull/1966/files#r
-00031470: 3132 3533 3433 3938 3337 0a0a 2020 2020  1253439837..    
-00031480: 2020 2020 6578 745f 6275 636b 6574 5f6e      ext_bucket_n
-00031490: 616d 652c 2065 7874 5f62 7563 6b65 745f  ame, ext_bucket_
-000314a0: 7572 6920 3d20 7265 7175 6573 742e 6765  uri = request.ge
-000314b0: 7466 6978 7475 7265 7661 6c75 6528 0a20  tfixturevalue(. 
-000314c0: 2020 2020 2020 2020 2020 2065 7874 5f62             ext_b
-000314d0: 7563 6b65 745f 6669 7874 7572 6529 0a20  ucket_fixture). 
-000314e0: 2020 2020 2020 2023 2069 6e76 616c 6964         # invalid
-000314f0: 2073 7065 630a 2020 2020 2020 2020 7769   spec.        wi
-00031500: 7468 2070 7974 6573 742e 7261 6973 6573  th pytest.raises
-00031510: 2873 6b79 2e65 7863 6570 7469 6f6e 732e  (sky.exceptions.
-00031520: 5374 6f72 6167 6553 7065 6345 7272 6f72  StorageSpecError
-00031530: 2920 6173 2065 3a0a 2020 2020 2020 2020  ) as e:.        
-00031540: 2020 2020 7374 6f72 6167 655f 6f62 6a20      storage_obj 
-00031550: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-00031560: 6f72 6167 6528 0a20 2020 2020 2020 2020  orage(.         
-00031570: 2020 2020 2020 206e 616d 653d 6578 745f         name=ext_
-00031580: 6275 636b 6574 5f6e 616d 652c 206d 6f64  bucket_name, mod
-00031590: 653d 7374 6f72 6167 655f 6c69 622e 5374  e=storage_lib.St
-000315a0: 6f72 6167 654d 6f64 652e 4d4f 554e 5429  orageMode.MOUNT)
-000315b0: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
-000315c0: 7261 6765 5f6f 626a 2e61 6464 5f73 746f  rage_obj.add_sto
-000315d0: 7265 2873 746f 7265 5f74 7970 6529 0a0a  re(store_type)..
-000315e0: 2020 2020 2020 2020 6173 7365 7274 2027          assert '
-000315f0: 4174 7465 6d70 7465 6420 746f 206d 6f75  Attempted to mou
-00031600: 6e74 2061 206e 6f6e 2d73 6b79 206d 616e  nt a non-sky man
-00031610: 6167 6564 2062 7563 6b65 7427 2069 6e20  aged bucket' in 
-00031620: 7374 7228 6529 0a0a 2020 2020 2020 2020  str(e)..        
-00031630: 2320 7661 6c69 6420 7370 6563 0a20 2020  # valid spec.   
-00031640: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
-00031650: 203d 2073 746f 7261 6765 5f6c 6962 2e53   = storage_lib.S
-00031660: 746f 7261 6765 2873 6f75 7263 653d 6578  torage(source=ex
-00031670: 745f 6275 636b 6574 5f75 7269 2c0a 2020  t_bucket_uri,.  
-00031680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000316a0: 2020 2020 2020 2020 6d6f 6465 3d73 746f          mode=sto
-000316b0: 7261 6765 5f6c 6962 2e53 746f 7261 6765  rage_lib.Storage
-000316c0: 4d6f 6465 2e4d 4f55 4e54 290a 2020 2020  Mode.MOUNT).    
-000316d0: 2020 2020 6861 6e64 6c65 203d 2067 6c6f      handle = glo
-000316e0: 6261 6c5f 7573 6572 5f73 7461 7465 2e67  bal_user_state.g
-000316f0: 6574 5f68 616e 646c 655f 6672 6f6d 5f73  et_handle_from_s
-00031700: 746f 7261 6765 5f6e 616d 6528 0a20 2020  torage_name(.   
-00031710: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-00031720: 5f6f 626a 2e6e 616d 6529 0a20 2020 2020  _obj.name).     
-00031730: 2020 2069 6620 6861 6e64 6c65 3a0a 2020     if handle:.  
-00031740: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
-00031750: 655f 6f62 6a2e 6465 6c65 7465 2829 0a0a  e_obj.delete()..
-00031760: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
-00031770: 2e6e 6f5f 666c 7569 6473 7461 636b 0a20  .no_fluidstack. 
-00031780: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-00031790: 7061 7261 6d65 7472 697a 6528 2772 6567  parametrize('reg
-000317a0: 696f 6e27 2c20 5b0a 2020 2020 2020 2020  ion', [.        
-000317b0: 2761 702d 6e6f 7274 6865 6173 742d 3127  'ap-northeast-1'
-000317c0: 2c20 2761 702d 6e6f 7274 6865 6173 742d  , 'ap-northeast-
-000317d0: 3227 2c20 2761 702d 6e6f 7274 6865 6173  2', 'ap-northeas
-000317e0: 742d 3327 2c20 2761 702d 736f 7574 682d  t-3', 'ap-south-
-000317f0: 3127 2c0a 2020 2020 2020 2020 2761 702d  1',.        'ap-
-00031800: 736f 7574 6865 6173 742d 3127 2c20 2761  southeast-1', 'a
-00031810: 702d 736f 7574 6865 6173 742d 3227 2c20  p-southeast-2', 
-00031820: 2765 752d 6365 6e74 7261 6c2d 3127 2c20  'eu-central-1', 
-00031830: 2765 752d 6e6f 7274 682d 3127 2c0a 2020  'eu-north-1',.  
-00031840: 2020 2020 2020 2765 752d 7765 7374 2d31        'eu-west-1
-00031850: 272c 2027 6575 2d77 6573 742d 3227 2c20  ', 'eu-west-2', 
-00031860: 2765 752d 7765 7374 2d33 272c 2027 7361  'eu-west-3', 'sa
-00031870: 2d65 6173 742d 3127 2c20 2775 732d 6561  -east-1', 'us-ea
-00031880: 7374 2d31 272c 0a20 2020 2020 2020 2027  st-1',.        '
-00031890: 7573 2d65 6173 742d 3227 2c20 2775 732d  us-east-2', 'us-
-000318a0: 7765 7374 2d31 272c 2027 7573 2d77 6573  west-1', 'us-wes
-000318b0: 742d 3227 0a20 2020 205d 290a 2020 2020  t-2'.    ]).    
-000318c0: 6465 6620 7465 7374 5f61 7773 5f72 6567  def test_aws_reg
-000318d0: 696f 6e73 2873 656c 662c 2074 6d70 5f6c  ions(self, tmp_l
-000318e0: 6f63 616c 5f73 746f 7261 6765 5f6f 626a  ocal_storage_obj
-000318f0: 2c20 7265 6769 6f6e 293a 0a20 2020 2020  , region):.     
-00031900: 2020 2023 2054 6869 7320 7465 7374 7320     # This tests 
-00031910: 6372 6561 7469 6f6e 2061 6e64 2075 706c  creation and upl
-00031920: 6f61 6420 746f 2062 7563 6b65 7420 696e  oad to bucket in
-00031930: 2061 6c6c 2041 5753 2073 3320 7265 6769   all AWS s3 regi
-00031940: 6f6e 730a 2020 2020 2020 2020 2320 546f  ons.        # To
-00031950: 2074 6573 7420 6675 6c6c 2066 756e 6374   test full funct
-00031960: 696f 6e61 6c69 7479 2c20 7573 6520 7465  ionality, use te
-00031970: 7374 5f73 706f 745f 7374 6f72 6167 6520  st_spot_storage 
-00031980: 6162 6f76 652e 0a20 2020 2020 2020 2073  above..        s
-00031990: 746f 7265 5f74 7970 6520 3d20 7374 6f72  tore_type = stor
-000319a0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-000319b0: 652e 5333 0a20 2020 2020 2020 2074 6d70  e.S3.        tmp
-000319c0: 5f6c 6f63 616c 5f73 746f 7261 6765 5f6f  _local_storage_o
-000319d0: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
-000319e0: 7265 5f74 7970 652c 2072 6567 696f 6e3d  re_type, region=
-000319f0: 7265 6769 6f6e 290a 2020 2020 2020 2020  region).        
-00031a00: 6275 636b 6574 5f6e 616d 6520 3d20 746d  bucket_name = tm
-00031a10: 705f 6c6f 6361 6c5f 7374 6f72 6167 655f  p_local_storage_
-00031a20: 6f62 6a2e 6e61 6d65 0a0a 2020 2020 2020  obj.name..      
-00031a30: 2020 2320 436f 6e66 6972 6d20 7468 6174    # Confirm that
-00031a40: 2074 6865 2062 7563 6b65 7420 7761 7320   the bucket was 
-00031a50: 6372 6561 7465 6420 696e 2074 6865 2063  created in the c
-00031a60: 6f72 7265 6374 2072 6567 696f 6e0a 2020  orrect region.  
-00031a70: 2020 2020 2020 7265 6769 6f6e 5f63 6d64        region_cmd
-00031a80: 203d 2073 656c 662e 636c 695f 7265 6769   = self.cli_regi
-00031a90: 6f6e 5f63 6d64 2873 746f 7265 5f74 7970  on_cmd(store_typ
-00031aa0: 652c 2062 7563 6b65 745f 6e61 6d65 290a  e, bucket_name).
-00031ab0: 2020 2020 2020 2020 6f75 7420 3d20 7375          out = su
-00031ac0: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
-00031ad0: 7574 7075 7428 7265 6769 6f6e 5f63 6d64  utput(region_cmd
-00031ae0: 2c20 7368 656c 6c3d 5472 7565 290a 2020  , shell=True).  
-00031af0: 2020 2020 2020 6f75 7470 7574 203d 206f        output = o
-00031b00: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
-00031b10: 2729 0a20 2020 2020 2020 2065 7870 6563  ').        expec
-00031b20: 7465 645f 6f75 7470 7574 5f72 6567 696f  ted_output_regio
-00031b30: 6e20 3d20 7265 6769 6f6e 0a20 2020 2020  n = region.     
-00031b40: 2020 2069 6620 7265 6769 6f6e 203d 3d20     if region == 
-00031b50: 2775 732d 6561 7374 2d31 273a 0a20 2020  'us-east-1':.   
-00031b60: 2020 2020 2020 2020 2065 7870 6563 7465           expecte
-00031b70: 645f 6f75 7470 7574 5f72 6567 696f 6e20  d_output_region 
-00031b80: 3d20 274e 6f6e 6527 2020 2320 7573 2d65  = 'None'  # us-e
-00031b90: 6173 742d 3120 6973 2074 6865 2064 6566  ast-1 is the def
-00031ba0: 6175 6c74 2072 6567 696f 6e0a 2020 2020  ault region.    
-00031bb0: 2020 2020 6173 7365 7274 2065 7870 6563      assert expec
-00031bc0: 7465 645f 6f75 7470 7574 5f72 6567 696f  ted_output_regio
-00031bd0: 6e20 696e 206f 7574 2e64 6563 6f64 6528  n in out.decode(
-00031be0: 2775 7466 2d38 2729 2c20 280a 2020 2020  'utf-8'), (.    
-00031bf0: 2020 2020 2020 2020 6627 4275 636b 6574          f'Bucket
-00031c00: 2077 6173 206e 6f74 2066 6f75 6e64 2069   was not found i
-00031c10: 6e20 7265 6769 6f6e 207b 7265 6769 6f6e  n region {region
-00031c20: 7d20 2d20 270a 2020 2020 2020 2020 2020  } - '.          
-00031c30: 2020 6627 6f75 7470 7574 206f 6620 7b72    f'output of {r
-00031c40: 6567 696f 6e5f 636d 647d 2077 6173 3a20  egion_cmd} was: 
-00031c50: 7b6f 7574 7075 747d 2729 0a0a 2020 2020  {output}')..    
-00031c60: 2020 2020 2320 4368 6563 6b20 6966 2074      # Check if t
-00031c70: 6d70 5f73 6f75 7263 652f 746d 702d 6669  mp_source/tmp-fi
-00031c80: 6c65 2065 7869 7374 7320 696e 2074 6865  le exists in the
-00031c90: 2062 7563 6b65 7420 7573 696e 6720 636c   bucket using cl
-00031ca0: 690a 2020 2020 2020 2020 6c73 5f63 6d64  i.        ls_cmd
-00031cb0: 203d 2073 656c 662e 636c 695f 6c73 5f63   = self.cli_ls_c
-00031cc0: 6d64 2873 746f 7265 5f74 7970 652c 2062  md(store_type, b
-00031cd0: 7563 6b65 745f 6e61 6d65 290a 2020 2020  ucket_name).    
-00031ce0: 2020 2020 6f75 7420 3d20 7375 6270 726f      out = subpro
-00031cf0: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
-00031d00: 7428 6c73 5f63 6d64 2c20 7368 656c 6c3d  t(ls_cmd, shell=
-00031d10: 5472 7565 290a 2020 2020 2020 2020 6f75  True).        ou
-00031d20: 7470 7574 203d 206f 7574 2e64 6563 6f64  tput = out.decod
-00031d30: 6528 2775 7466 2d38 2729 0a20 2020 2020  e('utf-8').     
-00031d40: 2020 2061 7373 6572 7420 2774 6d70 2d66     assert 'tmp-f
-00031d50: 696c 6527 2069 6e20 6f75 7470 7574 2c20  ile' in output, 
-00031d60: 280a 2020 2020 2020 2020 2020 2020 6627  (.            f'
-00031d70: 746d 702d 6669 6c65 206e 6f74 2066 6f75  tmp-file not fou
-00031d80: 6e64 2069 6e20 6275 636b 6574 202d 206f  nd in bucket - o
-00031d90: 7574 7075 7420 6f66 207b 6c73 5f63 6d64  utput of {ls_cmd
-00031da0: 7d20 7761 733a 207b 6f75 7470 7574 7d27  } was: {output}'
-00031db0: 290a 0a20 2020 2040 7079 7465 7374 2e6d  )..    @pytest.m
-00031dc0: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
-00031dd0: 6b0a 2020 2020 4070 7974 6573 742e 6d61  k.    @pytest.ma
-00031de0: 726b 2e70 6172 616d 6574 7269 7a65 2827  rk.parametrize('
-00031df0: 7265 6769 6f6e 272c 205b 0a20 2020 2020  region', [.     
-00031e00: 2020 2027 6e6f 7274 6861 6d65 7269 6361     'northamerica
-00031e10: 2d6e 6f72 7468 6561 7374 3127 2c20 276e  -northeast1', 'n
-00031e20: 6f72 7468 616d 6572 6963 612d 6e6f 7274  orthamerica-nort
-00031e30: 6865 6173 7432 272c 2027 7573 2d63 656e  heast2', 'us-cen
-00031e40: 7472 616c 3127 2c0a 2020 2020 2020 2020  tral1',.        
-00031e50: 2775 732d 6561 7374 3127 2c20 2775 732d  'us-east1', 'us-
-00031e60: 6561 7374 3427 2c20 2775 732d 6561 7374  east4', 'us-east
-00031e70: 3527 2c20 2775 732d 736f 7574 6831 272c  5', 'us-south1',
-00031e80: 2027 7573 2d77 6573 7431 272c 2027 7573   'us-west1', 'us
-00031e90: 2d77 6573 7432 272c 0a20 2020 2020 2020  -west2',.       
-00031ea0: 2027 7573 2d77 6573 7433 272c 2027 7573   'us-west3', 'us
-00031eb0: 2d77 6573 7434 272c 2027 736f 7574 6861  -west4', 'southa
-00031ec0: 6d65 7269 6361 2d65 6173 7431 272c 2027  merica-east1', '
-00031ed0: 736f 7574 6861 6d65 7269 6361 2d77 6573  southamerica-wes
-00031ee0: 7431 272c 0a20 2020 2020 2020 2027 6575  t1',.        'eu
-00031ef0: 726f 7065 2d63 656e 7472 616c 3227 2c20  rope-central2', 
-00031f00: 2765 7572 6f70 652d 6e6f 7274 6831 272c  'europe-north1',
-00031f10: 2027 6575 726f 7065 2d73 6f75 7468 7765   'europe-southwe
-00031f20: 7374 3127 2c20 2765 7572 6f70 652d 7765  st1', 'europe-we
-00031f30: 7374 3127 2c0a 2020 2020 2020 2020 2765  st1',.        'e
-00031f40: 7572 6f70 652d 7765 7374 3227 2c20 2765  urope-west2', 'e
-00031f50: 7572 6f70 652d 7765 7374 3327 2c20 2765  urope-west3', 'e
-00031f60: 7572 6f70 652d 7765 7374 3427 2c20 2765  urope-west4', 'e
-00031f70: 7572 6f70 652d 7765 7374 3627 2c0a 2020  urope-west6',.  
-00031f80: 2020 2020 2020 2765 7572 6f70 652d 7765        'europe-we
-00031f90: 7374 3827 2c20 2765 7572 6f70 652d 7765  st8', 'europe-we
-00031fa0: 7374 3927 2c20 2765 7572 6f70 652d 7765  st9', 'europe-we
-00031fb0: 7374 3130 272c 2027 6575 726f 7065 2d77  st10', 'europe-w
-00031fc0: 6573 7431 3227 2c0a 2020 2020 2020 2020  est12',.        
-00031fd0: 2761 7369 612d 6561 7374 3127 2c20 2761  'asia-east1', 'a
-00031fe0: 7369 612d 6561 7374 3227 2c20 2761 7369  sia-east2', 'asi
-00031ff0: 612d 6e6f 7274 6865 6173 7431 272c 2027  a-northeast1', '
-00032000: 6173 6961 2d6e 6f72 7468 6561 7374 3227  asia-northeast2'
-00032010: 2c0a 2020 2020 2020 2020 2761 7369 612d  ,.        'asia-
-00032020: 6e6f 7274 6865 6173 7433 272c 2027 6173  northeast3', 'as
-00032030: 6961 2d73 6f75 7468 6561 7374 3127 2c20  ia-southeast1', 
-00032040: 2761 7369 612d 736f 7574 6831 272c 2027  'asia-south1', '
-00032050: 6173 6961 2d73 6f75 7468 3227 2c0a 2020  asia-south2',.  
-00032060: 2020 2020 2020 2761 7369 612d 736f 7574        'asia-sout
-00032070: 6865 6173 7432 272c 2027 6d65 2d63 656e  heast2', 'me-cen
-00032080: 7472 616c 3127 2c20 276d 652d 6365 6e74  tral1', 'me-cent
-00032090: 7261 6c32 272c 2027 6d65 2d77 6573 7431  ral2', 'me-west1
-000320a0: 272c 0a20 2020 2020 2020 2027 6175 7374  ',.        'aust
-000320b0: 7261 6c69 612d 736f 7574 6865 6173 7431  ralia-southeast1
-000320c0: 272c 2027 6175 7374 7261 6c69 612d 736f  ', 'australia-so
-000320d0: 7574 6865 6173 7432 272c 2027 6166 7269  utheast2', 'afri
-000320e0: 6361 2d73 6f75 7468 3127 0a20 2020 205d  ca-south1'.    ]
-000320f0: 290a 2020 2020 6465 6620 7465 7374 5f67  ).    def test_g
-00032100: 6373 5f72 6567 696f 6e73 2873 656c 662c  cs_regions(self,
-00032110: 2074 6d70 5f6c 6f63 616c 5f73 746f 7261   tmp_local_stora
-00032120: 6765 5f6f 626a 2c20 7265 6769 6f6e 293a  ge_obj, region):
-00032130: 0a20 2020 2020 2020 2023 2054 6869 7320  .        # This 
-00032140: 7465 7374 7320 6372 6561 7469 6f6e 2061  tests creation a
-00032150: 6e64 2075 706c 6f61 6420 746f 2062 7563  nd upload to buc
-00032160: 6b65 7420 696e 2061 6c6c 2047 4353 2072  ket in all GCS r
-00032170: 6567 696f 6e73 0a20 2020 2020 2020 2023  egions.        #
-00032180: 2054 6f20 7465 7374 2066 756c 6c20 6675   To test full fu
-00032190: 6e63 7469 6f6e 616c 6974 792c 2075 7365  nctionality, use
-000321a0: 2074 6573 745f 7370 6f74 5f73 746f 7261   test_spot_stora
-000321b0: 6765 2061 626f 7665 2e0a 2020 2020 2020  ge above..      
-000321c0: 2020 7374 6f72 655f 7479 7065 203d 2073    store_type = s
-000321d0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-000321e0: 5479 7065 2e47 4353 0a20 2020 2020 2020  Type.GCS.       
-000321f0: 2074 6d70 5f6c 6f63 616c 5f73 746f 7261   tmp_local_stora
-00032200: 6765 5f6f 626a 2e61 6464 5f73 746f 7265  ge_obj.add_store
-00032210: 2873 746f 7265 5f74 7970 652c 2072 6567  (store_type, reg
-00032220: 696f 6e3d 7265 6769 6f6e 290a 2020 2020  ion=region).    
-00032230: 2020 2020 6275 636b 6574 5f6e 616d 6520      bucket_name 
-00032240: 3d20 746d 705f 6c6f 6361 6c5f 7374 6f72  = tmp_local_stor
-00032250: 6167 655f 6f62 6a2e 6e61 6d65 0a0a 2020  age_obj.name..  
-00032260: 2020 2020 2020 2320 436f 6e66 6972 6d20        # Confirm 
-00032270: 7468 6174 2074 6865 2062 7563 6b65 7420  that the bucket 
-00032280: 7761 7320 6372 6561 7465 6420 696e 2074  was created in t
-00032290: 6865 2063 6f72 7265 6374 2072 6567 696f  he correct regio
-000322a0: 6e0a 2020 2020 2020 2020 7265 6769 6f6e  n.        region
-000322b0: 5f63 6d64 203d 2073 656c 662e 636c 695f  _cmd = self.cli_
-000322c0: 7265 6769 6f6e 5f63 6d64 2873 746f 7265  region_cmd(store
-000322d0: 5f74 7970 652c 2062 7563 6b65 745f 6e61  _type, bucket_na
-000322e0: 6d65 290a 2020 2020 2020 2020 6f75 7420  me).        out 
-000322f0: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
-00032300: 636b 5f6f 7574 7075 7428 7265 6769 6f6e  ck_output(region
-00032310: 5f63 6d64 2c20 7368 656c 6c3d 5472 7565  _cmd, shell=True
-00032320: 290a 2020 2020 2020 2020 6f75 7470 7574  ).        output
-00032330: 203d 206f 7574 2e64 6563 6f64 6528 2775   = out.decode('u
-00032340: 7466 2d38 2729 0a20 2020 2020 2020 2061  tf-8').        a
-00032350: 7373 6572 7420 7265 6769 6f6e 2069 6e20  ssert region in 
-00032360: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
-00032370: 3827 292c 2028 0a20 2020 2020 2020 2020  8'), (.         
-00032380: 2020 2066 2742 7563 6b65 7420 7761 7320     f'Bucket was 
-00032390: 6e6f 7420 666f 756e 6420 696e 2072 6567  not found in reg
-000323a0: 696f 6e20 7b72 6567 696f 6e7d 202d 2027  ion {region} - '
-000323b0: 0a20 2020 2020 2020 2020 2020 2066 276f  .            f'o
-000323c0: 7574 7075 7420 6f66 207b 7265 6769 6f6e  utput of {region
-000323d0: 5f63 6d64 7d20 7761 733a 207b 6f75 7470  _cmd} was: {outp
-000323e0: 7574 7d27 290a 0a20 2020 2020 2020 2023  ut}')..        #
-000323f0: 2043 6865 636b 2069 6620 746d 705f 736f   Check if tmp_so
-00032400: 7572 6365 2f74 6d70 2d66 696c 6520 6578  urce/tmp-file ex
-00032410: 6973 7473 2069 6e20 7468 6520 6275 636b  ists in the buck
-00032420: 6574 2075 7369 6e67 2063 6c69 0a20 2020  et using cli.   
-00032430: 2020 2020 206c 735f 636d 6420 3d20 7365       ls_cmd = se
-00032440: 6c66 2e63 6c69 5f6c 735f 636d 6428 7374  lf.cli_ls_cmd(st
-00032450: 6f72 655f 7479 7065 2c20 6275 636b 6574  ore_type, bucket
-00032460: 5f6e 616d 6529 0a20 2020 2020 2020 206f  _name).        o
-00032470: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
-00032480: 6368 6563 6b5f 6f75 7470 7574 286c 735f  check_output(ls_
-00032490: 636d 642c 2073 6865 6c6c 3d54 7275 6529  cmd, shell=True)
-000324a0: 0a20 2020 2020 2020 206f 7574 7075 7420  .        output 
-000324b0: 3d20 6f75 742e 6465 636f 6465 2827 7574  = out.decode('ut
-000324c0: 662d 3827 290a 2020 2020 2020 2020 6173  f-8').        as
-000324d0: 7365 7274 2027 746d 702d 6669 6c65 2720  sert 'tmp-file' 
-000324e0: 696e 206f 7574 7075 742c 2028 0a20 2020  in output, (.   
-000324f0: 2020 2020 2020 2020 2066 2774 6d70 2d66           f'tmp-f
-00032500: 696c 6520 6e6f 7420 666f 756e 6420 696e  ile not found in
-00032510: 2062 7563 6b65 7420 2d20 6f75 7470 7574   bucket - output
-00032520: 206f 6620 7b6c 735f 636d 647d 2077 6173   of {ls_cmd} was
-00032530: 3a20 7b6f 7574 7075 747d 2729 0a0a 0a23  : {output}')...#
-00032540: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374   ---------- Test
-00032550: 696e 6720 5941 4d4c 2053 7065 6373 202d  ing YAML Specs -
-00032560: 2d2d 2d2d 2d2d 2d2d 2d0a 2320 4f75 7220  ---------.# Our 
-00032570: 736b 7920 7374 6f72 6167 6520 7265 7175  sky storage requ
-00032580: 6972 6573 2063 7265 6465 6e74 6961 6c73  ires credentials
-00032590: 2074 6f20 6368 6563 6b20 7468 6520 6275   to check the bu
-000325a0: 636b 6574 2065 7869 7374 616e 6365 2077  cket existance w
-000325b0: 6865 6e0a 2320 6c6f 6164 696e 6720 6120  hen.# loading a 
-000325c0: 7461 736b 2066 726f 6d20 7468 6520 7961  task from the ya
-000325d0: 6d6c 2066 696c 652c 2073 6f20 7765 2063  ml file, so we c
-000325e0: 616e 6e6f 7420 6d61 6b65 2069 7420 6120  annot make it a 
-000325f0: 756e 6974 2074 6573 742e 0a63 6c61 7373  unit test..class
-00032600: 2054 6573 7459 616d 6c53 7065 6373 3a0a   TestYamlSpecs:.
-00032610: 2020 2020 2320 544f 444f 287a 6877 7529      # TODO(zhwu)
-00032620: 3a20 4164 6420 7465 7374 2066 6f72 2060  : Add test for `
-00032630: 746f 5f79 616d 6c5f 636f 6e66 6967 6020  to_yaml_config` 
-00032640: 666f 7220 7468 6520 5374 6f72 6167 6520  for the Storage 
-00032650: 6f62 6a65 6374 2e0a 2020 2020 2320 2057  object..    #  W
-00032660: 6520 7368 6f75 6c64 206e 6f74 2075 7365  e should not use
-00032670: 2060 6578 616d 706c 6573 2f73 746f 7261   `examples/stora
-00032680: 6765 5f64 656d 6f2e 7961 6d6c 6020 6865  ge_demo.yaml` he
-00032690: 7265 2c20 7369 6e63 6520 6974 2072 6571  re, since it req
-000326a0: 7569 7265 730a 2020 2020 2320 2075 7365  uires.    #  use
-000326b0: 7273 2074 6f20 656e 7375 7265 2062 7563  rs to ensure buc
-000326c0: 6b65 7420 6e61 6d65 7320 746f 206e 6f74  ket names to not
-000326d0: 2065 7869 7374 2061 6e64 2f6f 7220 6265   exist and/or be
-000326e0: 2075 6e69 7175 652e 0a20 2020 205f 5445   unique..    _TE
-000326f0: 5354 5f59 414d 4c5f 5041 5448 5320 3d20  ST_YAML_PATHS = 
-00032700: 5b0a 2020 2020 2020 2020 2765 7861 6d70  [.        'examp
-00032710: 6c65 732f 6d69 6e69 6d61 6c2e 7961 6d6c  les/minimal.yaml
-00032720: 272c 2027 6578 616d 706c 6573 2f6d 616e  ', 'examples/man
-00032730: 6167 6564 5f73 706f 742e 7961 6d6c 272c  aged_spot.yaml',
-00032740: 0a20 2020 2020 2020 2027 6578 616d 706c  .        'exampl
-00032750: 6573 2f75 7369 6e67 5f66 696c 655f 6d6f  es/using_file_mo
-00032760: 756e 7473 2e79 616d 6c27 2c20 2765 7861  unts.yaml', 'exa
-00032770: 6d70 6c65 732f 7265 736e 6574 5f61 7070  mples/resnet_app
-00032780: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00032790: 2765 7861 6d70 6c65 732f 6d75 6c74 695f  'examples/multi_
-000327a0: 686f 7374 6e61 6d65 2e79 616d 6c27 0a20  hostname.yaml'. 
-000327b0: 2020 205d 0a0a 2020 2020 6465 6620 5f69     ]..    def _i
-000327c0: 735f 6469 6374 5f73 7562 7365 7428 7365  s_dict_subset(se
-000327d0: 6c66 2c20 6431 2c20 6432 293a 0a20 2020  lf, d1, d2):.   
-000327e0: 2020 2020 2022 2222 4368 6563 6b20 6966       """Check if
-000327f0: 2064 3120 6973 2074 6865 2073 7562 7365   d1 is the subse
-00032800: 7420 6f66 2064 322e 2222 220a 2020 2020  t of d2.""".    
-00032810: 2020 2020 666f 7220 6b2c 2076 2069 6e20      for k, v in 
-00032820: 6431 2e69 7465 6d73 2829 3a0a 2020 2020  d1.items():.    
-00032830: 2020 2020 2020 2020 6966 206b 206e 6f74          if k not
-00032840: 2069 6e20 6432 3a0a 2020 2020 2020 2020   in d2:.        
-00032850: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00032860: 7461 6e63 6528 762c 206c 6973 7429 206f  tance(v, list) o
-00032870: 7220 6973 696e 7374 616e 6365 2876 2c20  r isinstance(v, 
-00032880: 6469 6374 293a 0a20 2020 2020 2020 2020  dict):.         
-00032890: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-000328a0: 7420 6c65 6e28 7629 203d 3d20 302c 2028  t len(v) == 0, (
-000328b0: 6b2c 2076 290a 2020 2020 2020 2020 2020  k, v).          
-000328c0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000328d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000328e0: 6173 7365 7274 2046 616c 7365 2c20 286b  assert False, (k
-000328f0: 2c20 7629 0a20 2020 2020 2020 2020 2020  , v).           
-00032900: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
-00032910: 2876 2c20 6469 6374 293a 0a20 2020 2020  (v, dict):.     
-00032920: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00032930: 7420 6973 696e 7374 616e 6365 2864 325b  t isinstance(d2[
-00032940: 6b5d 2c20 6469 6374 292c 2028 6b2c 2076  k], dict), (k, v
-00032950: 2c20 6432 290a 2020 2020 2020 2020 2020  , d2).          
-00032960: 2020 2020 2020 7365 6c66 2e5f 6973 5f64        self._is_d
-00032970: 6963 745f 7375 6273 6574 2876 2c20 6432  ict_subset(v, d2
-00032980: 5b6b 5d29 0a20 2020 2020 2020 2020 2020  [k]).           
-00032990: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
-000329a0: 2876 2c20 7374 7229 3a0a 2020 2020 2020  (v, str):.      
-000329b0: 2020 2020 2020 2020 2020 6966 206b 203d            if k =
-000329c0: 3d20 2761 6363 656c 6572 6174 6f72 7327  = 'accelerators'
-000329d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000329e0: 2020 2020 2020 7265 736f 7572 6365 7320        resources 
-000329f0: 3d20 736b 792e 5265 736f 7572 6365 7328  = sky.Resources(
-00032a00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00032a10: 2020 2020 2020 7265 736f 7572 6365 732e        resources.
-00032a20: 5f73 6574 5f61 6363 656c 6572 6174 6f72  _set_accelerator
-00032a30: 7328 762c 204e 6f6e 6529 0a20 2020 2020  s(v, None).     
-00032a40: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00032a50: 7373 6572 7420 7265 736f 7572 6365 732e  ssert resources.
-00032a60: 6163 6365 6c65 7261 746f 7273 203d 3d20  accelerators == 
-00032a70: 6432 5b6b 5d2c 2028 6b2c 2076 2c20 6432  d2[k], (k, v, d2
-00032a80: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00032a90: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00032aa0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00032ab0: 7274 2076 2e6c 6f77 6572 2829 203d 3d20  rt v.lower() == 
-00032ac0: 6432 5b6b 5d2e 6c6f 7765 7228 292c 2028  d2[k].lower(), (
-00032ad0: 6b2c 2076 2c20 6432 5b6b 5d29 0a20 2020  k, v, d2[k]).   
-00032ae0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00032af0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00032b00: 7373 6572 7420 7620 3d3d 2064 325b 6b5d  ssert v == d2[k]
-00032b10: 2c20 286b 2c20 762c 2064 325b 6b5d 290a  , (k, v, d2[k]).
-00032b20: 0a20 2020 2064 6566 205f 6368 6563 6b5f  .    def _check_
-00032b30: 6571 7569 7661 6c65 6e74 2873 656c 662c  equivalent(self,
-00032b40: 2079 616d 6c5f 7061 7468 293a 0a20 2020   yaml_path):.   
-00032b50: 2020 2020 2022 2222 4368 6563 6b20 6966       """Check if
-00032b60: 2074 6865 2079 616d 6c20 6973 2065 7175   the yaml is equ
-00032b70: 6976 616c 656e 7420 6166 7465 7220 6c6f  ivalent after lo
-00032b80: 6164 2061 6e64 2064 756d 7020 6167 6169  ad and dump agai
-00032b90: 6e2e 2222 220a 2020 2020 2020 2020 6f72  n.""".        or
-00032ba0: 6967 696e 5f74 6173 6b5f 636f 6e66 6967  igin_task_config
-00032bb0: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
-00032bc0: 7265 6164 5f79 616d 6c28 7961 6d6c 5f70  read_yaml(yaml_p
-00032bd0: 6174 6829 0a0a 2020 2020 2020 2020 7461  ath)..        ta
-00032be0: 736b 203d 2073 6b79 2e54 6173 6b2e 6672  sk = sky.Task.fr
-00032bf0: 6f6d 5f79 616d 6c28 7961 6d6c 5f70 6174  om_yaml(yaml_pat
-00032c00: 6829 0a20 2020 2020 2020 206e 6577 5f74  h).        new_t
-00032c10: 6173 6b5f 636f 6e66 6967 203d 2074 6173  ask_config = tas
-00032c20: 6b2e 746f 5f79 616d 6c5f 636f 6e66 6967  k.to_yaml_config
-00032c30: 2829 0a20 2020 2020 2020 2023 2064 3120  ().        # d1 
-00032c40: 3c3d 2064 320a 2020 2020 2020 2020 7072  <= d2.        pr
-00032c50: 696e 7428 6f72 6967 696e 5f74 6173 6b5f  int(origin_task_
-00032c60: 636f 6e66 6967 2c20 6e65 775f 7461 736b  config, new_task
-00032c70: 5f63 6f6e 6669 6729 0a20 2020 2020 2020  _config).       
-00032c80: 2073 656c 662e 5f69 735f 6469 6374 5f73   self._is_dict_s
-00032c90: 7562 7365 7428 6f72 6967 696e 5f74 6173  ubset(origin_tas
-00032ca0: 6b5f 636f 6e66 6967 2c20 6e65 775f 7461  k_config, new_ta
-00032cb0: 736b 5f63 6f6e 6669 6729 0a0a 2020 2020  sk_config)..    
-00032cc0: 6465 6620 7465 7374 5f6c 6f61 645f 6475  def test_load_du
-00032cd0: 6d70 5f79 616d 6c5f 636f 6e66 6967 5f65  mp_yaml_config_e
-00032ce0: 7175 6976 616c 656e 7428 7365 6c66 293a  quivalent(self):
-00032cf0: 0a20 2020 2020 2020 2022 2222 5465 7374  .        """Test
-00032d00: 2069 6620 7468 6520 7961 6d6c 2063 6f6e   if the yaml con
-00032d10: 6669 6720 6973 2065 7175 6976 616c 656e  fig is equivalen
-00032d20: 7420 6166 7465 7220 6c6f 6164 2061 6e64  t after load and
-00032d30: 2064 756d 7020 6167 6169 6e2e 2222 220a   dump again.""".
-00032d40: 2020 2020 2020 2020 7061 7468 6c69 622e          pathlib.
-00032d50: 5061 7468 2827 7e2f 6461 7461 7365 7473  Path('~/datasets
-00032d60: 2729 2e65 7870 616e 6475 7365 7228 292e  ').expanduser().
-00032d70: 6d6b 6469 7228 6578 6973 745f 6f6b 3d54  mkdir(exist_ok=T
-00032d80: 7275 6529 0a20 2020 2020 2020 2070 6174  rue).        pat
-00032d90: 686c 6962 2e50 6174 6828 277e 2f74 6d70  hlib.Path('~/tmp
-00032da0: 6669 6c65 2729 2e65 7870 616e 6475 7365  file').expanduse
-00032db0: 7228 292e 746f 7563 6828 290a 2020 2020  r().touch().    
-00032dc0: 2020 2020 7061 7468 6c69 622e 5061 7468      pathlib.Path
-00032dd0: 2827 7e2f 2e73 7368 2729 2e65 7870 616e  ('~/.ssh').expan
-00032de0: 6475 7365 7228 292e 6d6b 6469 7228 6578  duser().mkdir(ex
-00032df0: 6973 745f 6f6b 3d54 7275 6529 0a20 2020  ist_ok=True).   
-00032e00: 2020 2020 2070 6174 686c 6962 2e50 6174       pathlib.Pat
-00032e10: 6828 277e 2f2e 7373 682f 6964 5f72 7361  h('~/.ssh/id_rsa
-00032e20: 2e70 7562 2729 2e65 7870 616e 6475 7365  .pub').expanduse
-00032e30: 7228 292e 746f 7563 6828 290a 2020 2020  r().touch().    
-00032e40: 2020 2020 7061 7468 6c69 622e 5061 7468      pathlib.Path
-00032e50: 2827 7e2f 746d 702d 776f 726b 6469 7227  ('~/tmp-workdir'
-00032e60: 292e 6578 7061 6e64 7573 6572 2829 2e6d  ).expanduser().m
-00032e70: 6b64 6972 2865 7869 7374 5f6f 6b3d 5472  kdir(exist_ok=Tr
-00032e80: 7565 290a 2020 2020 2020 2020 7061 7468  ue).        path
-00032e90: 6c69 622e 5061 7468 2827 7e2f 446f 776e  lib.Path('~/Down
-00032ea0: 6c6f 6164 732f 7470 7527 292e 6578 7061  loads/tpu').expa
-00032eb0: 6e64 7573 6572 2829 2e6d 6b64 6972 2870  nduser().mkdir(p
-00032ec0: 6172 656e 7473 3d54 7275 652c 0a20 2020  arents=True,.   
-00032ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032f00: 2020 2020 2020 2020 6578 6973 745f 6f6b          exist_ok
-00032f10: 3d54 7275 6529 0a20 2020 2020 2020 2066  =True).        f
-00032f20: 6f72 2079 616d 6c5f 7061 7468 2069 6e20  or yaml_path in 
-00032f30: 7365 6c66 2e5f 5445 5354 5f59 414d 4c5f  self._TEST_YAML_
-00032f40: 5041 5448 533a 0a20 2020 2020 2020 2020  PATHS:.         
-00032f50: 2020 2073 656c 662e 5f63 6865 636b 5f65     self._check_e
-00032f60: 7175 6976 616c 656e 7428 7961 6d6c 5f70  quivalent(yaml_p
-00032f70: 6174 6829 0a0a 0a23 202d 2d2d 2d2d 2d2d  ath)...# -------
-00032f80: 2d2d 2d20 5465 7374 696e 6720 4d75 6c74  --- Testing Mult
-00032f90: 6970 6c65 2041 6363 656c 6572 6174 6f72  iple Accelerator
-00032fa0: 7320 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  s ----------.@py
-00032fb0: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
-00032fc0: 6964 7374 6163 6b20 2023 2046 6c75 6964  idstack  # Fluid
-00032fd0: 7374 6163 6b20 646f 6573 206e 6f74 2073  stack does not s
-00032fe0: 7570 706f 7274 204b 3830 2067 7075 7320  upport K80 gpus 
-00032ff0: 666f 7220 6e6f 770a 4070 7974 6573 742e  for now.@pytest.
-00033000: 6d61 726b 2e6e 6f5f 7061 7065 7273 7061  mark.no_paperspa
-00033010: 6365 2020 2320 5061 7065 7273 7061 6365  ce  # Paperspace
-00033020: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00033030: 7420 4b38 3020 6770 7573 0a64 6566 2074  t K80 gpus.def t
-00033040: 6573 745f 6d75 6c74 6970 6c65 5f61 6363  est_multiple_acc
-00033050: 656c 6572 6174 6f72 735f 6f72 6465 7265  elerators_ordere
-00033060: 6428 293a 0a20 2020 206e 616d 6520 3d20  d():.    name = 
-00033070: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00033080: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00033090: 6573 7428 0a20 2020 2020 2020 2027 6d75  est(.        'mu
-000330a0: 6c74 6970 6c65 2d61 6363 656c 6572 6174  ltiple-accelerat
-000330b0: 6f72 732d 6f72 6465 7265 6427 2c0a 2020  ors-ordered',.  
-000330c0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-000330d0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-000330e0: 202d 7920 2d63 207b 6e61 6d65 7d20 7465   -y -c {name} te
-000330f0: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
-00033100: 6573 745f 6d75 6c74 6970 6c65 5f61 6363  est_multiple_acc
-00033110: 656c 6572 6174 6f72 735f 6f72 6465 7265  elerators_ordere
-00033120: 642e 7961 6d6c 207c 2067 7265 7020 2255  d.yaml | grep "U
-00033130: 7369 6e67 2075 7365 722d 7370 6563 6966  sing user-specif
-00033140: 6965 6420 6163 6365 6c65 7261 746f 7273  ied accelerators
-00033150: 206c 6973 7422 272c 0a20 2020 2020 2020   list"',.       
-00033160: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00033170: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-00033180: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-00033190: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-000331a0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-000331b0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-000331c0: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
-000331d0: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
-000331e0: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-000331f0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00033200: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00033210: 6e6f 5f66 6c75 6964 7374 6163 6b20 2023  no_fluidstack  #
-00033220: 2046 6c75 6964 7374 6163 6b20 6861 7320   Fluidstack has 
-00033230: 6c6f 7720 6176 6169 6c61 6269 6c69 7479  low availability
-00033240: 2066 6f72 2054 3420 4750 5573 0a40 7079   for T4 GPUs.@py
-00033250: 7465 7374 2e6d 6172 6b2e 6e6f 5f70 6170  test.mark.no_pap
-00033260: 6572 7370 6163 6520 2023 2050 6170 6572  erspace  # Paper
-00033270: 7370 6163 6520 646f 6573 206e 6f74 2073  space does not s
-00033280: 7570 706f 7274 2054 3420 4750 5573 0a64  upport T4 GPUs.d
-00033290: 6566 2074 6573 745f 6d75 6c74 6970 6c65  ef test_multiple
-000332a0: 5f61 6363 656c 6572 6174 6f72 735f 6f72  _accelerators_or
-000332b0: 6465 7265 645f 7769 7468 5f64 6566 6175  dered_with_defau
-000332c0: 6c74 2829 3a0a 2020 2020 6e61 6d65 203d  lt():.    name =
-000332d0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-000332e0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-000332f0: 5465 7374 280a 2020 2020 2020 2020 276d  Test(.        'm
-00033300: 756c 7469 706c 652d 6163 6365 6c65 7261  ultiple-accelera
-00033310: 746f 7273 2d6f 7264 6572 6564 272c 0a20  tors-ordered',. 
-00033320: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00033330: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00033340: 6820 2d79 202d 6320 7b6e 616d 657d 2074  h -y -c {name} t
-00033350: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
-00033360: 7465 7374 5f6d 756c 7469 706c 655f 6163  test_multiple_ac
-00033370: 6365 6c65 7261 746f 7273 5f6f 7264 6572  celerators_order
-00033380: 6564 5f77 6974 685f 6465 6661 756c 742e  ed_with_default.
-00033390: 7961 6d6c 207c 2067 7265 7020 2255 7369  yaml | grep "Usi
-000333a0: 6e67 2075 7365 722d 7370 6563 6966 6965  ng user-specifie
-000333b0: 6420 6163 6365 6c65 7261 746f 7273 206c  d accelerators l
-000333c0: 6973 7422 272c 0a20 2020 2020 2020 2020  ist"',.         
-000333d0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-000333e0: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
-000333f0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-00033400: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-00033410: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00033420: 2073 7461 7475 7320 7b6e 616d 657d 207c   status {name} |
-00033430: 2067 7265 7020 5370 6f74 272c 0a20 2020   grep Spot',.   
-00033440: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00033450: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-00033460: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
-00033470: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00033480: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00033490: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
-000334a0: 2020 2320 466c 7569 6473 7461 636b 2068    # Fluidstack h
-000334b0: 6173 206c 6f77 2061 7661 696c 6162 696c  as low availabil
-000334c0: 6974 7920 666f 7220 5434 2047 5055 730a  ity for T4 GPUs.
-000334d0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-000334e0: 7061 7065 7273 7061 6365 2020 2320 5061  paperspace  # Pa
-000334f0: 7065 7273 7061 6365 2064 6f65 7320 6e6f  perspace does no
-00033500: 7420 7375 7070 6f72 7420 5434 2047 5055  t support T4 GPU
-00033510: 730a 6465 6620 7465 7374 5f6d 756c 7469  s.def test_multi
-00033520: 706c 655f 6163 6365 6c65 7261 746f 7273  ple_accelerators
-00033530: 5f75 6e6f 7264 6572 6564 2829 3a0a 2020  _unordered():.  
-00033540: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00033550: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00033560: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00033570: 2020 2020 2020 276d 756c 7469 706c 652d        'multiple-
-00033580: 6163 6365 6c65 7261 746f 7273 2d75 6e6f  accelerators-uno
-00033590: 7264 6572 6564 272c 0a20 2020 2020 2020  rdered',.       
-000335a0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-000335b0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-000335c0: 6320 7b6e 616d 657d 2074 6573 7473 2f74  c {name} tests/t
-000335d0: 6573 745f 7961 6d6c 732f 7465 7374 5f6d  est_yamls/test_m
-000335e0: 756c 7469 706c 655f 6163 6365 6c65 7261  ultiple_accelera
-000335f0: 746f 7273 5f75 6e6f 7264 6572 6564 2e79  tors_unordered.y
-00033600: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00033610: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00033620: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-00033630: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-00033640: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-00033650: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00033660: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00033670: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-00033680: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00033690: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-000336a0: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
-000336b0: 6b20 2023 2046 6c75 6964 7374 6163 6b20  k  # Fluidstack 
-000336c0: 6861 7320 6c6f 7720 6176 6169 6c61 6269  has low availabi
-000336d0: 6c69 7479 2066 6f72 2054 3420 4750 5573  lity for T4 GPUs
-000336e0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-000336f0: 5f70 6170 6572 7370 6163 6520 2023 2050  _paperspace  # P
-00033700: 6170 6572 7370 6163 6520 646f 6573 206e  aperspace does n
-00033710: 6f74 2073 7570 706f 7274 2054 3420 4750  ot support T4 GP
-00033720: 5573 0a64 6566 2074 6573 745f 6d75 6c74  Us.def test_mult
-00033730: 6970 6c65 5f61 6363 656c 6572 6174 6f72  iple_accelerator
-00033740: 735f 756e 6f72 6465 7265 645f 7769 7468  s_unordered_with
-00033750: 5f64 6566 6175 6c74 2829 3a0a 2020 2020  _default():.    
-00033760: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-00033770: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-00033780: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-00033790: 2020 2020 276d 756c 7469 706c 652d 6163      'multiple-ac
-000337a0: 6365 6c65 7261 746f 7273 2d75 6e6f 7264  celerators-unord
-000337b0: 6572 6564 272c 0a20 2020 2020 2020 205b  ered',.        [
-000337c0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000337d0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-000337e0: 7b6e 616d 657d 2074 6573 7473 2f74 6573  {name} tests/tes
-000337f0: 745f 7961 6d6c 732f 7465 7374 5f6d 756c  t_yamls/test_mul
-00033800: 7469 706c 655f 6163 6365 6c65 7261 746f  tiple_accelerato
-00033810: 7273 5f75 6e6f 7264 6572 6564 5f77 6974  rs_unordered_wit
-00033820: 685f 6465 6661 756c 742e 7961 6d6c 272c  h_default.yaml',
-00033830: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00033840: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-00033850: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
-00033860: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
-00033870: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
-00033880: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
-00033890: 7320 7b6e 616d 657d 207c 2067 7265 7020  s {name} | grep 
-000338a0: 5370 6f74 272c 0a20 2020 2020 2020 205d  Spot',.        ]
-000338b0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-000338c0: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-000338d0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-000338e0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-000338f0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00033900: 666c 7569 6473 7461 636b 2020 2320 5265  fluidstack  # Re
-00033910: 7175 6972 6573 206f 7468 6572 2063 6c6f  quires other clo
-00033920: 7564 7320 746f 2062 6520 656e 6162 6c65  uds to be enable
-00033930: 640a 6465 6620 7465 7374 5f6d 756c 7469  d.def test_multi
-00033940: 706c 655f 7265 736f 7572 6365 7328 293a  ple_resources():
-00033950: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00033960: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-00033970: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00033980: 0a20 2020 2020 2020 2027 6d75 6c74 6970  .        'multip
-00033990: 6c65 2d72 6573 6f75 7263 6573 272c 0a20  le-resources',. 
-000339a0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-000339b0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-000339c0: 6820 2d79 202d 6320 7b6e 616d 657d 2074  h -y -c {name} t
-000339d0: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
-000339e0: 7465 7374 5f6d 756c 7469 706c 655f 7265  test_multiple_re
-000339f0: 736f 7572 6365 732e 7961 6d6c 272c 0a20  sources.yaml',. 
-00033a00: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00033a10: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-00033a20: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
-00033a30: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
-00033a40: 6565 6465 642e 0a20 2020 2020 2020 205d  eeded..        ]
-00033a50: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00033a60: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-00033a70: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00033a80: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00033a90: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2053 6b79  # ---------- Sky
-00033aa0: 2042 656e 6368 6d61 726b 202d 2d2d 2d2d   Benchmark -----
-00033ab0: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
-00033ac0: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
-00033ad0: 2020 2320 5265 7175 6972 6573 206f 7468    # Requires oth
-00033ae0: 6572 2063 6c6f 7564 7320 746f 2062 6520  er clouds to be 
-00033af0: 656e 6162 6c65 640a 4070 7974 6573 742e  enabled.@pytest.
-00033b00: 6d61 726b 2e6e 6f5f 7061 7065 7273 7061  mark.no_paperspa
-00033b10: 6365 2020 2320 5265 7175 6972 6573 206f  ce  # Requires o
-00033b20: 7468 6572 2063 6c6f 7564 7320 746f 2062  ther clouds to b
-00033b30: 6520 656e 6162 6c65 640a 4070 7974 6573  e enabled.@pytes
-00033b40: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
-00033b50: 6574 6573 0a64 6566 2074 6573 745f 736b  etes.def test_sk
-00033b60: 795f 6265 6e63 6828 6765 6e65 7269 635f  y_bench(generic_
-00033b70: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
-00033b80: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00033b90: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00033ba0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00033bb0: 2020 2020 2027 736b 792d 6265 6e63 6827       'sky-bench'
-00033bc0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00033bd0: 2020 2020 2020 2020 6627 736b 7920 6265          f'sky be
-00033be0: 6e63 6820 6c61 756e 6368 202d 7920 2d62  nch launch -y -b
-00033bf0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-00033c00: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
-00033c10: 2d69 3020 7465 7374 732f 7465 7374 5f79  -i0 tests/test_y
-00033c20: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
-00033c30: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00033c40: 2773 6c65 6570 2031 3230 272c 0a20 2020  'sleep 120',.   
-00033c50: 2020 2020 2020 2020 2066 2773 6b79 2062           f'sky b
-00033c60: 656e 6368 2073 686f 7720 7b6e 616d 657d  ench show {name}
-00033c70: 207c 2067 7265 7020 736b 792d 6265 6e63   | grep sky-benc
-00033c80: 682d 7b6e 616d 657d 207c 2067 7265 7020  h-{name} | grep 
-00033c90: 4649 4e49 5348 4544 272c 0a20 2020 2020  FINISHED',.     
-00033ca0: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-00033cb0: 736b 7920 6265 6e63 6820 646f 776e 207b  sky bench down {
-00033cc0: 6e61 6d65 7d20 2d79 3b20 736b 7920 6265  name} -y; sky be
-00033cd0: 6e63 6820 6465 6c65 7465 207b 6e61 6d65  nch delete {name
-00033ce0: 7d20 2d79 272c 0a20 2020 2029 0a20 2020  } -y',.    ).   
-00033cf0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00033d00: 7374 290a                                st).
+00031120: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+00031130: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+00031140: 2e49 424d 2c0a 2020 2020 2020 2020 2020  .IBM,.          
+00031150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031170: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
+00031180: 726b 2e69 626d 292c 0a20 2020 2020 2020  rk.ibm),.       
+00031190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000311a0: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
+000311b0: 7261 6d28 4157 535f 494e 5641 4c49 445f  ram(AWS_INVALID_
+000311c0: 4e41 4d45 532c 0a20 2020 2020 2020 2020  NAMES,.         
+000311d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000311e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000311f0: 2020 7374 6f72 6167 655f 6c69 622e 5374    storage_lib.St
+00031200: 6f72 6554 7970 652e 5232 2c0a 2020 2020  oreType.R2,.    
+00031210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031230: 2020 2020 2020 206d 6172 6b73 3d70 7974         marks=pyt
+00031240: 6573 742e 6d61 726b 2e63 6c6f 7564 666c  est.mark.cloudfl
+00031250: 6172 6529 5d29 0a20 2020 2064 6566 2074  are)]).    def t
+00031260: 6573 745f 696e 7661 6c69 645f 6e61 6d65  est_invalid_name
+00031270: 7328 7365 6c66 2c20 696e 7661 6c69 645f  s(self, invalid_
+00031280: 6e61 6d65 5f6c 6973 742c 2073 746f 7265  name_list, store
+00031290: 5f74 7970 6529 3a0a 2020 2020 2020 2020  _type):.        
+000312a0: 2320 5573 6573 2061 206c 6973 7420 696e  # Uses a list in
+000312b0: 2074 6865 2073 6f75 7263 6520 6669 656c   the source fiel
+000312c0: 6420 746f 2073 7065 6369 6679 2061 2066  d to specify a f
+000312d0: 696c 6520 616e 6420 6120 6469 7265 6374  ile and a direct
+000312e0: 6f72 7920 746f 0a20 2020 2020 2020 2023  ory to.        #
+000312f0: 2062 6520 7570 6c6f 6164 6564 2074 6f20   be uploaded to 
+00031300: 7468 6520 7374 6f72 6167 6520 6f62 6a65  the storage obje
+00031310: 6374 2e0a 2020 2020 2020 2020 666f 7220  ct..        for 
+00031320: 6e61 6d65 2069 6e20 696e 7661 6c69 645f  name in invalid_
+00031330: 6e61 6d65 5f6c 6973 743a 0a20 2020 2020  name_list:.     
+00031340: 2020 2020 2020 2077 6974 6820 7079 7465         with pyte
+00031350: 7374 2e72 6169 7365 7328 736b 792e 6578  st.raises(sky.ex
+00031360: 6365 7074 696f 6e73 2e53 746f 7261 6765  ceptions.Storage
+00031370: 4e61 6d65 4572 726f 7229 3a0a 2020 2020  NameError):.    
+00031380: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+00031390: 6167 655f 6f62 6a20 3d20 7374 6f72 6167  age_obj = storag
+000313a0: 655f 6c69 622e 5374 6f72 6167 6528 6e61  e_lib.Storage(na
+000313b0: 6d65 3d6e 616d 6529 0a20 2020 2020 2020  me=name).       
+000313c0: 2020 2020 2020 2020 2073 746f 7261 6765           storage
+000313d0: 5f6f 626a 2e61 6464 5f73 746f 7265 2873  _obj.add_store(s
+000313e0: 746f 7265 5f74 7970 6529 0a0a 2020 2020  tore_type)..    
+000313f0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00031400: 666c 7569 6473 7461 636b 0a20 2020 2040  fluidstack.    @
+00031410: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
+00031420: 6d65 7472 697a 6528 0a20 2020 2020 2020  metrize(.       
+00031430: 2027 6769 7469 676e 6f72 655f 7374 7275   'gitignore_stru
+00031440: 6374 7572 652c 2073 746f 7265 5f74 7970  cture, store_typ
+00031450: 6527 2c0a 2020 2020 2020 2020 5b28 4749  e',.        [(GI
+00031460: 5449 474e 4f52 455f 5359 4e43 5f54 4553  TIGNORE_SYNC_TES
+00031470: 545f 4449 525f 5354 5255 4354 5552 452c  T_DIR_STRUCTURE,
+00031480: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+00031490: 7265 5479 7065 2e53 3329 2c0a 2020 2020  reType.S3),.    
+000314a0: 2020 2020 2028 4749 5449 474e 4f52 455f       (GITIGNORE_
+000314b0: 5359 4e43 5f54 4553 545f 4449 525f 5354  SYNC_TEST_DIR_ST
+000314c0: 5255 4354 5552 452c 2073 746f 7261 6765  RUCTURE, storage
+000314d0: 5f6c 6962 2e53 746f 7265 5479 7065 2e47  _lib.StoreType.G
+000314e0: 4353 292c 0a20 2020 2020 2020 2020 7079  CS),.         py
+000314f0: 7465 7374 2e70 6172 616d 2847 4954 4947  test.param(GITIG
+00031500: 4e4f 5245 5f53 594e 435f 5445 5354 5f44  NORE_SYNC_TEST_D
+00031510: 4952 5f53 5452 5543 5455 5245 2c0a 2020  IR_STRUCTURE,.  
+00031520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031530: 2020 2020 7374 6f72 6167 655f 6c69 622e      storage_lib.
+00031540: 5374 6f72 6554 7970 652e 5232 2c0a 2020  StoreType.R2,.  
+00031550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031560: 2020 2020 6d61 726b 733d 7079 7465 7374      marks=pytest
+00031570: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
+00031580: 295d 290a 2020 2020 6465 6620 7465 7374  )]).    def test
+00031590: 5f65 7863 6c75 6465 645f 6669 6c65 5f63  _excluded_file_c
+000315a0: 6c6f 7564 5f73 746f 7261 6765 5f75 706c  loud_storage_upl
+000315b0: 6f61 645f 636f 7079 2873 656c 662c 2067  oad_copy(self, g
+000315c0: 6974 6967 6e6f 7265 5f73 7472 7563 7475  itignore_structu
+000315d0: 7265 2c0a 2020 2020 2020 2020 2020 2020  re,.            
+000315e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000315f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031600: 2020 2020 2020 2020 2073 746f 7265 5f74           store_t
+00031610: 7970 652c 0a20 2020 2020 2020 2020 2020  ype,.           
+00031620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031640: 2020 2020 2020 2020 2020 746d 705f 6769            tmp_gi
+00031650: 7469 676e 6f72 655f 7374 6f72 6167 655f  tignore_storage_
+00031660: 6f62 6a29 3a0a 2020 2020 2020 2020 2320  obj):.        # 
+00031670: 7465 7374 7320 6966 2066 696c 6573 2069  tests if files i
+00031680: 6e63 6c75 6465 6420 696e 202e 6769 7469  ncluded in .giti
+00031690: 676e 6f72 6520 616e 6420 2e67 6974 2f69  gnore and .git/i
+000316a0: 6e66 6f2f 6578 636c 7564 6520 6172 650a  nfo/exclude are.
+000316b0: 2020 2020 2020 2020 2320 6578 636c 7564          # exclud
+000316c0: 6564 2066 726f 6d20 6265 696e 6720 7472  ed from being tr
+000316d0: 616e 7366 6572 7265 6420 746f 2053 746f  ansferred to Sto
+000316e0: 7261 6765 0a0a 2020 2020 2020 2020 746d  rage..        tm
+000316f0: 705f 6769 7469 676e 6f72 655f 7374 6f72  p_gitignore_stor
+00031700: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
+00031710: 6528 7374 6f72 655f 7479 7065 290a 0a20  e(store_type).. 
+00031720: 2020 2020 2020 2075 706c 6f61 645f 6669         upload_fi
+00031730: 6c65 5f6e 616d 6520 3d20 2769 6e63 6c75  le_name = 'inclu
+00031740: 6465 6427 0a20 2020 2020 2020 2023 2043  ded'.        # C
+00031750: 6f75 6e74 2074 6865 206e 756d 6265 7220  ount the number 
+00031760: 6f66 2066 696c 6573 2077 6974 6820 7468  of files with th
+00031770: 6520 6769 7665 6e20 6669 6c65 206e 616d  e given file nam
+00031780: 650a 2020 2020 2020 2020 7570 5f63 6d64  e.        up_cmd
+00031790: 203d 2073 656c 662e 636c 695f 636f 756e   = self.cli_coun
+000317a0: 745f 6e61 6d65 5f69 6e5f 6275 636b 6574  t_name_in_bucket
+000317b0: 2873 746f 7265 5f74 7970 652c 205c 0a20  (store_type, \. 
+000317c0: 2020 2020 2020 2020 2020 2074 6d70 5f67             tmp_g
+000317d0: 6974 6967 6e6f 7265 5f73 746f 7261 6765  itignore_storage
+000317e0: 5f6f 626a 2e6e 616d 652c 2066 696c 655f  _obj.name, file_
+000317f0: 6e61 6d65 3d75 706c 6f61 645f 6669 6c65  name=upload_file
+00031800: 5f6e 616d 6529 0a20 2020 2020 2020 2067  _name).        g
+00031810: 6974 5f65 7863 6c75 6465 5f63 6d64 203d  it_exclude_cmd =
+00031820: 2073 656c 662e 636c 695f 636f 756e 745f   self.cli_count_
+00031830: 6e61 6d65 5f69 6e5f 6275 636b 6574 2873  name_in_bucket(s
+00031840: 746f 7265 5f74 7970 652c 205c 0a20 2020  tore_type, \.   
+00031850: 2020 2020 2020 2020 2074 6d70 5f67 6974           tmp_git
+00031860: 6967 6e6f 7265 5f73 746f 7261 6765 5f6f  ignore_storage_o
+00031870: 626a 2e6e 616d 652c 2066 696c 655f 6e61  bj.name, file_na
+00031880: 6d65 3d27 2e67 6974 2729 0a20 2020 2020  me='.git').     
+00031890: 2020 2063 6e74 5f6e 756d 5f66 696c 655f     cnt_num_file_
+000318a0: 636d 6420 3d20 7365 6c66 2e63 6c69 5f63  cmd = self.cli_c
+000318b0: 6f75 6e74 5f66 696c 655f 696e 5f62 7563  ount_file_in_buc
+000318c0: 6b65 7428 0a20 2020 2020 2020 2020 2020  ket(.           
+000318d0: 2073 746f 7265 5f74 7970 652c 2074 6d70   store_type, tmp
+000318e0: 5f67 6974 6967 6e6f 7265 5f73 746f 7261  _gitignore_stora
+000318f0: 6765 5f6f 626a 2e6e 616d 6529 0a0a 2020  ge_obj.name)..  
+00031900: 2020 2020 2020 7570 5f6f 7574 7075 7420        up_output 
+00031910: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
+00031920: 636b 5f6f 7574 7075 7428 7570 5f63 6d64  ck_output(up_cmd
+00031930: 2c20 7368 656c 6c3d 5472 7565 290a 2020  , shell=True).  
+00031940: 2020 2020 2020 6769 745f 6578 636c 7564        git_exclud
+00031950: 655f 6f75 7470 7574 203d 2073 7562 7072  e_output = subpr
+00031960: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+00031970: 7574 2867 6974 5f65 7863 6c75 6465 5f63  ut(git_exclude_c
+00031980: 6d64 2c0a 2020 2020 2020 2020 2020 2020  md,.            
+00031990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000319a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000319b0: 2020 2020 2020 2020 2073 6865 6c6c 3d54           shell=T
+000319c0: 7275 6529 0a20 2020 2020 2020 2063 6e74  rue).        cnt
+000319d0: 5f6f 7574 7075 7420 3d20 7375 6270 726f  _output = subpro
+000319e0: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
+000319f0: 7428 636e 745f 6e75 6d5f 6669 6c65 5f63  t(cnt_num_file_c
+00031a00: 6d64 2c20 7368 656c 6c3d 5472 7565 290a  md, shell=True).
+00031a10: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00031a20: 2733 2720 696e 2075 705f 6f75 7470 7574  '3' in up_output
+00031a30: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+00031a40: 2c20 5c0a 2020 2020 2020 2020 2020 2020  , \.            
+00031a50: 2020 2020 2746 696c 6573 2074 6f20 6265      'Files to be
+00031a60: 2069 6e63 6c75 6465 6420 6172 6520 6e6f   included are no
+00031a70: 7420 636f 6d70 6c65 7465 6c79 2075 706c  t completely upl
+00031a80: 6f61 6465 642e 270a 2020 2020 2020 2020  oaded.'.        
+00031a90: 2320 3120 6973 2072 6561 6420 6173 202e  # 1 is read as .
+00031aa0: 6769 7469 676e 6f72 6520 6973 2075 706c  gitignore is upl
+00031ab0: 6f61 6465 640a 2020 2020 2020 2020 6173  oaded.        as
+00031ac0: 7365 7274 2027 3127 2069 6e20 6769 745f  sert '1' in git_
+00031ad0: 6578 636c 7564 655f 6f75 7470 7574 2e64  exclude_output.d
+00031ae0: 6563 6f64 6528 2775 7466 2d38 2729 2c20  ecode('utf-8'), 
+00031af0: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
+00031b00: 2027 2e67 6974 2064 6972 6563 746f 7279   '.git directory
+00031b10: 2073 686f 756c 6420 6e6f 7420 6265 2075   should not be u
+00031b20: 706c 6f61 6465 642e 270a 2020 2020 2020  ploaded.'.      
+00031b30: 2020 2320 3420 6669 6c65 7320 696e 636c    # 4 files incl
+00031b40: 7564 6520 2e67 6974 6967 6e6f 7265 2c20  ude .gitignore, 
+00031b50: 696e 636c 7564 6564 2e6c 6f67 2c20 696e  included.log, in
+00031b60: 636c 7564 6564 2e74 7874 2c20 696e 636c  cluded.txt, incl
+00031b70: 7564 655f 6469 722f 696e 636c 7564 6564  ude_dir/included
+00031b80: 2e6c 6f67 0a20 2020 2020 2020 2061 7373  .log.        ass
+00031b90: 6572 7420 2734 2720 696e 2063 6e74 5f6f  ert '4' in cnt_o
+00031ba0: 7574 7075 742e 6465 636f 6465 2827 7574  utput.decode('ut
+00031bb0: 662d 3827 292c 205c 0a20 2020 2020 2020  f-8'), \.       
+00031bc0: 2020 2020 2020 2020 2753 6f6d 6520 6974          'Some it
+00031bd0: 656d 7320 6c69 7374 6564 2069 6e20 2e67  ems listed in .g
+00031be0: 6974 6967 6e6f 7265 2061 6e64 202e 6769  itignore and .gi
+00031bf0: 742f 696e 666f 2f65 7863 6c75 6465 2061  t/info/exclude a
+00031c00: 7265 206e 6f74 2065 7863 6c75 6465 642e  re not excluded.
+00031c10: 270a 0a20 2020 2040 7079 7465 7374 2e6d  '..    @pytest.m
+00031c20: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
+00031c30: 2765 7874 5f62 7563 6b65 745f 6669 7874  'ext_bucket_fixt
+00031c40: 7572 652c 2073 746f 7265 5f74 7970 6527  ure, store_type'
+00031c50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00031c60: 2020 2020 2020 2020 2020 2020 2020 205b                 [
+00031c70: 2827 746d 705f 6177 7363 6c69 5f62 7563  ('tmp_awscli_buc
+00031c80: 6b65 7427 2c20 7374 6f72 6167 655f 6c69  ket', storage_li
+00031c90: 622e 5374 6f72 6554 7970 652e 5333 292c  b.StoreType.S3),
+00031ca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00031cb0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00031cc0: 2774 6d70 5f67 7375 7469 6c5f 6275 636b  'tmp_gsutil_buck
+00031cd0: 6574 272c 2073 746f 7261 6765 5f6c 6962  et', storage_lib
+00031ce0: 2e53 746f 7265 5479 7065 2e47 4353 292c  .StoreType.GCS),
+00031cf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00031d00: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00031d10: 7974 6573 742e 7061 7261 6d28 2774 6d70  ytest.param('tmp
+00031d20: 5f61 7773 636c 695f 6275 636b 6574 5f72  _awscli_bucket_r
+00031d30: 3227 2c0a 2020 2020 2020 2020 2020 2020  2',.            
+00031d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031d50: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00031d60: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+00031d70: 5479 7065 2e52 322c 0a20 2020 2020 2020  Type.R2,.       
+00031d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031da0: 2020 2020 6d61 726b 733d 7079 7465 7374      marks=pytest
+00031db0: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
+00031dc0: 295d 290a 2020 2020 6465 6620 7465 7374  )]).    def test
+00031dd0: 5f65 7874 6572 6e61 6c6c 795f 6372 6561  _externally_crea
+00031de0: 7465 645f 6275 636b 6574 5f6d 6f75 6e74  ted_bucket_mount
+00031df0: 5f77 6974 686f 7574 5f73 6f75 7263 6528  _without_source(
+00031e00: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00031e10: 662c 2065 7874 5f62 7563 6b65 745f 6669  f, ext_bucket_fi
+00031e20: 7874 7572 652c 2072 6571 7565 7374 2c20  xture, request, 
+00031e30: 7374 6f72 655f 7479 7065 293a 0a20 2020  store_type):.   
+00031e40: 2020 2020 2023 204e 6f6e 2d73 6b79 206d       # Non-sky m
+00031e50: 616e 6167 6564 2062 7563 6b65 7473 2862  anaged buckets(b
+00031e60: 7563 6b65 7473 2063 7265 6174 6564 206f  uckets created o
+00031e70: 7574 7369 6465 206f 6620 536b 7970 696c  utside of Skypil
+00031e80: 6f74 2043 4c49 290a 2020 2020 2020 2020  ot CLI).        
+00031e90: 2320 6172 6520 616c 6c6f 7765 6420 746f  # are allowed to
+00031ea0: 2062 6520 4d4f 554e 5465 6420 6279 2073   be MOUNTed by s
+00031eb0: 7065 6369 6679 696e 6720 7468 6520 5552  pecifying the UR
+00031ec0: 4920 6f66 2074 6865 2062 7563 6b65 7420  I of the bucket 
+00031ed0: 746f 0a20 2020 2020 2020 2023 2073 6f75  to.        # sou
+00031ee0: 7263 6520 6669 656c 6420 6f6e 6c79 2e20  rce field only. 
+00031ef0: 5768 656e 2069 7420 6973 2061 7474 656d  When it is attem
+00031f00: 7074 6564 2062 7920 7370 6563 6966 7969  pted by specifyi
+00031f10: 6e67 2074 6865 206e 616d 6520 6f66 0a20  ng the name of. 
+00031f20: 2020 2020 2020 2023 2074 6865 2062 7563         # the buc
+00031f30: 6b65 7420 6f6e 6c79 2c20 6974 2073 686f  ket only, it sho
+00031f40: 756c 6420 6572 726f 7220 6f75 742e 0a20  uld error out.. 
+00031f50: 2020 2020 2020 2023 0a20 2020 2020 2020         #.       
+00031f60: 2023 2054 4f44 4f28 646f 796f 756e 6729   # TODO(doyoung)
+00031f70: 3a20 4164 6420 7465 7374 2066 6f72 2049  : Add test for I
+00031f80: 424d 2043 4f53 2e20 4375 7272 656e 746c  BM COS. Currentl
+00031f90: 792c 2074 6869 7320 6973 2062 6c6f 636b  y, this is block
+00031fa0: 6564 0a20 2020 2020 2020 2023 2061 7320  ed.        # as 
+00031fb0: 7263 6c6f 6e65 2075 7365 6420 746f 2069  rclone used to i
+00031fc0: 6e74 6572 6163 7420 7769 7468 2049 424d  nteract with IBM
+00031fd0: 2043 4f53 2064 6f65 7320 6e6f 7420 7375   COS does not su
+00031fe0: 7070 6f72 7420 6665 6174 7572 6520 746f  pport feature to
+00031ff0: 0a20 2020 2020 2020 2023 2063 7265 6174  .        # creat
+00032000: 6520 6120 6275 636b 6574 2c20 616e 6420  e a bucket, and 
+00032010: 7468 6520 6962 6d63 6c6f 7564 2043 4c49  the ibmcloud CLI
+00032020: 2069 7320 6e6f 7420 7375 7070 6f72 7465   is not supporte
+00032030: 6420 696e 2053 6b79 7069 6c6f 742e 0a20  d in Skypilot.. 
+00032040: 2020 2020 2020 2023 2045 6974 6865 7220         # Either 
+00032050: 6f66 2074 6865 2066 6561 7475 7265 2069  of the feature i
+00032060: 7320 6e65 6365 7373 6172 7920 746f 2073  s necessary to s
+00032070: 696d 756c 6174 6520 616e 2065 7874 6572  imulate an exter
+00032080: 6e61 6c20 6275 636b 6574 0a20 2020 2020  nal bucket.     
+00032090: 2020 2023 2063 7265 6174 696f 6e20 666f     # creation fo
+000320a0: 7220 4942 4d20 434f 532e 0a20 2020 2020  r IBM COS..     
+000320b0: 2020 2023 2068 7474 7073 3a2f 2f67 6974     # https://git
+000320c0: 6875 622e 636f 6d2f 736b 7970 696c 6f74  hub.com/skypilot
+000320d0: 2d6f 7267 2f73 6b79 7069 6c6f 742f 7075  -org/skypilot/pu
+000320e0: 6c6c 2f31 3936 362f 6669 6c65 7323 7231  ll/1966/files#r1
+000320f0: 3235 3334 3339 3833 370a 0a20 2020 2020  253439837..     
+00032100: 2020 2065 7874 5f62 7563 6b65 745f 6e61     ext_bucket_na
+00032110: 6d65 2c20 6578 745f 6275 636b 6574 5f75  me, ext_bucket_u
+00032120: 7269 203d 2072 6571 7565 7374 2e67 6574  ri = request.get
+00032130: 6669 7874 7572 6576 616c 7565 280a 2020  fixturevalue(.  
+00032140: 2020 2020 2020 2020 2020 6578 745f 6275            ext_bu
+00032150: 636b 6574 5f66 6978 7475 7265 290a 2020  cket_fixture).  
+00032160: 2020 2020 2020 2320 696e 7661 6c69 6420        # invalid 
+00032170: 7370 6563 0a20 2020 2020 2020 2077 6974  spec.        wit
+00032180: 6820 7079 7465 7374 2e72 6169 7365 7328  h pytest.raises(
+00032190: 736b 792e 6578 6365 7074 696f 6e73 2e53  sky.exceptions.S
+000321a0: 746f 7261 6765 5370 6563 4572 726f 7229  torageSpecError)
+000321b0: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+000321c0: 2020 2073 746f 7261 6765 5f6f 626a 203d     storage_obj =
+000321d0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+000321e0: 7261 6765 280a 2020 2020 2020 2020 2020  rage(.          
+000321f0: 2020 2020 2020 6e61 6d65 3d65 7874 5f62        name=ext_b
+00032200: 7563 6b65 745f 6e61 6d65 2c20 6d6f 6465  ucket_name, mode
+00032210: 3d73 746f 7261 6765 5f6c 6962 2e53 746f  =storage_lib.Sto
+00032220: 7261 6765 4d6f 6465 2e4d 4f55 4e54 290a  rageMode.MOUNT).
+00032230: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+00032240: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
+00032250: 6528 7374 6f72 655f 7479 7065 290a 0a20  e(store_type).. 
+00032260: 2020 2020 2020 2061 7373 6572 7420 2741         assert 'A
+00032270: 7474 656d 7074 6564 2074 6f20 6d6f 756e  ttempted to moun
+00032280: 7420 6120 6e6f 6e2d 736b 7920 6d61 6e61  t a non-sky mana
+00032290: 6765 6420 6275 636b 6574 2720 696e 2073  ged bucket' in s
+000322a0: 7472 2865 290a 0a20 2020 2020 2020 2023  tr(e)..        #
+000322b0: 2076 616c 6964 2073 7065 630a 2020 2020   valid spec.    
+000322c0: 2020 2020 7374 6f72 6167 655f 6f62 6a20      storage_obj 
+000322d0: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
+000322e0: 6f72 6167 6528 736f 7572 6365 3d65 7874  orage(source=ext
+000322f0: 5f62 7563 6b65 745f 7572 692c 0a20 2020  _bucket_uri,.   
+00032300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032320: 2020 2020 2020 206d 6f64 653d 7374 6f72         mode=stor
+00032330: 6167 655f 6c69 622e 5374 6f72 6167 654d  age_lib.StorageM
+00032340: 6f64 652e 4d4f 554e 5429 0a20 2020 2020  ode.MOUNT).     
+00032350: 2020 2068 616e 646c 6520 3d20 676c 6f62     handle = glob
+00032360: 616c 5f75 7365 725f 7374 6174 652e 6765  al_user_state.ge
+00032370: 745f 6861 6e64 6c65 5f66 726f 6d5f 7374  t_handle_from_st
+00032380: 6f72 6167 655f 6e61 6d65 280a 2020 2020  orage_name(.    
+00032390: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
+000323a0: 6f62 6a2e 6e61 6d65 290a 2020 2020 2020  obj.name).      
+000323b0: 2020 6966 2068 616e 646c 653a 0a20 2020    if handle:.   
+000323c0: 2020 2020 2020 2020 2073 746f 7261 6765           storage
+000323d0: 5f6f 626a 2e64 656c 6574 6528 290a 0a20  _obj.delete().. 
+000323e0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
+000323f0: 6e6f 5f66 6c75 6964 7374 6163 6b0a 2020  no_fluidstack.  
+00032400: 2020 4070 7974 6573 742e 6d61 726b 2e70    @pytest.mark.p
+00032410: 6172 616d 6574 7269 7a65 2827 7265 6769  arametrize('regi
+00032420: 6f6e 272c 205b 0a20 2020 2020 2020 2027  on', [.        '
+00032430: 6170 2d6e 6f72 7468 6561 7374 2d31 272c  ap-northeast-1',
+00032440: 2027 6170 2d6e 6f72 7468 6561 7374 2d32   'ap-northeast-2
+00032450: 272c 2027 6170 2d6e 6f72 7468 6561 7374  ', 'ap-northeast
+00032460: 2d33 272c 2027 6170 2d73 6f75 7468 2d31  -3', 'ap-south-1
+00032470: 272c 0a20 2020 2020 2020 2027 6170 2d73  ',.        'ap-s
+00032480: 6f75 7468 6561 7374 2d31 272c 2027 6170  outheast-1', 'ap
+00032490: 2d73 6f75 7468 6561 7374 2d32 272c 2027  -southeast-2', '
+000324a0: 6575 2d63 656e 7472 616c 2d31 272c 2027  eu-central-1', '
+000324b0: 6575 2d6e 6f72 7468 2d31 272c 0a20 2020  eu-north-1',.   
+000324c0: 2020 2020 2027 6575 2d77 6573 742d 3127       'eu-west-1'
+000324d0: 2c20 2765 752d 7765 7374 2d32 272c 2027  , 'eu-west-2', '
+000324e0: 6575 2d77 6573 742d 3327 2c20 2773 612d  eu-west-3', 'sa-
+000324f0: 6561 7374 2d31 272c 2027 7573 2d65 6173  east-1', 'us-eas
+00032500: 742d 3127 2c0a 2020 2020 2020 2020 2775  t-1',.        'u
+00032510: 732d 6561 7374 2d32 272c 2027 7573 2d77  s-east-2', 'us-w
+00032520: 6573 742d 3127 2c20 2775 732d 7765 7374  est-1', 'us-west
+00032530: 2d32 270a 2020 2020 5d29 0a20 2020 2064  -2'.    ]).    d
+00032540: 6566 2074 6573 745f 6177 735f 7265 6769  ef test_aws_regi
+00032550: 6f6e 7328 7365 6c66 2c20 746d 705f 6c6f  ons(self, tmp_lo
+00032560: 6361 6c5f 7374 6f72 6167 655f 6f62 6a2c  cal_storage_obj,
+00032570: 2072 6567 696f 6e29 3a0a 2020 2020 2020   region):.      
+00032580: 2020 2320 5468 6973 2074 6573 7473 2063    # This tests c
+00032590: 7265 6174 696f 6e20 616e 6420 7570 6c6f  reation and uplo
+000325a0: 6164 2074 6f20 6275 636b 6574 2069 6e20  ad to bucket in 
+000325b0: 616c 6c20 4157 5320 7333 2072 6567 696f  all AWS s3 regio
+000325c0: 6e73 0a20 2020 2020 2020 2023 2054 6f20  ns.        # To 
+000325d0: 7465 7374 2066 756c 6c20 6675 6e63 7469  test full functi
+000325e0: 6f6e 616c 6974 792c 2075 7365 2074 6573  onality, use tes
+000325f0: 745f 7370 6f74 5f73 746f 7261 6765 2061  t_spot_storage a
+00032600: 626f 7665 2e0a 2020 2020 2020 2020 7374  bove..        st
+00032610: 6f72 655f 7479 7065 203d 2073 746f 7261  ore_type = stora
+00032620: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+00032630: 2e53 330a 2020 2020 2020 2020 746d 705f  .S3.        tmp_
+00032640: 6c6f 6361 6c5f 7374 6f72 6167 655f 6f62  local_storage_ob
+00032650: 6a2e 6164 645f 7374 6f72 6528 7374 6f72  j.add_store(stor
+00032660: 655f 7479 7065 2c20 7265 6769 6f6e 3d72  e_type, region=r
+00032670: 6567 696f 6e29 0a20 2020 2020 2020 2062  egion).        b
+00032680: 7563 6b65 745f 6e61 6d65 203d 2074 6d70  ucket_name = tmp
+00032690: 5f6c 6f63 616c 5f73 746f 7261 6765 5f6f  _local_storage_o
+000326a0: 626a 2e6e 616d 650a 0a20 2020 2020 2020  bj.name..       
+000326b0: 2023 2043 6f6e 6669 726d 2074 6861 7420   # Confirm that 
+000326c0: 7468 6520 6275 636b 6574 2077 6173 2063  the bucket was c
+000326d0: 7265 6174 6564 2069 6e20 7468 6520 636f  reated in the co
+000326e0: 7272 6563 7420 7265 6769 6f6e 0a20 2020  rrect region.   
+000326f0: 2020 2020 2072 6567 696f 6e5f 636d 6420       region_cmd 
+00032700: 3d20 7365 6c66 2e63 6c69 5f72 6567 696f  = self.cli_regio
+00032710: 6e5f 636d 6428 7374 6f72 655f 7479 7065  n_cmd(store_type
+00032720: 2c20 6275 636b 6574 5f6e 616d 6529 0a20  , bucket_name). 
+00032730: 2020 2020 2020 206f 7574 203d 2073 7562         out = sub
+00032740: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
+00032750: 7470 7574 2872 6567 696f 6e5f 636d 642c  tput(region_cmd,
+00032760: 2073 6865 6c6c 3d54 7275 6529 0a20 2020   shell=True).   
+00032770: 2020 2020 206f 7574 7075 7420 3d20 6f75       output = ou
+00032780: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
+00032790: 290a 2020 2020 2020 2020 6578 7065 6374  ).        expect
+000327a0: 6564 5f6f 7574 7075 745f 7265 6769 6f6e  ed_output_region
+000327b0: 203d 2072 6567 696f 6e0a 2020 2020 2020   = region.      
+000327c0: 2020 6966 2072 6567 696f 6e20 3d3d 2027    if region == '
+000327d0: 7573 2d65 6173 742d 3127 3a0a 2020 2020  us-east-1':.    
+000327e0: 2020 2020 2020 2020 6578 7065 6374 6564          expected
+000327f0: 5f6f 7574 7075 745f 7265 6769 6f6e 203d  _output_region =
+00032800: 2027 4e6f 6e65 2720 2023 2075 732d 6561   'None'  # us-ea
+00032810: 7374 2d31 2069 7320 7468 6520 6465 6661  st-1 is the defa
+00032820: 756c 7420 7265 6769 6f6e 0a20 2020 2020  ult region.     
+00032830: 2020 2061 7373 6572 7420 6578 7065 6374     assert expect
+00032840: 6564 5f6f 7574 7075 745f 7265 6769 6f6e  ed_output_region
+00032850: 2069 6e20 6f75 742e 6465 636f 6465 2827   in out.decode('
+00032860: 7574 662d 3827 292c 2028 0a20 2020 2020  utf-8'), (.     
+00032870: 2020 2020 2020 2066 2742 7563 6b65 7420         f'Bucket 
+00032880: 7761 7320 6e6f 7420 666f 756e 6420 696e  was not found in
+00032890: 2072 6567 696f 6e20 7b72 6567 696f 6e7d   region {region}
+000328a0: 202d 2027 0a20 2020 2020 2020 2020 2020   - '.           
+000328b0: 2066 276f 7574 7075 7420 6f66 207b 7265   f'output of {re
+000328c0: 6769 6f6e 5f63 6d64 7d20 7761 733a 207b  gion_cmd} was: {
+000328d0: 6f75 7470 7574 7d27 290a 0a20 2020 2020  output}')..     
+000328e0: 2020 2023 2043 6865 636b 2069 6620 746d     # Check if tm
+000328f0: 705f 736f 7572 6365 2f74 6d70 2d66 696c  p_source/tmp-fil
+00032900: 6520 6578 6973 7473 2069 6e20 7468 6520  e exists in the 
+00032910: 6275 636b 6574 2075 7369 6e67 2063 6c69  bucket using cli
+00032920: 0a20 2020 2020 2020 206c 735f 636d 6420  .        ls_cmd 
+00032930: 3d20 7365 6c66 2e63 6c69 5f6c 735f 636d  = self.cli_ls_cm
+00032940: 6428 7374 6f72 655f 7479 7065 2c20 6275  d(store_type, bu
+00032950: 636b 6574 5f6e 616d 6529 0a20 2020 2020  cket_name).     
+00032960: 2020 206f 7574 203d 2073 7562 7072 6f63     out = subproc
+00032970: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
+00032980: 286c 735f 636d 642c 2073 6865 6c6c 3d54  (ls_cmd, shell=T
+00032990: 7275 6529 0a20 2020 2020 2020 206f 7574  rue).        out
+000329a0: 7075 7420 3d20 6f75 742e 6465 636f 6465  put = out.decode
+000329b0: 2827 7574 662d 3827 290a 2020 2020 2020  ('utf-8').      
+000329c0: 2020 6173 7365 7274 2027 746d 702d 6669    assert 'tmp-fi
+000329d0: 6c65 2720 696e 206f 7574 7075 742c 2028  le' in output, (
+000329e0: 0a20 2020 2020 2020 2020 2020 2066 2774  .            f't
+000329f0: 6d70 2d66 696c 6520 6e6f 7420 666f 756e  mp-file not foun
+00032a00: 6420 696e 2062 7563 6b65 7420 2d20 6f75  d in bucket - ou
+00032a10: 7470 7574 206f 6620 7b6c 735f 636d 647d  tput of {ls_cmd}
+00032a20: 2077 6173 3a20 7b6f 7574 7075 747d 2729   was: {output}')
+00032a30: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
+00032a40: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
+00032a50: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+00032a60: 6b2e 7061 7261 6d65 7472 697a 6528 2772  k.parametrize('r
+00032a70: 6567 696f 6e27 2c20 5b0a 2020 2020 2020  egion', [.      
+00032a80: 2020 276e 6f72 7468 616d 6572 6963 612d    'northamerica-
+00032a90: 6e6f 7274 6865 6173 7431 272c 2027 6e6f  northeast1', 'no
+00032aa0: 7274 6861 6d65 7269 6361 2d6e 6f72 7468  rthamerica-north
+00032ab0: 6561 7374 3227 2c20 2775 732d 6365 6e74  east2', 'us-cent
+00032ac0: 7261 6c31 272c 0a20 2020 2020 2020 2027  ral1',.        '
+00032ad0: 7573 2d65 6173 7431 272c 2027 7573 2d65  us-east1', 'us-e
+00032ae0: 6173 7434 272c 2027 7573 2d65 6173 7435  ast4', 'us-east5
+00032af0: 272c 2027 7573 2d73 6f75 7468 3127 2c20  ', 'us-south1', 
+00032b00: 2775 732d 7765 7374 3127 2c20 2775 732d  'us-west1', 'us-
+00032b10: 7765 7374 3227 2c0a 2020 2020 2020 2020  west2',.        
+00032b20: 2775 732d 7765 7374 3327 2c20 2775 732d  'us-west3', 'us-
+00032b30: 7765 7374 3427 2c20 2773 6f75 7468 616d  west4', 'southam
+00032b40: 6572 6963 612d 6561 7374 3127 2c20 2773  erica-east1', 's
+00032b50: 6f75 7468 616d 6572 6963 612d 7765 7374  outhamerica-west
+00032b60: 3127 2c0a 2020 2020 2020 2020 2765 7572  1',.        'eur
+00032b70: 6f70 652d 6365 6e74 7261 6c32 272c 2027  ope-central2', '
+00032b80: 6575 726f 7065 2d6e 6f72 7468 3127 2c20  europe-north1', 
+00032b90: 2765 7572 6f70 652d 736f 7574 6877 6573  'europe-southwes
+00032ba0: 7431 272c 2027 6575 726f 7065 2d77 6573  t1', 'europe-wes
+00032bb0: 7431 272c 0a20 2020 2020 2020 2027 6575  t1',.        'eu
+00032bc0: 726f 7065 2d77 6573 7432 272c 2027 6575  rope-west2', 'eu
+00032bd0: 726f 7065 2d77 6573 7433 272c 2027 6575  rope-west3', 'eu
+00032be0: 726f 7065 2d77 6573 7434 272c 2027 6575  rope-west4', 'eu
+00032bf0: 726f 7065 2d77 6573 7436 272c 0a20 2020  rope-west6',.   
+00032c00: 2020 2020 2027 6575 726f 7065 2d77 6573       'europe-wes
+00032c10: 7438 272c 2027 6575 726f 7065 2d77 6573  t8', 'europe-wes
+00032c20: 7439 272c 2027 6575 726f 7065 2d77 6573  t9', 'europe-wes
+00032c30: 7431 3027 2c20 2765 7572 6f70 652d 7765  t10', 'europe-we
+00032c40: 7374 3132 272c 0a20 2020 2020 2020 2027  st12',.        '
+00032c50: 6173 6961 2d65 6173 7431 272c 2027 6173  asia-east1', 'as
+00032c60: 6961 2d65 6173 7432 272c 2027 6173 6961  ia-east2', 'asia
+00032c70: 2d6e 6f72 7468 6561 7374 3127 2c20 2761  -northeast1', 'a
+00032c80: 7369 612d 6e6f 7274 6865 6173 7432 272c  sia-northeast2',
+00032c90: 0a20 2020 2020 2020 2027 6173 6961 2d6e  .        'asia-n
+00032ca0: 6f72 7468 6561 7374 3327 2c20 2761 7369  ortheast3', 'asi
+00032cb0: 612d 736f 7574 6865 6173 7431 272c 2027  a-southeast1', '
+00032cc0: 6173 6961 2d73 6f75 7468 3127 2c20 2761  asia-south1', 'a
+00032cd0: 7369 612d 736f 7574 6832 272c 0a20 2020  sia-south2',.   
+00032ce0: 2020 2020 2027 6173 6961 2d73 6f75 7468       'asia-south
+00032cf0: 6561 7374 3227 2c20 276d 652d 6365 6e74  east2', 'me-cent
+00032d00: 7261 6c31 272c 2027 6d65 2d63 656e 7472  ral1', 'me-centr
+00032d10: 616c 3227 2c20 276d 652d 7765 7374 3127  al2', 'me-west1'
+00032d20: 2c0a 2020 2020 2020 2020 2761 7573 7472  ,.        'austr
+00032d30: 616c 6961 2d73 6f75 7468 6561 7374 3127  alia-southeast1'
+00032d40: 2c20 2761 7573 7472 616c 6961 2d73 6f75  , 'australia-sou
+00032d50: 7468 6561 7374 3227 2c20 2761 6672 6963  theast2', 'afric
+00032d60: 612d 736f 7574 6831 270a 2020 2020 5d29  a-south1'.    ])
+00032d70: 0a20 2020 2064 6566 2074 6573 745f 6763  .    def test_gc
+00032d80: 735f 7265 6769 6f6e 7328 7365 6c66 2c20  s_regions(self, 
+00032d90: 746d 705f 6c6f 6361 6c5f 7374 6f72 6167  tmp_local_storag
+00032da0: 655f 6f62 6a2c 2072 6567 696f 6e29 3a0a  e_obj, region):.
+00032db0: 2020 2020 2020 2020 2320 5468 6973 2074          # This t
+00032dc0: 6573 7473 2063 7265 6174 696f 6e20 616e  ests creation an
+00032dd0: 6420 7570 6c6f 6164 2074 6f20 6275 636b  d upload to buck
+00032de0: 6574 2069 6e20 616c 6c20 4743 5320 7265  et in all GCS re
+00032df0: 6769 6f6e 730a 2020 2020 2020 2020 2320  gions.        # 
+00032e00: 546f 2074 6573 7420 6675 6c6c 2066 756e  To test full fun
+00032e10: 6374 696f 6e61 6c69 7479 2c20 7573 6520  ctionality, use 
+00032e20: 7465 7374 5f73 706f 745f 7374 6f72 6167  test_spot_storag
+00032e30: 6520 6162 6f76 652e 0a20 2020 2020 2020  e above..       
+00032e40: 2073 746f 7265 5f74 7970 6520 3d20 7374   store_type = st
+00032e50: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+00032e60: 7970 652e 4743 530a 2020 2020 2020 2020  ype.GCS.        
+00032e70: 746d 705f 6c6f 6361 6c5f 7374 6f72 6167  tmp_local_storag
+00032e80: 655f 6f62 6a2e 6164 645f 7374 6f72 6528  e_obj.add_store(
+00032e90: 7374 6f72 655f 7479 7065 2c20 7265 6769  store_type, regi
+00032ea0: 6f6e 3d72 6567 696f 6e29 0a20 2020 2020  on=region).     
+00032eb0: 2020 2062 7563 6b65 745f 6e61 6d65 203d     bucket_name =
+00032ec0: 2074 6d70 5f6c 6f63 616c 5f73 746f 7261   tmp_local_stora
+00032ed0: 6765 5f6f 626a 2e6e 616d 650a 0a20 2020  ge_obj.name..   
+00032ee0: 2020 2020 2023 2043 6f6e 6669 726d 2074       # Confirm t
+00032ef0: 6861 7420 7468 6520 6275 636b 6574 2077  hat the bucket w
+00032f00: 6173 2063 7265 6174 6564 2069 6e20 7468  as created in th
+00032f10: 6520 636f 7272 6563 7420 7265 6769 6f6e  e correct region
+00032f20: 0a20 2020 2020 2020 2072 6567 696f 6e5f  .        region_
+00032f30: 636d 6420 3d20 7365 6c66 2e63 6c69 5f72  cmd = self.cli_r
+00032f40: 6567 696f 6e5f 636d 6428 7374 6f72 655f  egion_cmd(store_
+00032f50: 7479 7065 2c20 6275 636b 6574 5f6e 616d  type, bucket_nam
+00032f60: 6529 0a20 2020 2020 2020 206f 7574 203d  e).        out =
+00032f70: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+00032f80: 6b5f 6f75 7470 7574 2872 6567 696f 6e5f  k_output(region_
+00032f90: 636d 642c 2073 6865 6c6c 3d54 7275 6529  cmd, shell=True)
+00032fa0: 0a20 2020 2020 2020 206f 7574 7075 7420  .        output 
+00032fb0: 3d20 6f75 742e 6465 636f 6465 2827 7574  = out.decode('ut
+00032fc0: 662d 3827 290a 2020 2020 2020 2020 6173  f-8').        as
+00032fd0: 7365 7274 2072 6567 696f 6e20 696e 206f  sert region in o
+00032fe0: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
+00032ff0: 2729 2c20 280a 2020 2020 2020 2020 2020  '), (.          
+00033000: 2020 6627 4275 636b 6574 2077 6173 206e    f'Bucket was n
+00033010: 6f74 2066 6f75 6e64 2069 6e20 7265 6769  ot found in regi
+00033020: 6f6e 207b 7265 6769 6f6e 7d20 2d20 270a  on {region} - '.
+00033030: 2020 2020 2020 2020 2020 2020 6627 6f75              f'ou
+00033040: 7470 7574 206f 6620 7b72 6567 696f 6e5f  tput of {region_
+00033050: 636d 647d 2077 6173 3a20 7b6f 7574 7075  cmd} was: {outpu
+00033060: 747d 2729 0a0a 2020 2020 2020 2020 2320  t}')..        # 
+00033070: 4368 6563 6b20 6966 2074 6d70 5f73 6f75  Check if tmp_sou
+00033080: 7263 652f 746d 702d 6669 6c65 2065 7869  rce/tmp-file exi
+00033090: 7374 7320 696e 2074 6865 2062 7563 6b65  sts in the bucke
+000330a0: 7420 7573 696e 6720 636c 690a 2020 2020  t using cli.    
+000330b0: 2020 2020 6c73 5f63 6d64 203d 2073 656c      ls_cmd = sel
+000330c0: 662e 636c 695f 6c73 5f63 6d64 2873 746f  f.cli_ls_cmd(sto
+000330d0: 7265 5f74 7970 652c 2062 7563 6b65 745f  re_type, bucket_
+000330e0: 6e61 6d65 290a 2020 2020 2020 2020 6f75  name).        ou
+000330f0: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
+00033100: 6865 636b 5f6f 7574 7075 7428 6c73 5f63  heck_output(ls_c
+00033110: 6d64 2c20 7368 656c 6c3d 5472 7565 290a  md, shell=True).
+00033120: 2020 2020 2020 2020 6f75 7470 7574 203d          output =
+00033130: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
+00033140: 2d38 2729 0a20 2020 2020 2020 2061 7373  -8').        ass
+00033150: 6572 7420 2774 6d70 2d66 696c 6527 2069  ert 'tmp-file' i
+00033160: 6e20 6f75 7470 7574 2c20 280a 2020 2020  n output, (.    
+00033170: 2020 2020 2020 2020 6627 746d 702d 6669          f'tmp-fi
+00033180: 6c65 206e 6f74 2066 6f75 6e64 2069 6e20  le not found in 
+00033190: 6275 636b 6574 202d 206f 7574 7075 7420  bucket - output 
+000331a0: 6f66 207b 6c73 5f63 6d64 7d20 7761 733a  of {ls_cmd} was:
+000331b0: 207b 6f75 7470 7574 7d27 290a 0a0a 2320   {output}')...# 
+000331c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7469  ---------- Testi
+000331d0: 6e67 2059 414d 4c20 5370 6563 7320 2d2d  ng YAML Specs --
+000331e0: 2d2d 2d2d 2d2d 2d2d 0a23 204f 7572 2073  --------.# Our s
+000331f0: 6b79 2073 746f 7261 6765 2072 6571 7569  ky storage requi
+00033200: 7265 7320 6372 6564 656e 7469 616c 7320  res credentials 
+00033210: 746f 2063 6865 636b 2074 6865 2062 7563  to check the buc
+00033220: 6b65 7420 6578 6973 7461 6e63 6520 7768  ket existance wh
+00033230: 656e 0a23 206c 6f61 6469 6e67 2061 2074  en.# loading a t
+00033240: 6173 6b20 6672 6f6d 2074 6865 2079 616d  ask from the yam
+00033250: 6c20 6669 6c65 2c20 736f 2077 6520 6361  l file, so we ca
+00033260: 6e6e 6f74 206d 616b 6520 6974 2061 2075  nnot make it a u
+00033270: 6e69 7420 7465 7374 2e0a 636c 6173 7320  nit test..class 
+00033280: 5465 7374 5961 6d6c 5370 6563 733a 0a20  TestYamlSpecs:. 
+00033290: 2020 2023 2054 4f44 4f28 7a68 7775 293a     # TODO(zhwu):
+000332a0: 2041 6464 2074 6573 7420 666f 7220 6074   Add test for `t
+000332b0: 6f5f 7961 6d6c 5f63 6f6e 6669 6760 2066  o_yaml_config` f
+000332c0: 6f72 2074 6865 2053 746f 7261 6765 206f  or the Storage o
+000332d0: 626a 6563 742e 0a20 2020 2023 2020 5765  bject..    #  We
+000332e0: 2073 686f 756c 6420 6e6f 7420 7573 6520   should not use 
+000332f0: 6065 7861 6d70 6c65 732f 7374 6f72 6167  `examples/storag
+00033300: 655f 6465 6d6f 2e79 616d 6c60 2068 6572  e_demo.yaml` her
+00033310: 652c 2073 696e 6365 2069 7420 7265 7175  e, since it requ
+00033320: 6972 6573 0a20 2020 2023 2020 7573 6572  ires.    #  user
+00033330: 7320 746f 2065 6e73 7572 6520 6275 636b  s to ensure buck
+00033340: 6574 206e 616d 6573 2074 6f20 6e6f 7420  et names to not 
+00033350: 6578 6973 7420 616e 642f 6f72 2062 6520  exist and/or be 
+00033360: 756e 6971 7565 2e0a 2020 2020 5f54 4553  unique..    _TES
+00033370: 545f 5941 4d4c 5f50 4154 4853 203d 205b  T_YAML_PATHS = [
+00033380: 0a20 2020 2020 2020 2027 6578 616d 706c  .        'exampl
+00033390: 6573 2f6d 696e 696d 616c 2e79 616d 6c27  es/minimal.yaml'
+000333a0: 2c20 2765 7861 6d70 6c65 732f 6d61 6e61  , 'examples/mana
+000333b0: 6765 645f 7370 6f74 2e79 616d 6c27 2c0a  ged_spot.yaml',.
+000333c0: 2020 2020 2020 2020 2765 7861 6d70 6c65          'example
+000333d0: 732f 7573 696e 675f 6669 6c65 5f6d 6f75  s/using_file_mou
+000333e0: 6e74 732e 7961 6d6c 272c 2027 6578 616d  nts.yaml', 'exam
+000333f0: 706c 6573 2f72 6573 6e65 745f 6170 702e  ples/resnet_app.
+00033400: 7961 6d6c 272c 0a20 2020 2020 2020 2027  yaml',.        '
+00033410: 6578 616d 706c 6573 2f6d 756c 7469 5f68  examples/multi_h
+00033420: 6f73 746e 616d 652e 7961 6d6c 270a 2020  ostname.yaml'.  
+00033430: 2020 5d0a 0a20 2020 2064 6566 205f 6973    ]..    def _is
+00033440: 5f64 6963 745f 7375 6273 6574 2873 656c  _dict_subset(sel
+00033450: 662c 2064 312c 2064 3229 3a0a 2020 2020  f, d1, d2):.    
+00033460: 2020 2020 2222 2243 6865 636b 2069 6620      """Check if 
+00033470: 6431 2069 7320 7468 6520 7375 6273 6574  d1 is the subset
+00033480: 206f 6620 6432 2e22 2222 0a20 2020 2020   of d2.""".     
+00033490: 2020 2066 6f72 206b 2c20 7620 696e 2064     for k, v in d
+000334a0: 312e 6974 656d 7328 293a 0a20 2020 2020  1.items():.     
+000334b0: 2020 2020 2020 2069 6620 6b20 6e6f 7420         if k not 
+000334c0: 696e 2064 323a 0a20 2020 2020 2020 2020  in d2:.         
+000334d0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+000334e0: 616e 6365 2876 2c20 6c69 7374 2920 6f72  ance(v, list) or
+000334f0: 2069 7369 6e73 7461 6e63 6528 762c 2064   isinstance(v, d
+00033500: 6963 7429 3a0a 2020 2020 2020 2020 2020  ict):.          
+00033510: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00033520: 206c 656e 2876 2920 3d3d 2030 2c20 286b   len(v) == 0, (k
+00033530: 2c20 7629 0a20 2020 2020 2020 2020 2020  , v).           
+00033540: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00033550: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00033560: 7373 6572 7420 4661 6c73 652c 2028 6b2c  ssert False, (k,
+00033570: 2076 290a 2020 2020 2020 2020 2020 2020   v).            
+00033580: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+00033590: 762c 2064 6963 7429 3a0a 2020 2020 2020  v, dict):.      
+000335a0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000335b0: 2069 7369 6e73 7461 6e63 6528 6432 5b6b   isinstance(d2[k
+000335c0: 5d2c 2064 6963 7429 2c20 286b 2c20 762c  ], dict), (k, v,
+000335d0: 2064 3229 0a20 2020 2020 2020 2020 2020   d2).           
+000335e0: 2020 2020 2073 656c 662e 5f69 735f 6469       self._is_di
+000335f0: 6374 5f73 7562 7365 7428 762c 2064 325b  ct_subset(v, d2[
+00033600: 6b5d 290a 2020 2020 2020 2020 2020 2020  k]).            
+00033610: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+00033620: 762c 2073 7472 293a 0a20 2020 2020 2020  v, str):.       
+00033630: 2020 2020 2020 2020 2069 6620 6b20 3d3d           if k ==
+00033640: 2027 6163 6365 6c65 7261 746f 7273 273a   'accelerators':
+00033650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00033660: 2020 2020 2072 6573 6f75 7263 6573 203d       resources =
+00033670: 2073 6b79 2e52 6573 6f75 7263 6573 2829   sky.Resources()
+00033680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00033690: 2020 2020 2072 6573 6f75 7263 6573 2e5f       resources._
+000336a0: 7365 745f 6163 6365 6c65 7261 746f 7273  set_accelerators
+000336b0: 2876 2c20 4e6f 6e65 290a 2020 2020 2020  (v, None).      
+000336c0: 2020 2020 2020 2020 2020 2020 2020 6173                as
+000336d0: 7365 7274 2072 6573 6f75 7263 6573 2e61  sert resources.a
+000336e0: 6363 656c 6572 6174 6f72 7320 3d3d 2064  ccelerators == d
+000336f0: 325b 6b5d 2c20 286b 2c20 762c 2064 3229  2[k], (k, v, d2)
+00033700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00033710: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00033720: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00033730: 7420 762e 6c6f 7765 7228 2920 3d3d 2064  t v.lower() == d
+00033740: 325b 6b5d 2e6c 6f77 6572 2829 2c20 286b  2[k].lower(), (k
+00033750: 2c20 762c 2064 325b 6b5d 290a 2020 2020  , v, d2[k]).    
+00033760: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00033770: 2020 2020 2020 2020 2020 2020 2020 6173                as
+00033780: 7365 7274 2076 203d 3d20 6432 5b6b 5d2c  sert v == d2[k],
+00033790: 2028 6b2c 2076 2c20 6432 5b6b 5d29 0a0a   (k, v, d2[k])..
+000337a0: 2020 2020 6465 6620 5f63 6865 636b 5f65      def _check_e
+000337b0: 7175 6976 616c 656e 7428 7365 6c66 2c20  quivalent(self, 
+000337c0: 7961 6d6c 5f70 6174 6829 3a0a 2020 2020  yaml_path):.    
+000337d0: 2020 2020 2222 2243 6865 636b 2069 6620      """Check if 
+000337e0: 7468 6520 7961 6d6c 2069 7320 6571 7569  the yaml is equi
+000337f0: 7661 6c65 6e74 2061 6674 6572 206c 6f61  valent after loa
+00033800: 6420 616e 6420 6475 6d70 2061 6761 696e  d and dump again
+00033810: 2e22 2222 0a20 2020 2020 2020 206f 7269  .""".        ori
+00033820: 6769 6e5f 7461 736b 5f63 6f6e 6669 6720  gin_task_config 
+00033830: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e72  = common_utils.r
+00033840: 6561 645f 7961 6d6c 2879 616d 6c5f 7061  ead_yaml(yaml_pa
+00033850: 7468 290a 0a20 2020 2020 2020 2074 6173  th)..        tas
+00033860: 6b20 3d20 736b 792e 5461 736b 2e66 726f  k = sky.Task.fro
+00033870: 6d5f 7961 6d6c 2879 616d 6c5f 7061 7468  m_yaml(yaml_path
+00033880: 290a 2020 2020 2020 2020 6e65 775f 7461  ).        new_ta
+00033890: 736b 5f63 6f6e 6669 6720 3d20 7461 736b  sk_config = task
+000338a0: 2e74 6f5f 7961 6d6c 5f63 6f6e 6669 6728  .to_yaml_config(
+000338b0: 290a 2020 2020 2020 2020 2320 6431 203c  ).        # d1 <
+000338c0: 3d20 6432 0a20 2020 2020 2020 2070 7269  = d2.        pri
+000338d0: 6e74 286f 7269 6769 6e5f 7461 736b 5f63  nt(origin_task_c
+000338e0: 6f6e 6669 672c 206e 6577 5f74 6173 6b5f  onfig, new_task_
+000338f0: 636f 6e66 6967 290a 2020 2020 2020 2020  config).        
+00033900: 7365 6c66 2e5f 6973 5f64 6963 745f 7375  self._is_dict_su
+00033910: 6273 6574 286f 7269 6769 6e5f 7461 736b  bset(origin_task
+00033920: 5f63 6f6e 6669 672c 206e 6577 5f74 6173  _config, new_tas
+00033930: 6b5f 636f 6e66 6967 290a 0a20 2020 2064  k_config)..    d
+00033940: 6566 2074 6573 745f 6c6f 6164 5f64 756d  ef test_load_dum
+00033950: 705f 7961 6d6c 5f63 6f6e 6669 675f 6571  p_yaml_config_eq
+00033960: 7569 7661 6c65 6e74 2873 656c 6629 3a0a  uivalent(self):.
+00033970: 2020 2020 2020 2020 2222 2254 6573 7420          """Test 
+00033980: 6966 2074 6865 2079 616d 6c20 636f 6e66  if the yaml conf
+00033990: 6967 2069 7320 6571 7569 7661 6c65 6e74  ig is equivalent
+000339a0: 2061 6674 6572 206c 6f61 6420 616e 6420   after load and 
+000339b0: 6475 6d70 2061 6761 696e 2e22 2222 0a20  dump again.""". 
+000339c0: 2020 2020 2020 2070 6174 686c 6962 2e50         pathlib.P
+000339d0: 6174 6828 277e 2f64 6174 6173 6574 7327  ath('~/datasets'
+000339e0: 292e 6578 7061 6e64 7573 6572 2829 2e6d  ).expanduser().m
+000339f0: 6b64 6972 2865 7869 7374 5f6f 6b3d 5472  kdir(exist_ok=Tr
+00033a00: 7565 290a 2020 2020 2020 2020 7061 7468  ue).        path
+00033a10: 6c69 622e 5061 7468 2827 7e2f 746d 7066  lib.Path('~/tmpf
+00033a20: 696c 6527 292e 6578 7061 6e64 7573 6572  ile').expanduser
+00033a30: 2829 2e74 6f75 6368 2829 0a20 2020 2020  ().touch().     
+00033a40: 2020 2070 6174 686c 6962 2e50 6174 6828     pathlib.Path(
+00033a50: 277e 2f2e 7373 6827 292e 6578 7061 6e64  '~/.ssh').expand
+00033a60: 7573 6572 2829 2e6d 6b64 6972 2865 7869  user().mkdir(exi
+00033a70: 7374 5f6f 6b3d 5472 7565 290a 2020 2020  st_ok=True).    
+00033a80: 2020 2020 7061 7468 6c69 622e 5061 7468      pathlib.Path
+00033a90: 2827 7e2f 2e73 7368 2f69 645f 7273 612e  ('~/.ssh/id_rsa.
+00033aa0: 7075 6227 292e 6578 7061 6e64 7573 6572  pub').expanduser
+00033ab0: 2829 2e74 6f75 6368 2829 0a20 2020 2020  ().touch().     
+00033ac0: 2020 2070 6174 686c 6962 2e50 6174 6828     pathlib.Path(
+00033ad0: 277e 2f74 6d70 2d77 6f72 6b64 6972 2729  '~/tmp-workdir')
+00033ae0: 2e65 7870 616e 6475 7365 7228 292e 6d6b  .expanduser().mk
+00033af0: 6469 7228 6578 6973 745f 6f6b 3d54 7275  dir(exist_ok=Tru
+00033b00: 6529 0a20 2020 2020 2020 2070 6174 686c  e).        pathl
+00033b10: 6962 2e50 6174 6828 277e 2f44 6f77 6e6c  ib.Path('~/Downl
+00033b20: 6f61 6473 2f74 7075 2729 2e65 7870 616e  oads/tpu').expan
+00033b30: 6475 7365 7228 292e 6d6b 6469 7228 7061  duser().mkdir(pa
+00033b40: 7265 6e74 733d 5472 7565 2c0a 2020 2020  rents=True,.    
+00033b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033b80: 2020 2020 2020 2065 7869 7374 5f6f 6b3d         exist_ok=
+00033b90: 5472 7565 290a 2020 2020 2020 2020 666f  True).        fo
+00033ba0: 7220 7961 6d6c 5f70 6174 6820 696e 2073  r yaml_path in s
+00033bb0: 656c 662e 5f54 4553 545f 5941 4d4c 5f50  elf._TEST_YAML_P
+00033bc0: 4154 4853 3a0a 2020 2020 2020 2020 2020  ATHS:.          
+00033bd0: 2020 7365 6c66 2e5f 6368 6563 6b5f 6571    self._check_eq
+00033be0: 7569 7661 6c65 6e74 2879 616d 6c5f 7061  uivalent(yaml_pa
+00033bf0: 7468 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  th)...# --------
+00033c00: 2d2d 2054 6573 7469 6e67 204d 756c 7469  -- Testing Multi
+00033c10: 706c 6520 4163 6365 6c65 7261 746f 7273  ple Accelerators
+00033c20: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
+00033c30: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
+00033c40: 6473 7461 636b 2020 2320 466c 7569 6473  dstack  # Fluids
+00033c50: 7461 636b 2064 6f65 7320 6e6f 7420 7375  tack does not su
+00033c60: 7070 6f72 7420 4b38 3020 6770 7573 2066  pport K80 gpus f
+00033c70: 6f72 206e 6f77 0a40 7079 7465 7374 2e6d  or now.@pytest.m
+00033c80: 6172 6b2e 6e6f 5f70 6170 6572 7370 6163  ark.no_paperspac
+00033c90: 6520 2023 2050 6170 6572 7370 6163 6520  e  # Paperspace 
+00033ca0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+00033cb0: 204b 3830 2067 7075 730a 6465 6620 7465   K80 gpus.def te
+00033cc0: 7374 5f6d 756c 7469 706c 655f 6163 6365  st_multiple_acce
+00033cd0: 6c65 7261 746f 7273 5f6f 7264 6572 6564  lerators_ordered
+00033ce0: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
+00033cf0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+00033d00: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+00033d10: 7374 280a 2020 2020 2020 2020 276d 756c  st(.        'mul
+00033d20: 7469 706c 652d 6163 6365 6c65 7261 746f  tiple-accelerato
+00033d30: 7273 2d6f 7264 6572 6564 272c 0a20 2020  rs-ordered',.   
+00033d40: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00033d50: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00033d60: 2d79 202d 6320 7b6e 616d 657d 2074 6573  -y -c {name} tes
+00033d70: 7473 2f74 6573 745f 7961 6d6c 732f 7465  ts/test_yamls/te
+00033d80: 7374 5f6d 756c 7469 706c 655f 6163 6365  st_multiple_acce
+00033d90: 6c65 7261 746f 7273 5f6f 7264 6572 6564  lerators_ordered
+00033da0: 2e79 616d 6c20 7c20 6772 6570 2022 5573  .yaml | grep "Us
+00033db0: 696e 6720 7573 6572 2d73 7065 6369 6669  ing user-specifi
+00033dc0: 6564 2061 6363 656c 6572 6174 6f72 7320  ed accelerators 
+00033dd0: 6c69 7374 2227 2c0a 2020 2020 2020 2020  list"',.        
+00033de0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00033df0: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+00033e00: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+00033e10: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+00033e20: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00033e30: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+00033e40: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
+00033e50: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
+00033e60: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
+00033e70: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00033e80: 0a0a 4070 7974 6573 742e 6d61 726b 2e6e  ..@pytest.mark.n
+00033e90: 6f5f 666c 7569 6473 7461 636b 2020 2320  o_fluidstack  # 
+00033ea0: 466c 7569 6473 7461 636b 2068 6173 206c  Fluidstack has l
+00033eb0: 6f77 2061 7661 696c 6162 696c 6974 7920  ow availability 
+00033ec0: 666f 7220 5434 2047 5055 730a 4070 7974  for T4 GPUs.@pyt
+00033ed0: 6573 742e 6d61 726b 2e6e 6f5f 7061 7065  est.mark.no_pape
+00033ee0: 7273 7061 6365 2020 2320 5061 7065 7273  rspace  # Papers
+00033ef0: 7061 6365 2064 6f65 7320 6e6f 7420 7375  pace does not su
+00033f00: 7070 6f72 7420 5434 2047 5055 730a 6465  pport T4 GPUs.de
+00033f10: 6620 7465 7374 5f6d 756c 7469 706c 655f  f test_multiple_
+00033f20: 6163 6365 6c65 7261 746f 7273 5f6f 7264  accelerators_ord
+00033f30: 6572 6564 5f77 6974 685f 6465 6661 756c  ered_with_defaul
+00033f40: 7428 293a 0a20 2020 206e 616d 6520 3d20  t():.    name = 
+00033f50: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00033f60: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+00033f70: 6573 7428 0a20 2020 2020 2020 2027 6d75  est(.        'mu
+00033f80: 6c74 6970 6c65 2d61 6363 656c 6572 6174  ltiple-accelerat
+00033f90: 6f72 732d 6f72 6465 7265 6427 2c0a 2020  ors-ordered',.  
+00033fa0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00033fb0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00033fc0: 202d 7920 2d63 207b 6e61 6d65 7d20 7465   -y -c {name} te
+00033fd0: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
+00033fe0: 6573 745f 6d75 6c74 6970 6c65 5f61 6363  est_multiple_acc
+00033ff0: 656c 6572 6174 6f72 735f 6f72 6465 7265  elerators_ordere
+00034000: 645f 7769 7468 5f64 6566 6175 6c74 2e79  d_with_default.y
+00034010: 616d 6c20 7c20 6772 6570 2022 5573 696e  aml | grep "Usin
+00034020: 6720 7573 6572 2d73 7065 6369 6669 6564  g user-specified
+00034030: 2061 6363 656c 6572 6174 6f72 7320 6c69   accelerators li
+00034040: 7374 2227 2c0a 2020 2020 2020 2020 2020  st"',.          
+00034050: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00034060: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+00034070: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+00034080: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+00034090: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000340a0: 7374 6174 7573 207b 6e61 6d65 7d20 7c20  status {name} | 
+000340b0: 6772 6570 2053 706f 7427 2c0a 2020 2020  grep Spot',.    
+000340c0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+000340d0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+000340e0: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+000340f0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00034100: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00034110: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b20  k.no_fluidstack 
+00034120: 2023 2046 6c75 6964 7374 6163 6b20 6861   # Fluidstack ha
+00034130: 7320 6c6f 7720 6176 6169 6c61 6269 6c69  s low availabili
+00034140: 7479 2066 6f72 2054 3420 4750 5573 0a40  ty for T4 GPUs.@
+00034150: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f70  pytest.mark.no_p
+00034160: 6170 6572 7370 6163 6520 2023 2050 6170  aperspace  # Pap
+00034170: 6572 7370 6163 6520 646f 6573 206e 6f74  erspace does not
+00034180: 2073 7570 706f 7274 2054 3420 4750 5573   support T4 GPUs
+00034190: 0a64 6566 2074 6573 745f 6d75 6c74 6970  .def test_multip
+000341a0: 6c65 5f61 6363 656c 6572 6174 6f72 735f  le_accelerators_
+000341b0: 756e 6f72 6465 7265 6428 293a 0a20 2020  unordered():.   
+000341c0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+000341d0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+000341e0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+000341f0: 2020 2020 2027 6d75 6c74 6970 6c65 2d61       'multiple-a
+00034200: 6363 656c 6572 6174 6f72 732d 756e 6f72  ccelerators-unor
+00034210: 6465 7265 6427 2c0a 2020 2020 2020 2020  dered',.        
+00034220: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00034230: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00034240: 207b 6e61 6d65 7d20 7465 7374 732f 7465   {name} tests/te
+00034250: 7374 5f79 616d 6c73 2f74 6573 745f 6d75  st_yamls/test_mu
+00034260: 6c74 6970 6c65 5f61 6363 656c 6572 6174  ltiple_accelerat
+00034270: 6f72 735f 756e 6f72 6465 7265 642e 7961  ors_unordered.ya
+00034280: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00034290: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+000342a0: 657d 2031 202d 2d73 7461 7475 7327 2c20  e} 1 --status', 
+000342b0: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+000342c0: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
+000342d0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+000342e0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+000342f0: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
+00034300: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00034310: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00034320: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
+00034330: 2020 2320 466c 7569 6473 7461 636b 2068    # Fluidstack h
+00034340: 6173 206c 6f77 2061 7661 696c 6162 696c  as low availabil
+00034350: 6974 7920 666f 7220 5434 2047 5055 730a  ity for T4 GPUs.
+00034360: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00034370: 7061 7065 7273 7061 6365 2020 2320 5061  paperspace  # Pa
+00034380: 7065 7273 7061 6365 2064 6f65 7320 6e6f  perspace does no
+00034390: 7420 7375 7070 6f72 7420 5434 2047 5055  t support T4 GPU
+000343a0: 730a 6465 6620 7465 7374 5f6d 756c 7469  s.def test_multi
+000343b0: 706c 655f 6163 6365 6c65 7261 746f 7273  ple_accelerators
+000343c0: 5f75 6e6f 7264 6572 6564 5f77 6974 685f  _unordered_with_
+000343d0: 6465 6661 756c 7428 293a 0a20 2020 206e  default():.    n
+000343e0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+000343f0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+00034400: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00034410: 2020 2027 6d75 6c74 6970 6c65 2d61 6363     'multiple-acc
+00034420: 656c 6572 6174 6f72 732d 756e 6f72 6465  elerators-unorde
+00034430: 7265 6427 2c0a 2020 2020 2020 2020 5b0a  red',.        [.
+00034440: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00034450: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00034460: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
+00034470: 5f79 616d 6c73 2f74 6573 745f 6d75 6c74  _yamls/test_mult
+00034480: 6970 6c65 5f61 6363 656c 6572 6174 6f72  iple_accelerator
+00034490: 735f 756e 6f72 6465 7265 645f 7769 7468  s_unordered_with
+000344a0: 5f64 6566 6175 6c74 2e79 616d 6c27 2c0a  _default.yaml',.
+000344b0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000344c0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+000344d0: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
+000344e0: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
+000344f0: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+00034500: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
+00034510: 207b 6e61 6d65 7d20 7c20 6772 6570 2053   {name} | grep S
+00034520: 706f 7427 2c0a 2020 2020 2020 2020 5d2c  pot',.        ],
+00034530: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+00034540: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+00034550: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00034560: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+00034570: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
+00034580: 6c75 6964 7374 6163 6b20 2023 2052 6571  luidstack  # Req
+00034590: 7569 7265 7320 6f74 6865 7220 636c 6f75  uires other clou
+000345a0: 6473 2074 6f20 6265 2065 6e61 626c 6564  ds to be enabled
+000345b0: 0a64 6566 2074 6573 745f 6d75 6c74 6970  .def test_multip
+000345c0: 6c65 5f72 6573 6f75 7263 6573 2829 3a0a  le_resources():.
+000345d0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+000345e0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+000345f0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00034600: 2020 2020 2020 2020 276d 756c 7469 706c          'multipl
+00034610: 652d 7265 736f 7572 6365 7327 2c0a 2020  e-resources',.  
+00034620: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00034630: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00034640: 202d 7920 2d63 207b 6e61 6d65 7d20 7465   -y -c {name} te
+00034650: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
+00034660: 6573 745f 6d75 6c74 6970 6c65 5f72 6573  est_multiple_res
+00034670: 6f75 7263 6573 2e79 616d 6c27 2c0a 2020  ources.yaml',.  
+00034680: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00034690: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+000346a0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+000346b0: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
+000346c0: 6564 6564 2e0a 2020 2020 2020 2020 5d2c  eded..        ],
+000346d0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+000346e0: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+000346f0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00034700: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
+00034710: 202d 2d2d 2d2d 2d2d 2d2d 2d20 536b 7920   ---------- Sky 
+00034720: 4265 6e63 686d 6172 6b20 2d2d 2d2d 2d2d  Benchmark ------
+00034730: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
+00034740: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b20  k.no_fluidstack 
+00034750: 2023 2052 6571 7569 7265 7320 6f74 6865   # Requires othe
+00034760: 7220 636c 6f75 6473 2074 6f20 6265 2065  r clouds to be e
+00034770: 6e61 626c 6564 0a40 7079 7465 7374 2e6d  nabled.@pytest.m
+00034780: 6172 6b2e 6e6f 5f70 6170 6572 7370 6163  ark.no_paperspac
+00034790: 6520 2023 2052 6571 7569 7265 7320 6f74  e  # Requires ot
+000347a0: 6865 7220 636c 6f75 6473 2074 6f20 6265  her clouds to be
+000347b0: 2065 6e61 626c 6564 0a40 7079 7465 7374   enabled.@pytest
+000347c0: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
+000347d0: 7465 730a 6465 6620 7465 7374 5f73 6b79  tes.def test_sky
+000347e0: 5f62 656e 6368 2867 656e 6572 6963 5f63  _bench(generic_c
+000347f0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+00034800: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00034810: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+00034820: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00034830: 2020 2020 2773 6b79 2d62 656e 6368 272c      'sky-bench',
+00034840: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00034850: 2020 2020 2020 2066 2773 6b79 2062 656e         f'sky ben
+00034860: 6368 206c 6175 6e63 6820 2d79 202d 6220  ch launch -y -b 
+00034870: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
+00034880: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
+00034890: 6930 2074 6573 7473 2f74 6573 745f 7961  i0 tests/test_ya
+000348a0: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
+000348b0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+000348c0: 736c 6565 7020 3132 3027 2c0a 2020 2020  sleep 120',.    
+000348d0: 2020 2020 2020 2020 6627 736b 7920 6265          f'sky be
+000348e0: 6e63 6820 7368 6f77 207b 6e61 6d65 7d20  nch show {name} 
+000348f0: 7c20 6772 6570 2073 6b79 2d62 656e 6368  | grep sky-bench
+00034900: 2d7b 6e61 6d65 7d20 7c20 6772 6570 2046  -{name} | grep F
+00034910: 494e 4953 4845 4427 2c0a 2020 2020 2020  INISHED',.      
+00034920: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+00034930: 6b79 2062 656e 6368 2064 6f77 6e20 7b6e  ky bench down {n
+00034940: 616d 657d 202d 793b 2073 6b79 2062 656e  ame} -y; sky ben
+00034950: 6368 2064 656c 6574 6520 7b6e 616d 657d  ch delete {name}
+00034960: 202d 7927 2c0a 2020 2020 290a 2020 2020   -y',.    ).    
+00034970: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00034980: 7429 0a                                  t).
```

### Comparing `skypilot_nightly-1.0.0.dev20240501/tests/test_spot_serve.py` & `skypilot_nightly-1.0.0.dev20240502/tests/test_spot_serve.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/tests/test_storage.py` & `skypilot_nightly-1.0.0.dev20240502/tests/test_storage.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/tests/test_wheels.py` & `skypilot_nightly-1.0.0.dev20240502/tests/test_wheels.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240501/tests/test_yaml_parser.py` & `skypilot_nightly-1.0.0.dev20240502/tests/test_yaml_parser.py`

 * *Files identical despite different names*

