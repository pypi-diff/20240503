# Comparing `tmp/torchrl_nightly-2024.5.2-cp39-cp39-win_amd64.whl.zip` & `tmp/torchrl_nightly-2024.5.3-cp39-cp39-win_amd64.whl.zip`

## zipinfo {}

```diff
@@ -1,162 +1,162 @@
-Zip file size: 902210 bytes, number of entries: 160
--rw-rw-rw-  2.0 fat      183 b- defN 24-May-02 11:18 build_tools/__init__.py
--rw-rw-rw-  2.0 fat      245 b- defN 24-May-02 11:18 build_tools/setup_helpers/__init__.py
--rw-rw-rw-  2.0 fat     6085 b- defN 24-May-02 11:18 build_tools/setup_helpers/extension.py
--rw-rw-rw-  2.0 fat     1452 b- defN 24-May-02 11:18 torchrl/__init__.py
--rw-rw-rw-  2.0 fat     1240 b- defN 24-May-02 11:18 torchrl/_extension.py
--rw-rw-rw-  2.0 fat   373760 b- defN 24-May-02 11:21 torchrl/_torchrl.pyd
--rw-rw-rw-  2.0 fat    26867 b- defN 24-May-02 11:18 torchrl/_utils.py
--rw-rw-rw-  2.0 fat       84 b- defN 24-May-02 11:20 torchrl/version.py
--rw-rw-rw-  2.0 fat      394 b- defN 24-May-02 11:18 torchrl/collectors/__init__.py
--rw-rw-rw-  2.0 fat   134396 b- defN 24-May-02 11:18 torchrl/collectors/collectors.py
--rw-rw-rw-  2.0 fat     8610 b- defN 24-May-02 11:18 torchrl/collectors/utils.py
--rw-rw-rw-  2.0 fat      412 b- defN 24-May-02 11:18 torchrl/collectors/distributed/__init__.py
--rw-rw-rw-  2.0 fat      674 b- defN 24-May-02 11:18 torchrl/collectors/distributed/default_configs.py
--rw-rw-rw-  2.0 fat    40438 b- defN 24-May-02 11:18 torchrl/collectors/distributed/generic.py
--rw-rw-rw-  2.0 fat    33423 b- defN 24-May-02 11:18 torchrl/collectors/distributed/ray.py
--rw-rw-rw-  2.0 fat    34183 b- defN 24-May-02 11:18 torchrl/collectors/distributed/rpc.py
--rw-rw-rw-  2.0 fat    26560 b- defN 24-May-02 11:18 torchrl/collectors/distributed/sync.py
--rw-rw-rw-  2.0 fat     6402 b- defN 24-May-02 11:18 torchrl/collectors/distributed/utils.py
--rw-rw-rw-  2.0 fat     1653 b- defN 24-May-02 11:18 torchrl/data/__init__.py
--rw-rw-rw-  2.0 fat   171719 b- defN 24-May-02 11:18 torchrl/data/tensor_specs.py
--rw-rw-rw-  2.0 fat    12387 b- defN 24-May-02 11:18 torchrl/data/utils.py
--rw-rw-rw-  2.0 fat      593 b- defN 24-May-02 11:18 torchrl/data/datasets/__init__.py
--rw-rw-rw-  2.0 fat    41201 b- defN 24-May-02 11:18 torchrl/data/datasets/atari_dqn.py
--rw-rw-rw-  2.0 fat    16294 b- defN 24-May-02 11:18 torchrl/data/datasets/common.py
--rw-rw-rw-  2.0 fat    20080 b- defN 24-May-02 11:18 torchrl/data/datasets/d4rl.py
--rw-rw-rw-  2.0 fat    22721 b- defN 24-May-02 11:18 torchrl/data/datasets/d4rl_infos.py
--rw-rw-rw-  2.0 fat    14633 b- defN 24-May-02 11:18 torchrl/data/datasets/gen_dgrl.py
--rw-rw-rw-  2.0 fat    21337 b- defN 24-May-02 11:18 torchrl/data/datasets/minari_data.py
--rw-rw-rw-  2.0 fat     7190 b- defN 24-May-02 11:18 torchrl/data/datasets/openml.py
--rw-rw-rw-  2.0 fat    33991 b- defN 24-May-02 11:18 torchrl/data/datasets/openx.py
--rw-rw-rw-  2.0 fat    17017 b- defN 24-May-02 11:18 torchrl/data/datasets/roboset.py
--rw-rw-rw-  2.0 fat      312 b- defN 24-May-02 11:18 torchrl/data/datasets/utils.py
--rw-rw-rw-  2.0 fat    18687 b- defN 24-May-02 11:18 torchrl/data/datasets/vd4rl.py
--rw-rw-rw-  2.0 fat      219 b- defN 24-May-02 11:18 torchrl/data/postprocs/__init__.py
--rw-rw-rw-  2.0 fat    11627 b- defN 24-May-02 11:18 torchrl/data/postprocs/postprocs.py
--rw-rw-rw-  2.0 fat      953 b- defN 24-May-02 11:18 torchrl/data/replay_buffers/__init__.py
--rw-rw-rw-  2.0 fat    76136 b- defN 24-May-02 11:18 torchrl/data/replay_buffers/replay_buffers.py
--rw-rw-rw-  2.0 fat    87065 b- defN 24-May-02 11:18 torchrl/data/replay_buffers/samplers.py
--rw-rw-rw-  2.0 fat    58160 b- defN 24-May-02 11:18 torchrl/data/replay_buffers/storages.py
--rw-rw-rw-  2.0 fat     2954 b- defN 24-May-02 11:18 torchrl/data/replay_buffers/utils.py
--rw-rw-rw-  2.0 fat    24261 b- defN 24-May-02 11:18 torchrl/data/replay_buffers/writers.py
--rw-rw-rw-  2.0 fat      508 b- defN 24-May-02 11:18 torchrl/data/rlhf/__init__.py
--rw-rw-rw-  2.0 fat    20989 b- defN 24-May-02 11:18 torchrl/data/rlhf/dataset.py
--rw-rw-rw-  2.0 fat     8617 b- defN 24-May-02 11:18 torchrl/data/rlhf/prompt.py
--rw-rw-rw-  2.0 fat     8668 b- defN 24-May-02 11:18 torchrl/data/rlhf/reward.py
--rw-rw-rw-  2.0 fat    24134 b- defN 24-May-02 11:18 torchrl/data/rlhf/utils.py
--rw-rw-rw-  2.0 fat     2482 b- defN 24-May-02 11:18 torchrl/envs/__init__.py
--rw-rw-rw-  2.0 fat    85060 b- defN 24-May-02 11:18 torchrl/envs/batched_envs.py
--rw-rw-rw-  2.0 fat   134853 b- defN 24-May-02 11:18 torchrl/envs/common.py
--rw-rw-rw-  2.0 fat     7661 b- defN 24-May-02 11:18 torchrl/envs/env_creator.py
--rw-rw-rw-  2.0 fat    21850 b- defN 24-May-02 11:18 torchrl/envs/gym_like.py
--rw-rw-rw-  2.0 fat    68344 b- defN 24-May-02 11:18 torchrl/envs/utils.py
--rw-rw-rw-  2.0 fat      339 b- defN 24-May-02 11:18 torchrl/envs/vec_envs.py
--rw-rw-rw-  2.0 fat      874 b- defN 24-May-02 11:18 torchrl/envs/libs/__init__.py
--rw-rw-rw-  2.0 fat    10400 b- defN 24-May-02 11:18 torchrl/envs/libs/_gym_utils.py
--rw-rw-rw-  2.0 fat    24078 b- defN 24-May-02 11:18 torchrl/envs/libs/brax.py
--rw-rw-rw-  2.0 fat    20968 b- defN 24-May-02 11:18 torchrl/envs/libs/dm_control.py
--rw-rw-rw-  2.0 fat    16723 b- defN 24-May-02 11:18 torchrl/envs/libs/envpool.py
--rw-rw-rw-  2.0 fat    62823 b- defN 24-May-02 11:18 torchrl/envs/libs/gym.py
--rw-rw-rw-  2.0 fat     5437 b- defN 24-May-02 11:18 torchrl/envs/libs/habitat.py
--rw-rw-rw-  2.0 fat     6954 b- defN 24-May-02 11:18 torchrl/envs/libs/isaacgym.py
--rw-rw-rw-  2.0 fat     5333 b- defN 24-May-02 11:18 torchrl/envs/libs/jax_utils.py
--rw-rw-rw-  2.0 fat    38178 b- defN 24-May-02 11:18 torchrl/envs/libs/jumanji.py
--rw-rw-rw-  2.0 fat    26778 b- defN 24-May-02 11:18 torchrl/envs/libs/meltingpot.py
--rw-rw-rw-  2.0 fat     6019 b- defN 24-May-02 11:18 torchrl/envs/libs/openml.py
--rw-rw-rw-  2.0 fat    47103 b- defN 24-May-02 11:18 torchrl/envs/libs/pettingzoo.py
--rw-rw-rw-  2.0 fat    16194 b- defN 24-May-02 11:18 torchrl/envs/libs/robohive.py
--rw-rw-rw-  2.0 fat    29939 b- defN 24-May-02 11:18 torchrl/envs/libs/smacv2.py
--rw-rw-rw-  2.0 fat     5316 b- defN 24-May-02 11:18 torchrl/envs/libs/utils.py
--rw-rw-rw-  2.0 fat    36083 b- defN 24-May-02 11:18 torchrl/envs/libs/vmas.py
--rw-rw-rw-  2.0 fat      273 b- defN 24-May-02 11:18 torchrl/envs/model_based/__init__.py
--rw-rw-rw-  2.0 fat     7907 b- defN 24-May-02 11:18 torchrl/envs/model_based/common.py
--rw-rw-rw-  2.0 fat     3487 b- defN 24-May-02 11:18 torchrl/envs/model_based/dreamer.py
--rw-rw-rw-  2.0 fat     1473 b- defN 24-May-02 11:18 torchrl/envs/transforms/__init__.py
--rw-rw-rw-  2.0 fat     1485 b- defN 24-May-02 11:18 torchrl/envs/transforms/functional.py
--rw-rw-rw-  2.0 fat    10062 b- defN 24-May-02 11:18 torchrl/envs/transforms/gym_transforms.py
--rw-rw-rw-  2.0 fat    13933 b- defN 24-May-02 11:18 torchrl/envs/transforms/r3m.py
--rw-rw-rw-  2.0 fat     7684 b- defN 24-May-02 11:18 torchrl/envs/transforms/rb_transforms.py
--rw-rw-rw-  2.0 fat    10085 b- defN 24-May-02 11:18 torchrl/envs/transforms/rlhf.py
--rw-rw-rw-  2.0 fat   343890 b- defN 24-May-02 11:18 torchrl/envs/transforms/transforms.py
--rw-rw-rw-  2.0 fat     2094 b- defN 24-May-02 11:18 torchrl/envs/transforms/utils.py
--rw-rw-rw-  2.0 fat    10883 b- defN 24-May-02 11:18 torchrl/envs/transforms/vc1.py
--rw-rw-rw-  2.0 fat    15290 b- defN 24-May-02 11:18 torchrl/envs/transforms/vip.py
--rw-rw-rw-  2.0 fat     1903 b- defN 24-May-02 11:18 torchrl/modules/__init__.py
--rw-rw-rw-  2.0 fat      681 b- defN 24-May-02 11:18 torchrl/modules/distributions/__init__.py
--rw-rw-rw-  2.0 fat    21427 b- defN 24-May-02 11:18 torchrl/modules/distributions/continuous.py
--rw-rw-rw-  2.0 fat    17803 b- defN 24-May-02 11:18 torchrl/modules/distributions/discrete.py
--rw-rw-rw-  2.0 fat     6123 b- defN 24-May-02 11:18 torchrl/modules/distributions/truncated_normal.py
--rw-rw-rw-  2.0 fat     6115 b- defN 24-May-02 11:18 torchrl/modules/distributions/utils.py
--rw-rw-rw-  2.0 fat      884 b- defN 24-May-02 11:18 torchrl/modules/models/__init__.py
--rw-rw-rw-  2.0 fat     6727 b- defN 24-May-02 11:18 torchrl/modules/models/decision_transformer.py
--rw-rw-rw-  2.0 fat    21920 b- defN 24-May-02 11:18 torchrl/modules/models/exploration.py
--rw-rw-rw-  2.0 fat    14291 b- defN 24-May-02 11:18 torchrl/modules/models/model_based.py
--rw-rw-rw-  2.0 fat    66963 b- defN 24-May-02 11:18 torchrl/modules/models/models.py
--rw-rw-rw-  2.0 fat    37131 b- defN 24-May-02 11:18 torchrl/modules/models/multiagent.py
--rw-rw-rw-  2.0 fat     6520 b- defN 24-May-02 11:18 torchrl/modules/models/rlhf.py
--rw-rw-rw-  2.0 fat     5221 b- defN 24-May-02 11:18 torchrl/modules/models/utils.py
--rw-rw-rw-  2.0 fat      281 b- defN 24-May-02 11:18 torchrl/modules/planners/__init__.py
--rw-rw-rw-  2.0 fat     9784 b- defN 24-May-02 11:18 torchrl/modules/planners/cem.py
--rw-rw-rw-  2.0 fat     2451 b- defN 24-May-02 11:18 torchrl/modules/planners/common.py
--rw-rw-rw-  2.0 fat    11047 b- defN 24-May-02 11:18 torchrl/modules/planners/mppi.py
--rw-rw-rw-  2.0 fat     1056 b- defN 24-May-02 11:18 torchrl/modules/tensordict_module/__init__.py
--rw-rw-rw-  2.0 fat   105738 b- defN 24-May-02 11:18 torchrl/modules/tensordict_module/actors.py
--rw-rw-rw-  2.0 fat    21933 b- defN 24-May-02 11:18 torchrl/modules/tensordict_module/common.py
--rw-rw-rw-  2.0 fat    30492 b- defN 24-May-02 11:18 torchrl/modules/tensordict_module/exploration.py
--rw-rw-rw-  2.0 fat    12045 b- defN 24-May-02 11:18 torchrl/modules/tensordict_module/probabilistic.py
--rw-rw-rw-  2.0 fat    57588 b- defN 24-May-02 11:18 torchrl/modules/tensordict_module/rnn.py
--rw-rw-rw-  2.0 fat     5804 b- defN 24-May-02 11:18 torchrl/modules/tensordict_module/sequence.py
--rw-rw-rw-  2.0 fat     1360 b- defN 24-May-02 11:18 torchrl/modules/tensordict_module/world_models.py
--rw-rw-rw-  2.0 fat     1046 b- defN 24-May-02 11:18 torchrl/modules/utils/__init__.py
--rw-rw-rw-  2.0 fat     2435 b- defN 24-May-02 11:18 torchrl/modules/utils/mappings.py
--rw-rw-rw-  2.0 fat        0 b- defN 24-May-02 11:18 torchrl/modules/utils/utils.py
--rw-rw-rw-  2.0 fat     1047 b- defN 24-May-02 11:18 torchrl/objectives/__init__.py
--rw-rw-rw-  2.0 fat    24345 b- defN 24-May-02 11:18 torchrl/objectives/a2c.py
--rw-rw-rw-  2.0 fat    20668 b- defN 24-May-02 11:18 torchrl/objectives/common.py
--rw-rw-rw-  2.0 fat    53644 b- defN 24-May-02 11:18 torchrl/objectives/cql.py
--rw-rw-rw-  2.0 fat    17227 b- defN 24-May-02 11:18 torchrl/objectives/ddpg.py
--rw-rw-rw-  2.0 fat    12662 b- defN 24-May-02 11:18 torchrl/objectives/decision_transformer.py
--rw-rw-rw-  2.0 fat    19010 b- defN 24-May-02 11:18 torchrl/objectives/deprecated.py
--rw-rw-rw-  2.0 fat    28303 b- defN 24-May-02 11:18 torchrl/objectives/dqn.py
--rw-rw-rw-  2.0 fat    18156 b- defN 24-May-02 11:18 torchrl/objectives/dreamer.py
--rw-rw-rw-  2.0 fat     2155 b- defN 24-May-02 11:18 torchrl/objectives/functional.py
--rw-rw-rw-  2.0 fat    39036 b- defN 24-May-02 11:18 torchrl/objectives/iql.py
--rw-rw-rw-  2.0 fat    51682 b- defN 24-May-02 11:18 torchrl/objectives/ppo.py
--rw-rw-rw-  2.0 fat    27125 b- defN 24-May-02 11:18 torchrl/objectives/redq.py
--rw-rw-rw-  2.0 fat    21557 b- defN 24-May-02 11:18 torchrl/objectives/reinforce.py
--rw-rw-rw-  2.0 fat    56606 b- defN 24-May-02 11:18 torchrl/objectives/sac.py
--rw-rw-rw-  2.0 fat    21944 b- defN 24-May-02 11:18 torchrl/objectives/td3.py
--rw-rw-rw-  2.0 fat    19336 b- defN 24-May-02 11:18 torchrl/objectives/utils.py
--rw-rw-rw-  2.0 fat      217 b- defN 24-May-02 11:18 torchrl/objectives/multiagent/__init__.py
--rw-rw-rw-  2.0 fat    17154 b- defN 24-May-02 11:18 torchrl/objectives/multiagent/qmixer.py
--rw-rw-rw-  2.0 fat      384 b- defN 24-May-02 11:18 torchrl/objectives/value/__init__.py
--rw-rw-rw-  2.0 fat    77377 b- defN 24-May-02 11:18 torchrl/objectives/value/advantages.py
--rw-rw-rw-  2.0 fat    50043 b- defN 24-May-02 11:18 torchrl/objectives/value/functional.py
--rw-rw-rw-  2.0 fat      317 b- defN 24-May-02 11:18 torchrl/objectives/value/pg.py
--rw-rw-rw-  2.0 fat    13444 b- defN 24-May-02 11:18 torchrl/objectives/value/utils.py
--rw-rw-rw-  2.0 fat      342 b- defN 24-May-02 11:18 torchrl/record/__init__.py
--rw-rw-rw-  2.0 fat    22236 b- defN 24-May-02 11:18 torchrl/record/recorder.py
--rw-rw-rw-  2.0 fat      405 b- defN 24-May-02 11:18 torchrl/record/loggers/__init__.py
--rw-rw-rw-  2.0 fat     1182 b- defN 24-May-02 11:18 torchrl/record/loggers/common.py
--rw-rw-rw-  2.0 fat     8232 b- defN 24-May-02 11:18 torchrl/record/loggers/csv.py
--rw-rw-rw-  2.0 fat     4600 b- defN 24-May-02 11:18 torchrl/record/loggers/mlflow.py
--rw-rw-rw-  2.0 fat     4944 b- defN 24-May-02 11:18 torchrl/record/loggers/tensorboard.py
--rw-rw-rw-  2.0 fat     2398 b- defN 24-May-02 11:18 torchrl/record/loggers/utils.py
--rw-rw-rw-  2.0 fat     7974 b- defN 24-May-02 11:18 torchrl/record/loggers/wandb.py
--rw-rw-rw-  2.0 fat      467 b- defN 24-May-02 11:18 torchrl/trainers/__init__.py
--rw-rw-rw-  2.0 fat    51838 b- defN 24-May-02 11:18 torchrl/trainers/trainers.py
--rw-rw-rw-  2.0 fat      701 b- defN 24-May-02 11:18 torchrl/trainers/helpers/__init__.py
--rw-rw-rw-  2.0 fat    19326 b- defN 24-May-02 11:18 torchrl/trainers/helpers/collectors.py
--rw-rw-rw-  2.0 fat    22336 b- defN 24-May-02 11:18 torchrl/trainers/helpers/envs.py
--rw-rw-rw-  2.0 fat     1275 b- defN 24-May-02 11:18 torchrl/trainers/helpers/logger.py
--rw-rw-rw-  2.0 fat     5389 b- defN 24-May-02 11:18 torchrl/trainers/helpers/losses.py
--rw-rw-rw-  2.0 fat    22664 b- defN 24-May-02 11:18 torchrl/trainers/helpers/models.py
--rw-rw-rw-  2.0 fat     1985 b- defN 24-May-02 11:18 torchrl/trainers/helpers/replay_buffer.py
--rw-rw-rw-  2.0 fat    12385 b- defN 24-May-02 11:18 torchrl/trainers/helpers/trainers.py
--rw-rw-rw-  2.0 fat     1119 b- defN 24-May-02 11:21 torchrl_nightly-2024.5.2.dist-info/LICENSE
--rw-rw-rw-  2.0 fat    32621 b- defN 24-May-02 11:21 torchrl_nightly-2024.5.2.dist-info/METADATA
--rw-rw-rw-  2.0 fat      100 b- defN 24-May-02 11:21 torchrl_nightly-2024.5.2.dist-info/WHEEL
--rw-rw-rw-  2.0 fat       20 b- defN 24-May-02 11:21 torchrl_nightly-2024.5.2.dist-info/top_level.txt
--rw-rw-r--  2.0 fat    14366 b- defN 24-May-02 11:21 torchrl_nightly-2024.5.2.dist-info/RECORD
-160 files, 3836962 bytes uncompressed, 879546 bytes compressed:  77.1%
+Zip file size: 904751 bytes, number of entries: 160
+-rw-rw-rw-  2.0 fat      183 b- defN 24-May-03 11:18 build_tools/__init__.py
+-rw-rw-rw-  2.0 fat      245 b- defN 24-May-03 11:18 build_tools/setup_helpers/__init__.py
+-rw-rw-rw-  2.0 fat     6085 b- defN 24-May-03 11:18 build_tools/setup_helpers/extension.py
+-rw-rw-rw-  2.0 fat     1452 b- defN 24-May-03 11:18 torchrl/__init__.py
+-rw-rw-rw-  2.0 fat     1240 b- defN 24-May-03 11:18 torchrl/_extension.py
+-rw-rw-rw-  2.0 fat   373760 b- defN 24-May-03 11:21 torchrl/_torchrl.pyd
+-rw-rw-rw-  2.0 fat    26867 b- defN 24-May-03 11:18 torchrl/_utils.py
+-rw-rw-rw-  2.0 fat       84 b- defN 24-May-03 11:20 torchrl/version.py
+-rw-rw-rw-  2.0 fat      394 b- defN 24-May-03 11:18 torchrl/collectors/__init__.py
+-rw-rw-rw-  2.0 fat   134396 b- defN 24-May-03 11:18 torchrl/collectors/collectors.py
+-rw-rw-rw-  2.0 fat     8610 b- defN 24-May-03 11:18 torchrl/collectors/utils.py
+-rw-rw-rw-  2.0 fat      412 b- defN 24-May-03 11:18 torchrl/collectors/distributed/__init__.py
+-rw-rw-rw-  2.0 fat      674 b- defN 24-May-03 11:18 torchrl/collectors/distributed/default_configs.py
+-rw-rw-rw-  2.0 fat    40438 b- defN 24-May-03 11:18 torchrl/collectors/distributed/generic.py
+-rw-rw-rw-  2.0 fat    33423 b- defN 24-May-03 11:18 torchrl/collectors/distributed/ray.py
+-rw-rw-rw-  2.0 fat    34183 b- defN 24-May-03 11:18 torchrl/collectors/distributed/rpc.py
+-rw-rw-rw-  2.0 fat    26560 b- defN 24-May-03 11:18 torchrl/collectors/distributed/sync.py
+-rw-rw-rw-  2.0 fat     6402 b- defN 24-May-03 11:18 torchrl/collectors/distributed/utils.py
+-rw-rw-rw-  2.0 fat     1653 b- defN 24-May-03 11:18 torchrl/data/__init__.py
+-rw-rw-rw-  2.0 fat   171719 b- defN 24-May-03 11:18 torchrl/data/tensor_specs.py
+-rw-rw-rw-  2.0 fat    12387 b- defN 24-May-03 11:18 torchrl/data/utils.py
+-rw-rw-rw-  2.0 fat      593 b- defN 24-May-03 11:18 torchrl/data/datasets/__init__.py
+-rw-rw-rw-  2.0 fat    41201 b- defN 24-May-03 11:18 torchrl/data/datasets/atari_dqn.py
+-rw-rw-rw-  2.0 fat    16294 b- defN 24-May-03 11:18 torchrl/data/datasets/common.py
+-rw-rw-rw-  2.0 fat    20080 b- defN 24-May-03 11:18 torchrl/data/datasets/d4rl.py
+-rw-rw-rw-  2.0 fat    22721 b- defN 24-May-03 11:18 torchrl/data/datasets/d4rl_infos.py
+-rw-rw-rw-  2.0 fat    14633 b- defN 24-May-03 11:18 torchrl/data/datasets/gen_dgrl.py
+-rw-rw-rw-  2.0 fat    21337 b- defN 24-May-03 11:18 torchrl/data/datasets/minari_data.py
+-rw-rw-rw-  2.0 fat     7190 b- defN 24-May-03 11:18 torchrl/data/datasets/openml.py
+-rw-rw-rw-  2.0 fat    33991 b- defN 24-May-03 11:18 torchrl/data/datasets/openx.py
+-rw-rw-rw-  2.0 fat    17017 b- defN 24-May-03 11:18 torchrl/data/datasets/roboset.py
+-rw-rw-rw-  2.0 fat      312 b- defN 24-May-03 11:18 torchrl/data/datasets/utils.py
+-rw-rw-rw-  2.0 fat    18687 b- defN 24-May-03 11:18 torchrl/data/datasets/vd4rl.py
+-rw-rw-rw-  2.0 fat      219 b- defN 24-May-03 11:18 torchrl/data/postprocs/__init__.py
+-rw-rw-rw-  2.0 fat    11627 b- defN 24-May-03 11:18 torchrl/data/postprocs/postprocs.py
+-rw-rw-rw-  2.0 fat      953 b- defN 24-May-03 11:18 torchrl/data/replay_buffers/__init__.py
+-rw-rw-rw-  2.0 fat    76136 b- defN 24-May-03 11:18 torchrl/data/replay_buffers/replay_buffers.py
+-rw-rw-rw-  2.0 fat    87065 b- defN 24-May-03 11:18 torchrl/data/replay_buffers/samplers.py
+-rw-rw-rw-  2.0 fat    58160 b- defN 24-May-03 11:18 torchrl/data/replay_buffers/storages.py
+-rw-rw-rw-  2.0 fat     2954 b- defN 24-May-03 11:18 torchrl/data/replay_buffers/utils.py
+-rw-rw-rw-  2.0 fat    24261 b- defN 24-May-03 11:18 torchrl/data/replay_buffers/writers.py
+-rw-rw-rw-  2.0 fat      508 b- defN 24-May-03 11:18 torchrl/data/rlhf/__init__.py
+-rw-rw-rw-  2.0 fat    20989 b- defN 24-May-03 11:18 torchrl/data/rlhf/dataset.py
+-rw-rw-rw-  2.0 fat     8617 b- defN 24-May-03 11:18 torchrl/data/rlhf/prompt.py
+-rw-rw-rw-  2.0 fat     8668 b- defN 24-May-03 11:18 torchrl/data/rlhf/reward.py
+-rw-rw-rw-  2.0 fat    24134 b- defN 24-May-03 11:18 torchrl/data/rlhf/utils.py
+-rw-rw-rw-  2.0 fat     2482 b- defN 24-May-03 11:18 torchrl/envs/__init__.py
+-rw-rw-rw-  2.0 fat    85060 b- defN 24-May-03 11:18 torchrl/envs/batched_envs.py
+-rw-rw-rw-  2.0 fat   134853 b- defN 24-May-03 11:18 torchrl/envs/common.py
+-rw-rw-rw-  2.0 fat     7661 b- defN 24-May-03 11:18 torchrl/envs/env_creator.py
+-rw-rw-rw-  2.0 fat    23228 b- defN 24-May-03 11:18 torchrl/envs/gym_like.py
+-rw-rw-rw-  2.0 fat    68344 b- defN 24-May-03 11:18 torchrl/envs/utils.py
+-rw-rw-rw-  2.0 fat      339 b- defN 24-May-03 11:18 torchrl/envs/vec_envs.py
+-rw-rw-rw-  2.0 fat      874 b- defN 24-May-03 11:18 torchrl/envs/libs/__init__.py
+-rw-rw-rw-  2.0 fat    10400 b- defN 24-May-03 11:18 torchrl/envs/libs/_gym_utils.py
+-rw-rw-rw-  2.0 fat    24078 b- defN 24-May-03 11:18 torchrl/envs/libs/brax.py
+-rw-rw-rw-  2.0 fat    20968 b- defN 24-May-03 11:18 torchrl/envs/libs/dm_control.py
+-rw-rw-rw-  2.0 fat    16723 b- defN 24-May-03 11:18 torchrl/envs/libs/envpool.py
+-rw-rw-rw-  2.0 fat    64005 b- defN 24-May-03 11:18 torchrl/envs/libs/gym.py
+-rw-rw-rw-  2.0 fat     5437 b- defN 24-May-03 11:18 torchrl/envs/libs/habitat.py
+-rw-rw-rw-  2.0 fat     6954 b- defN 24-May-03 11:18 torchrl/envs/libs/isaacgym.py
+-rw-rw-rw-  2.0 fat     5333 b- defN 24-May-03 11:18 torchrl/envs/libs/jax_utils.py
+-rw-rw-rw-  2.0 fat    38178 b- defN 24-May-03 11:18 torchrl/envs/libs/jumanji.py
+-rw-rw-rw-  2.0 fat    26778 b- defN 24-May-03 11:18 torchrl/envs/libs/meltingpot.py
+-rw-rw-rw-  2.0 fat     6019 b- defN 24-May-03 11:18 torchrl/envs/libs/openml.py
+-rw-rw-rw-  2.0 fat    47103 b- defN 24-May-03 11:18 torchrl/envs/libs/pettingzoo.py
+-rw-rw-rw-  2.0 fat    16194 b- defN 24-May-03 11:18 torchrl/envs/libs/robohive.py
+-rw-rw-rw-  2.0 fat    29939 b- defN 24-May-03 11:18 torchrl/envs/libs/smacv2.py
+-rw-rw-rw-  2.0 fat     5316 b- defN 24-May-03 11:18 torchrl/envs/libs/utils.py
+-rw-rw-rw-  2.0 fat    36083 b- defN 24-May-03 11:18 torchrl/envs/libs/vmas.py
+-rw-rw-rw-  2.0 fat      273 b- defN 24-May-03 11:18 torchrl/envs/model_based/__init__.py
+-rw-rw-rw-  2.0 fat     7907 b- defN 24-May-03 11:18 torchrl/envs/model_based/common.py
+-rw-rw-rw-  2.0 fat     3487 b- defN 24-May-03 11:18 torchrl/envs/model_based/dreamer.py
+-rw-rw-rw-  2.0 fat     1473 b- defN 24-May-03 11:18 torchrl/envs/transforms/__init__.py
+-rw-rw-rw-  2.0 fat     1485 b- defN 24-May-03 11:18 torchrl/envs/transforms/functional.py
+-rw-rw-rw-  2.0 fat    10062 b- defN 24-May-03 11:18 torchrl/envs/transforms/gym_transforms.py
+-rw-rw-rw-  2.0 fat    13933 b- defN 24-May-03 11:18 torchrl/envs/transforms/r3m.py
+-rw-rw-rw-  2.0 fat     7684 b- defN 24-May-03 11:18 torchrl/envs/transforms/rb_transforms.py
+-rw-rw-rw-  2.0 fat    10085 b- defN 24-May-03 11:18 torchrl/envs/transforms/rlhf.py
+-rw-rw-rw-  2.0 fat   344561 b- defN 24-May-03 11:18 torchrl/envs/transforms/transforms.py
+-rw-rw-rw-  2.0 fat     2094 b- defN 24-May-03 11:18 torchrl/envs/transforms/utils.py
+-rw-rw-rw-  2.0 fat    10883 b- defN 24-May-03 11:18 torchrl/envs/transforms/vc1.py
+-rw-rw-rw-  2.0 fat    15290 b- defN 24-May-03 11:18 torchrl/envs/transforms/vip.py
+-rw-rw-rw-  2.0 fat     1903 b- defN 24-May-03 11:18 torchrl/modules/__init__.py
+-rw-rw-rw-  2.0 fat      681 b- defN 24-May-03 11:18 torchrl/modules/distributions/__init__.py
+-rw-rw-rw-  2.0 fat    21427 b- defN 24-May-03 11:18 torchrl/modules/distributions/continuous.py
+-rw-rw-rw-  2.0 fat    17803 b- defN 24-May-03 11:18 torchrl/modules/distributions/discrete.py
+-rw-rw-rw-  2.0 fat     6123 b- defN 24-May-03 11:18 torchrl/modules/distributions/truncated_normal.py
+-rw-rw-rw-  2.0 fat     6115 b- defN 24-May-03 11:18 torchrl/modules/distributions/utils.py
+-rw-rw-rw-  2.0 fat      884 b- defN 24-May-03 11:18 torchrl/modules/models/__init__.py
+-rw-rw-rw-  2.0 fat     6727 b- defN 24-May-03 11:18 torchrl/modules/models/decision_transformer.py
+-rw-rw-rw-  2.0 fat    21920 b- defN 24-May-03 11:18 torchrl/modules/models/exploration.py
+-rw-rw-rw-  2.0 fat    14291 b- defN 24-May-03 11:18 torchrl/modules/models/model_based.py
+-rw-rw-rw-  2.0 fat    66963 b- defN 24-May-03 11:18 torchrl/modules/models/models.py
+-rw-rw-rw-  2.0 fat    37131 b- defN 24-May-03 11:18 torchrl/modules/models/multiagent.py
+-rw-rw-rw-  2.0 fat     6520 b- defN 24-May-03 11:18 torchrl/modules/models/rlhf.py
+-rw-rw-rw-  2.0 fat     5221 b- defN 24-May-03 11:18 torchrl/modules/models/utils.py
+-rw-rw-rw-  2.0 fat      281 b- defN 24-May-03 11:18 torchrl/modules/planners/__init__.py
+-rw-rw-rw-  2.0 fat     9784 b- defN 24-May-03 11:18 torchrl/modules/planners/cem.py
+-rw-rw-rw-  2.0 fat     2451 b- defN 24-May-03 11:18 torchrl/modules/planners/common.py
+-rw-rw-rw-  2.0 fat    11047 b- defN 24-May-03 11:18 torchrl/modules/planners/mppi.py
+-rw-rw-rw-  2.0 fat     1056 b- defN 24-May-03 11:18 torchrl/modules/tensordict_module/__init__.py
+-rw-rw-rw-  2.0 fat   105738 b- defN 24-May-03 11:18 torchrl/modules/tensordict_module/actors.py
+-rw-rw-rw-  2.0 fat    21933 b- defN 24-May-03 11:18 torchrl/modules/tensordict_module/common.py
+-rw-rw-rw-  2.0 fat    30492 b- defN 24-May-03 11:18 torchrl/modules/tensordict_module/exploration.py
+-rw-rw-rw-  2.0 fat    12045 b- defN 24-May-03 11:18 torchrl/modules/tensordict_module/probabilistic.py
+-rw-rw-rw-  2.0 fat    58835 b- defN 24-May-03 11:18 torchrl/modules/tensordict_module/rnn.py
+-rw-rw-rw-  2.0 fat     5804 b- defN 24-May-03 11:18 torchrl/modules/tensordict_module/sequence.py
+-rw-rw-rw-  2.0 fat     1360 b- defN 24-May-03 11:18 torchrl/modules/tensordict_module/world_models.py
+-rw-rw-rw-  2.0 fat     1090 b- defN 24-May-03 11:18 torchrl/modules/utils/__init__.py
+-rw-rw-rw-  2.0 fat     2435 b- defN 24-May-03 11:18 torchrl/modules/utils/mappings.py
+-rw-rw-rw-  2.0 fat     2502 b- defN 24-May-03 11:18 torchrl/modules/utils/utils.py
+-rw-rw-rw-  2.0 fat     1047 b- defN 24-May-03 11:18 torchrl/objectives/__init__.py
+-rw-rw-rw-  2.0 fat    24632 b- defN 24-May-03 11:18 torchrl/objectives/a2c.py
+-rw-rw-rw-  2.0 fat    20884 b- defN 24-May-03 11:18 torchrl/objectives/common.py
+-rw-rw-rw-  2.0 fat    54065 b- defN 24-May-03 11:18 torchrl/objectives/cql.py
+-rw-rw-rw-  2.0 fat    17508 b- defN 24-May-03 11:18 torchrl/objectives/ddpg.py
+-rw-rw-rw-  2.0 fat    12966 b- defN 24-May-03 11:18 torchrl/objectives/decision_transformer.py
+-rw-rw-rw-  2.0 fat    19566 b- defN 24-May-03 11:18 torchrl/objectives/deprecated.py
+-rw-rw-rw-  2.0 fat    28607 b- defN 24-May-03 11:18 torchrl/objectives/dqn.py
+-rw-rw-rw-  2.0 fat    18156 b- defN 24-May-03 11:18 torchrl/objectives/dreamer.py
+-rw-rw-rw-  2.0 fat     2155 b- defN 24-May-03 11:18 torchrl/objectives/functional.py
+-rw-rw-rw-  2.0 fat    39898 b- defN 24-May-03 11:18 torchrl/objectives/iql.py
+-rw-rw-rw-  2.0 fat    52507 b- defN 24-May-03 11:18 torchrl/objectives/ppo.py
+-rw-rw-rw-  2.0 fat    27412 b- defN 24-May-03 11:18 torchrl/objectives/redq.py
+-rw-rw-rw-  2.0 fat    21844 b- defN 24-May-03 11:18 torchrl/objectives/reinforce.py
+-rw-rw-rw-  2.0 fat    57467 b- defN 24-May-03 11:18 torchrl/objectives/sac.py
+-rw-rw-rw-  2.0 fat    22231 b- defN 24-May-03 11:18 torchrl/objectives/td3.py
+-rw-rw-rw-  2.0 fat    19336 b- defN 24-May-03 11:18 torchrl/objectives/utils.py
+-rw-rw-rw-  2.0 fat      217 b- defN 24-May-03 11:18 torchrl/objectives/multiagent/__init__.py
+-rw-rw-rw-  2.0 fat    17456 b- defN 24-May-03 11:18 torchrl/objectives/multiagent/qmixer.py
+-rw-rw-rw-  2.0 fat      384 b- defN 24-May-03 11:18 torchrl/objectives/value/__init__.py
+-rw-rw-rw-  2.0 fat    77377 b- defN 24-May-03 11:18 torchrl/objectives/value/advantages.py
+-rw-rw-rw-  2.0 fat    50043 b- defN 24-May-03 11:18 torchrl/objectives/value/functional.py
+-rw-rw-rw-  2.0 fat      317 b- defN 24-May-03 11:18 torchrl/objectives/value/pg.py
+-rw-rw-rw-  2.0 fat    13444 b- defN 24-May-03 11:18 torchrl/objectives/value/utils.py
+-rw-rw-rw-  2.0 fat      342 b- defN 24-May-03 11:18 torchrl/record/__init__.py
+-rw-rw-rw-  2.0 fat    22236 b- defN 24-May-03 11:18 torchrl/record/recorder.py
+-rw-rw-rw-  2.0 fat      405 b- defN 24-May-03 11:18 torchrl/record/loggers/__init__.py
+-rw-rw-rw-  2.0 fat     1182 b- defN 24-May-03 11:18 torchrl/record/loggers/common.py
+-rw-rw-rw-  2.0 fat     8232 b- defN 24-May-03 11:18 torchrl/record/loggers/csv.py
+-rw-rw-rw-  2.0 fat     4835 b- defN 24-May-03 11:18 torchrl/record/loggers/mlflow.py
+-rw-rw-rw-  2.0 fat     4944 b- defN 24-May-03 11:18 torchrl/record/loggers/tensorboard.py
+-rw-rw-rw-  2.0 fat     2398 b- defN 24-May-03 11:18 torchrl/record/loggers/utils.py
+-rw-rw-rw-  2.0 fat     7974 b- defN 24-May-03 11:18 torchrl/record/loggers/wandb.py
+-rw-rw-rw-  2.0 fat      467 b- defN 24-May-03 11:18 torchrl/trainers/__init__.py
+-rw-rw-rw-  2.0 fat    51838 b- defN 24-May-03 11:18 torchrl/trainers/trainers.py
+-rw-rw-rw-  2.0 fat      701 b- defN 24-May-03 11:18 torchrl/trainers/helpers/__init__.py
+-rw-rw-rw-  2.0 fat    19326 b- defN 24-May-03 11:18 torchrl/trainers/helpers/collectors.py
+-rw-rw-rw-  2.0 fat    22336 b- defN 24-May-03 11:18 torchrl/trainers/helpers/envs.py
+-rw-rw-rw-  2.0 fat     1275 b- defN 24-May-03 11:18 torchrl/trainers/helpers/logger.py
+-rw-rw-rw-  2.0 fat     5389 b- defN 24-May-03 11:18 torchrl/trainers/helpers/losses.py
+-rw-rw-rw-  2.0 fat    22664 b- defN 24-May-03 11:18 torchrl/trainers/helpers/models.py
+-rw-rw-rw-  2.0 fat     1985 b- defN 24-May-03 11:18 torchrl/trainers/helpers/replay_buffer.py
+-rw-rw-rw-  2.0 fat    12385 b- defN 24-May-03 11:18 torchrl/trainers/helpers/trainers.py
+-rw-rw-rw-  2.0 fat     1119 b- defN 24-May-03 11:21 torchrl_nightly-2024.5.3.dist-info/LICENSE
+-rw-rw-rw-  2.0 fat    32621 b- defN 24-May-03 11:21 torchrl_nightly-2024.5.3.dist-info/METADATA
+-rw-rw-rw-  2.0 fat      100 b- defN 24-May-03 11:21 torchrl_nightly-2024.5.3.dist-info/WHEEL
+-rw-rw-rw-  2.0 fat       20 b- defN 24-May-03 11:21 torchrl_nightly-2024.5.3.dist-info/top_level.txt
+-rw-rw-r--  2.0 fat    14369 b- defN 24-May-03 11:21 torchrl_nightly-2024.5.3.dist-info/RECORD
+160 files, 3850304 bytes uncompressed, 882087 bytes compressed:  77.1%
```

## zipnote {}

```diff
@@ -459,23 +459,23 @@
 
 Filename: torchrl/trainers/helpers/replay_buffer.py
 Comment: 
 
 Filename: torchrl/trainers/helpers/trainers.py
 Comment: 
 
-Filename: torchrl_nightly-2024.5.2.dist-info/LICENSE
+Filename: torchrl_nightly-2024.5.3.dist-info/LICENSE
 Comment: 
 
-Filename: torchrl_nightly-2024.5.2.dist-info/METADATA
+Filename: torchrl_nightly-2024.5.3.dist-info/METADATA
 Comment: 
 
-Filename: torchrl_nightly-2024.5.2.dist-info/WHEEL
+Filename: torchrl_nightly-2024.5.3.dist-info/WHEEL
 Comment: 
 
-Filename: torchrl_nightly-2024.5.2.dist-info/top_level.txt
+Filename: torchrl_nightly-2024.5.3.dist-info/top_level.txt
 Comment: 
 
-Filename: torchrl_nightly-2024.5.2.dist-info/RECORD
+Filename: torchrl_nightly-2024.5.3.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## torchrl/version.py

```diff
@@ -1,2 +1,2 @@
-__version__ = '2024.5.2'
-git_version = '7109a3f16f0792ab89f2d6ca736376078c73dd33'
+__version__ = '2024.5.3'
+git_version = '7348af330c466bcd6ab092b9ef1cc7f3e9631475'
```

## torchrl/envs/gym_like.py

```diff
@@ -45,14 +45,16 @@
         keys (list of keys, optional): If provided, the list of keys to get from
             the info dictionary. Defaults to all keys.
         spec (List[TensorSpec], Dict[str, TensorSpec] or CompositeSpec, optional):
             If a list of specs is provided, each spec will be matched to its
             correspondent key to form a :class:`torchrl.data.CompositeSpec`.
             If not provided, a composite spec with :class:`~torchrl.data.UnboundedContinuousTensorSpec`
             specs will lazyly be created.
+        ignore_private (bool, optional): If ``True``, private infos (starting with
+            an underscore) will be ignored. Defaults to ``True``.
 
     In cases where keys can be directly written to a tensordict (mostly if they abide to the
     tensordict shape), one simply needs to indicate the keys to be registered during
     instantiation.
 
     Examples:
         >>> from torchrl.envs.libs.gym import GymWrapper
@@ -70,15 +72,17 @@
     def __init__(
         self,
         keys: List[str] | None = None,
         spec: Sequence[TensorSpec]
         | Dict[str, TensorSpec]
         | CompositeSpec
         | None = None,
+        ignore_private: bool = True,
     ):
+        self.ignore_private = ignore_private
         self._lazy = False
         if keys is None:
             self._lazy = True
         self.keys = keys
 
         if spec is None and keys is None:
             _info_spec = None
@@ -109,24 +113,37 @@
             warnings.warn(
                 f"Found an info_dict of type {type(info_dict)} "
                 f"but expected type or subtype `dict`."
             )
         keys = self.keys
         if keys is None:
             keys = info_dict.keys()
+            if self.ignore_private:
+                keys = [key for key in keys if not key.startswith("_")]
             self.keys = keys
+        # create an info_spec only if there is none
         info_spec = None if self.info_spec is not None else CompositeSpec()
         for key in keys:
             if key in info_dict:
-                tensordict.set(key, info_dict[key])
+                if info_dict[key].dtype == np.dtype("O"):
+                    val = np.stack(info_dict[key])
+                else:
+                    val = info_dict[key]
+                tensordict.set(key, val)
                 if info_spec is not None:
                     val = tensordict.get(key)
                     info_spec[key] = UnboundedContinuousTensorSpec(
                         val.shape, device=val.device, dtype=val.dtype
                     )
+            elif self.info_spec is not None:
+                # Fill missing with 0s
+                tensordict.set(key, self.info_spec[key].zero())
+            else:
+                raise KeyError(f"The key {key} could not be found or inferred.")
+        # set the info spec if there wasn't any - this should occur only once in this class
         if info_spec is not None:
             if tensordict.device is not None:
                 info_spec = info_spec.to(tensordict.device)
             self._info_spec = info_spec
         return tensordict
 
     def reset(self):
@@ -418,28 +435,32 @@
         ...
 
     @abc.abstractmethod
     def _reset_output_transform(self, reset_outputs_tuple: Tuple) -> Tuple:
         ...
 
     def set_info_dict_reader(
-        self, info_dict_reader: BaseInfoDictReader | None = None
+        self,
+        info_dict_reader: BaseInfoDictReader | None = None,
+        ignore_private: bool = True,
     ) -> GymLikeEnv:
         """Sets an info_dict_reader function.
 
         This function should take as input an
         info_dict dictionary and the tensordict returned by the step function, and
         write values in an ad-hoc manner from one to the other.
 
         Args:
             info_dict_reader (Callable[[Dict], TensorDict], optional): a callable
                 taking a input dictionary and output tensordict as arguments.
                 This function should modify the tensordict in-place. If none is
                 provided, :class:`~torchrl.envs.gym_like.default_info_dict_reader`
                 will be used.
+            ignore_private (bool, optional): If ``True``, private infos (starting with
+                an underscore) will be ignored. Defaults to ``True``.
 
         Returns: the same environment with the dict_reader registered.
 
         .. note::
           Automatically registering an info_dict reader should be done via
           :meth:`~.auto_register_info_dict`, which will ensure that the env
           specs are properly constructed.
@@ -452,15 +473,15 @@
             >>> env = GymWrapper(gym.make("some_env-v0")).set_info_dict_reader(info_dict_reader=reader)
             >>> tensordict = env.reset()
             >>> tensordict = env.rand_step(tensordict)
             >>> assert "my_info_key" in tensordict.keys()
 
         """
         if info_dict_reader is None:
-            info_dict_reader = default_info_dict_reader()
+            info_dict_reader = default_info_dict_reader(ignore_private=ignore_private)
         self.info_dict_reader.append(info_dict_reader)
         if isinstance(info_dict_reader, BaseInfoDictReader):
             # if we have a BaseInfoDictReader, we know what the specs will be
             # In other cases (eg, RoboHive) we will need to figure it out empirically.
             if (
                 isinstance(info_dict_reader, default_info_dict_reader)
                 and info_dict_reader.info_spec is None
@@ -477,38 +498,42 @@
                 self.reset()
 
             for info_key, spec in info_dict_reader.info_spec.items():
                 self.observation_spec[info_key] = spec.to(self.device)
 
         return self
 
-    def auto_register_info_dict(self):
+    def auto_register_info_dict(self, ignore_private: bool = True):
         """Automatically registers the info dict.
 
         It is assumed that all the information contained in the info dict can be registered as numerical values
         within the tensordict.
 
         This method returns a (possibly transformed) environment where we make sure that
         the :func:`torchrl.envs.utils.check_env_specs` succeeds, whether
         the info is filled at reset time.
 
         This method requires running a few iterations in the environment to
         manually check that the behaviour matches expectations.
 
+        Args:
+            ignore_private (bool, optional): If ``True``, private infos (starting with
+                an underscore) will be ignored. Defaults to ``True``.
+
         Examples:
             >>> from torchrl.envs import GymEnv
             >>> env = GymEnv("HalfCheetah-v4")
             >>> env.register_info_dict()
             >>> env.rollout(3)
         """
         from torchrl.envs import check_env_specs, TensorDictPrimer, TransformedEnv
 
         if self.info_dict_reader:
             raise RuntimeError("The environment already has an info-dict reader.")
-        self.set_info_dict_reader()
+        self.set_info_dict_reader(ignore_private=ignore_private)
         try:
             check_env_specs(self)
             return self
         except (AssertionError, RuntimeError) as err:
             patterns = [
                 "The keys of the specs and data do not match",
                 "The sets of keys in the tensordicts to stack are exclusive",
```

## torchrl/envs/libs/gym.py

```diff
@@ -572,14 +572,17 @@
                         "This implies that the next-observation is wrongly tracked (as the batched environment auto-resets "
                         "and discards the true next observation to return the result of the step). "
                         "This isn't compatible with TorchRL API and should be used with caution.",
                         category=UserWarning,
                     )
                     add_info_dict = False
             if add_info_dict:
+                # First register the basic info dict reader
+                instance.auto_register_info_dict()
+                # Make it so that infos are properly cast where they should at done time
                 instance.set_info_dict_reader(
                     terminal_obs_reader(instance.observation_spec, backend=backend)
                 )
             return TransformedEnv(instance, VecGymEnvTransform())
         return instance
 
 
@@ -1490,20 +1493,23 @@
 
     """
 
     backend_key = {
         "sb3": "terminal_observation",
         "gym": "final_observation",
     }
+    backend_info_key = {
+        "sb3": "terminal_info",
+        "gym": "final_info",
+    }
 
     def __init__(self, observation_spec: CompositeSpec, backend, name="final"):
         self.name = name
         self._info_spec = CompositeSpec(
-            {(self.name, key): item.clone() for key, item in observation_spec.items()},
-            shape=observation_spec.shape,
+            {name: observation_spec.clone()}, shape=observation_spec.shape
         )
         self.backend = backend
 
     @property
     def info_spec(self):
         return self._info_spec
 
@@ -1535,22 +1541,42 @@
         else:
             raise NotImplementedError(
                 f"Observations of type {type(obs)} are not supported yet."
             )
 
     def __call__(self, info_dict, tensordict):
         terminal_obs = info_dict.get(self.backend_key[self.backend], None)
-        for key, item in self.info_spec.items(True, True):
-            key = (key,) if isinstance(key, str) else key
-            final_obs_buffer = item.zero()
+        terminal_info = info_dict.get(self.backend_info_key[self.backend], None)
+        if terminal_info is not None:
+            # terminal_info is a list of items that can be None or not
+            # If they're not None, they are a dict of values that we want to put in a root dict
+            keys = set()
+            for info in terminal_info:
+                if info is None:
+                    continue
+                keys = keys.union(info.keys())
+            terminal_info = {
+                key: [info[key] if info is not None else info for info in terminal_info]
+                for key in keys
+            }
+        else:
+            terminal_info = {}
+        obs_dict = terminal_info.copy()
+        if terminal_obs is not None:
+            obs_dict["observation"] = terminal_obs
+        for key, terminal_obs in obs_dict.items():
+            spec = self.info_spec[self.name, key]
+            # for key, item in self.info_spec.items(True, True):
+            #     key = (key,) if isinstance(key, str) else key
+            final_obs_buffer = spec.zero()
             if terminal_obs is not None:
                 for i, obs in enumerate(terminal_obs):
                     # writes final_obs inplace with terminal_obs content
-                    self._read_obs(obs, key[-1], final_obs_buffer, index=i)
-            tensordict.set(key, final_obs_buffer)
+                    self._read_obs(obs, key, final_obs_buffer, index=i)
+            tensordict.set((self.name, key), final_obs_buffer)
         return tensordict
 
 
 def _flip_info_tuple(info: Tuple[Dict]) -> Dict[str, tuple]:
     # In Gym < 0.24, batched envs returned tuples of dict, and not dict of tuples.
     # We patch this by flipping the tuple -> dict order.
     info_example = set(info[0])
```

## torchrl/envs/transforms/transforms.py

```diff
@@ -11569,9926 +11569,9968 @@
 0002d300: 5f73 7465 7028 7464 290d 0a20 2020 2020  _step(td)..     
 0002d310: 2020 203e 3e3e 2070 7269 6e74 2874 642e     >>> print(td.
 0002d320: 6765 7428 2822 6e65 7874 222c 2022 6d79  get(("next", "my
 0002d330: 6b65 7922 2929 290d 0a20 2020 2020 2020  key")))..       
 0002d340: 2074 656e 736f 7228 5b5b 312e 2c20 312e   tensor([[1., 1.
 0002d350: 2c20 312e 5d2c 0d0a 2020 2020 2020 2020  , 1.],..        
 0002d360: 2020 2020 2020 2020 5b31 2e2c 2031 2e2c          [1., 1.,
-0002d370: 2031 2e5d 5d29 0d0a 0d0a 2020 2020 2222   1.]])....    ""
-0002d380: 220d 0a0d 0a20 2020 2064 6566 205f 5f69  "....    def __i
-0002d390: 6e69 745f 5f28 0d0a 2020 2020 2020 2020  nit__(..        
-0002d3a0: 7365 6c66 2c0d 0a20 2020 2020 2020 2070  self,..        p
-0002d3b0: 7269 6d65 7273 3a20 6469 6374 207c 2043  rimers: dict | C
-0002d3c0: 6f6d 706f 7369 7465 5370 6563 203d 204e  ompositeSpec = N
-0002d3d0: 6f6e 652c 0d0a 2020 2020 2020 2020 7261  one,..        ra
-0002d3e0: 6e64 6f6d 3a20 626f 6f6c 207c 204e 6f6e  ndom: bool | Non
-0002d3f0: 6520 3d20 4e6f 6e65 2c0d 0a20 2020 2020  e = None,..     
-0002d400: 2020 2064 6566 6175 6c74 5f76 616c 7565     default_value
-0002d410: 3a20 666c 6f61 740d 0a20 2020 2020 2020  : float..       
-0002d420: 207c 2043 616c 6c61 626c 650d 0a20 2020   | Callable..   
-0002d430: 2020 2020 207c 2044 6963 745b 4e65 7374       | Dict[Nest
-0002d440: 6564 4b65 792c 2066 6c6f 6174 5d0d 0a20  edKey, float].. 
-0002d450: 2020 2020 2020 207c 2044 6963 745b 4e65         | Dict[Ne
-0002d460: 7374 6564 4b65 792c 2043 616c 6c61 626c  stedKey, Callabl
-0002d470: 655d 203d 204e 6f6e 652c 0d0a 2020 2020  e] = None,..    
-0002d480: 2020 2020 7265 7365 745f 6b65 793a 204e      reset_key: N
-0002d490: 6573 7465 644b 6579 207c 204e 6f6e 6520  estedKey | None 
-0002d4a0: 3d20 4e6f 6e65 2c0d 0a20 2020 2020 2020  = None,..       
-0002d4b0: 202a 2a6b 7761 7267 732c 0d0a 2020 2020   **kwargs,..    
-0002d4c0: 293a 0d0a 2020 2020 2020 2020 7365 6c66  ):..        self
-0002d4d0: 2e64 6576 6963 6520 3d20 6b77 6172 6773  .device = kwargs
-0002d4e0: 2e70 6f70 2822 6465 7669 6365 222c 204e  .pop("device", N
-0002d4f0: 6f6e 6529 0d0a 2020 2020 2020 2020 6966  one)..        if
-0002d500: 2070 7269 6d65 7273 2069 7320 6e6f 7420   primers is not 
-0002d510: 4e6f 6e65 3a0d 0a20 2020 2020 2020 2020  None:..         
-0002d520: 2020 2069 6620 6b77 6172 6773 3a0d 0a20     if kwargs:.. 
-0002d530: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0002d540: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
-0002d550: 7228 0d0a 2020 2020 2020 2020 2020 2020  r(..            
-0002d560: 2020 2020 2020 2020 2270 726f 7669 6469          "providi
-0002d570: 6e67 2074 6865 2070 7269 6d65 7273 2061  ng the primers a
-0002d580: 7320 6120 6469 6374 696f 6e61 7279 2069  s a dictionary i
-0002d590: 7320 696e 636f 6d70 6174 6962 6c65 2077  s incompatible w
-0002d5a0: 6974 6820 6578 7472 6120 6b65 7973 2070  ith extra keys p
-0002d5b0: 726f 7669 6465 6420 220d 0a20 2020 2020  rovided "..     
-0002d5c0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0002d5d0: 6173 206b 7761 7267 732e 220d 0a20 2020  as kwargs."..   
-0002d5e0: 2020 2020 2020 2020 2020 2020 2029 0d0a               )..
-0002d5f0: 2020 2020 2020 2020 2020 2020 6b77 6172              kwar
-0002d600: 6773 203d 2070 7269 6d65 7273 0d0a 2020  gs = primers..  
-0002d610: 2020 2020 2020 6966 206e 6f74 2069 7369        if not isi
-0002d620: 6e73 7461 6e63 6528 6b77 6172 6773 2c20  nstance(kwargs, 
-0002d630: 436f 6d70 6f73 6974 6553 7065 6329 3a0d  CompositeSpec):.
-0002d640: 0a20 2020 2020 2020 2020 2020 206b 7761  .            kwa
-0002d650: 7267 7320 3d20 436f 6d70 6f73 6974 6553  rgs = CompositeS
-0002d660: 7065 6328 6b77 6172 6773 290d 0a20 2020  pec(kwargs)..   
-0002d670: 2020 2020 2073 656c 662e 7072 696d 6572       self.primer
-0002d680: 7320 3d20 6b77 6172 6773 0d0a 2020 2020  s = kwargs..    
-0002d690: 2020 2020 6966 2072 616e 646f 6d20 616e      if random an
-0002d6a0: 6420 6465 6661 756c 745f 7661 6c75 653a  d default_value:
-0002d6b0: 0d0a 2020 2020 2020 2020 2020 2020 7261  ..            ra
-0002d6c0: 6973 6520 5661 6c75 6545 7272 6f72 280d  ise ValueError(.
-0002d6d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d6e0: 2022 5365 7474 696e 6720 7261 6e64 6f6d   "Setting random
-0002d6f0: 2074 6f20 5472 7565 2061 6e64 2070 726f   to True and pro
-0002d700: 7669 6469 6e67 2061 2064 6566 6175 6c74  viding a default
-0002d710: 5f76 616c 7565 2061 7265 2069 6e63 6f6d  _value are incom
-0002d720: 7061 7469 626c 652e 220d 0a20 2020 2020  patible."..     
-0002d730: 2020 2020 2020 2029 0d0a 2020 2020 2020         )..      
-0002d740: 2020 6465 6661 756c 745f 7661 6c75 6520    default_value 
-0002d750: 3d20 280d 0a20 2020 2020 2020 2020 2020  = (..           
-0002d760: 2064 6566 6175 6c74 5f76 616c 7565 206f   default_value o
-0002d770: 7220 302e 300d 0a20 2020 2020 2020 2029  r 0.0..        )
-0002d780: 2020 2320 6966 206e 6f74 2072 616e 646f    # if not rando
-0002d790: 6d20 616e 6420 6e6f 2064 6566 6175 6c74  m and no default
-0002d7a0: 2076 616c 7565 2c20 7573 6520 302e 300d   value, use 0.0.
-0002d7b0: 0a20 2020 2020 2020 2073 656c 662e 7261  .        self.ra
-0002d7c0: 6e64 6f6d 203d 2072 616e 646f 6d0d 0a20  ndom = random.. 
-0002d7d0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-0002d7e0: 616e 6365 2864 6566 6175 6c74 5f76 616c  ance(default_val
-0002d7f0: 7565 2c20 6469 6374 293a 0d0a 2020 2020  ue, dict):..    
-0002d800: 2020 2020 2020 2020 6465 6661 756c 745f          default_
-0002d810: 7661 6c75 6520 3d20 5465 6e73 6f72 4469  value = TensorDi
-0002d820: 6374 2864 6566 6175 6c74 5f76 616c 7565  ct(default_value
-0002d830: 2c20 5b5d 290d 0a20 2020 2020 2020 2020  , [])..         
-0002d840: 2020 2064 6566 6175 6c74 5f76 616c 7565     default_value
-0002d850: 5f6b 6579 7320 3d20 6465 6661 756c 745f  _keys = default_
-0002d860: 7661 6c75 652e 6b65 7973 280d 0a20 2020  value.keys(..   
-0002d870: 2020 2020 2020 2020 2020 2020 2054 7275               Tru
-0002d880: 652c 0d0a 2020 2020 2020 2020 2020 2020  e,..            
-0002d890: 2020 2020 5472 7565 2c0d 0a20 2020 2020      True,..     
-0002d8a0: 2020 2020 2020 2020 2020 2069 735f 6c65             is_le
-0002d8b0: 6166 3d6c 616d 6264 6120 783a 2069 7373  af=lambda x: iss
-0002d8c0: 7562 636c 6173 7328 782c 2028 4e6f 6e54  ubclass(x, (NonT
-0002d8d0: 656e 736f 7244 6174 612c 2074 6f72 6368  ensorData, torch
-0002d8e0: 2e54 656e 736f 7229 292c 0d0a 2020 2020  .Tensor)),..    
-0002d8f0: 2020 2020 2020 2020 290d 0a20 2020 2020          )..     
-0002d900: 2020 2020 2020 2069 6620 7365 7428 6465         if set(de
-0002d910: 6661 756c 745f 7661 6c75 655f 6b65 7973  fault_value_keys
-0002d920: 2920 213d 2073 6574 2873 656c 662e 7072  ) != set(self.pr
-0002d930: 696d 6572 732e 6b65 7973 2854 7275 652c  imers.keys(True,
-0002d940: 2054 7275 6529 293a 0d0a 2020 2020 2020   True)):..      
-0002d950: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0002d960: 5661 6c75 6545 7272 6f72 280d 0a20 2020  ValueError(..   
-0002d970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d980: 2022 4966 2061 2064 6566 6175 6c74 5f76   "If a default_v
-0002d990: 616c 7565 2064 6963 7469 6f6e 6172 7920  alue dictionary 
-0002d9a0: 6973 2070 726f 7669 6465 642c 2069 7420  is provided, it 
-0002d9b0: 6d75 7374 206d 6174 6368 2074 6865 2070  must match the p
-0002d9c0: 7269 6d65 7273 206b 6579 732e 220d 0a20  rimers keys.".. 
-0002d9d0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0002d9e0: 0d0a 2020 2020 2020 2020 656c 7365 3a0d  ..        else:.
-0002d9f0: 0a20 2020 2020 2020 2020 2020 2064 6566  .            def
-0002da00: 6175 6c74 5f76 616c 7565 203d 207b 0d0a  ault_value = {..
-0002da10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002da20: 6b65 793a 2064 6566 6175 6c74 5f76 616c  key: default_val
-0002da30: 7565 2066 6f72 206b 6579 2069 6e20 7365  ue for key in se
-0002da40: 6c66 2e70 7269 6d65 7273 2e6b 6579 7328  lf.primers.keys(
-0002da50: 5472 7565 2c20 5472 7565 290d 0a20 2020  True, True)..   
-0002da60: 2020 2020 2020 2020 207d 0d0a 2020 2020           }..    
-0002da70: 2020 2020 7365 6c66 2e64 6566 6175 6c74      self.default
-0002da80: 5f76 616c 7565 203d 2064 6566 6175 6c74  _value = default
-0002da90: 5f76 616c 7565 0d0a 2020 2020 2020 2020  _value..        
-0002daa0: 7365 6c66 2e5f 7661 6c69 6461 7465 6420  self._validated 
-0002dab0: 3d20 4661 6c73 650d 0a20 2020 2020 2020  = False..       
-0002dac0: 2073 656c 662e 7265 7365 745f 6b65 7920   self.reset_key 
-0002dad0: 3d20 7265 7365 745f 6b65 790d 0a0d 0a20  = reset_key.... 
-0002dae0: 2020 2020 2020 2023 2073 616e 6974 7920         # sanity 
-0002daf0: 6368 6563 6b0d 0a20 2020 2020 2020 2066  check..        f
-0002db00: 6f72 2073 7065 6320 696e 2073 656c 662e  or spec in self.
-0002db10: 7072 696d 6572 732e 7661 6c75 6573 2829  primers.values()
-0002db20: 3a0d 0a20 2020 2020 2020 2020 2020 2069  :..            i
-0002db30: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
-0002db40: 2873 7065 632c 2054 656e 736f 7253 7065  (spec, TensorSpe
-0002db50: 6329 3a0d 0a20 2020 2020 2020 2020 2020  c):..           
-0002db60: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-0002db70: 4572 726f 7228 0d0a 2020 2020 2020 2020  Error(..        
-0002db80: 2020 2020 2020 2020 2020 2020 2254 6865              "The
-0002db90: 2076 616c 7565 7320 6f66 2074 6865 2070   values of the p
-0002dba0: 7269 6d65 7273 206d 7573 7420 6265 2061  rimers must be a
-0002dbb0: 2073 7562 7479 7065 206f 6620 7468 6520   subtype of the 
-0002dbc0: 5465 6e73 6f72 5370 6563 2063 6c61 7373  TensorSpec class
-0002dbd0: 2e20 220d 0a20 2020 2020 2020 2020 2020  . "..           
-0002dbe0: 2020 2020 2020 2020 2066 2247 6f74 207b           f"Got {
-0002dbf0: 7479 7065 2873 7065 6329 7d20 696e 7374  type(spec)} inst
-0002dc00: 6561 642e 220d 0a20 2020 2020 2020 2020  ead."..         
-0002dc10: 2020 2020 2020 2029 0d0a 2020 2020 2020         )..      
-0002dc20: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
-0002dc30: 5f5f 2829 0d0a 0d0a 2020 2020 4070 726f  __()....    @pro
-0002dc40: 7065 7274 790d 0a20 2020 2064 6566 2072  perty..    def r
-0002dc50: 6573 6574 5f6b 6579 2873 656c 6629 3a0d  eset_key(self):.
-0002dc60: 0a20 2020 2020 2020 2072 6573 6574 5f6b  .        reset_k
-0002dc70: 6579 203d 2073 656c 662e 5f5f 6469 6374  ey = self.__dict
-0002dc80: 5f5f 2e67 6574 2822 5f72 6573 6574 5f6b  __.get("_reset_k
-0002dc90: 6579 222c 204e 6f6e 6529 0d0a 2020 2020  ey", None)..    
-0002dca0: 2020 2020 6966 2072 6573 6574 5f6b 6579      if reset_key
-0002dcb0: 2069 7320 4e6f 6e65 3a0d 0a20 2020 2020   is None:..     
-0002dcc0: 2020 2020 2020 2072 6573 6574 5f6b 6579         reset_key
-0002dcd0: 7320 3d20 7365 6c66 2e70 6172 656e 742e  s = self.parent.
-0002dce0: 7265 7365 745f 6b65 7973 0d0a 2020 2020  reset_keys..    
-0002dcf0: 2020 2020 2020 2020 6966 206c 656e 2872          if len(r
-0002dd00: 6573 6574 5f6b 6579 7329 203e 2031 3a0d  eset_keys) > 1:.
-0002dd10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002dd20: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
-0002dd30: 726f 7228 0d0a 2020 2020 2020 2020 2020  ror(..          
-0002dd40: 2020 2020 2020 2020 2020 6622 476f 7420            f"Got 
-0002dd50: 6d6f 7265 2074 6861 6e20 6f6e 6520 7265  more than one re
-0002dd60: 7365 7420 6b65 7920 696e 2065 6e76 207b  set key in env {
-0002dd70: 7365 6c66 2e63 6f6e 7461 696e 6572 7d2c  self.container},
-0002dd80: 2063 616e 6e6f 7420 696e 6665 7220 7768   cannot infer wh
-0002dd90: 6963 6820 6f6e 6520 746f 2075 7365 2e20  ich one to use. 
-0002dda0: 436f 6e73 6964 6572 2070 726f 7669 6469  Consider providi
-0002ddb0: 6e67 2074 6865 2072 6573 6574 206b 6579  ng the reset key
-0002ddc0: 2069 6e20 7468 6520 7b74 7970 6528 7365   in the {type(se
-0002ddd0: 6c66 297d 2063 6f6e 7374 7275 6374 6f72  lf)} constructor
-0002dde0: 2e22 0d0a 2020 2020 2020 2020 2020 2020  ."..            
-0002ddf0: 2020 2020 290d 0a20 2020 2020 2020 2020      )..         
-0002de00: 2020 2072 6573 6574 5f6b 6579 203d 2073     reset_key = s
-0002de10: 656c 662e 5f72 6573 6574 5f6b 6579 203d  elf._reset_key =
-0002de20: 2072 6573 6574 5f6b 6579 735b 305d 0d0a   reset_keys[0]..
-0002de30: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-0002de40: 6573 6574 5f6b 6579 0d0a 0d0a 2020 2020  eset_key....    
-0002de50: 4072 6573 6574 5f6b 6579 2e73 6574 7465  @reset_key.sette
-0002de60: 720d 0a20 2020 2064 6566 2072 6573 6574  r..    def reset
-0002de70: 5f6b 6579 2873 656c 662c 2076 616c 7565  _key(self, value
-0002de80: 293a 0d0a 2020 2020 2020 2020 7365 6c66  ):..        self
-0002de90: 2e5f 7265 7365 745f 6b65 7920 3d20 7661  ._reset_key = va
-0002dea0: 6c75 650d 0a0d 0a20 2020 2040 7072 6f70  lue....    @prop
-0002deb0: 6572 7479 0d0a 2020 2020 6465 6620 6465  erty..    def de
-0002dec0: 7669 6365 2873 656c 6629 3a0d 0a20 2020  vice(self):..   
-0002ded0: 2020 2020 2064 6576 6963 6520 3d20 7365       device = se
-0002dee0: 6c66 2e5f 6465 7669 6365 0d0a 2020 2020  lf._device..    
-0002def0: 2020 2020 6966 2064 6576 6963 6520 6973      if device is
-0002df00: 204e 6f6e 6520 616e 6420 7365 6c66 2e70   None and self.p
-0002df10: 6172 656e 7420 6973 206e 6f74 204e 6f6e  arent is not Non
-0002df20: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
-0002df30: 6465 7669 6365 203d 2073 656c 662e 7061  device = self.pa
-0002df40: 7265 6e74 2e64 6576 6963 650d 0a20 2020  rent.device..   
-0002df50: 2020 2020 2020 2020 2073 656c 662e 5f64           self._d
-0002df60: 6576 6963 6520 3d20 6465 7669 6365 0d0a  evice = device..
-0002df70: 2020 2020 2020 2020 7265 7475 726e 2064          return d
-0002df80: 6576 6963 650d 0a0d 0a20 2020 2040 6465  evice....    @de
-0002df90: 7669 6365 2e73 6574 7465 720d 0a20 2020  vice.setter..   
-0002dfa0: 2064 6566 2064 6576 6963 6528 7365 6c66   def device(self
-0002dfb0: 2c20 7661 6c75 6529 3a0d 0a20 2020 2020  , value):..     
-0002dfc0: 2020 2069 6620 7661 6c75 6520 6973 204e     if value is N
-0002dfd0: 6f6e 653a 0d0a 2020 2020 2020 2020 2020  one:..          
-0002dfe0: 2020 7365 6c66 2e5f 6465 7669 6365 203d    self._device =
-0002dff0: 204e 6f6e 650d 0a20 2020 2020 2020 2020   None..         
-0002e000: 2020 2072 6574 7572 6e0d 0a20 2020 2020     return..     
-0002e010: 2020 2073 656c 662e 5f64 6576 6963 6520     self._device 
-0002e020: 3d20 746f 7263 682e 6465 7669 6365 2876  = torch.device(v
-0002e030: 616c 7565 290d 0a0d 0a20 2020 2064 6566  alue)....    def
-0002e040: 2074 6f28 7365 6c66 2c20 2a61 7267 732c   to(self, *args,
-0002e050: 202a 2a6b 7761 7267 7329 3a0d 0a20 2020   **kwargs):..   
-0002e060: 2020 2020 2064 6576 6963 652c 2064 7479       device, dty
-0002e070: 7065 2c20 6e6f 6e5f 626c 6f63 6b69 6e67  pe, non_blocking
-0002e080: 2c20 636f 6e76 6572 745f 746f 5f66 6f72  , convert_to_for
-0002e090: 6d61 7420 3d20 746f 7263 682e 5f43 2e5f  mat = torch._C._
-0002e0a0: 6e6e 2e5f 7061 7273 655f 746f 280d 0a20  nn._parse_to(.. 
-0002e0b0: 2020 2020 2020 2020 2020 202a 6172 6773             *args
-0002e0c0: 2c20 2a2a 6b77 6172 6773 0d0a 2020 2020  , **kwargs..    
-0002e0d0: 2020 2020 290d 0a20 2020 2020 2020 2069      )..        i
-0002e0e0: 6620 6465 7669 6365 2069 7320 6e6f 7420  f device is not 
-0002e0f0: 4e6f 6e65 3a0d 0a20 2020 2020 2020 2020  None:..         
-0002e100: 2020 2073 656c 662e 6465 7669 6365 203d     self.device =
-0002e110: 2064 6576 6963 650d 0a20 2020 2020 2020   device..       
-0002e120: 2020 2020 2073 656c 662e 656d 7074 795f       self.empty_
-0002e130: 6361 6368 6528 290d 0a20 2020 2020 2020  cache()..       
-0002e140: 2020 2020 2073 656c 662e 7072 696d 6572       self.primer
-0002e150: 7320 3d20 7365 6c66 2e70 7269 6d65 7273  s = self.primers
-0002e160: 2e74 6f28 6465 7669 6365 290d 0a20 2020  .to(device)..   
-0002e170: 2020 2020 2072 6574 7572 6e20 7375 7065       return supe
-0002e180: 7228 292e 746f 282a 6172 6773 2c20 2a2a  r().to(*args, **
-0002e190: 6b77 6172 6773 290d 0a0d 0a20 2020 2064  kwargs)....    d
-0002e1a0: 6566 205f 6578 7061 6e64 5f73 6861 7065  ef _expand_shape
-0002e1b0: 2873 656c 662c 2073 7065 6329 3a0d 0a20  (self, spec):.. 
-0002e1c0: 2020 2020 2020 2072 6574 7572 6e20 7370         return sp
-0002e1d0: 6563 2e65 7870 616e 6428 282a 7365 6c66  ec.expand((*self
-0002e1e0: 2e70 6172 656e 742e 6261 7463 685f 7369  .parent.batch_si
-0002e1f0: 7a65 2c20 2a73 7065 632e 7368 6170 6529  ze, *spec.shape)
-0002e200: 290d 0a0d 0a20 2020 2064 6566 2074 7261  )....    def tra
-0002e210: 6e73 666f 726d 5f6f 6273 6572 7661 7469  nsform_observati
-0002e220: 6f6e 5f73 7065 6328 0d0a 2020 2020 2020  on_spec(..      
-0002e230: 2020 7365 6c66 2c20 6f62 7365 7276 6174    self, observat
-0002e240: 696f 6e5f 7370 6563 3a20 436f 6d70 6f73  ion_spec: Compos
-0002e250: 6974 6553 7065 630d 0a20 2020 2029 202d  iteSpec..    ) -
-0002e260: 3e20 436f 6d70 6f73 6974 6553 7065 633a  > CompositeSpec:
-0002e270: 0d0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-0002e280: 2069 7369 6e73 7461 6e63 6528 6f62 7365   isinstance(obse
-0002e290: 7276 6174 696f 6e5f 7370 6563 2c20 436f  rvation_spec, Co
-0002e2a0: 6d70 6f73 6974 6553 7065 6329 3a0d 0a20  mpositeSpec):.. 
-0002e2b0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0002e2c0: 2056 616c 7565 4572 726f 7228 0d0a 2020   ValueError(..  
-0002e2d0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0002e2e0: 6f62 7365 7276 6174 696f 6e5f 7370 6563  observation_spec
-0002e2f0: 2077 6173 2065 7870 6563 7465 6420 746f   was expected to
-0002e300: 2062 6520 6f66 2074 7970 6520 436f 6d70   be of type Comp
-0002e310: 6f73 6974 6553 7065 632e 2047 6f74 207b  ositeSpec. Got {
-0002e320: 7479 7065 286f 6273 6572 7661 7469 6f6e  type(observation
-0002e330: 5f73 7065 6329 7d20 696e 7374 6561 642e  _spec)} instead.
-0002e340: 220d 0a20 2020 2020 2020 2020 2020 2029  "..            )
-0002e350: 0d0a 2020 2020 2020 2020 666f 7220 6b65  ..        for ke
-0002e360: 792c 2073 7065 6320 696e 2073 656c 662e  y, spec in self.
-0002e370: 7072 696d 6572 732e 6974 656d 7328 293a  primers.items():
-0002e380: 0d0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-0002e390: 2073 7065 632e 7368 6170 655b 3a20 6c65   spec.shape[: le
-0002e3a0: 6e28 6f62 7365 7276 6174 696f 6e5f 7370  n(observation_sp
-0002e3b0: 6563 2e73 6861 7065 295d 2021 3d20 6f62  ec.shape)] != ob
-0002e3c0: 7365 7276 6174 696f 6e5f 7370 6563 2e73  servation_spec.s
-0002e3d0: 6861 7065 3a0d 0a20 2020 2020 2020 2020  hape:..         
-0002e3e0: 2020 2020 2020 2065 7870 616e 6465 645f         expanded_
-0002e3f0: 7370 6563 203d 2073 656c 662e 5f65 7870  spec = self._exp
-0002e400: 616e 645f 7368 6170 6528 7370 6563 290d  and_shape(spec).
-0002e410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e420: 2073 7065 6320 3d20 6578 7061 6e64 6564   spec = expanded
-0002e430: 5f73 7065 630d 0a20 2020 2020 2020 2020  _spec..         
-0002e440: 2020 2074 7279 3a0d 0a20 2020 2020 2020     try:..       
-0002e450: 2020 2020 2020 2020 2064 6576 6963 6520           device 
-0002e460: 3d20 6f62 7365 7276 6174 696f 6e5f 7370  = observation_sp
-0002e470: 6563 2e64 6576 6963 650d 0a20 2020 2020  ec.device..     
-0002e480: 2020 2020 2020 2065 7863 6570 7420 5275         except Ru
-0002e490: 6e74 696d 6545 7272 6f72 3a0d 0a20 2020  ntimeError:..   
-0002e4a0: 2020 2020 2020 2020 2020 2020 2064 6576               dev
-0002e4b0: 6963 6520 3d20 7365 6c66 2e64 6576 6963  ice = self.devic
-0002e4c0: 650d 0a20 2020 2020 2020 2020 2020 206f  e..            o
-0002e4d0: 6273 6572 7661 7469 6f6e 5f73 7065 635b  bservation_spec[
-0002e4e0: 6b65 795d 203d 2073 656c 662e 7072 696d  key] = self.prim
-0002e4f0: 6572 735b 6b65 795d 203d 2073 7065 632e  ers[key] = spec.
-0002e500: 746f 2864 6576 6963 6529 0d0a 2020 2020  to(device)..    
-0002e510: 2020 2020 7265 7475 726e 206f 6273 6572      return obser
-0002e520: 7661 7469 6f6e 5f73 7065 630d 0a0d 0a20  vation_spec.... 
-0002e530: 2020 2064 6566 2074 7261 6e73 666f 726d     def transform
-0002e540: 5f69 6e70 7574 5f73 7065 6328 7365 6c66  _input_spec(self
-0002e550: 2c20 696e 7075 745f 7370 6563 3a20 5465  , input_spec: Te
-0002e560: 6e73 6f72 5370 6563 2920 2d3e 2054 656e  nsorSpec) -> Ten
-0002e570: 736f 7253 7065 633a 0d0a 2020 2020 2020  sorSpec:..      
-0002e580: 2020 696e 7075 745f 7370 6563 5b22 6675    input_spec["fu
-0002e590: 6c6c 5f73 7461 7465 5f73 7065 6322 5d20  ll_state_spec"] 
-0002e5a0: 3d20 7365 6c66 2e74 7261 6e73 666f 726d  = self.transform
-0002e5b0: 5f6f 6273 6572 7661 7469 6f6e 5f73 7065  _observation_spe
-0002e5c0: 6328 0d0a 2020 2020 2020 2020 2020 2020  c(..            
-0002e5d0: 696e 7075 745f 7370 6563 5b22 6675 6c6c  input_spec["full
-0002e5e0: 5f73 7461 7465 5f73 7065 6322 5d0d 0a20  _state_spec"].. 
-0002e5f0: 2020 2020 2020 2029 0d0a 2020 2020 2020         )..      
-0002e600: 2020 7265 7475 726e 2069 6e70 7574 5f73    return input_s
-0002e610: 7065 630d 0a0d 0a20 2020 2040 7072 6f70  pec....    @prop
-0002e620: 6572 7479 0d0a 2020 2020 6465 6620 5f62  erty..    def _b
-0002e630: 6174 6368 5f73 697a 6528 7365 6c66 293a  atch_size(self):
-0002e640: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-0002e650: 2073 656c 662e 7061 7265 6e74 2e62 6174   self.parent.bat
-0002e660: 6368 5f73 697a 650d 0a0d 0a20 2020 2064  ch_size....    d
-0002e670: 6566 205f 7661 6c69 6461 7465 5f76 616c  ef _validate_val
-0002e680: 7565 5f74 656e 736f 7228 7365 6c66 2c20  ue_tensor(self, 
-0002e690: 7661 6c75 652c 2073 7065 6329 3a0d 0a20  value, spec):.. 
-0002e6a0: 2020 2020 2020 2069 6620 6e6f 7420 7370         if not sp
-0002e6b0: 6563 2e69 735f 696e 2876 616c 7565 293a  ec.is_in(value):
-0002e6c0: 0d0a 2020 2020 2020 2020 2020 2020 7261  ..            ra
-0002e6d0: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
-0002e6e0: 2866 2256 616c 7565 2028 7b76 616c 7565  (f"Value ({value
-0002e6f0: 7d29 2069 7320 6e6f 7420 696e 2074 6865  }) is not in the
-0002e700: 2073 7065 6320 646f 6d61 696e 2028 7b73   spec domain ({s
-0002e710: 7065 637d 292e 2229 0d0a 2020 2020 2020  pec}).")..      
-0002e720: 2020 7265 7475 726e 2054 7275 650d 0a0d    return True...
-0002e730: 0a20 2020 2064 6566 2066 6f72 7761 7264  .    def forward
-0002e740: 2873 656c 662c 2074 656e 736f 7264 6963  (self, tensordic
-0002e750: 743a 2054 656e 736f 7244 6963 7442 6173  t: TensorDictBas
-0002e760: 6529 202d 3e20 5465 6e73 6f72 4469 6374  e) -> TensorDict
-0002e770: 4261 7365 3a0d 0a20 2020 2020 2020 2066  Base:..        f
-0002e780: 6f72 206b 6579 2c20 7370 6563 2069 6e20  or key, spec in 
-0002e790: 7365 6c66 2e70 7269 6d65 7273 2e69 7465  self.primers.ite
-0002e7a0: 6d73 2854 7275 652c 2054 7275 6529 3a0d  ms(True, True):.
-0002e7b0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002e7c0: 7370 6563 2e73 6861 7065 5b3a 206c 656e  spec.shape[: len
-0002e7d0: 2874 656e 736f 7264 6963 742e 7368 6170  (tensordict.shap
-0002e7e0: 6529 5d20 213d 2074 656e 736f 7264 6963  e)] != tensordic
-0002e7f0: 742e 7368 6170 653a 0d0a 2020 2020 2020  t.shape:..      
-0002e800: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0002e810: 5275 6e74 696d 6545 7272 6f72 280d 0a20  RuntimeError(.. 
-0002e820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e830: 2020 2022 5468 6520 6c65 6164 696e 6720     "The leading 
-0002e840: 7368 6170 6520 6f66 2074 6865 2073 7065  shape of the spe
-0002e850: 6320 6d75 7374 206d 6174 6368 2074 6865  c must match the
-0002e860: 2074 656e 736f 7264 6963 7427 732c 2022   tensordict's, "
-0002e870: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0002e880: 2020 2020 2020 2262 7574 2069 7420 646f        "but it do
-0002e890: 6573 206e 6f74 3a20 676f 7420 220d 0a20  es not: got ".. 
-0002e8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e8b0: 2020 2066 2274 656e 736f 7264 6963 742e     f"tensordict.
-0002e8c0: 7368 6170 653d 7b74 656e 736f 7264 6963  shape={tensordic
-0002e8d0: 742e 7368 6170 657d 2077 6865 7265 6173  t.shape} whereas
-0002e8e0: 207b 6b65 797d 2073 7065 6327 7320 7368   {key} spec's sh
-0002e8f0: 6170 6520 6973 2022 0d0a 2020 2020 2020  ape is "..      
-0002e900: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0002e910: 7b73 7065 632e 7368 6170 657d 2e22 0d0a  {spec.shape}."..
-0002e920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e930: 290d 0a20 2020 2020 2020 2020 2020 2069  )..            i
-0002e940: 6620 7365 6c66 2e72 616e 646f 6d3a 0d0a  f self.random:..
-0002e950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e960: 7661 6c75 6520 3d20 7370 6563 2e72 616e  value = spec.ran
-0002e970: 6428 290d 0a20 2020 2020 2020 2020 2020  d()..           
-0002e980: 2065 6c73 653a 0d0a 2020 2020 2020 2020   else:..        
-0002e990: 2020 2020 2020 2020 7661 6c75 6520 3d20          value = 
-0002e9a0: 7365 6c66 2e64 6566 6175 6c74 5f76 616c  self.default_val
-0002e9b0: 7565 5b6b 6579 5d0d 0a20 2020 2020 2020  ue[key]..       
-0002e9c0: 2020 2020 2020 2020 2069 6620 6361 6c6c           if call
-0002e9d0: 6162 6c65 2876 616c 7565 293a 0d0a 2020  able(value):..  
-0002e9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e9f0: 2020 7661 6c75 6520 3d20 7661 6c75 6528    value = value(
-0002ea00: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
-0002ea10: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
-0002ea20: 6c66 2e5f 7661 6c69 6461 7465 643a 0d0a  lf._validated:..
-0002ea30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ea40: 2020 2020 2020 2020 7365 6c66 2e5f 7661          self._va
-0002ea50: 6c69 6461 7465 5f76 616c 7565 5f74 656e  lidate_value_ten
-0002ea60: 736f 7228 7661 6c75 652c 2073 7065 6329  sor(value, spec)
-0002ea70: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0002ea80: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
-0002ea90: 2020 2020 2020 2020 2020 2020 2076 616c               val
-0002eaa0: 7565 203d 2074 6f72 6368 2e66 756c 6c28  ue = torch.full(
-0002eab0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0002eac0: 2020 2020 2020 2020 2020 7370 6563 2e73            spec.s
-0002ead0: 6861 7065 2c0d 0a20 2020 2020 2020 2020  hape,..         
-0002eae0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-0002eaf0: 616c 7565 2c0d 0a20 2020 2020 2020 2020  alue,..         
-0002eb00: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0002eb10: 6576 6963 653d 7370 6563 2e64 6576 6963  evice=spec.devic
-0002eb20: 652c 0d0a 2020 2020 2020 2020 2020 2020  e,..            
-0002eb30: 2020 2020 2020 2020 290d 0a0d 0a20 2020          )....   
-0002eb40: 2020 2020 2020 2020 2074 656e 736f 7264           tensord
-0002eb50: 6963 742e 7365 7428 6b65 792c 2076 616c  ict.set(key, val
-0002eb60: 7565 290d 0a20 2020 2020 2020 2069 6620  ue)..        if 
-0002eb70: 6e6f 7420 7365 6c66 2e5f 7661 6c69 6461  not self._valida
-0002eb80: 7465 643a 0d0a 2020 2020 2020 2020 2020  ted:..          
-0002eb90: 2020 7365 6c66 2e5f 7661 6c69 6461 7465    self._validate
-0002eba0: 6420 3d20 5472 7565 0d0a 2020 2020 2020  d = True..      
-0002ebb0: 2020 7265 7475 726e 2074 656e 736f 7264    return tensord
-0002ebc0: 6963 740d 0a0d 0a20 2020 2064 6566 205f  ict....    def _
-0002ebd0: 7374 6570 280d 0a20 2020 2020 2020 2073  step(..        s
-0002ebe0: 656c 662c 2074 656e 736f 7264 6963 743a  elf, tensordict:
-0002ebf0: 2054 656e 736f 7244 6963 7442 6173 652c   TensorDictBase,
-0002ec00: 206e 6578 745f 7465 6e73 6f72 6469 6374   next_tensordict
-0002ec10: 3a20 5465 6e73 6f72 4469 6374 4261 7365  : TensorDictBase
-0002ec20: 0d0a 2020 2020 2920 2d3e 2054 656e 736f  ..    ) -> Tenso
-0002ec30: 7244 6963 7442 6173 653a 0d0a 2020 2020  rDictBase:..    
-0002ec40: 2020 2020 666f 7220 6b65 7920 696e 2073      for key in s
-0002ec50: 656c 662e 7072 696d 6572 732e 6b65 7973  elf.primers.keys
-0002ec60: 2829 3a0d 0a20 2020 2020 2020 2020 2020  ():..           
-0002ec70: 2069 6620 6b65 7920 6e6f 7420 696e 206e   if key not in n
-0002ec80: 6578 745f 7465 6e73 6f72 6469 6374 2e6b  ext_tensordict.k
-0002ec90: 6579 7328 5472 7565 293a 0d0a 2020 2020  eys(True):..    
-0002eca0: 2020 2020 2020 2020 2020 2020 7072 6576              prev
-0002ecb0: 5f76 616c 203d 2074 656e 736f 7264 6963  _val = tensordic
-0002ecc0: 742e 6765 7428 6b65 7929 0d0a 2020 2020  t.get(key)..    
-0002ecd0: 2020 2020 2020 2020 2020 2020 6e65 7874              next
-0002ece0: 5f74 656e 736f 7264 6963 742e 7365 7428  _tensordict.set(
-0002ecf0: 6b65 792c 2070 7265 765f 7661 6c29 0d0a  key, prev_val)..
-0002ed00: 2020 2020 2020 2020 7265 7475 726e 206e          return n
-0002ed10: 6578 745f 7465 6e73 6f72 6469 6374 0d0a  ext_tensordict..
-0002ed20: 0d0a 2020 2020 6465 6620 5f72 6573 6574  ..    def _reset
-0002ed30: 280d 0a20 2020 2020 2020 2073 656c 662c  (..        self,
-0002ed40: 2074 656e 736f 7264 6963 743a 2054 656e   tensordict: Ten
-0002ed50: 736f 7244 6963 7442 6173 652c 2074 656e  sorDictBase, ten
-0002ed60: 736f 7264 6963 745f 7265 7365 743a 2054  sordict_reset: T
-0002ed70: 656e 736f 7244 6963 7442 6173 650d 0a20  ensorDictBase.. 
-0002ed80: 2020 2029 202d 3e20 5465 6e73 6f72 4469     ) -> TensorDi
-0002ed90: 6374 4261 7365 3a0d 0a20 2020 2020 2020  ctBase:..       
-0002eda0: 2022 2222 5365 7473 2074 6865 2064 6566   """Sets the def
-0002edb0: 6175 6c74 2076 616c 7565 7320 696e 2074  ault values in t
-0002edc0: 6865 2069 6e70 7574 2074 656e 736f 7264  he input tensord
-0002edd0: 6963 742e 0d0a 0d0a 2020 2020 2020 2020  ict.....        
-0002ede0: 4966 2074 6865 2070 6172 656e 7420 6973  If the parent is
-0002edf0: 2062 6174 6368 2d6c 6f63 6b65 642c 2077   batch-locked, w
-0002ee00: 6520 6173 7375 6d65 2074 6861 7420 7468  e assume that th
-0002ee10: 6520 7370 6563 7320 6861 7665 2074 6865  e specs have the
-0002ee20: 2061 7070 726f 7072 6961 7465 206c 6561   appropriate lea
-0002ee30: 6469 6e67 0d0a 2020 2020 2020 2020 7368  ding..        sh
-0002ee40: 6170 652e 2057 6520 616c 6c6f 7720 666f  ape. We allow fo
-0002ee50: 7220 6578 6563 7574 696f 6e20 7768 656e  r execution when
-0002ee60: 2074 6865 2070 6172 656e 7420 6973 206d   the parent is m
-0002ee70: 6973 7369 6e67 2c20 696e 2077 6869 6368  issing, in which
-0002ee80: 2063 6173 6520 7468 650d 0a20 2020 2020   case the..     
-0002ee90: 2020 2073 7065 6320 7368 6170 6520 6973     spec shape is
-0002eea0: 2061 7373 756d 6564 2074 6f20 6d61 7463   assumed to matc
-0002eeb0: 6820 7468 6520 7465 6e73 6f72 6469 6374  h the tensordict
-0002eec0: 2773 2e0d 0a0d 0a20 2020 2020 2020 2022  's.....        "
-0002eed0: 2222 0d0a 2020 2020 2020 2020 7368 6170  ""..        shap
-0002eee0: 6520 3d20 280d 0a20 2020 2020 2020 2020  e = (..         
-0002eef0: 2020 2028 290d 0a20 2020 2020 2020 2020     ()..         
-0002ef00: 2020 2069 6620 286e 6f74 2073 656c 662e     if (not self.
-0002ef10: 7061 7265 6e74 206f 7220 7365 6c66 2e70  parent or self.p
-0002ef20: 6172 656e 742e 6261 7463 685f 6c6f 636b  arent.batch_lock
-0002ef30: 6564 290d 0a20 2020 2020 2020 2020 2020  ed)..           
-0002ef40: 2065 6c73 6520 7465 6e73 6f72 6469 6374   else tensordict
-0002ef50: 2e62 6174 6368 5f73 697a 650d 0a20 2020  .batch_size..   
-0002ef60: 2020 2020 2029 0d0a 2020 2020 2020 2020       )..        
-0002ef70: 5f72 6573 6574 203d 205f 6765 745f 7265  _reset = _get_re
-0002ef80: 7365 7428 7365 6c66 2e72 6573 6574 5f6b  set(self.reset_k
-0002ef90: 6579 2c20 7465 6e73 6f72 6469 6374 290d  ey, tensordict).
-0002efa0: 0a20 2020 2020 2020 2069 6620 5f72 6573  .        if _res
-0002efb0: 6574 2e61 6e79 2829 3a0d 0a20 2020 2020  et.any():..     
-0002efc0: 2020 2020 2020 2066 6f72 206b 6579 2c20         for key, 
-0002efd0: 7370 6563 2069 6e20 7365 6c66 2e70 7269  spec in self.pri
-0002efe0: 6d65 7273 2e69 7465 6d73 2854 7275 652c  mers.items(True,
-0002eff0: 2054 7275 6529 3a0d 0a20 2020 2020 2020   True):..       
-0002f000: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-0002f010: 2e72 616e 646f 6d3a 0d0a 2020 2020 2020  .random:..      
-0002f020: 2020 2020 2020 2020 2020 2020 2020 7661                va
-0002f030: 6c75 6520 3d20 7370 6563 2e72 616e 6428  lue = spec.rand(
-0002f040: 7368 6170 6529 0d0a 2020 2020 2020 2020  shape)..        
-0002f050: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
-0002f060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f070: 2020 2076 616c 7565 203d 2073 656c 662e     value = self.
-0002f080: 6465 6661 756c 745f 7661 6c75 655b 6b65  default_value[ke
-0002f090: 795d 0d0a 2020 2020 2020 2020 2020 2020  y]..            
-0002f0a0: 2020 2020 2020 2020 6966 2063 616c 6c61          if calla
-0002f0b0: 626c 6528 7661 6c75 6529 3a0d 0a20 2020  ble(value):..   
-0002f0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f0d0: 2020 2020 2076 616c 7565 203d 2076 616c       value = val
-0002f0e0: 7565 2829 0d0a 2020 2020 2020 2020 2020  ue()..          
-0002f0f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0002f100: 206e 6f74 2073 656c 662e 5f76 616c 6964   not self._valid
-0002f110: 6174 6564 3a0d 0a20 2020 2020 2020 2020  ated:..         
-0002f120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f130: 2020 2073 656c 662e 5f76 616c 6964 6174     self._validat
-0002f140: 655f 7661 6c75 655f 7465 6e73 6f72 2876  e_value_tensor(v
-0002f150: 616c 7565 2c20 7370 6563 290d 0a20 2020  alue, spec)..   
+0002d370: 2031 2e5d 5d29 0d0a 0d0a 2020 2020 2e2e   1.]])....    ..
+0002d380: 206e 6f74 653a 3a20 536f 6d65 2054 6f72   note:: Some Tor
+0002d390: 6368 524c 206d 6f64 756c 6573 2072 656c  chRL modules rel
+0002d3a0: 7920 6f6e 2073 7065 6369 6669 6320 6b65  y on specific ke
+0002d3b0: 7973 2062 6569 6e67 2070 7265 7365 6e74  ys being present
+0002d3c0: 2069 6e20 7468 6520 656e 7669 726f 6e6d   in the environm
+0002d3d0: 656e 7420 5465 6e73 6f72 4469 6374 732c  ent TensorDicts,
+0002d3e0: 0d0a 2020 2020 2020 2020 6c69 6b65 203a  ..        like :
+0002d3f0: 636c 6173 733a 607e 746f 7263 6872 6c2e  class:`~torchrl.
+0002d400: 6d6f 6475 6c65 732e 6d6f 6465 6c73 2e4c  modules.models.L
+0002d410: 5354 4d60 206f 7220 3a63 6c61 7373 3a60  STM` or :class:`
+0002d420: 7e74 6f72 6368 726c 2e6d 6f64 756c 6573  ~torchrl.modules
+0002d430: 2e6d 6f64 656c 732e 4752 5560 2e0d 0a20  .models.GRU`... 
+0002d440: 2020 2020 2020 2054 6f20 6661 6369 6c69         To facili
+0002d450: 7461 7465 2074 6869 7320 7072 6f63 6573  tate this proces
+0002d460: 732c 2074 6865 206d 6574 686f 6420 3a66  s, the method :f
+0002d470: 756e 633a 607e 746f 7263 6872 6c2e 6d6f  unc:`~torchrl.mo
+0002d480: 6465 6c73 2e75 7469 6c73 2e67 6574 5f70  dels.utils.get_p
+0002d490: 7269 6d65 7273 5f66 726f 6d5f 6d6f 6475  rimers_from_modu
+0002d4a0: 6c65 600d 0a20 2020 2020 2020 2061 7574  le`..        aut
+0002d4b0: 6f6d 6174 6963 616c 6c79 2063 6865 636b  omatically check
+0002d4c0: 7320 666f 7220 7265 7175 6972 6564 2070  s for required p
+0002d4d0: 7269 6d65 7220 7472 616e 7366 6f72 6d73  rimer transforms
+0002d4e0: 2069 6e20 6120 6d6f 6475 6c65 2061 6e64   in a module and
+0002d4f0: 2069 7473 2073 7562 6d6f 6475 6c65 7320   its submodules 
+0002d500: 616e 640d 0a20 2020 2020 2020 2067 656e  and..        gen
+0002d510: 6572 6174 6573 2074 6865 6d2e 0d0a 2020  erates them...  
+0002d520: 2020 2222 220d 0a0d 0a20 2020 2064 6566    """....    def
+0002d530: 205f 5f69 6e69 745f 5f28 0d0a 2020 2020   __init__(..    
+0002d540: 2020 2020 7365 6c66 2c0d 0a20 2020 2020      self,..     
+0002d550: 2020 2070 7269 6d65 7273 3a20 6469 6374     primers: dict
+0002d560: 207c 2043 6f6d 706f 7369 7465 5370 6563   | CompositeSpec
+0002d570: 203d 204e 6f6e 652c 0d0a 2020 2020 2020   = None,..      
+0002d580: 2020 7261 6e64 6f6d 3a20 626f 6f6c 207c    random: bool |
+0002d590: 204e 6f6e 6520 3d20 4e6f 6e65 2c0d 0a20   None = None,.. 
+0002d5a0: 2020 2020 2020 2064 6566 6175 6c74 5f76         default_v
+0002d5b0: 616c 7565 3a20 666c 6f61 740d 0a20 2020  alue: float..   
+0002d5c0: 2020 2020 207c 2043 616c 6c61 626c 650d       | Callable.
+0002d5d0: 0a20 2020 2020 2020 207c 2044 6963 745b  .        | Dict[
+0002d5e0: 4e65 7374 6564 4b65 792c 2066 6c6f 6174  NestedKey, float
+0002d5f0: 5d0d 0a20 2020 2020 2020 207c 2044 6963  ]..        | Dic
+0002d600: 745b 4e65 7374 6564 4b65 792c 2043 616c  t[NestedKey, Cal
+0002d610: 6c61 626c 655d 203d 204e 6f6e 652c 0d0a  lable] = None,..
+0002d620: 2020 2020 2020 2020 7265 7365 745f 6b65          reset_ke
+0002d630: 793a 204e 6573 7465 644b 6579 207c 204e  y: NestedKey | N
+0002d640: 6f6e 6520 3d20 4e6f 6e65 2c0d 0a20 2020  one = None,..   
+0002d650: 2020 2020 202a 2a6b 7761 7267 732c 0d0a       **kwargs,..
+0002d660: 2020 2020 293a 0d0a 2020 2020 2020 2020      ):..        
+0002d670: 7365 6c66 2e64 6576 6963 6520 3d20 6b77  self.device = kw
+0002d680: 6172 6773 2e70 6f70 2822 6465 7669 6365  args.pop("device
+0002d690: 222c 204e 6f6e 6529 0d0a 2020 2020 2020  ", None)..      
+0002d6a0: 2020 6966 2070 7269 6d65 7273 2069 7320    if primers is 
+0002d6b0: 6e6f 7420 4e6f 6e65 3a0d 0a20 2020 2020  not None:..     
+0002d6c0: 2020 2020 2020 2069 6620 6b77 6172 6773         if kwargs
+0002d6d0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+0002d6e0: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
+0002d6f0: 4572 726f 7228 0d0a 2020 2020 2020 2020  Error(..        
+0002d700: 2020 2020 2020 2020 2020 2020 2270 726f              "pro
+0002d710: 7669 6469 6e67 2074 6865 2070 7269 6d65  viding the prime
+0002d720: 7273 2061 7320 6120 6469 6374 696f 6e61  rs as a dictiona
+0002d730: 7279 2069 7320 696e 636f 6d70 6174 6962  ry is incompatib
+0002d740: 6c65 2077 6974 6820 6578 7472 6120 6b65  le with extra ke
+0002d750: 7973 2070 726f 7669 6465 6420 220d 0a20  ys provided ".. 
+0002d760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d770: 2020 2022 6173 206b 7761 7267 732e 220d     "as kwargs.".
+0002d780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d790: 2029 0d0a 2020 2020 2020 2020 2020 2020   )..            
+0002d7a0: 6b77 6172 6773 203d 2070 7269 6d65 7273  kwargs = primers
+0002d7b0: 0d0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+0002d7c0: 2069 7369 6e73 7461 6e63 6528 6b77 6172   isinstance(kwar
+0002d7d0: 6773 2c20 436f 6d70 6f73 6974 6553 7065  gs, CompositeSpe
+0002d7e0: 6329 3a0d 0a20 2020 2020 2020 2020 2020  c):..           
+0002d7f0: 206b 7761 7267 7320 3d20 436f 6d70 6f73   kwargs = Compos
+0002d800: 6974 6553 7065 6328 6b77 6172 6773 290d  iteSpec(kwargs).
+0002d810: 0a20 2020 2020 2020 2073 656c 662e 7072  .        self.pr
+0002d820: 696d 6572 7320 3d20 6b77 6172 6773 0d0a  imers = kwargs..
+0002d830: 2020 2020 2020 2020 6966 2072 616e 646f          if rando
+0002d840: 6d20 616e 6420 6465 6661 756c 745f 7661  m and default_va
+0002d850: 6c75 653a 0d0a 2020 2020 2020 2020 2020  lue:..          
+0002d860: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+0002d870: 6f72 280d 0a20 2020 2020 2020 2020 2020  or(..           
+0002d880: 2020 2020 2022 5365 7474 696e 6720 7261       "Setting ra
+0002d890: 6e64 6f6d 2074 6f20 5472 7565 2061 6e64  ndom to True and
+0002d8a0: 2070 726f 7669 6469 6e67 2061 2064 6566   providing a def
+0002d8b0: 6175 6c74 5f76 616c 7565 2061 7265 2069  ault_value are i
+0002d8c0: 6e63 6f6d 7061 7469 626c 652e 220d 0a20  ncompatible.".. 
+0002d8d0: 2020 2020 2020 2020 2020 2029 0d0a 2020             )..  
+0002d8e0: 2020 2020 2020 6465 6661 756c 745f 7661        default_va
+0002d8f0: 6c75 6520 3d20 280d 0a20 2020 2020 2020  lue = (..       
+0002d900: 2020 2020 2064 6566 6175 6c74 5f76 616c       default_val
+0002d910: 7565 206f 7220 302e 300d 0a20 2020 2020  ue or 0.0..     
+0002d920: 2020 2029 2020 2320 6966 206e 6f74 2072     )  # if not r
+0002d930: 616e 646f 6d20 616e 6420 6e6f 2064 6566  andom and no def
+0002d940: 6175 6c74 2076 616c 7565 2c20 7573 6520  ault value, use 
+0002d950: 302e 300d 0a20 2020 2020 2020 2073 656c  0.0..        sel
+0002d960: 662e 7261 6e64 6f6d 203d 2072 616e 646f  f.random = rando
+0002d970: 6d0d 0a20 2020 2020 2020 2069 6620 6973  m..        if is
+0002d980: 696e 7374 616e 6365 2864 6566 6175 6c74  instance(default
+0002d990: 5f76 616c 7565 2c20 6469 6374 293a 0d0a  _value, dict):..
+0002d9a0: 2020 2020 2020 2020 2020 2020 6465 6661              defa
+0002d9b0: 756c 745f 7661 6c75 6520 3d20 5465 6e73  ult_value = Tens
+0002d9c0: 6f72 4469 6374 2864 6566 6175 6c74 5f76  orDict(default_v
+0002d9d0: 616c 7565 2c20 5b5d 290d 0a20 2020 2020  alue, [])..     
+0002d9e0: 2020 2020 2020 2064 6566 6175 6c74 5f76         default_v
+0002d9f0: 616c 7565 5f6b 6579 7320 3d20 6465 6661  alue_keys = defa
+0002da00: 756c 745f 7661 6c75 652e 6b65 7973 280d  ult_value.keys(.
+0002da10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002da20: 2054 7275 652c 0d0a 2020 2020 2020 2020   True,..        
+0002da30: 2020 2020 2020 2020 5472 7565 2c0d 0a20          True,.. 
+0002da40: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0002da50: 735f 6c65 6166 3d6c 616d 6264 6120 783a  s_leaf=lambda x:
+0002da60: 2069 7373 7562 636c 6173 7328 782c 2028   issubclass(x, (
+0002da70: 4e6f 6e54 656e 736f 7244 6174 612c 2074  NonTensorData, t
+0002da80: 6f72 6368 2e54 656e 736f 7229 292c 0d0a  orch.Tensor)),..
+0002da90: 2020 2020 2020 2020 2020 2020 290d 0a20              ).. 
+0002daa0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+0002dab0: 7428 6465 6661 756c 745f 7661 6c75 655f  t(default_value_
+0002dac0: 6b65 7973 2920 213d 2073 6574 2873 656c  keys) != set(sel
+0002dad0: 662e 7072 696d 6572 732e 6b65 7973 2854  f.primers.keys(T
+0002dae0: 7275 652c 2054 7275 6529 293a 0d0a 2020  rue, True)):..  
+0002daf0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0002db00: 6973 6520 5661 6c75 6545 7272 6f72 280d  ise ValueError(.
+0002db10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002db20: 2020 2020 2022 4966 2061 2064 6566 6175       "If a defau
+0002db30: 6c74 5f76 616c 7565 2064 6963 7469 6f6e  lt_value diction
+0002db40: 6172 7920 6973 2070 726f 7669 6465 642c  ary is provided,
+0002db50: 2069 7420 6d75 7374 206d 6174 6368 2074   it must match t
+0002db60: 6865 2070 7269 6d65 7273 206b 6579 732e  he primers keys.
+0002db70: 220d 0a20 2020 2020 2020 2020 2020 2020  "..             
+0002db80: 2020 2029 0d0a 2020 2020 2020 2020 656c     )..        el
+0002db90: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
+0002dba0: 2064 6566 6175 6c74 5f76 616c 7565 203d   default_value =
+0002dbb0: 207b 0d0a 2020 2020 2020 2020 2020 2020   {..            
+0002dbc0: 2020 2020 6b65 793a 2064 6566 6175 6c74      key: default
+0002dbd0: 5f76 616c 7565 2066 6f72 206b 6579 2069  _value for key i
+0002dbe0: 6e20 7365 6c66 2e70 7269 6d65 7273 2e6b  n self.primers.k
+0002dbf0: 6579 7328 5472 7565 2c20 5472 7565 290d  eys(True, True).
+0002dc00: 0a20 2020 2020 2020 2020 2020 207d 0d0a  .            }..
+0002dc10: 2020 2020 2020 2020 7365 6c66 2e64 6566          self.def
+0002dc20: 6175 6c74 5f76 616c 7565 203d 2064 6566  ault_value = def
+0002dc30: 6175 6c74 5f76 616c 7565 0d0a 2020 2020  ault_value..    
+0002dc40: 2020 2020 7365 6c66 2e5f 7661 6c69 6461      self._valida
+0002dc50: 7465 6420 3d20 4661 6c73 650d 0a20 2020  ted = False..   
+0002dc60: 2020 2020 2073 656c 662e 7265 7365 745f       self.reset_
+0002dc70: 6b65 7920 3d20 7265 7365 745f 6b65 790d  key = reset_key.
+0002dc80: 0a0d 0a20 2020 2020 2020 2023 2073 616e  ...        # san
+0002dc90: 6974 7920 6368 6563 6b0d 0a20 2020 2020  ity check..     
+0002dca0: 2020 2066 6f72 2073 7065 6320 696e 2073     for spec in s
+0002dcb0: 656c 662e 7072 696d 6572 732e 7661 6c75  elf.primers.valu
+0002dcc0: 6573 2829 3a0d 0a20 2020 2020 2020 2020  es():..         
+0002dcd0: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
+0002dce0: 616e 6365 2873 7065 632c 2054 656e 736f  ance(spec, Tenso
+0002dcf0: 7253 7065 6329 3a0d 0a20 2020 2020 2020  rSpec):..       
+0002dd00: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+0002dd10: 616c 7565 4572 726f 7228 0d0a 2020 2020  alueError(..    
+0002dd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dd30: 2254 6865 2076 616c 7565 7320 6f66 2074  "The values of t
+0002dd40: 6865 2070 7269 6d65 7273 206d 7573 7420  he primers must 
+0002dd50: 6265 2061 2073 7562 7479 7065 206f 6620  be a subtype of 
+0002dd60: 7468 6520 5465 6e73 6f72 5370 6563 2063  the TensorSpec c
+0002dd70: 6c61 7373 2e20 220d 0a20 2020 2020 2020  lass. "..       
+0002dd80: 2020 2020 2020 2020 2020 2020 2066 2247               f"G
+0002dd90: 6f74 207b 7479 7065 2873 7065 6329 7d20  ot {type(spec)} 
+0002dda0: 696e 7374 6561 642e 220d 0a20 2020 2020  instead."..     
+0002ddb0: 2020 2020 2020 2020 2020 2029 0d0a 2020             )..  
+0002ddc0: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
+0002ddd0: 696e 6974 5f5f 2829 0d0a 0d0a 2020 2020  init__()....    
+0002dde0: 4070 726f 7065 7274 790d 0a20 2020 2064  @property..    d
+0002ddf0: 6566 2072 6573 6574 5f6b 6579 2873 656c  ef reset_key(sel
+0002de00: 6629 3a0d 0a20 2020 2020 2020 2072 6573  f):..        res
+0002de10: 6574 5f6b 6579 203d 2073 656c 662e 5f5f  et_key = self.__
+0002de20: 6469 6374 5f5f 2e67 6574 2822 5f72 6573  dict__.get("_res
+0002de30: 6574 5f6b 6579 222c 204e 6f6e 6529 0d0a  et_key", None)..
+0002de40: 2020 2020 2020 2020 6966 2072 6573 6574          if reset
+0002de50: 5f6b 6579 2069 7320 4e6f 6e65 3a0d 0a20  _key is None:.. 
+0002de60: 2020 2020 2020 2020 2020 2072 6573 6574             reset
+0002de70: 5f6b 6579 7320 3d20 7365 6c66 2e70 6172  _keys = self.par
+0002de80: 656e 742e 7265 7365 745f 6b65 7973 0d0a  ent.reset_keys..
+0002de90: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+0002dea0: 656e 2872 6573 6574 5f6b 6579 7329 203e  en(reset_keys) >
+0002deb0: 2031 3a0d 0a20 2020 2020 2020 2020 2020   1:..           
+0002dec0: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
+0002ded0: 6d65 4572 726f 7228 0d0a 2020 2020 2020  meError(..      
+0002dee0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0002def0: 476f 7420 6d6f 7265 2074 6861 6e20 6f6e  Got more than on
+0002df00: 6520 7265 7365 7420 6b65 7920 696e 2065  e reset key in e
+0002df10: 6e76 207b 7365 6c66 2e63 6f6e 7461 696e  nv {self.contain
+0002df20: 6572 7d2c 2063 616e 6e6f 7420 696e 6665  er}, cannot infe
+0002df30: 7220 7768 6963 6820 6f6e 6520 746f 2075  r which one to u
+0002df40: 7365 2e20 436f 6e73 6964 6572 2070 726f  se. Consider pro
+0002df50: 7669 6469 6e67 2074 6865 2072 6573 6574  viding the reset
+0002df60: 206b 6579 2069 6e20 7468 6520 7b74 7970   key in the {typ
+0002df70: 6528 7365 6c66 297d 2063 6f6e 7374 7275  e(self)} constru
+0002df80: 6374 6f72 2e22 0d0a 2020 2020 2020 2020  ctor."..        
+0002df90: 2020 2020 2020 2020 290d 0a20 2020 2020          )..     
+0002dfa0: 2020 2020 2020 2072 6573 6574 5f6b 6579         reset_key
+0002dfb0: 203d 2073 656c 662e 5f72 6573 6574 5f6b   = self._reset_k
+0002dfc0: 6579 203d 2072 6573 6574 5f6b 6579 735b  ey = reset_keys[
+0002dfd0: 305d 0d0a 2020 2020 2020 2020 7265 7475  0]..        retu
+0002dfe0: 726e 2072 6573 6574 5f6b 6579 0d0a 0d0a  rn reset_key....
+0002dff0: 2020 2020 4072 6573 6574 5f6b 6579 2e73      @reset_key.s
+0002e000: 6574 7465 720d 0a20 2020 2064 6566 2072  etter..    def r
+0002e010: 6573 6574 5f6b 6579 2873 656c 662c 2076  eset_key(self, v
+0002e020: 616c 7565 293a 0d0a 2020 2020 2020 2020  alue):..        
+0002e030: 7365 6c66 2e5f 7265 7365 745f 6b65 7920  self._reset_key 
+0002e040: 3d20 7661 6c75 650d 0a0d 0a20 2020 2040  = value....    @
+0002e050: 7072 6f70 6572 7479 0d0a 2020 2020 6465  property..    de
+0002e060: 6620 6465 7669 6365 2873 656c 6629 3a0d  f device(self):.
+0002e070: 0a20 2020 2020 2020 2064 6576 6963 6520  .        device 
+0002e080: 3d20 7365 6c66 2e5f 6465 7669 6365 0d0a  = self._device..
+0002e090: 2020 2020 2020 2020 6966 2064 6576 6963          if devic
+0002e0a0: 6520 6973 204e 6f6e 6520 616e 6420 7365  e is None and se
+0002e0b0: 6c66 2e70 6172 656e 7420 6973 206e 6f74  lf.parent is not
+0002e0c0: 204e 6f6e 653a 0d0a 2020 2020 2020 2020   None:..        
+0002e0d0: 2020 2020 6465 7669 6365 203d 2073 656c      device = sel
+0002e0e0: 662e 7061 7265 6e74 2e64 6576 6963 650d  f.parent.device.
+0002e0f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0002e100: 662e 5f64 6576 6963 6520 3d20 6465 7669  f._device = devi
+0002e110: 6365 0d0a 2020 2020 2020 2020 7265 7475  ce..        retu
+0002e120: 726e 2064 6576 6963 650d 0a0d 0a20 2020  rn device....   
+0002e130: 2040 6465 7669 6365 2e73 6574 7465 720d   @device.setter.
+0002e140: 0a20 2020 2064 6566 2064 6576 6963 6528  .    def device(
+0002e150: 7365 6c66 2c20 7661 6c75 6529 3a0d 0a20  self, value):.. 
+0002e160: 2020 2020 2020 2069 6620 7661 6c75 6520         if value 
+0002e170: 6973 204e 6f6e 653a 0d0a 2020 2020 2020  is None:..      
+0002e180: 2020 2020 2020 7365 6c66 2e5f 6465 7669        self._devi
+0002e190: 6365 203d 204e 6f6e 650d 0a20 2020 2020  ce = None..     
+0002e1a0: 2020 2020 2020 2072 6574 7572 6e0d 0a20         return.. 
+0002e1b0: 2020 2020 2020 2073 656c 662e 5f64 6576         self._dev
+0002e1c0: 6963 6520 3d20 746f 7263 682e 6465 7669  ice = torch.devi
+0002e1d0: 6365 2876 616c 7565 290d 0a0d 0a20 2020  ce(value)....   
+0002e1e0: 2064 6566 2074 6f28 7365 6c66 2c20 2a61   def to(self, *a
+0002e1f0: 7267 732c 202a 2a6b 7761 7267 7329 3a0d  rgs, **kwargs):.
+0002e200: 0a20 2020 2020 2020 2064 6576 6963 652c  .        device,
+0002e210: 2064 7479 7065 2c20 6e6f 6e5f 626c 6f63   dtype, non_bloc
+0002e220: 6b69 6e67 2c20 636f 6e76 6572 745f 746f  king, convert_to
+0002e230: 5f66 6f72 6d61 7420 3d20 746f 7263 682e  _format = torch.
+0002e240: 5f43 2e5f 6e6e 2e5f 7061 7273 655f 746f  _C._nn._parse_to
+0002e250: 280d 0a20 2020 2020 2020 2020 2020 202a  (..            *
+0002e260: 6172 6773 2c20 2a2a 6b77 6172 6773 0d0a  args, **kwargs..
+0002e270: 2020 2020 2020 2020 290d 0a20 2020 2020          )..     
+0002e280: 2020 2069 6620 6465 7669 6365 2069 7320     if device is 
+0002e290: 6e6f 7420 4e6f 6e65 3a0d 0a20 2020 2020  not None:..     
+0002e2a0: 2020 2020 2020 2073 656c 662e 6465 7669         self.devi
+0002e2b0: 6365 203d 2064 6576 6963 650d 0a20 2020  ce = device..   
+0002e2c0: 2020 2020 2020 2020 2073 656c 662e 656d           self.em
+0002e2d0: 7074 795f 6361 6368 6528 290d 0a20 2020  pty_cache()..   
+0002e2e0: 2020 2020 2020 2020 2073 656c 662e 7072           self.pr
+0002e2f0: 696d 6572 7320 3d20 7365 6c66 2e70 7269  imers = self.pri
+0002e300: 6d65 7273 2e74 6f28 6465 7669 6365 290d  mers.to(device).
+0002e310: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0002e320: 7375 7065 7228 292e 746f 282a 6172 6773  super().to(*args
+0002e330: 2c20 2a2a 6b77 6172 6773 290d 0a0d 0a20  , **kwargs).... 
+0002e340: 2020 2064 6566 205f 6578 7061 6e64 5f73     def _expand_s
+0002e350: 6861 7065 2873 656c 662c 2073 7065 6329  hape(self, spec)
+0002e360: 3a0d 0a20 2020 2020 2020 2072 6574 7572  :..        retur
+0002e370: 6e20 7370 6563 2e65 7870 616e 6428 282a  n spec.expand((*
+0002e380: 7365 6c66 2e70 6172 656e 742e 6261 7463  self.parent.batc
+0002e390: 685f 7369 7a65 2c20 2a73 7065 632e 7368  h_size, *spec.sh
+0002e3a0: 6170 6529 290d 0a0d 0a20 2020 2064 6566  ape))....    def
+0002e3b0: 2074 7261 6e73 666f 726d 5f6f 6273 6572   transform_obser
+0002e3c0: 7661 7469 6f6e 5f73 7065 6328 0d0a 2020  vation_spec(..  
+0002e3d0: 2020 2020 2020 7365 6c66 2c20 6f62 7365        self, obse
+0002e3e0: 7276 6174 696f 6e5f 7370 6563 3a20 436f  rvation_spec: Co
+0002e3f0: 6d70 6f73 6974 6553 7065 630d 0a20 2020  mpositeSpec..   
+0002e400: 2029 202d 3e20 436f 6d70 6f73 6974 6553   ) -> CompositeS
+0002e410: 7065 633a 0d0a 2020 2020 2020 2020 6966  pec:..        if
+0002e420: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+0002e430: 6f62 7365 7276 6174 696f 6e5f 7370 6563  observation_spec
+0002e440: 2c20 436f 6d70 6f73 6974 6553 7065 6329  , CompositeSpec)
+0002e450: 3a0d 0a20 2020 2020 2020 2020 2020 2072  :..            r
+0002e460: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+0002e470: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0002e480: 2020 6622 6f62 7365 7276 6174 696f 6e5f    f"observation_
+0002e490: 7370 6563 2077 6173 2065 7870 6563 7465  spec was expecte
+0002e4a0: 6420 746f 2062 6520 6f66 2074 7970 6520  d to be of type 
+0002e4b0: 436f 6d70 6f73 6974 6553 7065 632e 2047  CompositeSpec. G
+0002e4c0: 6f74 207b 7479 7065 286f 6273 6572 7661  ot {type(observa
+0002e4d0: 7469 6f6e 5f73 7065 6329 7d20 696e 7374  tion_spec)} inst
+0002e4e0: 6561 642e 220d 0a20 2020 2020 2020 2020  ead."..         
+0002e4f0: 2020 2029 0d0a 2020 2020 2020 2020 666f     )..        fo
+0002e500: 7220 6b65 792c 2073 7065 6320 696e 2073  r key, spec in s
+0002e510: 656c 662e 7072 696d 6572 732e 6974 656d  elf.primers.item
+0002e520: 7328 293a 0d0a 2020 2020 2020 2020 2020  s():..          
+0002e530: 2020 6966 2073 7065 632e 7368 6170 655b    if spec.shape[
+0002e540: 3a20 6c65 6e28 6f62 7365 7276 6174 696f  : len(observatio
+0002e550: 6e5f 7370 6563 2e73 6861 7065 295d 2021  n_spec.shape)] !
+0002e560: 3d20 6f62 7365 7276 6174 696f 6e5f 7370  = observation_sp
+0002e570: 6563 2e73 6861 7065 3a0d 0a20 2020 2020  ec.shape:..     
+0002e580: 2020 2020 2020 2020 2020 2065 7870 616e             expan
+0002e590: 6465 645f 7370 6563 203d 2073 656c 662e  ded_spec = self.
+0002e5a0: 5f65 7870 616e 645f 7368 6170 6528 7370  _expand_shape(sp
+0002e5b0: 6563 290d 0a20 2020 2020 2020 2020 2020  ec)..           
+0002e5c0: 2020 2020 2073 7065 6320 3d20 6578 7061       spec = expa
+0002e5d0: 6e64 6564 5f73 7065 630d 0a20 2020 2020  nded_spec..     
+0002e5e0: 2020 2020 2020 2074 7279 3a0d 0a20 2020         try:..   
+0002e5f0: 2020 2020 2020 2020 2020 2020 2064 6576               dev
+0002e600: 6963 6520 3d20 6f62 7365 7276 6174 696f  ice = observatio
+0002e610: 6e5f 7370 6563 2e64 6576 6963 650d 0a20  n_spec.device.. 
+0002e620: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0002e630: 7420 5275 6e74 696d 6545 7272 6f72 3a0d  t RuntimeError:.
+0002e640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e650: 2064 6576 6963 6520 3d20 7365 6c66 2e64   device = self.d
+0002e660: 6576 6963 650d 0a20 2020 2020 2020 2020  evice..         
+0002e670: 2020 206f 6273 6572 7661 7469 6f6e 5f73     observation_s
+0002e680: 7065 635b 6b65 795d 203d 2073 656c 662e  pec[key] = self.
+0002e690: 7072 696d 6572 735b 6b65 795d 203d 2073  primers[key] = s
+0002e6a0: 7065 632e 746f 2864 6576 6963 6529 0d0a  pec.to(device)..
+0002e6b0: 2020 2020 2020 2020 7265 7475 726e 206f          return o
+0002e6c0: 6273 6572 7661 7469 6f6e 5f73 7065 630d  bservation_spec.
+0002e6d0: 0a0d 0a20 2020 2064 6566 2074 7261 6e73  ...    def trans
+0002e6e0: 666f 726d 5f69 6e70 7574 5f73 7065 6328  form_input_spec(
+0002e6f0: 7365 6c66 2c20 696e 7075 745f 7370 6563  self, input_spec
+0002e700: 3a20 5465 6e73 6f72 5370 6563 2920 2d3e  : TensorSpec) ->
+0002e710: 2054 656e 736f 7253 7065 633a 0d0a 2020   TensorSpec:..  
+0002e720: 2020 2020 2020 696e 7075 745f 7370 6563        input_spec
+0002e730: 5b22 6675 6c6c 5f73 7461 7465 5f73 7065  ["full_state_spe
+0002e740: 6322 5d20 3d20 7365 6c66 2e74 7261 6e73  c"] = self.trans
+0002e750: 666f 726d 5f6f 6273 6572 7661 7469 6f6e  form_observation
+0002e760: 5f73 7065 6328 0d0a 2020 2020 2020 2020  _spec(..        
+0002e770: 2020 2020 696e 7075 745f 7370 6563 5b22      input_spec["
+0002e780: 6675 6c6c 5f73 7461 7465 5f73 7065 6322  full_state_spec"
+0002e790: 5d0d 0a20 2020 2020 2020 2029 0d0a 2020  ]..        )..  
+0002e7a0: 2020 2020 2020 7265 7475 726e 2069 6e70        return inp
+0002e7b0: 7574 5f73 7065 630d 0a0d 0a20 2020 2040  ut_spec....    @
+0002e7c0: 7072 6f70 6572 7479 0d0a 2020 2020 6465  property..    de
+0002e7d0: 6620 5f62 6174 6368 5f73 697a 6528 7365  f _batch_size(se
+0002e7e0: 6c66 293a 0d0a 2020 2020 2020 2020 7265  lf):..        re
+0002e7f0: 7475 726e 2073 656c 662e 7061 7265 6e74  turn self.parent
+0002e800: 2e62 6174 6368 5f73 697a 650d 0a0d 0a20  .batch_size.... 
+0002e810: 2020 2064 6566 205f 7661 6c69 6461 7465     def _validate
+0002e820: 5f76 616c 7565 5f74 656e 736f 7228 7365  _value_tensor(se
+0002e830: 6c66 2c20 7661 6c75 652c 2073 7065 6329  lf, value, spec)
+0002e840: 3a0d 0a20 2020 2020 2020 2069 6620 6e6f  :..        if no
+0002e850: 7420 7370 6563 2e69 735f 696e 2876 616c  t spec.is_in(val
+0002e860: 7565 293a 0d0a 2020 2020 2020 2020 2020  ue):..          
+0002e870: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
+0002e880: 7272 6f72 2866 2256 616c 7565 2028 7b76  rror(f"Value ({v
+0002e890: 616c 7565 7d29 2069 7320 6e6f 7420 696e  alue}) is not in
+0002e8a0: 2074 6865 2073 7065 6320 646f 6d61 696e   the spec domain
+0002e8b0: 2028 7b73 7065 637d 292e 2229 0d0a 2020   ({spec}).")..  
+0002e8c0: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
+0002e8d0: 650d 0a0d 0a20 2020 2064 6566 2066 6f72  e....    def for
+0002e8e0: 7761 7264 2873 656c 662c 2074 656e 736f  ward(self, tenso
+0002e8f0: 7264 6963 743a 2054 656e 736f 7244 6963  rdict: TensorDic
+0002e900: 7442 6173 6529 202d 3e20 5465 6e73 6f72  tBase) -> Tensor
+0002e910: 4469 6374 4261 7365 3a0d 0a20 2020 2020  DictBase:..     
+0002e920: 2020 2066 6f72 206b 6579 2c20 7370 6563     for key, spec
+0002e930: 2069 6e20 7365 6c66 2e70 7269 6d65 7273   in self.primers
+0002e940: 2e69 7465 6d73 2854 7275 652c 2054 7275  .items(True, Tru
+0002e950: 6529 3a0d 0a20 2020 2020 2020 2020 2020  e):..           
+0002e960: 2069 6620 7370 6563 2e73 6861 7065 5b3a   if spec.shape[:
+0002e970: 206c 656e 2874 656e 736f 7264 6963 742e   len(tensordict.
+0002e980: 7368 6170 6529 5d20 213d 2074 656e 736f  shape)] != tenso
+0002e990: 7264 6963 742e 7368 6170 653a 0d0a 2020  rdict.shape:..  
+0002e9a0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0002e9b0: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
+0002e9c0: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
+0002e9d0: 2020 2020 2020 2022 5468 6520 6c65 6164         "The lead
+0002e9e0: 696e 6720 7368 6170 6520 6f66 2074 6865  ing shape of the
+0002e9f0: 2073 7065 6320 6d75 7374 206d 6174 6368   spec must match
+0002ea00: 2074 6865 2074 656e 736f 7264 6963 7427   the tensordict'
+0002ea10: 732c 2022 0d0a 2020 2020 2020 2020 2020  s, "..          
+0002ea20: 2020 2020 2020 2020 2020 2262 7574 2069            "but i
+0002ea30: 7420 646f 6573 206e 6f74 3a20 676f 7420  t does not: got 
+0002ea40: 220d 0a20 2020 2020 2020 2020 2020 2020  "..             
+0002ea50: 2020 2020 2020 2066 2274 656e 736f 7264         f"tensord
+0002ea60: 6963 742e 7368 6170 653d 7b74 656e 736f  ict.shape={tenso
+0002ea70: 7264 6963 742e 7368 6170 657d 2077 6865  rdict.shape} whe
+0002ea80: 7265 6173 207b 6b65 797d 2073 7065 6327  reas {key} spec'
+0002ea90: 7320 7368 6170 6520 6973 2022 0d0a 2020  s shape is "..  
+0002eaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eab0: 2020 6622 7b73 7065 632e 7368 6170 657d    f"{spec.shape}
+0002eac0: 2e22 0d0a 2020 2020 2020 2020 2020 2020  ."..            
+0002ead0: 2020 2020 290d 0a20 2020 2020 2020 2020      )..         
+0002eae0: 2020 2069 6620 7365 6c66 2e72 616e 646f     if self.rando
+0002eaf0: 6d3a 0d0a 2020 2020 2020 2020 2020 2020  m:..            
+0002eb00: 2020 2020 7661 6c75 6520 3d20 7370 6563      value = spec
+0002eb10: 2e72 616e 6428 290d 0a20 2020 2020 2020  .rand()..       
+0002eb20: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
+0002eb30: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
+0002eb40: 6520 3d20 7365 6c66 2e64 6566 6175 6c74  e = self.default
+0002eb50: 5f76 616c 7565 5b6b 6579 5d0d 0a20 2020  _value[key]..   
+0002eb60: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0002eb70: 6361 6c6c 6162 6c65 2876 616c 7565 293a  callable(value):
+0002eb80: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0002eb90: 2020 2020 2020 7661 6c75 6520 3d20 7661        value = va
+0002eba0: 6c75 6528 290d 0a20 2020 2020 2020 2020  lue()..         
+0002ebb0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0002ebc0: 7420 7365 6c66 2e5f 7661 6c69 6461 7465  t self._validate
+0002ebd0: 643a 0d0a 2020 2020 2020 2020 2020 2020  d:..            
+0002ebe0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0002ebf0: 2e5f 7661 6c69 6461 7465 5f76 616c 7565  ._validate_value
+0002ec00: 5f74 656e 736f 7228 7661 6c75 652c 2073  _tensor(value, s
+0002ec10: 7065 6329 0d0a 2020 2020 2020 2020 2020  pec)..          
+0002ec20: 2020 2020 2020 656c 7365 3a0d 0a20 2020        else:..   
+0002ec30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ec40: 2076 616c 7565 203d 2074 6f72 6368 2e66   value = torch.f
+0002ec50: 756c 6c28 0d0a 2020 2020 2020 2020 2020  ull(..          
+0002ec60: 2020 2020 2020 2020 2020 2020 2020 7370                sp
+0002ec70: 6563 2e73 6861 7065 2c0d 0a20 2020 2020  ec.shape,..     
+0002ec80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ec90: 2020 2076 616c 7565 2c0d 0a20 2020 2020     value,..     
+0002eca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ecb0: 2020 2064 6576 6963 653d 7370 6563 2e64     device=spec.d
+0002ecc0: 6576 6963 652c 0d0a 2020 2020 2020 2020  evice,..        
+0002ecd0: 2020 2020 2020 2020 2020 2020 290d 0a0d              )...
+0002ece0: 0a20 2020 2020 2020 2020 2020 2074 656e  .            ten
+0002ecf0: 736f 7264 6963 742e 7365 7428 6b65 792c  sordict.set(key,
+0002ed00: 2076 616c 7565 290d 0a20 2020 2020 2020   value)..       
+0002ed10: 2069 6620 6e6f 7420 7365 6c66 2e5f 7661   if not self._va
+0002ed20: 6c69 6461 7465 643a 0d0a 2020 2020 2020  lidated:..      
+0002ed30: 2020 2020 2020 7365 6c66 2e5f 7661 6c69        self._vali
+0002ed40: 6461 7465 6420 3d20 5472 7565 0d0a 2020  dated = True..  
+0002ed50: 2020 2020 2020 7265 7475 726e 2074 656e        return ten
+0002ed60: 736f 7264 6963 740d 0a0d 0a20 2020 2064  sordict....    d
+0002ed70: 6566 205f 7374 6570 280d 0a20 2020 2020  ef _step(..     
+0002ed80: 2020 2073 656c 662c 2074 656e 736f 7264     self, tensord
+0002ed90: 6963 743a 2054 656e 736f 7244 6963 7442  ict: TensorDictB
+0002eda0: 6173 652c 206e 6578 745f 7465 6e73 6f72  ase, next_tensor
+0002edb0: 6469 6374 3a20 5465 6e73 6f72 4469 6374  dict: TensorDict
+0002edc0: 4261 7365 0d0a 2020 2020 2920 2d3e 2054  Base..    ) -> T
+0002edd0: 656e 736f 7244 6963 7442 6173 653a 0d0a  ensorDictBase:..
+0002ede0: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
+0002edf0: 696e 2073 656c 662e 7072 696d 6572 732e  in self.primers.
+0002ee00: 6b65 7973 2829 3a0d 0a20 2020 2020 2020  keys():..       
+0002ee10: 2020 2020 2069 6620 6b65 7920 6e6f 7420       if key not 
+0002ee20: 696e 206e 6578 745f 7465 6e73 6f72 6469  in next_tensordi
+0002ee30: 6374 2e6b 6579 7328 5472 7565 293a 0d0a  ct.keys(True):..
+0002ee40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ee50: 7072 6576 5f76 616c 203d 2074 656e 736f  prev_val = tenso
+0002ee60: 7264 6963 742e 6765 7428 6b65 7929 0d0a  rdict.get(key)..
+0002ee70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ee80: 6e65 7874 5f74 656e 736f 7264 6963 742e  next_tensordict.
+0002ee90: 7365 7428 6b65 792c 2070 7265 765f 7661  set(key, prev_va
+0002eea0: 6c29 0d0a 2020 2020 2020 2020 7265 7475  l)..        retu
+0002eeb0: 726e 206e 6578 745f 7465 6e73 6f72 6469  rn next_tensordi
+0002eec0: 6374 0d0a 0d0a 2020 2020 6465 6620 5f72  ct....    def _r
+0002eed0: 6573 6574 280d 0a20 2020 2020 2020 2073  eset(..        s
+0002eee0: 656c 662c 2074 656e 736f 7264 6963 743a  elf, tensordict:
+0002eef0: 2054 656e 736f 7244 6963 7442 6173 652c   TensorDictBase,
+0002ef00: 2074 656e 736f 7264 6963 745f 7265 7365   tensordict_rese
+0002ef10: 743a 2054 656e 736f 7244 6963 7442 6173  t: TensorDictBas
+0002ef20: 650d 0a20 2020 2029 202d 3e20 5465 6e73  e..    ) -> Tens
+0002ef30: 6f72 4469 6374 4261 7365 3a0d 0a20 2020  orDictBase:..   
+0002ef40: 2020 2020 2022 2222 5365 7473 2074 6865       """Sets the
+0002ef50: 2064 6566 6175 6c74 2076 616c 7565 7320   default values 
+0002ef60: 696e 2074 6865 2069 6e70 7574 2074 656e  in the input ten
+0002ef70: 736f 7264 6963 742e 0d0a 0d0a 2020 2020  sordict.....    
+0002ef80: 2020 2020 4966 2074 6865 2070 6172 656e      If the paren
+0002ef90: 7420 6973 2062 6174 6368 2d6c 6f63 6b65  t is batch-locke
+0002efa0: 642c 2077 6520 6173 7375 6d65 2074 6861  d, we assume tha
+0002efb0: 7420 7468 6520 7370 6563 7320 6861 7665  t the specs have
+0002efc0: 2074 6865 2061 7070 726f 7072 6961 7465   the appropriate
+0002efd0: 206c 6561 6469 6e67 0d0a 2020 2020 2020   leading..      
+0002efe0: 2020 7368 6170 652e 2057 6520 616c 6c6f    shape. We allo
+0002eff0: 7720 666f 7220 6578 6563 7574 696f 6e20  w for execution 
+0002f000: 7768 656e 2074 6865 2070 6172 656e 7420  when the parent 
+0002f010: 6973 206d 6973 7369 6e67 2c20 696e 2077  is missing, in w
+0002f020: 6869 6368 2063 6173 6520 7468 650d 0a20  hich case the.. 
+0002f030: 2020 2020 2020 2073 7065 6320 7368 6170         spec shap
+0002f040: 6520 6973 2061 7373 756d 6564 2074 6f20  e is assumed to 
+0002f050: 6d61 7463 6820 7468 6520 7465 6e73 6f72  match the tensor
+0002f060: 6469 6374 2773 2e0d 0a0d 0a20 2020 2020  dict's.....     
+0002f070: 2020 2022 2222 0d0a 2020 2020 2020 2020     """..        
+0002f080: 5f72 6573 6574 203d 205f 6765 745f 7265  _reset = _get_re
+0002f090: 7365 7428 7365 6c66 2e72 6573 6574 5f6b  set(self.reset_k
+0002f0a0: 6579 2c20 7465 6e73 6f72 6469 6374 290d  ey, tensordict).
+0002f0b0: 0a20 2020 2020 2020 2069 6620 5f72 6573  .        if _res
+0002f0c0: 6574 2e61 6e79 2829 3a0d 0a20 2020 2020  et.any():..     
+0002f0d0: 2020 2020 2020 2066 6f72 206b 6579 2c20         for key, 
+0002f0e0: 7370 6563 2069 6e20 7365 6c66 2e70 7269  spec in self.pri
+0002f0f0: 6d65 7273 2e69 7465 6d73 2854 7275 652c  mers.items(True,
+0002f100: 2054 7275 6529 3a0d 0a20 2020 2020 2020   True):..       
+0002f110: 2020 2020 2020 2020 2069 6620 7370 6563           if spec
+0002f120: 2e73 6861 7065 5b3a 206c 656e 2874 656e  .shape[: len(ten
+0002f130: 736f 7264 6963 742e 6261 7463 685f 7369  sordict.batch_si
+0002f140: 7a65 295d 2021 3d20 7465 6e73 6f72 6469  ze)] != tensordi
+0002f150: 6374 2e62 6174 6368 5f73 697a 653a 0d0a  ct.batch_size:..
 0002f160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f170: 2065 6c73 653a 0d0a 2020 2020 2020 2020   else:..        
-0002f180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f190: 7661 6c75 6520 3d20 746f 7263 682e 6675  value = torch.fu
-0002f1a0: 6c6c 280d 0a20 2020 2020 2020 2020 2020  ll(..           
-0002f1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f1c0: 2073 7065 632e 7368 6170 652c 0d0a 2020   spec.shape,..  
-0002f1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f1e0: 2020 2020 2020 2020 2020 7661 6c75 652c            value,
-0002f1f0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0002f200: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0002f210: 7669 6365 3d73 7065 632e 6465 7669 6365  vice=spec.device
-0002f220: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
-0002f230: 2020 2020 2020 2020 2020 2029 0d0a 2020             )..  
+0002f170: 2020 2020 6578 7061 6e64 6564 5f73 7065      expanded_spe
+0002f180: 6320 3d20 7365 6c66 2e5f 6578 7061 6e64  c = self._expand
+0002f190: 5f73 6861 7065 2873 7065 6329 0d0a 2020  _shape(spec)..  
+0002f1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f1b0: 2020 7365 6c66 2e70 7269 6d65 7273 5b6b    self.primers[k
+0002f1c0: 6579 5d20 3d20 7370 6563 203d 2065 7870  ey] = spec = exp
+0002f1d0: 616e 6465 645f 7370 6563 0d0a 2020 2020  anded_spec..    
+0002f1e0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+0002f1f0: 656c 662e 7261 6e64 6f6d 3a0d 0a20 2020  elf.random:..   
+0002f200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f210: 2073 6861 7065 203d 2028 0d0a 2020 2020   shape = (..    
+0002f220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f230: 2020 2020 2829 0d0a 2020 2020 2020 2020      ()..        
 0002f240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f250: 2020 2020 2020 7072 6576 5f76 616c 203d        prev_val =
-0002f260: 2074 656e 736f 7264 6963 742e 6765 7428   tensordict.get(
-0002f270: 6b65 792c 2030 2e30 290d 0a20 2020 2020  key, 0.0)..     
-0002f280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f290: 2020 2076 616c 7565 203d 2074 6f72 6368     value = torch
-0002f2a0: 2e77 6865 7265 280d 0a20 2020 2020 2020  .where(..       
-0002f2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f2c0: 2020 2020 2065 7870 616e 645f 6173 5f72       expand_as_r
-0002f2d0: 6967 6874 285f 7265 7365 742c 2076 616c  ight(_reset, val
-0002f2e0: 7565 292c 2076 616c 7565 2c20 7072 6576  ue), value, prev
-0002f2f0: 5f76 616c 0d0a 2020 2020 2020 2020 2020  _val..          
-0002f300: 2020 2020 2020 2020 2020 2020 2020 290d                ).
-0002f310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f320: 2074 656e 736f 7264 6963 745f 7265 7365   tensordict_rese
-0002f330: 742e 7365 7428 6b65 792c 2076 616c 7565  t.set(key, value
-0002f340: 290d 0a20 2020 2020 2020 2020 2020 2073  )..            s
-0002f350: 656c 662e 5f76 616c 6964 6174 6564 203d  elf._validated =
-0002f360: 2054 7275 650d 0a20 2020 2020 2020 2072   True..        r
-0002f370: 6574 7572 6e20 7465 6e73 6f72 6469 6374  eturn tensordict
-0002f380: 5f72 6573 6574 0d0a 0d0a 2020 2020 6465  _reset....    de
-0002f390: 6620 5f5f 7265 7072 5f5f 2873 656c 6629  f __repr__(self)
-0002f3a0: 202d 3e20 7374 723a 0d0a 2020 2020 2020   -> str:..      
-0002f3b0: 2020 636c 6173 735f 6e61 6d65 203d 2073    class_name = s
-0002f3c0: 656c 662e 5f5f 636c 6173 735f 5f2e 5f5f  elf.__class__.__
-0002f3d0: 6e61 6d65 5f5f 0d0a 2020 2020 2020 2020  name__..        
-0002f3e0: 6465 6661 756c 745f 7661 6c75 6520 3d20  default_value = 
-0002f3f0: 7b0d 0a20 2020 2020 2020 2020 2020 206b  {..            k
-0002f400: 6579 3a20 7661 6c75 6520 6966 2069 7369  ey: value if isi
-0002f410: 6e73 7461 6e63 6528 7661 6c75 652c 2066  nstance(value, f
-0002f420: 6c6f 6174 2920 656c 7365 2022 4361 6c6c  loat) else "Call
-0002f430: 6162 6c65 220d 0a20 2020 2020 2020 2020  able"..         
-0002f440: 2020 2066 6f72 206b 6579 2c20 7661 6c75     for key, valu
-0002f450: 6520 696e 2073 656c 662e 6465 6661 756c  e in self.defaul
-0002f460: 745f 7661 6c75 652e 6974 656d 7328 290d  t_value.items().
-0002f470: 0a20 2020 2020 2020 207d 0d0a 2020 2020  .        }..    
-0002f480: 2020 2020 7265 7475 726e 2066 227b 636c      return f"{cl
-0002f490: 6173 735f 6e61 6d65 7d28 7072 696d 6572  ass_name}(primer
-0002f4a0: 733d 7b73 656c 662e 7072 696d 6572 737d  s={self.primers}
-0002f4b0: 2c20 6465 6661 756c 745f 7661 6c75 653d  , default_value=
-0002f4c0: 7b64 6566 6175 6c74 5f76 616c 7565 7d2c  {default_value},
-0002f4d0: 2072 616e 646f 6d3d 7b73 656c 662e 7261   random={self.ra
-0002f4e0: 6e64 6f6d 7d29 220d 0a0d 0a0d 0a63 6c61  ndom})"......cla
-0002f4f0: 7373 2050 696e 4d65 6d6f 7279 5472 616e  ss PinMemoryTran
-0002f500: 7366 6f72 6d28 5472 616e 7366 6f72 6d29  sform(Transform)
-0002f510: 3a0d 0a20 2020 2022 2222 4361 6c6c 7320  :..    """Calls 
-0002f520: 7069 6e5f 6d65 6d6f 7279 206f 6e20 7468  pin_memory on th
-0002f530: 6520 7465 6e73 6f72 6469 6374 2074 6f20  e tensordict to 
-0002f540: 6661 6369 6c69 7461 7465 2077 7269 7469  facilitate writi
-0002f550: 6e67 206f 6e20 4355 4441 2064 6576 6963  ng on CUDA devic
-0002f560: 6573 2e22 2222 0d0a 0d0a 2020 2020 6465  es."""....    de
-0002f570: 6620 5f5f 696e 6974 5f5f 2873 656c 6629  f __init__(self)
-0002f580: 3a0d 0a20 2020 2020 2020 2073 7570 6572  :..        super
-0002f590: 2829 2e5f 5f69 6e69 745f 5f28 290d 0a0d  ().__init__()...
-0002f5a0: 0a20 2020 2064 6566 205f 6361 6c6c 2873  .    def _call(s
-0002f5b0: 656c 662c 2074 656e 736f 7264 6963 743a  elf, tensordict:
-0002f5c0: 2054 656e 736f 7244 6963 7442 6173 6529   TensorDictBase)
-0002f5d0: 202d 3e20 5465 6e73 6f72 4469 6374 4261   -> TensorDictBa
-0002f5e0: 7365 3a0d 0a20 2020 2020 2020 2072 6574  se:..        ret
-0002f5f0: 7572 6e20 7465 6e73 6f72 6469 6374 2e70  urn tensordict.p
-0002f600: 696e 5f6d 656d 6f72 7928 290d 0a0d 0a20  in_memory().... 
-0002f610: 2020 2066 6f72 7761 7264 203d 205f 6361     forward = _ca
-0002f620: 6c6c 0d0a 0d0a 2020 2020 6465 6620 5f72  ll....    def _r
-0002f630: 6573 6574 280d 0a20 2020 2020 2020 2073  eset(..        s
-0002f640: 656c 662c 2074 656e 736f 7264 6963 743a  elf, tensordict:
-0002f650: 2054 656e 736f 7244 6963 7442 6173 652c   TensorDictBase,
-0002f660: 2074 656e 736f 7264 6963 745f 7265 7365   tensordict_rese
-0002f670: 743a 2054 656e 736f 7244 6963 7442 6173  t: TensorDictBas
-0002f680: 650d 0a20 2020 2029 202d 3e20 5465 6e73  e..    ) -> Tens
-0002f690: 6f72 4469 6374 4261 7365 3a0d 0a20 2020  orDictBase:..   
-0002f6a0: 2020 2020 2077 6974 6820 5f73 6574 5f6d       with _set_m
-0002f6b0: 6973 7369 6e67 5f74 6f6c 6572 616e 6365  issing_tolerance
-0002f6c0: 2873 656c 662c 2054 7275 6529 3a0d 0a20  (self, True):.. 
-0002f6d0: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
-0002f6e0: 7264 6963 745f 7265 7365 7420 3d20 7365  rdict_reset = se
-0002f6f0: 6c66 2e5f 6361 6c6c 2874 656e 736f 7264  lf._call(tensord
-0002f700: 6963 745f 7265 7365 7429 0d0a 2020 2020  ict_reset)..    
-0002f710: 2020 2020 7265 7475 726e 2074 656e 736f      return tenso
-0002f720: 7264 6963 745f 7265 7365 740d 0a0d 0a0d  rdict_reset.....
-0002f730: 0a64 6566 205f 7375 6d5f 6c65 6674 2876  .def _sum_left(v
-0002f740: 616c 2c20 6465 7374 293a 0d0a 2020 2020  al, dest):..    
-0002f750: 7768 696c 6520 7661 6c2e 6e64 696d 656e  while val.ndimen
-0002f760: 7369 6f6e 2829 203e 2064 6573 742e 6e64  sion() > dest.nd
-0002f770: 696d 656e 7369 6f6e 2829 3a0d 0a20 2020  imension():..   
-0002f780: 2020 2020 2076 616c 203d 2076 616c 2e73       val = val.s
-0002f790: 756d 2830 290d 0a20 2020 2072 6574 7572  um(0)..    retur
-0002f7a0: 6e20 7661 6c0d 0a0d 0a0d 0a63 6c61 7373  n val......class
-0002f7b0: 2067 5344 454e 6f69 7365 2854 656e 736f   gSDENoise(Tenso
-0002f7c0: 7244 6963 7450 7269 6d65 7229 3a0d 0a20  rDictPrimer):.. 
-0002f7d0: 2020 2022 2222 4120 6753 4445 206e 6f69     """A gSDE noi
-0002f7e0: 7365 2069 6e69 7469 616c 697a 6572 2e0d  se initializer..
-0002f7f0: 0a0d 0a20 2020 2053 6565 2074 6865 203a  ...    See the :
-0002f800: 6675 6e63 3a60 7e74 6f72 6368 726c 2e6d  func:`~torchrl.m
-0002f810: 6f64 756c 6573 2e6d 6f64 656c 732e 6578  odules.models.ex
-0002f820: 706c 6f72 6174 696f 6e2e 6753 4445 4d6f  ploration.gSDEMo
-0002f830: 6475 6c65 2720 666f 7220 6d6f 7265 2069  dule' for more i
-0002f840: 6e66 6f2e 0d0a 2020 2020 2222 220d 0a0d  nfo...    """...
-0002f850: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-0002f860: 5f28 0d0a 2020 2020 2020 2020 7365 6c66  _(..        self
-0002f870: 2c0d 0a20 2020 2020 2020 2073 7461 7465  ,..        state
-0002f880: 5f64 696d 3d4e 6f6e 652c 0d0a 2020 2020  _dim=None,..    
-0002f890: 2020 2020 6163 7469 6f6e 5f64 696d 3d4e      action_dim=N
-0002f8a0: 6f6e 652c 0d0a 2020 2020 2020 2020 7368  one,..        sh
-0002f8b0: 6170 653d 4e6f 6e65 2c0d 0a20 2020 2020  ape=None,..     
-0002f8c0: 2020 202a 2a6b 7761 7267 732c 0d0a 2020     **kwargs,..  
-0002f8d0: 2020 2920 2d3e 204e 6f6e 653a 0d0a 2020    ) -> None:..  
-0002f8e0: 2020 2020 2020 7365 6c66 2e73 7461 7465        self.state
-0002f8f0: 5f64 696d 203d 2073 7461 7465 5f64 696d  _dim = state_dim
-0002f900: 0d0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
-0002f910: 6374 696f 6e5f 6469 6d20 3d20 6163 7469  ction_dim = acti
-0002f920: 6f6e 5f64 696d 0d0a 2020 2020 2020 2020  on_dim..        
-0002f930: 6966 2073 6861 7065 2069 7320 4e6f 6e65  if shape is None
-0002f940: 3a0d 0a20 2020 2020 2020 2020 2020 2073  :..            s
-0002f950: 6861 7065 203d 2028 290d 0a20 2020 2020  hape = ()..     
-0002f960: 2020 2074 6169 6c5f 6469 6d20 3d20 280d     tail_dim = (.
-0002f970: 0a20 2020 2020 2020 2020 2020 2028 312c  .            (1,
-0002f980: 2920 6966 2073 7461 7465 5f64 696d 2069  ) if state_dim i
-0002f990: 7320 4e6f 6e65 206f 7220 6163 7469 6f6e  s None or action
-0002f9a0: 5f64 696d 2069 7320 4e6f 6e65 2065 6c73  _dim is None els
-0002f9b0: 6520 2861 6374 696f 6e5f 6469 6d2c 2073  e (action_dim, s
-0002f9c0: 7461 7465 5f64 696d 290d 0a20 2020 2020  tate_dim)..     
-0002f9d0: 2020 2029 0d0a 2020 2020 2020 2020 7261     )..        ra
-0002f9e0: 6e64 6f6d 203d 2073 7461 7465 5f64 696d  ndom = state_dim
-0002f9f0: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
-0002fa00: 2061 6374 696f 6e5f 6469 6d20 6973 206e   action_dim is n
-0002fa10: 6f74 204e 6f6e 650d 0a20 2020 2020 2020  ot None..       
-0002fa20: 2073 6861 7065 203d 2074 7570 6c65 2873   shape = tuple(s
-0002fa30: 6861 7065 2920 2b20 7461 696c 5f64 696d  hape) + tail_dim
-0002fa40: 0d0a 2020 2020 2020 2020 7072 696d 6572  ..        primer
-0002fa50: 7320 3d20 7b22 5f65 7073 5f67 5344 4522  s = {"_eps_gSDE"
-0002fa60: 3a20 556e 626f 756e 6465 6443 6f6e 7469  : UnboundedConti
-0002fa70: 6e75 6f75 7354 656e 736f 7253 7065 6328  nuousTensorSpec(
-0002fa80: 7368 6170 653d 7368 6170 6529 7d0d 0a20  shape=shape)}.. 
-0002fa90: 2020 2020 2020 2073 7570 6572 2829 2e5f         super()._
-0002faa0: 5f69 6e69 745f 5f28 7072 696d 6572 733d  _init__(primers=
-0002fab0: 7072 696d 6572 732c 2072 616e 646f 6d3d  primers, random=
-0002fac0: 7261 6e64 6f6d 2c20 2a2a 6b77 6172 6773  random, **kwargs
-0002fad0: 290d 0a0d 0a0d 0a63 6c61 7373 2056 6563  )......class Vec
-0002fae0: 4e6f 726d 2854 7261 6e73 666f 726d 293a  Norm(Transform):
-0002faf0: 0d0a 2020 2020 2222 224d 6f76 696e 6720  ..    """Moving 
-0002fb00: 6176 6572 6167 6520 6e6f 726d 616c 697a  average normaliz
-0002fb10: 6174 696f 6e20 6c61 7965 7220 666f 7220  ation layer for 
-0002fb20: 746f 7263 6872 6c20 656e 7669 726f 6e6d  torchrl environm
-0002fb30: 656e 7473 2e0d 0a0d 0a20 2020 2056 6563  ents.....    Vec
-0002fb40: 4e6f 726d 206b 6565 7073 2074 7261 636b  Norm keeps track
-0002fb50: 206f 6620 7468 6520 7375 6d6d 6172 7920   of the summary 
-0002fb60: 7374 6174 6973 7469 6373 206f 6620 6120  statistics of a 
-0002fb70: 6461 7461 7365 7420 746f 2073 7461 6e64  dataset to stand
-0002fb80: 6172 6469 7a65 0d0a 2020 2020 6974 206f  ardize..    it o
-0002fb90: 6e2d 7468 652d 666c 792e 2049 6620 7468  n-the-fly. If th
-0002fba0: 6520 7472 616e 7366 6f72 6d20 6973 2069  e transform is i
-0002fbb0: 6e20 2765 7661 6c27 206d 6f64 652c 2074  n 'eval' mode, t
-0002fbc0: 6865 2072 756e 6e69 6e67 0d0a 2020 2020  he running..    
-0002fbd0: 7374 6174 6973 7469 6373 2061 7265 206e  statistics are n
-0002fbe0: 6f74 2075 7064 6174 6564 2e0d 0a0d 0a20  ot updated..... 
-0002fbf0: 2020 2049 6620 6d75 6c74 6970 6c65 2070     If multiple p
-0002fc00: 726f 6365 7373 6573 2061 7265 2072 756e  rocesses are run
-0002fc10: 6e69 6e67 2061 2073 696d 696c 6172 2065  ning a similar e
-0002fc20: 6e76 6972 6f6e 6d65 6e74 2c20 6f6e 6520  nvironment, one 
-0002fc30: 6361 6e20 7061 7373 2061 0d0a 2020 2020  can pass a..    
-0002fc40: 5465 6e73 6f72 4469 6374 4261 7365 2069  TensorDictBase i
-0002fc50: 6e73 7461 6e63 6520 7468 6174 2069 7320  nstance that is 
-0002fc60: 706c 6163 6564 2069 6e20 7368 6172 6564  placed in shared
-0002fc70: 206d 656d 6f72 793a 2069 6620 736f 2c20   memory: if so, 
-0002fc80: 6576 6572 7920 7469 6d65 0d0a 2020 2020  every time..    
-0002fc90: 7468 6520 6e6f 726d 616c 697a 6174 696f  the normalizatio
-0002fca0: 6e20 6c61 7965 7220 6973 2071 7565 7269  n layer is queri
-0002fcb0: 6564 2069 7420 7769 6c6c 2075 7064 6174  ed it will updat
-0002fcc0: 6520 7468 6520 7661 6c75 6573 2066 6f72  e the values for
-0002fcd0: 2061 6c6c 0d0a 2020 2020 7072 6f63 6573   all..    proces
-0002fce0: 7365 7320 7468 6174 2073 6861 7265 2074  ses that share t
-0002fcf0: 6865 2073 616d 6520 7265 6665 7265 6e63  he same referenc
-0002fd00: 652e 0d0a 0d0a 2020 2020 546f 2075 7365  e.....    To use
-0002fd10: 2056 6563 4e6f 726d 2061 7420 696e 6665   VecNorm at infe
-0002fd20: 7265 6e63 6520 7469 6d65 2061 6e64 2061  rence time and a
-0002fd30: 766f 6964 2075 7064 6174 696e 6720 7468  void updating th
-0002fd40: 6520 7661 6c75 6573 2077 6974 6820 7468  e values with th
-0002fd50: 6520 6e65 770d 0a20 2020 206f 6273 6572  e new..    obser
-0002fd60: 7661 7469 6f6e 732c 206f 6e65 2073 686f  vations, one sho
-0002fd70: 756c 6420 7375 6273 7469 7475 7465 2074  uld substitute t
-0002fd80: 6869 7320 6c61 7965 7220 6279 2060 7665  his layer by `ve
-0002fd90: 636e 6f72 6d2e 746f 5f6f 6273 6572 7661  cnorm.to_observa
-0002fda0: 7469 6f6e 5f6e 6f72 6d28 2960 2e0d 0a0d  tion_norm()`....
-0002fdb0: 0a20 2020 2041 7267 733a 0d0a 2020 2020  .    Args:..    
-0002fdc0: 2020 2020 696e 5f6b 6579 7320 2873 6571      in_keys (seq
-0002fdd0: 7565 6e63 6520 6f66 204e 6573 7465 644b  uence of NestedK
-0002fde0: 6579 2c20 6f70 7469 6f6e 616c 293a 206b  ey, optional): k
-0002fdf0: 6579 7320 746f 2062 6520 7570 6461 7465  eys to be update
-0002fe00: 642e 0d0a 2020 2020 2020 2020 2020 2020  d...            
-0002fe10: 6465 6661 756c 743a 205b 226f 6273 6572  default: ["obser
-0002fe20: 7661 7469 6f6e 222c 2022 7265 7761 7264  vation", "reward
-0002fe30: 225d 0d0a 2020 2020 2020 2020 6f75 745f  "]..        out_
-0002fe40: 6b65 7973 2028 7365 7175 656e 6365 206f  keys (sequence o
-0002fe50: 6620 4e65 7374 6564 4b65 792c 206f 7074  f NestedKey, opt
-0002fe60: 696f 6e61 6c29 3a20 6465 7374 696e 6174  ional): destinat
-0002fe70: 696f 6e20 6b65 7973 2e0d 0a20 2020 2020  ion keys...     
-0002fe80: 2020 2020 2020 2044 6566 6175 6c74 7320         Defaults 
-0002fe90: 746f 2060 6069 6e5f 6b65 7973 6060 2e0d  to ``in_keys``..
-0002fea0: 0a20 2020 2020 2020 2073 6861 7265 645f  .        shared_
-0002feb0: 7464 2028 5465 6e73 6f72 4469 6374 4261  td (TensorDictBa
-0002fec0: 7365 2c20 6f70 7469 6f6e 616c 293a 2041  se, optional): A
-0002fed0: 2073 6861 7265 6420 7465 6e73 6f72 6469   shared tensordi
-0002fee0: 6374 2063 6f6e 7461 696e 696e 6720 7468  ct containing th
-0002fef0: 650d 0a20 2020 2020 2020 2020 2020 206b  e..            k
-0002ff00: 6579 7320 6f66 2074 6865 2074 7261 6e73  eys of the trans
-0002ff10: 666f 726d 2e0d 0a20 2020 2020 2020 2064  form...        d
-0002ff20: 6563 6179 2028 6e75 6d62 6572 2c20 6f70  ecay (number, op
-0002ff30: 7469 6f6e 616c 293a 2064 6563 6179 2072  tional): decay r
-0002ff40: 6174 6520 6f66 2074 6865 206d 6f76 696e  ate of the movin
-0002ff50: 6720 6176 6572 6167 652e 0d0a 2020 2020  g average...    
-0002ff60: 2020 2020 2020 2020 6465 6661 756c 743a          default:
-0002ff70: 2030 2e39 390d 0a20 2020 2020 2020 2065   0.99..        e
-0002ff80: 7073 2028 6e75 6d62 6572 2c20 6f70 7469  ps (number, opti
-0002ff90: 6f6e 616c 293a 206c 6f77 6572 2062 6f75  onal): lower bou
-0002ffa0: 6e64 206f 6620 7468 6520 7275 6e6e 696e  nd of the runnin
-0002ffb0: 6720 7374 616e 6461 7264 0d0a 2020 2020  g standard..    
-0002ffc0: 2020 2020 2020 2020 6465 7669 6174 696f          deviatio
-0002ffd0: 6e20 2866 6f72 206e 756d 6572 6963 616c  n (for numerical
-0002ffe0: 2075 6e64 6572 666c 6f77 292e 2044 6566   underflow). Def
-0002fff0: 6175 6c74 2069 7320 3165 2d34 2e0d 0a20  ault is 1e-4... 
-00030000: 2020 2020 2020 2073 6861 7065 7320 284c         shapes (L
-00030010: 6973 745b 746f 7263 682e 5369 7a65 5d2c  ist[torch.Size],
-00030020: 206f 7074 696f 6e61 6c29 3a20 6966 2070   optional): if p
-00030030: 726f 7669 6465 642c 2072 6570 7265 7365  rovided, represe
-00030040: 6e74 7320 7468 6520 7368 6170 650d 0a20  nts the shape.. 
-00030050: 2020 2020 2020 2020 2020 206f 6620 6561             of ea
-00030060: 6368 2069 6e5f 6b65 7973 2e20 4974 7320  ch in_keys. Its 
-00030070: 6c65 6e67 7468 206d 7573 7420 6d61 7463  length must matc
-00030080: 6820 7468 6520 6f6e 6520 6f66 2060 6069  h the one of ``i
-00030090: 6e5f 6b65 7973 6060 2e0d 0a20 2020 2020  n_keys``...     
-000300a0: 2020 2020 2020 2045 6163 6820 7368 6170         Each shap
-000300b0: 6520 6d75 7374 206d 6174 6368 2074 6865  e must match the
-000300c0: 2074 7261 696c 696e 6720 6469 6d65 6e73   trailing dimens
-000300d0: 696f 6e20 6f66 2074 6865 2063 6f72 7265  ion of the corre
-000300e0: 7370 6f6e 6469 6e67 0d0a 2020 2020 2020  sponding..      
-000300f0: 2020 2020 2020 656e 7472 792e 0d0a 2020        entry...  
-00030100: 2020 2020 2020 2020 2020 4966 206e 6f74            If not
-00030110: 2c20 7468 6520 6665 6174 7572 6520 6469  , the feature di
-00030120: 6d65 6e73 696f 6e73 206f 6620 7468 6520  mensions of the 
-00030130: 656e 7472 7920 2869 6520 616c 6c20 6469  entry (ie all di
-00030140: 6d73 2074 6861 7420 646f 0d0a 2020 2020  ms that do..    
-00030150: 2020 2020 2020 2020 6e6f 7420 6265 6c6f          not belo
-00030160: 6e67 2074 6f20 7468 6520 7465 6e73 6f72  ng to the tensor
-00030170: 6469 6374 2062 6174 6368 2d73 697a 6529  dict batch-size)
-00030180: 2077 696c 6c20 6265 2063 6f6e 7369 6465   will be conside
-00030190: 7265 6420 6173 0d0a 2020 2020 2020 2020  red as..        
-000301a0: 2020 2020 6665 6174 7572 6520 6469 6d65      feature dime
-000301b0: 6e73 696f 6e2e 0d0a 0d0a 2020 2020 4578  nsion.....    Ex
-000301c0: 616d 706c 6573 3a0d 0a20 2020 2020 2020  amples:..       
-000301d0: 203e 3e3e 2066 726f 6d20 746f 7263 6872   >>> from torchr
-000301e0: 6c2e 656e 7673 2e6c 6962 732e 6779 6d20  l.envs.libs.gym 
-000301f0: 696d 706f 7274 2047 796d 456e 760d 0a20  import GymEnv.. 
-00030200: 2020 2020 2020 203e 3e3e 2074 203d 2056         >>> t = V
-00030210: 6563 4e6f 726d 2864 6563 6179 3d30 2e39  ecNorm(decay=0.9
-00030220: 290d 0a20 2020 2020 2020 203e 3e3e 2065  )..        >>> e
-00030230: 6e76 203d 2047 796d 456e 7628 2250 656e  nv = GymEnv("Pen
-00030240: 6475 6c75 6d2d 7630 2229 0d0a 2020 2020  dulum-v0")..    
-00030250: 2020 2020 3e3e 3e20 656e 7620 3d20 5472      >>> env = Tr
-00030260: 616e 7366 6f72 6d65 6445 6e76 2865 6e76  ansformedEnv(env
-00030270: 2c20 7429 0d0a 2020 2020 2020 2020 3e3e  , t)..        >>
-00030280: 3e20 7464 7320 3d20 5b5d 0d0a 2020 2020  > tds = []..    
-00030290: 2020 2020 3e3e 3e20 666f 7220 5f20 696e      >>> for _ in
-000302a0: 2072 616e 6765 2831 3030 3029 3a0d 0a20   range(1000):.. 
-000302b0: 2020 2020 2020 202e 2e2e 2020 2020 2074         ...     t
-000302c0: 6420 3d20 656e 762e 7261 6e64 5f73 7465  d = env.rand_ste
-000302d0: 7028 290d 0a20 2020 2020 2020 202e 2e2e  p()..        ...
-000302e0: 2020 2020 2069 6620 7464 2e67 6574 2822       if td.get("
-000302f0: 646f 6e65 2229 3a0d 0a20 2020 2020 2020  done"):..       
-00030300: 202e 2e2e 2020 2020 2020 2020 205f 203d   ...         _ =
-00030310: 2065 6e76 2e72 6573 6574 2829 0d0a 2020   env.reset()..  
-00030320: 2020 2020 2020 2e2e 2e20 2020 2020 7464        ...     td
-00030330: 7320 2b3d 205b 7464 5d0d 0a20 2020 2020  s += [td]..     
-00030340: 2020 203e 3e3e 2074 6473 203d 2074 6f72     >>> tds = tor
-00030350: 6368 2e73 7461 636b 2874 6473 2c20 3029  ch.stack(tds, 0)
-00030360: 0d0a 2020 2020 2020 2020 3e3e 3e20 7072  ..        >>> pr
-00030370: 696e 7428 2861 6273 2874 6473 2e67 6574  int((abs(tds.get
-00030380: 2828 226e 6578 7422 2c20 226f 6273 6572  (("next", "obser
-00030390: 7661 7469 6f6e 2229 292e 6d65 616e 2830  vation")).mean(0
-000303a0: 2929 3c30 2e32 292e 616c 6c28 2929 0d0a  ))<0.2).all())..
-000303b0: 2020 2020 2020 2020 7465 6e73 6f72 2854          tensor(T
-000303c0: 7275 6529 0d0a 2020 2020 2020 2020 3e3e  rue)..        >>
-000303d0: 3e20 7072 696e 7428 2861 6273 2874 6473  > print((abs(tds
-000303e0: 2e67 6574 2828 226e 6578 7422 2c20 226f  .get(("next", "o
-000303f0: 6273 6572 7661 7469 6f6e 2229 292e 7374  bservation")).st
-00030400: 6428 3029 2d31 293c 302e 3229 2e61 6c6c  d(0)-1)<0.2).all
-00030410: 2829 290d 0a20 2020 2020 2020 2074 656e  ())..        ten
-00030420: 736f 7228 5472 7565 290d 0a0d 0a20 2020  sor(True)....   
-00030430: 2022 2222 0d0a 0d0a 2020 2020 6465 6620   """....    def 
-00030440: 5f5f 696e 6974 5f5f 280d 0a20 2020 2020  __init__(..     
-00030450: 2020 2073 656c 662c 0d0a 2020 2020 2020     self,..      
-00030460: 2020 696e 5f6b 6579 733a 2053 6571 7565    in_keys: Seque
-00030470: 6e63 655b 4e65 7374 6564 4b65 795d 207c  nce[NestedKey] |
-00030480: 204e 6f6e 6520 3d20 4e6f 6e65 2c0d 0a20   None = None,.. 
-00030490: 2020 2020 2020 206f 7574 5f6b 6579 733a         out_keys:
-000304a0: 2053 6571 7565 6e63 655b 4e65 7374 6564   Sequence[Nested
-000304b0: 4b65 795d 207c 204e 6f6e 6520 3d20 4e6f  Key] | None = No
-000304c0: 6e65 2c0d 0a20 2020 2020 2020 2073 6861  ne,..        sha
-000304d0: 7265 645f 7464 3a20 4f70 7469 6f6e 616c  red_td: Optional
-000304e0: 5b54 656e 736f 7244 6963 7442 6173 655d  [TensorDictBase]
-000304f0: 203d 204e 6f6e 652c 0d0a 2020 2020 2020   = None,..      
-00030500: 2020 6c6f 636b 3a20 6d70 2e4c 6f63 6b20    lock: mp.Lock 
-00030510: 3d20 4e6f 6e65 2c0d 0a20 2020 2020 2020  = None,..       
-00030520: 2064 6563 6179 3a20 666c 6f61 7420 3d20   decay: float = 
-00030530: 302e 3939 3939 2c0d 0a20 2020 2020 2020  0.9999,..       
-00030540: 2065 7073 3a20 666c 6f61 7420 3d20 3165   eps: float = 1e
-00030550: 2d34 2c0d 0a20 2020 2020 2020 2073 6861  -4,..        sha
-00030560: 7065 733a 204c 6973 745b 746f 7263 682e  pes: List[torch.
-00030570: 5369 7a65 5d20 3d20 4e6f 6e65 2c0d 0a20  Size] = None,.. 
-00030580: 2020 2029 202d 3e20 4e6f 6e65 3a0d 0a20     ) -> None:.. 
-00030590: 2020 2020 2020 2069 6620 6c6f 636b 2069         if lock i
-000305a0: 7320 4e6f 6e65 3a0d 0a20 2020 2020 2020  s None:..       
-000305b0: 2020 2020 206c 6f63 6b20 3d20 6d70 2e4c       lock = mp.L
-000305c0: 6f63 6b28 290d 0a20 2020 2020 2020 2069  ock()..        i
-000305d0: 6620 696e 5f6b 6579 7320 6973 204e 6f6e  f in_keys is Non
-000305e0: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
-000305f0: 696e 5f6b 6579 7320 3d20 5b22 6f62 7365  in_keys = ["obse
-00030600: 7276 6174 696f 6e22 2c20 2272 6577 6172  rvation", "rewar
-00030610: 6422 5d0d 0a20 2020 2020 2020 2069 6620  d"]..        if 
-00030620: 6f75 745f 6b65 7973 2069 7320 4e6f 6e65  out_keys is None
-00030630: 3a0d 0a20 2020 2020 2020 2020 2020 206f  :..            o
-00030640: 7574 5f6b 6579 7320 3d20 636f 7079 2869  ut_keys = copy(i
-00030650: 6e5f 6b65 7973 290d 0a20 2020 2020 2020  n_keys)..       
-00030660: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
-00030670: 5f28 696e 5f6b 6579 733d 696e 5f6b 6579  _(in_keys=in_key
-00030680: 732c 206f 7574 5f6b 6579 733d 6f75 745f  s, out_keys=out_
-00030690: 6b65 7973 290d 0a20 2020 2020 2020 2073  keys)..        s
-000306a0: 656c 662e 5f74 6420 3d20 7368 6172 6564  elf._td = shared
-000306b0: 5f74 640d 0a20 2020 2020 2020 2069 6620  _td..        if 
-000306c0: 7368 6172 6564 5f74 6420 6973 206e 6f74  shared_td is not
-000306d0: 204e 6f6e 6520 616e 6420 6e6f 7420 280d   None and not (.
-000306e0: 0a20 2020 2020 2020 2020 2020 2073 6861  .            sha
-000306f0: 7265 645f 7464 2e69 735f 7368 6172 6564  red_td.is_shared
-00030700: 2829 206f 7220 7368 6172 6564 5f74 642e  () or shared_td.
-00030710: 6973 5f6d 656d 6d61 7028 290d 0a20 2020  is_memmap()..   
-00030720: 2020 2020 2029 3a0d 0a20 2020 2020 2020       ):..       
-00030730: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
-00030740: 6d65 4572 726f 7228 0d0a 2020 2020 2020  meError(..      
-00030750: 2020 2020 2020 2020 2020 2273 6861 7265            "share
-00030760: 645f 7464 206d 7573 7420 6265 2065 6974  d_td must be eit
-00030770: 6865 7220 696e 2073 6861 7265 6420 6d65  her in shared me
-00030780: 6d6f 7279 206f 7220 6120 6d65 6d6d 6170  mory or a memmap
-00030790: 2022 2022 7465 6e73 6f72 6469 6374 2e22   " "tensordict."
-000307a0: 0d0a 2020 2020 2020 2020 2020 2020 290d  ..            ).
-000307b0: 0a20 2020 2020 2020 2069 6620 7368 6172  .        if shar
-000307c0: 6564 5f74 6420 6973 206e 6f74 204e 6f6e  ed_td is not Non
-000307d0: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
-000307e0: 666f 7220 6b65 7920 696e 2069 6e5f 6b65  for key in in_ke
-000307f0: 7973 3a0d 0a20 2020 2020 2020 2020 2020  ys:..           
-00030800: 2020 2020 2069 6620 280d 0a20 2020 2020       if (..     
-00030810: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00030820: 5f61 7070 656e 645f 6c61 7374 286b 6579  _append_last(key
-00030830: 2c20 225f 7375 6d22 2920 6e6f 7420 696e  , "_sum") not in
-00030840: 2073 6861 7265 645f 7464 2e6b 6579 7328   shared_td.keys(
-00030850: 2929 0d0a 2020 2020 2020 2020 2020 2020  ))..            
-00030860: 2020 2020 2020 2020 6f72 2028 5f61 7070          or (_app
-00030870: 656e 645f 6c61 7374 286b 6579 2c20 225f  end_last(key, "_
-00030880: 7373 7122 2920 6e6f 7420 696e 2073 6861  ssq") not in sha
-00030890: 7265 645f 7464 2e6b 6579 7328 2929 0d0a  red_td.keys())..
-000308a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000308b0: 2020 2020 6f72 2028 5f61 7070 656e 645f      or (_append_
-000308c0: 6c61 7374 286b 6579 2c20 225f 636f 756e  last(key, "_coun
-000308d0: 7422 2920 6e6f 7420 696e 2073 6861 7265  t") not in share
-000308e0: 645f 7464 2e6b 6579 7328 2929 0d0a 2020  d_td.keys())..  
-000308f0: 2020 2020 2020 2020 2020 2020 2020 293a                ):
-00030900: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00030910: 2020 2020 2020 7261 6973 6520 4b65 7945        raise KeyE
-00030920: 7272 6f72 280d 0a20 2020 2020 2020 2020  rror(..         
-00030930: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00030940: 226b 6579 207b 6b65 797d 206e 6f74 2070  "key {key} not p
-00030950: 7265 7365 6e74 2069 6e20 7468 6520 7368  resent in the sh
-00030960: 6172 6564 2074 656e 736f 7264 6963 7420  ared tensordict 
-00030970: 220d 0a20 2020 2020 2020 2020 2020 2020  "..             
-00030980: 2020 2020 2020 2020 2020 2066 2277 6974             f"wit
-00030990: 6820 6b65 7973 207b 7368 6172 6564 5f74  h keys {shared_t
-000309a0: 642e 6b65 7973 2829 7d22 0d0a 2020 2020  d.keys()}"..    
-000309b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000309c0: 290d 0a0d 0a20 2020 2020 2020 2073 656c  )....        sel
-000309d0: 662e 6c6f 636b 203d 206c 6f63 6b0d 0a20  f.lock = lock.. 
-000309e0: 2020 2020 2020 2073 656c 662e 6465 6361         self.deca
-000309f0: 7920 3d20 6465 6361 790d 0a20 2020 2020  y = decay..     
-00030a00: 2020 2073 656c 662e 7368 6170 6573 203d     self.shapes =
-00030a10: 2073 6861 7065 730d 0a20 2020 2020 2020   shapes..       
-00030a20: 2073 656c 662e 6570 7320 3d20 6570 730d   self.eps = eps.
-00030a30: 0a0d 0a20 2020 2064 6566 205f 7265 7365  ...    def _rese
-00030a40: 7428 0d0a 2020 2020 2020 2020 7365 6c66  t(..        self
-00030a50: 2c20 7465 6e73 6f72 6469 6374 3a20 5465  , tensordict: Te
-00030a60: 6e73 6f72 4469 6374 4261 7365 2c20 7465  nsorDictBase, te
-00030a70: 6e73 6f72 6469 6374 5f72 6573 6574 3a20  nsordict_reset: 
-00030a80: 5465 6e73 6f72 4469 6374 4261 7365 0d0a  TensorDictBase..
-00030a90: 2020 2020 2920 2d3e 2054 656e 736f 7244      ) -> TensorD
-00030aa0: 6963 7442 6173 653a 0d0a 2020 2020 2020  ictBase:..      
-00030ab0: 2020 2320 544f 444f 3a20 7265 6d6f 7665    # TODO: remove
-00030ac0: 2074 6869 7320 6465 636f 7261 746f 7220   this decorator 
-00030ad0: 7768 656e 2074 7261 636b 6572 7320 6172  when trackers ar
-00030ae0: 6520 696e 2064 6174 610d 0a20 2020 2020  e in data..     
-00030af0: 2020 2077 6974 6820 5f73 6574 5f6d 6973     with _set_mis
-00030b00: 7369 6e67 5f74 6f6c 6572 616e 6365 2873  sing_tolerance(s
-00030b10: 656c 662c 2054 7275 6529 3a0d 0a20 2020  elf, True):..   
-00030b20: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00030b30: 7365 6c66 2e5f 6361 6c6c 2874 656e 736f  self._call(tenso
-00030b40: 7264 6963 745f 7265 7365 7429 0d0a 2020  rdict_reset)..  
-00030b50: 2020 2020 2020 7265 7475 726e 2074 656e        return ten
-00030b60: 736f 7264 6963 745f 7265 7365 740d 0a0d  sordict_reset...
-00030b70: 0a20 2020 2064 6566 205f 6361 6c6c 2873  .    def _call(s
-00030b80: 656c 662c 2074 656e 736f 7264 6963 743a  elf, tensordict:
-00030b90: 2054 656e 736f 7244 6963 7442 6173 6529   TensorDictBase)
-00030ba0: 202d 3e20 5465 6e73 6f72 4469 6374 4261   -> TensorDictBa
-00030bb0: 7365 3a0d 0a20 2020 2020 2020 2069 6620  se:..        if 
-00030bc0: 7365 6c66 2e6c 6f63 6b20 6973 206e 6f74  self.lock is not
-00030bd0: 204e 6f6e 653a 0d0a 2020 2020 2020 2020   None:..        
-00030be0: 2020 2020 7365 6c66 2e6c 6f63 6b2e 6163      self.lock.ac
-00030bf0: 7175 6972 6528 290d 0a0d 0a20 2020 2020  quire()....     
-00030c00: 2020 2066 6f72 206b 6579 2069 6e20 7365     for key in se
-00030c10: 6c66 2e69 6e5f 6b65 7973 3a0d 0a20 2020  lf.in_keys:..   
-00030c20: 2020 2020 2020 2020 2069 6620 6b65 7920           if key 
-00030c30: 6e6f 7420 696e 2074 656e 736f 7264 6963  not in tensordic
-00030c40: 742e 6b65 7973 2869 6e63 6c75 6465 5f6e  t.keys(include_n
-00030c50: 6573 7465 643d 5472 7565 293a 0d0a 2020  ested=True):..  
-00030c60: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00030c70: 544f 444f 3a20 696e 6974 206d 6973 7369  TODO: init missi
-00030c80: 6e67 2072 6577 6172 6473 2077 6974 6820  ng rewards with 
-00030c90: 7468 6973 0d0a 2020 2020 2020 2020 2020  this..          
-00030ca0: 2020 2020 2020 2320 666f 7220 6b65 795f        # for key_
-00030cb0: 7375 6666 6978 2069 6e20 5b5f 6170 7065  suffix in [_appe
-00030cc0: 6e64 5f6c 6173 7428 6b65 792c 2073 7566  nd_last(key, suf
-00030cd0: 6669 7829 2066 6f72 2073 7566 6669 7820  fix) for suffix 
-00030ce0: 696e 2028 225f 7375 6d22 2c20 225f 7373  in ("_sum", "_ss
-00030cf0: 7122 2c20 225f 636f 756e 7422 295d 3a0d  q", "_count")]:.
-00030d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030d10: 2023 2020 2020 2074 656e 736f 7264 6963   #     tensordic
-00030d20: 742e 7365 7428 6b65 795f 7375 6666 6978  t.set(key_suffix
-00030d30: 2c20 7365 6c66 2e63 6f6e 7461 696e 6572  , self.container
-00030d40: 2e6f 6273 6572 7661 7469 6f6e 5f73 7065  .observation_spe
-00030d50: 635b 6b65 795f 7375 6666 6978 5d2e 7a65  c[key_suffix].ze
-00030d60: 726f 2829 290d 0a20 2020 2020 2020 2020  ro())..         
-00030d70: 2020 2020 2020 2063 6f6e 7469 6e75 650d         continue.
-00030d80: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00030d90: 662e 5f69 6e69 7428 7465 6e73 6f72 6469  f._init(tensordi
-00030da0: 6374 2c20 6b65 7929 0d0a 2020 2020 2020  ct, key)..      
-00030db0: 2020 2020 2020 2320 7570 6461 7465 2061        # update a
-00030dc0: 6e64 2073 7461 6e64 6172 6469 7a65 0d0a  nd standardize..
-00030dd0: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
-00030de0: 7661 6c20 3d20 7365 6c66 2e5f 7570 6461  val = self._upda
-00030df0: 7465 280d 0a20 2020 2020 2020 2020 2020  te(..           
-00030e00: 2020 2020 206b 6579 2c20 7465 6e73 6f72       key, tensor
-00030e10: 6469 6374 2e67 6574 286b 6579 292c 204e  dict.get(key), N
-00030e20: 3d6d 6178 2831 2c20 7465 6e73 6f72 6469  =max(1, tensordi
-00030e30: 6374 2e6e 756d 656c 2829 290d 0a20 2020  ct.numel())..   
-00030e40: 2020 2020 2020 2020 2029 0d0a 0d0a 2020           )....  
-00030e50: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
-00030e60: 6469 6374 2e73 6574 286b 6579 2c20 6e65  dict.set(key, ne
-00030e70: 775f 7661 6c29 0d0a 0d0a 2020 2020 2020  w_val)....      
-00030e80: 2020 6966 2073 656c 662e 6c6f 636b 2069    if self.lock i
-00030e90: 7320 6e6f 7420 4e6f 6e65 3a0d 0a20 2020  s not None:..   
-00030ea0: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-00030eb0: 636b 2e72 656c 6561 7365 2829 0d0a 0d0a  ck.release()....
-00030ec0: 2020 2020 2020 2020 7265 7475 726e 2074          return t
-00030ed0: 656e 736f 7264 6963 740d 0a0d 0a20 2020  ensordict....   
-00030ee0: 2066 6f72 7761 7264 203d 205f 6361 6c6c   forward = _call
-00030ef0: 0d0a 0d0a 2020 2020 6465 6620 5f69 6e69  ....    def _ini
-00030f00: 7428 7365 6c66 2c20 7465 6e73 6f72 6469  t(self, tensordi
-00030f10: 6374 3a20 5465 6e73 6f72 4469 6374 4261  ct: TensorDictBa
-00030f20: 7365 2c20 6b65 793a 2073 7472 2920 2d3e  se, key: str) ->
-00030f30: 204e 6f6e 653a 0d0a 2020 2020 2020 2020   None:..        
-00030f40: 6966 2073 656c 662e 5f74 6420 6973 204e  if self._td is N
-00030f50: 6f6e 6520 6f72 205f 6170 7065 6e64 5f6c  one or _append_l
-00030f60: 6173 7428 6b65 792c 2022 5f73 756d 2229  ast(key, "_sum")
-00030f70: 206e 6f74 2069 6e20 7365 6c66 2e5f 7464   not in self._td
-00030f80: 2e6b 6579 7328 5472 7565 293a 0d0a 2020  .keys(True):..  
-00030f90: 2020 2020 2020 2020 2020 6966 206b 6579            if key
-00030fa0: 2069 7320 6e6f 7420 6b65 7920 616e 6420   is not key and 
-00030fb0: 6b65 7920 696e 2074 656e 736f 7264 6963  key in tensordic
-00030fc0: 742e 6b65 7973 2829 3a0d 0a20 2020 2020  t.keys():..     
-00030fd0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00030fe0: 2052 756e 7469 6d65 4572 726f 7228 0d0a   RuntimeError(..
-00030ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031000: 2020 2020 6622 436f 6e66 6c69 6374 696e      f"Conflictin
-00031010: 6720 6b65 7920 6e61 6d65 733a 207b 6b65  g key names: {ke
-00031020: 797d 2066 726f 6d20 5665 634e 6f72 6d20  y} from VecNorm 
-00031030: 616e 6420 696e 7075 7420 7465 6e73 6f72  and input tensor
-00031040: 6469 6374 206b 6579 732e 220d 0a20 2020  dict keys."..   
-00031050: 2020 2020 2020 2020 2020 2020 2029 0d0a               )..
-00031060: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00031070: 656c 662e 7368 6170 6573 2069 7320 4e6f  elf.shapes is No
-00031080: 6e65 3a0d 0a20 2020 2020 2020 2020 2020  ne:..           
-00031090: 2020 2020 2074 645f 7669 6577 203d 2074       td_view = t
-000310a0: 656e 736f 7264 6963 742e 7669 6577 282d  ensordict.view(-
-000310b0: 3129 0d0a 2020 2020 2020 2020 2020 2020  1)..            
-000310c0: 2020 2020 7464 5f73 656c 6563 7420 3d20      td_select = 
-000310d0: 7464 5f76 6965 775b 305d 0d0a 2020 2020  td_view[0]..    
-000310e0: 2020 2020 2020 2020 2020 2020 6974 656d              item
-000310f0: 203d 2074 645f 7365 6c65 6374 2e67 6574   = td_select.get
-00031100: 286b 6579 290d 0a20 2020 2020 2020 2020  (key)..         
-00031110: 2020 2020 2020 2064 203d 207b 5f61 7070         d = {_app
-00031120: 656e 645f 6c61 7374 286b 6579 2c20 225f  end_last(key, "_
-00031130: 7375 6d22 293a 2074 6f72 6368 2e7a 6572  sum"): torch.zer
-00031140: 6f73 5f6c 696b 6528 6974 656d 297d 0d0a  os_like(item)}..
-00031150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031160: 642e 7570 6461 7465 287b 5f61 7070 656e  d.update({_appen
-00031170: 645f 6c61 7374 286b 6579 2c20 225f 7373  d_last(key, "_ss
-00031180: 7122 293a 2074 6f72 6368 2e7a 6572 6f73  q"): torch.zeros
-00031190: 5f6c 696b 6528 6974 656d 297d 290d 0a20  _like(item)}).. 
-000311a0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-000311b0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000311c0: 2020 6964 7820 3d20 300d 0a20 2020 2020    idx = 0..     
-000311d0: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-000311e0: 6e5f 6b65 7920 696e 2073 656c 662e 696e  n_key in self.in
-000311f0: 5f6b 6579 733a 0d0a 2020 2020 2020 2020  _keys:..        
-00031200: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-00031210: 6e5f 6b65 7920 213d 206b 6579 3a0d 0a20  n_key != key:.. 
-00031220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031230: 2020 2020 2020 2069 6478 202b 3d20 310d         idx += 1.
-00031240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031250: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
-00031260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031270: 2020 2020 6272 6561 6b0d 0a20 2020 2020      break..     
-00031280: 2020 2020 2020 2020 2020 2073 6861 7065             shape
-00031290: 203d 2073 656c 662e 7368 6170 6573 5b69   = self.shapes[i
-000312a0: 6478 5d0d 0a20 2020 2020 2020 2020 2020  dx]..           
-000312b0: 2020 2020 2069 7465 6d20 3d20 7465 6e73       item = tens
-000312c0: 6f72 6469 6374 2e67 6574 286b 6579 290d  ordict.get(key).
-000312d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000312e0: 2064 203d 207b 0d0a 2020 2020 2020 2020   d = {..        
-000312f0: 2020 2020 2020 2020 2020 2020 5f61 7070              _app
-00031300: 656e 645f 6c61 7374 286b 6579 2c20 225f  end_last(key, "_
-00031310: 7375 6d22 293a 2074 6f72 6368 2e7a 6572  sum"): torch.zer
-00031320: 6f73 280d 0a20 2020 2020 2020 2020 2020  os(..           
-00031330: 2020 2020 2020 2020 2020 2020 2073 6861               sha
-00031340: 7065 2c20 6465 7669 6365 3d69 7465 6d2e  pe, device=item.
-00031350: 6465 7669 6365 2c20 6474 7970 653d 6974  device, dtype=it
-00031360: 656d 2e64 7479 7065 0d0a 2020 2020 2020  em.dtype..      
-00031370: 2020 2020 2020 2020 2020 2020 2020 290d                ).
-00031380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031390: 207d 0d0a 2020 2020 2020 2020 2020 2020   }..            
-000313a0: 2020 2020 642e 7570 6461 7465 280d 0a20      d.update(.. 
-000313b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000313c0: 2020 207b 0d0a 2020 2020 2020 2020 2020     {..          
-000313d0: 2020 2020 2020 2020 2020 2020 2020 5f61                _a
-000313e0: 7070 656e 645f 6c61 7374 286b 6579 2c20  ppend_last(key, 
-000313f0: 225f 7373 7122 293a 2074 6f72 6368 2e7a  "_ssq"): torch.z
-00031400: 6572 6f73 280d 0a20 2020 2020 2020 2020  eros(..         
-00031410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031420: 2020 2073 6861 7065 2c20 6465 7669 6365     shape, device
-00031430: 3d69 7465 6d2e 6465 7669 6365 2c20 6474  =item.device, dt
-00031440: 7970 653d 6974 656d 2e64 7479 7065 0d0a  ype=item.dtype..
-00031450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031460: 2020 2020 2020 2020 290d 0a20 2020 2020          )..     
-00031470: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00031480: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00031490: 2020 290d 0a0d 0a20 2020 2020 2020 2020    )....         
-000314a0: 2020 2064 2e75 7064 6174 6528 0d0a 2020     d.update(..  
-000314b0: 2020 2020 2020 2020 2020 2020 2020 7b0d                {.
-000314c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000314d0: 2020 2020 205f 6170 7065 6e64 5f6c 6173       _append_las
-000314e0: 7428 6b65 792c 2022 5f63 6f75 6e74 2229  t(key, "_count")
-000314f0: 3a20 746f 7263 682e 7a65 726f 7328 0d0a  : torch.zeros(..
-00031500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031510: 2020 2020 2020 2020 312c 2064 6576 6963          1, devic
-00031520: 653d 6974 656d 2e64 6576 6963 652c 2064  e=item.device, d
-00031530: 7479 7065 3d74 6f72 6368 2e66 6c6f 6174  type=torch.float
-00031540: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00031550: 2020 2020 2020 290d 0a20 2020 2020 2020        )..       
-00031560: 2020 2020 2020 2020 207d 0d0a 2020 2020           }..    
-00031570: 2020 2020 2020 2020 290d 0a20 2020 2020          )..     
-00031580: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
-00031590: 7464 2069 7320 4e6f 6e65 3a0d 0a20 2020  td is None:..   
-000315a0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-000315b0: 662e 5f74 6420 3d20 5465 6e73 6f72 4469  f._td = TensorDi
-000315c0: 6374 2864 2c20 6261 7463 685f 7369 7a65  ct(d, batch_size
-000315d0: 3d5b 5d29 0d0a 2020 2020 2020 2020 2020  =[])..          
-000315e0: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
-000315f0: 2020 2020 2020 2020 2073 656c 662e 5f74           self._t
-00031600: 642e 7570 6461 7465 2864 290d 0a20 2020  d.update(d)..   
-00031610: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
-00031620: 2020 2020 2020 2020 7061 7373 0d0a 0d0a          pass....
-00031630: 2020 2020 6465 6620 5f75 7064 6174 6528      def _update(
-00031640: 7365 6c66 2c20 6b65 792c 2076 616c 7565  self, key, value
-00031650: 2c20 4e29 202d 3e20 746f 7263 682e 5465  , N) -> torch.Te
-00031660: 6e73 6f72 3a0d 0a20 2020 2020 2020 205f  nsor:..        _
-00031670: 7375 6d20 3d20 7365 6c66 2e5f 7464 2e67  sum = self._td.g
-00031680: 6574 285f 6170 7065 6e64 5f6c 6173 7428  et(_append_last(
-00031690: 6b65 792c 2022 5f73 756d 2229 290d 0a20  key, "_sum")).. 
-000316a0: 2020 2020 2020 205f 7373 7120 3d20 7365         _ssq = se
-000316b0: 6c66 2e5f 7464 2e67 6574 285f 6170 7065  lf._td.get(_appe
-000316c0: 6e64 5f6c 6173 7428 6b65 792c 2022 5f73  nd_last(key, "_s
-000316d0: 7371 2229 290d 0a20 2020 2020 2020 205f  sq"))..        _
-000316e0: 636f 756e 7420 3d20 7365 6c66 2e5f 7464  count = self._td
-000316f0: 2e67 6574 285f 6170 7065 6e64 5f6c 6173  .get(_append_las
-00031700: 7428 6b65 792c 2022 5f63 6f75 6e74 2229  t(key, "_count")
-00031710: 290d 0a0d 0a20 2020 2020 2020 2076 616c  )....        val
-00031720: 7565 5f73 756d 203d 205f 7375 6d5f 6c65  ue_sum = _sum_le
-00031730: 6674 2876 616c 7565 2c20 5f73 756d 290d  ft(value, _sum).
-00031740: 0a20 2020 2020 2020 205f 7375 6d20 2a3d  .        _sum *=
-00031750: 2073 656c 662e 6465 6361 790d 0a20 2020   self.decay..   
-00031760: 2020 2020 205f 7375 6d20 2b3d 2076 616c       _sum += val
-00031770: 7565 5f73 756d 0d0a 2020 2020 2020 2020  ue_sum..        
-00031780: 7365 6c66 2e5f 7464 2e73 6574 5f28 0d0a  self._td.set_(..
-00031790: 2020 2020 2020 2020 2020 2020 5f61 7070              _app
-000317a0: 656e 645f 6c61 7374 286b 6579 2c20 225f  end_last(key, "_
-000317b0: 7375 6d22 292c 0d0a 2020 2020 2020 2020  sum"),..        
-000317c0: 2020 2020 5f73 756d 2c0d 0a20 2020 2020      _sum,..     
-000317d0: 2020 2029 0d0a 0d0a 2020 2020 2020 2020     )....        
-000317e0: 5f73 7371 203d 2073 656c 662e 5f74 642e  _ssq = self._td.
-000317f0: 6765 7428 5f61 7070 656e 645f 6c61 7374  get(_append_last
-00031800: 286b 6579 2c20 225f 7373 7122 2929 0d0a  (key, "_ssq"))..
-00031810: 2020 2020 2020 2020 7661 6c75 655f 7373          value_ss
-00031820: 7120 3d20 5f73 756d 5f6c 6566 7428 7661  q = _sum_left(va
-00031830: 6c75 652e 706f 7728 3229 2c20 5f73 7371  lue.pow(2), _ssq
-00031840: 290d 0a20 2020 2020 2020 205f 7373 7120  )..        _ssq 
-00031850: 2a3d 2073 656c 662e 6465 6361 790d 0a20  *= self.decay.. 
-00031860: 2020 2020 2020 205f 7373 7120 2b3d 2076         _ssq += v
-00031870: 616c 7565 5f73 7371 0d0a 2020 2020 2020  alue_ssq..      
-00031880: 2020 7365 6c66 2e5f 7464 2e73 6574 5f28    self._td.set_(
-00031890: 0d0a 2020 2020 2020 2020 2020 2020 5f61  ..            _a
-000318a0: 7070 656e 645f 6c61 7374 286b 6579 2c20  ppend_last(key, 
-000318b0: 225f 7373 7122 292c 0d0a 2020 2020 2020  "_ssq"),..      
-000318c0: 2020 2020 2020 5f73 7371 2c0d 0a20 2020        _ssq,..   
-000318d0: 2020 2020 2029 0d0a 0d0a 2020 2020 2020       )....      
-000318e0: 2020 5f63 6f75 6e74 203d 2073 656c 662e    _count = self.
-000318f0: 5f74 642e 6765 7428 5f61 7070 656e 645f  _td.get(_append_
-00031900: 6c61 7374 286b 6579 2c20 225f 636f 756e  last(key, "_coun
-00031910: 7422 2929 0d0a 2020 2020 2020 2020 5f63  t"))..        _c
-00031920: 6f75 6e74 202a 3d20 7365 6c66 2e64 6563  ount *= self.dec
-00031930: 6179 0d0a 2020 2020 2020 2020 5f63 6f75  ay..        _cou
-00031940: 6e74 202b 3d20 4e0d 0a20 2020 2020 2020  nt += N..       
-00031950: 2073 656c 662e 5f74 642e 7365 745f 280d   self._td.set_(.
-00031960: 0a20 2020 2020 2020 2020 2020 205f 6170  .            _ap
-00031970: 7065 6e64 5f6c 6173 7428 6b65 792c 2022  pend_last(key, "
-00031980: 5f63 6f75 6e74 2229 2c0d 0a20 2020 2020  _count"),..     
-00031990: 2020 2020 2020 205f 636f 756e 742c 0d0a         _count,..
-000319a0: 2020 2020 2020 2020 290d 0a0d 0a20 2020          )....   
-000319b0: 2020 2020 206d 6561 6e20 3d20 5f73 756d       mean = _sum
-000319c0: 202f 205f 636f 756e 740d 0a20 2020 2020   / _count..     
-000319d0: 2020 2073 7464 203d 2028 5f73 7371 202f     std = (_ssq /
-000319e0: 205f 636f 756e 7420 2d20 6d65 616e 2e70   _count - mean.p
-000319f0: 6f77 2832 2929 2e63 6c61 6d70 5f6d 696e  ow(2)).clamp_min
-00031a00: 2873 656c 662e 6570 7329 2e73 7172 7428  (self.eps).sqrt(
-00031a10: 290d 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00031a20: 6e20 2876 616c 7565 202d 206d 6561 6e29  n (value - mean)
-00031a30: 202f 2073 7464 2e63 6c61 6d70 5f6d 696e   / std.clamp_min
-00031a40: 2873 656c 662e 6570 7329 0d0a 0d0a 2020  (self.eps)....  
-00031a50: 2020 6465 6620 746f 5f6f 6273 6572 7661    def to_observa
-00031a60: 7469 6f6e 5f6e 6f72 6d28 7365 6c66 2920  tion_norm(self) 
-00031a70: 2d3e 2055 6e69 6f6e 5b43 6f6d 706f 7365  -> Union[Compose
-00031a80: 2c20 4f62 7365 7276 6174 696f 6e4e 6f72  , ObservationNor
-00031a90: 6d5d 3a0d 0a20 2020 2020 2020 2022 2222  m]:..        """
-00031aa0: 436f 6e76 6572 7473 2056 6563 4e6f 726d  Converts VecNorm
-00031ab0: 2069 6e74 6f20 616e 204f 6273 6572 7661   into an Observa
-00031ac0: 7469 6f6e 4e6f 726d 2063 6c61 7373 2074  tionNorm class t
-00031ad0: 6861 7420 6361 6e20 6265 2075 7365 6420  hat can be used 
-00031ae0: 6174 2069 6e66 6572 656e 6365 2074 696d  at inference tim
-00031af0: 652e 2222 220d 0a20 2020 2020 2020 206f  e."""..        o
-00031b00: 7574 203d 205b 5d0d 0a20 2020 2020 2020  ut = []..       
-00031b10: 2066 6f72 206b 6579 2069 6e20 7365 6c66   for key in self
-00031b20: 2e69 6e5f 6b65 7973 3a0d 0a20 2020 2020  .in_keys:..     
-00031b30: 2020 2020 2020 205f 7375 6d20 3d20 7365         _sum = se
-00031b40: 6c66 2e5f 7464 2e67 6574 285f 6170 7065  lf._td.get(_appe
-00031b50: 6e64 5f6c 6173 7428 6b65 792c 2022 5f73  nd_last(key, "_s
-00031b60: 756d 2229 290d 0a20 2020 2020 2020 2020  um"))..         
-00031b70: 2020 205f 7373 7120 3d20 7365 6c66 2e5f     _ssq = self._
-00031b80: 7464 2e67 6574 285f 6170 7065 6e64 5f6c  td.get(_append_l
-00031b90: 6173 7428 6b65 792c 2022 5f73 7371 2229  ast(key, "_ssq")
-00031ba0: 290d 0a20 2020 2020 2020 2020 2020 205f  )..            _
-00031bb0: 636f 756e 7420 3d20 7365 6c66 2e5f 7464  count = self._td
-00031bc0: 2e67 6574 285f 6170 7065 6e64 5f6c 6173  .get(_append_las
-00031bd0: 7428 6b65 792c 2022 5f63 6f75 6e74 2229  t(key, "_count")
-00031be0: 290d 0a20 2020 2020 2020 2020 2020 206d  )..            m
-00031bf0: 6561 6e20 3d20 5f73 756d 202f 205f 636f  ean = _sum / _co
-00031c00: 756e 740d 0a20 2020 2020 2020 2020 2020  unt..           
-00031c10: 2073 7464 203d 2028 5f73 7371 202f 205f   std = (_ssq / _
-00031c20: 636f 756e 7420 2d20 6d65 616e 2e70 6f77  count - mean.pow
-00031c30: 2832 2929 2e63 6c61 6d70 5f6d 696e 2873  (2)).clamp_min(s
-00031c40: 656c 662e 6570 7329 2e73 7172 7428 290d  elf.eps).sqrt().
-00031c50: 0a0d 0a20 2020 2020 2020 2020 2020 205f  ...            _
-00031c60: 6f75 7420 3d20 4f62 7365 7276 6174 696f  out = Observatio
-00031c70: 6e4e 6f72 6d28 0d0a 2020 2020 2020 2020  nNorm(..        
-00031c80: 2020 2020 2020 2020 6c6f 633d 6d65 616e          loc=mean
-00031c90: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
-00031ca0: 2020 2073 6361 6c65 3d73 7464 2c0d 0a20     scale=std,.. 
-00031cb0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00031cc0: 7461 6e64 6172 645f 6e6f 726d 616c 3d54  tandard_normal=T
-00031cd0: 7275 652c 0d0a 2020 2020 2020 2020 2020  rue,..          
-00031ce0: 2020 2020 2020 696e 5f6b 6579 733d 7365        in_keys=se
-00031cf0: 6c66 2e69 6e5f 6b65 7973 2c0d 0a20 2020  lf.in_keys,..   
-00031d00: 2020 2020 2020 2020 2029 0d0a 2020 2020           )..    
-00031d10: 2020 2020 2020 2020 6966 206c 656e 2873          if len(s
-00031d20: 656c 662e 696e 5f6b 6579 7329 203d 3d20  elf.in_keys) == 
-00031d30: 313a 0d0a 2020 2020 2020 2020 2020 2020  1:..            
-00031d40: 2020 2020 7265 7475 726e 205f 6f75 740d      return _out.
-00031d50: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00031d60: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
-00031d70: 2020 2020 6f75 7420 2b3d 204f 6273 6572      out += Obser
-00031d80: 7661 7469 6f6e 4e6f 726d 0d0a 2020 2020  vationNorm..    
-00031d90: 2020 2020 7265 7475 726e 2043 6f6d 706f      return Compo
-00031da0: 7365 282a 6f75 7429 0d0a 0d0a 2020 2020  se(*out)....    
-00031db0: 4073 7461 7469 636d 6574 686f 640d 0a20  @staticmethod.. 
-00031dc0: 2020 2064 6566 2062 7569 6c64 5f74 645f     def build_td_
-00031dd0: 666f 725f 7368 6172 6564 5f76 6563 6e6f  for_shared_vecno
-00031de0: 726d 280d 0a20 2020 2020 2020 2065 6e76  rm(..        env
-00031df0: 3a20 456e 7642 6173 652c 0d0a 2020 2020  : EnvBase,..    
-00031e00: 2020 2020 6b65 7973 3a20 4f70 7469 6f6e      keys: Option
-00031e10: 616c 5b53 6571 7565 6e63 655b 7374 725d  al[Sequence[str]
-00031e20: 5d20 3d20 4e6f 6e65 2c0d 0a20 2020 2020  ] = None,..     
-00031e30: 2020 206d 656d 6d61 703a 2062 6f6f 6c20     memmap: bool 
-00031e40: 3d20 4661 6c73 652c 0d0a 2020 2020 2920  = False,..    ) 
-00031e50: 2d3e 2054 656e 736f 7244 6963 7442 6173  -> TensorDictBas
-00031e60: 653a 0d0a 2020 2020 2020 2020 2222 2243  e:..        """C
-00031e70: 7265 6174 6573 2061 2073 6861 7265 6420  reates a shared 
-00031e80: 7465 6e73 6f72 6469 6374 2066 6f72 206e  tensordict for n
-00031e90: 6f72 6d61 6c69 7a61 7469 6f6e 2061 6372  ormalization acr
-00031ea0: 6f73 7320 7072 6f63 6573 7365 732e 0d0a  oss processes...
-00031eb0: 0d0a 2020 2020 2020 2020 4172 6773 3a0d  ..        Args:.
-00031ec0: 0a20 2020 2020 2020 2020 2020 2065 6e76  .            env
-00031ed0: 2028 456e 7642 6173 6529 3a20 6578 616d   (EnvBase): exam
-00031ee0: 706c 6520 656e 7669 726f 6e6d 656e 7420  ple environment 
-00031ef0: 746f 2062 6520 7573 6564 2074 6f20 6372  to be used to cr
-00031f00: 6561 7465 2074 6865 0d0a 2020 2020 2020  eate the..      
-00031f10: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
-00031f20: 6469 6374 0d0a 2020 2020 2020 2020 2020  dict..          
-00031f30: 2020 6b65 7973 2028 7365 7175 656e 6365    keys (sequence
-00031f40: 206f 6620 4e65 7374 6564 4b65 792c 206f   of NestedKey, o
-00031f50: 7074 696f 6e61 6c29 3a20 6b65 7973 2074  ptional): keys t
-00031f60: 6861 740d 0a20 2020 2020 2020 2020 2020  hat..           
-00031f70: 2020 2020 2068 6176 6520 746f 2062 6520       have to be 
-00031f80: 6e6f 726d 616c 697a 6564 2e20 4465 6661  normalized. Defa
-00031f90: 756c 7420 6973 2060 5b22 6e65 7874 222c  ult is `["next",
-00031fa0: 2022 7265 7761 7264 225d 600d 0a20 2020   "reward"]`..   
-00031fb0: 2020 2020 2020 2020 206d 656d 6d61 7020           memmap 
-00031fc0: 2862 6f6f 6c29 3a20 6966 2060 6054 7275  (bool): if ``Tru
-00031fd0: 6560 602c 2074 6865 2072 6573 756c 7469  e``, the resulti
-00031fe0: 6e67 2074 656e 736f 7264 6963 7420 7769  ng tensordict wi
-00031ff0: 6c6c 2062 6520 6361 7374 2069 6e74 6f0d  ll be cast into.
-00032000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032010: 206d 656d 6d6f 7279 206d 6170 2028 7573   memmory map (us
-00032020: 696e 6720 606d 656d 6d61 705f 2829 6029  ing `memmap_()`)
-00032030: 2e20 4f74 6865 7277 6973 652c 2074 6865  . Otherwise, the
-00032040: 2074 656e 736f 7264 6963 740d 0a20 2020   tensordict..   
-00032050: 2020 2020 2020 2020 2020 2020 2077 696c               wil
-00032060: 6c20 6265 2070 6c61 6365 6420 696e 2073  l be placed in s
-00032070: 6861 7265 6420 6d65 6d6f 7279 2e0d 0a0d  hared memory....
-00032080: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-00032090: 3a0d 0a20 2020 2020 2020 2020 2020 2041  :..            A
-000320a0: 206d 656d 6f72 7920 696e 2073 6861 7265   memory in share
-000320b0: 6420 6d65 6d6f 7279 2074 6f20 6265 2073  d memory to be s
-000320c0: 656e 7420 746f 2065 6163 6820 7072 6f63  ent to each proc
-000320d0: 6573 732e 0d0a 0d0a 2020 2020 2020 2020  ess.....        
-000320e0: 4578 616d 706c 6573 3a0d 0a20 2020 2020  Examples:..     
-000320f0: 2020 2020 2020 203e 3e3e 2066 726f 6d20         >>> from 
-00032100: 746f 7263 6820 696d 706f 7274 206d 756c  torch import mul
-00032110: 7469 7072 6f63 6573 7369 6e67 2061 7320  tiprocessing as 
-00032120: 6d70 0d0a 2020 2020 2020 2020 2020 2020  mp..            
-00032130: 3e3e 3e20 7175 6575 6520 3d20 6d70 2e51  >>> queue = mp.Q
-00032140: 7565 7565 2829 0d0a 2020 2020 2020 2020  ueue()..        
-00032150: 2020 2020 3e3e 3e20 656e 7620 3d20 6d61      >>> env = ma
-00032160: 6b65 5f65 6e76 2829 0d0a 2020 2020 2020  ke_env()..      
-00032170: 2020 2020 2020 3e3e 3e20 7464 5f73 6861        >>> td_sha
-00032180: 7265 6420 3d20 5665 634e 6f72 6d2e 6275  red = VecNorm.bu
-00032190: 696c 645f 7464 5f66 6f72 5f73 6861 7265  ild_td_for_share
-000321a0: 645f 7665 636e 6f72 6d28 656e 762c 0d0a  d_vecnorm(env,..
-000321b0: 2020 2020 2020 2020 2020 2020 2e2e 2e20              ... 
-000321c0: 2020 2020 5b22 6e65 7874 222c 2022 7265      ["next", "re
-000321d0: 7761 7264 225d 290d 0a20 2020 2020 2020  ward"])..       
-000321e0: 2020 2020 203e 3e3e 2061 7373 6572 7420       >>> assert 
-000321f0: 7464 5f73 6861 7265 642e 6973 5f73 6861  td_shared.is_sha
-00032200: 7265 6428 290d 0a20 2020 2020 2020 2020  red()..         
-00032210: 2020 203e 3e3e 2071 7565 7565 2e70 7574     >>> queue.put
-00032220: 2874 645f 7368 6172 6564 290d 0a20 2020  (td_shared)..   
-00032230: 2020 2020 2020 2020 203e 3e3e 2023 206f           >>> # o
-00032240: 6e20 776f 726b 6572 730d 0a20 2020 2020  n workers..     
-00032250: 2020 2020 2020 203e 3e3e 2076 203d 2056         >>> v = V
-00032260: 6563 4e6f 726d 2873 6861 7265 645f 7464  ecNorm(shared_td
-00032270: 3d71 7565 7565 2e67 6574 2829 290d 0a20  =queue.get()).. 
-00032280: 2020 2020 2020 2020 2020 203e 3e3e 2065             >>> e
-00032290: 6e76 203d 2054 7261 6e73 666f 726d 6564  nv = Transformed
-000322a0: 456e 7628 6d61 6b65 5f65 6e76 2829 2c20  Env(make_env(), 
-000322b0: 7629 0d0a 0d0a 2020 2020 2020 2020 2222  v)....        ""
-000322c0: 220d 0a20 2020 2020 2020 2072 6169 7365  "..        raise
-000322d0: 204e 6f74 496d 706c 656d 656e 7465 6445   NotImplementedE
-000322e0: 7272 6f72 2822 7468 6973 2066 6561 7475  rror("this featu
-000322f0: 7265 2069 7320 6375 7272 656e 746c 7920  re is currently 
-00032300: 7075 7420 6f6e 2068 6f6c 642e 2229 0d0a  put on hold.")..
-00032310: 2020 2020 2020 2020 7365 7020 3d20 222e          sep = ".
-00032320: 2d7c 2d2e 220d 0a20 2020 2020 2020 2069  -|-."..        i
-00032330: 6620 6b65 7973 2069 7320 4e6f 6e65 3a0d  f keys is None:.
-00032340: 0a20 2020 2020 2020 2020 2020 206b 6579  .            key
-00032350: 7320 3d20 5b22 6e65 7874 222c 2022 7265  s = ["next", "re
-00032360: 7761 7264 225d 0d0a 2020 2020 2020 2020  ward"]..        
-00032370: 7464 203d 206d 616b 655f 7465 6e73 6f72  td = make_tensor
-00032380: 6469 6374 2865 6e76 290d 0a20 2020 2020  dict(env)..     
-00032390: 2020 206b 6579 7320 3d20 7b6b 6579 2066     keys = {key f
-000323a0: 6f72 206b 6579 2069 6e20 7464 2e6b 6579  or key in td.key
-000323b0: 7328 2920 6966 206b 6579 2069 6e20 6b65  s() if key in ke
-000323c0: 7973 7d0d 0a20 2020 2020 2020 2074 645f  ys}..        td_
-000323d0: 7365 6c65 6374 203d 2074 642e 7365 6c65  select = td.sele
-000323e0: 6374 282a 6b65 7973 290d 0a20 2020 2020  ct(*keys)..     
-000323f0: 2020 2074 645f 7365 6c65 6374 203d 2074     td_select = t
-00032400: 645f 7365 6c65 6374 2e66 6c61 7474 656e  d_select.flatten
-00032410: 5f6b 6579 7328 7365 7029 0d0a 2020 2020  _keys(sep)..    
-00032420: 2020 2020 6966 2074 642e 6261 7463 685f      if td.batch_
-00032430: 6469 6d73 3a0d 0a20 2020 2020 2020 2020  dims:..         
-00032440: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
-00032450: 4572 726f 7228 0d0a 2020 2020 2020 2020  Error(..        
-00032460: 2020 2020 2020 2020 6622 5665 634e 6f72          f"VecNor
-00032470: 6d20 7368 6f75 6c64 2062 6520 7573 6564  m should be used
-00032480: 2077 6974 6820 6e6f 6e2d 6261 7463 6865   with non-batche
-00032490: 6420 656e 7669 726f 6e6d 656e 7473 2e20  d environments. 
-000324a0: 220d 0a20 2020 2020 2020 2020 2020 2020  "..             
-000324b0: 2020 2066 2247 6f74 2062 6174 6368 5f73     f"Got batch_s
-000324c0: 697a 653d 7b74 642e 6261 7463 685f 7369  ize={td.batch_si
-000324d0: 7a65 7d22 0d0a 2020 2020 2020 2020 2020  ze}"..          
-000324e0: 2020 290d 0a20 2020 2020 2020 206b 6579    )..        key
-000324f0: 7320 3d20 6c69 7374 2874 645f 7365 6c65  s = list(td_sele
-00032500: 6374 2e6b 6579 7328 2929 0d0a 2020 2020  ct.keys())..    
-00032510: 2020 2020 666f 7220 6b65 7920 696e 206b      for key in k
-00032520: 6579 733a 0d0a 2020 2020 2020 2020 2020  eys:..          
-00032530: 2020 7464 5f73 656c 6563 742e 7365 7428    td_select.set(
-00032540: 5f61 7070 656e 645f 6c61 7374 286b 6579  _append_last(key
-00032550: 2c20 225f 7373 7122 292c 2074 645f 7365  , "_ssq"), td_se
-00032560: 6c65 6374 2e67 6574 286b 6579 292e 636c  lect.get(key).cl
-00032570: 6f6e 6528 2929 0d0a 2020 2020 2020 2020  one())..        
-00032580: 2020 2020 7464 5f73 656c 6563 742e 7365      td_select.se
-00032590: 7428 0d0a 2020 2020 2020 2020 2020 2020  t(..            
-000325a0: 2020 2020 5f61 7070 656e 645f 6c61 7374      _append_last
-000325b0: 286b 6579 2c20 225f 636f 756e 7422 292c  (key, "_count"),
-000325c0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000325d0: 2020 746f 7263 682e 7a65 726f 7328 0d0a    torch.zeros(..
-000325e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000325f0: 2020 2020 2a74 642e 6261 7463 685f 7369      *td.batch_si
-00032600: 7a65 2c0d 0a20 2020 2020 2020 2020 2020  ze,..           
-00032610: 2020 2020 2020 2020 2031 2c0d 0a20 2020           1,..   
-00032620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032630: 2064 6576 6963 653d 7464 5f73 656c 6563   device=td_selec
-00032640: 742e 6465 7669 6365 2c0d 0a20 2020 2020  t.device,..     
-00032650: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00032660: 7479 7065 3d74 6f72 6368 2e66 6c6f 6174  type=torch.float
-00032670: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
-00032680: 2020 2029 2c0d 0a20 2020 2020 2020 2020     ),..         
-00032690: 2020 2029 0d0a 2020 2020 2020 2020 2020     )..          
-000326a0: 2020 7464 5f73 656c 6563 742e 7265 6e61    td_select.rena
-000326b0: 6d65 5f6b 6579 5f28 6b65 792c 205f 6170  me_key_(key, _ap
-000326c0: 7065 6e64 5f6c 6173 7428 6b65 792c 2022  pend_last(key, "
-000326d0: 5f73 756d 2229 290d 0a20 2020 2020 2020  _sum"))..       
-000326e0: 2074 645f 7365 6c65 6374 2e65 7863 6c75   td_select.exclu
-000326f0: 6465 282a 6b65 7973 292e 7a65 726f 5f28  de(*keys).zero_(
-00032700: 290d 0a20 2020 2020 2020 2074 645f 7365  )..        td_se
-00032710: 6c65 6374 203d 2074 645f 7365 6c65 6374  lect = td_select
-00032720: 2e75 6e66 6c61 7474 656e 5f6b 6579 7328  .unflatten_keys(
-00032730: 7365 7029 0d0a 2020 2020 2020 2020 6966  sep)..        if
-00032740: 206d 656d 6d61 703a 0d0a 2020 2020 2020   memmap:..      
-00032750: 2020 2020 2020 7265 7475 726e 2074 645f        return td_
-00032760: 7365 6c65 6374 2e6d 656d 6d61 705f 2829  select.memmap_()
-00032770: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00032780: 2074 645f 7365 6c65 6374 2e73 6861 7265   td_select.share
-00032790: 5f6d 656d 6f72 795f 2829 0d0a 0d0a 2020  _memory_()....  
-000327a0: 2020 6465 6620 6765 745f 6578 7472 615f    def get_extra_
-000327b0: 7374 6174 6528 7365 6c66 2920 2d3e 204f  state(self) -> O
-000327c0: 7264 6572 6564 4469 6374 3a0d 0a20 2020  rderedDict:..   
-000327d0: 2020 2020 2072 6574 7572 6e20 636f 6c6c       return coll
-000327e0: 6563 7469 6f6e 732e 4f72 6465 7265 6444  ections.OrderedD
-000327f0: 6963 7428 7b22 6c6f 636b 223a 2073 656c  ict({"lock": sel
-00032800: 662e 6c6f 636b 2c20 2274 6422 3a20 7365  f.lock, "td": se
-00032810: 6c66 2e5f 7464 7d29 0d0a 0d0a 2020 2020  lf._td})....    
-00032820: 6465 6620 7365 745f 6578 7472 615f 7374  def set_extra_st
-00032830: 6174 6528 7365 6c66 2c20 7374 6174 653a  ate(self, state:
-00032840: 204f 7264 6572 6564 4469 6374 2920 2d3e   OrderedDict) ->
-00032850: 204e 6f6e 653a 0d0a 2020 2020 2020 2020   None:..        
-00032860: 6c6f 636b 203d 2073 7461 7465 5b22 6c6f  lock = state["lo
-00032870: 636b 225d 0d0a 2020 2020 2020 2020 6966  ck"]..        if
-00032880: 206c 6f63 6b20 6973 206e 6f74 204e 6f6e   lock is not Non
-00032890: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
-000328a0: 2222 220d 0a20 2020 2020 2020 2020 2020  """..           
-000328b0: 2073 696e 6365 206c 6f63 6b73 2063 616e   since locks can
-000328c0: 2774 2062 6520 7365 7269 616c 697a 6564  't be serialized
-000328d0: 2c20 7765 2068 6176 6520 7573 6520 6361  , we have use ca
-000328e0: 7365 7320 666f 7220 7374 7269 7070 696e  ses for strippin
-000328f0: 6720 7468 656d 0d0a 2020 2020 2020 2020  g them..        
-00032900: 2020 2020 666f 7220 6578 616d 706c 6520      for example 
-00032910: 696e 2050 6172 616c 6c65 6c45 6e76 2c20  in ParallelEnv, 
-00032920: 696e 2077 6869 6368 2063 6173 6520 6b65  in which case ke
-00032930: 6570 2074 6865 206c 6f63 6b20 7765 2061  ep the lock we a
-00032940: 6c72 6561 6479 2068 6176 650d 0a20 2020  lready have..   
-00032950: 2020 2020 2020 2020 2074 6f20 6176 6f69           to avoi
-00032960: 6420 616e 2075 7064 6174 6564 2074 656e  d an updated ten
-00032970: 736f 7220 6469 6374 2062 6569 6e67 2073  sor dict being s
-00032980: 656e 7420 6265 7477 6565 6e20 7072 6f63  ent between proc
-00032990: 6573 7365 7320 746f 2065 7261 7365 206c  esses to erase l
-000329a0: 6f63 6b73 0d0a 2020 2020 2020 2020 2020  ocks..          
-000329b0: 2020 2222 220d 0a20 2020 2020 2020 2020    """..         
-000329c0: 2020 2073 656c 662e 6c6f 636b 203d 206c     self.lock = l
-000329d0: 6f63 6b0d 0a20 2020 2020 2020 2074 6420  ock..        td 
-000329e0: 3d20 7374 6174 655b 2274 6422 5d0d 0a20  = state["td"].. 
-000329f0: 2020 2020 2020 2069 6620 7464 2069 7320         if td is 
-00032a00: 6e6f 7420 4e6f 6e65 2061 6e64 206e 6f74  not None and not
-00032a10: 2074 642e 6973 5f73 6861 7265 6428 293a   td.is_shared():
-00032a20: 0d0a 2020 2020 2020 2020 2020 2020 7261  ..            ra
-00032a30: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
-00032a40: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
-00032a50: 2020 2022 4f6e 6c79 2073 6861 7265 6420     "Only shared 
-00032a60: 7465 6e73 6f72 6469 6374 7320 6361 6e20  tensordicts can 
-00032a70: 6265 2073 6574 2069 6e20 5665 634e 6f72  be set in VecNor
-00032a80: 6d20 7472 616e 7366 6f72 6d73 220d 0a20  m transforms".. 
-00032a90: 2020 2020 2020 2020 2020 2029 0d0a 2020             )..  
-00032aa0: 2020 2020 2020 7365 6c66 2e5f 7464 203d        self._td =
-00032ab0: 2074 640d 0a0d 0a20 2020 2064 6566 205f   td....    def _
-00032ac0: 5f72 6570 725f 5f28 7365 6c66 2920 2d3e  _repr__(self) ->
-00032ad0: 2073 7472 3a0d 0a20 2020 2020 2020 2072   str:..        r
-00032ae0: 6574 7572 6e20 280d 0a20 2020 2020 2020  eturn (..       
-00032af0: 2020 2020 2066 227b 7365 6c66 2e5f 5f63       f"{self.__c
-00032b00: 6c61 7373 5f5f 2e5f 5f6e 616d 655f 5f7d  lass__.__name__}
-00032b10: 2864 6563 6179 3d7b 7365 6c66 2e64 6563  (decay={self.dec
-00032b20: 6179 3a34 2e34 667d 2c22 0d0a 2020 2020  ay:4.4f},"..    
-00032b30: 2020 2020 2020 2020 6622 6570 733d 7b73          f"eps={s
-00032b40: 656c 662e 6570 733a 342e 3466 7d2c 206b  elf.eps:4.4f}, k
-00032b50: 6579 733d 7b73 656c 662e 696e 5f6b 6579  eys={self.in_key
-00032b60: 737d 2922 0d0a 2020 2020 2020 2020 290d  s})"..        ).
-00032b70: 0a0d 0a20 2020 2064 6566 205f 5f67 6574  ...    def __get
-00032b80: 7374 6174 655f 5f28 7365 6c66 2920 2d3e  state__(self) ->
-00032b90: 2044 6963 745b 7374 722c 2041 6e79 5d3a   Dict[str, Any]:
-00032ba0: 0d0a 2020 2020 2020 2020 7374 6174 6520  ..        state 
-00032bb0: 3d20 7365 6c66 2e5f 5f64 6963 745f 5f2e  = self.__dict__.
-00032bc0: 636f 7079 2829 0d0a 2020 2020 2020 2020  copy()..        
-00032bd0: 5f6c 6f63 6b20 3d20 7374 6174 652e 706f  _lock = state.po
-00032be0: 7028 226c 6f63 6b22 2c20 4e6f 6e65 290d  p("lock", None).
-00032bf0: 0a20 2020 2020 2020 2069 6620 5f6c 6f63  .        if _loc
-00032c00: 6b20 6973 206e 6f74 204e 6f6e 653a 0d0a  k is not None:..
-00032c10: 2020 2020 2020 2020 2020 2020 7374 6174              stat
-00032c20: 655b 226c 6f63 6b5f 706c 6163 6568 6f6c  e["lock_placehol
-00032c30: 6465 7222 5d20 3d20 4e6f 6e65 0d0a 2020  der"] = None..  
-00032c40: 2020 2020 2020 7265 7475 726e 2073 7461        return sta
-00032c50: 7465 0d0a 0d0a 2020 2020 6465 6620 5f5f  te....    def __
-00032c60: 7365 7473 7461 7465 5f5f 2873 656c 662c  setstate__(self,
-00032c70: 2073 7461 7465 3a20 4469 6374 5b73 7472   state: Dict[str
-00032c80: 2c20 416e 795d 293a 0d0a 2020 2020 2020  , Any]):..      
-00032c90: 2020 6966 2022 6c6f 636b 5f70 6c61 6365    if "lock_place
-00032ca0: 686f 6c64 6572 2220 696e 2073 7461 7465  holder" in state
-00032cb0: 3a0d 0a20 2020 2020 2020 2020 2020 2073  :..            s
-00032cc0: 7461 7465 2e70 6f70 2822 6c6f 636b 5f70  tate.pop("lock_p
-00032cd0: 6c61 6365 686f 6c64 6572 2229 0d0a 2020  laceholder")..  
-00032ce0: 2020 2020 2020 2020 2020 5f6c 6f63 6b20            _lock 
-00032cf0: 3d20 6d70 2e4c 6f63 6b28 290d 0a20 2020  = mp.Lock()..   
-00032d00: 2020 2020 2020 2020 2073 7461 7465 5b22           state["
-00032d10: 6c6f 636b 225d 203d 205f 6c6f 636b 0d0a  lock"] = _lock..
-00032d20: 2020 2020 2020 2020 7365 6c66 2e5f 5f64          self.__d
-00032d30: 6963 745f 5f2e 7570 6461 7465 2873 7461  ict__.update(sta
-00032d40: 7465 290d 0a0d 0a20 2020 2040 5f61 7070  te)....    @_app
-00032d50: 6c79 5f74 6f5f 636f 6d70 6f73 6974 650d  ly_to_composite.
-00032d60: 0a20 2020 2064 6566 2074 7261 6e73 666f  .    def transfo
-00032d70: 726d 5f6f 6273 6572 7661 7469 6f6e 5f73  rm_observation_s
-00032d80: 7065 6328 7365 6c66 2c20 6f62 7365 7276  pec(self, observ
-00032d90: 6174 696f 6e5f 7370 6563 3a20 5465 6e73  ation_spec: Tens
-00032da0: 6f72 5370 6563 2920 2d3e 2054 656e 736f  orSpec) -> Tenso
-00032db0: 7253 7065 633a 0d0a 2020 2020 2020 2020  rSpec:..        
-00032dc0: 6966 2069 7369 6e73 7461 6e63 6528 6f62  if isinstance(ob
-00032dd0: 7365 7276 6174 696f 6e5f 7370 6563 2c20  servation_spec, 
-00032de0: 426f 756e 6465 6454 656e 736f 7253 7065  BoundedTensorSpe
-00032df0: 6329 3a0d 0a20 2020 2020 2020 2020 2020  c):..           
-00032e00: 2072 6574 7572 6e20 556e 626f 756e 6465   return Unbounde
-00032e10: 6443 6f6e 7469 6e75 6f75 7354 656e 736f  dContinuousTenso
-00032e20: 7253 7065 6328 0d0a 2020 2020 2020 2020  rSpec(..        
-00032e30: 2020 2020 2020 2020 7368 6170 653d 6f62          shape=ob
-00032e40: 7365 7276 6174 696f 6e5f 7370 6563 2e73  servation_spec.s
-00032e50: 6861 7065 2c0d 0a20 2020 2020 2020 2020  hape,..         
-00032e60: 2020 2020 2020 2064 7479 7065 3d6f 6273         dtype=obs
-00032e70: 6572 7661 7469 6f6e 5f73 7065 632e 6474  ervation_spec.dt
-00032e80: 7970 652c 0d0a 2020 2020 2020 2020 2020  ype,..          
-00032e90: 2020 2020 2020 6465 7669 6365 3d6f 6273        device=obs
-00032ea0: 6572 7661 7469 6f6e 5f73 7065 632e 6465  ervation_spec.de
-00032eb0: 7669 6365 2c0d 0a20 2020 2020 2020 2020  vice,..         
-00032ec0: 2020 2029 0d0a 2020 2020 2020 2020 7265     )..        re
-00032ed0: 7475 726e 206f 6273 6572 7661 7469 6f6e  turn observation
-00032ee0: 5f73 7065 630d 0a0d 0a20 2020 2023 2054  _spec....    # T
-00032ef0: 4f44 4f3a 2069 6e63 6f72 706f 7261 7465  ODO: incorporate
-00032f00: 2074 6869 7320 7768 656e 2074 7261 636b   this when track
-00032f10: 6572 7320 6172 6520 7061 7274 206f 6620  ers are part of 
-00032f20: 7468 6520 6461 7461 0d0a 2020 2020 2320  the data..    # 
-00032f30: 6465 6620 7472 616e 7366 6f72 6d5f 6f75  def transform_ou
-00032f40: 7470 7574 5f73 7065 6328 7365 6c66 2c20  tput_spec(self, 
-00032f50: 6f75 7470 7574 5f73 7065 633a 2054 656e  output_spec: Ten
-00032f60: 736f 7253 7065 6329 202d 3e20 5465 6e73  sorSpec) -> Tens
-00032f70: 6f72 5370 6563 3a0d 0a20 2020 2023 2020  orSpec:..    #  
-00032f80: 2020 206f 6273 6572 7661 7469 6f6e 5f73     observation_s
-00032f90: 7065 6320 3d20 6f75 7470 7574 5f73 7065  pec = output_spe
-00032fa0: 635b 2266 756c 6c5f 6f62 7365 7276 6174  c["full_observat
-00032fb0: 696f 6e5f 7370 6563 225d 0d0a 2020 2020  ion_spec"]..    
-00032fc0: 2320 2020 2020 7265 7761 7264 5f73 7065  #     reward_spe
-00032fd0: 6320 3d20 6f75 7470 7574 5f73 7065 635b  c = output_spec[
-00032fe0: 2266 756c 6c5f 7265 7761 7264 5f73 7065  "full_reward_spe
-00032ff0: 6322 5d0d 0a20 2020 2023 2020 2020 2066  c"]..    #     f
-00033000: 6f72 206b 6579 2069 6e20 6c69 7374 286f  or key in list(o
-00033010: 6273 6572 7661 7469 6f6e 5f73 7065 632e  bservation_spec.
-00033020: 6b65 7973 2854 7275 652c 2054 7275 6529  keys(True, True)
-00033030: 293a 0d0a 2020 2020 2320 2020 2020 2020  ):..    #       
-00033040: 2020 6966 206b 6579 2069 6e20 7365 6c66    if key in self
-00033050: 2e69 6e5f 6b65 7973 3a0d 0a20 2020 2023  .in_keys:..    #
-00033060: 2020 2020 2020 2020 2020 2020 206f 6273               obs
-00033070: 6572 7661 7469 6f6e 5f73 7065 635b 5f61  ervation_spec[_a
-00033080: 7070 656e 645f 6c61 7374 286b 6579 2c20  ppend_last(key, 
-00033090: 225f 7375 6d22 295d 203d 206f 6273 6572  "_sum")] = obser
-000330a0: 7661 7469 6f6e 5f73 7065 635b 6b65 795d  vation_spec[key]
-000330b0: 2e63 6c6f 6e65 2829 0d0a 2020 2020 2320  .clone()..    # 
-000330c0: 2020 2020 2020 2020 2020 2020 6f62 7365              obse
-000330d0: 7276 6174 696f 6e5f 7370 6563 5b5f 6170  rvation_spec[_ap
-000330e0: 7065 6e64 5f6c 6173 7428 6b65 792c 2022  pend_last(key, "
-000330f0: 5f73 7371 2229 5d20 3d20 6f62 7365 7276  _ssq")] = observ
-00033100: 6174 696f 6e5f 7370 6563 5b6b 6579 5d2e  ation_spec[key].
-00033110: 636c 6f6e 6528 290d 0a20 2020 2023 2020  clone()..    #  
-00033120: 2020 2020 2020 2020 2020 206f 6273 6572             obser
-00033130: 7661 7469 6f6e 5f73 7065 635b 5f61 7070  vation_spec[_app
-00033140: 656e 645f 6c61 7374 286b 6579 2c20 225f  end_last(key, "_
-00033150: 636f 756e 7422 295d 203d 206f 6273 6572  count")] = obser
-00033160: 7661 7469 6f6e 5f73 7065 635b 6b65 795d  vation_spec[key]
-00033170: 2e63 6c6f 6e65 2829 0d0a 2020 2020 2320  .clone()..    # 
-00033180: 2020 2020 666f 7220 6b65 7920 696e 206c      for key in l
-00033190: 6973 7428 7265 7761 7264 5f73 7065 632e  ist(reward_spec.
-000331a0: 6b65 7973 2854 7275 652c 2054 7275 6529  keys(True, True)
-000331b0: 293a 0d0a 2020 2020 2320 2020 2020 2020  ):..    #       
-000331c0: 2020 6966 206b 6579 2069 6e20 7365 6c66    if key in self
-000331d0: 2e69 6e5f 6b65 7973 3a0d 0a20 2020 2023  .in_keys:..    #
-000331e0: 2020 2020 2020 2020 2020 2020 206f 6273               obs
-000331f0: 6572 7661 7469 6f6e 5f73 7065 635b 5f61  ervation_spec[_a
-00033200: 7070 656e 645f 6c61 7374 286b 6579 2c20  ppend_last(key, 
-00033210: 225f 7375 6d22 295d 203d 2072 6577 6172  "_sum")] = rewar
-00033220: 645f 7370 6563 5b6b 6579 5d2e 636c 6f6e  d_spec[key].clon
-00033230: 6528 290d 0a20 2020 2023 2020 2020 2020  e()..    #      
-00033240: 2020 2020 2020 206f 6273 6572 7661 7469         observati
-00033250: 6f6e 5f73 7065 635b 5f61 7070 656e 645f  on_spec[_append_
-00033260: 6c61 7374 286b 6579 2c20 225f 7373 7122  last(key, "_ssq"
-00033270: 295d 203d 2072 6577 6172 645f 7370 6563  )] = reward_spec
-00033280: 5b6b 6579 5d2e 636c 6f6e 6528 290d 0a20  [key].clone().. 
-00033290: 2020 2023 2020 2020 2020 2020 2020 2020     #            
-000332a0: 206f 6273 6572 7661 7469 6f6e 5f73 7065   observation_spe
-000332b0: 635b 5f61 7070 656e 645f 6c61 7374 286b  c[_append_last(k
-000332c0: 6579 2c20 225f 636f 756e 7422 295d 203d  ey, "_count")] =
-000332d0: 2072 6577 6172 645f 7370 6563 5b6b 6579   reward_spec[key
-000332e0: 5d2e 636c 6f6e 6528 290d 0a20 2020 2023  ].clone()..    #
-000332f0: 2020 2020 2072 6574 7572 6e20 6f75 7470       return outp
-00033300: 7574 5f73 7065 630d 0a0d 0a0d 0a63 6c61  ut_spec......cla
-00033310: 7373 2052 6577 6172 6453 756d 2854 7261  ss RewardSum(Tra
-00033320: 6e73 666f 726d 293a 0d0a 2020 2020 2222  nsform):..    ""
-00033330: 2254 7261 636b 7320 6570 6973 6f64 6520  "Tracks episode 
-00033340: 6375 6d75 6c61 7469 7665 2072 6577 6172  cumulative rewar
-00033350: 6473 2e0d 0a0d 0a20 2020 2054 6869 7320  ds.....    This 
-00033360: 7472 616e 7366 6f72 6d20 6163 6365 7074  transform accept
-00033370: 7320 6120 6c69 7374 206f 6620 7465 6e73  s a list of tens
-00033380: 6f72 6469 6374 2072 6577 6172 6420 6b65  ordict reward ke
-00033390: 7973 2028 692e 652e 20c2 b469 6e5f 6b65  ys (i.e. ..in_ke
-000333a0: 7973 c2b4 2920 616e 6420 7472 6163 6b73  ys..) and tracks
-000333b0: 2074 6865 6972 2063 756d 756c 6174 6976   their cumulativ
-000333c0: 650d 0a20 2020 2076 616c 7565 2061 6c6f  e..    value alo
-000333d0: 6e67 2074 6865 2074 696d 6520 6469 6d65  ng the time dime
-000333e0: 6e73 696f 6e20 666f 7220 6561 6368 2065  nsion for each e
-000333f0: 7069 736f 6465 2e0d 0a0d 0a20 2020 2057  pisode.....    W
-00033400: 6865 6e20 6361 6c6c 6564 2c20 7468 6520  hen called, the 
-00033410: 7472 616e 7366 6f72 6d20 7772 6974 6573  transform writes
-00033420: 2061 206e 6577 2074 656e 736f 7264 6963   a new tensordic
-00033430: 7420 656e 7472 7920 666f 7220 6561 6368  t entry for each
-00033440: 2060 6069 6e5f 6b65 7960 6020 6e61 6d65   ``in_key`` name
-00033450: 640d 0a20 2020 2060 6065 7069 736f 6465  d..    ``episode
-00033460: 5f7b 696e 5f6b 6579 7d60 6020 7768 6572  _{in_key}`` wher
-00033470: 6520 7468 6520 6375 6d75 6c61 7469 7665  e the cumulative
-00033480: 2076 616c 7565 7320 6172 6520 7772 6974   values are writ
-00033490: 7465 6e2e 0d0a 0d0a 2020 2020 4172 6773  ten.....    Args
-000334a0: 3a0d 0a20 2020 2020 2020 2069 6e5f 6b65  :..        in_ke
-000334b0: 7973 2028 6c69 7374 206f 6620 4e65 7374  ys (list of Nest
-000334c0: 6564 4b65 7973 2c20 6f70 7469 6f6e 616c  edKeys, optional
-000334d0: 293a 2049 6e70 7574 2072 6577 6172 6420  ): Input reward 
-000334e0: 6b65 7973 2e0d 0a20 2020 2020 2020 2020  keys...         
-000334f0: 2020 2041 6c6c 20c2 b469 6e5f 6b65 7973     All ..in_keys
-00033500: c2b4 2073 686f 756c 6420 6265 2070 6172  .. should be par
-00033510: 7420 6f66 2074 6865 2065 6e76 6972 6f6e  t of the environ
-00033520: 6d65 6e74 2072 6577 6172 645f 7370 6563  ment reward_spec
-00033530: 2e0d 0a20 2020 2020 2020 2020 2020 2049  ...            I
-00033540: 6620 6e6f 2060 6069 6e5f 6b65 7973 6060  f no ``in_keys``
-00033550: 2061 7265 2073 7065 6369 6669 6564 2c20   are specified, 
-00033560: 7468 6973 2074 7261 6e73 666f 726d 2061  this transform a
-00033570: 7373 756d 6573 2060 6022 7265 7761 7264  ssumes ``"reward
-00033580: 2260 6020 746f 2062 6520 7468 6520 696e  "`` to be the in
-00033590: 7075 7420 6b65 792e 0d0a 2020 2020 2020  put key...      
-000335a0: 2020 2020 2020 486f 7765 7665 722c 206d        However, m
-000335b0: 756c 7469 706c 6520 7265 7761 7264 7320  ultiple rewards 
-000335c0: 2865 2e67 2e20 6060 2272 6577 6172 6431  (e.g. ``"reward1
-000335d0: 2260 6020 616e 6420 6060 2272 6577 6172  "`` and ``"rewar
-000335e0: 6432 2222 6060 2920 6361 6e20 616c 736f  d2""``) can also
-000335f0: 2062 6520 7370 6563 6966 6965 642e 0d0a   be specified...
-00033600: 2020 2020 2020 2020 6f75 745f 6b65 7973          out_keys
-00033610: 2028 6c69 7374 206f 6620 4e65 7374 6564   (list of Nested
-00033620: 4b65 7973 2c20 6f70 7469 6f6e 616c 293a  Keys, optional):
-00033630: 2054 6865 206f 7574 7075 7420 7375 6d20   The output sum 
-00033640: 6b65 7973 2c20 7368 6f75 6c64 2062 6520  keys, should be 
-00033650: 6f6e 6520 7065 7220 6561 6368 2069 6e70  one per each inp
-00033660: 7574 206b 6579 2e0d 0a20 2020 2020 2020  ut key...       
-00033670: 2072 6573 6574 5f6b 6579 7320 286c 6973   reset_keys (lis
-00033680: 7420 6f66 204e 6573 7465 644b 6579 732c  t of NestedKeys,
-00033690: 206f 7074 696f 6e61 6c29 3a20 7468 6520   optional): the 
-000336a0: 6c69 7374 206f 6620 7265 7365 745f 6b65  list of reset_ke
-000336b0: 7973 2074 6f20 6265 0d0a 2020 2020 2020  ys to be..      
-000336c0: 2020 2020 2020 7573 6564 2c20 6966 2074        used, if t
-000336d0: 6865 2070 6172 656e 7420 656e 7669 726f  he parent enviro
-000336e0: 6e6d 656e 7420 6361 6e6e 6f74 2062 6520  nment cannot be 
-000336f0: 666f 756e 642e 2049 6620 7072 6f76 6964  found. If provid
-00033700: 6564 2c20 7468 6973 0d0a 2020 2020 2020  ed, this..      
-00033710: 2020 2020 2020 7661 6c75 6520 7769 6c6c        value will
-00033720: 2070 7265 7661 696c 206f 7665 7220 7468   prevail over th
-00033730: 6520 656e 7669 726f 6e6d 656e 7420 6060  e environment ``
-00033740: 7265 7365 745f 6b65 7973 6060 2e0d 0a0d  reset_keys``....
-00033750: 0a20 2020 204b 6579 776f 7264 2041 7267  .    Keyword Arg
-00033760: 733a 0d0a 2020 2020 2020 2020 7265 7761  s:..        rewa
-00033770: 7264 5f73 7065 6320 2862 6f6f 6c2c 206f  rd_spec (bool, o
-00033780: 7074 696f 6e61 6c29 3a20 6966 2060 6054  ptional): if ``T
-00033790: 7275 6560 602c 2074 6865 206e 6577 2072  rue``, the new r
-000337a0: 6577 6172 6420 656e 7472 7920 7769 6c6c  eward entry will
-000337b0: 2062 6520 7265 6769 7374 6572 6564 2069   be registered i
-000337c0: 6e20 7468 650d 0a20 2020 2020 2020 2020  n the..         
-000337d0: 2020 2072 6577 6172 6420 7370 6563 732e     reward specs.
-000337e0: 2044 6566 6175 6c74 7320 746f 2060 6046   Defaults to ``F
-000337f0: 616c 7365 6060 2028 7265 6769 7374 6572  alse`` (register
-00033800: 6564 2069 6e20 6060 6f62 7365 7276 6174  ed in ``observat
-00033810: 696f 6e5f 7370 6563 7360 6029 2e0d 0a0d  ion_specs``)....
-00033820: 0a20 2020 2045 7861 6d70 6c65 733a 0d0a  .    Examples:..
-00033830: 2020 2020 2020 2020 3e3e 3e20 6672 6f6d          >>> from
-00033840: 2074 6f72 6368 726c 2e65 6e76 732e 7472   torchrl.envs.tr
-00033850: 616e 7366 6f72 6d73 2069 6d70 6f72 7420  ansforms import 
-00033860: 5265 7761 7264 5375 6d2c 2054 7261 6e73  RewardSum, Trans
-00033870: 666f 726d 6564 456e 760d 0a20 2020 2020  formedEnv..     
-00033880: 2020 203e 3e3e 2066 726f 6d20 746f 7263     >>> from torc
-00033890: 6872 6c2e 656e 7673 2e6c 6962 732e 6779  hrl.envs.libs.gy
-000338a0: 6d20 696d 706f 7274 2047 796d 456e 760d  m import GymEnv.
-000338b0: 0a20 2020 2020 2020 203e 3e3e 2065 6e76  .        >>> env
-000338c0: 203d 2054 7261 6e73 666f 726d 6564 456e   = TransformedEn
-000338d0: 7628 4779 6d45 6e76 2822 4361 7274 506f  v(GymEnv("CartPo
-000338e0: 6c65 2d76 3122 292c 2052 6577 6172 6453  le-v1"), RewardS
-000338f0: 756d 2829 290d 0a20 2020 2020 2020 203e  um())..        >
-00033900: 3e3e 2065 6e76 2e73 6574 5f73 6565 6428  >> env.set_seed(
-00033910: 3029 0d0a 2020 2020 2020 2020 3e3e 3e20  0)..        >>> 
-00033920: 746f 7263 682e 6d61 6e75 616c 5f73 6565  torch.manual_see
-00033930: 6428 3029 0d0a 2020 2020 2020 2020 3e3e  d(0)..        >>
-00033940: 3e20 7464 203d 2065 6e76 2e72 6573 6574  > td = env.reset
-00033950: 2829 0d0a 2020 2020 2020 2020 3e3e 3e20  ()..        >>> 
-00033960: 7072 696e 7428 7464 5b22 6570 6973 6f64  print(td["episod
-00033970: 655f 7265 7761 7264 225d 290d 0a20 2020  e_reward"])..   
-00033980: 2020 2020 2074 656e 736f 7228 5b30 2e5d       tensor([0.]
-00033990: 290d 0a20 2020 2020 2020 203e 3e3e 2074  )..        >>> t
-000339a0: 6420 3d20 656e 762e 726f 6c6c 6f75 7428  d = env.rollout(
-000339b0: 3329 0d0a 2020 2020 2020 2020 3e3e 3e20  3)..        >>> 
-000339c0: 7072 696e 7428 7464 5b22 6e65 7874 222c  print(td["next",
-000339d0: 2022 6570 6973 6f64 655f 7265 7761 7264   "episode_reward
-000339e0: 225d 290d 0a20 2020 2020 2020 2074 656e  "])..        ten
-000339f0: 736f 7228 5b5b 312e 5d2c 0d0a 2020 2020  sor([[1.],..    
-00033a00: 2020 2020 2020 2020 2020 2020 5b32 2e5d              [2.]
-00033a10: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
-00033a20: 2020 205b 332e 5d5d 290d 0a20 2020 2022     [3.]])..    "
-00033a30: 2222 0d0a 0d0a 2020 2020 6465 6620 5f5f  ""....    def __
-00033a40: 696e 6974 5f5f 280d 0a20 2020 2020 2020  init__(..       
-00033a50: 2073 656c 662c 0d0a 2020 2020 2020 2020   self,..        
-00033a60: 696e 5f6b 6579 733a 2053 6571 7565 6e63  in_keys: Sequenc
-00033a70: 655b 4e65 7374 6564 4b65 795d 207c 204e  e[NestedKey] | N
-00033a80: 6f6e 6520 3d20 4e6f 6e65 2c0d 0a20 2020  one = None,..   
-00033a90: 2020 2020 206f 7574 5f6b 6579 733a 2053       out_keys: S
-00033aa0: 6571 7565 6e63 655b 4e65 7374 6564 4b65  equence[NestedKe
-00033ab0: 795d 207c 204e 6f6e 6520 3d20 4e6f 6e65  y] | None = None
-00033ac0: 2c0d 0a20 2020 2020 2020 2072 6573 6574  ,..        reset
-00033ad0: 5f6b 6579 733a 2053 6571 7565 6e63 655b  _keys: Sequence[
-00033ae0: 4e65 7374 6564 4b65 795d 207c 204e 6f6e  NestedKey] | Non
-00033af0: 6520 3d20 4e6f 6e65 2c0d 0a20 2020 2020  e = None,..     
-00033b00: 2020 202a 2c0d 0a20 2020 2020 2020 2072     *,..        r
-00033b10: 6577 6172 645f 7370 6563 3a20 626f 6f6c  eward_spec: bool
-00033b20: 203d 2046 616c 7365 2c0d 0a20 2020 2029   = False,..    )
-00033b30: 3a0d 0a20 2020 2020 2020 2022 2222 496e  :..        """In
-00033b40: 6974 6961 6c69 7365 7320 7468 6520 7472  itialises the tr
-00033b50: 616e 7366 6f72 6d2e 2046 696c 7465 7273  ansform. Filters
-00033b60: 206f 7574 206e 6f6e 2d72 6577 6172 6420   out non-reward 
-00033b70: 696e 7075 7420 6b65 7973 2061 6e64 2064  input keys and d
-00033b80: 6566 696e 6573 206f 7574 7075 7420 6b65  efines output ke
-00033b90: 7973 2e22 2222 0d0a 2020 2020 2020 2020  ys."""..        
-00033ba0: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
-00033bb0: 2869 6e5f 6b65 7973 3d69 6e5f 6b65 7973  (in_keys=in_keys
-00033bc0: 2c20 6f75 745f 6b65 7973 3d6f 7574 5f6b  , out_keys=out_k
-00033bd0: 6579 7329 0d0a 2020 2020 2020 2020 7365  eys)..        se
-00033be0: 6c66 2e5f 7265 7365 745f 6b65 7973 203d  lf._reset_keys =
-00033bf0: 2072 6573 6574 5f6b 6579 730d 0a20 2020   reset_keys..   
-00033c00: 2020 2020 2073 656c 662e 5f6b 6579 735f       self._keys_
-00033c10: 6368 6563 6b65 6420 3d20 4661 6c73 650d  checked = False.
-00033c20: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
-00033c30: 7761 7264 5f73 7065 6320 3d20 7265 7761  ward_spec = rewa
-00033c40: 7264 5f73 7065 630d 0a0d 0a20 2020 2040  rd_spec....    @
-00033c50: 7072 6f70 6572 7479 0d0a 2020 2020 6465  property..    de
-00033c60: 6620 696e 5f6b 6579 7328 7365 6c66 293a  f in_keys(self):
-00033c70: 0d0a 2020 2020 2020 2020 696e 5f6b 6579  ..        in_key
-00033c80: 7320 3d20 7365 6c66 2e5f 5f64 6963 745f  s = self.__dict_
-00033c90: 5f2e 6765 7428 225f 696e 5f6b 6579 7322  _.get("_in_keys"
-00033ca0: 2c20 4e6f 6e65 290d 0a20 2020 2020 2020  , None)..       
-00033cb0: 2069 6620 696e 5f6b 6579 7320 696e 2028   if in_keys in (
-00033cc0: 4e6f 6e65 2c20 5b5d 293a 0d0a 2020 2020  None, []):..    
-00033cd0: 2020 2020 2020 2020 2320 7265 7472 6965          # retrie
-00033ce0: 7665 2072 6577 6172 6473 2066 726f 6d20  ve rewards from 
-00033cf0: 7061 7265 6e74 2065 6e76 0d0a 2020 2020  parent env..    
-00033d00: 2020 2020 2020 2020 7061 7265 6e74 203d          parent =
-00033d10: 2073 656c 662e 7061 7265 6e74 0d0a 2020   self.parent..  
-00033d20: 2020 2020 2020 2020 2020 6966 2070 6172            if par
-00033d30: 656e 7420 6973 204e 6f6e 653a 0d0a 2020  ent is None:..  
-00033d40: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00033d50: 5f6b 6579 7320 3d20 5b22 7265 7761 7264  _keys = ["reward
-00033d60: 225d 0d0a 2020 2020 2020 2020 2020 2020  "]..            
-00033d70: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
-00033d80: 2020 2020 2020 2069 6e5f 6b65 7973 203d         in_keys =
-00033d90: 2063 6f70 7928 7061 7265 6e74 2e72 6577   copy(parent.rew
-00033da0: 6172 645f 6b65 7973 290d 0a20 2020 2020  ard_keys)..     
-00033db0: 2020 2020 2020 2073 656c 662e 5f69 6e5f         self._in_
-00033dc0: 6b65 7973 203d 2069 6e5f 6b65 7973 0d0a  keys = in_keys..
-00033dd0: 2020 2020 2020 2020 7265 7475 726e 2069          return i
-00033de0: 6e5f 6b65 7973 0d0a 0d0a 2020 2020 4069  n_keys....    @i
-00033df0: 6e5f 6b65 7973 2e73 6574 7465 720d 0a20  n_keys.setter.. 
-00033e00: 2020 2064 6566 2069 6e5f 6b65 7973 2873     def in_keys(s
-00033e10: 656c 662c 2076 616c 7565 293a 0d0a 2020  elf, value):..  
-00033e20: 2020 2020 2020 6966 2076 616c 7565 2069        if value i
-00033e30: 7320 6e6f 7420 4e6f 6e65 3a0d 0a20 2020  s not None:..   
-00033e40: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
-00033e50: 7374 616e 6365 2876 616c 7565 2c20 2873  stance(value, (s
-00033e60: 7472 2c20 7475 706c 6529 293a 0d0a 2020  tr, tuple)):..  
-00033e70: 2020 2020 2020 2020 2020 2020 2020 7661                va
-00033e80: 6c75 6520 3d20 5b76 616c 7565 5d0d 0a20  lue = [value].. 
-00033e90: 2020 2020 2020 2020 2020 2076 616c 7565             value
-00033ea0: 203d 205b 756e 7261 7665 6c5f 6b65 7928   = [unravel_key(
-00033eb0: 7661 6c29 2066 6f72 2076 616c 2069 6e20  val) for val in 
-00033ec0: 7661 6c75 655d 0d0a 2020 2020 2020 2020  value]..        
-00033ed0: 7365 6c66 2e5f 696e 5f6b 6579 7320 3d20  self._in_keys = 
-00033ee0: 7661 6c75 650d 0a0d 0a20 2020 2040 7072  value....    @pr
-00033ef0: 6f70 6572 7479 0d0a 2020 2020 6465 6620  operty..    def 
-00033f00: 6f75 745f 6b65 7973 2873 656c 6629 3a0d  out_keys(self):.
-00033f10: 0a20 2020 2020 2020 206f 7574 5f6b 6579  .        out_key
-00033f20: 7320 3d20 7365 6c66 2e5f 5f64 6963 745f  s = self.__dict_
-00033f30: 5f2e 6765 7428 225f 6f75 745f 6b65 7973  _.get("_out_keys
-00033f40: 222c 204e 6f6e 6529 0d0a 2020 2020 2020  ", None)..      
-00033f50: 2020 6966 206f 7574 5f6b 6579 7320 696e    if out_keys in
-00033f60: 2028 4e6f 6e65 2c20 5b5d 293a 0d0a 2020   (None, []):..  
-00033f70: 2020 2020 2020 2020 2020 6f75 745f 6b65            out_ke
-00033f80: 7973 203d 205b 0d0a 2020 2020 2020 2020  ys = [..        
-00033f90: 2020 2020 2020 2020 5f72 6570 6c61 6365          _replace
-00033fa0: 5f6c 6173 7428 696e 5f6b 6579 2c20 6622  _last(in_key, f"
-00033fb0: 6570 6973 6f64 655f 7b5f 756e 7261 7665  episode_{_unrave
-00033fc0: 6c5f 6b65 795f 746f 5f74 7570 6c65 2869  l_key_to_tuple(i
-00033fd0: 6e5f 6b65 7929 5b2d 315d 7d22 290d 0a20  n_key)[-1]}").. 
-00033fe0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00033ff0: 6f72 2069 6e5f 6b65 7920 696e 2073 656c  or in_key in sel
-00034000: 662e 696e 5f6b 6579 730d 0a20 2020 2020  f.in_keys..     
-00034010: 2020 2020 2020 205d 0d0a 2020 2020 2020         ]..      
-00034020: 2020 2020 2020 7365 6c66 2e5f 6f75 745f        self._out_
-00034030: 6b65 7973 203d 206f 7574 5f6b 6579 730d  keys = out_keys.
-00034040: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00034050: 6f75 745f 6b65 7973 0d0a 0d0a 2020 2020  out_keys....    
-00034060: 406f 7574 5f6b 6579 732e 7365 7474 6572  @out_keys.setter
-00034070: 0d0a 2020 2020 6465 6620 6f75 745f 6b65  ..    def out_ke
-00034080: 7973 2873 656c 662c 2076 616c 7565 293a  ys(self, value):
-00034090: 0d0a 2020 2020 2020 2020 2320 7765 206d  ..        # we m
-000340a0: 7573 7420 6163 6365 7373 2074 6865 2070  ust access the p
-000340b0: 7269 7661 7465 2061 7474 7269 6275 7465  rivate attribute
-000340c0: 2062 6563 6175 7365 2074 6869 7320 6368   because this ch
-000340d0: 6563 6b20 6f63 6375 7273 2062 6566 6f72  eck occurs befor
-000340e0: 650d 0a20 2020 2020 2020 2023 2074 6865  e..        # the
-000340f0: 2070 6172 656e 7420 656e 7620 6973 2064   parent env is d
-00034100: 6566 696e 6564 0d0a 2020 2020 2020 2020  efined..        
-00034110: 6966 2076 616c 7565 2069 7320 6e6f 7420  if value is not 
-00034120: 4e6f 6e65 2061 6e64 206c 656e 2873 656c  None and len(sel
-00034130: 662e 5f69 6e5f 6b65 7973 2920 213d 206c  f._in_keys) != l
-00034140: 656e 2876 616c 7565 293a 0d0a 2020 2020  en(value):..    
-00034150: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-00034160: 6c75 6545 7272 6f72 280d 0a20 2020 2020  lueError(..     
-00034170: 2020 2020 2020 2020 2020 2022 5265 7761             "Rewa
-00034180: 7264 5375 6d20 6578 7065 6374 7320 7468  rdSum expects th
-00034190: 6520 7361 6d65 206e 756d 6265 7220 6f66  e same number of
-000341a0: 2069 6e70 7574 2061 6e64 206f 7574 7075   input and outpu
-000341b0: 7420 6b65 7973 220d 0a20 2020 2020 2020  t keys"..       
-000341c0: 2020 2020 2029 0d0a 2020 2020 2020 2020       )..        
-000341d0: 6966 2076 616c 7565 2069 7320 6e6f 7420  if value is not 
-000341e0: 4e6f 6e65 3a0d 0a20 2020 2020 2020 2020  None:..         
-000341f0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-00034200: 2876 616c 7565 2c20 2873 7472 2c20 7475  (value, (str, tu
-00034210: 706c 6529 293a 0d0a 2020 2020 2020 2020  ple)):..        
-00034220: 2020 2020 2020 2020 7661 6c75 6520 3d20          value = 
-00034230: 5b76 616c 7565 5d0d 0a20 2020 2020 2020  [value]..       
-00034240: 2020 2020 2076 616c 7565 203d 205b 756e       value = [un
-00034250: 7261 7665 6c5f 6b65 7928 7661 6c29 2066  ravel_key(val) f
-00034260: 6f72 2076 616c 2069 6e20 7661 6c75 655d  or val in value]
-00034270: 0d0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
-00034280: 6f75 745f 6b65 7973 203d 2076 616c 7565  out_keys = value
-00034290: 0d0a 0d0a 2020 2020 4070 726f 7065 7274  ....    @propert
-000342a0: 790d 0a20 2020 2064 6566 2072 6573 6574  y..    def reset
-000342b0: 5f6b 6579 7328 7365 6c66 293a 0d0a 2020  _keys(self):..  
-000342c0: 2020 2020 2020 7265 7365 745f 6b65 7973        reset_keys
-000342d0: 203d 2073 656c 662e 5f5f 6469 6374 5f5f   = self.__dict__
-000342e0: 2e67 6574 2822 5f72 6573 6574 5f6b 6579  .get("_reset_key
-000342f0: 7322 2c20 4e6f 6e65 290d 0a20 2020 2020  s", None)..     
-00034300: 2020 2069 6620 7265 7365 745f 6b65 7973     if reset_keys
-00034310: 2069 7320 4e6f 6e65 3a0d 0a20 2020 2020   is None:..     
-00034320: 2020 2020 2020 2070 6172 656e 7420 3d20         parent = 
-00034330: 7365 6c66 2e70 6172 656e 740d 0a20 2020  self.parent..   
-00034340: 2020 2020 2020 2020 2069 6620 7061 7265           if pare
-00034350: 6e74 2069 7320 4e6f 6e65 3a0d 0a20 2020  nt is None:..   
-00034360: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00034370: 7365 2054 7970 6545 7272 6f72 280d 0a20  se TypeError(.. 
-00034380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034390: 2020 2022 7265 7365 745f 6b65 7973 206e     "reset_keys n
-000343a0: 6f74 2070 726f 7669 6465 6420 6275 7420  ot provided but 
-000343b0: 7061 7265 6e74 2065 6e76 206e 6f74 2066  parent env not f
-000343c0: 6f75 6e64 2e20 220d 0a20 2020 2020 2020  ound. "..       
-000343d0: 2020 2020 2020 2020 2020 2020 2022 4d61               "Ma
-000343e0: 6b65 2073 7572 6520 7468 6174 2074 6865  ke sure that the
-000343f0: 2072 6573 6574 5f6b 6579 7320 6172 6520   reset_keys are 
-00034400: 7072 6f76 6964 6564 2064 7572 696e 6720  provided during 
-00034410: 220d 0a20 2020 2020 2020 2020 2020 2020  "..             
-00034420: 2020 2020 2020 2022 636f 6e73 7472 7563         "construc
-00034430: 7469 6f6e 2069 6620 7468 6520 7472 616e  tion if the tran
-00034440: 7366 6f72 6d20 646f 6573 206e 6f74 2068  sform does not h
-00034450: 6176 6520 6120 636f 6e74 6169 6e65 7220  ave a container 
-00034460: 656e 762e 220d 0a20 2020 2020 2020 2020  env."..         
-00034470: 2020 2020 2020 2029 0d0a 2020 2020 2020         )..      
-00034480: 2020 2020 2020 2320 6c65 7427 7320 7472        # let's tr
-00034490: 7920 746f 206d 6174 6368 2074 6865 2072  y to match the r
-000344a0: 6573 6574 206b 6579 7320 7769 7468 2074  eset keys with t
-000344b0: 6865 2069 6e5f 6b65 7973 2e0d 0a20 2020  he in_keys...   
-000344c0: 2020 2020 2020 2020 2023 2057 6520 7461           # We ta
-000344d0: 6b65 2074 6865 2066 696c 7465 7265 6420  ke the filtered 
-000344e0: 7265 7365 7420 6b65 7973 2c20 7768 6963  reset keys, whic
-000344f0: 6820 6172 6520 7468 6520 6f6e 6c79 206b  h are the only k
-00034500: 6579 7320 7468 6174 2072 6561 6c6c 790d  eys that really.
-00034510: 0a20 2020 2020 2020 2020 2020 2023 206d  .            # m
-00034520: 6174 7465 7220 7768 656e 2063 616c 6c69  atter when calli
-00034530: 6e67 2072 6573 6574 2c20 616e 6420 6368  ng reset, and ch
-00034540: 6563 6b20 7468 6174 2074 6865 7920 6d61  eck that they ma
-00034550: 7463 6820 7468 6520 696e 5f6b 6579 7320  tch the in_keys 
-00034560: 726f 6f74 2e0d 0a20 2020 2020 2020 2020  root...         
-00034570: 2020 2072 6573 6574 5f6b 6579 7320 3d20     reset_keys = 
-00034580: 7061 7265 6e74 2e5f 6669 6c74 6572 6564  parent._filtered
-00034590: 5f72 6573 6574 5f6b 6579 730d 0a0d 0a20  _reset_keys.... 
-000345a0: 2020 2020 2020 2020 2020 2064 6566 205f             def _
-000345b0: 6368 6563 6b5f 6d61 7463 6828 7265 7365  check_match(rese
-000345c0: 745f 6b65 7973 2c20 696e 5f6b 6579 7329  t_keys, in_keys)
-000345d0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-000345e0: 2020 2023 2069 6620 7468 6973 2069 7320     # if this is 
-000345f0: 6361 6c6c 6564 2c20 7468 6520 6c65 6e67  called, the leng
-00034600: 7468 206f 6620 7265 7365 745f 6b65 7973  th of reset_keys
-00034610: 2061 6e64 2069 6e5f 6b65 7973 206d 7573   and in_keys mus
-00034620: 7420 6d61 7463 680d 0a20 2020 2020 2020  t match..       
-00034630: 2020 2020 2020 2020 2066 6f72 2072 6573           for res
-00034640: 6574 5f6b 6579 2c20 696e 5f6b 6579 2069  et_key, in_key i
-00034650: 6e20 7a69 7028 7265 7365 745f 6b65 7973  n zip(reset_keys
-00034660: 2c20 696e 5f6b 6579 7329 3a0d 0a20 2020  , in_keys):..   
-00034670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034680: 2023 2068 6176 696e 6720 5f72 6573 6574   # having _reset
-00034690: 2061 7420 7468 6520 726f 6f74 2061 6e64   at the root and
-000346a0: 2074 6865 2072 6577 6172 645f 6b65 7920   the reward_key 
-000346b0: 2822 6167 656e 7422 2c20 2272 6577 6172  ("agent", "rewar
-000346c0: 6422 2920 6973 2061 6c6c 6f77 6564 0d0a  d") is allowed..
-000346d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000346e0: 2020 2020 2320 6275 7420 6861 7669 6e67      # but having
-000346f0: 2028 2261 6765 6e74 222c 2022 5f72 6573   ("agent", "_res
-00034700: 6574 2229 2061 6e64 2022 7265 7761 7264  et") and "reward
-00034710: 2220 6973 6e27 740d 0a20 2020 2020 2020  " isn't..       
-00034720: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00034730: 6973 696e 7374 616e 6365 2872 6573 6574  isinstance(reset
-00034740: 5f6b 6579 2c20 7475 706c 6529 2061 6e64  _key, tuple) and
-00034750: 2069 7369 6e73 7461 6e63 6528 696e 5f6b   isinstance(in_k
-00034760: 6579 2c20 7374 7229 3a0d 0a20 2020 2020  ey, str):..     
-00034770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034780: 2020 2072 6574 7572 6e20 4661 6c73 650d     return False.
-00034790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000347a0: 2020 2020 2069 6620 280d 0a20 2020 2020       if (..     
-000347b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000347c0: 2020 2069 7369 6e73 7461 6e63 6528 7265     isinstance(re
-000347d0: 7365 745f 6b65 792c 2074 7570 6c65 290d  set_key, tuple).
-000347e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000347f0: 2020 2020 2020 2020 2061 6e64 2069 7369           and isi
-00034800: 6e73 7461 6e63 6528 696e 5f6b 6579 2c20  nstance(in_key, 
-00034810: 7475 706c 6529 0d0a 2020 2020 2020 2020  tuple)..        
-00034820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034830: 616e 6420 696e 5f6b 6579 5b3a 2028 6c65  and in_key[: (le
-00034840: 6e28 7265 7365 745f 6b65 7929 202d 2031  n(reset_key) - 1
-00034850: 295d 2021 3d20 7265 7365 745f 6b65 795b  )] != reset_key[
-00034860: 3a2d 315d 0d0a 2020 2020 2020 2020 2020  :-1]..          
-00034870: 2020 2020 2020 2020 2020 293a 0d0a 2020            ):..  
-00034880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034890: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-000348a0: 7365 0d0a 2020 2020 2020 2020 2020 2020  se..            
-000348b0: 2020 2020 7265 7475 726e 2054 7275 650d      return True.
-000348c0: 0a0d 0a20 2020 2020 2020 2020 2020 2069  ...            i
-000348d0: 6620 6e6f 7420 5f63 6865 636b 5f6d 6174  f not _check_mat
-000348e0: 6368 2872 6573 6574 5f6b 6579 732c 2073  ch(reset_keys, s
-000348f0: 656c 662e 696e 5f6b 6579 7329 3a0d 0a20  elf.in_keys):.. 
-00034900: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00034910: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00034920: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00034930: 2020 2020 2020 6622 436f 756c 6420 6e6f        f"Could no
-00034940: 7420 6d61 7463 6820 7468 6520 656e 7620  t match the env 
-00034950: 7265 7365 745f 6b65 7973 207b 7265 7365  reset_keys {rese
-00034960: 745f 6b65 7973 7d20 7769 7468 2074 6865  t_keys} with the
-00034970: 207b 7479 7065 2873 656c 6629 7d20 696e   {type(self)} in
-00034980: 5f6b 6579 7320 7b73 656c 662e 696e 5f6b  _keys {self.in_k
-00034990: 6579 737d 2e20 220d 0a20 2020 2020 2020  eys}. "..       
-000349a0: 2020 2020 2020 2020 2020 2020 2066 2250               f"P
-000349b0: 6c65 6173 6520 7072 6f76 6964 6520 7468  lease provide th
-000349c0: 6520 7265 7365 745f 6b65 7973 206d 616e  e reset_keys man
-000349d0: 7561 6c6c 792e 2052 6573 6574 2065 6e74  ually. Reset ent
-000349e0: 7269 6573 2063 616e 2062 6520 220d 0a20  ries can be ".. 
-000349f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034a00: 2020 2066 226e 6f6e 2d75 6e69 7175 6520     f"non-unique 
-00034a10: 616e 6420 6d75 7374 2062 6520 7269 6768  and must be righ
-00034a20: 742d 6578 7061 6e64 6162 6c65 2074 6f20  t-expandable to 
-00034a30: 7468 6520 7368 6170 6520 6f66 2022 0d0a  the shape of "..
-00034a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034a50: 2020 2020 6622 7468 6520 696e 7075 7420      f"the input 
-00034a60: 656e 7472 6965 732e 220d 0a20 2020 2020  entries."..     
-00034a70: 2020 2020 2020 2020 2020 2029 0d0a 2020             )..  
-00034a80: 2020 2020 2020 2020 2020 7265 7365 745f            reset_
-00034a90: 6b65 7973 203d 2063 6f70 7928 7265 7365  keys = copy(rese
-00034aa0: 745f 6b65 7973 290d 0a20 2020 2020 2020  t_keys)..       
-00034ab0: 2020 2020 2073 656c 662e 5f72 6573 6574       self._reset
-00034ac0: 5f6b 6579 7320 3d20 7265 7365 745f 6b65  _keys = reset_ke
-00034ad0: 7973 0d0a 0d0a 2020 2020 2020 2020 6966  ys....        if
-00034ae0: 206e 6f74 2073 656c 662e 5f6b 6579 735f   not self._keys_
-00034af0: 6368 6563 6b65 6420 616e 6420 6c65 6e28  checked and len(
-00034b00: 7265 7365 745f 6b65 7973 2920 213d 206c  reset_keys) != l
-00034b10: 656e 2873 656c 662e 696e 5f6b 6579 7329  en(self.in_keys)
-00034b20: 3a0d 0a20 2020 2020 2020 2020 2020 2072  :..            r
-00034b30: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00034b40: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00034b50: 2020 6622 436f 756c 6420 6e6f 7420 6d61    f"Could not ma
-00034b60: 7463 6820 7468 6520 656e 7620 7265 7365  tch the env rese
-00034b70: 745f 6b65 7973 207b 7265 7365 745f 6b65  t_keys {reset_ke
-00034b80: 7973 7d20 7769 7468 2074 6865 2069 6e5f  ys} with the in_
-00034b90: 6b65 7973 207b 7365 6c66 2e69 6e5f 6b65  keys {self.in_ke
-00034ba0: 7973 7d2e 2022 0d0a 2020 2020 2020 2020  ys}. "..        
-00034bb0: 2020 2020 2020 2020 2250 6c65 6173 6520          "Please 
-00034bc0: 6d61 6b65 2073 7572 6520 7468 6174 2074  make sure that t
-00034bd0: 6865 7365 2068 6176 6520 7468 6520 7361  hese have the sa
-00034be0: 6d65 206c 656e 6774 682e 220d 0a20 2020  me length."..   
-00034bf0: 2020 2020 2020 2020 2029 0d0a 2020 2020           )..    
-00034c00: 2020 2020 7365 6c66 2e5f 6b65 7973 5f63      self._keys_c
-00034c10: 6865 636b 6564 203d 2054 7275 650d 0a0d  hecked = True...
-00034c20: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00034c30: 7265 7365 745f 6b65 7973 0d0a 0d0a 2020  reset_keys....  
-00034c40: 2020 4072 6573 6574 5f6b 6579 732e 7365    @reset_keys.se
-00034c50: 7474 6572 0d0a 2020 2020 6465 6620 7265  tter..    def re
-00034c60: 7365 745f 6b65 7973 2873 656c 662c 2076  set_keys(self, v
-00034c70: 616c 7565 293a 0d0a 2020 2020 2020 2020  alue):..        
-00034c80: 6966 2076 616c 7565 2069 7320 6e6f 7420  if value is not 
-00034c90: 4e6f 6e65 3a0d 0a20 2020 2020 2020 2020  None:..         
-00034ca0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-00034cb0: 2876 616c 7565 2c20 2873 7472 2c20 7475  (value, (str, tu
-00034cc0: 706c 6529 293a 0d0a 2020 2020 2020 2020  ple)):..        
-00034cd0: 2020 2020 2020 2020 7661 6c75 6520 3d20          value = 
-00034ce0: 5b76 616c 7565 5d0d 0a20 2020 2020 2020  [value]..       
-00034cf0: 2020 2020 2076 616c 7565 203d 205b 756e       value = [un
-00034d00: 7261 7665 6c5f 6b65 7928 7661 6c29 2066  ravel_key(val) f
-00034d10: 6f72 2076 616c 2069 6e20 7661 6c75 655d  or val in value]
-00034d20: 0d0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
-00034d30: 7265 7365 745f 6b65 7973 203d 2076 616c  reset_keys = val
-00034d40: 7565 0d0a 0d0a 2020 2020 6465 6620 5f72  ue....    def _r
-00034d50: 6573 6574 280d 0a20 2020 2020 2020 2073  eset(..        s
-00034d60: 656c 662c 2074 656e 736f 7264 6963 743a  elf, tensordict:
-00034d70: 2054 656e 736f 7244 6963 7442 6173 652c   TensorDictBase,
-00034d80: 2074 656e 736f 7264 6963 745f 7265 7365   tensordict_rese
-00034d90: 743a 2054 656e 736f 7244 6963 7442 6173  t: TensorDictBas
-00034da0: 650d 0a20 2020 2029 202d 3e20 5465 6e73  e..    ) -> Tens
-00034db0: 6f72 4469 6374 4261 7365 3a0d 0a20 2020  orDictBase:..   
-00034dc0: 2020 2020 2022 2222 5265 7365 7473 2065       """Resets e
-00034dd0: 7069 736f 6465 2072 6577 6172 6473 2e22  pisode rewards."
-00034de0: 2222 0d0a 2020 2020 2020 2020 666f 7220  ""..        for 
-00034df0: 696e 5f6b 6579 2c20 7265 7365 745f 6b65  in_key, reset_ke
-00034e00: 792c 206f 7574 5f6b 6579 2069 6e20 7a69  y, out_key in zi
-00034e10: 7028 0d0a 2020 2020 2020 2020 2020 2020  p(..            
-00034e20: 7365 6c66 2e69 6e5f 6b65 7973 2c20 7365  self.in_keys, se
-00034e30: 6c66 2e72 6573 6574 5f6b 6579 732c 2073  lf.reset_keys, s
-00034e40: 656c 662e 6f75 745f 6b65 7973 0d0a 2020  elf.out_keys..  
-00034e50: 2020 2020 2020 293a 0d0a 2020 2020 2020        ):..      
-00034e60: 2020 2020 2020 5f72 6573 6574 203d 205f        _reset = _
-00034e70: 6765 745f 7265 7365 7428 7265 7365 745f  get_reset(reset_
-00034e80: 6b65 792c 2074 656e 736f 7264 6963 7429  key, tensordict)
-00034e90: 0d0a 2020 2020 2020 2020 2020 2020 7661  ..            va
-00034ea0: 6c75 6520 3d20 7465 6e73 6f72 6469 6374  lue = tensordict
-00034eb0: 2e67 6574 286f 7574 5f6b 6579 2c20 6465  .get(out_key, de
-00034ec0: 6661 756c 743d 4e6f 6e65 290d 0a20 2020  fault=None)..   
-00034ed0: 2020 2020 2020 2020 2069 6620 7661 6c75           if valu
-00034ee0: 6520 6973 204e 6f6e 653a 0d0a 2020 2020  e is None:..    
-00034ef0: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
-00034f00: 6520 3d20 7365 6c66 2e70 6172 656e 742e  e = self.parent.
-00034f10: 6675 6c6c 5f72 6577 6172 645f 7370 6563  full_reward_spec
-00034f20: 5b69 6e5f 6b65 795d 2e7a 6572 6f28 290d  [in_key].zero().
-00034f30: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00034f40: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
-00034f50: 2020 2020 7661 6c75 6520 3d20 746f 7263      value = torc
-00034f60: 682e 7768 6572 6528 6578 7061 6e64 5f61  h.where(expand_a
-00034f70: 735f 7269 6768 7428 7e5f 7265 7365 742c  s_right(~_reset,
-00034f80: 2076 616c 7565 292c 2076 616c 7565 2c20   value), value, 
-00034f90: 302e 3029 0d0a 2020 2020 2020 2020 2020  0.0)..          
-00034fa0: 2020 7465 6e73 6f72 6469 6374 5f72 6573    tensordict_res
-00034fb0: 6574 2e73 6574 286f 7574 5f6b 6579 2c20  et.set(out_key, 
-00034fc0: 7661 6c75 6529 0d0a 2020 2020 2020 2020  value)..        
-00034fd0: 7265 7475 726e 2074 656e 736f 7264 6963  return tensordic
-00034fe0: 745f 7265 7365 740d 0a0d 0a20 2020 2064  t_reset....    d
-00034ff0: 6566 205f 7374 6570 280d 0a20 2020 2020  ef _step(..     
-00035000: 2020 2073 656c 662c 2074 656e 736f 7264     self, tensord
-00035010: 6963 743a 2054 656e 736f 7244 6963 7442  ict: TensorDictB
-00035020: 6173 652c 206e 6578 745f 7465 6e73 6f72  ase, next_tensor
-00035030: 6469 6374 3a20 5465 6e73 6f72 4469 6374  dict: TensorDict
-00035040: 4261 7365 0d0a 2020 2020 2920 2d3e 2054  Base..    ) -> T
-00035050: 656e 736f 7244 6963 7442 6173 653a 0d0a  ensorDictBase:..
-00035060: 2020 2020 2020 2020 2222 2255 7064 6174          """Updat
-00035070: 6573 2074 6865 2065 7069 736f 6465 2072  es the episode r
-00035080: 6577 6172 6473 2077 6974 6820 7468 6520  ewards with the 
-00035090: 7374 6570 2072 6577 6172 6473 2e22 2222  step rewards."""
-000350a0: 0d0a 2020 2020 2020 2020 2320 5570 6461  ..        # Upda
-000350b0: 7465 2065 7069 736f 6465 2072 6577 6172  te episode rewar
-000350c0: 6473 0d0a 2020 2020 2020 2020 666f 7220  ds..        for 
-000350d0: 696e 5f6b 6579 2c20 6f75 745f 6b65 7920  in_key, out_key 
-000350e0: 696e 207a 6970 2873 656c 662e 696e 5f6b  in zip(self.in_k
-000350f0: 6579 732c 2073 656c 662e 6f75 745f 6b65  eys, self.out_ke
-00035100: 7973 293a 0d0a 2020 2020 2020 2020 2020  ys):..          
-00035110: 2020 6966 2069 6e5f 6b65 7920 696e 206e    if in_key in n
-00035120: 6578 745f 7465 6e73 6f72 6469 6374 2e6b  ext_tensordict.k
-00035130: 6579 7328 696e 636c 7564 655f 6e65 7374  eys(include_nest
-00035140: 6564 3d54 7275 6529 3a0d 0a20 2020 2020  ed=True):..     
-00035150: 2020 2020 2020 2020 2020 2072 6577 6172             rewar
-00035160: 6420 3d20 6e65 7874 5f74 656e 736f 7264  d = next_tensord
-00035170: 6963 742e 6765 7428 696e 5f6b 6579 290d  ict.get(in_key).
-00035180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00035190: 2070 7265 765f 7265 7761 7264 203d 2074   prev_reward = t
-000351a0: 656e 736f 7264 6963 742e 6765 7428 6f75  ensordict.get(ou
-000351b0: 745f 6b65 792c 2030 2e30 290d 0a20 2020  t_key, 0.0)..   
-000351c0: 2020 2020 2020 2020 2020 2020 206e 6578               nex
-000351d0: 745f 7465 6e73 6f72 6469 6374 2e73 6574  t_tensordict.set
-000351e0: 286f 7574 5f6b 6579 2c20 7072 6576 5f72  (out_key, prev_r
-000351f0: 6577 6172 6420 2b20 7265 7761 7264 290d  eward + reward).
-00035200: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-00035210: 6620 6e6f 7420 7365 6c66 2e6d 6973 7369  f not self.missi
-00035220: 6e67 5f74 6f6c 6572 616e 6365 3a0d 0a20  ng_tolerance:.. 
-00035230: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00035240: 6169 7365 204b 6579 4572 726f 7228 6622  aise KeyError(f"
-00035250: 277b 696e 5f6b 6579 7d27 206e 6f74 2066  '{in_key}' not f
-00035260: 6f75 6e64 2069 6e20 7465 6e73 6f72 6469  ound in tensordi
-00035270: 6374 207b 7465 6e73 6f72 6469 6374 7d22  ct {tensordict}"
-00035280: 290d 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00035290: 6e20 6e65 7874 5f74 656e 736f 7264 6963  n next_tensordic
-000352a0: 740d 0a0d 0a20 2020 2064 6566 2074 7261  t....    def tra
-000352b0: 6e73 666f 726d 5f69 6e70 7574 5f73 7065  nsform_input_spe
-000352c0: 6328 7365 6c66 2c20 696e 7075 745f 7370  c(self, input_sp
-000352d0: 6563 3a20 5465 6e73 6f72 5370 6563 2920  ec: TensorSpec) 
-000352e0: 2d3e 2054 656e 736f 7253 7065 633a 0d0a  -> TensorSpec:..
-000352f0: 2020 2020 2020 2020 7374 6174 655f 7370          state_sp
-00035300: 6563 203d 2069 6e70 7574 5f73 7065 635b  ec = input_spec[
-00035310: 2266 756c 6c5f 7374 6174 655f 7370 6563  "full_state_spec
-00035320: 225d 0d0a 2020 2020 2020 2020 6966 2073  "]..        if s
-00035330: 7461 7465 5f73 7065 6320 6973 204e 6f6e  tate_spec is Non
-00035340: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
-00035350: 7374 6174 655f 7370 6563 203d 2043 6f6d  state_spec = Com
-00035360: 706f 7369 7465 5370 6563 2873 6861 7065  positeSpec(shape
-00035370: 3d69 6e70 7574 5f73 7065 632e 7368 6170  =input_spec.shap
-00035380: 652c 2064 6576 6963 653d 696e 7075 745f  e, device=input_
-00035390: 7370 6563 2e64 6576 6963 6529 0d0a 2020  spec.device)..  
-000353a0: 2020 2020 2020 7374 6174 655f 7370 6563        state_spec
-000353b0: 2e75 7064 6174 6528 7365 6c66 2e5f 6765  .update(self._ge
-000353c0: 6e65 7261 7465 5f65 7069 736f 6465 5f72  nerate_episode_r
-000353d0: 6577 6172 645f 7370 6563 2829 290d 0a20  eward_spec()).. 
-000353e0: 2020 2020 2020 2069 6e70 7574 5f73 7065         input_spe
-000353f0: 635b 2266 756c 6c5f 7374 6174 655f 7370  c["full_state_sp
-00035400: 6563 225d 203d 2073 7461 7465 5f73 7065  ec"] = state_spe
-00035410: 630d 0a20 2020 2020 2020 2072 6574 7572  c..        retur
-00035420: 6e20 696e 7075 745f 7370 6563 0d0a 0d0a  n input_spec....
-00035430: 2020 2020 6465 6620 5f67 656e 6572 6174      def _generat
-00035440: 655f 6570 6973 6f64 655f 7265 7761 7264  e_episode_reward
-00035450: 5f73 7065 6328 7365 6c66 2920 2d3e 2043  _spec(self) -> C
-00035460: 6f6d 706f 7369 7465 5370 6563 3a0d 0a20  ompositeSpec:.. 
-00035470: 2020 2020 2020 2065 7069 736f 6465 5f72         episode_r
-00035480: 6577 6172 645f 7370 6563 203d 2043 6f6d  eward_spec = Com
-00035490: 706f 7369 7465 5370 6563 2829 0d0a 2020  positeSpec()..  
-000354a0: 2020 2020 2020 7265 7761 7264 5f73 7065        reward_spe
-000354b0: 6320 3d20 7365 6c66 2e70 6172 656e 742e  c = self.parent.
-000354c0: 6675 6c6c 5f72 6577 6172 645f 7370 6563  full_reward_spec
-000354d0: 0d0a 2020 2020 2020 2020 7265 7761 7264  ..        reward
-000354e0: 5f73 7065 635f 6b65 7973 203d 2073 656c  _spec_keys = sel
-000354f0: 662e 7061 7265 6e74 2e72 6577 6172 645f  f.parent.reward_
-00035500: 6b65 7973 0d0a 2020 2020 2020 2020 2320  keys..        # 
-00035510: 4465 6669 6e65 2065 7069 736f 6465 2073  Define episode s
-00035520: 7065 6373 2066 6f72 2061 6c6c 206f 7574  pecs for all out
-00035530: 5f6b 6579 730d 0a20 2020 2020 2020 2066  _keys..        f
-00035540: 6f72 2069 6e5f 6b65 792c 206f 7574 5f6b  or in_key, out_k
-00035550: 6579 2069 6e20 7a69 7028 7365 6c66 2e69  ey in zip(self.i
-00035560: 6e5f 6b65 7973 2c20 7365 6c66 2e6f 7574  n_keys, self.out
-00035570: 5f6b 6579 7329 3a0d 0a20 2020 2020 2020  _keys):..       
-00035580: 2020 2020 2069 6620 280d 0a20 2020 2020       if (..     
-00035590: 2020 2020 2020 2020 2020 2069 6e5f 6b65             in_ke
-000355a0: 7920 696e 2072 6577 6172 645f 7370 6563  y in reward_spec
-000355b0: 5f6b 6579 730d 0a20 2020 2020 2020 2020  _keys..         
-000355c0: 2020 2029 3a20 2023 2069 6620 7468 6973     ):  # if this
-000355d0: 206f 7574 5f6b 6579 2068 6173 2061 2063   out_key has a c
-000355e0: 6f72 7265 7370 6f6e 6469 6e67 206b 6579  orresponding key
-000355f0: 2069 6e20 7265 7761 7264 5f73 7065 630d   in reward_spec.
-00035600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00035610: 206f 7574 5f6b 6579 203d 205f 756e 7261   out_key = _unra
-00035620: 7665 6c5f 6b65 795f 746f 5f74 7570 6c65  vel_key_to_tuple
-00035630: 286f 7574 5f6b 6579 290d 0a20 2020 2020  (out_key)..     
-00035640: 2020 2020 2020 2020 2020 2074 656d 705f             temp_
-00035650: 6570 6973 6f64 655f 7265 7761 7264 5f73  episode_reward_s
-00035660: 7065 6320 3d20 6570 6973 6f64 655f 7265  pec = episode_re
-00035670: 7761 7264 5f73 7065 630d 0a20 2020 2020  ward_spec..     
-00035680: 2020 2020 2020 2020 2020 2074 656d 705f             temp_
-00035690: 7265 775f 7370 6563 203d 2072 6577 6172  rew_spec = rewar
-000356a0: 645f 7370 6563 0d0a 2020 2020 2020 2020  d_spec..        
-000356b0: 2020 2020 2020 2020 666f 7220 7375 625f          for sub_
-000356c0: 6b65 7920 696e 206f 7574 5f6b 6579 5b3a  key in out_key[:
-000356d0: 2d31 5d3a 0d0a 2020 2020 2020 2020 2020  -1]:..          
-000356e0: 2020 2020 2020 2020 2020 6966 2028 0d0a            if (..
-000356f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035700: 2020 2020 2020 2020 6e6f 7420 6973 696e          not isin
-00035710: 7374 616e 6365 2874 656d 705f 7265 775f  stance(temp_rew_
-00035720: 7370 6563 2c20 436f 6d70 6f73 6974 6553  spec, CompositeS
-00035730: 7065 6329 0d0a 2020 2020 2020 2020 2020  pec)..          
-00035740: 2020 2020 2020 2020 2020 2020 2020 6f72                or
-00035750: 2073 7562 5f6b 6579 206e 6f74 2069 6e20   sub_key not in 
-00035760: 7465 6d70 5f72 6577 5f73 7065 632e 6b65  temp_rew_spec.ke
-00035770: 7973 2829 0d0a 2020 2020 2020 2020 2020  ys()..          
-00035780: 2020 2020 2020 2020 2020 293a 0d0a 2020            ):..  
-00035790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000357a0: 2020 2020 2020 6272 6561 6b0d 0a20 2020        break..   
-000357b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000357c0: 2069 6620 7375 625f 6b65 7920 6e6f 7420   if sub_key not 
-000357d0: 696e 2074 656d 705f 6570 6973 6f64 655f  in temp_episode_
-000357e0: 7265 7761 7264 5f73 7065 632e 6b65 7973  reward_spec.keys
-000357f0: 2829 3a0d 0a20 2020 2020 2020 2020 2020  ():..           
-00035800: 2020 2020 2020 2020 2020 2020 2074 656d               tem
-00035810: 705f 6570 6973 6f64 655f 7265 7761 7264  p_episode_reward
-00035820: 5f73 7065 635b 7375 625f 6b65 795d 203d  _spec[sub_key] =
-00035830: 2074 656d 705f 7265 775f 7370 6563 5b0d   temp_rew_spec[.
-00035840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00035850: 2020 2020 2020 2020 2020 2020 2073 7562               sub
-00035860: 5f6b 6579 0d0a 2020 2020 2020 2020 2020  _key..          
-00035870: 2020 2020 2020 2020 2020 2020 2020 5d2e                ].
-00035880: 656d 7074 7928 290d 0a20 2020 2020 2020  empty()..       
-00035890: 2020 2020 2020 2020 2020 2020 2074 656d               tem
-000358a0: 705f 7265 775f 7370 6563 203d 2074 656d  p_rew_spec = tem
-000358b0: 705f 7265 775f 7370 6563 5b73 7562 5f6b  p_rew_spec[sub_k
-000358c0: 6579 5d0d 0a20 2020 2020 2020 2020 2020  ey]..           
-000358d0: 2020 2020 2020 2020 2074 656d 705f 6570           temp_ep
-000358e0: 6973 6f64 655f 7265 7761 7264 5f73 7065  isode_reward_spe
-000358f0: 6320 3d20 7465 6d70 5f65 7069 736f 6465  c = temp_episode
-00035900: 5f72 6577 6172 645f 7370 6563 5b73 7562  _reward_spec[sub
-00035910: 5f6b 6579 5d0d 0a20 2020 2020 2020 2020  _key]..         
-00035920: 2020 2020 2020 2065 7069 736f 6465 5f72         episode_r
-00035930: 6577 6172 645f 7370 6563 5b6f 7574 5f6b  eward_spec[out_k
-00035940: 6579 5d20 3d20 7265 7761 7264 5f73 7065  ey] = reward_spe
-00035950: 635b 696e 5f6b 6579 5d2e 636c 6f6e 6528  c[in_key].clone(
-00035960: 290d 0a20 2020 2020 2020 2020 2020 2065  )..            e
-00035970: 6c73 653a 0d0a 2020 2020 2020 2020 2020  lse:..          
-00035980: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-00035990: 6545 7272 6f72 280d 0a20 2020 2020 2020  eError(..       
-000359a0: 2020 2020 2020 2020 2020 2020 2066 2254               f"T
-000359b0: 6865 2069 6e5f 6b65 793a 207b 696e 5f6b  he in_key: {in_k
-000359c0: 6579 7d20 6973 206e 6f74 2070 7265 7365  ey} is not prese
-000359d0: 6e74 2069 6e20 7468 6520 7265 7761 7264  nt in the reward
-000359e0: 2073 7065 6320 7b72 6577 6172 645f 7370   spec {reward_sp
-000359f0: 6563 7d2e 220d 0a20 2020 2020 2020 2020  ec}."..         
-00035a00: 2020 2020 2020 2029 0d0a 2020 2020 2020         )..      
-00035a10: 2020 7265 7475 726e 2065 7069 736f 6465    return episode
-00035a20: 5f72 6577 6172 645f 7370 6563 0d0a 0d0a  _reward_spec....
-00035a30: 2020 2020 6465 6620 7472 616e 7366 6f72      def transfor
-00035a40: 6d5f 6f62 7365 7276 6174 696f 6e5f 7370  m_observation_sp
-00035a50: 6563 2873 656c 662c 206f 6273 6572 7661  ec(self, observa
-00035a60: 7469 6f6e 5f73 7065 633a 2054 656e 736f  tion_spec: Tenso
-00035a70: 7253 7065 6329 202d 3e20 5465 6e73 6f72  rSpec) -> Tensor
-00035a80: 5370 6563 3a0d 0a20 2020 2020 2020 2022  Spec:..        "
-00035a90: 2222 5472 616e 7366 6f72 6d73 2074 6865  ""Transforms the
-00035aa0: 206f 6273 6572 7661 7469 6f6e 2073 7065   observation spe
-00035ab0: 632c 2061 6464 696e 6720 7468 6520 6e65  c, adding the ne
-00035ac0: 7720 6b65 7973 2067 656e 6572 6174 6564  w keys generated
-00035ad0: 2062 7920 5265 7761 7264 5375 6d2e 2222   by RewardSum.""
-00035ae0: 220d 0a20 2020 2020 2020 2069 6620 7365  "..        if se
-00035af0: 6c66 2e72 6577 6172 645f 7370 6563 3a0d  lf.reward_spec:.
-00035b00: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00035b10: 7572 6e20 6f62 7365 7276 6174 696f 6e5f  urn observation_
-00035b20: 7370 6563 0d0a 2020 2020 2020 2020 6966  spec..        if
-00035b30: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
-00035b40: 6f62 7365 7276 6174 696f 6e5f 7370 6563  observation_spec
-00035b50: 2c20 436f 6d70 6f73 6974 6553 7065 6329  , CompositeSpec)
-00035b60: 3a0d 0a20 2020 2020 2020 2020 2020 206f  :..            o
-00035b70: 6273 6572 7661 7469 6f6e 5f73 7065 6320  bservation_spec 
-00035b80: 3d20 436f 6d70 6f73 6974 6553 7065 6328  = CompositeSpec(
-00035b90: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00035ba0: 2020 6f62 7365 7276 6174 696f 6e3d 6f62    observation=ob
-00035bb0: 7365 7276 6174 696f 6e5f 7370 6563 2c20  servation_spec, 
-00035bc0: 7368 6170 653d 7365 6c66 2e70 6172 656e  shape=self.paren
-00035bd0: 742e 6261 7463 685f 7369 7a65 0d0a 2020  t.batch_size..  
-00035be0: 2020 2020 2020 2020 2020 290d 0a20 2020            )..   
-00035bf0: 2020 2020 206f 6273 6572 7661 7469 6f6e       observation
-00035c00: 5f73 7065 632e 7570 6461 7465 2873 656c  _spec.update(sel
-00035c10: 662e 5f67 656e 6572 6174 655f 6570 6973  f._generate_epis
-00035c20: 6f64 655f 7265 7761 7264 5f73 7065 6328  ode_reward_spec(
-00035c30: 2929 0d0a 2020 2020 2020 2020 7265 7475  ))..        retu
-00035c40: 726e 206f 6273 6572 7661 7469 6f6e 5f73  rn observation_s
-00035c50: 7065 630d 0a0d 0a20 2020 2064 6566 2074  pec....    def t
-00035c60: 7261 6e73 666f 726d 5f72 6577 6172 645f  ransform_reward_
-00035c70: 7370 6563 2873 656c 662c 2072 6577 6172  spec(self, rewar
-00035c80: 645f 7370 6563 3a20 5465 6e73 6f72 5370  d_spec: TensorSp
-00035c90: 6563 2920 2d3e 2054 656e 736f 7253 7065  ec) -> TensorSpe
-00035ca0: 633a 0d0a 2020 2020 2020 2020 6966 206e  c:..        if n
-00035cb0: 6f74 2073 656c 662e 7265 7761 7264 5f73  ot self.reward_s
-00035cc0: 7065 633a 0d0a 2020 2020 2020 2020 2020  pec:..          
-00035cd0: 2020 7265 7475 726e 2072 6577 6172 645f    return reward_
-00035ce0: 7370 6563 0d0a 2020 2020 2020 2020 7265  spec..        re
-00035cf0: 7761 7264 5f73 7065 632e 7570 6461 7465  ward_spec.update
-00035d00: 2873 656c 662e 5f67 656e 6572 6174 655f  (self._generate_
-00035d10: 6570 6973 6f64 655f 7265 7761 7264 5f73  episode_reward_s
-00035d20: 7065 6328 2929 0d0a 2020 2020 2020 2020  pec())..        
-00035d30: 7265 7475 726e 2072 6577 6172 645f 7370  return reward_sp
-00035d40: 6563 0d0a 0d0a 2020 2020 6465 6620 666f  ec....    def fo
-00035d50: 7277 6172 6428 7365 6c66 2c20 7465 6e73  rward(self, tens
-00035d60: 6f72 6469 6374 3a20 5465 6e73 6f72 4469  ordict: TensorDi
-00035d70: 6374 4261 7365 2920 2d3e 2054 656e 736f  ctBase) -> Tenso
-00035d80: 7244 6963 7442 6173 653a 0d0a 2020 2020  rDictBase:..    
-00035d90: 2020 2020 7469 6d65 5f64 696d 203d 205b      time_dim = [
-00035da0: 6920 666f 7220 692c 206e 616d 6520 696e  i for i, name in
-00035db0: 2065 6e75 6d65 7261 7465 2874 656e 736f   enumerate(tenso
-00035dc0: 7264 6963 742e 6e61 6d65 7329 2069 6620  rdict.names) if 
-00035dd0: 6e61 6d65 203d 3d20 2274 696d 6522 5d0d  name == "time"].
-00035de0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00035df0: 7469 6d65 5f64 696d 3a0d 0a20 2020 2020  time_dim:..     
-00035e00: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00035e10: 7565 4572 726f 7228 0d0a 2020 2020 2020  ueError(..      
-00035e20: 2020 2020 2020 2020 2020 2241 7420 6c65            "At le
-00035e30: 6173 7420 6f6e 6520 6469 6d65 6e73 696f  ast one dimensio
-00035e40: 6e20 6f66 2074 6865 2074 656e 736f 7264  n of the tensord
-00035e50: 6963 7420 6d75 7374 2062 6520 6e61 6d65  ict must be name
-00035e60: 6420 2774 696d 6527 2069 6e20 6f66 666c  d 'time' in offl
-00035e70: 696e 6520 6d6f 6465 220d 0a20 2020 2020  ine mode"..     
-00035e80: 2020 2020 2020 2029 0d0a 2020 2020 2020         )..      
-00035e90: 2020 7469 6d65 5f64 696d 203d 2074 696d    time_dim = tim
-00035ea0: 655f 6469 6d5b 305d 202d 2031 0d0a 2020  e_dim[0] - 1..  
-00035eb0: 2020 2020 2020 666f 7220 696e 5f6b 6579        for in_key
-00035ec0: 2c20 6f75 745f 6b65 7920 696e 207a 6970  , out_key in zip
-00035ed0: 2873 656c 662e 696e 5f6b 6579 732c 2073  (self.in_keys, s
-00035ee0: 656c 662e 6f75 745f 6b65 7973 293a 0d0a  elf.out_keys):..
-00035ef0: 2020 2020 2020 2020 2020 2020 7265 7761              rewa
-00035f00: 7264 203d 2074 656e 736f 7264 6963 742e  rd = tensordict.
-00035f10: 6765 7428 696e 5f6b 6579 290d 0a20 2020  get(in_key)..   
-00035f20: 2020 2020 2020 2020 2063 756d 7375 6d20           cumsum 
-00035f30: 3d20 7265 7761 7264 2e63 756d 7375 6d28  = reward.cumsum(
-00035f40: 7469 6d65 5f64 696d 290d 0a20 2020 2020  time_dim)..     
-00035f50: 2020 2020 2020 2074 656e 736f 7264 6963         tensordic
-00035f60: 742e 7365 7428 6f75 745f 6b65 792c 2063  t.set(out_key, c
-00035f70: 756d 7375 6d29 0d0a 2020 2020 2020 2020  umsum)..        
-00035f80: 7265 7475 726e 2074 656e 736f 7264 6963  return tensordic
-00035f90: 740d 0a0d 0a0d 0a63 6c61 7373 2053 7465  t......class Ste
-00035fa0: 7043 6f75 6e74 6572 2854 7261 6e73 666f  pCounter(Transfo
-00035fb0: 726d 293a 0d0a 2020 2020 2222 2243 6f75  rm):..    """Cou
-00035fc0: 6e74 7320 7468 6520 7374 6570 7320 6672  nts the steps fr
-00035fd0: 6f6d 2061 2072 6573 6574 2061 6e64 206f  om a reset and o
-00035fe0: 7074 696f 6e61 6c6c 7920 7365 7473 2074  ptionally sets t
-00035ff0: 6865 2074 7275 6e63 6174 6564 2073 7461  he truncated sta
-00036000: 7465 2074 6f20 6060 5472 7565 6060 2061  te to ``True`` a
-00036010: 6674 6572 2061 2063 6572 7461 696e 206e  fter a certain n
-00036020: 756d 6265 7220 6f66 2073 7465 7073 2e0d  umber of steps..
-00036030: 0a0d 0a20 2020 2054 6865 2060 6022 646f  ...    The ``"do
-00036040: 6e65 2260 6020 7374 6174 6520 6973 2061  ne"`` state is a
-00036050: 6c73 6f20 6164 6170 7465 6420 6163 636f  lso adapted acco
-00036060: 7264 696e 676c 7920 2861 7320 646f 6e65  rdingly (as done
-00036070: 2069 7320 7468 6520 6469 736a 756e 6374   is the disjunct
-00036080: 696f 6e0d 0a20 2020 206f 6620 7461 736b  ion..    of task
-00036090: 2063 6f6d 706c 6574 696f 6e20 616e 6420   completion and 
-000360a0: 6561 726c 7920 7472 756e 6361 7469 6f6e  early truncation
-000360b0: 292e 0d0a 0d0a 2020 2020 4172 6773 3a0d  ).....    Args:.
-000360c0: 0a20 2020 2020 2020 206d 6178 5f73 7465  .        max_ste
-000360d0: 7073 2028 696e 742c 206f 7074 696f 6e61  ps (int, optiona
-000360e0: 6c29 3a20 6120 706f 7369 7469 7665 2069  l): a positive i
-000360f0: 6e74 6567 6572 2074 6861 7420 696e 6469  nteger that indi
-00036100: 6361 7465 7320 7468 650d 0a20 2020 2020  cates the..     
-00036110: 2020 2020 2020 206d 6178 696d 756d 206e         maximum n
-00036120: 756d 6265 7220 6f66 2073 7465 7073 2074  umber of steps t
-00036130: 6f20 7461 6b65 2062 6566 6f72 6520 7365  o take before se
-00036140: 7474 696e 6720 7468 6520 6060 7472 756e  tting the ``trun
-00036150: 6361 7465 645f 6b65 7960 600d 0a20 2020  cated_key``..   
-00036160: 2020 2020 2020 2020 2065 6e74 7279 2074           entry t
-00036170: 6f20 6060 5472 7565 6060 2e0d 0a20 2020  o ``True``...   
-00036180: 2020 2020 2074 7275 6e63 6174 6564 5f6b       truncated_k
-00036190: 6579 2028 7374 722c 206f 7074 696f 6e61  ey (str, optiona
-000361a0: 6c29 3a20 7468 6520 6b65 7920 7768 6572  l): the key wher
-000361b0: 6520 7468 6520 7472 756e 6361 7465 6420  e the truncated 
-000361c0: 656e 7472 6965 730d 0a20 2020 2020 2020  entries..       
-000361d0: 2020 2020 2073 686f 756c 6420 6265 2077       should be w
-000361e0: 7269 7474 656e 2e20 4465 6661 756c 7473  ritten. Defaults
-000361f0: 2074 6f20 6060 2274 7275 6e63 6174 6564   to ``"truncated
-00036200: 2260 602c 2077 6869 6368 2069 7320 7265  "``, which is re
-00036210: 636f 676e 6973 6564 2062 790d 0a20 2020  cognised by..   
-00036220: 2020 2020 2020 2020 2064 6174 6120 636f           data co
-00036230: 6c6c 6563 746f 7273 2061 7320 6120 7265  llectors as a re
-00036240: 7365 7420 7369 676e 616c 2e0d 0a20 2020  set signal...   
-00036250: 2020 2020 2020 2020 2054 6869 7320 6172           This ar
-00036260: 6775 6d65 6e74 2063 616e 206f 6e6c 7920  gument can only 
-00036270: 6265 2061 2073 7472 696e 6720 286e 6f74  be a string (not
-00036280: 2061 206e 6573 7465 6420 6b65 7929 2061   a nested key) a
-00036290: 7320 6974 2077 696c 6c20 6265 0d0a 2020  s it will be..  
-000362a0: 2020 2020 2020 2020 2020 6d61 7463 6865            matche
-000362b0: 6420 746f 2065 6163 6820 6f66 2074 6865  d to each of the
-000362c0: 206c 6561 6620 646f 6e65 206b 6579 2069   leaf done key i
-000362d0: 6e20 7468 6520 7061 7265 6e74 2065 6e76  n the parent env
-000362e0: 6972 6f6e 6d65 6e74 0d0a 2020 2020 2020  ironment..      
-000362f0: 2020 2020 2020 2865 672c 2061 2060 6028        (eg, a ``(
-00036300: 2261 6765 6e74 222c 2022 646f 6e65 2229  "agent", "done")
-00036310: 6060 206b 6579 2077 696c 6c20 6265 2061  `` key will be a
-00036320: 6363 6f6d 7061 6e69 6564 2062 7920 610d  ccompanied by a.
-00036330: 0a20 2020 2020 2020 2020 2020 2060 6028  .            ``(
-00036340: 2261 6765 6e74 222c 2022 7472 756e 6361  "agent", "trunca
-00036350: 7465 6422 2960 6020 6966 2074 6865 2060  ted")`` if the `
-00036360: 6022 7472 756e 6361 7465 6422 6060 206b  `"truncated"`` k
-00036370: 6579 206e 616d 6520 6973 2075 7365 6429  ey name is used)
-00036380: 2e0d 0a20 2020 2020 2020 2073 7465 705f  ...        step_
-00036390: 636f 756e 745f 6b65 7920 2873 7472 2c20  count_key (str, 
-000363a0: 6f70 7469 6f6e 616c 293a 2074 6865 206b  optional): the k
-000363b0: 6579 2077 6865 7265 2074 6865 2073 7465  ey where the ste
-000363c0: 7020 636f 756e 7420 656e 7472 6965 730d  p count entries.
-000363d0: 0a20 2020 2020 2020 2020 2020 2073 686f  .            sho
-000363e0: 756c 6420 6265 2077 7269 7474 656e 2e20  uld be written. 
-000363f0: 4465 6661 756c 7473 2074 6f20 6060 2273  Defaults to ``"s
-00036400: 7465 705f 636f 756e 7422 6060 2e0d 0a20  tep_count"``... 
-00036410: 2020 2020 2020 2020 2020 2054 6869 7320             This 
-00036420: 6172 6775 6d65 6e74 2063 616e 206f 6e6c  argument can onl
-00036430: 7920 6265 2061 2073 7472 696e 6720 286e  y be a string (n
-00036440: 6f74 2061 206e 6573 7465 6420 6b65 7929  ot a nested key)
-00036450: 2061 7320 6974 2077 696c 6c20 6265 0d0a   as it will be..
-00036460: 2020 2020 2020 2020 2020 2020 6d61 7463              matc
-00036470: 6865 6420 746f 2065 6163 6820 6f66 2074  hed to each of t
-00036480: 6865 206c 6561 6620 646f 6e65 206b 6579  he leaf done key
-00036490: 2069 6e20 7468 6520 7061 7265 6e74 2065   in the parent e
-000364a0: 6e76 6972 6f6e 6d65 6e74 0d0a 2020 2020  nvironment..    
-000364b0: 2020 2020 2020 2020 2865 672c 2061 2060          (eg, a `
-000364c0: 6028 2261 6765 6e74 222c 2022 646f 6e65  `("agent", "done
-000364d0: 2229 6060 206b 6579 2077 696c 6c20 6265  ")`` key will be
-000364e0: 2061 6363 6f6d 7061 6e69 6564 2062 7920   accompanied by 
-000364f0: 610d 0a20 2020 2020 2020 2020 2020 2060  a..            `
-00036500: 6028 2261 6765 6e74 222c 2022 7374 6570  `("agent", "step
-00036510: 5f63 6f75 6e74 2229 6060 2069 6620 7468  _count")`` if th
-00036520: 6520 6060 2273 7465 705f 636f 756e 7422  e ``"step_count"
-00036530: 6060 206b 6579 206e 616d 6520 6973 2075  `` key name is u
-00036540: 7365 6429 2e0d 0a20 2020 2020 2020 2075  sed)...        u
-00036550: 7064 6174 655f 646f 6e65 2028 626f 6f6c  pdate_done (bool
-00036560: 2c20 6f70 7469 6f6e 616c 293a 2069 6620  , optional): if 
-00036570: 6060 5472 7565 6060 2c20 7468 6520 6060  ``True``, the ``
-00036580: 2264 6f6e 6522 6060 2062 6f6f 6c65 616e  "done"`` boolean
-00036590: 2074 656e 736f 720d 0a20 2020 2020 2020   tensor..       
-000365a0: 2020 2020 2061 7420 7468 6520 6c65 7665       at the leve
-000365b0: 6c20 6f66 2060 6022 7472 756e 6361 7465  l of ``"truncate
-000365c0: 6422 6060 0d0a 2020 2020 2020 2020 2020  d"``..          
-000365d0: 2020 7769 6c6c 2062 6520 7570 6461 7465    will be update
-000365e0: 642e 0d0a 2020 2020 2020 2020 2020 2020  d...            
-000365f0: 5468 6973 2073 6967 6e61 6c20 696e 6469  This signal indi
-00036600: 6361 7465 7320 7468 6174 2074 6865 2074  cates that the t
-00036610: 7261 6a65 6374 6f72 7920 6861 7320 7265  rajectory has re
-00036620: 6163 6865 6420 6974 7320 656e 6473 2c0d  ached its ends,.
-00036630: 0a20 2020 2020 2020 2020 2020 2065 6974  .            eit
-00036640: 6865 7220 6265 6361 7573 6520 7468 6520  her because the 
-00036650: 7461 736b 2069 7320 636f 6d70 6c65 7465  task is complete
-00036660: 6420 2860 6022 636f 6d70 6c65 7465 6422  d (``"completed"
-00036670: 6060 2065 6e74 7279 2069 730d 0a20 2020  `` entry is..   
-00036680: 2020 2020 2020 2020 2060 6054 7275 6560           ``True`
-00036690: 6029 206f 7220 6265 6361 7573 6520 6974  `) or because it
-000366a0: 2068 6173 2062 6565 6e20 7472 756e 6361   has been trunca
-000366b0: 7465 6420 2860 6022 7472 756e 6361 7465  ted (``"truncate
-000366c0: 6422 6060 2065 6e74 7279 0d0a 2020 2020  d"`` entry..    
-000366d0: 2020 2020 2020 2020 6973 2060 6054 7275          is ``Tru
-000366e0: 6560 6029 2e0d 0a20 2020 2020 2020 2020  e``)...         
-000366f0: 2020 2044 6566 6175 6c74 7320 746f 2060     Defaults to `
-00036700: 6054 7275 6560 602e 0d0a 0d0a 2020 2020  `True``.....    
-00036710: 2e2e 206e 6f74 653a 3a20 546f 2065 6e73  .. note:: To ens
-00036720: 7572 6520 636f 6d70 6174 6962 696c 6974  ure compatibilit
-00036730: 7920 7769 7468 2065 6e76 6972 6f6e 6d65  y with environme
-00036740: 6e74 7320 7468 6174 2068 6176 6520 6d75  nts that have mu
-00036750: 6c74 6970 6c65 0d0a 2020 2020 2020 2020  ltiple..        
-00036760: 646f 6e65 5f6b 6579 2873 292c 2074 6869  done_key(s), thi
-00036770: 7320 7472 616e 7366 6f72 6d20 7769 6c6c  s transform will
-00036780: 2077 7269 7465 2061 2073 7465 705f 636f   write a step_co
-00036790: 756e 7420 656e 7472 7920 666f 720d 0a20  unt entry for.. 
-000367a0: 2020 2020 2020 2065 7665 7279 2064 6f6e         every don
-000367b0: 6520 656e 7472 7920 7769 7468 696e 2074  e entry within t
-000367c0: 6865 2074 656e 736f 7264 6963 742e 0d0a  he tensordict...
-000367d0: 0d0a 2020 2020 4578 616d 706c 6573 3a0d  ..    Examples:.
-000367e0: 0a20 2020 2020 2020 203e 3e3e 2069 6d70  .        >>> imp
-000367f0: 6f72 7420 6779 6d6e 6173 6975 6d0d 0a20  ort gymnasium.. 
-00036800: 2020 2020 2020 203e 3e3e 2066 726f 6d20         >>> from 
-00036810: 746f 7263 6872 6c2e 656e 7673 2069 6d70  torchrl.envs imp
-00036820: 6f72 7420 4779 6d57 7261 7070 6572 0d0a  ort GymWrapper..
-00036830: 2020 2020 2020 2020 3e3e 3e20 6261 7365          >>> base
-00036840: 5f65 6e76 203d 2047 796d 5772 6170 7065  _env = GymWrappe
-00036850: 7228 6779 6d6e 6173 6975 6d2e 6d61 6b65  r(gymnasium.make
-00036860: 2822 5065 6e64 756c 756d 2d76 3122 2929  ("Pendulum-v1"))
-00036870: 0d0a 2020 2020 2020 2020 3e3e 3e20 656e  ..        >>> en
-00036880: 7620 3d20 5472 616e 7366 6f72 6d65 6445  v = TransformedE
-00036890: 6e76 2862 6173 655f 656e 762c 0d0a 2020  nv(base_env,..  
-000368a0: 2020 2020 2020 2e2e 2e20 2020 2020 5374        ...     St
-000368b0: 6570 436f 756e 7465 7228 6d61 785f 7374  epCounter(max_st
-000368c0: 6570 733d 3529 290d 0a20 2020 2020 2020  eps=5))..       
-000368d0: 203e 3e3e 2072 6f6c 6c6f 7574 203d 2065   >>> rollout = e
-000368e0: 6e76 2e72 6f6c 6c6f 7574 2831 3030 290d  nv.rollout(100).
-000368f0: 0a20 2020 2020 2020 203e 3e3e 2070 7269  .        >>> pri
-00036900: 6e74 2872 6f6c 6c6f 7574 290d 0a20 2020  nt(rollout)..   
-00036910: 2020 2020 2054 656e 736f 7244 6963 7428       TensorDict(
-00036920: 0d0a 2020 2020 2020 2020 2020 2020 6669  ..            fi
-00036930: 656c 6473 3d7b 0d0a 2020 2020 2020 2020  elds={..        
-00036940: 2020 2020 2020 2020 6163 7469 6f6e 3a20          action: 
-00036950: 5465 6e73 6f72 2873 6861 7065 3d74 6f72  Tensor(shape=tor
-00036960: 6368 2e53 697a 6528 5b35 2c20 315d 292c  ch.Size([5, 1]),
-00036970: 2064 6576 6963 653d 6370 752c 2064 7479   device=cpu, dty
-00036980: 7065 3d74 6f72 6368 2e66 6c6f 6174 3332  pe=torch.float32
-00036990: 2c20 6973 5f73 6861 7265 643d 4661 6c73  , is_shared=Fals
-000369a0: 6529 2c0d 0a20 2020 2020 2020 2020 2020  e),..           
-000369b0: 2020 2020 2064 6f6e 653a 2054 656e 736f       done: Tenso
-000369c0: 7228 7368 6170 653d 746f 7263 682e 5369  r(shape=torch.Si
-000369d0: 7a65 285b 352c 2031 5d29 2c20 6465 7669  ze([5, 1]), devi
-000369e0: 6365 3d63 7075 2c20 6474 7970 653d 746f  ce=cpu, dtype=to
-000369f0: 7263 682e 626f 6f6c 2c20 6973 5f73 6861  rch.bool, is_sha
-00036a00: 7265 643d 4661 6c73 6529 2c0d 0a20 2020  red=False),..   
-00036a10: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
-00036a20: 706c 6574 6564 3a20 5465 6e73 6f72 2873  pleted: Tensor(s
-00036a30: 6861 7065 3d74 6f72 6368 2e53 697a 6528  hape=torch.Size(
-00036a40: 5b35 2c20 315d 292c 2064 6576 6963 653d  [5, 1]), device=
-00036a50: 6370 752c 2064 7479 7065 3d74 6f72 6368  cpu, dtype=torch
-00036a60: 2e62 6f6f 6c2c 2069 735f 7368 6172 6564  .bool, is_shared
-00036a70: 3d46 616c 7365 297d 2c0d 0a20 2020 2020  =False)},..     
-00036a80: 2020 2020 2020 2020 2020 206e 6578 743a             next:
-00036a90: 2054 656e 736f 7244 6963 7428 0d0a 2020   TensorDict(..  
-00036aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036ab0: 2020 6669 656c 6473 3d7b 0d0a 2020 2020    fields={..    
-00036ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036ad0: 2020 2020 646f 6e65 3a20 5465 6e73 6f72      done: Tensor
-00036ae0: 2873 6861 7065 3d74 6f72 6368 2e53 697a  (shape=torch.Siz
-00036af0: 6528 5b35 2c20 315d 292c 2064 6576 6963  e([5, 1]), devic
-00036b00: 653d 6370 752c 2064 7479 7065 3d74 6f72  e=cpu, dtype=tor
-00036b10: 6368 2e62 6f6f 6c2c 2069 735f 7368 6172  ch.bool, is_shar
-00036b20: 6564 3d46 616c 7365 292c 0d0a 2020 2020  ed=False),..    
-00036b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036b40: 2020 2020 636f 6d70 6c65 7465 643a 2054      completed: T
-00036b50: 656e 736f 7228 7368 6170 653d 746f 7263  ensor(shape=torc
-00036b60: 682e 5369 7a65 285b 352c 2031 5d29 2c20  h.Size([5, 1]), 
-00036b70: 6465 7669 6365 3d63 7075 2c20 6474 7970  device=cpu, dtyp
-00036b80: 653d 746f 7263 682e 626f 6f6c 2c20 6973  e=torch.bool, is
-00036b90: 5f73 6861 7265 643d 4661 6c73 6529 7d2c  _shared=False)},
-00036ba0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00036bb0: 2020 2020 2020 2020 2020 6f62 7365 7276            observ
-00036bc0: 6174 696f 6e3a 2054 656e 736f 7228 7368  ation: Tensor(sh
-00036bd0: 6170 653d 746f 7263 682e 5369 7a65 285b  ape=torch.Size([
-00036be0: 352c 2033 5d29 2c20 6465 7669 6365 3d63  5, 3]), device=c
-00036bf0: 7075 2c20 6474 7970 653d 746f 7263 682e  pu, dtype=torch.
-00036c00: 666c 6f61 7433 322c 2069 735f 7368 6172  float32, is_shar
-00036c10: 6564 3d46 616c 7365 292c 0d0a 2020 2020  ed=False),..    
-00036c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036c30: 2020 2020 7265 7761 7264 3a20 5465 6e73      reward: Tens
-00036c40: 6f72 2873 6861 7065 3d74 6f72 6368 2e53  or(shape=torch.S
-00036c50: 697a 6528 5b35 2c20 315d 292c 2064 6576  ize([5, 1]), dev
-00036c60: 6963 653d 6370 752c 2064 7479 7065 3d74  ice=cpu, dtype=t
-00036c70: 6f72 6368 2e66 6c6f 6174 3332 2c20 6973  orch.float32, is
-00036c80: 5f73 6861 7265 643d 4661 6c73 6529 2c0d  _shared=False),.
-00036c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00036ca0: 2020 2020 2020 2020 2073 7465 705f 636f           step_co
-00036cb0: 756e 743a 2054 656e 736f 7228 7368 6170  unt: Tensor(shap
-00036cc0: 653d 746f 7263 682e 5369 7a65 285b 352c  e=torch.Size([5,
-00036cd0: 2031 5d29 2c20 6465 7669 6365 3d63 7075   1]), device=cpu
-00036ce0: 2c20 6474 7970 653d 746f 7263 682e 696e  , dtype=torch.in
-00036cf0: 7436 342c 2069 735f 7368 6172 6564 3d46  t64, is_shared=F
-00036d00: 616c 7365 292c 0d0a 2020 2020 2020 2020  alse),..        
-00036d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036d20: 7472 756e 6361 7465 643a 2054 656e 736f  truncated: Tenso
-00036d30: 7228 7368 6170 653d 746f 7263 682e 5369  r(shape=torch.Si
-00036d40: 7a65 285b 352c 2031 5d29 2c20 6465 7669  ze([5, 1]), devi
-00036d50: 6365 3d63 7075 2c20 6474 7970 653d 746f  ce=cpu, dtype=to
-00036d60: 7263 682e 626f 6f6c 2c20 6973 5f73 6861  rch.bool, is_sha
-00036d70: 7265 643d 4661 6c73 6529 7d2c 0d0a 2020  red=False)},..  
-00036d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036d90: 2020 6261 7463 685f 7369 7a65 3d74 6f72    batch_size=tor
-00036da0: 6368 2e53 697a 6528 5b35 5d29 2c0d 0a20  ch.Size([5]),.. 
-00036db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036dc0: 2020 2064 6576 6963 653d 6370 752c 0d0a     device=cpu,..
-00036dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036de0: 2020 2020 6973 5f73 6861 7265 643d 4661      is_shared=Fa
-00036df0: 6c73 6529 2c0d 0a20 2020 2020 2020 2020  lse),..         
-00036e00: 2020 2020 2020 206f 6273 6572 7661 7469         observati
-00036e10: 6f6e 3a20 5465 6e73 6f72 2873 6861 7065  on: Tensor(shape
-00036e20: 3d74 6f72 6368 2e53 697a 6528 5b35 2c20  =torch.Size([5, 
-00036e30: 335d 292c 2064 6576 6963 653d 6370 752c  3]), device=cpu,
-00036e40: 2064 7479 7065 3d74 6f72 6368 2e66 6c6f   dtype=torch.flo
-00036e50: 6174 3332 2c20 6973 5f73 6861 7265 643d  at32, is_shared=
-00036e60: 4661 6c73 6529 2c0d 0a20 2020 2020 2020  False),..       
-00036e70: 2020 2020 2020 2020 2073 7465 705f 636f           step_co
-00036e80: 756e 743a 2054 656e 736f 7228 7368 6170  unt: Tensor(shap
-00036e90: 653d 746f 7263 682e 5369 7a65 285b 352c  e=torch.Size([5,
-00036ea0: 2031 5d29 2c20 6465 7669 6365 3d63 7075   1]), device=cpu
-00036eb0: 2c20 6474 7970 653d 746f 7263 682e 696e  , dtype=torch.in
-00036ec0: 7436 342c 2069 735f 7368 6172 6564 3d46  t64, is_shared=F
-00036ed0: 616c 7365 292c 0d0a 2020 2020 2020 2020  alse),..        
-00036ee0: 2020 2020 2020 2020 7472 756e 6361 7465          truncate
-00036ef0: 643a 2054 656e 736f 7228 7368 6170 653d  d: Tensor(shape=
-00036f00: 746f 7263 682e 5369 7a65 285b 352c 2031  torch.Size([5, 1
-00036f10: 5d29 2c20 6465 7669 6365 3d63 7075 2c20  ]), device=cpu, 
-00036f20: 6474 7970 653d 746f 7263 682e 626f 6f6c  dtype=torch.bool
-00036f30: 2c20 6973 5f73 6861 7265 643d 4661 6c73  , is_shared=Fals
-00036f40: 6529 7d2c 0d0a 2020 2020 2020 2020 2020  e)},..          
-00036f50: 2020 6261 7463 685f 7369 7a65 3d74 6f72    batch_size=tor
-00036f60: 6368 2e53 697a 6528 5b35 5d29 2c0d 0a20  ch.Size([5]),.. 
-00036f70: 2020 2020 2020 2020 2020 2064 6576 6963             devic
-00036f80: 653d 6370 752c 0d0a 2020 2020 2020 2020  e=cpu,..        
-00036f90: 2020 2020 6973 5f73 6861 7265 643d 4661      is_shared=Fa
-00036fa0: 6c73 6529 0d0a 2020 2020 2020 2020 3e3e  lse)..        >>
-00036fb0: 3e20 7072 696e 7428 726f 6c6c 6f75 745b  > print(rollout[
-00036fc0: 226e 6578 7422 2c20 2273 7465 705f 636f  "next", "step_co
-00036fd0: 756e 7422 5d29 0d0a 2020 2020 2020 2020  unt"])..        
-00036fe0: 7465 6e73 6f72 285b 5b31 5d2c 0d0a 2020  tensor([[1],..  
-00036ff0: 2020 2020 2020 2020 2020 2020 2020 5b32                [2
-00037000: 5d2c 0d0a 2020 2020 2020 2020 2020 2020  ],..            
-00037010: 2020 2020 5b33 5d2c 0d0a 2020 2020 2020      [3],..      
-00037020: 2020 2020 2020 2020 2020 5b34 5d2c 0d0a            [4],..
-00037030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037040: 5b35 5d5d 290d 0a0d 0a20 2020 2022 2222  [5]])....    """
-00037050: 0d0a 0d0a 2020 2020 696e 7665 7274 6962  ....    invertib
-00037060: 6c65 203d 2046 616c 7365 0d0a 0d0a 2020  le = False....  
-00037070: 2020 6465 6620 5f5f 696e 6974 5f5f 280d    def __init__(.
-00037080: 0a20 2020 2020 2020 2073 656c 662c 0d0a  .        self,..
-00037090: 2020 2020 2020 2020 6d61 785f 7374 6570          max_step
-000370a0: 733a 204f 7074 696f 6e61 6c5b 696e 745d  s: Optional[int]
-000370b0: 203d 204e 6f6e 652c 0d0a 2020 2020 2020   = None,..      
-000370c0: 2020 7472 756e 6361 7465 645f 6b65 793a    truncated_key:
-000370d0: 2073 7472 207c 204e 6f6e 6520 3d20 2274   str | None = "t
-000370e0: 7275 6e63 6174 6564 222c 0d0a 2020 2020  runcated",..    
-000370f0: 2020 2020 7374 6570 5f63 6f75 6e74 5f6b      step_count_k
-00037100: 6579 3a20 7374 7220 7c20 4e6f 6e65 203d  ey: str | None =
-00037110: 2022 7374 6570 5f63 6f75 6e74 222c 0d0a   "step_count",..
-00037120: 2020 2020 2020 2020 7570 6461 7465 5f64          update_d
-00037130: 6f6e 653a 2062 6f6f 6c20 3d20 5472 7565  one: bool = True
-00037140: 2c0d 0a20 2020 2029 3a0d 0a20 2020 2020  ,..    ):..     
-00037150: 2020 2069 6620 6d61 785f 7374 6570 7320     if max_steps 
-00037160: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
-00037170: 6d61 785f 7374 6570 7320 3c20 313a 0d0a  max_steps < 1:..
-00037180: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00037190: 6520 5661 6c75 6545 7272 6f72 2822 6d61  e ValueError("ma
-000371a0: 785f 7374 6570 7320 7368 6f75 6c64 2068  x_steps should h
-000371b0: 6176 6520 6120 7661 6c75 6520 6772 6561  ave a value grea
-000371c0: 7465 7220 6f72 2065 7175 616c 2074 6f20  ter or equal to 
-000371d0: 6f6e 652e 2229 0d0a 2020 2020 2020 2020  one.")..        
-000371e0: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
-000371f0: 6528 7472 756e 6361 7465 645f 6b65 792c  e(truncated_key,
-00037200: 2073 7472 293a 0d0a 2020 2020 2020 2020   str):..        
-00037210: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-00037220: 7272 6f72 2822 7472 756e 6361 7465 645f  rror("truncated_
-00037230: 6b65 7920 6d75 7374 2062 6520 6120 7374  key must be a st
-00037240: 7269 6e67 2e22 290d 0a20 2020 2020 2020  ring.")..       
-00037250: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
-00037260: 6365 2873 7465 705f 636f 756e 745f 6b65  ce(step_count_ke
-00037270: 792c 2073 7472 293a 0d0a 2020 2020 2020  y, str):..      
-00037280: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-00037290: 6545 7272 6f72 2822 7374 6570 5f63 6f75  eError("step_cou
-000372a0: 6e74 5f6b 6579 206d 7573 7420 6265 2061  nt_key must be a
-000372b0: 2073 7472 696e 672e 2229 0d0a 2020 2020   string.")..    
-000372c0: 2020 2020 7365 6c66 2e6d 6178 5f73 7465      self.max_ste
-000372d0: 7073 203d 206d 6178 5f73 7465 7073 0d0a  ps = max_steps..
-000372e0: 2020 2020 2020 2020 7365 6c66 2e74 7275          self.tru
-000372f0: 6e63 6174 6564 5f6b 6579 203d 2074 7275  ncated_key = tru
-00037300: 6e63 6174 6564 5f6b 6579 0d0a 2020 2020  ncated_key..    
-00037310: 2020 2020 7365 6c66 2e73 7465 705f 636f      self.step_co
-00037320: 756e 745f 6b65 7920 3d20 7374 6570 5f63  unt_key = step_c
-00037330: 6f75 6e74 5f6b 6579 0d0a 2020 2020 2020  ount_key..      
-00037340: 2020 7365 6c66 2e75 7064 6174 655f 646f    self.update_do
-00037350: 6e65 203d 2075 7064 6174 655f 646f 6e65  ne = update_done
-00037360: 0d0a 2020 2020 2020 2020 7375 7065 7228  ..        super(
-00037370: 292e 5f5f 696e 6974 5f5f 2829 0d0a 0d0a  ).__init__()....
-00037380: 2020 2020 4070 726f 7065 7274 790d 0a20      @property.. 
-00037390: 2020 2064 6566 2074 7275 6e63 6174 6564     def truncated
-000373a0: 5f6b 6579 7328 7365 6c66 293a 0d0a 2020  _keys(self):..  
-000373b0: 2020 2020 2020 7472 756e 6361 7465 645f        truncated_
-000373c0: 6b65 7973 203d 2073 656c 662e 5f5f 6469  keys = self.__di
-000373d0: 6374 5f5f 2e67 6574 2822 5f74 7275 6e63  ct__.get("_trunc
-000373e0: 6174 6564 5f6b 6579 7322 2c20 4e6f 6e65  ated_keys", None
-000373f0: 290d 0a20 2020 2020 2020 2069 6620 7472  )..        if tr
-00037400: 756e 6361 7465 645f 6b65 7973 2069 7320  uncated_keys is 
-00037410: 4e6f 6e65 3a0d 0a20 2020 2020 2020 2020  None:..         
-00037420: 2020 2023 206d 616b 6520 7468 6520 6465     # make the de
-00037430: 6661 756c 7420 7472 756e 6361 7465 6420  fault truncated 
-00037440: 6b65 7973 0d0a 2020 2020 2020 2020 2020  keys..          
-00037450: 2020 7472 756e 6361 7465 645f 6b65 7973    truncated_keys
-00037460: 203d 205b 5d0d 0a20 2020 2020 2020 2020   = []..         
-00037470: 2020 2066 6f72 2072 6573 6574 5f6b 6579     for reset_key
-00037480: 2069 6e20 7365 6c66 2e70 6172 656e 742e   in self.parent.
-00037490: 5f66 696c 7465 7265 645f 7265 7365 745f  _filtered_reset_
-000374a0: 6b65 7973 3a0d 0a20 2020 2020 2020 2020  keys:..         
-000374b0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-000374c0: 616e 6365 2872 6573 6574 5f6b 6579 2c20  ance(reset_key, 
-000374d0: 7374 7229 3a0d 0a20 2020 2020 2020 2020  str):..         
-000374e0: 2020 2020 2020 2020 2020 206b 6579 203d             key =
-000374f0: 2073 656c 662e 7472 756e 6361 7465 645f   self.truncated_
-00037500: 6b65 790d 0a20 2020 2020 2020 2020 2020  key..           
-00037510: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
-00037520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037530: 6b65 7920 3d20 282a 7265 7365 745f 6b65  key = (*reset_ke
-00037540: 795b 3a2d 315d 2c20 7365 6c66 2e74 7275  y[:-1], self.tru
-00037550: 6e63 6174 6564 5f6b 6579 290d 0a20 2020  ncated_key)..   
-00037560: 2020 2020 2020 2020 2020 2020 2074 7275               tru
-00037570: 6e63 6174 6564 5f6b 6579 732e 6170 7065  ncated_keys.appe
-00037580: 6e64 286b 6579 290d 0a20 2020 2020 2020  nd(key)..       
-00037590: 2073 656c 662e 5f74 7275 6e63 6174 6564   self._truncated
-000375a0: 5f6b 6579 7320 3d20 7472 756e 6361 7465  _keys = truncate
-000375b0: 645f 6b65 7973 0d0a 2020 2020 2020 2020  d_keys..        
-000375c0: 7265 7475 726e 2074 7275 6e63 6174 6564  return truncated
-000375d0: 5f6b 6579 730d 0a0d 0a20 2020 2040 7072  _keys....    @pr
-000375e0: 6f70 6572 7479 0d0a 2020 2020 6465 6620  operty..    def 
-000375f0: 646f 6e65 5f6b 6579 7328 7365 6c66 293a  done_keys(self):
-00037600: 0d0a 2020 2020 2020 2020 646f 6e65 5f6b  ..        done_k
-00037610: 6579 7320 3d20 7365 6c66 2e5f 5f64 6963  eys = self.__dic
-00037620: 745f 5f2e 6765 7428 225f 646f 6e65 5f6b  t__.get("_done_k
-00037630: 6579 7322 2c20 4e6f 6e65 290d 0a20 2020  eys", None)..   
-00037640: 2020 2020 2069 6620 646f 6e65 5f6b 6579       if done_key
-00037650: 7320 6973 204e 6f6e 653a 0d0a 2020 2020  s is None:..    
-00037660: 2020 2020 2020 2020 2320 6d61 6b65 2074          # make t
-00037670: 6865 2064 6566 6175 6c74 2064 6f6e 6520  he default done 
-00037680: 6b65 7973 0d0a 2020 2020 2020 2020 2020  keys..          
-00037690: 2020 646f 6e65 5f6b 6579 7320 3d20 5b5d    done_keys = []
-000376a0: 0d0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
-000376b0: 7220 7265 7365 745f 6b65 7920 696e 2073  r reset_key in s
-000376c0: 656c 662e 7061 7265 6e74 2e5f 6669 6c74  elf.parent._filt
-000376d0: 6572 6564 5f72 6573 6574 5f6b 6579 733a  ered_reset_keys:
-000376e0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000376f0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00037700: 7265 7365 745f 6b65 792c 2073 7472 293a  reset_key, str):
-00037710: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00037720: 2020 2020 2020 6b65 7920 3d20 2264 6f6e        key = "don
-00037730: 6522 0d0a 2020 2020 2020 2020 2020 2020  e"..            
-00037740: 2020 2020 656c 7365 3a0d 0a20 2020 2020      else:..     
-00037750: 2020 2020 2020 2020 2020 2020 2020 206b                 k
-00037760: 6579 203d 2028 2a72 6573 6574 5f6b 6579  ey = (*reset_key
-00037770: 5b3a 2d31 5d2c 2022 646f 6e65 2229 0d0a  [:-1], "done")..
-00037780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037790: 646f 6e65 5f6b 6579 732e 6170 7065 6e64  done_keys.append
-000377a0: 286b 6579 290d 0a20 2020 2020 2020 2073  (key)..        s
-000377b0: 656c 662e 5f5f 6469 6374 5f5f 5b22 5f64  elf.__dict__["_d
-000377c0: 6f6e 655f 6b65 7973 225d 203d 2064 6f6e  one_keys"] = don
-000377d0: 655f 6b65 7973 0d0a 2020 2020 2020 2020  e_keys..        
-000377e0: 7265 7475 726e 2064 6f6e 655f 6b65 7973  return done_keys
-000377f0: 0d0a 0d0a 2020 2020 4070 726f 7065 7274  ....    @propert
-00037800: 790d 0a20 2020 2064 6566 2074 6572 6d69  y..    def termi
-00037810: 6e61 7465 645f 6b65 7973 2873 656c 6629  nated_keys(self)
-00037820: 3a0d 0a20 2020 2020 2020 2074 6572 6d69  :..        termi
-00037830: 6e61 7465 645f 6b65 7973 203d 2073 656c  nated_keys = sel
-00037840: 662e 5f5f 6469 6374 5f5f 2e67 6574 2822  f.__dict__.get("
-00037850: 5f74 6572 6d69 6e61 7465 645f 6b65 7973  _terminated_keys
-00037860: 222c 204e 6f6e 6529 0d0a 2020 2020 2020  ", None)..      
-00037870: 2020 6966 2074 6572 6d69 6e61 7465 645f    if terminated_
-00037880: 6b65 7973 2069 7320 4e6f 6e65 3a0d 0a20  keys is None:.. 
-00037890: 2020 2020 2020 2020 2020 2023 206d 616b             # mak
-000378a0: 6520 7468 6520 6465 6661 756c 7420 7465  e the default te
-000378b0: 726d 696e 6174 6564 206b 6579 730d 0a20  rminated keys.. 
-000378c0: 2020 2020 2020 2020 2020 2074 6572 6d69             termi
-000378d0: 6e61 7465 645f 6b65 7973 203d 205b 5d0d  nated_keys = [].
-000378e0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-000378f0: 2072 6573 6574 5f6b 6579 2069 6e20 7365   reset_key in se
-00037900: 6c66 2e70 6172 656e 742e 5f66 696c 7465  lf.parent._filte
-00037910: 7265 645f 7265 7365 745f 6b65 7973 3a0d  red_reset_keys:.
-00037920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00037930: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
-00037940: 6573 6574 5f6b 6579 2c20 7374 7229 3a0d  eset_key, str):.
-00037950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00037960: 2020 2020 206b 6579 203d 2022 7465 726d       key = "term
-00037970: 696e 6174 6564 220d 0a20 2020 2020 2020  inated"..       
-00037980: 2020 2020 2020 2020 2065 6c73 653a 0d0a           else:..
-00037990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000379a0: 2020 2020 6b65 7920 3d20 282a 7265 7365      key = (*rese
-000379b0: 745f 6b65 795b 3a2d 315d 2c20 2274 6572  t_key[:-1], "ter
-000379c0: 6d69 6e61 7465 6422 290d 0a20 2020 2020  minated")..     
-000379d0: 2020 2020 2020 2020 2020 2074 6572 6d69             termi
-000379e0: 6e61 7465 645f 6b65 7973 2e61 7070 656e  nated_keys.appen
-000379f0: 6428 6b65 7929 0d0a 2020 2020 2020 2020  d(key)..        
-00037a00: 7365 6c66 2e5f 5f64 6963 745f 5f5b 225f  self.__dict__["_
-00037a10: 7465 726d 696e 6174 6564 5f6b 6579 7322  terminated_keys"
-00037a20: 5d20 3d20 7465 726d 696e 6174 6564 5f6b  ] = terminated_k
-00037a30: 6579 730d 0a20 2020 2020 2020 2072 6574  eys..        ret
-00037a40: 7572 6e20 7465 726d 696e 6174 6564 5f6b  urn terminated_k
-00037a50: 6579 730d 0a0d 0a20 2020 2040 7072 6f70  eys....    @prop
-00037a60: 6572 7479 0d0a 2020 2020 6465 6620 7374  erty..    def st
-00037a70: 6570 5f63 6f75 6e74 5f6b 6579 7328 7365  ep_count_keys(se
-00037a80: 6c66 293a 0d0a 2020 2020 2020 2020 7374  lf):..        st
-00037a90: 6570 5f63 6f75 6e74 5f6b 6579 7320 3d20  ep_count_keys = 
-00037aa0: 7365 6c66 2e5f 5f64 6963 745f 5f2e 6765  self.__dict__.ge
-00037ab0: 7428 225f 7374 6570 5f63 6f75 6e74 5f6b  t("_step_count_k
-00037ac0: 6579 7322 2c20 4e6f 6e65 290d 0a20 2020  eys", None)..   
-00037ad0: 2020 2020 2069 6620 7374 6570 5f63 6f75       if step_cou
-00037ae0: 6e74 5f6b 6579 7320 6973 204e 6f6e 653a  nt_keys is None:
-00037af0: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00037b00: 6d61 6b65 2074 6865 2064 6566 6175 6c74  make the default
-00037b10: 2073 7465 705f 636f 756e 7420 6b65 7973   step_count keys
-00037b20: 0d0a 2020 2020 2020 2020 2020 2020 7374  ..            st
-00037b30: 6570 5f63 6f75 6e74 5f6b 6579 7320 3d20  ep_count_keys = 
-00037b40: 5b5d 0d0a 2020 2020 2020 2020 2020 2020  []..            
-00037b50: 666f 7220 7265 7365 745f 6b65 7920 696e  for reset_key in
-00037b60: 2073 656c 662e 7061 7265 6e74 2e5f 6669   self.parent._fi
-00037b70: 6c74 6572 6564 5f72 6573 6574 5f6b 6579  ltered_reset_key
-00037b80: 733a 0d0a 2020 2020 2020 2020 2020 2020  s:..            
-00037b90: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00037ba0: 6528 7265 7365 745f 6b65 792c 2073 7472  e(reset_key, str
-00037bb0: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
-00037bc0: 2020 2020 2020 2020 6b65 7920 3d20 7365          key = se
-00037bd0: 6c66 2e73 7465 705f 636f 756e 745f 6b65  lf.step_count_ke
-00037be0: 790d 0a20 2020 2020 2020 2020 2020 2020  y..             
-00037bf0: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
-00037c00: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
-00037c10: 7920 3d20 282a 7265 7365 745f 6b65 795b  y = (*reset_key[
-00037c20: 3a2d 315d 2c20 7365 6c66 2e73 7465 705f  :-1], self.step_
-00037c30: 636f 756e 745f 6b65 7929 0d0a 2020 2020  count_key)..    
-00037c40: 2020 2020 2020 2020 2020 2020 7374 6570              step
-00037c50: 5f63 6f75 6e74 5f6b 6579 732e 6170 7065  _count_keys.appe
-00037c60: 6e64 286b 6579 290d 0a20 2020 2020 2020  nd(key)..       
-00037c70: 2073 656c 662e 5f5f 6469 6374 5f5f 5b22   self.__dict__["
-00037c80: 5f73 7465 705f 636f 756e 745f 6b65 7973  _step_count_keys
-00037c90: 225d 203d 2073 7465 705f 636f 756e 745f  "] = step_count_
-00037ca0: 6b65 7973 0d0a 2020 2020 2020 2020 7265  keys..        re
-00037cb0: 7475 726e 2073 7465 705f 636f 756e 745f  turn step_count_
-00037cc0: 6b65 7973 0d0a 0d0a 2020 2020 4070 726f  keys....    @pro
-00037cd0: 7065 7274 790d 0a20 2020 2064 6566 2072  perty..    def r
-00037ce0: 6573 6574 5f6b 6579 7328 7365 6c66 293a  eset_keys(self):
-00037cf0: 0d0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00037d00: 662e 7061 7265 6e74 2069 7320 6e6f 7420  f.parent is not 
-00037d10: 4e6f 6e65 3a0d 0a20 2020 2020 2020 2020  None:..         
-00037d20: 2020 2072 6574 7572 6e20 7365 6c66 2e70     return self.p
-00037d30: 6172 656e 742e 5f66 696c 7465 7265 645f  arent._filtered_
-00037d40: 7265 7365 745f 6b65 7973 0d0a 2020 2020  reset_keys..    
-00037d50: 2020 2020 2320 6661 6c6c 6261 636b 206f      # fallback o
-00037d60: 6e20 6465 6661 756c 7420 225f 7265 7365  n default "_rese
-00037d70: 7422 0d0a 2020 2020 2020 2020 7265 7475  t"..        retu
-00037d80: 726e 205b 225f 7265 7365 7422 5d0d 0a0d  rn ["_reset"]...
-00037d90: 0a20 2020 2040 7072 6f70 6572 7479 0d0a  .    @property..
-00037da0: 2020 2020 6465 6620 6675 6c6c 5f64 6f6e      def full_don
-00037db0: 655f 7370 6563 2873 656c 6629 3a0d 0a20  e_spec(self):.. 
-00037dc0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00037dd0: 6c66 2e70 6172 656e 742e 6f75 7470 7574  lf.parent.output
-00037de0: 5f73 7065 635b 2266 756c 6c5f 646f 6e65  _spec["full_done
-00037df0: 5f73 7065 6322 5d20 6966 2073 656c 662e  _spec"] if self.
-00037e00: 7061 7265 6e74 2065 6c73 6520 4e6f 6e65  parent else None
-00037e10: 0d0a 0d0a 2020 2020 6465 6620 5f72 6573  ....    def _res
-00037e20: 6574 280d 0a20 2020 2020 2020 2073 656c  et(..        sel
-00037e30: 662c 2074 656e 736f 7264 6963 743a 2054  f, tensordict: T
-00037e40: 656e 736f 7244 6963 7442 6173 652c 2074  ensorDictBase, t
-00037e50: 656e 736f 7264 6963 745f 7265 7365 743a  ensordict_reset:
-00037e60: 2054 656e 736f 7244 6963 7442 6173 650d   TensorDictBase.
-00037e70: 0a20 2020 2029 202d 3e20 5465 6e73 6f72  .    ) -> Tensor
-00037e80: 4469 6374 4261 7365 3a0d 0a20 2020 2020  DictBase:..     
-00037e90: 2020 2023 2067 6574 2072 6573 6574 2073     # get reset s
-00037ea0: 6967 6e61 6c0d 0a20 2020 2020 2020 2066  ignal..        f
-00037eb0: 6f72 2073 7465 705f 636f 756e 745f 6b65  or step_count_ke
-00037ec0: 792c 2074 7275 6e63 6174 6564 5f6b 6579  y, truncated_key
-00037ed0: 2c20 7465 726d 696e 6174 6564 5f6b 6579  , terminated_key
-00037ee0: 2c20 7265 7365 745f 6b65 792c 2064 6f6e  , reset_key, don
-00037ef0: 655f 6b65 7920 696e 207a 6970 280d 0a20  e_key in zip(.. 
-00037f00: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00037f10: 7374 6570 5f63 6f75 6e74 5f6b 6579 732c  step_count_keys,
-00037f20: 0d0a 2020 2020 2020 2020 2020 2020 7365  ..            se
-00037f30: 6c66 2e74 7275 6e63 6174 6564 5f6b 6579  lf.truncated_key
-00037f40: 732c 0d0a 2020 2020 2020 2020 2020 2020  s,..            
-00037f50: 7365 6c66 2e74 6572 6d69 6e61 7465 645f  self.terminated_
-00037f60: 6b65 7973 2c0d 0a20 2020 2020 2020 2020  keys,..         
-00037f70: 2020 2073 656c 662e 7265 7365 745f 6b65     self.reset_ke
-00037f80: 7973 2c0d 0a20 2020 2020 2020 2020 2020  ys,..           
-00037f90: 2073 656c 662e 646f 6e65 5f6b 6579 732c   self.done_keys,
-00037fa0: 0d0a 2020 2020 2020 2020 293a 0d0a 2020  ..        ):..  
-00037fb0: 2020 2020 2020 2020 2020 7265 7365 7420            reset 
-00037fc0: 3d20 7465 6e73 6f72 6469 6374 2e67 6574  = tensordict.get
-00037fd0: 2872 6573 6574 5f6b 6579 2c20 6465 6661  (reset_key, defa
-00037fe0: 756c 743d 4e6f 6e65 290d 0a20 2020 2020  ult=None)..     
-00037ff0: 2020 2020 2020 2069 6620 7265 7365 7420         if reset 
-00038000: 6973 204e 6f6e 653a 0d0a 2020 2020 2020  is None:..      
-00038010: 2020 2020 2020 2020 2020 2320 6765 7420            # get 
-00038020: 646f 6e65 2073 7461 7475 732c 206a 7573  done status, jus
-00038030: 7420 746f 2069 6e66 6f72 6d20 7468 6520  t to inform the 
-00038040: 7265 7365 7420 7368 6170 652c 2064 7479  reset shape, dty
-00038050: 7065 2061 6e64 2064 6576 6963 650d 0a20  pe and device.. 
-00038060: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00038070: 6f72 2065 6e74 7279 5f6e 616d 6520 696e  or entry_name in
-00038080: 2028 7465 726d 696e 6174 6564 5f6b 6579   (terminated_key
-00038090: 2c20 7472 756e 6361 7465 645f 6b65 792c  , truncated_key,
-000380a0: 2064 6f6e 655f 6b65 7929 3a0d 0a20 2020   done_key):..   
-000380b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000380c0: 2064 6f6e 6520 3d20 7465 6e73 6f72 6469   done = tensordi
-000380d0: 6374 2e67 6574 2865 6e74 7279 5f6e 616d  ct.get(entry_nam
-000380e0: 652c 2064 6566 6175 6c74 3d4e 6f6e 6529  e, default=None)
-000380f0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00038100: 2020 2020 2020 6966 2064 6f6e 6520 6973        if done is
-00038110: 206e 6f74 204e 6f6e 653a 0d0a 2020 2020   not None:..    
-00038120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038130: 2020 2020 6272 6561 6b0d 0a20 2020 2020      break..     
-00038140: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00038150: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00038160: 2020 2020 2020 2320 4974 206d 6179 2062        # It may b
-00038170: 6520 7468 6520 6361 7365 2074 6861 7420  e the case that 
-00038180: 7265 7365 7420 6469 6420 6e6f 7420 7072  reset did not pr
-00038190: 6f76 6964 6520 6120 646f 6e65 2073 7461  ovide a done sta
-000381a0: 7465 2c20 696e 2077 6869 6368 2063 6173  te, in which cas
-000381b0: 650d 0a20 2020 2020 2020 2020 2020 2020  e..             
-000381c0: 2020 2020 2020 2023 2077 6520 6661 6c6c         # we fall
-000381d0: 2062 6163 6b20 6f6e 2074 6865 2073 7065   back on the spe
-000381e0: 630d 0a20 2020 2020 2020 2020 2020 2020  c..             
-000381f0: 2020 2020 2020 2064 6f6e 6520 3d20 7365         done = se
-00038200: 6c66 2e70 6172 656e 742e 6f75 7470 7574  lf.parent.output
-00038210: 5f73 7065 635b 2266 756c 6c5f 646f 6e65  _spec["full_done
-00038220: 5f73 7065 6322 2c20 656e 7472 795f 6e61  _spec", entry_na
-00038230: 6d65 5d2e 7a65 726f 2829 0d0a 2020 2020  me].zero()..    
-00038240: 2020 2020 2020 2020 2020 2020 7265 7365              rese
-00038250: 7420 3d20 746f 7263 682e 6f6e 6573 5f6c  t = torch.ones_l
-00038260: 696b 6528 646f 6e65 290d 0a0d 0a20 2020  ike(done)....   
-00038270: 2020 2020 2020 2020 2073 7465 705f 636f           step_co
-00038280: 756e 7420 3d20 7465 6e73 6f72 6469 6374  unt = tensordict
-00038290: 2e67 6574 2873 7465 705f 636f 756e 745f  .get(step_count_
-000382a0: 6b65 792c 2064 6566 6175 6c74 3d4e 6f6e  key, default=Non
-000382b0: 6529 0d0a 2020 2020 2020 2020 2020 2020  e)..            
-000382c0: 6966 2073 7465 705f 636f 756e 7420 6973  if step_count is
-000382d0: 204e 6f6e 653a 0d0a 2020 2020 2020 2020   None:..        
-000382e0: 2020 2020 2020 2020 7374 6570 5f63 6f75          step_cou
-000382f0: 6e74 203d 2073 656c 662e 636f 6e74 6169  nt = self.contai
-00038300: 6e65 722e 6f62 7365 7276 6174 696f 6e5f  ner.observation_
-00038310: 7370 6563 5b73 7465 705f 636f 756e 745f  spec[step_count_
-00038320: 6b65 795d 2e7a 6572 6f28 290d 0a20 2020  key].zero()..   
-00038330: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00038340: 7374 6570 5f63 6f75 6e74 2e64 6576 6963  step_count.devic
-00038350: 6520 213d 2072 6573 6574 2e64 6576 6963  e != reset.devic
-00038360: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
-00038370: 2020 2020 2020 2020 7374 6570 5f63 6f75          step_cou
-00038380: 6e74 203d 2073 7465 705f 636f 756e 742e  nt = step_count.
-00038390: 746f 2872 6573 6574 2e64 6576 6963 652c  to(reset.device,
-000383a0: 206e 6f6e 5f62 6c6f 636b 696e 673d 5472   non_blocking=Tr
-000383b0: 7565 290d 0a0d 0a20 2020 2020 2020 2020  ue)....         
-000383c0: 2020 2023 207a 6572 6f20 7468 6520 7374     # zero the st
-000383d0: 6570 2063 6f75 6e74 2069 6620 7265 7365  ep count if rese
-000383e0: 7420 6973 206e 6565 6465 640d 0a20 2020  t is needed..   
-000383f0: 2020 2020 2020 2020 2073 7465 705f 636f           step_co
-00038400: 756e 7420 3d20 746f 7263 682e 7768 6572  unt = torch.wher
-00038410: 6528 7e65 7870 616e 645f 6173 5f72 6967  e(~expand_as_rig
-00038420: 6874 2872 6573 6574 2c20 7374 6570 5f63  ht(reset, step_c
-00038430: 6f75 6e74 292c 2073 7465 705f 636f 756e  ount), step_coun
-00038440: 742c 2030 290d 0a20 2020 2020 2020 2020  t, 0)..         
-00038450: 2020 2074 656e 736f 7264 6963 745f 7265     tensordict_re
-00038460: 7365 742e 7365 7428 7374 6570 5f63 6f75  set.set(step_cou
-00038470: 6e74 5f6b 6579 2c20 7374 6570 5f63 6f75  nt_key, step_cou
-00038480: 6e74 290d 0a20 2020 2020 2020 2020 2020  nt)..           
-00038490: 2069 6620 7365 6c66 2e6d 6178 5f73 7465   if self.max_ste
-000384a0: 7073 2069 7320 6e6f 7420 4e6f 6e65 3a0d  ps is not None:.
-000384b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000384c0: 2074 7275 6e63 6174 6564 203d 2073 7465   truncated = ste
-000384d0: 705f 636f 756e 7420 3e3d 2073 656c 662e  p_count >= self.
-000384e0: 6d61 785f 7374 6570 730d 0a20 2020 2020  max_steps..     
-000384f0: 2020 2020 2020 2020 2020 2074 7275 6e63             trunc
-00038500: 6174 6564 203d 2074 7275 6e63 6174 6564  ated = truncated
-00038510: 207c 2074 656e 736f 7264 6963 745f 7265   | tensordict_re
-00038520: 7365 742e 6765 7428 7472 756e 6361 7465  set.get(truncate
-00038530: 645f 6b65 792c 2046 616c 7365 290d 0a20  d_key, False).. 
-00038540: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00038550: 6620 7365 6c66 2e75 7064 6174 655f 646f  f self.update_do
-00038560: 6e65 3a0d 0a20 2020 2020 2020 2020 2020  ne:..           
-00038570: 2020 2020 2020 2020 2023 2077 6520 6173           # we as
-00038580: 7375 6d65 206e 6f20 646f 6e65 2061 6674  sume no done aft
-00038590: 6572 2072 6573 6574 0d0a 2020 2020 2020  er reset..      
-000385a0: 2020 2020 2020 2020 2020 2020 2020 7465                te
-000385b0: 6e73 6f72 6469 6374 5f72 6573 6574 2e73  nsordict_reset.s
-000385c0: 6574 2864 6f6e 655f 6b65 792c 2074 7275  et(done_key, tru
-000385d0: 6e63 6174 6564 290d 0a20 2020 2020 2020  ncated)..       
-000385e0: 2020 2020 2020 2020 2074 656e 736f 7264           tensord
-000385f0: 6963 745f 7265 7365 742e 7365 7428 7472  ict_reset.set(tr
-00038600: 756e 6361 7465 645f 6b65 792c 2074 7275  uncated_key, tru
-00038610: 6e63 6174 6564 290d 0a20 2020 2020 2020  ncated)..       
-00038620: 2072 6574 7572 6e20 7465 6e73 6f72 6469   return tensordi
-00038630: 6374 5f72 6573 6574 0d0a 0d0a 2020 2020  ct_reset....    
-00038640: 6465 6620 5f73 7465 7028 0d0a 2020 2020  def _step(..    
-00038650: 2020 2020 7365 6c66 2c20 7465 6e73 6f72      self, tensor
-00038660: 6469 6374 3a20 5465 6e73 6f72 4469 6374  dict: TensorDict
-00038670: 4261 7365 2c20 6e65 7874 5f74 656e 736f  Base, next_tenso
-00038680: 7264 6963 743a 2054 656e 736f 7244 6963  rdict: TensorDic
-00038690: 7442 6173 650d 0a20 2020 2029 202d 3e20  tBase..    ) -> 
-000386a0: 5465 6e73 6f72 4469 6374 4261 7365 3a0d  TensorDictBase:.
-000386b0: 0a20 2020 2020 2020 2066 6f72 2073 7465  .        for ste
-000386c0: 705f 636f 756e 745f 6b65 792c 2074 7275  p_count_key, tru
-000386d0: 6e63 6174 6564 5f6b 6579 2c20 646f 6e65  ncated_key, done
-000386e0: 5f6b 6579 2069 6e20 7a69 7028 0d0a 2020  _key in zip(..  
-000386f0: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-00038700: 7465 705f 636f 756e 745f 6b65 7973 2c0d  tep_count_keys,.
-00038710: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00038720: 662e 7472 756e 6361 7465 645f 6b65 7973  f.truncated_keys
-00038730: 2c0d 0a20 2020 2020 2020 2020 2020 2073  ,..            s
-00038740: 656c 662e 646f 6e65 5f6b 6579 732c 0d0a  elf.done_keys,..
-00038750: 2020 2020 2020 2020 293a 0d0a 2020 2020          ):..    
-00038760: 2020 2020 2020 2020 7374 6570 5f63 6f75          step_cou
-00038770: 6e74 203d 2074 656e 736f 7264 6963 742e  nt = tensordict.
-00038780: 6765 7428 7374 6570 5f63 6f75 6e74 5f6b  get(step_count_k
-00038790: 6579 290d 0a20 2020 2020 2020 2020 2020  ey)..           
-000387a0: 206e 6578 745f 7374 6570 5f63 6f75 6e74   next_step_count
-000387b0: 203d 2073 7465 705f 636f 756e 7420 2b20   = step_count + 
-000387c0: 310d 0a20 2020 2020 2020 2020 2020 206e  1..            n
-000387d0: 6578 745f 7465 6e73 6f72 6469 6374 2e73  ext_tensordict.s
-000387e0: 6574 2873 7465 705f 636f 756e 745f 6b65  et(step_count_ke
-000387f0: 792c 206e 6578 745f 7374 6570 5f63 6f75  y, next_step_cou
-00038800: 6e74 290d 0a0d 0a20 2020 2020 2020 2020  nt)....         
-00038810: 2020 2069 6620 7365 6c66 2e6d 6178 5f73     if self.max_s
-00038820: 7465 7073 2069 7320 6e6f 7420 4e6f 6e65  teps is not None
-00038830: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-00038840: 2020 2074 7275 6e63 6174 6564 203d 206e     truncated = n
-00038850: 6578 745f 7374 6570 5f63 6f75 6e74 203e  ext_step_count >
-00038860: 3d20 7365 6c66 2e6d 6178 5f73 7465 7073  = self.max_steps
-00038870: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00038880: 2020 7472 756e 6361 7465 6420 3d20 7472    truncated = tr
-00038890: 756e 6361 7465 6420 7c20 6e65 7874 5f74  uncated | next_t
-000388a0: 656e 736f 7264 6963 742e 6765 7428 7472  ensordict.get(tr
-000388b0: 756e 6361 7465 645f 6b65 792c 2046 616c  uncated_key, Fal
-000388c0: 7365 290d 0a20 2020 2020 2020 2020 2020  se)..           
-000388d0: 2020 2020 2069 6620 7365 6c66 2e75 7064       if self.upd
-000388e0: 6174 655f 646f 6e65 3a0d 0a20 2020 2020  ate_done:..     
-000388f0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00038900: 6f6e 6520 3d20 6e65 7874 5f74 656e 736f  one = next_tenso
-00038910: 7264 6963 742e 6765 7428 646f 6e65 5f6b  rdict.get(done_k
-00038920: 6579 2c20 4e6f 6e65 290d 0a0d 0a20 2020  ey, None)....   
-00038930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038940: 2023 2077 6520 6361 6e20 6861 7665 2074   # we can have t
-00038950: 6572 6d69 6e61 7465 6420 616e 6420 7472  erminated and tr
-00038960: 756e 6361 7465 640d 0a20 2020 2020 2020  uncated..       
-00038970: 2020 2020 2020 2020 2020 2020 2023 2074               # t
-00038980: 6572 6d69 6e61 7465 6420 3d20 6e65 7874  erminated = next
-00038990: 5f74 656e 736f 7264 6963 742e 6765 7428  _tensordict.get(
-000389a0: 7465 726d 696e 6174 6564 5f6b 6579 2c20  terminated_key, 
-000389b0: 4e6f 6e65 290d 0a20 2020 2020 2020 2020  None)..         
-000389c0: 2020 2020 2020 2020 2020 2023 2069 6620             # if 
-000389d0: 7465 726d 696e 6174 6564 2069 7320 6e6f  terminated is no
-000389e0: 7420 4e6f 6e65 3a0d 0a20 2020 2020 2020  t None:..       
-000389f0: 2020 2020 2020 2020 2020 2020 2023 2020               #  
-00038a00: 2020 2074 7275 6e63 6174 6564 203d 2074     truncated = t
-00038a10: 7275 6e63 6174 6564 2026 207e 7465 726d  runcated & ~term
-00038a20: 696e 6174 6564 0d0a 0d0a 2020 2020 2020  inated....      
-00038a30: 2020 2020 2020 2020 2020 2020 2020 646f                do
-00038a40: 6e65 203d 2074 7275 6e63 6174 6564 207c  ne = truncated |
-00038a50: 2064 6f6e 6520 2023 2077 6520 6173 7375   done  # we assu
-00038a60: 6d65 206e 6f20 646f 6e65 2061 6674 6572  me no done after
-00038a70: 2072 6573 6574 0d0a 2020 2020 2020 2020   reset..        
-00038a80: 2020 2020 2020 2020 2020 2020 6e65 7874              next
-00038a90: 5f74 656e 736f 7264 6963 742e 7365 7428  _tensordict.set(
-00038aa0: 646f 6e65 5f6b 6579 2c20 646f 6e65 290d  done_key, done).
-00038ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00038ac0: 206e 6578 745f 7465 6e73 6f72 6469 6374   next_tensordict
-00038ad0: 2e73 6574 2874 7275 6e63 6174 6564 5f6b  .set(truncated_k
-00038ae0: 6579 2c20 7472 756e 6361 7465 6429 0d0a  ey, truncated)..
-00038af0: 2020 2020 2020 2020 7265 7475 726e 206e          return n
-00038b00: 6578 745f 7465 6e73 6f72 6469 6374 0d0a  ext_tensordict..
-00038b10: 0d0a 2020 2020 6465 6620 7472 616e 7366  ..    def transf
-00038b20: 6f72 6d5f 6f62 7365 7276 6174 696f 6e5f  orm_observation_
-00038b30: 7370 6563 280d 0a20 2020 2020 2020 2073  spec(..        s
-00038b40: 656c 662c 206f 6273 6572 7661 7469 6f6e  elf, observation
-00038b50: 5f73 7065 633a 2043 6f6d 706f 7369 7465  _spec: Composite
-00038b60: 5370 6563 0d0a 2020 2020 2920 2d3e 2043  Spec..    ) -> C
-00038b70: 6f6d 706f 7369 7465 5370 6563 3a0d 0a20  ompositeSpec:.. 
-00038b80: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
-00038b90: 696e 7374 616e 6365 286f 6273 6572 7661  instance(observa
-00038ba0: 7469 6f6e 5f73 7065 632c 2043 6f6d 706f  tion_spec, Compo
-00038bb0: 7369 7465 5370 6563 293a 0d0a 2020 2020  siteSpec):..    
-00038bc0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-00038bd0: 6c75 6545 7272 6f72 280d 0a20 2020 2020  lueError(..     
-00038be0: 2020 2020 2020 2020 2020 2066 226f 6273             f"obs
-00038bf0: 6572 7661 7469 6f6e 5f73 7065 6320 7761  ervation_spec wa
-00038c00: 7320 6578 7065 6374 6564 2074 6f20 6265  s expected to be
-00038c10: 206f 6620 7479 7065 2043 6f6d 706f 7369   of type Composi
-00038c20: 7465 5370 6563 2e20 476f 7420 7b74 7970  teSpec. Got {typ
-00038c30: 6528 6f62 7365 7276 6174 696f 6e5f 7370  e(observation_sp
-00038c40: 6563 297d 2069 6e73 7465 6164 2e22 0d0a  ec)} instead."..
-00038c50: 2020 2020 2020 2020 2020 2020 290d 0a20              ).. 
-00038c60: 2020 2020 2020 2066 756c 6c5f 646f 6e65         full_done
-00038c70: 5f73 7065 6320 3d20 7365 6c66 2e70 6172  _spec = self.par
-00038c80: 656e 742e 6f75 7470 7574 5f73 7065 635b  ent.output_spec[
-00038c90: 2266 756c 6c5f 646f 6e65 5f73 7065 6322  "full_done_spec"
-00038ca0: 5d0d 0a20 2020 2020 2020 2066 6f72 2073  ]..        for s
-00038cb0: 7465 705f 636f 756e 745f 6b65 7920 696e  tep_count_key in
-00038cc0: 2073 656c 662e 7374 6570 5f63 6f75 6e74   self.step_count
-00038cd0: 5f6b 6579 733a 0d0a 2020 2020 2020 2020  _keys:..        
-00038ce0: 2020 2020 7374 6570 5f63 6f75 6e74 5f6b      step_count_k
-00038cf0: 6579 203d 2075 6e72 6176 656c 5f6b 6579  ey = unravel_key
-00038d00: 2873 7465 705f 636f 756e 745f 6b65 7929  (step_count_key)
-00038d10: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00038d20: 6669 6e64 2061 206d 6174 6368 696e 6720  find a matching 
-00038d30: 646f 6e65 206b 6579 2028 7468 6572 6520  done key (there 
-00038d40: 6d69 6768 7420 6265 206d 6f72 6520 7468  might be more th
-00038d50: 616e 206f 6e65 290d 0a20 2020 2020 2020  an one)..       
-00038d60: 2020 2020 2066 6f72 2064 6f6e 655f 6b65       for done_ke
-00038d70: 7920 696e 2073 656c 662e 646f 6e65 5f6b  y in self.done_k
-00038d80: 6579 733a 0d0a 2020 2020 2020 2020 2020  eys:..          
-00038d90: 2020 2020 2020 2320 6368 6563 6b20 726f        # check ro
-00038da0: 6f74 0d0a 2020 2020 2020 2020 2020 2020  ot..            
-00038db0: 2020 2020 6966 2074 7970 6528 646f 6e65      if type(done
-00038dc0: 5f6b 6579 2920 213d 2074 7970 6528 7374  _key) != type(st
-00038dd0: 6570 5f63 6f75 6e74 5f6b 6579 293a 0d0a  ep_count_key):..
-00038de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038df0: 2020 2020 636f 6e74 696e 7565 0d0a 2020      continue..  
-00038e00: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00038e10: 2069 7369 6e73 7461 6e63 6528 646f 6e65   isinstance(done
-00038e20: 5f6b 6579 2c20 7475 706c 6529 3a0d 0a20  _key, tuple):.. 
-00038e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038e40: 2020 2069 6620 646f 6e65 5f6b 6579 5b3a     if done_key[:
-00038e50: 2d31 5d20 3d3d 2073 7465 705f 636f 756e  -1] == step_coun
-00038e60: 745f 6b65 795b 3a2d 315d 3a0d 0a20 2020  t_key[:-1]:..   
-00038e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038e80: 2020 2020 2073 6861 7065 203d 2066 756c       shape = ful
-00038e90: 6c5f 646f 6e65 5f73 7065 635b 646f 6e65  l_done_spec[done
-00038ea0: 5f6b 6579 5d2e 7368 6170 650d 0a20 2020  _key].shape..   
-00038eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038ec0: 2020 2020 2062 7265 616b 0d0a 2020 2020       break..    
-00038ed0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-00038ee0: 7369 6e73 7461 6e63 6528 646f 6e65 5f6b  sinstance(done_k
-00038ef0: 6579 2c20 7374 7229 3a0d 0a20 2020 2020  ey, str):..     
-00038f00: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00038f10: 6861 7065 203d 2066 756c 6c5f 646f 6e65  hape = full_done
-00038f20: 5f73 7065 635b 646f 6e65 5f6b 6579 5d2e  _spec[done_key].
-00038f30: 7368 6170 650d 0a20 2020 2020 2020 2020  shape..         
-00038f40: 2020 2020 2020 2020 2020 2062 7265 616b             break
-00038f50: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
-00038f60: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
-00038f70: 2020 2020 2020 2072 6169 7365 204b 6579         raise Key
-00038f80: 4572 726f 7228 0d0a 2020 2020 2020 2020  Error(..        
-00038f90: 2020 2020 2020 2020 2020 2020 6622 436f              f"Co
-00038fa0: 756c 6420 6e6f 7420 6669 6e64 2072 6f6f  uld not find roo
-00038fb0: 7420 6f66 2073 7465 705f 636f 756e 745f  t of step_count_
-00038fc0: 6b65 7920 7b73 7465 705f 636f 756e 745f  key {step_count_
-00038fd0: 6b65 797d 2069 6e20 646f 6e65 206b 6579  key} in done key
-00038fe0: 7320 7b73 656c 662e 646f 6e65 5f6b 6579  s {self.done_key
-00038ff0: 737d 2e22 0d0a 2020 2020 2020 2020 2020  s}."..          
-00039000: 2020 2020 2020 290d 0a20 2020 2020 2020        )..       
-00039010: 2020 2020 206f 6273 6572 7661 7469 6f6e       observation
-00039020: 5f73 7065 635b 7374 6570 5f63 6f75 6e74  _spec[step_count
-00039030: 5f6b 6579 5d20 3d20 426f 756e 6465 6454  _key] = BoundedT
-00039040: 656e 736f 7253 7065 6328 0d0a 2020 2020  ensorSpec(..    
-00039050: 2020 2020 2020 2020 2020 2020 7368 6170              shap
-00039060: 653d 7368 6170 652c 0d0a 2020 2020 2020  e=shape,..      
-00039070: 2020 2020 2020 2020 2020 6474 7970 653d            dtype=
-00039080: 746f 7263 682e 696e 7436 342c 0d0a 2020  torch.int64,..  
-00039090: 2020 2020 2020 2020 2020 2020 2020 6465                de
-000390a0: 7669 6365 3d6f 6273 6572 7661 7469 6f6e  vice=observation
-000390b0: 5f73 7065 632e 6465 7669 6365 2c0d 0a20  _spec.device,.. 
-000390c0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-000390d0: 6f77 3d30 2c0d 0a20 2020 2020 2020 2020  ow=0,..         
-000390e0: 2020 2020 2020 2068 6967 683d 746f 7263         high=torc
-000390f0: 682e 6969 6e66 6f28 746f 7263 682e 696e  h.iinfo(torch.in
-00039100: 7436 3429 2e6d 6178 2c0d 0a20 2020 2020  t64).max,..     
-00039110: 2020 2020 2020 2029 0d0a 2020 2020 2020         )..      
-00039120: 2020 7265 7475 726e 2073 7570 6572 2829    return super()
-00039130: 2e74 7261 6e73 666f 726d 5f6f 6273 6572  .transform_obser
-00039140: 7661 7469 6f6e 5f73 7065 6328 6f62 7365  vation_spec(obse
-00039150: 7276 6174 696f 6e5f 7370 6563 290d 0a0d  rvation_spec)...
-00039160: 0a20 2020 2064 6566 2074 7261 6e73 666f  .    def transfo
-00039170: 726d 5f6f 7574 7075 745f 7370 6563 2873  rm_output_spec(s
-00039180: 656c 662c 206f 7574 7075 745f 7370 6563  elf, output_spec
-00039190: 3a20 436f 6d70 6f73 6974 6553 7065 6329  : CompositeSpec)
-000391a0: 202d 3e20 436f 6d70 6f73 6974 6553 7065   -> CompositeSpe
-000391b0: 633a 0d0a 2020 2020 2020 2020 6966 2073  c:..        if s
-000391c0: 656c 662e 6d61 785f 7374 6570 733a 0d0a  elf.max_steps:..
-000391d0: 2020 2020 2020 2020 2020 2020 6675 6c6c              full
-000391e0: 5f64 6f6e 655f 7370 6563 203d 2073 656c  _done_spec = sel
-000391f0: 662e 7061 7265 6e74 2e6f 7574 7075 745f  f.parent.output_
-00039200: 7370 6563 5b22 6675 6c6c 5f64 6f6e 655f  spec["full_done_
-00039210: 7370 6563 225d 0d0a 2020 2020 2020 2020  spec"]..        
-00039220: 2020 2020 666f 7220 7472 756e 6361 7465      for truncate
-00039230: 645f 6b65 7920 696e 2073 656c 662e 7472  d_key in self.tr
-00039240: 756e 6361 7465 645f 6b65 7973 3a0d 0a20  uncated_keys:.. 
-00039250: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00039260: 7275 6e63 6174 6564 5f6b 6579 203d 2075  runcated_key = u
-00039270: 6e72 6176 656c 5f6b 6579 2874 7275 6e63  nravel_key(trunc
-00039280: 6174 6564 5f6b 6579 290d 0a20 2020 2020  ated_key)..     
-00039290: 2020 2020 2020 2020 2020 2023 2066 696e             # fin
-000392a0: 6420 6120 6d61 7463 6869 6e67 2064 6f6e  d a matching don
-000392b0: 6520 6b65 7920 2874 6865 7265 206d 6967  e key (there mig
-000392c0: 6874 2062 6520 6d6f 7265 2074 6861 6e20  ht be more than 
-000392d0: 6f6e 6529 0d0a 2020 2020 2020 2020 2020  one)..          
-000392e0: 2020 2020 2020 666f 7220 646f 6e65 5f6b        for done_k
-000392f0: 6579 2069 6e20 7365 6c66 2e64 6f6e 655f  ey in self.done_
-00039300: 6b65 7973 3a0d 0a20 2020 2020 2020 2020  keys:..         
-00039310: 2020 2020 2020 2020 2020 2023 2063 6865             # che
-00039320: 636b 2072 6f6f 740d 0a20 2020 2020 2020  ck root..       
-00039330: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00039340: 7479 7065 2864 6f6e 655f 6b65 7929 2021  type(done_key) !
-00039350: 3d20 7479 7065 2874 7275 6e63 6174 6564  = type(truncated
-00039360: 5f6b 6579 293a 0d0a 2020 2020 2020 2020  _key):..        
-00039370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039380: 636f 6e74 696e 7565 0d0a 2020 2020 2020  continue..      
-00039390: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000393a0: 2069 7369 6e73 7461 6e63 6528 646f 6e65   isinstance(done
-000393b0: 5f6b 6579 2c20 7475 706c 6529 3a0d 0a20  _key, tuple):.. 
-000393c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000393d0: 2020 2020 2020 2069 6620 646f 6e65 5f6b         if done_k
-000393e0: 6579 5b3a 2d31 5d20 3d3d 2074 7275 6e63  ey[:-1] == trunc
-000393f0: 6174 6564 5f6b 6579 5b3a 2d31 5d3a 0d0a  ated_key[:-1]:..
-00039400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039410: 2020 2020 2020 2020 2020 2020 7368 6170              shap
-00039420: 6520 3d20 6675 6c6c 5f64 6f6e 655f 7370  e = full_done_sp
-00039430: 6563 5b64 6f6e 655f 6b65 795d 2e73 6861  ec[done_key].sha
-00039440: 7065 0d0a 2020 2020 2020 2020 2020 2020  pe..            
-00039450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039460: 6272 6561 6b0d 0a20 2020 2020 2020 2020  break..         
-00039470: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-00039480: 696e 7374 616e 6365 2864 6f6e 655f 6b65  instance(done_ke
-00039490: 792c 2073 7472 293a 0d0a 2020 2020 2020  y, str):..      
-000394a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000394b0: 2020 7368 6170 6520 3d20 6675 6c6c 5f64    shape = full_d
-000394c0: 6f6e 655f 7370 6563 5b64 6f6e 655f 6b65  one_spec[done_ke
-000394d0: 795d 2e73 6861 7065 0d0a 2020 2020 2020  y].shape..      
-000394e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000394f0: 2020 6272 6561 6b0d 0a0d 0a20 2020 2020    break....     
-00039500: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00039510: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00039520: 2020 2020 2020 7261 6973 6520 4b65 7945        raise KeyE
-00039530: 7272 6f72 280d 0a20 2020 2020 2020 2020  rror(..         
-00039540: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00039550: 2243 6f75 6c64 206e 6f74 2066 696e 6420  "Could not find 
-00039560: 726f 6f74 206f 6620 7472 756e 6361 7465  root of truncate
-00039570: 645f 6b65 7920 7b74 7275 6e63 6174 6564  d_key {truncated
-00039580: 5f6b 6579 7d20 696e 2064 6f6e 6520 6b65  _key} in done ke
-00039590: 7973 207b 7365 6c66 2e64 6f6e 655f 6b65  ys {self.done_ke
-000395a0: 7973 7d2e 220d 0a20 2020 2020 2020 2020  ys}."..         
-000395b0: 2020 2020 2020 2020 2020 2029 0d0a 2020             )..  
-000395c0: 2020 2020 2020 2020 2020 2020 2020 6675                fu
-000395d0: 6c6c 5f64 6f6e 655f 7370 6563 5b74 7275  ll_done_spec[tru
-000395e0: 6e63 6174 6564 5f6b 6579 5d20 3d20 4469  ncated_key] = Di
-000395f0: 7363 7265 7465 5465 6e73 6f72 5370 6563  screteTensorSpec
-00039600: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
-00039610: 2020 2020 2020 2032 2c20 6474 7970 653d         2, dtype=
-00039620: 746f 7263 682e 626f 6f6c 2c20 6465 7669  torch.bool, devi
-00039630: 6365 3d6f 7574 7075 745f 7370 6563 2e64  ce=output_spec.d
-00039640: 6576 6963 652c 2073 6861 7065 3d73 6861  evice, shape=sha
-00039650: 7065 0d0a 2020 2020 2020 2020 2020 2020  pe..            
-00039660: 2020 2020 290d 0a20 2020 2020 2020 2020      )..         
-00039670: 2020 2069 6620 7365 6c66 2e75 7064 6174     if self.updat
-00039680: 655f 646f 6e65 3a0d 0a20 2020 2020 2020  e_done:..       
-00039690: 2020 2020 2020 2020 2066 6f72 2064 6f6e           for don
-000396a0: 655f 6b65 7920 696e 2073 656c 662e 646f  e_key in self.do
-000396b0: 6e65 5f6b 6579 733a 0d0a 2020 2020 2020  ne_keys:..      
-000396c0: 2020 2020 2020 2020 2020 2020 2020 646f                do
-000396d0: 6e65 5f6b 6579 203d 2075 6e72 6176 656c  ne_key = unravel
-000396e0: 5f6b 6579 2864 6f6e 655f 6b65 7929 0d0a  _key(done_key)..
-000396f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039700: 2020 2020 2320 6669 6e64 2061 206d 6174      # find a mat
-00039710: 6368 696e 6720 646f 6e65 206b 6579 2028  ching done key (
-00039720: 7468 6572 6520 6d69 6768 7420 6265 206d  there might be m
-00039730: 6f72 6520 7468 616e 206f 6e65 290d 0a20  ore than one).. 
-00039740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039750: 2020 2066 6f72 2064 6f6e 655f 6b65 7920     for done_key 
-00039760: 696e 2073 656c 662e 646f 6e65 5f6b 6579  in self.done_key
-00039770: 733a 0d0a 2020 2020 2020 2020 2020 2020  s:..            
-00039780: 2020 2020 2020 2020 2020 2020 2320 6368              # ch
-00039790: 6563 6b20 726f 6f74 0d0a 2020 2020 2020  eck root..      
-000397a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000397b0: 2020 6966 2074 7970 6528 646f 6e65 5f6b    if type(done_k
-000397c0: 6579 2920 213d 2074 7970 6528 646f 6e65  ey) != type(done
-000397d0: 5f6b 6579 293a 0d0a 2020 2020 2020 2020  _key):..        
-000397e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000397f0: 2020 2020 636f 6e74 696e 7565 0d0a 2020      continue..  
-00039800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039810: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00039820: 6e63 6528 646f 6e65 5f6b 6579 2c20 7475  nce(done_key, tu
-00039830: 706c 6529 3a0d 0a20 2020 2020 2020 2020  ple):..         
-00039840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039850: 2020 2069 6620 646f 6e65 5f6b 6579 5b3a     if done_key[:
-00039860: 2d31 5d20 3d3d 2064 6f6e 655f 6b65 795b  -1] == done_key[
-00039870: 3a2d 315d 3a0d 0a20 2020 2020 2020 2020  :-1]:..         
-00039880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039890: 2020 2020 2020 2073 6861 7065 203d 2066         shape = f
-000398a0: 756c 6c5f 646f 6e65 5f73 7065 635b 646f  ull_done_spec[do
-000398b0: 6e65 5f6b 6579 5d2e 7368 6170 650d 0a20  ne_key].shape.. 
-000398c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000398d0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-000398e0: 7265 616b 0d0a 2020 2020 2020 2020 2020  reak..          
-000398f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00039900: 2069 7369 6e73 7461 6e63 6528 646f 6e65   isinstance(done
-00039910: 5f6b 6579 2c20 7374 7229 3a0d 0a20 2020  _key, str):..   
-00039920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039930: 2020 2020 2020 2020 2073 6861 7065 203d           shape =
-00039940: 2066 756c 6c5f 646f 6e65 5f73 7065 635b   full_done_spec[
-00039950: 646f 6e65 5f6b 6579 5d2e 7368 6170 650d  done_key].shape.
-00039960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039970: 2020 2020 2020 2020 2020 2020 2062 7265               bre
-00039980: 616b 0d0a 0d0a 2020 2020 2020 2020 2020  ak....          
-00039990: 2020 2020 2020 2020 2020 656c 7365 3a0d            else:.
-000399a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000399b0: 2020 2020 2020 2020 2072 6169 7365 204b           raise K
-000399c0: 6579 4572 726f 7228 0d0a 2020 2020 2020  eyError(..      
-000399d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000399e0: 2020 2020 2020 6622 436f 756c 6420 6e6f        f"Could no
-000399f0: 7420 6669 6e64 2072 6f6f 7420 6f66 2073  t find root of s
-00039a00: 746f 705f 6b65 7920 7b64 6f6e 655f 6b65  top_key {done_ke
-00039a10: 797d 2069 6e20 646f 6e65 206b 6579 7320  y} in done keys 
-00039a20: 7b73 656c 662e 646f 6e65 5f6b 6579 737d  {self.done_keys}
-00039a30: 2e22 0d0a 2020 2020 2020 2020 2020 2020  ."..            
-00039a40: 2020 2020 2020 2020 2020 2020 290d 0a20              ).. 
+0002f250: 6966 2028 6e6f 7420 7365 6c66 2e70 6172  if (not self.par
+0002f260: 656e 7420 6f72 2073 656c 662e 7061 7265  ent or self.pare
+0002f270: 6e74 2e62 6174 6368 5f6c 6f63 6b65 6429  nt.batch_locked)
+0002f280: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0002f290: 2020 2020 2020 2020 2020 656c 7365 2074            else t
+0002f2a0: 656e 736f 7264 6963 742e 6261 7463 685f  ensordict.batch_
+0002f2b0: 7369 7a65 0d0a 2020 2020 2020 2020 2020  size..          
+0002f2c0: 2020 2020 2020 2020 2020 290d 0a20 2020            )..   
+0002f2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f2e0: 2076 616c 7565 203d 2073 7065 632e 7261   value = spec.ra
+0002f2f0: 6e64 2873 6861 7065 290d 0a20 2020 2020  nd(shape)..     
+0002f300: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0002f310: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0002f320: 2020 2020 2020 7661 6c75 6520 3d20 7365        value = se
+0002f330: 6c66 2e64 6566 6175 6c74 5f76 616c 7565  lf.default_value
+0002f340: 5b6b 6579 5d0d 0a20 2020 2020 2020 2020  [key]..         
+0002f350: 2020 2020 2020 2020 2020 2069 6620 6361             if ca
+0002f360: 6c6c 6162 6c65 2876 616c 7565 293a 0d0a  llable(value):..
+0002f370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f380: 2020 2020 2020 2020 7661 6c75 6520 3d20          value = 
+0002f390: 7661 6c75 6528 290d 0a20 2020 2020 2020  value()..       
+0002f3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f3b0: 2069 6620 6e6f 7420 7365 6c66 2e5f 7661   if not self._va
+0002f3c0: 6c69 6461 7465 643a 0d0a 2020 2020 2020  lidated:..      
+0002f3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f3e0: 2020 2020 2020 7365 6c66 2e5f 7661 6c69        self._vali
+0002f3f0: 6461 7465 5f76 616c 7565 5f74 656e 736f  date_value_tenso
+0002f400: 7228 7661 6c75 652c 2073 7065 6329 0d0a  r(value, spec)..
+0002f410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f420: 2020 2020 656c 7365 3a0d 0a20 2020 2020      else:..     
+0002f430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f440: 2020 2076 616c 7565 203d 2074 6f72 6368     value = torch
+0002f450: 2e66 756c 6c28 0d0a 2020 2020 2020 2020  .full(..        
+0002f460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f470: 2020 2020 7370 6563 2e73 6861 7065 2c0d      spec.shape,.
+0002f480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f490: 2020 2020 2020 2020 2020 2020 2076 616c               val
+0002f4a0: 7565 2c0d 0a20 2020 2020 2020 2020 2020  ue,..           
+0002f4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f4c0: 2064 6576 6963 653d 7370 6563 2e64 6576   device=spec.dev
+0002f4d0: 6963 652c 0d0a 2020 2020 2020 2020 2020  ice,..          
+0002f4e0: 2020 2020 2020 2020 2020 2020 2020 290d                ).
+0002f4f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f500: 2020 2020 2020 2020 2070 7265 765f 7661           prev_va
+0002f510: 6c20 3d20 7465 6e73 6f72 6469 6374 2e67  l = tensordict.g
+0002f520: 6574 286b 6579 2c20 302e 3029 0d0a 2020  et(key, 0.0)..  
+0002f530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f540: 2020 2020 2020 7661 6c75 6520 3d20 746f        value = to
+0002f550: 7263 682e 7768 6572 6528 0d0a 2020 2020  rch.where(..    
+0002f560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f570: 2020 2020 2020 2020 6578 7061 6e64 5f61          expand_a
+0002f580: 735f 7269 6768 7428 5f72 6573 6574 2c20  s_right(_reset, 
+0002f590: 7661 6c75 6529 2c20 7661 6c75 652c 2070  value), value, p
+0002f5a0: 7265 765f 7661 6c0d 0a20 2020 2020 2020  rev_val..       
+0002f5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f5c0: 2029 0d0a 2020 2020 2020 2020 2020 2020   )..            
+0002f5d0: 2020 2020 7465 6e73 6f72 6469 6374 5f72      tensordict_r
+0002f5e0: 6573 6574 2e73 6574 286b 6579 2c20 7661  eset.set(key, va
+0002f5f0: 6c75 6529 0d0a 2020 2020 2020 2020 2020  lue)..          
+0002f600: 2020 7365 6c66 2e5f 7661 6c69 6461 7465    self._validate
+0002f610: 6420 3d20 5472 7565 0d0a 2020 2020 2020  d = True..      
+0002f620: 2020 7265 7475 726e 2074 656e 736f 7264    return tensord
+0002f630: 6963 745f 7265 7365 740d 0a0d 0a20 2020  ict_reset....   
+0002f640: 2064 6566 205f 5f72 6570 725f 5f28 7365   def __repr__(se
+0002f650: 6c66 2920 2d3e 2073 7472 3a0d 0a20 2020  lf) -> str:..   
+0002f660: 2020 2020 2063 6c61 7373 5f6e 616d 6520       class_name 
+0002f670: 3d20 7365 6c66 2e5f 5f63 6c61 7373 5f5f  = self.__class__
+0002f680: 2e5f 5f6e 616d 655f 5f0d 0a20 2020 2020  .__name__..     
+0002f690: 2020 2064 6566 6175 6c74 5f76 616c 7565     default_value
+0002f6a0: 203d 207b 0d0a 2020 2020 2020 2020 2020   = {..          
+0002f6b0: 2020 6b65 793a 2076 616c 7565 2069 6620    key: value if 
+0002f6c0: 6973 696e 7374 616e 6365 2876 616c 7565  isinstance(value
+0002f6d0: 2c20 666c 6f61 7429 2065 6c73 6520 2243  , float) else "C
+0002f6e0: 616c 6c61 626c 6522 0d0a 2020 2020 2020  allable"..      
+0002f6f0: 2020 2020 2020 666f 7220 6b65 792c 2076        for key, v
+0002f700: 616c 7565 2069 6e20 7365 6c66 2e64 6566  alue in self.def
+0002f710: 6175 6c74 5f76 616c 7565 2e69 7465 6d73  ault_value.items
+0002f720: 2829 0d0a 2020 2020 2020 2020 7d0d 0a20  ()..        }.. 
+0002f730: 2020 2020 2020 2072 6574 7572 6e20 6622         return f"
+0002f740: 7b63 6c61 7373 5f6e 616d 657d 2870 7269  {class_name}(pri
+0002f750: 6d65 7273 3d7b 7365 6c66 2e70 7269 6d65  mers={self.prime
+0002f760: 7273 7d2c 2064 6566 6175 6c74 5f76 616c  rs}, default_val
+0002f770: 7565 3d7b 6465 6661 756c 745f 7661 6c75  ue={default_valu
+0002f780: 657d 2c20 7261 6e64 6f6d 3d7b 7365 6c66  e}, random={self
+0002f790: 2e72 616e 646f 6d7d 2922 0d0a 0d0a 0d0a  .random})"......
+0002f7a0: 636c 6173 7320 5069 6e4d 656d 6f72 7954  class PinMemoryT
+0002f7b0: 7261 6e73 666f 726d 2854 7261 6e73 666f  ransform(Transfo
+0002f7c0: 726d 293a 0d0a 2020 2020 2222 2243 616c  rm):..    """Cal
+0002f7d0: 6c73 2070 696e 5f6d 656d 6f72 7920 6f6e  ls pin_memory on
+0002f7e0: 2074 6865 2074 656e 736f 7264 6963 7420   the tensordict 
+0002f7f0: 746f 2066 6163 696c 6974 6174 6520 7772  to facilitate wr
+0002f800: 6974 696e 6720 6f6e 2043 5544 4120 6465  iting on CUDA de
+0002f810: 7669 6365 732e 2222 220d 0a0d 0a20 2020  vices."""....   
+0002f820: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+0002f830: 6c66 293a 0d0a 2020 2020 2020 2020 7375  lf):..        su
+0002f840: 7065 7228 292e 5f5f 696e 6974 5f5f 2829  per().__init__()
+0002f850: 0d0a 0d0a 2020 2020 6465 6620 5f63 616c  ....    def _cal
+0002f860: 6c28 7365 6c66 2c20 7465 6e73 6f72 6469  l(self, tensordi
+0002f870: 6374 3a20 5465 6e73 6f72 4469 6374 4261  ct: TensorDictBa
+0002f880: 7365 2920 2d3e 2054 656e 736f 7244 6963  se) -> TensorDic
+0002f890: 7442 6173 653a 0d0a 2020 2020 2020 2020  tBase:..        
+0002f8a0: 7265 7475 726e 2074 656e 736f 7264 6963  return tensordic
+0002f8b0: 742e 7069 6e5f 6d65 6d6f 7279 2829 0d0a  t.pin_memory()..
+0002f8c0: 0d0a 2020 2020 666f 7277 6172 6420 3d20  ..    forward = 
+0002f8d0: 5f63 616c 6c0d 0a0d 0a20 2020 2064 6566  _call....    def
+0002f8e0: 205f 7265 7365 7428 0d0a 2020 2020 2020   _reset(..      
+0002f8f0: 2020 7365 6c66 2c20 7465 6e73 6f72 6469    self, tensordi
+0002f900: 6374 3a20 5465 6e73 6f72 4469 6374 4261  ct: TensorDictBa
+0002f910: 7365 2c20 7465 6e73 6f72 6469 6374 5f72  se, tensordict_r
+0002f920: 6573 6574 3a20 5465 6e73 6f72 4469 6374  eset: TensorDict
+0002f930: 4261 7365 0d0a 2020 2020 2920 2d3e 2054  Base..    ) -> T
+0002f940: 656e 736f 7244 6963 7442 6173 653a 0d0a  ensorDictBase:..
+0002f950: 2020 2020 2020 2020 7769 7468 205f 7365          with _se
+0002f960: 745f 6d69 7373 696e 675f 746f 6c65 7261  t_missing_tolera
+0002f970: 6e63 6528 7365 6c66 2c20 5472 7565 293a  nce(self, True):
+0002f980: 0d0a 2020 2020 2020 2020 2020 2020 7465  ..            te
+0002f990: 6e73 6f72 6469 6374 5f72 6573 6574 203d  nsordict_reset =
+0002f9a0: 2073 656c 662e 5f63 616c 6c28 7465 6e73   self._call(tens
+0002f9b0: 6f72 6469 6374 5f72 6573 6574 290d 0a20  ordict_reset).. 
+0002f9c0: 2020 2020 2020 2072 6574 7572 6e20 7465         return te
+0002f9d0: 6e73 6f72 6469 6374 5f72 6573 6574 0d0a  nsordict_reset..
+0002f9e0: 0d0a 0d0a 6465 6620 5f73 756d 5f6c 6566  ....def _sum_lef
+0002f9f0: 7428 7661 6c2c 2064 6573 7429 3a0d 0a20  t(val, dest):.. 
+0002fa00: 2020 2077 6869 6c65 2076 616c 2e6e 6469     while val.ndi
+0002fa10: 6d65 6e73 696f 6e28 2920 3e20 6465 7374  mension() > dest
+0002fa20: 2e6e 6469 6d65 6e73 696f 6e28 293a 0d0a  .ndimension():..
+0002fa30: 2020 2020 2020 2020 7661 6c20 3d20 7661          val = va
+0002fa40: 6c2e 7375 6d28 3029 0d0a 2020 2020 7265  l.sum(0)..    re
+0002fa50: 7475 726e 2076 616c 0d0a 0d0a 0d0a 636c  turn val......cl
+0002fa60: 6173 7320 6753 4445 4e6f 6973 6528 5465  ass gSDENoise(Te
+0002fa70: 6e73 6f72 4469 6374 5072 696d 6572 293a  nsorDictPrimer):
+0002fa80: 0d0a 2020 2020 2222 2241 2067 5344 4520  ..    """A gSDE 
+0002fa90: 6e6f 6973 6520 696e 6974 6961 6c69 7a65  noise initialize
+0002faa0: 722e 0d0a 0d0a 2020 2020 5365 6520 7468  r.....    See th
+0002fab0: 6520 3a66 756e 633a 607e 746f 7263 6872  e :func:`~torchr
+0002fac0: 6c2e 6d6f 6475 6c65 732e 6d6f 6465 6c73  l.modules.models
+0002fad0: 2e65 7870 6c6f 7261 7469 6f6e 2e67 5344  .exploration.gSD
+0002fae0: 454d 6f64 756c 6527 2066 6f72 206d 6f72  EModule' for mor
+0002faf0: 6520 696e 666f 2e0d 0a20 2020 2022 2222  e info...    """
+0002fb00: 0d0a 0d0a 2020 2020 6465 6620 5f5f 696e  ....    def __in
+0002fb10: 6974 5f5f 280d 0a20 2020 2020 2020 2073  it__(..        s
+0002fb20: 656c 662c 0d0a 2020 2020 2020 2020 7374  elf,..        st
+0002fb30: 6174 655f 6469 6d3d 4e6f 6e65 2c0d 0a20  ate_dim=None,.. 
+0002fb40: 2020 2020 2020 2061 6374 696f 6e5f 6469         action_di
+0002fb50: 6d3d 4e6f 6e65 2c0d 0a20 2020 2020 2020  m=None,..       
+0002fb60: 2073 6861 7065 3d4e 6f6e 652c 0d0a 2020   shape=None,..  
+0002fb70: 2020 2020 2020 2a2a 6b77 6172 6773 2c0d        **kwargs,.
+0002fb80: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0d  .    ) -> None:.
+0002fb90: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
+0002fba0: 6174 655f 6469 6d20 3d20 7374 6174 655f  ate_dim = state_
+0002fbb0: 6469 6d0d 0a20 2020 2020 2020 2073 656c  dim..        sel
+0002fbc0: 662e 6163 7469 6f6e 5f64 696d 203d 2061  f.action_dim = a
+0002fbd0: 6374 696f 6e5f 6469 6d0d 0a20 2020 2020  ction_dim..     
+0002fbe0: 2020 2069 6620 7368 6170 6520 6973 204e     if shape is N
+0002fbf0: 6f6e 653a 0d0a 2020 2020 2020 2020 2020  one:..          
+0002fc00: 2020 7368 6170 6520 3d20 2829 0d0a 2020    shape = ()..  
+0002fc10: 2020 2020 2020 7461 696c 5f64 696d 203d        tail_dim =
+0002fc20: 2028 0d0a 2020 2020 2020 2020 2020 2020   (..            
+0002fc30: 2831 2c29 2069 6620 7374 6174 655f 6469  (1,) if state_di
+0002fc40: 6d20 6973 204e 6f6e 6520 6f72 2061 6374  m is None or act
+0002fc50: 696f 6e5f 6469 6d20 6973 204e 6f6e 6520  ion_dim is None 
+0002fc60: 656c 7365 2028 6163 7469 6f6e 5f64 696d  else (action_dim
+0002fc70: 2c20 7374 6174 655f 6469 6d29 0d0a 2020  , state_dim)..  
+0002fc80: 2020 2020 2020 290d 0a20 2020 2020 2020        )..       
+0002fc90: 2072 616e 646f 6d20 3d20 7374 6174 655f   random = state_
+0002fca0: 6469 6d20 6973 206e 6f74 204e 6f6e 6520  dim is not None 
+0002fcb0: 616e 6420 6163 7469 6f6e 5f64 696d 2069  and action_dim i
+0002fcc0: 7320 6e6f 7420 4e6f 6e65 0d0a 2020 2020  s not None..    
+0002fcd0: 2020 2020 7368 6170 6520 3d20 7475 706c      shape = tupl
+0002fce0: 6528 7368 6170 6529 202b 2074 6169 6c5f  e(shape) + tail_
+0002fcf0: 6469 6d0d 0a20 2020 2020 2020 2070 7269  dim..        pri
+0002fd00: 6d65 7273 203d 207b 225f 6570 735f 6753  mers = {"_eps_gS
+0002fd10: 4445 223a 2055 6e62 6f75 6e64 6564 436f  DE": UnboundedCo
+0002fd20: 6e74 696e 756f 7573 5465 6e73 6f72 5370  ntinuousTensorSp
+0002fd30: 6563 2873 6861 7065 3d73 6861 7065 297d  ec(shape=shape)}
+0002fd40: 0d0a 2020 2020 2020 2020 7375 7065 7228  ..        super(
+0002fd50: 292e 5f5f 696e 6974 5f5f 2870 7269 6d65  ).__init__(prime
+0002fd60: 7273 3d70 7269 6d65 7273 2c20 7261 6e64  rs=primers, rand
+0002fd70: 6f6d 3d72 616e 646f 6d2c 202a 2a6b 7761  om=random, **kwa
+0002fd80: 7267 7329 0d0a 0d0a 0d0a 636c 6173 7320  rgs)......class 
+0002fd90: 5665 634e 6f72 6d28 5472 616e 7366 6f72  VecNorm(Transfor
+0002fda0: 6d29 3a0d 0a20 2020 2022 2222 4d6f 7669  m):..    """Movi
+0002fdb0: 6e67 2061 7665 7261 6765 206e 6f72 6d61  ng average norma
+0002fdc0: 6c69 7a61 7469 6f6e 206c 6179 6572 2066  lization layer f
+0002fdd0: 6f72 2074 6f72 6368 726c 2065 6e76 6972  or torchrl envir
+0002fde0: 6f6e 6d65 6e74 732e 0d0a 0d0a 2020 2020  onments.....    
+0002fdf0: 5665 634e 6f72 6d20 6b65 6570 7320 7472  VecNorm keeps tr
+0002fe00: 6163 6b20 6f66 2074 6865 2073 756d 6d61  ack of the summa
+0002fe10: 7279 2073 7461 7469 7374 6963 7320 6f66  ry statistics of
+0002fe20: 2061 2064 6174 6173 6574 2074 6f20 7374   a dataset to st
+0002fe30: 616e 6461 7264 697a 650d 0a20 2020 2069  andardize..    i
+0002fe40: 7420 6f6e 2d74 6865 2d66 6c79 2e20 4966  t on-the-fly. If
+0002fe50: 2074 6865 2074 7261 6e73 666f 726d 2069   the transform i
+0002fe60: 7320 696e 2027 6576 616c 2720 6d6f 6465  s in 'eval' mode
+0002fe70: 2c20 7468 6520 7275 6e6e 696e 670d 0a20  , the running.. 
+0002fe80: 2020 2073 7461 7469 7374 6963 7320 6172     statistics ar
+0002fe90: 6520 6e6f 7420 7570 6461 7465 642e 0d0a  e not updated...
+0002fea0: 0d0a 2020 2020 4966 206d 756c 7469 706c  ..    If multipl
+0002feb0: 6520 7072 6f63 6573 7365 7320 6172 6520  e processes are 
+0002fec0: 7275 6e6e 696e 6720 6120 7369 6d69 6c61  running a simila
+0002fed0: 7220 656e 7669 726f 6e6d 656e 742c 206f  r environment, o
+0002fee0: 6e65 2063 616e 2070 6173 7320 610d 0a20  ne can pass a.. 
+0002fef0: 2020 2054 656e 736f 7244 6963 7442 6173     TensorDictBas
+0002ff00: 6520 696e 7374 616e 6365 2074 6861 7420  e instance that 
+0002ff10: 6973 2070 6c61 6365 6420 696e 2073 6861  is placed in sha
+0002ff20: 7265 6420 6d65 6d6f 7279 3a20 6966 2073  red memory: if s
+0002ff30: 6f2c 2065 7665 7279 2074 696d 650d 0a20  o, every time.. 
+0002ff40: 2020 2074 6865 206e 6f72 6d61 6c69 7a61     the normaliza
+0002ff50: 7469 6f6e 206c 6179 6572 2069 7320 7175  tion layer is qu
+0002ff60: 6572 6965 6420 6974 2077 696c 6c20 7570  eried it will up
+0002ff70: 6461 7465 2074 6865 2076 616c 7565 7320  date the values 
+0002ff80: 666f 7220 616c 6c0d 0a20 2020 2070 726f  for all..    pro
+0002ff90: 6365 7373 6573 2074 6861 7420 7368 6172  cesses that shar
+0002ffa0: 6520 7468 6520 7361 6d65 2072 6566 6572  e the same refer
+0002ffb0: 656e 6365 2e0d 0a0d 0a20 2020 2054 6f20  ence.....    To 
+0002ffc0: 7573 6520 5665 634e 6f72 6d20 6174 2069  use VecNorm at i
+0002ffd0: 6e66 6572 656e 6365 2074 696d 6520 616e  nference time an
+0002ffe0: 6420 6176 6f69 6420 7570 6461 7469 6e67  d avoid updating
+0002fff0: 2074 6865 2076 616c 7565 7320 7769 7468   the values with
+00030000: 2074 6865 206e 6577 0d0a 2020 2020 6f62   the new..    ob
+00030010: 7365 7276 6174 696f 6e73 2c20 6f6e 6520  servations, one 
+00030020: 7368 6f75 6c64 2073 7562 7374 6974 7574  should substitut
+00030030: 6520 7468 6973 206c 6179 6572 2062 7920  e this layer by 
+00030040: 6076 6563 6e6f 726d 2e74 6f5f 6f62 7365  `vecnorm.to_obse
+00030050: 7276 6174 696f 6e5f 6e6f 726d 2829 602e  rvation_norm()`.
+00030060: 0d0a 0d0a 2020 2020 4172 6773 3a0d 0a20  ....    Args:.. 
+00030070: 2020 2020 2020 2069 6e5f 6b65 7973 2028         in_keys (
+00030080: 7365 7175 656e 6365 206f 6620 4e65 7374  sequence of Nest
+00030090: 6564 4b65 792c 206f 7074 696f 6e61 6c29  edKey, optional)
+000300a0: 3a20 6b65 7973 2074 6f20 6265 2075 7064  : keys to be upd
+000300b0: 6174 6564 2e0d 0a20 2020 2020 2020 2020  ated...         
+000300c0: 2020 2064 6566 6175 6c74 3a20 5b22 6f62     default: ["ob
+000300d0: 7365 7276 6174 696f 6e22 2c20 2272 6577  servation", "rew
+000300e0: 6172 6422 5d0d 0a20 2020 2020 2020 206f  ard"]..        o
+000300f0: 7574 5f6b 6579 7320 2873 6571 7565 6e63  ut_keys (sequenc
+00030100: 6520 6f66 204e 6573 7465 644b 6579 2c20  e of NestedKey, 
+00030110: 6f70 7469 6f6e 616c 293a 2064 6573 7469  optional): desti
+00030120: 6e61 7469 6f6e 206b 6579 732e 0d0a 2020  nation keys...  
+00030130: 2020 2020 2020 2020 2020 4465 6661 756c            Defaul
+00030140: 7473 2074 6f20 6060 696e 5f6b 6579 7360  ts to ``in_keys`
+00030150: 602e 0d0a 2020 2020 2020 2020 7368 6172  `...        shar
+00030160: 6564 5f74 6420 2854 656e 736f 7244 6963  ed_td (TensorDic
+00030170: 7442 6173 652c 206f 7074 696f 6e61 6c29  tBase, optional)
+00030180: 3a20 4120 7368 6172 6564 2074 656e 736f  : A shared tenso
+00030190: 7264 6963 7420 636f 6e74 6169 6e69 6e67  rdict containing
+000301a0: 2074 6865 0d0a 2020 2020 2020 2020 2020   the..          
+000301b0: 2020 6b65 7973 206f 6620 7468 6520 7472    keys of the tr
+000301c0: 616e 7366 6f72 6d2e 0d0a 2020 2020 2020  ansform...      
+000301d0: 2020 6465 6361 7920 286e 756d 6265 722c    decay (number,
+000301e0: 206f 7074 696f 6e61 6c29 3a20 6465 6361   optional): deca
+000301f0: 7920 7261 7465 206f 6620 7468 6520 6d6f  y rate of the mo
+00030200: 7669 6e67 2061 7665 7261 6765 2e0d 0a20  ving average... 
+00030210: 2020 2020 2020 2020 2020 2064 6566 6175             defau
+00030220: 6c74 3a20 302e 3939 0d0a 2020 2020 2020  lt: 0.99..      
+00030230: 2020 6570 7320 286e 756d 6265 722c 206f    eps (number, o
+00030240: 7074 696f 6e61 6c29 3a20 6c6f 7765 7220  ptional): lower 
+00030250: 626f 756e 6420 6f66 2074 6865 2072 756e  bound of the run
+00030260: 6e69 6e67 2073 7461 6e64 6172 640d 0a20  ning standard.. 
+00030270: 2020 2020 2020 2020 2020 2064 6576 6961             devia
+00030280: 7469 6f6e 2028 666f 7220 6e75 6d65 7269  tion (for numeri
+00030290: 6361 6c20 756e 6465 7266 6c6f 7729 2e20  cal underflow). 
+000302a0: 4465 6661 756c 7420 6973 2031 652d 342e  Default is 1e-4.
+000302b0: 0d0a 2020 2020 2020 2020 7368 6170 6573  ..        shapes
+000302c0: 2028 4c69 7374 5b74 6f72 6368 2e53 697a   (List[torch.Siz
+000302d0: 655d 2c20 6f70 7469 6f6e 616c 293a 2069  e], optional): i
+000302e0: 6620 7072 6f76 6964 6564 2c20 7265 7072  f provided, repr
+000302f0: 6573 656e 7473 2074 6865 2073 6861 7065  esents the shape
+00030300: 0d0a 2020 2020 2020 2020 2020 2020 6f66  ..            of
+00030310: 2065 6163 6820 696e 5f6b 6579 732e 2049   each in_keys. I
+00030320: 7473 206c 656e 6774 6820 6d75 7374 206d  ts length must m
+00030330: 6174 6368 2074 6865 206f 6e65 206f 6620  atch the one of 
+00030340: 6060 696e 5f6b 6579 7360 602e 0d0a 2020  ``in_keys``...  
+00030350: 2020 2020 2020 2020 2020 4561 6368 2073            Each s
+00030360: 6861 7065 206d 7573 7420 6d61 7463 6820  hape must match 
+00030370: 7468 6520 7472 6169 6c69 6e67 2064 696d  the trailing dim
+00030380: 656e 7369 6f6e 206f 6620 7468 6520 636f  ension of the co
+00030390: 7272 6573 706f 6e64 696e 670d 0a20 2020  rresponding..   
+000303a0: 2020 2020 2020 2020 2065 6e74 7279 2e0d           entry..
+000303b0: 0a20 2020 2020 2020 2020 2020 2049 6620  .            If 
+000303c0: 6e6f 742c 2074 6865 2066 6561 7475 7265  not, the feature
+000303d0: 2064 696d 656e 7369 6f6e 7320 6f66 2074   dimensions of t
+000303e0: 6865 2065 6e74 7279 2028 6965 2061 6c6c  he entry (ie all
+000303f0: 2064 696d 7320 7468 6174 2064 6f0d 0a20   dims that do.. 
+00030400: 2020 2020 2020 2020 2020 206e 6f74 2062             not b
+00030410: 656c 6f6e 6720 746f 2074 6865 2074 656e  elong to the ten
+00030420: 736f 7264 6963 7420 6261 7463 682d 7369  sordict batch-si
+00030430: 7a65 2920 7769 6c6c 2062 6520 636f 6e73  ze) will be cons
+00030440: 6964 6572 6564 2061 730d 0a20 2020 2020  idered as..     
+00030450: 2020 2020 2020 2066 6561 7475 7265 2064         feature d
+00030460: 696d 656e 7369 6f6e 2e0d 0a0d 0a20 2020  imension.....   
+00030470: 2045 7861 6d70 6c65 733a 0d0a 2020 2020   Examples:..    
+00030480: 2020 2020 3e3e 3e20 6672 6f6d 2074 6f72      >>> from tor
+00030490: 6368 726c 2e65 6e76 732e 6c69 6273 2e67  chrl.envs.libs.g
+000304a0: 796d 2069 6d70 6f72 7420 4779 6d45 6e76  ym import GymEnv
+000304b0: 0d0a 2020 2020 2020 2020 3e3e 3e20 7420  ..        >>> t 
+000304c0: 3d20 5665 634e 6f72 6d28 6465 6361 793d  = VecNorm(decay=
+000304d0: 302e 3929 0d0a 2020 2020 2020 2020 3e3e  0.9)..        >>
+000304e0: 3e20 656e 7620 3d20 4779 6d45 6e76 2822  > env = GymEnv("
+000304f0: 5065 6e64 756c 756d 2d76 3022 290d 0a20  Pendulum-v0").. 
+00030500: 2020 2020 2020 203e 3e3e 2065 6e76 203d         >>> env =
+00030510: 2054 7261 6e73 666f 726d 6564 456e 7628   TransformedEnv(
+00030520: 656e 762c 2074 290d 0a20 2020 2020 2020  env, t)..       
+00030530: 203e 3e3e 2074 6473 203d 205b 5d0d 0a20   >>> tds = [].. 
+00030540: 2020 2020 2020 203e 3e3e 2066 6f72 205f         >>> for _
+00030550: 2069 6e20 7261 6e67 6528 3130 3030 293a   in range(1000):
+00030560: 0d0a 2020 2020 2020 2020 2e2e 2e20 2020  ..        ...   
+00030570: 2020 7464 203d 2065 6e76 2e72 616e 645f    td = env.rand_
+00030580: 7374 6570 2829 0d0a 2020 2020 2020 2020  step()..        
+00030590: 2e2e 2e20 2020 2020 6966 2074 642e 6765  ...     if td.ge
+000305a0: 7428 2264 6f6e 6522 293a 0d0a 2020 2020  t("done"):..    
+000305b0: 2020 2020 2e2e 2e20 2020 2020 2020 2020      ...         
+000305c0: 5f20 3d20 656e 762e 7265 7365 7428 290d  _ = env.reset().
+000305d0: 0a20 2020 2020 2020 202e 2e2e 2020 2020  .        ...    
+000305e0: 2074 6473 202b 3d20 5b74 645d 0d0a 2020   tds += [td]..  
+000305f0: 2020 2020 2020 3e3e 3e20 7464 7320 3d20        >>> tds = 
+00030600: 746f 7263 682e 7374 6163 6b28 7464 732c  torch.stack(tds,
+00030610: 2030 290d 0a20 2020 2020 2020 203e 3e3e   0)..        >>>
+00030620: 2070 7269 6e74 2828 6162 7328 7464 732e   print((abs(tds.
+00030630: 6765 7428 2822 6e65 7874 222c 2022 6f62  get(("next", "ob
+00030640: 7365 7276 6174 696f 6e22 2929 2e6d 6561  servation")).mea
+00030650: 6e28 3029 293c 302e 3229 2e61 6c6c 2829  n(0))<0.2).all()
+00030660: 290d 0a20 2020 2020 2020 2074 656e 736f  )..        tenso
+00030670: 7228 5472 7565 290d 0a20 2020 2020 2020  r(True)..       
+00030680: 203e 3e3e 2070 7269 6e74 2828 6162 7328   >>> print((abs(
+00030690: 7464 732e 6765 7428 2822 6e65 7874 222c  tds.get(("next",
+000306a0: 2022 6f62 7365 7276 6174 696f 6e22 2929   "observation"))
+000306b0: 2e73 7464 2830 292d 3129 3c30 2e32 292e  .std(0)-1)<0.2).
+000306c0: 616c 6c28 2929 0d0a 2020 2020 2020 2020  all())..        
+000306d0: 7465 6e73 6f72 2854 7275 6529 0d0a 0d0a  tensor(True)....
+000306e0: 2020 2020 2222 220d 0a0d 0a20 2020 2064      """....    d
+000306f0: 6566 205f 5f69 6e69 745f 5f28 0d0a 2020  ef __init__(..  
+00030700: 2020 2020 2020 7365 6c66 2c0d 0a20 2020        self,..   
+00030710: 2020 2020 2069 6e5f 6b65 7973 3a20 5365       in_keys: Se
+00030720: 7175 656e 6365 5b4e 6573 7465 644b 6579  quence[NestedKey
+00030730: 5d20 7c20 4e6f 6e65 203d 204e 6f6e 652c  ] | None = None,
+00030740: 0d0a 2020 2020 2020 2020 6f75 745f 6b65  ..        out_ke
+00030750: 7973 3a20 5365 7175 656e 6365 5b4e 6573  ys: Sequence[Nes
+00030760: 7465 644b 6579 5d20 7c20 4e6f 6e65 203d  tedKey] | None =
+00030770: 204e 6f6e 652c 0d0a 2020 2020 2020 2020   None,..        
+00030780: 7368 6172 6564 5f74 643a 204f 7074 696f  shared_td: Optio
+00030790: 6e61 6c5b 5465 6e73 6f72 4469 6374 4261  nal[TensorDictBa
+000307a0: 7365 5d20 3d20 4e6f 6e65 2c0d 0a20 2020  se] = None,..   
+000307b0: 2020 2020 206c 6f63 6b3a 206d 702e 4c6f       lock: mp.Lo
+000307c0: 636b 203d 204e 6f6e 652c 0d0a 2020 2020  ck = None,..    
+000307d0: 2020 2020 6465 6361 793a 2066 6c6f 6174      decay: float
+000307e0: 203d 2030 2e39 3939 392c 0d0a 2020 2020   = 0.9999,..    
+000307f0: 2020 2020 6570 733a 2066 6c6f 6174 203d      eps: float =
+00030800: 2031 652d 342c 0d0a 2020 2020 2020 2020   1e-4,..        
+00030810: 7368 6170 6573 3a20 4c69 7374 5b74 6f72  shapes: List[tor
+00030820: 6368 2e53 697a 655d 203d 204e 6f6e 652c  ch.Size] = None,
+00030830: 0d0a 2020 2020 2920 2d3e 204e 6f6e 653a  ..    ) -> None:
+00030840: 0d0a 2020 2020 2020 2020 6966 206c 6f63  ..        if loc
+00030850: 6b20 6973 204e 6f6e 653a 0d0a 2020 2020  k is None:..    
+00030860: 2020 2020 2020 2020 6c6f 636b 203d 206d          lock = m
+00030870: 702e 4c6f 636b 2829 0d0a 2020 2020 2020  p.Lock()..      
+00030880: 2020 6966 2069 6e5f 6b65 7973 2069 7320    if in_keys is 
+00030890: 4e6f 6e65 3a0d 0a20 2020 2020 2020 2020  None:..         
+000308a0: 2020 2069 6e5f 6b65 7973 203d 205b 226f     in_keys = ["o
+000308b0: 6273 6572 7661 7469 6f6e 222c 2022 7265  bservation", "re
+000308c0: 7761 7264 225d 0d0a 2020 2020 2020 2020  ward"]..        
+000308d0: 6966 206f 7574 5f6b 6579 7320 6973 204e  if out_keys is N
+000308e0: 6f6e 653a 0d0a 2020 2020 2020 2020 2020  one:..          
+000308f0: 2020 6f75 745f 6b65 7973 203d 2063 6f70    out_keys = cop
+00030900: 7928 696e 5f6b 6579 7329 0d0a 2020 2020  y(in_keys)..    
+00030910: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
+00030920: 6974 5f5f 2869 6e5f 6b65 7973 3d69 6e5f  it__(in_keys=in_
+00030930: 6b65 7973 2c20 6f75 745f 6b65 7973 3d6f  keys, out_keys=o
+00030940: 7574 5f6b 6579 7329 0d0a 2020 2020 2020  ut_keys)..      
+00030950: 2020 7365 6c66 2e5f 7464 203d 2073 6861    self._td = sha
+00030960: 7265 645f 7464 0d0a 2020 2020 2020 2020  red_td..        
+00030970: 6966 2073 6861 7265 645f 7464 2069 7320  if shared_td is 
+00030980: 6e6f 7420 4e6f 6e65 2061 6e64 206e 6f74  not None and not
+00030990: 2028 0d0a 2020 2020 2020 2020 2020 2020   (..            
+000309a0: 7368 6172 6564 5f74 642e 6973 5f73 6861  shared_td.is_sha
+000309b0: 7265 6428 2920 6f72 2073 6861 7265 645f  red() or shared_
+000309c0: 7464 2e69 735f 6d65 6d6d 6170 2829 0d0a  td.is_memmap()..
+000309d0: 2020 2020 2020 2020 293a 0d0a 2020 2020          ):..    
+000309e0: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
+000309f0: 6e74 696d 6545 7272 6f72 280d 0a20 2020  ntimeError(..   
+00030a00: 2020 2020 2020 2020 2020 2020 2022 7368               "sh
+00030a10: 6172 6564 5f74 6420 6d75 7374 2062 6520  ared_td must be 
+00030a20: 6569 7468 6572 2069 6e20 7368 6172 6564  either in shared
+00030a30: 206d 656d 6f72 7920 6f72 2061 206d 656d   memory or a mem
+00030a40: 6d61 7020 2220 2274 656e 736f 7264 6963  map " "tensordic
+00030a50: 742e 220d 0a20 2020 2020 2020 2020 2020  t."..           
+00030a60: 2029 0d0a 2020 2020 2020 2020 6966 2073   )..        if s
+00030a70: 6861 7265 645f 7464 2069 7320 6e6f 7420  hared_td is not 
+00030a80: 4e6f 6e65 3a0d 0a20 2020 2020 2020 2020  None:..         
+00030a90: 2020 2066 6f72 206b 6579 2069 6e20 696e     for key in in
+00030aa0: 5f6b 6579 733a 0d0a 2020 2020 2020 2020  _keys:..        
+00030ab0: 2020 2020 2020 2020 6966 2028 0d0a 2020          if (..  
+00030ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030ad0: 2020 285f 6170 7065 6e64 5f6c 6173 7428    (_append_last(
+00030ae0: 6b65 792c 2022 5f73 756d 2229 206e 6f74  key, "_sum") not
+00030af0: 2069 6e20 7368 6172 6564 5f74 642e 6b65   in shared_td.ke
+00030b00: 7973 2829 290d 0a20 2020 2020 2020 2020  ys())..         
+00030b10: 2020 2020 2020 2020 2020 206f 7220 285f             or (_
+00030b20: 6170 7065 6e64 5f6c 6173 7428 6b65 792c  append_last(key,
+00030b30: 2022 5f73 7371 2229 206e 6f74 2069 6e20   "_ssq") not in 
+00030b40: 7368 6172 6564 5f74 642e 6b65 7973 2829  shared_td.keys()
+00030b50: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+00030b60: 2020 2020 2020 206f 7220 285f 6170 7065         or (_appe
+00030b70: 6e64 5f6c 6173 7428 6b65 792c 2022 5f63  nd_last(key, "_c
+00030b80: 6f75 6e74 2229 206e 6f74 2069 6e20 7368  ount") not in sh
+00030b90: 6172 6564 5f74 642e 6b65 7973 2829 290d  ared_td.keys()).
+00030ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030bb0: 2029 3a0d 0a20 2020 2020 2020 2020 2020   ):..           
+00030bc0: 2020 2020 2020 2020 2072 6169 7365 204b           raise K
+00030bd0: 6579 4572 726f 7228 0d0a 2020 2020 2020  eyError(..      
+00030be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030bf0: 2020 6622 6b65 7920 7b6b 6579 7d20 6e6f    f"key {key} no
+00030c00: 7420 7072 6573 656e 7420 696e 2074 6865  t present in the
+00030c10: 2073 6861 7265 6420 7465 6e73 6f72 6469   shared tensordi
+00030c20: 6374 2022 0d0a 2020 2020 2020 2020 2020  ct "..          
+00030c30: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00030c40: 7769 7468 206b 6579 7320 7b73 6861 7265  with keys {share
+00030c50: 645f 7464 2e6b 6579 7328 297d 220d 0a20  d_td.keys()}".. 
+00030c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030c70: 2020 2029 0d0a 0d0a 2020 2020 2020 2020     )....        
+00030c80: 7365 6c66 2e6c 6f63 6b20 3d20 6c6f 636b  self.lock = lock
+00030c90: 0d0a 2020 2020 2020 2020 7365 6c66 2e64  ..        self.d
+00030ca0: 6563 6179 203d 2064 6563 6179 0d0a 2020  ecay = decay..  
+00030cb0: 2020 2020 2020 7365 6c66 2e73 6861 7065        self.shape
+00030cc0: 7320 3d20 7368 6170 6573 0d0a 2020 2020  s = shapes..    
+00030cd0: 2020 2020 7365 6c66 2e65 7073 203d 2065      self.eps = e
+00030ce0: 7073 0d0a 0d0a 2020 2020 6465 6620 5f72  ps....    def _r
+00030cf0: 6573 6574 280d 0a20 2020 2020 2020 2073  eset(..        s
+00030d00: 656c 662c 2074 656e 736f 7264 6963 743a  elf, tensordict:
+00030d10: 2054 656e 736f 7244 6963 7442 6173 652c   TensorDictBase,
+00030d20: 2074 656e 736f 7264 6963 745f 7265 7365   tensordict_rese
+00030d30: 743a 2054 656e 736f 7244 6963 7442 6173  t: TensorDictBas
+00030d40: 650d 0a20 2020 2029 202d 3e20 5465 6e73  e..    ) -> Tens
+00030d50: 6f72 4469 6374 4261 7365 3a0d 0a20 2020  orDictBase:..   
+00030d60: 2020 2020 2023 2054 4f44 4f3a 2072 656d       # TODO: rem
+00030d70: 6f76 6520 7468 6973 2064 6563 6f72 6174  ove this decorat
+00030d80: 6f72 2077 6865 6e20 7472 6163 6b65 7273  or when trackers
+00030d90: 2061 7265 2069 6e20 6461 7461 0d0a 2020   are in data..  
+00030da0: 2020 2020 2020 7769 7468 205f 7365 745f        with _set_
+00030db0: 6d69 7373 696e 675f 746f 6c65 7261 6e63  missing_toleranc
+00030dc0: 6528 7365 6c66 2c20 5472 7565 293a 0d0a  e(self, True):..
+00030dd0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00030de0: 726e 2073 656c 662e 5f63 616c 6c28 7465  rn self._call(te
+00030df0: 6e73 6f72 6469 6374 5f72 6573 6574 290d  nsordict_reset).
+00030e00: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00030e10: 7465 6e73 6f72 6469 6374 5f72 6573 6574  tensordict_reset
+00030e20: 0d0a 0d0a 2020 2020 6465 6620 5f63 616c  ....    def _cal
+00030e30: 6c28 7365 6c66 2c20 7465 6e73 6f72 6469  l(self, tensordi
+00030e40: 6374 3a20 5465 6e73 6f72 4469 6374 4261  ct: TensorDictBa
+00030e50: 7365 2920 2d3e 2054 656e 736f 7244 6963  se) -> TensorDic
+00030e60: 7442 6173 653a 0d0a 2020 2020 2020 2020  tBase:..        
+00030e70: 6966 2073 656c 662e 6c6f 636b 2069 7320  if self.lock is 
+00030e80: 6e6f 7420 4e6f 6e65 3a0d 0a20 2020 2020  not None:..     
+00030e90: 2020 2020 2020 2073 656c 662e 6c6f 636b         self.lock
+00030ea0: 2e61 6371 7569 7265 2829 0d0a 0d0a 2020  .acquire()....  
+00030eb0: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
+00030ec0: 2073 656c 662e 696e 5f6b 6579 733a 0d0a   self.in_keys:..
+00030ed0: 2020 2020 2020 2020 2020 2020 6966 206b              if k
+00030ee0: 6579 206e 6f74 2069 6e20 7465 6e73 6f72  ey not in tensor
+00030ef0: 6469 6374 2e6b 6579 7328 696e 636c 7564  dict.keys(includ
+00030f00: 655f 6e65 7374 6564 3d54 7275 6529 3a0d  e_nested=True):.
+00030f10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030f20: 2023 2054 4f44 4f3a 2069 6e69 7420 6d69   # TODO: init mi
+00030f30: 7373 696e 6720 7265 7761 7264 7320 7769  ssing rewards wi
+00030f40: 7468 2074 6869 730d 0a20 2020 2020 2020  th this..       
+00030f50: 2020 2020 2020 2020 2023 2066 6f72 206b           # for k
+00030f60: 6579 5f73 7566 6669 7820 696e 205b 5f61  ey_suffix in [_a
+00030f70: 7070 656e 645f 6c61 7374 286b 6579 2c20  ppend_last(key, 
+00030f80: 7375 6666 6978 2920 666f 7220 7375 6666  suffix) for suff
+00030f90: 6978 2069 6e20 2822 5f73 756d 222c 2022  ix in ("_sum", "
+00030fa0: 5f73 7371 222c 2022 5f63 6f75 6e74 2229  _ssq", "_count")
+00030fb0: 5d3a 0d0a 2020 2020 2020 2020 2020 2020  ]:..            
+00030fc0: 2020 2020 2320 2020 2020 7465 6e73 6f72      #     tensor
+00030fd0: 6469 6374 2e73 6574 286b 6579 5f73 7566  dict.set(key_suf
+00030fe0: 6669 782c 2073 656c 662e 636f 6e74 6169  fix, self.contai
+00030ff0: 6e65 722e 6f62 7365 7276 6174 696f 6e5f  ner.observation_
+00031000: 7370 6563 5b6b 6579 5f73 7566 6669 785d  spec[key_suffix]
+00031010: 2e7a 6572 6f28 2929 0d0a 2020 2020 2020  .zero())..      
+00031020: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+00031030: 7565 0d0a 2020 2020 2020 2020 2020 2020  ue..            
+00031040: 7365 6c66 2e5f 696e 6974 2874 656e 736f  self._init(tenso
+00031050: 7264 6963 742c 206b 6579 290d 0a20 2020  rdict, key)..   
+00031060: 2020 2020 2020 2020 2023 2075 7064 6174           # updat
+00031070: 6520 616e 6420 7374 616e 6461 7264 697a  e and standardiz
+00031080: 650d 0a20 2020 2020 2020 2020 2020 206e  e..            n
+00031090: 6577 5f76 616c 203d 2073 656c 662e 5f75  ew_val = self._u
+000310a0: 7064 6174 6528 0d0a 2020 2020 2020 2020  pdate(..        
+000310b0: 2020 2020 2020 2020 6b65 792c 2074 656e          key, ten
+000310c0: 736f 7264 6963 742e 6765 7428 6b65 7929  sordict.get(key)
+000310d0: 2c20 4e3d 6d61 7828 312c 2074 656e 736f  , N=max(1, tenso
+000310e0: 7264 6963 742e 6e75 6d65 6c28 2929 0d0a  rdict.numel())..
+000310f0: 2020 2020 2020 2020 2020 2020 290d 0a0d              )...
+00031100: 0a20 2020 2020 2020 2020 2020 2074 656e  .            ten
+00031110: 736f 7264 6963 742e 7365 7428 6b65 792c  sordict.set(key,
+00031120: 206e 6577 5f76 616c 290d 0a0d 0a20 2020   new_val)....   
+00031130: 2020 2020 2069 6620 7365 6c66 2e6c 6f63       if self.loc
+00031140: 6b20 6973 206e 6f74 204e 6f6e 653a 0d0a  k is not None:..
+00031150: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00031160: 2e6c 6f63 6b2e 7265 6c65 6173 6528 290d  .lock.release().
+00031170: 0a0d 0a20 2020 2020 2020 2072 6574 7572  ...        retur
+00031180: 6e20 7465 6e73 6f72 6469 6374 0d0a 0d0a  n tensordict....
+00031190: 2020 2020 666f 7277 6172 6420 3d20 5f63      forward = _c
+000311a0: 616c 6c0d 0a0d 0a20 2020 2064 6566 205f  all....    def _
+000311b0: 696e 6974 2873 656c 662c 2074 656e 736f  init(self, tenso
+000311c0: 7264 6963 743a 2054 656e 736f 7244 6963  rdict: TensorDic
+000311d0: 7442 6173 652c 206b 6579 3a20 7374 7229  tBase, key: str)
+000311e0: 202d 3e20 4e6f 6e65 3a0d 0a20 2020 2020   -> None:..     
+000311f0: 2020 2069 6620 7365 6c66 2e5f 7464 2069     if self._td i
+00031200: 7320 4e6f 6e65 206f 7220 5f61 7070 656e  s None or _appen
+00031210: 645f 6c61 7374 286b 6579 2c20 225f 7375  d_last(key, "_su
+00031220: 6d22 2920 6e6f 7420 696e 2073 656c 662e  m") not in self.
+00031230: 5f74 642e 6b65 7973 2854 7275 6529 3a0d  _td.keys(True):.
+00031240: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00031250: 6b65 7920 6973 206e 6f74 206b 6579 2061  key is not key a
+00031260: 6e64 206b 6579 2069 6e20 7465 6e73 6f72  nd key in tensor
+00031270: 6469 6374 2e6b 6579 7328 293a 0d0a 2020  dict.keys():..  
+00031280: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00031290: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
+000312a0: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
+000312b0: 2020 2020 2020 2066 2243 6f6e 666c 6963         f"Conflic
+000312c0: 7469 6e67 206b 6579 206e 616d 6573 3a20  ting key names: 
+000312d0: 7b6b 6579 7d20 6672 6f6d 2056 6563 4e6f  {key} from VecNo
+000312e0: 726d 2061 6e64 2069 6e70 7574 2074 656e  rm and input ten
+000312f0: 736f 7264 6963 7420 6b65 7973 2e22 0d0a  sordict keys."..
+00031300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031310: 290d 0a20 2020 2020 2020 2020 2020 2069  )..            i
+00031320: 6620 7365 6c66 2e73 6861 7065 7320 6973  f self.shapes is
+00031330: 204e 6f6e 653a 0d0a 2020 2020 2020 2020   None:..        
+00031340: 2020 2020 2020 2020 7464 5f76 6965 7720          td_view 
+00031350: 3d20 7465 6e73 6f72 6469 6374 2e76 6965  = tensordict.vie
+00031360: 7728 2d31 290d 0a20 2020 2020 2020 2020  w(-1)..         
+00031370: 2020 2020 2020 2074 645f 7365 6c65 6374         td_select
+00031380: 203d 2074 645f 7669 6577 5b30 5d0d 0a20   = td_view[0].. 
+00031390: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000313a0: 7465 6d20 3d20 7464 5f73 656c 6563 742e  tem = td_select.
+000313b0: 6765 7428 6b65 7929 0d0a 2020 2020 2020  get(key)..      
+000313c0: 2020 2020 2020 2020 2020 6420 3d20 7b5f            d = {_
+000313d0: 6170 7065 6e64 5f6c 6173 7428 6b65 792c  append_last(key,
+000313e0: 2022 5f73 756d 2229 3a20 746f 7263 682e   "_sum"): torch.
+000313f0: 7a65 726f 735f 6c69 6b65 2869 7465 6d29  zeros_like(item)
+00031400: 7d0d 0a20 2020 2020 2020 2020 2020 2020  }..             
+00031410: 2020 2064 2e75 7064 6174 6528 7b5f 6170     d.update({_ap
+00031420: 7065 6e64 5f6c 6173 7428 6b65 792c 2022  pend_last(key, "
+00031430: 5f73 7371 2229 3a20 746f 7263 682e 7a65  _ssq"): torch.ze
+00031440: 726f 735f 6c69 6b65 2869 7465 6d29 7d29  ros_like(item)})
+00031450: 0d0a 2020 2020 2020 2020 2020 2020 656c  ..            el
+00031460: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
+00031470: 2020 2020 2069 6478 203d 2030 0d0a 2020       idx = 0..  
+00031480: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00031490: 7220 696e 5f6b 6579 2069 6e20 7365 6c66  r in_key in self
+000314a0: 2e69 6e5f 6b65 7973 3a0d 0a20 2020 2020  .in_keys:..     
+000314b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000314c0: 6620 696e 5f6b 6579 2021 3d20 6b65 793a  f in_key != key:
+000314d0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000314e0: 2020 2020 2020 2020 2020 6964 7820 2b3d            idx +=
+000314f0: 2031 0d0a 2020 2020 2020 2020 2020 2020   1..            
+00031500: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
+00031510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031520: 2020 2020 2020 2062 7265 616b 0d0a 2020         break..  
+00031530: 2020 2020 2020 2020 2020 2020 2020 7368                sh
+00031540: 6170 6520 3d20 7365 6c66 2e73 6861 7065  ape = self.shape
+00031550: 735b 6964 785d 0d0a 2020 2020 2020 2020  s[idx]..        
+00031560: 2020 2020 2020 2020 6974 656d 203d 2074          item = t
+00031570: 656e 736f 7264 6963 742e 6765 7428 6b65  ensordict.get(ke
+00031580: 7929 0d0a 2020 2020 2020 2020 2020 2020  y)..            
+00031590: 2020 2020 6420 3d20 7b0d 0a20 2020 2020      d = {..     
+000315a0: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+000315b0: 6170 7065 6e64 5f6c 6173 7428 6b65 792c  append_last(key,
+000315c0: 2022 5f73 756d 2229 3a20 746f 7263 682e   "_sum"): torch.
+000315d0: 7a65 726f 7328 0d0a 2020 2020 2020 2020  zeros(..        
+000315e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000315f0: 7368 6170 652c 2064 6576 6963 653d 6974  shape, device=it
+00031600: 656d 2e64 6576 6963 652c 2064 7479 7065  em.device, dtype
+00031610: 3d69 7465 6d2e 6474 7970 650d 0a20 2020  =item.dtype..   
+00031620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031630: 2029 0d0a 2020 2020 2020 2020 2020 2020   )..            
+00031640: 2020 2020 7d0d 0a20 2020 2020 2020 2020      }..         
+00031650: 2020 2020 2020 2064 2e75 7064 6174 6528         d.update(
+00031660: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00031670: 2020 2020 2020 7b0d 0a20 2020 2020 2020        {..       
+00031680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031690: 205f 6170 7065 6e64 5f6c 6173 7428 6b65   _append_last(ke
+000316a0: 792c 2022 5f73 7371 2229 3a20 746f 7263  y, "_ssq"): torc
+000316b0: 682e 7a65 726f 7328 0d0a 2020 2020 2020  h.zeros(..      
+000316c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000316d0: 2020 2020 2020 7368 6170 652c 2064 6576        shape, dev
+000316e0: 6963 653d 6974 656d 2e64 6576 6963 652c  ice=item.device,
+000316f0: 2064 7479 7065 3d69 7465 6d2e 6474 7970   dtype=item.dtyp
+00031700: 650d 0a20 2020 2020 2020 2020 2020 2020  e..             
+00031710: 2020 2020 2020 2020 2020 2029 0d0a 2020             )..  
+00031720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031730: 2020 7d0d 0a20 2020 2020 2020 2020 2020    }..           
+00031740: 2020 2020 2029 0d0a 0d0a 2020 2020 2020       )....      
+00031750: 2020 2020 2020 642e 7570 6461 7465 280d        d.update(.
+00031760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00031770: 207b 0d0a 2020 2020 2020 2020 2020 2020   {..            
+00031780: 2020 2020 2020 2020 5f61 7070 656e 645f          _append_
+00031790: 6c61 7374 286b 6579 2c20 225f 636f 756e  last(key, "_coun
+000317a0: 7422 293a 2074 6f72 6368 2e7a 6572 6f73  t"): torch.zeros
+000317b0: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
+000317c0: 2020 2020 2020 2020 2020 2031 2c20 6465             1, de
+000317d0: 7669 6365 3d69 7465 6d2e 6465 7669 6365  vice=item.device
+000317e0: 2c20 6474 7970 653d 746f 7263 682e 666c  , dtype=torch.fl
+000317f0: 6f61 740d 0a20 2020 2020 2020 2020 2020  oat..           
+00031800: 2020 2020 2020 2020 2029 0d0a 2020 2020           )..    
+00031810: 2020 2020 2020 2020 2020 2020 7d0d 0a20              }.. 
+00031820: 2020 2020 2020 2020 2020 2029 0d0a 2020             )..  
+00031830: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+00031840: 662e 5f74 6420 6973 204e 6f6e 653a 0d0a  f._td is None:..
+00031850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031860: 7365 6c66 2e5f 7464 203d 2054 656e 736f  self._td = Tenso
+00031870: 7244 6963 7428 642c 2062 6174 6368 5f73  rDict(d, batch_s
+00031880: 697a 653d 5b5d 290d 0a20 2020 2020 2020  ize=[])..       
+00031890: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
+000318a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000318b0: 2e5f 7464 2e75 7064 6174 6528 6429 0d0a  ._td.update(d)..
+000318c0: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
+000318d0: 2020 2020 2020 2020 2020 2070 6173 730d             pass.
+000318e0: 0a0d 0a20 2020 2064 6566 205f 7570 6461  ...    def _upda
+000318f0: 7465 2873 656c 662c 206b 6579 2c20 7661  te(self, key, va
+00031900: 6c75 652c 204e 2920 2d3e 2074 6f72 6368  lue, N) -> torch
+00031910: 2e54 656e 736f 723a 0d0a 2020 2020 2020  .Tensor:..      
+00031920: 2020 5f73 756d 203d 2073 656c 662e 5f74    _sum = self._t
+00031930: 642e 6765 7428 5f61 7070 656e 645f 6c61  d.get(_append_la
+00031940: 7374 286b 6579 2c20 225f 7375 6d22 2929  st(key, "_sum"))
+00031950: 0d0a 2020 2020 2020 2020 5f73 7371 203d  ..        _ssq =
+00031960: 2073 656c 662e 5f74 642e 6765 7428 5f61   self._td.get(_a
+00031970: 7070 656e 645f 6c61 7374 286b 6579 2c20  ppend_last(key, 
+00031980: 225f 7373 7122 2929 0d0a 2020 2020 2020  "_ssq"))..      
+00031990: 2020 5f63 6f75 6e74 203d 2073 656c 662e    _count = self.
+000319a0: 5f74 642e 6765 7428 5f61 7070 656e 645f  _td.get(_append_
+000319b0: 6c61 7374 286b 6579 2c20 225f 636f 756e  last(key, "_coun
+000319c0: 7422 2929 0d0a 0d0a 2020 2020 2020 2020  t"))....        
+000319d0: 7661 6c75 655f 7375 6d20 3d20 5f73 756d  value_sum = _sum
+000319e0: 5f6c 6566 7428 7661 6c75 652c 205f 7375  _left(value, _su
+000319f0: 6d29 0d0a 2020 2020 2020 2020 5f73 756d  m)..        _sum
+00031a00: 202a 3d20 7365 6c66 2e64 6563 6179 0d0a   *= self.decay..
+00031a10: 2020 2020 2020 2020 5f73 756d 202b 3d20          _sum += 
+00031a20: 7661 6c75 655f 7375 6d0d 0a20 2020 2020  value_sum..     
+00031a30: 2020 2073 656c 662e 5f74 642e 7365 745f     self._td.set_
+00031a40: 280d 0a20 2020 2020 2020 2020 2020 205f  (..            _
+00031a50: 6170 7065 6e64 5f6c 6173 7428 6b65 792c  append_last(key,
+00031a60: 2022 5f73 756d 2229 2c0d 0a20 2020 2020   "_sum"),..     
+00031a70: 2020 2020 2020 205f 7375 6d2c 0d0a 2020         _sum,..  
+00031a80: 2020 2020 2020 290d 0a0d 0a20 2020 2020        )....     
+00031a90: 2020 205f 7373 7120 3d20 7365 6c66 2e5f     _ssq = self._
+00031aa0: 7464 2e67 6574 285f 6170 7065 6e64 5f6c  td.get(_append_l
+00031ab0: 6173 7428 6b65 792c 2022 5f73 7371 2229  ast(key, "_ssq")
+00031ac0: 290d 0a20 2020 2020 2020 2076 616c 7565  )..        value
+00031ad0: 5f73 7371 203d 205f 7375 6d5f 6c65 6674  _ssq = _sum_left
+00031ae0: 2876 616c 7565 2e70 6f77 2832 292c 205f  (value.pow(2), _
+00031af0: 7373 7129 0d0a 2020 2020 2020 2020 5f73  ssq)..        _s
+00031b00: 7371 202a 3d20 7365 6c66 2e64 6563 6179  sq *= self.decay
+00031b10: 0d0a 2020 2020 2020 2020 5f73 7371 202b  ..        _ssq +
+00031b20: 3d20 7661 6c75 655f 7373 710d 0a20 2020  = value_ssq..   
+00031b30: 2020 2020 2073 656c 662e 5f74 642e 7365       self._td.se
+00031b40: 745f 280d 0a20 2020 2020 2020 2020 2020  t_(..           
+00031b50: 205f 6170 7065 6e64 5f6c 6173 7428 6b65   _append_last(ke
+00031b60: 792c 2022 5f73 7371 2229 2c0d 0a20 2020  y, "_ssq"),..   
+00031b70: 2020 2020 2020 2020 205f 7373 712c 0d0a           _ssq,..
+00031b80: 2020 2020 2020 2020 290d 0a0d 0a20 2020          )....   
+00031b90: 2020 2020 205f 636f 756e 7420 3d20 7365       _count = se
+00031ba0: 6c66 2e5f 7464 2e67 6574 285f 6170 7065  lf._td.get(_appe
+00031bb0: 6e64 5f6c 6173 7428 6b65 792c 2022 5f63  nd_last(key, "_c
+00031bc0: 6f75 6e74 2229 290d 0a20 2020 2020 2020  ount"))..       
+00031bd0: 205f 636f 756e 7420 2a3d 2073 656c 662e   _count *= self.
+00031be0: 6465 6361 790d 0a20 2020 2020 2020 205f  decay..        _
+00031bf0: 636f 756e 7420 2b3d 204e 0d0a 2020 2020  count += N..    
+00031c00: 2020 2020 7365 6c66 2e5f 7464 2e73 6574      self._td.set
+00031c10: 5f28 0d0a 2020 2020 2020 2020 2020 2020  _(..            
+00031c20: 5f61 7070 656e 645f 6c61 7374 286b 6579  _append_last(key
+00031c30: 2c20 225f 636f 756e 7422 292c 0d0a 2020  , "_count"),..  
+00031c40: 2020 2020 2020 2020 2020 5f63 6f75 6e74            _count
+00031c50: 2c0d 0a20 2020 2020 2020 2029 0d0a 0d0a  ,..        )....
+00031c60: 2020 2020 2020 2020 6d65 616e 203d 205f          mean = _
+00031c70: 7375 6d20 2f20 5f63 6f75 6e74 0d0a 2020  sum / _count..  
+00031c80: 2020 2020 2020 7374 6420 3d20 285f 7373        std = (_ss
+00031c90: 7120 2f20 5f63 6f75 6e74 202d 206d 6561  q / _count - mea
+00031ca0: 6e2e 706f 7728 3229 292e 636c 616d 705f  n.pow(2)).clamp_
+00031cb0: 6d69 6e28 7365 6c66 2e65 7073 292e 7371  min(self.eps).sq
+00031cc0: 7274 2829 0d0a 2020 2020 2020 2020 7265  rt()..        re
+00031cd0: 7475 726e 2028 7661 6c75 6520 2d20 6d65  turn (value - me
+00031ce0: 616e 2920 2f20 7374 642e 636c 616d 705f  an) / std.clamp_
+00031cf0: 6d69 6e28 7365 6c66 2e65 7073 290d 0a0d  min(self.eps)...
+00031d00: 0a20 2020 2064 6566 2074 6f5f 6f62 7365  .    def to_obse
+00031d10: 7276 6174 696f 6e5f 6e6f 726d 2873 656c  rvation_norm(sel
+00031d20: 6629 202d 3e20 556e 696f 6e5b 436f 6d70  f) -> Union[Comp
+00031d30: 6f73 652c 204f 6273 6572 7661 7469 6f6e  ose, Observation
+00031d40: 4e6f 726d 5d3a 0d0a 2020 2020 2020 2020  Norm]:..        
+00031d50: 2222 2243 6f6e 7665 7274 7320 5665 634e  """Converts VecN
+00031d60: 6f72 6d20 696e 746f 2061 6e20 4f62 7365  orm into an Obse
+00031d70: 7276 6174 696f 6e4e 6f72 6d20 636c 6173  rvationNorm clas
+00031d80: 7320 7468 6174 2063 616e 2062 6520 7573  s that can be us
+00031d90: 6564 2061 7420 696e 6665 7265 6e63 6520  ed at inference 
+00031da0: 7469 6d65 2e22 2222 0d0a 2020 2020 2020  time."""..      
+00031db0: 2020 6f75 7420 3d20 5b5d 0d0a 2020 2020    out = []..    
+00031dc0: 2020 2020 666f 7220 6b65 7920 696e 2073      for key in s
+00031dd0: 656c 662e 696e 5f6b 6579 733a 0d0a 2020  elf.in_keys:..  
+00031de0: 2020 2020 2020 2020 2020 5f73 756d 203d            _sum =
+00031df0: 2073 656c 662e 5f74 642e 6765 7428 5f61   self._td.get(_a
+00031e00: 7070 656e 645f 6c61 7374 286b 6579 2c20  ppend_last(key, 
+00031e10: 225f 7375 6d22 2929 0d0a 2020 2020 2020  "_sum"))..      
+00031e20: 2020 2020 2020 5f73 7371 203d 2073 656c        _ssq = sel
+00031e30: 662e 5f74 642e 6765 7428 5f61 7070 656e  f._td.get(_appen
+00031e40: 645f 6c61 7374 286b 6579 2c20 225f 7373  d_last(key, "_ss
+00031e50: 7122 2929 0d0a 2020 2020 2020 2020 2020  q"))..          
+00031e60: 2020 5f63 6f75 6e74 203d 2073 656c 662e    _count = self.
+00031e70: 5f74 642e 6765 7428 5f61 7070 656e 645f  _td.get(_append_
+00031e80: 6c61 7374 286b 6579 2c20 225f 636f 756e  last(key, "_coun
+00031e90: 7422 2929 0d0a 2020 2020 2020 2020 2020  t"))..          
+00031ea0: 2020 6d65 616e 203d 205f 7375 6d20 2f20    mean = _sum / 
+00031eb0: 5f63 6f75 6e74 0d0a 2020 2020 2020 2020  _count..        
+00031ec0: 2020 2020 7374 6420 3d20 285f 7373 7120      std = (_ssq 
+00031ed0: 2f20 5f63 6f75 6e74 202d 206d 6561 6e2e  / _count - mean.
+00031ee0: 706f 7728 3229 292e 636c 616d 705f 6d69  pow(2)).clamp_mi
+00031ef0: 6e28 7365 6c66 2e65 7073 292e 7371 7274  n(self.eps).sqrt
+00031f00: 2829 0d0a 0d0a 2020 2020 2020 2020 2020  ()....          
+00031f10: 2020 5f6f 7574 203d 204f 6273 6572 7661    _out = Observa
+00031f20: 7469 6f6e 4e6f 726d 280d 0a20 2020 2020  tionNorm(..     
+00031f30: 2020 2020 2020 2020 2020 206c 6f63 3d6d             loc=m
+00031f40: 6561 6e2c 0d0a 2020 2020 2020 2020 2020  ean,..          
+00031f50: 2020 2020 2020 7363 616c 653d 7374 642c        scale=std,
+00031f60: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00031f70: 2020 7374 616e 6461 7264 5f6e 6f72 6d61    standard_norma
+00031f80: 6c3d 5472 7565 2c0d 0a20 2020 2020 2020  l=True,..       
+00031f90: 2020 2020 2020 2020 2069 6e5f 6b65 7973           in_keys
+00031fa0: 3d73 656c 662e 696e 5f6b 6579 732c 0d0a  =self.in_keys,..
+00031fb0: 2020 2020 2020 2020 2020 2020 290d 0a20              ).. 
+00031fc0: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
+00031fd0: 6e28 7365 6c66 2e69 6e5f 6b65 7973 2920  n(self.in_keys) 
+00031fe0: 3d3d 2031 3a0d 0a20 2020 2020 2020 2020  == 1:..         
+00031ff0: 2020 2020 2020 2072 6574 7572 6e20 5f6f         return _o
+00032000: 7574 0d0a 2020 2020 2020 2020 2020 2020  ut..            
+00032010: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
+00032020: 2020 2020 2020 206f 7574 202b 3d20 4f62         out += Ob
+00032030: 7365 7276 6174 696f 6e4e 6f72 6d0d 0a20  servationNorm.. 
+00032040: 2020 2020 2020 2072 6574 7572 6e20 436f         return Co
+00032050: 6d70 6f73 6528 2a6f 7574 290d 0a0d 0a20  mpose(*out).... 
+00032060: 2020 2040 7374 6174 6963 6d65 7468 6f64     @staticmethod
+00032070: 0d0a 2020 2020 6465 6620 6275 696c 645f  ..    def build_
+00032080: 7464 5f66 6f72 5f73 6861 7265 645f 7665  td_for_shared_ve
+00032090: 636e 6f72 6d28 0d0a 2020 2020 2020 2020  cnorm(..        
+000320a0: 656e 763a 2045 6e76 4261 7365 2c0d 0a20  env: EnvBase,.. 
+000320b0: 2020 2020 2020 206b 6579 733a 204f 7074         keys: Opt
+000320c0: 696f 6e61 6c5b 5365 7175 656e 6365 5b73  ional[Sequence[s
+000320d0: 7472 5d5d 203d 204e 6f6e 652c 0d0a 2020  tr]] = None,..  
+000320e0: 2020 2020 2020 6d65 6d6d 6170 3a20 626f        memmap: bo
+000320f0: 6f6c 203d 2046 616c 7365 2c0d 0a20 2020  ol = False,..   
+00032100: 2029 202d 3e20 5465 6e73 6f72 4469 6374   ) -> TensorDict
+00032110: 4261 7365 3a0d 0a20 2020 2020 2020 2022  Base:..        "
+00032120: 2222 4372 6561 7465 7320 6120 7368 6172  ""Creates a shar
+00032130: 6564 2074 656e 736f 7264 6963 7420 666f  ed tensordict fo
+00032140: 7220 6e6f 726d 616c 697a 6174 696f 6e20  r normalization 
+00032150: 6163 726f 7373 2070 726f 6365 7373 6573  across processes
+00032160: 2e0d 0a0d 0a20 2020 2020 2020 2041 7267  .....        Arg
+00032170: 733a 0d0a 2020 2020 2020 2020 2020 2020  s:..            
+00032180: 656e 7620 2845 6e76 4261 7365 293a 2065  env (EnvBase): e
+00032190: 7861 6d70 6c65 2065 6e76 6972 6f6e 6d65  xample environme
+000321a0: 6e74 2074 6f20 6265 2075 7365 6420 746f  nt to be used to
+000321b0: 2063 7265 6174 6520 7468 650d 0a20 2020   create the..   
+000321c0: 2020 2020 2020 2020 2020 2020 2074 656e               ten
+000321d0: 736f 7264 6963 740d 0a20 2020 2020 2020  sordict..       
+000321e0: 2020 2020 206b 6579 7320 2873 6571 7565       keys (seque
+000321f0: 6e63 6520 6f66 204e 6573 7465 644b 6579  nce of NestedKey
+00032200: 2c20 6f70 7469 6f6e 616c 293a 206b 6579  , optional): key
+00032210: 7320 7468 6174 0d0a 2020 2020 2020 2020  s that..        
+00032220: 2020 2020 2020 2020 6861 7665 2074 6f20          have to 
+00032230: 6265 206e 6f72 6d61 6c69 7a65 642e 2044  be normalized. D
+00032240: 6566 6175 6c74 2069 7320 605b 226e 6578  efault is `["nex
+00032250: 7422 2c20 2272 6577 6172 6422 5d60 0d0a  t", "reward"]`..
+00032260: 2020 2020 2020 2020 2020 2020 6d65 6d6d              memm
+00032270: 6170 2028 626f 6f6c 293a 2069 6620 6060  ap (bool): if ``
+00032280: 5472 7565 6060 2c20 7468 6520 7265 7375  True``, the resu
+00032290: 6c74 696e 6720 7465 6e73 6f72 6469 6374  lting tensordict
+000322a0: 2077 696c 6c20 6265 2063 6173 7420 696e   will be cast in
+000322b0: 746f 0d0a 2020 2020 2020 2020 2020 2020  to..            
+000322c0: 2020 2020 6d65 6d6d 6f72 7920 6d61 7020      memmory map 
+000322d0: 2875 7369 6e67 2060 6d65 6d6d 6170 5f28  (using `memmap_(
+000322e0: 2960 292e 204f 7468 6572 7769 7365 2c20  )`). Otherwise, 
+000322f0: 7468 6520 7465 6e73 6f72 6469 6374 0d0a  the tensordict..
+00032300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032310: 7769 6c6c 2062 6520 706c 6163 6564 2069  will be placed i
+00032320: 6e20 7368 6172 6564 206d 656d 6f72 792e  n shared memory.
+00032330: 0d0a 0d0a 2020 2020 2020 2020 5265 7475  ....        Retu
+00032340: 726e 733a 0d0a 2020 2020 2020 2020 2020  rns:..          
+00032350: 2020 4120 6d65 6d6f 7279 2069 6e20 7368    A memory in sh
+00032360: 6172 6564 206d 656d 6f72 7920 746f 2062  ared memory to b
+00032370: 6520 7365 6e74 2074 6f20 6561 6368 2070  e sent to each p
+00032380: 726f 6365 7373 2e0d 0a0d 0a20 2020 2020  rocess.....     
+00032390: 2020 2045 7861 6d70 6c65 733a 0d0a 2020     Examples:..  
+000323a0: 2020 2020 2020 2020 2020 3e3e 3e20 6672            >>> fr
+000323b0: 6f6d 2074 6f72 6368 2069 6d70 6f72 7420  om torch import 
+000323c0: 6d75 6c74 6970 726f 6365 7373 696e 6720  multiprocessing 
+000323d0: 6173 206d 700d 0a20 2020 2020 2020 2020  as mp..         
+000323e0: 2020 203e 3e3e 2071 7565 7565 203d 206d     >>> queue = m
+000323f0: 702e 5175 6575 6528 290d 0a20 2020 2020  p.Queue()..     
+00032400: 2020 2020 2020 203e 3e3e 2065 6e76 203d         >>> env =
+00032410: 206d 616b 655f 656e 7628 290d 0a20 2020   make_env()..   
+00032420: 2020 2020 2020 2020 203e 3e3e 2074 645f           >>> td_
+00032430: 7368 6172 6564 203d 2056 6563 4e6f 726d  shared = VecNorm
+00032440: 2e62 7569 6c64 5f74 645f 666f 725f 7368  .build_td_for_sh
+00032450: 6172 6564 5f76 6563 6e6f 726d 2865 6e76  ared_vecnorm(env
+00032460: 2c0d 0a20 2020 2020 2020 2020 2020 202e  ,..            .
+00032470: 2e2e 2020 2020 205b 226e 6578 7422 2c20  ..     ["next", 
+00032480: 2272 6577 6172 6422 5d29 0d0a 2020 2020  "reward"])..    
+00032490: 2020 2020 2020 2020 3e3e 3e20 6173 7365          >>> asse
+000324a0: 7274 2074 645f 7368 6172 6564 2e69 735f  rt td_shared.is_
+000324b0: 7368 6172 6564 2829 0d0a 2020 2020 2020  shared()..      
+000324c0: 2020 2020 2020 3e3e 3e20 7175 6575 652e        >>> queue.
+000324d0: 7075 7428 7464 5f73 6861 7265 6429 0d0a  put(td_shared)..
+000324e0: 2020 2020 2020 2020 2020 2020 3e3e 3e20              >>> 
+000324f0: 2320 6f6e 2077 6f72 6b65 7273 0d0a 2020  # on workers..  
+00032500: 2020 2020 2020 2020 2020 3e3e 3e20 7620            >>> v 
+00032510: 3d20 5665 634e 6f72 6d28 7368 6172 6564  = VecNorm(shared
+00032520: 5f74 643d 7175 6575 652e 6765 7428 2929  _td=queue.get())
+00032530: 0d0a 2020 2020 2020 2020 2020 2020 3e3e  ..            >>
+00032540: 3e20 656e 7620 3d20 5472 616e 7366 6f72  > env = Transfor
+00032550: 6d65 6445 6e76 286d 616b 655f 656e 7628  medEnv(make_env(
+00032560: 292c 2076 290d 0a0d 0a20 2020 2020 2020  ), v)....       
+00032570: 2022 2222 0d0a 2020 2020 2020 2020 7261   """..        ra
+00032580: 6973 6520 4e6f 7449 6d70 6c65 6d65 6e74  ise NotImplement
+00032590: 6564 4572 726f 7228 2274 6869 7320 6665  edError("this fe
+000325a0: 6174 7572 6520 6973 2063 7572 7265 6e74  ature is current
+000325b0: 6c79 2070 7574 206f 6e20 686f 6c64 2e22  ly put on hold."
+000325c0: 290d 0a20 2020 2020 2020 2073 6570 203d  )..        sep =
+000325d0: 2022 2e2d 7c2d 2e22 0d0a 2020 2020 2020   ".-|-."..      
+000325e0: 2020 6966 206b 6579 7320 6973 204e 6f6e    if keys is Non
+000325f0: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+00032600: 6b65 7973 203d 205b 226e 6578 7422 2c20  keys = ["next", 
+00032610: 2272 6577 6172 6422 5d0d 0a20 2020 2020  "reward"]..     
+00032620: 2020 2074 6420 3d20 6d61 6b65 5f74 656e     td = make_ten
+00032630: 736f 7264 6963 7428 656e 7629 0d0a 2020  sordict(env)..  
+00032640: 2020 2020 2020 6b65 7973 203d 207b 6b65        keys = {ke
+00032650: 7920 666f 7220 6b65 7920 696e 2074 642e  y for key in td.
+00032660: 6b65 7973 2829 2069 6620 6b65 7920 696e  keys() if key in
+00032670: 206b 6579 737d 0d0a 2020 2020 2020 2020   keys}..        
+00032680: 7464 5f73 656c 6563 7420 3d20 7464 2e73  td_select = td.s
+00032690: 656c 6563 7428 2a6b 6579 7329 0d0a 2020  elect(*keys)..  
+000326a0: 2020 2020 2020 7464 5f73 656c 6563 7420        td_select 
+000326b0: 3d20 7464 5f73 656c 6563 742e 666c 6174  = td_select.flat
+000326c0: 7465 6e5f 6b65 7973 2873 6570 290d 0a20  ten_keys(sep).. 
+000326d0: 2020 2020 2020 2069 6620 7464 2e62 6174         if td.bat
+000326e0: 6368 5f64 696d 733a 0d0a 2020 2020 2020  ch_dims:..      
+000326f0: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
+00032700: 696d 6545 7272 6f72 280d 0a20 2020 2020  imeError(..     
+00032710: 2020 2020 2020 2020 2020 2066 2256 6563             f"Vec
+00032720: 4e6f 726d 2073 686f 756c 6420 6265 2075  Norm should be u
+00032730: 7365 6420 7769 7468 206e 6f6e 2d62 6174  sed with non-bat
+00032740: 6368 6564 2065 6e76 6972 6f6e 6d65 6e74  ched environment
+00032750: 732e 2022 0d0a 2020 2020 2020 2020 2020  s. "..          
+00032760: 2020 2020 2020 6622 476f 7420 6261 7463        f"Got batc
+00032770: 685f 7369 7a65 3d7b 7464 2e62 6174 6368  h_size={td.batch
+00032780: 5f73 697a 657d 220d 0a20 2020 2020 2020  _size}"..       
+00032790: 2020 2020 2029 0d0a 2020 2020 2020 2020       )..        
+000327a0: 6b65 7973 203d 206c 6973 7428 7464 5f73  keys = list(td_s
+000327b0: 656c 6563 742e 6b65 7973 2829 290d 0a20  elect.keys()).. 
+000327c0: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
+000327d0: 6e20 6b65 7973 3a0d 0a20 2020 2020 2020  n keys:..       
+000327e0: 2020 2020 2074 645f 7365 6c65 6374 2e73       td_select.s
+000327f0: 6574 285f 6170 7065 6e64 5f6c 6173 7428  et(_append_last(
+00032800: 6b65 792c 2022 5f73 7371 2229 2c20 7464  key, "_ssq"), td
+00032810: 5f73 656c 6563 742e 6765 7428 6b65 7929  _select.get(key)
+00032820: 2e63 6c6f 6e65 2829 290d 0a20 2020 2020  .clone())..     
+00032830: 2020 2020 2020 2074 645f 7365 6c65 6374         td_select
+00032840: 2e73 6574 280d 0a20 2020 2020 2020 2020  .set(..         
+00032850: 2020 2020 2020 205f 6170 7065 6e64 5f6c         _append_l
+00032860: 6173 7428 6b65 792c 2022 5f63 6f75 6e74  ast(key, "_count
+00032870: 2229 2c0d 0a20 2020 2020 2020 2020 2020  "),..           
+00032880: 2020 2020 2074 6f72 6368 2e7a 6572 6f73       torch.zeros
+00032890: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
+000328a0: 2020 2020 2020 202a 7464 2e62 6174 6368         *td.batch
+000328b0: 5f73 697a 652c 0d0a 2020 2020 2020 2020  _size,..        
+000328c0: 2020 2020 2020 2020 2020 2020 312c 0d0a              1,..
+000328d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000328e0: 2020 2020 6465 7669 6365 3d74 645f 7365      device=td_se
+000328f0: 6c65 6374 2e64 6576 6963 652c 0d0a 2020  lect.device,..  
+00032900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032910: 2020 6474 7970 653d 746f 7263 682e 666c    dtype=torch.fl
+00032920: 6f61 742c 0d0a 2020 2020 2020 2020 2020  oat,..          
+00032930: 2020 2020 2020 292c 0d0a 2020 2020 2020        ),..      
+00032940: 2020 2020 2020 290d 0a20 2020 2020 2020        )..       
+00032950: 2020 2020 2074 645f 7365 6c65 6374 2e72       td_select.r
+00032960: 656e 616d 655f 6b65 795f 286b 6579 2c20  ename_key_(key, 
+00032970: 5f61 7070 656e 645f 6c61 7374 286b 6579  _append_last(key
+00032980: 2c20 225f 7375 6d22 2929 0d0a 2020 2020  , "_sum"))..    
+00032990: 2020 2020 7464 5f73 656c 6563 742e 6578      td_select.ex
+000329a0: 636c 7564 6528 2a6b 6579 7329 2e7a 6572  clude(*keys).zer
+000329b0: 6f5f 2829 0d0a 2020 2020 2020 2020 7464  o_()..        td
+000329c0: 5f73 656c 6563 7420 3d20 7464 5f73 656c  _select = td_sel
+000329d0: 6563 742e 756e 666c 6174 7465 6e5f 6b65  ect.unflatten_ke
+000329e0: 7973 2873 6570 290d 0a20 2020 2020 2020  ys(sep)..       
+000329f0: 2069 6620 6d65 6d6d 6170 3a0d 0a20 2020   if memmap:..   
+00032a00: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00032a10: 7464 5f73 656c 6563 742e 6d65 6d6d 6170  td_select.memmap
+00032a20: 5f28 290d 0a20 2020 2020 2020 2072 6574  _()..        ret
+00032a30: 7572 6e20 7464 5f73 656c 6563 742e 7368  urn td_select.sh
+00032a40: 6172 655f 6d65 6d6f 7279 5f28 290d 0a0d  are_memory_()...
+00032a50: 0a20 2020 2064 6566 2067 6574 5f65 7874  .    def get_ext
+00032a60: 7261 5f73 7461 7465 2873 656c 6629 202d  ra_state(self) -
+00032a70: 3e20 4f72 6465 7265 6444 6963 743a 0d0a  > OrderedDict:..
+00032a80: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+00032a90: 6f6c 6c65 6374 696f 6e73 2e4f 7264 6572  ollections.Order
+00032aa0: 6564 4469 6374 287b 226c 6f63 6b22 3a20  edDict({"lock": 
+00032ab0: 7365 6c66 2e6c 6f63 6b2c 2022 7464 223a  self.lock, "td":
+00032ac0: 2073 656c 662e 5f74 647d 290d 0a0d 0a20   self._td}).... 
+00032ad0: 2020 2064 6566 2073 6574 5f65 7874 7261     def set_extra
+00032ae0: 5f73 7461 7465 2873 656c 662c 2073 7461  _state(self, sta
+00032af0: 7465 3a20 4f72 6465 7265 6444 6963 7429  te: OrderedDict)
+00032b00: 202d 3e20 4e6f 6e65 3a0d 0a20 2020 2020   -> None:..     
+00032b10: 2020 206c 6f63 6b20 3d20 7374 6174 655b     lock = state[
+00032b20: 226c 6f63 6b22 5d0d 0a20 2020 2020 2020  "lock"]..       
+00032b30: 2069 6620 6c6f 636b 2069 7320 6e6f 7420   if lock is not 
+00032b40: 4e6f 6e65 3a0d 0a20 2020 2020 2020 2020  None:..         
+00032b50: 2020 2022 2222 0d0a 2020 2020 2020 2020     """..        
+00032b60: 2020 2020 7369 6e63 6520 6c6f 636b 7320      since locks 
+00032b70: 6361 6e27 7420 6265 2073 6572 6961 6c69  can't be seriali
+00032b80: 7a65 642c 2077 6520 6861 7665 2075 7365  zed, we have use
+00032b90: 2063 6173 6573 2066 6f72 2073 7472 6970   cases for strip
+00032ba0: 7069 6e67 2074 6865 6d0d 0a20 2020 2020  ping them..     
+00032bb0: 2020 2020 2020 2066 6f72 2065 7861 6d70         for examp
+00032bc0: 6c65 2069 6e20 5061 7261 6c6c 656c 456e  le in ParallelEn
+00032bd0: 762c 2069 6e20 7768 6963 6820 6361 7365  v, in which case
+00032be0: 206b 6565 7020 7468 6520 6c6f 636b 2077   keep the lock w
+00032bf0: 6520 616c 7265 6164 7920 6861 7665 0d0a  e already have..
+00032c00: 2020 2020 2020 2020 2020 2020 746f 2061              to a
+00032c10: 766f 6964 2061 6e20 7570 6461 7465 6420  void an updated 
+00032c20: 7465 6e73 6f72 2064 6963 7420 6265 696e  tensor dict bein
+00032c30: 6720 7365 6e74 2062 6574 7765 656e 2070  g sent between p
+00032c40: 726f 6365 7373 6573 2074 6f20 6572 6173  rocesses to eras
+00032c50: 6520 6c6f 636b 730d 0a20 2020 2020 2020  e locks..       
+00032c60: 2020 2020 2022 2222 0d0a 2020 2020 2020       """..      
+00032c70: 2020 2020 2020 7365 6c66 2e6c 6f63 6b20        self.lock 
+00032c80: 3d20 6c6f 636b 0d0a 2020 2020 2020 2020  = lock..        
+00032c90: 7464 203d 2073 7461 7465 5b22 7464 225d  td = state["td"]
+00032ca0: 0d0a 2020 2020 2020 2020 6966 2074 6420  ..        if td 
+00032cb0: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+00032cc0: 6e6f 7420 7464 2e69 735f 7368 6172 6564  not td.is_shared
+00032cd0: 2829 3a0d 0a20 2020 2020 2020 2020 2020  ():..           
+00032ce0: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
+00032cf0: 726f 7228 0d0a 2020 2020 2020 2020 2020  ror(..          
+00032d00: 2020 2020 2020 224f 6e6c 7920 7368 6172        "Only shar
+00032d10: 6564 2074 656e 736f 7264 6963 7473 2063  ed tensordicts c
+00032d20: 616e 2062 6520 7365 7420 696e 2056 6563  an be set in Vec
+00032d30: 4e6f 726d 2074 7261 6e73 666f 726d 7322  Norm transforms"
+00032d40: 0d0a 2020 2020 2020 2020 2020 2020 290d  ..            ).
+00032d50: 0a20 2020 2020 2020 2073 656c 662e 5f74  .        self._t
+00032d60: 6420 3d20 7464 0d0a 0d0a 2020 2020 6465  d = td....    de
+00032d70: 6620 5f5f 7265 7072 5f5f 2873 656c 6629  f __repr__(self)
+00032d80: 202d 3e20 7374 723a 0d0a 2020 2020 2020   -> str:..      
+00032d90: 2020 7265 7475 726e 2028 0d0a 2020 2020    return (..    
+00032da0: 2020 2020 2020 2020 6622 7b73 656c 662e          f"{self.
+00032db0: 5f5f 636c 6173 735f 5f2e 5f5f 6e61 6d65  __class__.__name
+00032dc0: 5f5f 7d28 6465 6361 793d 7b73 656c 662e  __}(decay={self.
+00032dd0: 6465 6361 793a 342e 3466 7d2c 220d 0a20  decay:4.4f},".. 
+00032de0: 2020 2020 2020 2020 2020 2066 2265 7073             f"eps
+00032df0: 3d7b 7365 6c66 2e65 7073 3a34 2e34 667d  ={self.eps:4.4f}
+00032e00: 2c20 6b65 7973 3d7b 7365 6c66 2e69 6e5f  , keys={self.in_
+00032e10: 6b65 7973 7d29 220d 0a20 2020 2020 2020  keys})"..       
+00032e20: 2029 0d0a 0d0a 2020 2020 6465 6620 5f5f   )....    def __
+00032e30: 6765 7473 7461 7465 5f5f 2873 656c 6629  getstate__(self)
+00032e40: 202d 3e20 4469 6374 5b73 7472 2c20 416e   -> Dict[str, An
+00032e50: 795d 3a0d 0a20 2020 2020 2020 2073 7461  y]:..        sta
+00032e60: 7465 203d 2073 656c 662e 5f5f 6469 6374  te = self.__dict
+00032e70: 5f5f 2e63 6f70 7928 290d 0a20 2020 2020  __.copy()..     
+00032e80: 2020 205f 6c6f 636b 203d 2073 7461 7465     _lock = state
+00032e90: 2e70 6f70 2822 6c6f 636b 222c 204e 6f6e  .pop("lock", Non
+00032ea0: 6529 0d0a 2020 2020 2020 2020 6966 205f  e)..        if _
+00032eb0: 6c6f 636b 2069 7320 6e6f 7420 4e6f 6e65  lock is not None
+00032ec0: 3a0d 0a20 2020 2020 2020 2020 2020 2073  :..            s
+00032ed0: 7461 7465 5b22 6c6f 636b 5f70 6c61 6365  tate["lock_place
+00032ee0: 686f 6c64 6572 225d 203d 204e 6f6e 650d  holder"] = None.
+00032ef0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00032f00: 7374 6174 650d 0a0d 0a20 2020 2064 6566  state....    def
+00032f10: 205f 5f73 6574 7374 6174 655f 5f28 7365   __setstate__(se
+00032f20: 6c66 2c20 7374 6174 653a 2044 6963 745b  lf, state: Dict[
+00032f30: 7374 722c 2041 6e79 5d29 3a0d 0a20 2020  str, Any]):..   
+00032f40: 2020 2020 2069 6620 226c 6f63 6b5f 706c       if "lock_pl
+00032f50: 6163 6568 6f6c 6465 7222 2069 6e20 7374  aceholder" in st
+00032f60: 6174 653a 0d0a 2020 2020 2020 2020 2020  ate:..          
+00032f70: 2020 7374 6174 652e 706f 7028 226c 6f63    state.pop("loc
+00032f80: 6b5f 706c 6163 6568 6f6c 6465 7222 290d  k_placeholder").
+00032f90: 0a20 2020 2020 2020 2020 2020 205f 6c6f  .            _lo
+00032fa0: 636b 203d 206d 702e 4c6f 636b 2829 0d0a  ck = mp.Lock()..
+00032fb0: 2020 2020 2020 2020 2020 2020 7374 6174              stat
+00032fc0: 655b 226c 6f63 6b22 5d20 3d20 5f6c 6f63  e["lock"] = _loc
+00032fd0: 6b0d 0a20 2020 2020 2020 2073 656c 662e  k..        self.
+00032fe0: 5f5f 6469 6374 5f5f 2e75 7064 6174 6528  __dict__.update(
+00032ff0: 7374 6174 6529 0d0a 0d0a 2020 2020 405f  state)....    @_
+00033000: 6170 706c 795f 746f 5f63 6f6d 706f 7369  apply_to_composi
+00033010: 7465 0d0a 2020 2020 6465 6620 7472 616e  te..    def tran
+00033020: 7366 6f72 6d5f 6f62 7365 7276 6174 696f  sform_observatio
+00033030: 6e5f 7370 6563 2873 656c 662c 206f 6273  n_spec(self, obs
+00033040: 6572 7661 7469 6f6e 5f73 7065 633a 2054  ervation_spec: T
+00033050: 656e 736f 7253 7065 6329 202d 3e20 5465  ensorSpec) -> Te
+00033060: 6e73 6f72 5370 6563 3a0d 0a20 2020 2020  nsorSpec:..     
+00033070: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+00033080: 286f 6273 6572 7661 7469 6f6e 5f73 7065  (observation_spe
+00033090: 632c 2042 6f75 6e64 6564 5465 6e73 6f72  c, BoundedTensor
+000330a0: 5370 6563 293a 0d0a 2020 2020 2020 2020  Spec):..        
+000330b0: 2020 2020 7265 7475 726e 2055 6e62 6f75      return Unbou
+000330c0: 6e64 6564 436f 6e74 696e 756f 7573 5465  ndedContinuousTe
+000330d0: 6e73 6f72 5370 6563 280d 0a20 2020 2020  nsorSpec(..     
+000330e0: 2020 2020 2020 2020 2020 2073 6861 7065             shape
+000330f0: 3d6f 6273 6572 7661 7469 6f6e 5f73 7065  =observation_spe
+00033100: 632e 7368 6170 652c 0d0a 2020 2020 2020  c.shape,..      
+00033110: 2020 2020 2020 2020 2020 6474 7970 653d            dtype=
+00033120: 6f62 7365 7276 6174 696f 6e5f 7370 6563  observation_spec
+00033130: 2e64 7479 7065 2c0d 0a20 2020 2020 2020  .dtype,..       
+00033140: 2020 2020 2020 2020 2064 6576 6963 653d           device=
+00033150: 6f62 7365 7276 6174 696f 6e5f 7370 6563  observation_spec
+00033160: 2e64 6576 6963 652c 0d0a 2020 2020 2020  .device,..      
+00033170: 2020 2020 2020 290d 0a20 2020 2020 2020        )..       
+00033180: 2072 6574 7572 6e20 6f62 7365 7276 6174   return observat
+00033190: 696f 6e5f 7370 6563 0d0a 0d0a 2020 2020  ion_spec....    
+000331a0: 2320 544f 444f 3a20 696e 636f 7270 6f72  # TODO: incorpor
+000331b0: 6174 6520 7468 6973 2077 6865 6e20 7472  ate this when tr
+000331c0: 6163 6b65 7273 2061 7265 2070 6172 7420  ackers are part 
+000331d0: 6f66 2074 6865 2064 6174 610d 0a20 2020  of the data..   
+000331e0: 2023 2064 6566 2074 7261 6e73 666f 726d   # def transform
+000331f0: 5f6f 7574 7075 745f 7370 6563 2873 656c  _output_spec(sel
+00033200: 662c 206f 7574 7075 745f 7370 6563 3a20  f, output_spec: 
+00033210: 5465 6e73 6f72 5370 6563 2920 2d3e 2054  TensorSpec) -> T
+00033220: 656e 736f 7253 7065 633a 0d0a 2020 2020  ensorSpec:..    
+00033230: 2320 2020 2020 6f62 7365 7276 6174 696f  #     observatio
+00033240: 6e5f 7370 6563 203d 206f 7574 7075 745f  n_spec = output_
+00033250: 7370 6563 5b22 6675 6c6c 5f6f 6273 6572  spec["full_obser
+00033260: 7661 7469 6f6e 5f73 7065 6322 5d0d 0a20  vation_spec"].. 
+00033270: 2020 2023 2020 2020 2072 6577 6172 645f     #     reward_
+00033280: 7370 6563 203d 206f 7574 7075 745f 7370  spec = output_sp
+00033290: 6563 5b22 6675 6c6c 5f72 6577 6172 645f  ec["full_reward_
+000332a0: 7370 6563 225d 0d0a 2020 2020 2320 2020  spec"]..    #   
+000332b0: 2020 666f 7220 6b65 7920 696e 206c 6973    for key in lis
+000332c0: 7428 6f62 7365 7276 6174 696f 6e5f 7370  t(observation_sp
+000332d0: 6563 2e6b 6579 7328 5472 7565 2c20 5472  ec.keys(True, Tr
+000332e0: 7565 2929 3a0d 0a20 2020 2023 2020 2020  ue)):..    #    
+000332f0: 2020 2020 2069 6620 6b65 7920 696e 2073       if key in s
+00033300: 656c 662e 696e 5f6b 6579 733a 0d0a 2020  elf.in_keys:..  
+00033310: 2020 2320 2020 2020 2020 2020 2020 2020    #             
+00033320: 6f62 7365 7276 6174 696f 6e5f 7370 6563  observation_spec
+00033330: 5b5f 6170 7065 6e64 5f6c 6173 7428 6b65  [_append_last(ke
+00033340: 792c 2022 5f73 756d 2229 5d20 3d20 6f62  y, "_sum")] = ob
+00033350: 7365 7276 6174 696f 6e5f 7370 6563 5b6b  servation_spec[k
+00033360: 6579 5d2e 636c 6f6e 6528 290d 0a20 2020  ey].clone()..   
+00033370: 2023 2020 2020 2020 2020 2020 2020 206f   #             o
+00033380: 6273 6572 7661 7469 6f6e 5f73 7065 635b  bservation_spec[
+00033390: 5f61 7070 656e 645f 6c61 7374 286b 6579  _append_last(key
+000333a0: 2c20 225f 7373 7122 295d 203d 206f 6273  , "_ssq")] = obs
+000333b0: 6572 7661 7469 6f6e 5f73 7065 635b 6b65  ervation_spec[ke
+000333c0: 795d 2e63 6c6f 6e65 2829 0d0a 2020 2020  y].clone()..    
+000333d0: 2320 2020 2020 2020 2020 2020 2020 6f62  #             ob
+000333e0: 7365 7276 6174 696f 6e5f 7370 6563 5b5f  servation_spec[_
+000333f0: 6170 7065 6e64 5f6c 6173 7428 6b65 792c  append_last(key,
+00033400: 2022 5f63 6f75 6e74 2229 5d20 3d20 6f62   "_count")] = ob
+00033410: 7365 7276 6174 696f 6e5f 7370 6563 5b6b  servation_spec[k
+00033420: 6579 5d2e 636c 6f6e 6528 290d 0a20 2020  ey].clone()..   
+00033430: 2023 2020 2020 2066 6f72 206b 6579 2069   #     for key i
+00033440: 6e20 6c69 7374 2872 6577 6172 645f 7370  n list(reward_sp
+00033450: 6563 2e6b 6579 7328 5472 7565 2c20 5472  ec.keys(True, Tr
+00033460: 7565 2929 3a0d 0a20 2020 2023 2020 2020  ue)):..    #    
+00033470: 2020 2020 2069 6620 6b65 7920 696e 2073       if key in s
+00033480: 656c 662e 696e 5f6b 6579 733a 0d0a 2020  elf.in_keys:..  
+00033490: 2020 2320 2020 2020 2020 2020 2020 2020    #             
+000334a0: 6f62 7365 7276 6174 696f 6e5f 7370 6563  observation_spec
+000334b0: 5b5f 6170 7065 6e64 5f6c 6173 7428 6b65  [_append_last(ke
+000334c0: 792c 2022 5f73 756d 2229 5d20 3d20 7265  y, "_sum")] = re
+000334d0: 7761 7264 5f73 7065 635b 6b65 795d 2e63  ward_spec[key].c
+000334e0: 6c6f 6e65 2829 0d0a 2020 2020 2320 2020  lone()..    #   
+000334f0: 2020 2020 2020 2020 2020 6f62 7365 7276            observ
+00033500: 6174 696f 6e5f 7370 6563 5b5f 6170 7065  ation_spec[_appe
+00033510: 6e64 5f6c 6173 7428 6b65 792c 2022 5f73  nd_last(key, "_s
+00033520: 7371 2229 5d20 3d20 7265 7761 7264 5f73  sq")] = reward_s
+00033530: 7065 635b 6b65 795d 2e63 6c6f 6e65 2829  pec[key].clone()
+00033540: 0d0a 2020 2020 2320 2020 2020 2020 2020  ..    #         
+00033550: 2020 2020 6f62 7365 7276 6174 696f 6e5f      observation_
+00033560: 7370 6563 5b5f 6170 7065 6e64 5f6c 6173  spec[_append_las
+00033570: 7428 6b65 792c 2022 5f63 6f75 6e74 2229  t(key, "_count")
+00033580: 5d20 3d20 7265 7761 7264 5f73 7065 635b  ] = reward_spec[
+00033590: 6b65 795d 2e63 6c6f 6e65 2829 0d0a 2020  key].clone()..  
+000335a0: 2020 2320 2020 2020 7265 7475 726e 206f    #     return o
+000335b0: 7574 7075 745f 7370 6563 0d0a 0d0a 0d0a  utput_spec......
+000335c0: 636c 6173 7320 5265 7761 7264 5375 6d28  class RewardSum(
+000335d0: 5472 616e 7366 6f72 6d29 3a0d 0a20 2020  Transform):..   
+000335e0: 2022 2222 5472 6163 6b73 2065 7069 736f   """Tracks episo
+000335f0: 6465 2063 756d 756c 6174 6976 6520 7265  de cumulative re
+00033600: 7761 7264 732e 0d0a 0d0a 2020 2020 5468  wards.....    Th
+00033610: 6973 2074 7261 6e73 666f 726d 2061 6363  is transform acc
+00033620: 6570 7473 2061 206c 6973 7420 6f66 2074  epts a list of t
+00033630: 656e 736f 7264 6963 7420 7265 7761 7264  ensordict reward
+00033640: 206b 6579 7320 2869 2e65 2e20 c2b4 696e   keys (i.e. ..in
+00033650: 5f6b 6579 73c2 b429 2061 6e64 2074 7261  _keys..) and tra
+00033660: 636b 7320 7468 6569 7220 6375 6d75 6c61  cks their cumula
+00033670: 7469 7665 0d0a 2020 2020 7661 6c75 6520  tive..    value 
+00033680: 616c 6f6e 6720 7468 6520 7469 6d65 2064  along the time d
+00033690: 696d 656e 7369 6f6e 2066 6f72 2065 6163  imension for eac
+000336a0: 6820 6570 6973 6f64 652e 0d0a 0d0a 2020  h episode.....  
+000336b0: 2020 5768 656e 2063 616c 6c65 642c 2074    When called, t
+000336c0: 6865 2074 7261 6e73 666f 726d 2077 7269  he transform wri
+000336d0: 7465 7320 6120 6e65 7720 7465 6e73 6f72  tes a new tensor
+000336e0: 6469 6374 2065 6e74 7279 2066 6f72 2065  dict entry for e
+000336f0: 6163 6820 6060 696e 5f6b 6579 6060 206e  ach ``in_key`` n
+00033700: 616d 6564 0d0a 2020 2020 6060 6570 6973  amed..    ``epis
+00033710: 6f64 655f 7b69 6e5f 6b65 797d 6060 2077  ode_{in_key}`` w
+00033720: 6865 7265 2074 6865 2063 756d 756c 6174  here the cumulat
+00033730: 6976 6520 7661 6c75 6573 2061 7265 2077  ive values are w
+00033740: 7269 7474 656e 2e0d 0a0d 0a20 2020 2041  ritten.....    A
+00033750: 7267 733a 0d0a 2020 2020 2020 2020 696e  rgs:..        in
+00033760: 5f6b 6579 7320 286c 6973 7420 6f66 204e  _keys (list of N
+00033770: 6573 7465 644b 6579 732c 206f 7074 696f  estedKeys, optio
+00033780: 6e61 6c29 3a20 496e 7075 7420 7265 7761  nal): Input rewa
+00033790: 7264 206b 6579 732e 0d0a 2020 2020 2020  rd keys...      
+000337a0: 2020 2020 2020 416c 6c20 c2b4 696e 5f6b        All ..in_k
+000337b0: 6579 73c2 b420 7368 6f75 6c64 2062 6520  eys.. should be 
+000337c0: 7061 7274 206f 6620 7468 6520 656e 7669  part of the envi
+000337d0: 726f 6e6d 656e 7420 7265 7761 7264 5f73  ronment reward_s
+000337e0: 7065 632e 0d0a 2020 2020 2020 2020 2020  pec...          
+000337f0: 2020 4966 206e 6f20 6060 696e 5f6b 6579    If no ``in_key
+00033800: 7360 6020 6172 6520 7370 6563 6966 6965  s`` are specifie
+00033810: 642c 2074 6869 7320 7472 616e 7366 6f72  d, this transfor
+00033820: 6d20 6173 7375 6d65 7320 6060 2272 6577  m assumes ``"rew
+00033830: 6172 6422 6060 2074 6f20 6265 2074 6865  ard"`` to be the
+00033840: 2069 6e70 7574 206b 6579 2e0d 0a20 2020   input key...   
+00033850: 2020 2020 2020 2020 2048 6f77 6576 6572           However
+00033860: 2c20 6d75 6c74 6970 6c65 2072 6577 6172  , multiple rewar
+00033870: 6473 2028 652e 672e 2060 6022 7265 7761  ds (e.g. ``"rewa
+00033880: 7264 3122 6060 2061 6e64 2060 6022 7265  rd1"`` and ``"re
+00033890: 7761 7264 3222 2260 6029 2063 616e 2061  ward2""``) can a
+000338a0: 6c73 6f20 6265 2073 7065 6369 6669 6564  lso be specified
+000338b0: 2e0d 0a20 2020 2020 2020 206f 7574 5f6b  ...        out_k
+000338c0: 6579 7320 286c 6973 7420 6f66 204e 6573  eys (list of Nes
+000338d0: 7465 644b 6579 732c 206f 7074 696f 6e61  tedKeys, optiona
+000338e0: 6c29 3a20 5468 6520 6f75 7470 7574 2073  l): The output s
+000338f0: 756d 206b 6579 732c 2073 686f 756c 6420  um keys, should 
+00033900: 6265 206f 6e65 2070 6572 2065 6163 6820  be one per each 
+00033910: 696e 7075 7420 6b65 792e 0d0a 2020 2020  input key...    
+00033920: 2020 2020 7265 7365 745f 6b65 7973 2028      reset_keys (
+00033930: 6c69 7374 206f 6620 4e65 7374 6564 4b65  list of NestedKe
+00033940: 7973 2c20 6f70 7469 6f6e 616c 293a 2074  ys, optional): t
+00033950: 6865 206c 6973 7420 6f66 2072 6573 6574  he list of reset
+00033960: 5f6b 6579 7320 746f 2062 650d 0a20 2020  _keys to be..   
+00033970: 2020 2020 2020 2020 2075 7365 642c 2069           used, i
+00033980: 6620 7468 6520 7061 7265 6e74 2065 6e76  f the parent env
+00033990: 6972 6f6e 6d65 6e74 2063 616e 6e6f 7420  ironment cannot 
+000339a0: 6265 2066 6f75 6e64 2e20 4966 2070 726f  be found. If pro
+000339b0: 7669 6465 642c 2074 6869 730d 0a20 2020  vided, this..   
+000339c0: 2020 2020 2020 2020 2076 616c 7565 2077           value w
+000339d0: 696c 6c20 7072 6576 6169 6c20 6f76 6572  ill prevail over
+000339e0: 2074 6865 2065 6e76 6972 6f6e 6d65 6e74   the environment
+000339f0: 2060 6072 6573 6574 5f6b 6579 7360 602e   ``reset_keys``.
+00033a00: 0d0a 0d0a 2020 2020 4b65 7977 6f72 6420  ....    Keyword 
+00033a10: 4172 6773 3a0d 0a20 2020 2020 2020 2072  Args:..        r
+00033a20: 6577 6172 645f 7370 6563 2028 626f 6f6c  eward_spec (bool
+00033a30: 2c20 6f70 7469 6f6e 616c 293a 2069 6620  , optional): if 
+00033a40: 6060 5472 7565 6060 2c20 7468 6520 6e65  ``True``, the ne
+00033a50: 7720 7265 7761 7264 2065 6e74 7279 2077  w reward entry w
+00033a60: 696c 6c20 6265 2072 6567 6973 7465 7265  ill be registere
+00033a70: 6420 696e 2074 6865 0d0a 2020 2020 2020  d in the..      
+00033a80: 2020 2020 2020 7265 7761 7264 2073 7065        reward spe
+00033a90: 6373 2e20 4465 6661 756c 7473 2074 6f20  cs. Defaults to 
+00033aa0: 6060 4661 6c73 6560 6020 2872 6567 6973  ``False`` (regis
+00033ab0: 7465 7265 6420 696e 2060 606f 6273 6572  tered in ``obser
+00033ac0: 7661 7469 6f6e 5f73 7065 6373 6060 292e  vation_specs``).
+00033ad0: 0d0a 0d0a 2020 2020 4578 616d 706c 6573  ....    Examples
+00033ae0: 3a0d 0a20 2020 2020 2020 203e 3e3e 2066  :..        >>> f
+00033af0: 726f 6d20 746f 7263 6872 6c2e 656e 7673  rom torchrl.envs
+00033b00: 2e74 7261 6e73 666f 726d 7320 696d 706f  .transforms impo
+00033b10: 7274 2052 6577 6172 6453 756d 2c20 5472  rt RewardSum, Tr
+00033b20: 616e 7366 6f72 6d65 6445 6e76 0d0a 2020  ansformedEnv..  
+00033b30: 2020 2020 2020 3e3e 3e20 6672 6f6d 2074        >>> from t
+00033b40: 6f72 6368 726c 2e65 6e76 732e 6c69 6273  orchrl.envs.libs
+00033b50: 2e67 796d 2069 6d70 6f72 7420 4779 6d45  .gym import GymE
+00033b60: 6e76 0d0a 2020 2020 2020 2020 3e3e 3e20  nv..        >>> 
+00033b70: 656e 7620 3d20 5472 616e 7366 6f72 6d65  env = Transforme
+00033b80: 6445 6e76 2847 796d 456e 7628 2243 6172  dEnv(GymEnv("Car
+00033b90: 7450 6f6c 652d 7631 2229 2c20 5265 7761  tPole-v1"), Rewa
+00033ba0: 7264 5375 6d28 2929 0d0a 2020 2020 2020  rdSum())..      
+00033bb0: 2020 3e3e 3e20 656e 762e 7365 745f 7365    >>> env.set_se
+00033bc0: 6564 2830 290d 0a20 2020 2020 2020 203e  ed(0)..        >
+00033bd0: 3e3e 2074 6f72 6368 2e6d 616e 7561 6c5f  >> torch.manual_
+00033be0: 7365 6564 2830 290d 0a20 2020 2020 2020  seed(0)..       
+00033bf0: 203e 3e3e 2074 6420 3d20 656e 762e 7265   >>> td = env.re
+00033c00: 7365 7428 290d 0a20 2020 2020 2020 203e  set()..        >
+00033c10: 3e3e 2070 7269 6e74 2874 645b 2265 7069  >> print(td["epi
+00033c20: 736f 6465 5f72 6577 6172 6422 5d29 0d0a  sode_reward"])..
+00033c30: 2020 2020 2020 2020 7465 6e73 6f72 285b          tensor([
+00033c40: 302e 5d29 0d0a 2020 2020 2020 2020 3e3e  0.])..        >>
+00033c50: 3e20 7464 203d 2065 6e76 2e72 6f6c 6c6f  > td = env.rollo
+00033c60: 7574 2833 290d 0a20 2020 2020 2020 203e  ut(3)..        >
+00033c70: 3e3e 2070 7269 6e74 2874 645b 226e 6578  >> print(td["nex
+00033c80: 7422 2c20 2265 7069 736f 6465 5f72 6577  t", "episode_rew
+00033c90: 6172 6422 5d29 0d0a 2020 2020 2020 2020  ard"])..        
+00033ca0: 7465 6e73 6f72 285b 5b31 2e5d 2c0d 0a20  tensor([[1.],.. 
+00033cb0: 2020 2020 2020 2020 2020 2020 2020 205b                 [
+00033cc0: 322e 5d2c 0d0a 2020 2020 2020 2020 2020  2.],..          
+00033cd0: 2020 2020 2020 5b33 2e5d 5d29 0d0a 2020        [3.]])..  
+00033ce0: 2020 2222 220d 0a0d 0a20 2020 2064 6566    """....    def
+00033cf0: 205f 5f69 6e69 745f 5f28 0d0a 2020 2020   __init__(..    
+00033d00: 2020 2020 7365 6c66 2c0d 0a20 2020 2020      self,..     
+00033d10: 2020 2069 6e5f 6b65 7973 3a20 5365 7175     in_keys: Sequ
+00033d20: 656e 6365 5b4e 6573 7465 644b 6579 5d20  ence[NestedKey] 
+00033d30: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0d0a  | None = None,..
+00033d40: 2020 2020 2020 2020 6f75 745f 6b65 7973          out_keys
+00033d50: 3a20 5365 7175 656e 6365 5b4e 6573 7465  : Sequence[Neste
+00033d60: 644b 6579 5d20 7c20 4e6f 6e65 203d 204e  dKey] | None = N
+00033d70: 6f6e 652c 0d0a 2020 2020 2020 2020 7265  one,..        re
+00033d80: 7365 745f 6b65 7973 3a20 5365 7175 656e  set_keys: Sequen
+00033d90: 6365 5b4e 6573 7465 644b 6579 5d20 7c20  ce[NestedKey] | 
+00033da0: 4e6f 6e65 203d 204e 6f6e 652c 0d0a 2020  None = None,..  
+00033db0: 2020 2020 2020 2a2c 0d0a 2020 2020 2020        *,..      
+00033dc0: 2020 7265 7761 7264 5f73 7065 633a 2062    reward_spec: b
+00033dd0: 6f6f 6c20 3d20 4661 6c73 652c 0d0a 2020  ool = False,..  
+00033de0: 2020 293a 0d0a 2020 2020 2020 2020 2222    ):..        ""
+00033df0: 2249 6e69 7469 616c 6973 6573 2074 6865  "Initialises the
+00033e00: 2074 7261 6e73 666f 726d 2e20 4669 6c74   transform. Filt
+00033e10: 6572 7320 6f75 7420 6e6f 6e2d 7265 7761  ers out non-rewa
+00033e20: 7264 2069 6e70 7574 206b 6579 7320 616e  rd input keys an
+00033e30: 6420 6465 6669 6e65 7320 6f75 7470 7574  d defines output
+00033e40: 206b 6579 732e 2222 220d 0a20 2020 2020   keys."""..     
+00033e50: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
+00033e60: 745f 5f28 696e 5f6b 6579 733d 696e 5f6b  t__(in_keys=in_k
+00033e70: 6579 732c 206f 7574 5f6b 6579 733d 6f75  eys, out_keys=ou
+00033e80: 745f 6b65 7973 290d 0a20 2020 2020 2020  t_keys)..       
+00033e90: 2073 656c 662e 5f72 6573 6574 5f6b 6579   self._reset_key
+00033ea0: 7320 3d20 7265 7365 745f 6b65 7973 0d0a  s = reset_keys..
+00033eb0: 2020 2020 2020 2020 7365 6c66 2e5f 6b65          self._ke
+00033ec0: 7973 5f63 6865 636b 6564 203d 2046 616c  ys_checked = Fal
+00033ed0: 7365 0d0a 2020 2020 2020 2020 7365 6c66  se..        self
+00033ee0: 2e72 6577 6172 645f 7370 6563 203d 2072  .reward_spec = r
+00033ef0: 6577 6172 645f 7370 6563 0d0a 0d0a 2020  eward_spec....  
+00033f00: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
+00033f10: 2064 6566 2069 6e5f 6b65 7973 2873 656c   def in_keys(sel
+00033f20: 6629 3a0d 0a20 2020 2020 2020 2069 6e5f  f):..        in_
+00033f30: 6b65 7973 203d 2073 656c 662e 5f5f 6469  keys = self.__di
+00033f40: 6374 5f5f 2e67 6574 2822 5f69 6e5f 6b65  ct__.get("_in_ke
+00033f50: 7973 222c 204e 6f6e 6529 0d0a 2020 2020  ys", None)..    
+00033f60: 2020 2020 6966 2069 6e5f 6b65 7973 2069      if in_keys i
+00033f70: 6e20 284e 6f6e 652c 205b 5d29 3a0d 0a20  n (None, []):.. 
+00033f80: 2020 2020 2020 2020 2020 2023 2072 6574             # ret
+00033f90: 7269 6576 6520 7265 7761 7264 7320 6672  rieve rewards fr
+00033fa0: 6f6d 2070 6172 656e 7420 656e 760d 0a20  om parent env.. 
+00033fb0: 2020 2020 2020 2020 2020 2070 6172 656e             paren
+00033fc0: 7420 3d20 7365 6c66 2e70 6172 656e 740d  t = self.parent.
+00033fd0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00033fe0: 7061 7265 6e74 2069 7320 4e6f 6e65 3a0d  parent is None:.
+00033ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034000: 2069 6e5f 6b65 7973 203d 205b 2272 6577   in_keys = ["rew
+00034010: 6172 6422 5d0d 0a20 2020 2020 2020 2020  ard"]..         
+00034020: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
+00034030: 2020 2020 2020 2020 2020 696e 5f6b 6579            in_key
+00034040: 7320 3d20 636f 7079 2870 6172 656e 742e  s = copy(parent.
+00034050: 7265 7761 7264 5f6b 6579 7329 0d0a 2020  reward_keys)..  
+00034060: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00034070: 696e 5f6b 6579 7320 3d20 696e 5f6b 6579  in_keys = in_key
+00034080: 730d 0a20 2020 2020 2020 2072 6574 7572  s..        retur
+00034090: 6e20 696e 5f6b 6579 730d 0a0d 0a20 2020  n in_keys....   
+000340a0: 2040 696e 5f6b 6579 732e 7365 7474 6572   @in_keys.setter
+000340b0: 0d0a 2020 2020 6465 6620 696e 5f6b 6579  ..    def in_key
+000340c0: 7328 7365 6c66 2c20 7661 6c75 6529 3a0d  s(self, value):.
+000340d0: 0a20 2020 2020 2020 2069 6620 7661 6c75  .        if valu
+000340e0: 6520 6973 206e 6f74 204e 6f6e 653a 0d0a  e is not None:..
+000340f0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+00034100: 7369 6e73 7461 6e63 6528 7661 6c75 652c  sinstance(value,
+00034110: 2028 7374 722c 2074 7570 6c65 2929 3a0d   (str, tuple)):.
+00034120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034130: 2076 616c 7565 203d 205b 7661 6c75 655d   value = [value]
+00034140: 0d0a 2020 2020 2020 2020 2020 2020 7661  ..            va
+00034150: 6c75 6520 3d20 5b75 6e72 6176 656c 5f6b  lue = [unravel_k
+00034160: 6579 2876 616c 2920 666f 7220 7661 6c20  ey(val) for val 
+00034170: 696e 2076 616c 7565 5d0d 0a20 2020 2020  in value]..     
+00034180: 2020 2073 656c 662e 5f69 6e5f 6b65 7973     self._in_keys
+00034190: 203d 2076 616c 7565 0d0a 0d0a 2020 2020   = value....    
+000341a0: 4070 726f 7065 7274 790d 0a20 2020 2064  @property..    d
+000341b0: 6566 206f 7574 5f6b 6579 7328 7365 6c66  ef out_keys(self
+000341c0: 293a 0d0a 2020 2020 2020 2020 6f75 745f  ):..        out_
+000341d0: 6b65 7973 203d 2073 656c 662e 5f5f 6469  keys = self.__di
+000341e0: 6374 5f5f 2e67 6574 2822 5f6f 7574 5f6b  ct__.get("_out_k
+000341f0: 6579 7322 2c20 4e6f 6e65 290d 0a20 2020  eys", None)..   
+00034200: 2020 2020 2069 6620 6f75 745f 6b65 7973       if out_keys
+00034210: 2069 6e20 284e 6f6e 652c 205b 5d29 3a0d   in (None, []):.
+00034220: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+00034230: 5f6b 6579 7320 3d20 5b0d 0a20 2020 2020  _keys = [..     
+00034240: 2020 2020 2020 2020 2020 205f 7265 706c             _repl
+00034250: 6163 655f 6c61 7374 2869 6e5f 6b65 792c  ace_last(in_key,
+00034260: 2066 2265 7069 736f 6465 5f7b 5f75 6e72   f"episode_{_unr
+00034270: 6176 656c 5f6b 6579 5f74 6f5f 7475 706c  avel_key_to_tupl
+00034280: 6528 696e 5f6b 6579 295b 2d31 5d7d 2229  e(in_key)[-1]}")
+00034290: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000342a0: 2020 666f 7220 696e 5f6b 6579 2069 6e20    for in_key in 
+000342b0: 7365 6c66 2e69 6e5f 6b65 7973 0d0a 2020  self.in_keys..  
+000342c0: 2020 2020 2020 2020 2020 5d0d 0a20 2020            ]..   
+000342d0: 2020 2020 2020 2020 2073 656c 662e 5f6f           self._o
+000342e0: 7574 5f6b 6579 7320 3d20 6f75 745f 6b65  ut_keys = out_ke
+000342f0: 7973 0d0a 2020 2020 2020 2020 7265 7475  ys..        retu
+00034300: 726e 206f 7574 5f6b 6579 730d 0a0d 0a20  rn out_keys.... 
+00034310: 2020 2040 6f75 745f 6b65 7973 2e73 6574     @out_keys.set
+00034320: 7465 720d 0a20 2020 2064 6566 206f 7574  ter..    def out
+00034330: 5f6b 6579 7328 7365 6c66 2c20 7661 6c75  _keys(self, valu
+00034340: 6529 3a0d 0a20 2020 2020 2020 2023 2077  e):..        # w
+00034350: 6520 6d75 7374 2061 6363 6573 7320 7468  e must access th
+00034360: 6520 7072 6976 6174 6520 6174 7472 6962  e private attrib
+00034370: 7574 6520 6265 6361 7573 6520 7468 6973  ute because this
+00034380: 2063 6865 636b 206f 6363 7572 7320 6265   check occurs be
+00034390: 666f 7265 0d0a 2020 2020 2020 2020 2320  fore..        # 
+000343a0: 7468 6520 7061 7265 6e74 2065 6e76 2069  the parent env i
+000343b0: 7320 6465 6669 6e65 640d 0a20 2020 2020  s defined..     
+000343c0: 2020 2069 6620 7661 6c75 6520 6973 206e     if value is n
+000343d0: 6f74 204e 6f6e 6520 616e 6420 6c65 6e28  ot None and len(
+000343e0: 7365 6c66 2e5f 696e 5f6b 6579 7329 2021  self._in_keys) !
+000343f0: 3d20 6c65 6e28 7661 6c75 6529 3a0d 0a20  = len(value):.. 
+00034400: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00034410: 2056 616c 7565 4572 726f 7228 0d0a 2020   ValueError(..  
+00034420: 2020 2020 2020 2020 2020 2020 2020 2252                "R
+00034430: 6577 6172 6453 756d 2065 7870 6563 7473  ewardSum expects
+00034440: 2074 6865 2073 616d 6520 6e75 6d62 6572   the same number
+00034450: 206f 6620 696e 7075 7420 616e 6420 6f75   of input and ou
+00034460: 7470 7574 206b 6579 7322 0d0a 2020 2020  tput keys"..    
+00034470: 2020 2020 2020 2020 290d 0a20 2020 2020          )..     
+00034480: 2020 2069 6620 7661 6c75 6520 6973 206e     if value is n
+00034490: 6f74 204e 6f6e 653a 0d0a 2020 2020 2020  ot None:..      
+000344a0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+000344b0: 6e63 6528 7661 6c75 652c 2028 7374 722c  nce(value, (str,
+000344c0: 2074 7570 6c65 2929 3a0d 0a20 2020 2020   tuple)):..     
+000344d0: 2020 2020 2020 2020 2020 2076 616c 7565             value
+000344e0: 203d 205b 7661 6c75 655d 0d0a 2020 2020   = [value]..    
+000344f0: 2020 2020 2020 2020 7661 6c75 6520 3d20          value = 
+00034500: 5b75 6e72 6176 656c 5f6b 6579 2876 616c  [unravel_key(val
+00034510: 2920 666f 7220 7661 6c20 696e 2076 616c  ) for val in val
+00034520: 7565 5d0d 0a20 2020 2020 2020 2073 656c  ue]..        sel
+00034530: 662e 5f6f 7574 5f6b 6579 7320 3d20 7661  f._out_keys = va
+00034540: 6c75 650d 0a0d 0a20 2020 2040 7072 6f70  lue....    @prop
+00034550: 6572 7479 0d0a 2020 2020 6465 6620 7265  erty..    def re
+00034560: 7365 745f 6b65 7973 2873 656c 6629 3a0d  set_keys(self):.
+00034570: 0a20 2020 2020 2020 2072 6573 6574 5f6b  .        reset_k
+00034580: 6579 7320 3d20 7365 6c66 2e5f 5f64 6963  eys = self.__dic
+00034590: 745f 5f2e 6765 7428 225f 7265 7365 745f  t__.get("_reset_
+000345a0: 6b65 7973 222c 204e 6f6e 6529 0d0a 2020  keys", None)..  
+000345b0: 2020 2020 2020 6966 2072 6573 6574 5f6b        if reset_k
+000345c0: 6579 7320 6973 204e 6f6e 653a 0d0a 2020  eys is None:..  
+000345d0: 2020 2020 2020 2020 2020 7061 7265 6e74            parent
+000345e0: 203d 2073 656c 662e 7061 7265 6e74 0d0a   = self.parent..
+000345f0: 2020 2020 2020 2020 2020 2020 6966 2070              if p
+00034600: 6172 656e 7420 6973 204e 6f6e 653a 0d0a  arent is None:..
+00034610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034620: 7261 6973 6520 5479 7065 4572 726f 7228  raise TypeError(
+00034630: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00034640: 2020 2020 2020 2272 6573 6574 5f6b 6579        "reset_key
+00034650: 7320 6e6f 7420 7072 6f76 6964 6564 2062  s not provided b
+00034660: 7574 2070 6172 656e 7420 656e 7620 6e6f  ut parent env no
+00034670: 7420 666f 756e 642e 2022 0d0a 2020 2020  t found. "..    
+00034680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034690: 224d 616b 6520 7375 7265 2074 6861 7420  "Make sure that 
+000346a0: 7468 6520 7265 7365 745f 6b65 7973 2061  the reset_keys a
+000346b0: 7265 2070 726f 7669 6465 6420 6475 7269  re provided duri
+000346c0: 6e67 2022 0d0a 2020 2020 2020 2020 2020  ng "..          
+000346d0: 2020 2020 2020 2020 2020 2263 6f6e 7374            "const
+000346e0: 7275 6374 696f 6e20 6966 2074 6865 2074  ruction if the t
+000346f0: 7261 6e73 666f 726d 2064 6f65 7320 6e6f  ransform does no
+00034700: 7420 6861 7665 2061 2063 6f6e 7461 696e  t have a contain
+00034710: 6572 2065 6e76 2e22 0d0a 2020 2020 2020  er env."..      
+00034720: 2020 2020 2020 2020 2020 290d 0a20 2020            )..   
+00034730: 2020 2020 2020 2020 2023 206c 6574 2773           # let's
+00034740: 2074 7279 2074 6f20 6d61 7463 6820 7468   try to match th
+00034750: 6520 7265 7365 7420 6b65 7973 2077 6974  e reset keys wit
+00034760: 6820 7468 6520 696e 5f6b 6579 732e 0d0a  h the in_keys...
+00034770: 2020 2020 2020 2020 2020 2020 2320 5765              # We
+00034780: 2074 616b 6520 7468 6520 6669 6c74 6572   take the filter
+00034790: 6564 2072 6573 6574 206b 6579 732c 2077  ed reset keys, w
+000347a0: 6869 6368 2061 7265 2074 6865 206f 6e6c  hich are the onl
+000347b0: 7920 6b65 7973 2074 6861 7420 7265 616c  y keys that real
+000347c0: 6c79 0d0a 2020 2020 2020 2020 2020 2020  ly..            
+000347d0: 2320 6d61 7474 6572 2077 6865 6e20 6361  # matter when ca
+000347e0: 6c6c 696e 6720 7265 7365 742c 2061 6e64  lling reset, and
+000347f0: 2063 6865 636b 2074 6861 7420 7468 6579   check that they
+00034800: 206d 6174 6368 2074 6865 2069 6e5f 6b65   match the in_ke
+00034810: 7973 2072 6f6f 742e 0d0a 2020 2020 2020  ys root...      
+00034820: 2020 2020 2020 7265 7365 745f 6b65 7973        reset_keys
+00034830: 203d 2070 6172 656e 742e 5f66 696c 7465   = parent._filte
+00034840: 7265 645f 7265 7365 745f 6b65 7973 0d0a  red_reset_keys..
+00034850: 0d0a 2020 2020 2020 2020 2020 2020 6465  ..            de
+00034860: 6620 5f63 6865 636b 5f6d 6174 6368 2872  f _check_match(r
+00034870: 6573 6574 5f6b 6579 732c 2069 6e5f 6b65  eset_keys, in_ke
+00034880: 7973 293a 0d0a 2020 2020 2020 2020 2020  ys):..          
+00034890: 2020 2020 2020 2320 6966 2074 6869 7320        # if this 
+000348a0: 6973 2063 616c 6c65 642c 2074 6865 206c  is called, the l
+000348b0: 656e 6774 6820 6f66 2072 6573 6574 5f6b  ength of reset_k
+000348c0: 6579 7320 616e 6420 696e 5f6b 6579 7320  eys and in_keys 
+000348d0: 6d75 7374 206d 6174 6368 0d0a 2020 2020  must match..    
+000348e0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000348f0: 7265 7365 745f 6b65 792c 2069 6e5f 6b65  reset_key, in_ke
+00034900: 7920 696e 207a 6970 2872 6573 6574 5f6b  y in zip(reset_k
+00034910: 6579 732c 2069 6e5f 6b65 7973 293a 0d0a  eys, in_keys):..
+00034920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034930: 2020 2020 2320 6861 7669 6e67 205f 7265      # having _re
+00034940: 7365 7420 6174 2074 6865 2072 6f6f 7420  set at the root 
+00034950: 616e 6420 7468 6520 7265 7761 7264 5f6b  and the reward_k
+00034960: 6579 2028 2261 6765 6e74 222c 2022 7265  ey ("agent", "re
+00034970: 7761 7264 2229 2069 7320 616c 6c6f 7765  ward") is allowe
+00034980: 640d 0a20 2020 2020 2020 2020 2020 2020  d..             
+00034990: 2020 2020 2020 2023 2062 7574 2068 6176         # but hav
+000349a0: 696e 6720 2822 6167 656e 7422 2c20 225f  ing ("agent", "_
+000349b0: 7265 7365 7422 2920 616e 6420 2272 6577  reset") and "rew
+000349c0: 6172 6422 2069 736e 2774 0d0a 2020 2020  ard" isn't..    
+000349d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000349e0: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
+000349f0: 7365 745f 6b65 792c 2074 7570 6c65 2920  set_key, tuple) 
+00034a00: 616e 6420 6973 696e 7374 616e 6365 2869  and isinstance(i
+00034a10: 6e5f 6b65 792c 2073 7472 293a 0d0a 2020  n_key, str):..  
+00034a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034a30: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
+00034a40: 7365 0d0a 2020 2020 2020 2020 2020 2020  se..            
+00034a50: 2020 2020 2020 2020 6966 2028 0d0a 2020          if (..  
+00034a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034a70: 2020 2020 2020 6973 696e 7374 616e 6365        isinstance
+00034a80: 2872 6573 6574 5f6b 6579 2c20 7475 706c  (reset_key, tupl
+00034a90: 6529 0d0a 2020 2020 2020 2020 2020 2020  e)..            
+00034aa0: 2020 2020 2020 2020 2020 2020 616e 6420              and 
+00034ab0: 6973 696e 7374 616e 6365 2869 6e5f 6b65  isinstance(in_ke
+00034ac0: 792c 2074 7570 6c65 290d 0a20 2020 2020  y, tuple)..     
+00034ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034ae0: 2020 2061 6e64 2069 6e5f 6b65 795b 3a20     and in_key[: 
+00034af0: 286c 656e 2872 6573 6574 5f6b 6579 2920  (len(reset_key) 
+00034b00: 2d20 3129 5d20 213d 2072 6573 6574 5f6b  - 1)] != reset_k
+00034b10: 6579 5b3a 2d31 5d0d 0a20 2020 2020 2020  ey[:-1]..       
+00034b20: 2020 2020 2020 2020 2020 2020 2029 3a0d               ):.
+00034b30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034b40: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00034b50: 4661 6c73 650d 0a20 2020 2020 2020 2020  False..         
+00034b60: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
+00034b70: 7565 0d0a 0d0a 2020 2020 2020 2020 2020  ue....          
+00034b80: 2020 6966 206e 6f74 205f 6368 6563 6b5f    if not _check_
+00034b90: 6d61 7463 6828 7265 7365 745f 6b65 7973  match(reset_keys
+00034ba0: 2c20 7365 6c66 2e69 6e5f 6b65 7973 293a  , self.in_keys):
+00034bb0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00034bc0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00034bd0: 6f72 280d 0a20 2020 2020 2020 2020 2020  or(..           
+00034be0: 2020 2020 2020 2020 2066 2243 6f75 6c64           f"Could
+00034bf0: 206e 6f74 206d 6174 6368 2074 6865 2065   not match the e
+00034c00: 6e76 2072 6573 6574 5f6b 6579 7320 7b72  nv reset_keys {r
+00034c10: 6573 6574 5f6b 6579 737d 2077 6974 6820  eset_keys} with 
+00034c20: 7468 6520 7b74 7970 6528 7365 6c66 297d  the {type(self)}
+00034c30: 2069 6e5f 6b65 7973 207b 7365 6c66 2e69   in_keys {self.i
+00034c40: 6e5f 6b65 7973 7d2e 2022 0d0a 2020 2020  n_keys}. "..    
+00034c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034c60: 6622 506c 6561 7365 2070 726f 7669 6465  f"Please provide
+00034c70: 2074 6865 2072 6573 6574 5f6b 6579 7320   the reset_keys 
+00034c80: 6d61 6e75 616c 6c79 2e20 5265 7365 7420  manually. Reset 
+00034c90: 656e 7472 6965 7320 6361 6e20 6265 2022  entries can be "
+00034ca0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00034cb0: 2020 2020 2020 6622 6e6f 6e2d 756e 6971        f"non-uniq
+00034cc0: 7565 2061 6e64 206d 7573 7420 6265 2072  ue and must be r
+00034cd0: 6967 6874 2d65 7870 616e 6461 626c 6520  ight-expandable 
+00034ce0: 746f 2074 6865 2073 6861 7065 206f 6620  to the shape of 
+00034cf0: 220d 0a20 2020 2020 2020 2020 2020 2020  "..             
+00034d00: 2020 2020 2020 2066 2274 6865 2069 6e70         f"the inp
+00034d10: 7574 2065 6e74 7269 6573 2e22 0d0a 2020  ut entries."..  
+00034d20: 2020 2020 2020 2020 2020 2020 2020 290d                ).
+00034d30: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+00034d40: 6574 5f6b 6579 7320 3d20 636f 7079 2872  et_keys = copy(r
+00034d50: 6573 6574 5f6b 6579 7329 0d0a 2020 2020  eset_keys)..    
+00034d60: 2020 2020 2020 2020 7365 6c66 2e5f 7265          self._re
+00034d70: 7365 745f 6b65 7973 203d 2072 6573 6574  set_keys = reset
+00034d80: 5f6b 6579 730d 0a0d 0a20 2020 2020 2020  _keys....       
+00034d90: 2069 6620 6e6f 7420 7365 6c66 2e5f 6b65   if not self._ke
+00034da0: 7973 5f63 6865 636b 6564 2061 6e64 206c  ys_checked and l
+00034db0: 656e 2872 6573 6574 5f6b 6579 7329 2021  en(reset_keys) !
+00034dc0: 3d20 6c65 6e28 7365 6c66 2e69 6e5f 6b65  = len(self.in_ke
+00034dd0: 7973 293a 0d0a 2020 2020 2020 2020 2020  ys):..          
+00034de0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00034df0: 6f72 280d 0a20 2020 2020 2020 2020 2020  or(..           
+00034e00: 2020 2020 2066 2243 6f75 6c64 206e 6f74       f"Could not
+00034e10: 206d 6174 6368 2074 6865 2065 6e76 2072   match the env r
+00034e20: 6573 6574 5f6b 6579 7320 7b72 6573 6574  eset_keys {reset
+00034e30: 5f6b 6579 737d 2077 6974 6820 7468 6520  _keys} with the 
+00034e40: 696e 5f6b 6579 7320 7b73 656c 662e 696e  in_keys {self.in
+00034e50: 5f6b 6579 737d 2e20 220d 0a20 2020 2020  _keys}. "..     
+00034e60: 2020 2020 2020 2020 2020 2022 506c 6561             "Plea
+00034e70: 7365 206d 616b 6520 7375 7265 2074 6861  se make sure tha
+00034e80: 7420 7468 6573 6520 6861 7665 2074 6865  t these have the
+00034e90: 2073 616d 6520 6c65 6e67 7468 2e22 0d0a   same length."..
+00034ea0: 2020 2020 2020 2020 2020 2020 290d 0a20              ).. 
+00034eb0: 2020 2020 2020 2073 656c 662e 5f6b 6579         self._key
+00034ec0: 735f 6368 6563 6b65 6420 3d20 5472 7565  s_checked = True
+00034ed0: 0d0a 0d0a 2020 2020 2020 2020 7265 7475  ....        retu
+00034ee0: 726e 2072 6573 6574 5f6b 6579 730d 0a0d  rn reset_keys...
+00034ef0: 0a20 2020 2040 7265 7365 745f 6b65 7973  .    @reset_keys
+00034f00: 2e73 6574 7465 720d 0a20 2020 2064 6566  .setter..    def
+00034f10: 2072 6573 6574 5f6b 6579 7328 7365 6c66   reset_keys(self
+00034f20: 2c20 7661 6c75 6529 3a0d 0a20 2020 2020  , value):..     
+00034f30: 2020 2069 6620 7661 6c75 6520 6973 206e     if value is n
+00034f40: 6f74 204e 6f6e 653a 0d0a 2020 2020 2020  ot None:..      
+00034f50: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00034f60: 6e63 6528 7661 6c75 652c 2028 7374 722c  nce(value, (str,
+00034f70: 2074 7570 6c65 2929 3a0d 0a20 2020 2020   tuple)):..     
+00034f80: 2020 2020 2020 2020 2020 2076 616c 7565             value
+00034f90: 203d 205b 7661 6c75 655d 0d0a 2020 2020   = [value]..    
+00034fa0: 2020 2020 2020 2020 7661 6c75 6520 3d20          value = 
+00034fb0: 5b75 6e72 6176 656c 5f6b 6579 2876 616c  [unravel_key(val
+00034fc0: 2920 666f 7220 7661 6c20 696e 2076 616c  ) for val in val
+00034fd0: 7565 5d0d 0a20 2020 2020 2020 2073 656c  ue]..        sel
+00034fe0: 662e 5f72 6573 6574 5f6b 6579 7320 3d20  f._reset_keys = 
+00034ff0: 7661 6c75 650d 0a0d 0a20 2020 2064 6566  value....    def
+00035000: 205f 7265 7365 7428 0d0a 2020 2020 2020   _reset(..      
+00035010: 2020 7365 6c66 2c20 7465 6e73 6f72 6469    self, tensordi
+00035020: 6374 3a20 5465 6e73 6f72 4469 6374 4261  ct: TensorDictBa
+00035030: 7365 2c20 7465 6e73 6f72 6469 6374 5f72  se, tensordict_r
+00035040: 6573 6574 3a20 5465 6e73 6f72 4469 6374  eset: TensorDict
+00035050: 4261 7365 0d0a 2020 2020 2920 2d3e 2054  Base..    ) -> T
+00035060: 656e 736f 7244 6963 7442 6173 653a 0d0a  ensorDictBase:..
+00035070: 2020 2020 2020 2020 2222 2252 6573 6574          """Reset
+00035080: 7320 6570 6973 6f64 6520 7265 7761 7264  s episode reward
+00035090: 732e 2222 220d 0a20 2020 2020 2020 2066  s."""..        f
+000350a0: 6f72 2069 6e5f 6b65 792c 2072 6573 6574  or in_key, reset
+000350b0: 5f6b 6579 2c20 6f75 745f 6b65 7920 696e  _key, out_key in
+000350c0: 207a 6970 280d 0a20 2020 2020 2020 2020   zip(..         
+000350d0: 2020 2073 656c 662e 696e 5f6b 6579 732c     self.in_keys,
+000350e0: 2073 656c 662e 7265 7365 745f 6b65 7973   self.reset_keys
+000350f0: 2c20 7365 6c66 2e6f 7574 5f6b 6579 730d  , self.out_keys.
+00035100: 0a20 2020 2020 2020 2029 3a0d 0a20 2020  .        ):..   
+00035110: 2020 2020 2020 2020 205f 7265 7365 7420           _reset 
+00035120: 3d20 5f67 6574 5f72 6573 6574 2872 6573  = _get_reset(res
+00035130: 6574 5f6b 6579 2c20 7465 6e73 6f72 6469  et_key, tensordi
+00035140: 6374 290d 0a20 2020 2020 2020 2020 2020  ct)..           
+00035150: 2076 616c 7565 203d 2074 656e 736f 7264   value = tensord
+00035160: 6963 742e 6765 7428 6f75 745f 6b65 792c  ict.get(out_key,
+00035170: 2064 6566 6175 6c74 3d4e 6f6e 6529 0d0a   default=None)..
+00035180: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+00035190: 616c 7565 2069 7320 4e6f 6e65 3a0d 0a20  alue is None:.. 
+000351a0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+000351b0: 616c 7565 203d 2073 656c 662e 7061 7265  alue = self.pare
+000351c0: 6e74 2e66 756c 6c5f 7265 7761 7264 5f73  nt.full_reward_s
+000351d0: 7065 635b 696e 5f6b 6579 5d2e 7a65 726f  pec[in_key].zero
+000351e0: 2829 0d0a 2020 2020 2020 2020 2020 2020  ()..            
+000351f0: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
+00035200: 2020 2020 2020 2076 616c 7565 203d 2074         value = t
+00035210: 6f72 6368 2e77 6865 7265 2865 7870 616e  orch.where(expan
+00035220: 645f 6173 5f72 6967 6874 287e 5f72 6573  d_as_right(~_res
+00035230: 6574 2c20 7661 6c75 6529 2c20 7661 6c75  et, value), valu
+00035240: 652c 2030 2e30 290d 0a20 2020 2020 2020  e, 0.0)..       
+00035250: 2020 2020 2074 656e 736f 7264 6963 745f       tensordict_
+00035260: 7265 7365 742e 7365 7428 6f75 745f 6b65  reset.set(out_ke
+00035270: 792c 2076 616c 7565 290d 0a20 2020 2020  y, value)..     
+00035280: 2020 2072 6574 7572 6e20 7465 6e73 6f72     return tensor
+00035290: 6469 6374 5f72 6573 6574 0d0a 0d0a 2020  dict_reset....  
+000352a0: 2020 6465 6620 5f73 7465 7028 0d0a 2020    def _step(..  
+000352b0: 2020 2020 2020 7365 6c66 2c20 7465 6e73        self, tens
+000352c0: 6f72 6469 6374 3a20 5465 6e73 6f72 4469  ordict: TensorDi
+000352d0: 6374 4261 7365 2c20 6e65 7874 5f74 656e  ctBase, next_ten
+000352e0: 736f 7264 6963 743a 2054 656e 736f 7244  sordict: TensorD
+000352f0: 6963 7442 6173 650d 0a20 2020 2029 202d  ictBase..    ) -
+00035300: 3e20 5465 6e73 6f72 4469 6374 4261 7365  > TensorDictBase
+00035310: 3a0d 0a20 2020 2020 2020 2022 2222 5570  :..        """Up
+00035320: 6461 7465 7320 7468 6520 6570 6973 6f64  dates the episod
+00035330: 6520 7265 7761 7264 7320 7769 7468 2074  e rewards with t
+00035340: 6865 2073 7465 7020 7265 7761 7264 732e  he step rewards.
+00035350: 2222 220d 0a20 2020 2020 2020 2023 2055  """..        # U
+00035360: 7064 6174 6520 6570 6973 6f64 6520 7265  pdate episode re
+00035370: 7761 7264 730d 0a20 2020 2020 2020 2066  wards..        f
+00035380: 6f72 2069 6e5f 6b65 792c 206f 7574 5f6b  or in_key, out_k
+00035390: 6579 2069 6e20 7a69 7028 7365 6c66 2e69  ey in zip(self.i
+000353a0: 6e5f 6b65 7973 2c20 7365 6c66 2e6f 7574  n_keys, self.out
+000353b0: 5f6b 6579 7329 3a0d 0a20 2020 2020 2020  _keys):..       
+000353c0: 2020 2020 2069 6620 696e 5f6b 6579 2069       if in_key i
+000353d0: 6e20 6e65 7874 5f74 656e 736f 7264 6963  n next_tensordic
+000353e0: 742e 6b65 7973 2869 6e63 6c75 6465 5f6e  t.keys(include_n
+000353f0: 6573 7465 643d 5472 7565 293a 0d0a 2020  ested=True):..  
+00035400: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00035410: 7761 7264 203d 206e 6578 745f 7465 6e73  ward = next_tens
+00035420: 6f72 6469 6374 2e67 6574 2869 6e5f 6b65  ordict.get(in_ke
+00035430: 7929 0d0a 2020 2020 2020 2020 2020 2020  y)..            
+00035440: 2020 2020 7072 6576 5f72 6577 6172 6420      prev_reward 
+00035450: 3d20 7465 6e73 6f72 6469 6374 2e67 6574  = tensordict.get
+00035460: 286f 7574 5f6b 6579 2c20 302e 3029 0d0a  (out_key, 0.0)..
+00035470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035480: 6e65 7874 5f74 656e 736f 7264 6963 742e  next_tensordict.
+00035490: 7365 7428 6f75 745f 6b65 792c 2070 7265  set(out_key, pre
+000354a0: 765f 7265 7761 7264 202b 2072 6577 6172  v_reward + rewar
+000354b0: 6429 0d0a 2020 2020 2020 2020 2020 2020  d)..            
+000354c0: 656c 6966 206e 6f74 2073 656c 662e 6d69  elif not self.mi
+000354d0: 7373 696e 675f 746f 6c65 7261 6e63 653a  ssing_tolerance:
+000354e0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000354f0: 2020 7261 6973 6520 4b65 7945 7272 6f72    raise KeyError
+00035500: 2866 2227 7b69 6e5f 6b65 797d 2720 6e6f  (f"'{in_key}' no
+00035510: 7420 666f 756e 6420 696e 2074 656e 736f  t found in tenso
+00035520: 7264 6963 7420 7b74 656e 736f 7264 6963  rdict {tensordic
+00035530: 747d 2229 0d0a 2020 2020 2020 2020 7265  t}")..        re
+00035540: 7475 726e 206e 6578 745f 7465 6e73 6f72  turn next_tensor
+00035550: 6469 6374 0d0a 0d0a 2020 2020 6465 6620  dict....    def 
+00035560: 7472 616e 7366 6f72 6d5f 696e 7075 745f  transform_input_
+00035570: 7370 6563 2873 656c 662c 2069 6e70 7574  spec(self, input
+00035580: 5f73 7065 633a 2054 656e 736f 7253 7065  _spec: TensorSpe
+00035590: 6329 202d 3e20 5465 6e73 6f72 5370 6563  c) -> TensorSpec
+000355a0: 3a0d 0a20 2020 2020 2020 2073 7461 7465  :..        state
+000355b0: 5f73 7065 6320 3d20 696e 7075 745f 7370  _spec = input_sp
+000355c0: 6563 5b22 6675 6c6c 5f73 7461 7465 5f73  ec["full_state_s
+000355d0: 7065 6322 5d0d 0a20 2020 2020 2020 2069  pec"]..        i
+000355e0: 6620 7374 6174 655f 7370 6563 2069 7320  f state_spec is 
+000355f0: 4e6f 6e65 3a0d 0a20 2020 2020 2020 2020  None:..         
+00035600: 2020 2073 7461 7465 5f73 7065 6320 3d20     state_spec = 
+00035610: 436f 6d70 6f73 6974 6553 7065 6328 7368  CompositeSpec(sh
+00035620: 6170 653d 696e 7075 745f 7370 6563 2e73  ape=input_spec.s
+00035630: 6861 7065 2c20 6465 7669 6365 3d69 6e70  hape, device=inp
+00035640: 7574 5f73 7065 632e 6465 7669 6365 290d  ut_spec.device).
+00035650: 0a20 2020 2020 2020 2073 7461 7465 5f73  .        state_s
+00035660: 7065 632e 7570 6461 7465 2873 656c 662e  pec.update(self.
+00035670: 5f67 656e 6572 6174 655f 6570 6973 6f64  _generate_episod
+00035680: 655f 7265 7761 7264 5f73 7065 6328 2929  e_reward_spec())
+00035690: 0d0a 2020 2020 2020 2020 696e 7075 745f  ..        input_
+000356a0: 7370 6563 5b22 6675 6c6c 5f73 7461 7465  spec["full_state
+000356b0: 5f73 7065 6322 5d20 3d20 7374 6174 655f  _spec"] = state_
+000356c0: 7370 6563 0d0a 2020 2020 2020 2020 7265  spec..        re
+000356d0: 7475 726e 2069 6e70 7574 5f73 7065 630d  turn input_spec.
+000356e0: 0a0d 0a20 2020 2064 6566 205f 6765 6e65  ...    def _gene
+000356f0: 7261 7465 5f65 7069 736f 6465 5f72 6577  rate_episode_rew
+00035700: 6172 645f 7370 6563 2873 656c 6629 202d  ard_spec(self) -
+00035710: 3e20 436f 6d70 6f73 6974 6553 7065 633a  > CompositeSpec:
+00035720: 0d0a 2020 2020 2020 2020 6570 6973 6f64  ..        episod
+00035730: 655f 7265 7761 7264 5f73 7065 6320 3d20  e_reward_spec = 
+00035740: 436f 6d70 6f73 6974 6553 7065 6328 290d  CompositeSpec().
+00035750: 0a20 2020 2020 2020 2072 6577 6172 645f  .        reward_
+00035760: 7370 6563 203d 2073 656c 662e 7061 7265  spec = self.pare
+00035770: 6e74 2e66 756c 6c5f 7265 7761 7264 5f73  nt.full_reward_s
+00035780: 7065 630d 0a20 2020 2020 2020 2072 6577  pec..        rew
+00035790: 6172 645f 7370 6563 5f6b 6579 7320 3d20  ard_spec_keys = 
+000357a0: 7365 6c66 2e70 6172 656e 742e 7265 7761  self.parent.rewa
+000357b0: 7264 5f6b 6579 730d 0a20 2020 2020 2020  rd_keys..       
+000357c0: 2023 2044 6566 696e 6520 6570 6973 6f64   # Define episod
+000357d0: 6520 7370 6563 7320 666f 7220 616c 6c20  e specs for all 
+000357e0: 6f75 745f 6b65 7973 0d0a 2020 2020 2020  out_keys..      
+000357f0: 2020 666f 7220 696e 5f6b 6579 2c20 6f75    for in_key, ou
+00035800: 745f 6b65 7920 696e 207a 6970 2873 656c  t_key in zip(sel
+00035810: 662e 696e 5f6b 6579 732c 2073 656c 662e  f.in_keys, self.
+00035820: 6f75 745f 6b65 7973 293a 0d0a 2020 2020  out_keys):..    
+00035830: 2020 2020 2020 2020 6966 2028 0d0a 2020          if (..  
+00035840: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00035850: 5f6b 6579 2069 6e20 7265 7761 7264 5f73  _key in reward_s
+00035860: 7065 635f 6b65 7973 0d0a 2020 2020 2020  pec_keys..      
+00035870: 2020 2020 2020 293a 2020 2320 6966 2074        ):  # if t
+00035880: 6869 7320 6f75 745f 6b65 7920 6861 7320  his out_key has 
+00035890: 6120 636f 7272 6573 706f 6e64 696e 6720  a corresponding 
+000358a0: 6b65 7920 696e 2072 6577 6172 645f 7370  key in reward_sp
+000358b0: 6563 0d0a 2020 2020 2020 2020 2020 2020  ec..            
+000358c0: 2020 2020 6f75 745f 6b65 7920 3d20 5f75      out_key = _u
+000358d0: 6e72 6176 656c 5f6b 6579 5f74 6f5f 7475  nravel_key_to_tu
+000358e0: 706c 6528 6f75 745f 6b65 7929 0d0a 2020  ple(out_key)..  
+000358f0: 2020 2020 2020 2020 2020 2020 2020 7465                te
+00035900: 6d70 5f65 7069 736f 6465 5f72 6577 6172  mp_episode_rewar
+00035910: 645f 7370 6563 203d 2065 7069 736f 6465  d_spec = episode
+00035920: 5f72 6577 6172 645f 7370 6563 0d0a 2020  _reward_spec..  
+00035930: 2020 2020 2020 2020 2020 2020 2020 7465                te
+00035940: 6d70 5f72 6577 5f73 7065 6320 3d20 7265  mp_rew_spec = re
+00035950: 7761 7264 5f73 7065 630d 0a20 2020 2020  ward_spec..     
+00035960: 2020 2020 2020 2020 2020 2066 6f72 2073             for s
+00035970: 7562 5f6b 6579 2069 6e20 6f75 745f 6b65  ub_key in out_ke
+00035980: 795b 3a2d 315d 3a0d 0a20 2020 2020 2020  y[:-1]:..       
+00035990: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000359a0: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
+000359b0: 2020 2020 2020 2020 2020 206e 6f74 2069             not i
+000359c0: 7369 6e73 7461 6e63 6528 7465 6d70 5f72  sinstance(temp_r
+000359d0: 6577 5f73 7065 632c 2043 6f6d 706f 7369  ew_spec, Composi
+000359e0: 7465 5370 6563 290d 0a20 2020 2020 2020  teSpec)..       
+000359f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035a00: 206f 7220 7375 625f 6b65 7920 6e6f 7420   or sub_key not 
+00035a10: 696e 2074 656d 705f 7265 775f 7370 6563  in temp_rew_spec
+00035a20: 2e6b 6579 7328 290d 0a20 2020 2020 2020  .keys()..       
+00035a30: 2020 2020 2020 2020 2020 2020 2029 3a0d               ):.
+00035a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035a50: 2020 2020 2020 2020 2062 7265 616b 0d0a           break..
+00035a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035a70: 2020 2020 6966 2073 7562 5f6b 6579 206e      if sub_key n
+00035a80: 6f74 2069 6e20 7465 6d70 5f65 7069 736f  ot in temp_episo
+00035a90: 6465 5f72 6577 6172 645f 7370 6563 2e6b  de_reward_spec.k
+00035aa0: 6579 7328 293a 0d0a 2020 2020 2020 2020  eys():..        
+00035ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035ac0: 7465 6d70 5f65 7069 736f 6465 5f72 6577  temp_episode_rew
+00035ad0: 6172 645f 7370 6563 5b73 7562 5f6b 6579  ard_spec[sub_key
+00035ae0: 5d20 3d20 7465 6d70 5f72 6577 5f73 7065  ] = temp_rew_spe
+00035af0: 635b 0d0a 2020 2020 2020 2020 2020 2020  c[..            
+00035b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035b10: 7375 625f 6b65 790d 0a20 2020 2020 2020  sub_key..       
+00035b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035b30: 205d 2e65 6d70 7479 2829 0d0a 2020 2020   ].empty()..    
+00035b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035b50: 7465 6d70 5f72 6577 5f73 7065 6320 3d20  temp_rew_spec = 
+00035b60: 7465 6d70 5f72 6577 5f73 7065 635b 7375  temp_rew_spec[su
+00035b70: 625f 6b65 795d 0d0a 2020 2020 2020 2020  b_key]..        
+00035b80: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
+00035b90: 5f65 7069 736f 6465 5f72 6577 6172 645f  _episode_reward_
+00035ba0: 7370 6563 203d 2074 656d 705f 6570 6973  spec = temp_epis
+00035bb0: 6f64 655f 7265 7761 7264 5f73 7065 635b  ode_reward_spec[
+00035bc0: 7375 625f 6b65 795d 0d0a 2020 2020 2020  sub_key]..      
+00035bd0: 2020 2020 2020 2020 2020 6570 6973 6f64            episod
+00035be0: 655f 7265 7761 7264 5f73 7065 635b 6f75  e_reward_spec[ou
+00035bf0: 745f 6b65 795d 203d 2072 6577 6172 645f  t_key] = reward_
+00035c00: 7370 6563 5b69 6e5f 6b65 795d 2e63 6c6f  spec[in_key].clo
+00035c10: 6e65 2829 0d0a 2020 2020 2020 2020 2020  ne()..          
+00035c20: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
+00035c30: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00035c40: 616c 7565 4572 726f 7228 0d0a 2020 2020  alueError(..    
+00035c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035c60: 6622 5468 6520 696e 5f6b 6579 3a20 7b69  f"The in_key: {i
+00035c70: 6e5f 6b65 797d 2069 7320 6e6f 7420 7072  n_key} is not pr
+00035c80: 6573 656e 7420 696e 2074 6865 2072 6577  esent in the rew
+00035c90: 6172 6420 7370 6563 207b 7265 7761 7264  ard spec {reward
+00035ca0: 5f73 7065 637d 2e22 0d0a 2020 2020 2020  _spec}."..      
+00035cb0: 2020 2020 2020 2020 2020 290d 0a20 2020            )..   
+00035cc0: 2020 2020 2072 6574 7572 6e20 6570 6973       return epis
+00035cd0: 6f64 655f 7265 7761 7264 5f73 7065 630d  ode_reward_spec.
+00035ce0: 0a0d 0a20 2020 2064 6566 2074 7261 6e73  ...    def trans
+00035cf0: 666f 726d 5f6f 6273 6572 7661 7469 6f6e  form_observation
+00035d00: 5f73 7065 6328 7365 6c66 2c20 6f62 7365  _spec(self, obse
+00035d10: 7276 6174 696f 6e5f 7370 6563 3a20 5465  rvation_spec: Te
+00035d20: 6e73 6f72 5370 6563 2920 2d3e 2054 656e  nsorSpec) -> Ten
+00035d30: 736f 7253 7065 633a 0d0a 2020 2020 2020  sorSpec:..      
+00035d40: 2020 2222 2254 7261 6e73 666f 726d 7320    """Transforms 
+00035d50: 7468 6520 6f62 7365 7276 6174 696f 6e20  the observation 
+00035d60: 7370 6563 2c20 6164 6469 6e67 2074 6865  spec, adding the
+00035d70: 206e 6577 206b 6579 7320 6765 6e65 7261   new keys genera
+00035d80: 7465 6420 6279 2052 6577 6172 6453 756d  ted by RewardSum
+00035d90: 2e22 2222 0d0a 2020 2020 2020 2020 6966  ."""..        if
+00035da0: 2073 656c 662e 7265 7761 7264 5f73 7065   self.reward_spe
+00035db0: 633a 0d0a 2020 2020 2020 2020 2020 2020  c:..            
+00035dc0: 7265 7475 726e 206f 6273 6572 7661 7469  return observati
+00035dd0: 6f6e 5f73 7065 630d 0a20 2020 2020 2020  on_spec..       
+00035de0: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
+00035df0: 6365 286f 6273 6572 7661 7469 6f6e 5f73  ce(observation_s
+00035e00: 7065 632c 2043 6f6d 706f 7369 7465 5370  pec, CompositeSp
+00035e10: 6563 293a 0d0a 2020 2020 2020 2020 2020  ec):..          
+00035e20: 2020 6f62 7365 7276 6174 696f 6e5f 7370    observation_sp
+00035e30: 6563 203d 2043 6f6d 706f 7369 7465 5370  ec = CompositeSp
+00035e40: 6563 280d 0a20 2020 2020 2020 2020 2020  ec(..           
+00035e50: 2020 2020 206f 6273 6572 7661 7469 6f6e       observation
+00035e60: 3d6f 6273 6572 7661 7469 6f6e 5f73 7065  =observation_spe
+00035e70: 632c 2073 6861 7065 3d73 656c 662e 7061  c, shape=self.pa
+00035e80: 7265 6e74 2e62 6174 6368 5f73 697a 650d  rent.batch_size.
+00035e90: 0a20 2020 2020 2020 2020 2020 2029 0d0a  .            )..
+00035ea0: 2020 2020 2020 2020 6f62 7365 7276 6174          observat
+00035eb0: 696f 6e5f 7370 6563 2e75 7064 6174 6528  ion_spec.update(
+00035ec0: 7365 6c66 2e5f 6765 6e65 7261 7465 5f65  self._generate_e
+00035ed0: 7069 736f 6465 5f72 6577 6172 645f 7370  pisode_reward_sp
+00035ee0: 6563 2829 290d 0a20 2020 2020 2020 2072  ec())..        r
+00035ef0: 6574 7572 6e20 6f62 7365 7276 6174 696f  eturn observatio
+00035f00: 6e5f 7370 6563 0d0a 0d0a 2020 2020 6465  n_spec....    de
+00035f10: 6620 7472 616e 7366 6f72 6d5f 7265 7761  f transform_rewa
+00035f20: 7264 5f73 7065 6328 7365 6c66 2c20 7265  rd_spec(self, re
+00035f30: 7761 7264 5f73 7065 633a 2054 656e 736f  ward_spec: Tenso
+00035f40: 7253 7065 6329 202d 3e20 5465 6e73 6f72  rSpec) -> Tensor
+00035f50: 5370 6563 3a0d 0a20 2020 2020 2020 2069  Spec:..        i
+00035f60: 6620 6e6f 7420 7365 6c66 2e72 6577 6172  f not self.rewar
+00035f70: 645f 7370 6563 3a0d 0a20 2020 2020 2020  d_spec:..       
+00035f80: 2020 2020 2072 6574 7572 6e20 7265 7761       return rewa
+00035f90: 7264 5f73 7065 630d 0a20 2020 2020 2020  rd_spec..       
+00035fa0: 2072 6577 6172 645f 7370 6563 2e75 7064   reward_spec.upd
+00035fb0: 6174 6528 7365 6c66 2e5f 6765 6e65 7261  ate(self._genera
+00035fc0: 7465 5f65 7069 736f 6465 5f72 6577 6172  te_episode_rewar
+00035fd0: 645f 7370 6563 2829 290d 0a20 2020 2020  d_spec())..     
+00035fe0: 2020 2072 6574 7572 6e20 7265 7761 7264     return reward
+00035ff0: 5f73 7065 630d 0a0d 0a20 2020 2064 6566  _spec....    def
+00036000: 2066 6f72 7761 7264 2873 656c 662c 2074   forward(self, t
+00036010: 656e 736f 7264 6963 743a 2054 656e 736f  ensordict: Tenso
+00036020: 7244 6963 7442 6173 6529 202d 3e20 5465  rDictBase) -> Te
+00036030: 6e73 6f72 4469 6374 4261 7365 3a0d 0a20  nsorDictBase:.. 
+00036040: 2020 2020 2020 2074 696d 655f 6469 6d20         time_dim 
+00036050: 3d20 5b69 2066 6f72 2069 2c20 6e61 6d65  = [i for i, name
+00036060: 2069 6e20 656e 756d 6572 6174 6528 7465   in enumerate(te
+00036070: 6e73 6f72 6469 6374 2e6e 616d 6573 2920  nsordict.names) 
+00036080: 6966 206e 616d 6520 3d3d 2022 7469 6d65  if name == "time
+00036090: 225d 0d0a 2020 2020 2020 2020 6966 206e  "]..        if n
+000360a0: 6f74 2074 696d 655f 6469 6d3a 0d0a 2020  ot time_dim:..  
+000360b0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+000360c0: 5661 6c75 6545 7272 6f72 280d 0a20 2020  ValueError(..   
+000360d0: 2020 2020 2020 2020 2020 2020 2022 4174               "At
+000360e0: 206c 6561 7374 206f 6e65 2064 696d 656e   least one dimen
+000360f0: 7369 6f6e 206f 6620 7468 6520 7465 6e73  sion of the tens
+00036100: 6f72 6469 6374 206d 7573 7420 6265 206e  ordict must be n
+00036110: 616d 6564 2027 7469 6d65 2720 696e 206f  amed 'time' in o
+00036120: 6666 6c69 6e65 206d 6f64 6522 0d0a 2020  ffline mode"..  
+00036130: 2020 2020 2020 2020 2020 290d 0a20 2020            )..   
+00036140: 2020 2020 2074 696d 655f 6469 6d20 3d20       time_dim = 
+00036150: 7469 6d65 5f64 696d 5b30 5d20 2d20 310d  time_dim[0] - 1.
+00036160: 0a20 2020 2020 2020 2066 6f72 2069 6e5f  .        for in_
+00036170: 6b65 792c 206f 7574 5f6b 6579 2069 6e20  key, out_key in 
+00036180: 7a69 7028 7365 6c66 2e69 6e5f 6b65 7973  zip(self.in_keys
+00036190: 2c20 7365 6c66 2e6f 7574 5f6b 6579 7329  , self.out_keys)
+000361a0: 3a0d 0a20 2020 2020 2020 2020 2020 2072  :..            r
+000361b0: 6577 6172 6420 3d20 7465 6e73 6f72 6469  eward = tensordi
+000361c0: 6374 2e67 6574 2869 6e5f 6b65 7929 0d0a  ct.get(in_key)..
+000361d0: 2020 2020 2020 2020 2020 2020 6375 6d73              cums
+000361e0: 756d 203d 2072 6577 6172 642e 6375 6d73  um = reward.cums
+000361f0: 756d 2874 696d 655f 6469 6d29 0d0a 2020  um(time_dim)..  
+00036200: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
+00036210: 6469 6374 2e73 6574 286f 7574 5f6b 6579  dict.set(out_key
+00036220: 2c20 6375 6d73 756d 290d 0a20 2020 2020  , cumsum)..     
+00036230: 2020 2072 6574 7572 6e20 7465 6e73 6f72     return tensor
+00036240: 6469 6374 0d0a 0d0a 0d0a 636c 6173 7320  dict......class 
+00036250: 5374 6570 436f 756e 7465 7228 5472 616e  StepCounter(Tran
+00036260: 7366 6f72 6d29 3a0d 0a20 2020 2022 2222  sform):..    """
+00036270: 436f 756e 7473 2074 6865 2073 7465 7073  Counts the steps
+00036280: 2066 726f 6d20 6120 7265 7365 7420 616e   from a reset an
+00036290: 6420 6f70 7469 6f6e 616c 6c79 2073 6574  d optionally set
+000362a0: 7320 7468 6520 7472 756e 6361 7465 6420  s the truncated 
+000362b0: 7374 6174 6520 746f 2060 6054 7275 6560  state to ``True`
+000362c0: 6020 6166 7465 7220 6120 6365 7274 6169  ` after a certai
+000362d0: 6e20 6e75 6d62 6572 206f 6620 7374 6570  n number of step
+000362e0: 732e 0d0a 0d0a 2020 2020 5468 6520 6060  s.....    The ``
+000362f0: 2264 6f6e 6522 6060 2073 7461 7465 2069  "done"`` state i
+00036300: 7320 616c 736f 2061 6461 7074 6564 2061  s also adapted a
+00036310: 6363 6f72 6469 6e67 6c79 2028 6173 2064  ccordingly (as d
+00036320: 6f6e 6520 6973 2074 6865 2064 6973 6a75  one is the disju
+00036330: 6e63 7469 6f6e 0d0a 2020 2020 6f66 2074  nction..    of t
+00036340: 6173 6b20 636f 6d70 6c65 7469 6f6e 2061  ask completion a
+00036350: 6e64 2065 6172 6c79 2074 7275 6e63 6174  nd early truncat
+00036360: 696f 6e29 2e0d 0a0d 0a20 2020 2041 7267  ion).....    Arg
+00036370: 733a 0d0a 2020 2020 2020 2020 6d61 785f  s:..        max_
+00036380: 7374 6570 7320 2869 6e74 2c20 6f70 7469  steps (int, opti
+00036390: 6f6e 616c 293a 2061 2070 6f73 6974 6976  onal): a positiv
+000363a0: 6520 696e 7465 6765 7220 7468 6174 2069  e integer that i
+000363b0: 6e64 6963 6174 6573 2074 6865 0d0a 2020  ndicates the..  
+000363c0: 2020 2020 2020 2020 2020 6d61 7869 6d75            maximu
+000363d0: 6d20 6e75 6d62 6572 206f 6620 7374 6570  m number of step
+000363e0: 7320 746f 2074 616b 6520 6265 666f 7265  s to take before
+000363f0: 2073 6574 7469 6e67 2074 6865 2060 6074   setting the ``t
+00036400: 7275 6e63 6174 6564 5f6b 6579 6060 0d0a  runcated_key``..
+00036410: 2020 2020 2020 2020 2020 2020 656e 7472              entr
+00036420: 7920 746f 2060 6054 7275 6560 602e 0d0a  y to ``True``...
+00036430: 2020 2020 2020 2020 7472 756e 6361 7465          truncate
+00036440: 645f 6b65 7920 2873 7472 2c20 6f70 7469  d_key (str, opti
+00036450: 6f6e 616c 293a 2074 6865 206b 6579 2077  onal): the key w
+00036460: 6865 7265 2074 6865 2074 7275 6e63 6174  here the truncat
+00036470: 6564 2065 6e74 7269 6573 0d0a 2020 2020  ed entries..    
+00036480: 2020 2020 2020 2020 7368 6f75 6c64 2062          should b
+00036490: 6520 7772 6974 7465 6e2e 2044 6566 6175  e written. Defau
+000364a0: 6c74 7320 746f 2060 6022 7472 756e 6361  lts to ``"trunca
+000364b0: 7465 6422 6060 2c20 7768 6963 6820 6973  ted"``, which is
+000364c0: 2072 6563 6f67 6e69 7365 6420 6279 0d0a   recognised by..
+000364d0: 2020 2020 2020 2020 2020 2020 6461 7461              data
+000364e0: 2063 6f6c 6c65 6374 6f72 7320 6173 2061   collectors as a
+000364f0: 2072 6573 6574 2073 6967 6e61 6c2e 0d0a   reset signal...
+00036500: 2020 2020 2020 2020 2020 2020 5468 6973              This
+00036510: 2061 7267 756d 656e 7420 6361 6e20 6f6e   argument can on
+00036520: 6c79 2062 6520 6120 7374 7269 6e67 2028  ly be a string (
+00036530: 6e6f 7420 6120 6e65 7374 6564 206b 6579  not a nested key
+00036540: 2920 6173 2069 7420 7769 6c6c 2062 650d  ) as it will be.
+00036550: 0a20 2020 2020 2020 2020 2020 206d 6174  .            mat
+00036560: 6368 6564 2074 6f20 6561 6368 206f 6620  ched to each of 
+00036570: 7468 6520 6c65 6166 2064 6f6e 6520 6b65  the leaf done ke
+00036580: 7920 696e 2074 6865 2070 6172 656e 7420  y in the parent 
+00036590: 656e 7669 726f 6e6d 656e 740d 0a20 2020  environment..   
+000365a0: 2020 2020 2020 2020 2028 6567 2c20 6120           (eg, a 
+000365b0: 6060 2822 6167 656e 7422 2c20 2264 6f6e  ``("agent", "don
+000365c0: 6522 2960 6020 6b65 7920 7769 6c6c 2062  e")`` key will b
+000365d0: 6520 6163 636f 6d70 616e 6965 6420 6279  e accompanied by
+000365e0: 2061 0d0a 2020 2020 2020 2020 2020 2020   a..            
+000365f0: 6060 2822 6167 656e 7422 2c20 2274 7275  ``("agent", "tru
+00036600: 6e63 6174 6564 2229 6060 2069 6620 7468  ncated")`` if th
+00036610: 6520 6060 2274 7275 6e63 6174 6564 2260  e ``"truncated"`
+00036620: 6020 6b65 7920 6e61 6d65 2069 7320 7573  ` key name is us
+00036630: 6564 292e 0d0a 2020 2020 2020 2020 7374  ed)...        st
+00036640: 6570 5f63 6f75 6e74 5f6b 6579 2028 7374  ep_count_key (st
+00036650: 722c 206f 7074 696f 6e61 6c29 3a20 7468  r, optional): th
+00036660: 6520 6b65 7920 7768 6572 6520 7468 6520  e key where the 
+00036670: 7374 6570 2063 6f75 6e74 2065 6e74 7269  step count entri
+00036680: 6573 0d0a 2020 2020 2020 2020 2020 2020  es..            
+00036690: 7368 6f75 6c64 2062 6520 7772 6974 7465  should be writte
+000366a0: 6e2e 2044 6566 6175 6c74 7320 746f 2060  n. Defaults to `
+000366b0: 6022 7374 6570 5f63 6f75 6e74 2260 602e  `"step_count"``.
+000366c0: 0d0a 2020 2020 2020 2020 2020 2020 5468  ..            Th
+000366d0: 6973 2061 7267 756d 656e 7420 6361 6e20  is argument can 
+000366e0: 6f6e 6c79 2062 6520 6120 7374 7269 6e67  only be a string
+000366f0: 2028 6e6f 7420 6120 6e65 7374 6564 206b   (not a nested k
+00036700: 6579 2920 6173 2069 7420 7769 6c6c 2062  ey) as it will b
+00036710: 650d 0a20 2020 2020 2020 2020 2020 206d  e..            m
+00036720: 6174 6368 6564 2074 6f20 6561 6368 206f  atched to each o
+00036730: 6620 7468 6520 6c65 6166 2064 6f6e 6520  f the leaf done 
+00036740: 6b65 7920 696e 2074 6865 2070 6172 656e  key in the paren
+00036750: 7420 656e 7669 726f 6e6d 656e 740d 0a20  t environment.. 
+00036760: 2020 2020 2020 2020 2020 2028 6567 2c20             (eg, 
+00036770: 6120 6060 2822 6167 656e 7422 2c20 2264  a ``("agent", "d
+00036780: 6f6e 6522 2960 6020 6b65 7920 7769 6c6c  one")`` key will
+00036790: 2062 6520 6163 636f 6d70 616e 6965 6420   be accompanied 
+000367a0: 6279 2061 0d0a 2020 2020 2020 2020 2020  by a..          
+000367b0: 2020 6060 2822 6167 656e 7422 2c20 2273    ``("agent", "s
+000367c0: 7465 705f 636f 756e 7422 2960 6020 6966  tep_count")`` if
+000367d0: 2074 6865 2060 6022 7374 6570 5f63 6f75   the ``"step_cou
+000367e0: 6e74 2260 6020 6b65 7920 6e61 6d65 2069  nt"`` key name i
+000367f0: 7320 7573 6564 292e 0d0a 2020 2020 2020  s used)...      
+00036800: 2020 7570 6461 7465 5f64 6f6e 6520 2862    update_done (b
+00036810: 6f6f 6c2c 206f 7074 696f 6e61 6c29 3a20  ool, optional): 
+00036820: 6966 2060 6054 7275 6560 602c 2074 6865  if ``True``, the
+00036830: 2060 6022 646f 6e65 2260 6020 626f 6f6c   ``"done"`` bool
+00036840: 6561 6e20 7465 6e73 6f72 0d0a 2020 2020  ean tensor..    
+00036850: 2020 2020 2020 2020 6174 2074 6865 206c          at the l
+00036860: 6576 656c 206f 6620 6060 2274 7275 6e63  evel of ``"trunc
+00036870: 6174 6564 2260 600d 0a20 2020 2020 2020  ated"``..       
+00036880: 2020 2020 2077 696c 6c20 6265 2075 7064       will be upd
+00036890: 6174 6564 2e0d 0a20 2020 2020 2020 2020  ated...         
+000368a0: 2020 2054 6869 7320 7369 676e 616c 2069     This signal i
+000368b0: 6e64 6963 6174 6573 2074 6861 7420 7468  ndicates that th
+000368c0: 6520 7472 616a 6563 746f 7279 2068 6173  e trajectory has
+000368d0: 2072 6561 6368 6564 2069 7473 2065 6e64   reached its end
+000368e0: 732c 0d0a 2020 2020 2020 2020 2020 2020  s,..            
+000368f0: 6569 7468 6572 2062 6563 6175 7365 2074  either because t
+00036900: 6865 2074 6173 6b20 6973 2063 6f6d 706c  he task is compl
+00036910: 6574 6564 2028 6060 2263 6f6d 706c 6574  eted (``"complet
+00036920: 6564 2260 6020 656e 7472 7920 6973 0d0a  ed"`` entry is..
+00036930: 2020 2020 2020 2020 2020 2020 6060 5472              ``Tr
+00036940: 7565 6060 2920 6f72 2062 6563 6175 7365  ue``) or because
+00036950: 2069 7420 6861 7320 6265 656e 2074 7275   it has been tru
+00036960: 6e63 6174 6564 2028 6060 2274 7275 6e63  ncated (``"trunc
+00036970: 6174 6564 2260 6020 656e 7472 790d 0a20  ated"`` entry.. 
+00036980: 2020 2020 2020 2020 2020 2069 7320 6060             is ``
+00036990: 5472 7565 6060 292e 0d0a 2020 2020 2020  True``)...      
+000369a0: 2020 2020 2020 4465 6661 756c 7473 2074        Defaults t
+000369b0: 6f20 6060 5472 7565 6060 2e0d 0a0d 0a20  o ``True``..... 
+000369c0: 2020 202e 2e20 6e6f 7465 3a3a 2054 6f20     .. note:: To 
+000369d0: 656e 7375 7265 2063 6f6d 7061 7469 6269  ensure compatibi
+000369e0: 6c69 7479 2077 6974 6820 656e 7669 726f  lity with enviro
+000369f0: 6e6d 656e 7473 2074 6861 7420 6861 7665  nments that have
+00036a00: 206d 756c 7469 706c 650d 0a20 2020 2020   multiple..     
+00036a10: 2020 2064 6f6e 655f 6b65 7928 7329 2c20     done_key(s), 
+00036a20: 7468 6973 2074 7261 6e73 666f 726d 2077  this transform w
+00036a30: 696c 6c20 7772 6974 6520 6120 7374 6570  ill write a step
+00036a40: 5f63 6f75 6e74 2065 6e74 7279 2066 6f72  _count entry for
+00036a50: 0d0a 2020 2020 2020 2020 6576 6572 7920  ..        every 
+00036a60: 646f 6e65 2065 6e74 7279 2077 6974 6869  done entry withi
+00036a70: 6e20 7468 6520 7465 6e73 6f72 6469 6374  n the tensordict
+00036a80: 2e0d 0a0d 0a20 2020 2045 7861 6d70 6c65  .....    Example
+00036a90: 733a 0d0a 2020 2020 2020 2020 3e3e 3e20  s:..        >>> 
+00036aa0: 696d 706f 7274 2067 796d 6e61 7369 756d  import gymnasium
+00036ab0: 0d0a 2020 2020 2020 2020 3e3e 3e20 6672  ..        >>> fr
+00036ac0: 6f6d 2074 6f72 6368 726c 2e65 6e76 7320  om torchrl.envs 
+00036ad0: 696d 706f 7274 2047 796d 5772 6170 7065  import GymWrappe
+00036ae0: 720d 0a20 2020 2020 2020 203e 3e3e 2062  r..        >>> b
+00036af0: 6173 655f 656e 7620 3d20 4779 6d57 7261  ase_env = GymWra
+00036b00: 7070 6572 2867 796d 6e61 7369 756d 2e6d  pper(gymnasium.m
+00036b10: 616b 6528 2250 656e 6475 6c75 6d2d 7631  ake("Pendulum-v1
+00036b20: 2229 290d 0a20 2020 2020 2020 203e 3e3e  "))..        >>>
+00036b30: 2065 6e76 203d 2054 7261 6e73 666f 726d   env = Transform
+00036b40: 6564 456e 7628 6261 7365 5f65 6e76 2c0d  edEnv(base_env,.
+00036b50: 0a20 2020 2020 2020 202e 2e2e 2020 2020  .        ...    
+00036b60: 2053 7465 7043 6f75 6e74 6572 286d 6178   StepCounter(max
+00036b70: 5f73 7465 7073 3d35 2929 0d0a 2020 2020  _steps=5))..    
+00036b80: 2020 2020 3e3e 3e20 726f 6c6c 6f75 7420      >>> rollout 
+00036b90: 3d20 656e 762e 726f 6c6c 6f75 7428 3130  = env.rollout(10
+00036ba0: 3029 0d0a 2020 2020 2020 2020 3e3e 3e20  0)..        >>> 
+00036bb0: 7072 696e 7428 726f 6c6c 6f75 7429 0d0a  print(rollout)..
+00036bc0: 2020 2020 2020 2020 5465 6e73 6f72 4469          TensorDi
+00036bd0: 6374 280d 0a20 2020 2020 2020 2020 2020  ct(..           
+00036be0: 2066 6965 6c64 733d 7b0d 0a20 2020 2020   fields={..     
+00036bf0: 2020 2020 2020 2020 2020 2061 6374 696f             actio
+00036c00: 6e3a 2054 656e 736f 7228 7368 6170 653d  n: Tensor(shape=
+00036c10: 746f 7263 682e 5369 7a65 285b 352c 2031  torch.Size([5, 1
+00036c20: 5d29 2c20 6465 7669 6365 3d63 7075 2c20  ]), device=cpu, 
+00036c30: 6474 7970 653d 746f 7263 682e 666c 6f61  dtype=torch.floa
+00036c40: 7433 322c 2069 735f 7368 6172 6564 3d46  t32, is_shared=F
+00036c50: 616c 7365 292c 0d0a 2020 2020 2020 2020  alse),..        
+00036c60: 2020 2020 2020 2020 646f 6e65 3a20 5465          done: Te
+00036c70: 6e73 6f72 2873 6861 7065 3d74 6f72 6368  nsor(shape=torch
+00036c80: 2e53 697a 6528 5b35 2c20 315d 292c 2064  .Size([5, 1]), d
+00036c90: 6576 6963 653d 6370 752c 2064 7479 7065  evice=cpu, dtype
+00036ca0: 3d74 6f72 6368 2e62 6f6f 6c2c 2069 735f  =torch.bool, is_
+00036cb0: 7368 6172 6564 3d46 616c 7365 292c 0d0a  shared=False),..
+00036cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036cd0: 636f 6d70 6c65 7465 643a 2054 656e 736f  completed: Tenso
+00036ce0: 7228 7368 6170 653d 746f 7263 682e 5369  r(shape=torch.Si
+00036cf0: 7a65 285b 352c 2031 5d29 2c20 6465 7669  ze([5, 1]), devi
+00036d00: 6365 3d63 7075 2c20 6474 7970 653d 746f  ce=cpu, dtype=to
+00036d10: 7263 682e 626f 6f6c 2c20 6973 5f73 6861  rch.bool, is_sha
+00036d20: 7265 643d 4661 6c73 6529 7d2c 0d0a 2020  red=False)},..  
+00036d30: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
+00036d40: 7874 3a20 5465 6e73 6f72 4469 6374 280d  xt: TensorDict(.
+00036d50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00036d60: 2020 2020 2066 6965 6c64 733d 7b0d 0a20       fields={.. 
+00036d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036d80: 2020 2020 2020 2064 6f6e 653a 2054 656e         done: Ten
+00036d90: 736f 7228 7368 6170 653d 746f 7263 682e  sor(shape=torch.
+00036da0: 5369 7a65 285b 352c 2031 5d29 2c20 6465  Size([5, 1]), de
+00036db0: 7669 6365 3d63 7075 2c20 6474 7970 653d  vice=cpu, dtype=
+00036dc0: 746f 7263 682e 626f 6f6c 2c20 6973 5f73  torch.bool, is_s
+00036dd0: 6861 7265 643d 4661 6c73 6529 2c0d 0a20  hared=False),.. 
+00036de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036df0: 2020 2020 2020 2063 6f6d 706c 6574 6564         completed
+00036e00: 3a20 5465 6e73 6f72 2873 6861 7065 3d74  : Tensor(shape=t
+00036e10: 6f72 6368 2e53 697a 6528 5b35 2c20 315d  orch.Size([5, 1]
+00036e20: 292c 2064 6576 6963 653d 6370 752c 2064  ), device=cpu, d
+00036e30: 7479 7065 3d74 6f72 6368 2e62 6f6f 6c2c  type=torch.bool,
+00036e40: 2069 735f 7368 6172 6564 3d46 616c 7365   is_shared=False
+00036e50: 297d 2c0d 0a20 2020 2020 2020 2020 2020  )},..           
+00036e60: 2020 2020 2020 2020 2020 2020 206f 6273               obs
+00036e70: 6572 7661 7469 6f6e 3a20 5465 6e73 6f72  ervation: Tensor
+00036e80: 2873 6861 7065 3d74 6f72 6368 2e53 697a  (shape=torch.Siz
+00036e90: 6528 5b35 2c20 335d 292c 2064 6576 6963  e([5, 3]), devic
+00036ea0: 653d 6370 752c 2064 7479 7065 3d74 6f72  e=cpu, dtype=tor
+00036eb0: 6368 2e66 6c6f 6174 3332 2c20 6973 5f73  ch.float32, is_s
+00036ec0: 6861 7265 643d 4661 6c73 6529 2c0d 0a20  hared=False),.. 
+00036ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036ee0: 2020 2020 2020 2072 6577 6172 643a 2054         reward: T
+00036ef0: 656e 736f 7228 7368 6170 653d 746f 7263  ensor(shape=torc
+00036f00: 682e 5369 7a65 285b 352c 2031 5d29 2c20  h.Size([5, 1]), 
+00036f10: 6465 7669 6365 3d63 7075 2c20 6474 7970  device=cpu, dtyp
+00036f20: 653d 746f 7263 682e 666c 6f61 7433 322c  e=torch.float32,
+00036f30: 2069 735f 7368 6172 6564 3d46 616c 7365   is_shared=False
+00036f40: 292c 0d0a 2020 2020 2020 2020 2020 2020  ),..            
+00036f50: 2020 2020 2020 2020 2020 2020 7374 6570              step
+00036f60: 5f63 6f75 6e74 3a20 5465 6e73 6f72 2873  _count: Tensor(s
+00036f70: 6861 7065 3d74 6f72 6368 2e53 697a 6528  hape=torch.Size(
+00036f80: 5b35 2c20 315d 292c 2064 6576 6963 653d  [5, 1]), device=
+00036f90: 6370 752c 2064 7479 7065 3d74 6f72 6368  cpu, dtype=torch
+00036fa0: 2e69 6e74 3634 2c20 6973 5f73 6861 7265  .int64, is_share
+00036fb0: 643d 4661 6c73 6529 2c0d 0a20 2020 2020  d=False),..     
+00036fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036fd0: 2020 2074 7275 6e63 6174 6564 3a20 5465     truncated: Te
+00036fe0: 6e73 6f72 2873 6861 7065 3d74 6f72 6368  nsor(shape=torch
+00036ff0: 2e53 697a 6528 5b35 2c20 315d 292c 2064  .Size([5, 1]), d
+00037000: 6576 6963 653d 6370 752c 2064 7479 7065  evice=cpu, dtype
+00037010: 3d74 6f72 6368 2e62 6f6f 6c2c 2069 735f  =torch.bool, is_
+00037020: 7368 6172 6564 3d46 616c 7365 297d 2c0d  shared=False)},.
+00037030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00037040: 2020 2020 2062 6174 6368 5f73 697a 653d       batch_size=
+00037050: 746f 7263 682e 5369 7a65 285b 355d 292c  torch.Size([5]),
+00037060: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00037070: 2020 2020 2020 6465 7669 6365 3d63 7075        device=cpu
+00037080: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+00037090: 2020 2020 2020 2069 735f 7368 6172 6564         is_shared
+000370a0: 3d46 616c 7365 292c 0d0a 2020 2020 2020  =False),..      
+000370b0: 2020 2020 2020 2020 2020 6f62 7365 7276            observ
+000370c0: 6174 696f 6e3a 2054 656e 736f 7228 7368  ation: Tensor(sh
+000370d0: 6170 653d 746f 7263 682e 5369 7a65 285b  ape=torch.Size([
+000370e0: 352c 2033 5d29 2c20 6465 7669 6365 3d63  5, 3]), device=c
+000370f0: 7075 2c20 6474 7970 653d 746f 7263 682e  pu, dtype=torch.
+00037100: 666c 6f61 7433 322c 2069 735f 7368 6172  float32, is_shar
+00037110: 6564 3d46 616c 7365 292c 0d0a 2020 2020  ed=False),..    
+00037120: 2020 2020 2020 2020 2020 2020 7374 6570              step
+00037130: 5f63 6f75 6e74 3a20 5465 6e73 6f72 2873  _count: Tensor(s
+00037140: 6861 7065 3d74 6f72 6368 2e53 697a 6528  hape=torch.Size(
+00037150: 5b35 2c20 315d 292c 2064 6576 6963 653d  [5, 1]), device=
+00037160: 6370 752c 2064 7479 7065 3d74 6f72 6368  cpu, dtype=torch
+00037170: 2e69 6e74 3634 2c20 6973 5f73 6861 7265  .int64, is_share
+00037180: 643d 4661 6c73 6529 2c0d 0a20 2020 2020  d=False),..     
+00037190: 2020 2020 2020 2020 2020 2074 7275 6e63             trunc
+000371a0: 6174 6564 3a20 5465 6e73 6f72 2873 6861  ated: Tensor(sha
+000371b0: 7065 3d74 6f72 6368 2e53 697a 6528 5b35  pe=torch.Size([5
+000371c0: 2c20 315d 292c 2064 6576 6963 653d 6370  , 1]), device=cp
+000371d0: 752c 2064 7479 7065 3d74 6f72 6368 2e62  u, dtype=torch.b
+000371e0: 6f6f 6c2c 2069 735f 7368 6172 6564 3d46  ool, is_shared=F
+000371f0: 616c 7365 297d 2c0d 0a20 2020 2020 2020  alse)},..       
+00037200: 2020 2020 2062 6174 6368 5f73 697a 653d       batch_size=
+00037210: 746f 7263 682e 5369 7a65 285b 355d 292c  torch.Size([5]),
+00037220: 0d0a 2020 2020 2020 2020 2020 2020 6465  ..            de
+00037230: 7669 6365 3d63 7075 2c0d 0a20 2020 2020  vice=cpu,..     
+00037240: 2020 2020 2020 2069 735f 7368 6172 6564         is_shared
+00037250: 3d46 616c 7365 290d 0a20 2020 2020 2020  =False)..       
+00037260: 203e 3e3e 2070 7269 6e74 2872 6f6c 6c6f   >>> print(rollo
+00037270: 7574 5b22 6e65 7874 222c 2022 7374 6570  ut["next", "step
+00037280: 5f63 6f75 6e74 225d 290d 0a20 2020 2020  _count"])..     
+00037290: 2020 2074 656e 736f 7228 5b5b 315d 2c0d     tensor([[1],.
+000372a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000372b0: 205b 325d 2c0d 0a20 2020 2020 2020 2020   [2],..         
+000372c0: 2020 2020 2020 205b 335d 2c0d 0a20 2020         [3],..   
+000372d0: 2020 2020 2020 2020 2020 2020 205b 345d               [4]
+000372e0: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+000372f0: 2020 205b 355d 5d29 0d0a 0d0a 2020 2020     [5]])....    
+00037300: 2222 220d 0a0d 0a20 2020 2069 6e76 6572  """....    inver
+00037310: 7469 626c 6520 3d20 4661 6c73 650d 0a0d  tible = False...
+00037320: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00037330: 5f28 0d0a 2020 2020 2020 2020 7365 6c66  _(..        self
+00037340: 2c0d 0a20 2020 2020 2020 206d 6178 5f73  ,..        max_s
+00037350: 7465 7073 3a20 4f70 7469 6f6e 616c 5b69  teps: Optional[i
+00037360: 6e74 5d20 3d20 4e6f 6e65 2c0d 0a20 2020  nt] = None,..   
+00037370: 2020 2020 2074 7275 6e63 6174 6564 5f6b       truncated_k
+00037380: 6579 3a20 7374 7220 7c20 4e6f 6e65 203d  ey: str | None =
+00037390: 2022 7472 756e 6361 7465 6422 2c0d 0a20   "truncated",.. 
+000373a0: 2020 2020 2020 2073 7465 705f 636f 756e         step_coun
+000373b0: 745f 6b65 793a 2073 7472 207c 204e 6f6e  t_key: str | Non
+000373c0: 6520 3d20 2273 7465 705f 636f 756e 7422  e = "step_count"
+000373d0: 2c0d 0a20 2020 2020 2020 2075 7064 6174  ,..        updat
+000373e0: 655f 646f 6e65 3a20 626f 6f6c 203d 2054  e_done: bool = T
+000373f0: 7275 652c 0d0a 2020 2020 293a 0d0a 2020  rue,..    ):..  
+00037400: 2020 2020 2020 6966 206d 6178 5f73 7465        if max_ste
+00037410: 7073 2069 7320 6e6f 7420 4e6f 6e65 2061  ps is not None a
+00037420: 6e64 206d 6178 5f73 7465 7073 203c 2031  nd max_steps < 1
+00037430: 3a0d 0a20 2020 2020 2020 2020 2020 2072  :..            r
+00037440: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00037450: 226d 6178 5f73 7465 7073 2073 686f 756c  "max_steps shoul
+00037460: 6420 6861 7665 2061 2076 616c 7565 2067  d have a value g
+00037470: 7265 6174 6572 206f 7220 6571 7561 6c20  reater or equal 
+00037480: 746f 206f 6e65 2e22 290d 0a20 2020 2020  to one.")..     
+00037490: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
+000374a0: 616e 6365 2874 7275 6e63 6174 6564 5f6b  ance(truncated_k
+000374b0: 6579 2c20 7374 7229 3a0d 0a20 2020 2020  ey, str):..     
+000374c0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+000374d0: 7565 4572 726f 7228 2274 7275 6e63 6174  ueError("truncat
+000374e0: 6564 5f6b 6579 206d 7573 7420 6265 2061  ed_key must be a
+000374f0: 2073 7472 696e 672e 2229 0d0a 2020 2020   string.")..    
+00037500: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
+00037510: 7461 6e63 6528 7374 6570 5f63 6f75 6e74  tance(step_count
+00037520: 5f6b 6579 2c20 7374 7229 3a0d 0a20 2020  _key, str):..   
+00037530: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00037540: 616c 7565 4572 726f 7228 2273 7465 705f  alueError("step_
+00037550: 636f 756e 745f 6b65 7920 6d75 7374 2062  count_key must b
+00037560: 6520 6120 7374 7269 6e67 2e22 290d 0a20  e a string.").. 
+00037570: 2020 2020 2020 2073 656c 662e 6d61 785f         self.max_
+00037580: 7374 6570 7320 3d20 6d61 785f 7374 6570  steps = max_step
+00037590: 730d 0a20 2020 2020 2020 2073 656c 662e  s..        self.
+000375a0: 7472 756e 6361 7465 645f 6b65 7920 3d20  truncated_key = 
+000375b0: 7472 756e 6361 7465 645f 6b65 790d 0a20  truncated_key.. 
+000375c0: 2020 2020 2020 2073 656c 662e 7374 6570         self.step
+000375d0: 5f63 6f75 6e74 5f6b 6579 203d 2073 7465  _count_key = ste
+000375e0: 705f 636f 756e 745f 6b65 790d 0a20 2020  p_count_key..   
+000375f0: 2020 2020 2073 656c 662e 7570 6461 7465       self.update
+00037600: 5f64 6f6e 6520 3d20 7570 6461 7465 5f64  _done = update_d
+00037610: 6f6e 650d 0a20 2020 2020 2020 2073 7570  one..        sup
+00037620: 6572 2829 2e5f 5f69 6e69 745f 5f28 290d  er().__init__().
+00037630: 0a0d 0a20 2020 2040 7072 6f70 6572 7479  ...    @property
+00037640: 0d0a 2020 2020 6465 6620 7472 756e 6361  ..    def trunca
+00037650: 7465 645f 6b65 7973 2873 656c 6629 3a0d  ted_keys(self):.
+00037660: 0a20 2020 2020 2020 2074 7275 6e63 6174  .        truncat
+00037670: 6564 5f6b 6579 7320 3d20 7365 6c66 2e5f  ed_keys = self._
+00037680: 5f64 6963 745f 5f2e 6765 7428 225f 7472  _dict__.get("_tr
+00037690: 756e 6361 7465 645f 6b65 7973 222c 204e  uncated_keys", N
+000376a0: 6f6e 6529 0d0a 2020 2020 2020 2020 6966  one)..        if
+000376b0: 2074 7275 6e63 6174 6564 5f6b 6579 7320   truncated_keys 
+000376c0: 6973 204e 6f6e 653a 0d0a 2020 2020 2020  is None:..      
+000376d0: 2020 2020 2020 2320 6d61 6b65 2074 6865        # make the
+000376e0: 2064 6566 6175 6c74 2074 7275 6e63 6174   default truncat
+000376f0: 6564 206b 6579 730d 0a20 2020 2020 2020  ed keys..       
+00037700: 2020 2020 2074 7275 6e63 6174 6564 5f6b       truncated_k
+00037710: 6579 7320 3d20 5b5d 0d0a 2020 2020 2020  eys = []..      
+00037720: 2020 2020 2020 666f 7220 7265 7365 745f        for reset_
+00037730: 6b65 7920 696e 2073 656c 662e 7061 7265  key in self.pare
+00037740: 6e74 2e5f 6669 6c74 6572 6564 5f72 6573  nt._filtered_res
+00037750: 6574 5f6b 6579 733a 0d0a 2020 2020 2020  et_keys:..      
+00037760: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
+00037770: 6e73 7461 6e63 6528 7265 7365 745f 6b65  nstance(reset_ke
+00037780: 792c 2073 7472 293a 0d0a 2020 2020 2020  y, str):..      
+00037790: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
+000377a0: 7920 3d20 7365 6c66 2e74 7275 6e63 6174  y = self.truncat
+000377b0: 6564 5f6b 6579 0d0a 2020 2020 2020 2020  ed_key..        
+000377c0: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
+000377d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000377e0: 2020 206b 6579 203d 2028 2a72 6573 6574     key = (*reset
+000377f0: 5f6b 6579 5b3a 2d31 5d2c 2073 656c 662e  _key[:-1], self.
+00037800: 7472 756e 6361 7465 645f 6b65 7929 0d0a  truncated_key)..
+00037810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037820: 7472 756e 6361 7465 645f 6b65 7973 2e61  truncated_keys.a
+00037830: 7070 656e 6428 6b65 7929 0d0a 2020 2020  ppend(key)..    
+00037840: 2020 2020 7365 6c66 2e5f 7472 756e 6361      self._trunca
+00037850: 7465 645f 6b65 7973 203d 2074 7275 6e63  ted_keys = trunc
+00037860: 6174 6564 5f6b 6579 730d 0a20 2020 2020  ated_keys..     
+00037870: 2020 2072 6574 7572 6e20 7472 756e 6361     return trunca
+00037880: 7465 645f 6b65 7973 0d0a 0d0a 2020 2020  ted_keys....    
+00037890: 4070 726f 7065 7274 790d 0a20 2020 2064  @property..    d
+000378a0: 6566 2064 6f6e 655f 6b65 7973 2873 656c  ef done_keys(sel
+000378b0: 6629 3a0d 0a20 2020 2020 2020 2064 6f6e  f):..        don
+000378c0: 655f 6b65 7973 203d 2073 656c 662e 5f5f  e_keys = self.__
+000378d0: 6469 6374 5f5f 2e67 6574 2822 5f64 6f6e  dict__.get("_don
+000378e0: 655f 6b65 7973 222c 204e 6f6e 6529 0d0a  e_keys", None)..
+000378f0: 2020 2020 2020 2020 6966 2064 6f6e 655f          if done_
+00037900: 6b65 7973 2069 7320 4e6f 6e65 3a0d 0a20  keys is None:.. 
+00037910: 2020 2020 2020 2020 2020 2023 206d 616b             # mak
+00037920: 6520 7468 6520 6465 6661 756c 7420 646f  e the default do
+00037930: 6e65 206b 6579 730d 0a20 2020 2020 2020  ne keys..       
+00037940: 2020 2020 2064 6f6e 655f 6b65 7973 203d       done_keys =
+00037950: 205b 5d0d 0a20 2020 2020 2020 2020 2020   []..           
+00037960: 2066 6f72 2072 6573 6574 5f6b 6579 2069   for reset_key i
+00037970: 6e20 7365 6c66 2e70 6172 656e 742e 5f66  n self.parent._f
+00037980: 696c 7465 7265 645f 7265 7365 745f 6b65  iltered_reset_ke
+00037990: 7973 3a0d 0a20 2020 2020 2020 2020 2020  ys:..           
+000379a0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+000379b0: 6365 2872 6573 6574 5f6b 6579 2c20 7374  ce(reset_key, st
+000379c0: 7229 3a0d 0a20 2020 2020 2020 2020 2020  r):..           
+000379d0: 2020 2020 2020 2020 206b 6579 203d 2022           key = "
+000379e0: 646f 6e65 220d 0a20 2020 2020 2020 2020  done"..         
+000379f0: 2020 2020 2020 2065 6c73 653a 0d0a 2020         else:..  
+00037a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037a10: 2020 6b65 7920 3d20 282a 7265 7365 745f    key = (*reset_
+00037a20: 6b65 795b 3a2d 315d 2c20 2264 6f6e 6522  key[:-1], "done"
+00037a30: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+00037a40: 2020 2064 6f6e 655f 6b65 7973 2e61 7070     done_keys.app
+00037a50: 656e 6428 6b65 7929 0d0a 2020 2020 2020  end(key)..      
+00037a60: 2020 7365 6c66 2e5f 5f64 6963 745f 5f5b    self.__dict__[
+00037a70: 225f 646f 6e65 5f6b 6579 7322 5d20 3d20  "_done_keys"] = 
+00037a80: 646f 6e65 5f6b 6579 730d 0a20 2020 2020  done_keys..     
+00037a90: 2020 2072 6574 7572 6e20 646f 6e65 5f6b     return done_k
+00037aa0: 6579 730d 0a0d 0a20 2020 2040 7072 6f70  eys....    @prop
+00037ab0: 6572 7479 0d0a 2020 2020 6465 6620 7465  erty..    def te
+00037ac0: 726d 696e 6174 6564 5f6b 6579 7328 7365  rminated_keys(se
+00037ad0: 6c66 293a 0d0a 2020 2020 2020 2020 7465  lf):..        te
+00037ae0: 726d 696e 6174 6564 5f6b 6579 7320 3d20  rminated_keys = 
+00037af0: 7365 6c66 2e5f 5f64 6963 745f 5f2e 6765  self.__dict__.ge
+00037b00: 7428 225f 7465 726d 696e 6174 6564 5f6b  t("_terminated_k
+00037b10: 6579 7322 2c20 4e6f 6e65 290d 0a20 2020  eys", None)..   
+00037b20: 2020 2020 2069 6620 7465 726d 696e 6174       if terminat
+00037b30: 6564 5f6b 6579 7320 6973 204e 6f6e 653a  ed_keys is None:
+00037b40: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00037b50: 6d61 6b65 2074 6865 2064 6566 6175 6c74  make the default
+00037b60: 2074 6572 6d69 6e61 7465 6420 6b65 7973   terminated keys
+00037b70: 0d0a 2020 2020 2020 2020 2020 2020 7465  ..            te
+00037b80: 726d 696e 6174 6564 5f6b 6579 7320 3d20  rminated_keys = 
+00037b90: 5b5d 0d0a 2020 2020 2020 2020 2020 2020  []..            
+00037ba0: 666f 7220 7265 7365 745f 6b65 7920 696e  for reset_key in
+00037bb0: 2073 656c 662e 7061 7265 6e74 2e5f 6669   self.parent._fi
+00037bc0: 6c74 6572 6564 5f72 6573 6574 5f6b 6579  ltered_reset_key
+00037bd0: 733a 0d0a 2020 2020 2020 2020 2020 2020  s:..            
+00037be0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00037bf0: 6528 7265 7365 745f 6b65 792c 2073 7472  e(reset_key, str
+00037c00: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
+00037c10: 2020 2020 2020 2020 6b65 7920 3d20 2274          key = "t
+00037c20: 6572 6d69 6e61 7465 6422 0d0a 2020 2020  erminated"..    
+00037c30: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00037c40: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+00037c50: 2020 2020 2020 206b 6579 203d 2028 2a72         key = (*r
+00037c60: 6573 6574 5f6b 6579 5b3a 2d31 5d2c 2022  eset_key[:-1], "
+00037c70: 7465 726d 696e 6174 6564 2229 0d0a 2020  terminated")..  
+00037c80: 2020 2020 2020 2020 2020 2020 2020 7465                te
+00037c90: 726d 696e 6174 6564 5f6b 6579 732e 6170  rminated_keys.ap
+00037ca0: 7065 6e64 286b 6579 290d 0a20 2020 2020  pend(key)..     
+00037cb0: 2020 2073 656c 662e 5f5f 6469 6374 5f5f     self.__dict__
+00037cc0: 5b22 5f74 6572 6d69 6e61 7465 645f 6b65  ["_terminated_ke
+00037cd0: 7973 225d 203d 2074 6572 6d69 6e61 7465  ys"] = terminate
+00037ce0: 645f 6b65 7973 0d0a 2020 2020 2020 2020  d_keys..        
+00037cf0: 7265 7475 726e 2074 6572 6d69 6e61 7465  return terminate
+00037d00: 645f 6b65 7973 0d0a 0d0a 2020 2020 4070  d_keys....    @p
+00037d10: 726f 7065 7274 790d 0a20 2020 2064 6566  roperty..    def
+00037d20: 2073 7465 705f 636f 756e 745f 6b65 7973   step_count_keys
+00037d30: 2873 656c 6629 3a0d 0a20 2020 2020 2020  (self):..       
+00037d40: 2073 7465 705f 636f 756e 745f 6b65 7973   step_count_keys
+00037d50: 203d 2073 656c 662e 5f5f 6469 6374 5f5f   = self.__dict__
+00037d60: 2e67 6574 2822 5f73 7465 705f 636f 756e  .get("_step_coun
+00037d70: 745f 6b65 7973 222c 204e 6f6e 6529 0d0a  t_keys", None)..
+00037d80: 2020 2020 2020 2020 6966 2073 7465 705f          if step_
+00037d90: 636f 756e 745f 6b65 7973 2069 7320 4e6f  count_keys is No
+00037da0: 6e65 3a0d 0a20 2020 2020 2020 2020 2020  ne:..           
+00037db0: 2023 206d 616b 6520 7468 6520 6465 6661   # make the defa
+00037dc0: 756c 7420 7374 6570 5f63 6f75 6e74 206b  ult step_count k
+00037dd0: 6579 730d 0a20 2020 2020 2020 2020 2020  eys..           
+00037de0: 2073 7465 705f 636f 756e 745f 6b65 7973   step_count_keys
+00037df0: 203d 205b 5d0d 0a20 2020 2020 2020 2020   = []..         
+00037e00: 2020 2066 6f72 2072 6573 6574 5f6b 6579     for reset_key
+00037e10: 2069 6e20 7365 6c66 2e70 6172 656e 742e   in self.parent.
+00037e20: 5f66 696c 7465 7265 645f 7265 7365 745f  _filtered_reset_
+00037e30: 6b65 7973 3a0d 0a20 2020 2020 2020 2020  keys:..         
+00037e40: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+00037e50: 616e 6365 2872 6573 6574 5f6b 6579 2c20  ance(reset_key, 
+00037e60: 7374 7229 3a0d 0a20 2020 2020 2020 2020  str):..         
+00037e70: 2020 2020 2020 2020 2020 206b 6579 203d             key =
+00037e80: 2073 656c 662e 7374 6570 5f63 6f75 6e74   self.step_count
+00037e90: 5f6b 6579 0d0a 2020 2020 2020 2020 2020  _key..          
+00037ea0: 2020 2020 2020 656c 7365 3a0d 0a20 2020        else:..   
+00037eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037ec0: 206b 6579 203d 2028 2a72 6573 6574 5f6b   key = (*reset_k
+00037ed0: 6579 5b3a 2d31 5d2c 2073 656c 662e 7374  ey[:-1], self.st
+00037ee0: 6570 5f63 6f75 6e74 5f6b 6579 290d 0a20  ep_count_key).. 
+00037ef0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00037f00: 7465 705f 636f 756e 745f 6b65 7973 2e61  tep_count_keys.a
+00037f10: 7070 656e 6428 6b65 7929 0d0a 2020 2020  ppend(key)..    
+00037f20: 2020 2020 7365 6c66 2e5f 5f64 6963 745f      self.__dict_
+00037f30: 5f5b 225f 7374 6570 5f63 6f75 6e74 5f6b  _["_step_count_k
+00037f40: 6579 7322 5d20 3d20 7374 6570 5f63 6f75  eys"] = step_cou
+00037f50: 6e74 5f6b 6579 730d 0a20 2020 2020 2020  nt_keys..       
+00037f60: 2072 6574 7572 6e20 7374 6570 5f63 6f75   return step_cou
+00037f70: 6e74 5f6b 6579 730d 0a0d 0a20 2020 2040  nt_keys....    @
+00037f80: 7072 6f70 6572 7479 0d0a 2020 2020 6465  property..    de
+00037f90: 6620 7265 7365 745f 6b65 7973 2873 656c  f reset_keys(sel
+00037fa0: 6629 3a0d 0a20 2020 2020 2020 2069 6620  f):..        if 
+00037fb0: 7365 6c66 2e70 6172 656e 7420 6973 206e  self.parent is n
+00037fc0: 6f74 204e 6f6e 653a 0d0a 2020 2020 2020  ot None:..      
+00037fd0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00037fe0: 662e 7061 7265 6e74 2e5f 6669 6c74 6572  f.parent._filter
+00037ff0: 6564 5f72 6573 6574 5f6b 6579 730d 0a20  ed_reset_keys.. 
+00038000: 2020 2020 2020 2023 2066 616c 6c62 6163         # fallbac
+00038010: 6b20 6f6e 2064 6566 6175 6c74 2022 5f72  k on default "_r
+00038020: 6573 6574 220d 0a20 2020 2020 2020 2072  eset"..        r
+00038030: 6574 7572 6e20 5b22 5f72 6573 6574 225d  eturn ["_reset"]
+00038040: 0d0a 0d0a 2020 2020 4070 726f 7065 7274  ....    @propert
+00038050: 790d 0a20 2020 2064 6566 2066 756c 6c5f  y..    def full_
+00038060: 646f 6e65 5f73 7065 6328 7365 6c66 293a  done_spec(self):
+00038070: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00038080: 2073 656c 662e 7061 7265 6e74 2e6f 7574   self.parent.out
+00038090: 7075 745f 7370 6563 5b22 6675 6c6c 5f64  put_spec["full_d
+000380a0: 6f6e 655f 7370 6563 225d 2069 6620 7365  one_spec"] if se
+000380b0: 6c66 2e70 6172 656e 7420 656c 7365 204e  lf.parent else N
+000380c0: 6f6e 650d 0a0d 0a20 2020 2064 6566 205f  one....    def _
+000380d0: 7265 7365 7428 0d0a 2020 2020 2020 2020  reset(..        
+000380e0: 7365 6c66 2c20 7465 6e73 6f72 6469 6374  self, tensordict
+000380f0: 3a20 5465 6e73 6f72 4469 6374 4261 7365  : TensorDictBase
+00038100: 2c20 7465 6e73 6f72 6469 6374 5f72 6573  , tensordict_res
+00038110: 6574 3a20 5465 6e73 6f72 4469 6374 4261  et: TensorDictBa
+00038120: 7365 0d0a 2020 2020 2920 2d3e 2054 656e  se..    ) -> Ten
+00038130: 736f 7244 6963 7442 6173 653a 0d0a 2020  sorDictBase:..  
+00038140: 2020 2020 2020 2320 6765 7420 7265 7365        # get rese
+00038150: 7420 7369 676e 616c 0d0a 2020 2020 2020  t signal..      
+00038160: 2020 666f 7220 7374 6570 5f63 6f75 6e74    for step_count
+00038170: 5f6b 6579 2c20 7472 756e 6361 7465 645f  _key, truncated_
+00038180: 6b65 792c 2074 6572 6d69 6e61 7465 645f  key, terminated_
+00038190: 6b65 792c 2072 6573 6574 5f6b 6579 2c20  key, reset_key, 
+000381a0: 646f 6e65 5f6b 6579 2069 6e20 7a69 7028  done_key in zip(
+000381b0: 0d0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+000381c0: 6c66 2e73 7465 705f 636f 756e 745f 6b65  lf.step_count_ke
+000381d0: 7973 2c0d 0a20 2020 2020 2020 2020 2020  ys,..           
+000381e0: 2073 656c 662e 7472 756e 6361 7465 645f   self.truncated_
+000381f0: 6b65 7973 2c0d 0a20 2020 2020 2020 2020  keys,..         
+00038200: 2020 2073 656c 662e 7465 726d 696e 6174     self.terminat
+00038210: 6564 5f6b 6579 732c 0d0a 2020 2020 2020  ed_keys,..      
+00038220: 2020 2020 2020 7365 6c66 2e72 6573 6574        self.reset
+00038230: 5f6b 6579 732c 0d0a 2020 2020 2020 2020  _keys,..        
+00038240: 2020 2020 7365 6c66 2e64 6f6e 655f 6b65      self.done_ke
+00038250: 7973 2c0d 0a20 2020 2020 2020 2029 3a0d  ys,..        ):.
+00038260: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+00038270: 6574 203d 2074 656e 736f 7264 6963 742e  et = tensordict.
+00038280: 6765 7428 7265 7365 745f 6b65 792c 2064  get(reset_key, d
+00038290: 6566 6175 6c74 3d4e 6f6e 6529 0d0a 2020  efault=None)..  
+000382a0: 2020 2020 2020 2020 2020 6966 2072 6573            if res
+000382b0: 6574 2069 7320 4e6f 6e65 3a0d 0a20 2020  et is None:..   
+000382c0: 2020 2020 2020 2020 2020 2020 2023 2067               # g
+000382d0: 6574 2064 6f6e 6520 7374 6174 7573 2c20  et done status, 
+000382e0: 6a75 7374 2074 6f20 696e 666f 726d 2074  just to inform t
+000382f0: 6865 2072 6573 6574 2073 6861 7065 2c20  he reset shape, 
+00038300: 6474 7970 6520 616e 6420 6465 7669 6365  dtype and device
+00038310: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00038320: 2020 666f 7220 656e 7472 795f 6e61 6d65    for entry_name
+00038330: 2069 6e20 2874 6572 6d69 6e61 7465 645f   in (terminated_
+00038340: 6b65 792c 2074 7275 6e63 6174 6564 5f6b  key, truncated_k
+00038350: 6579 2c20 646f 6e65 5f6b 6579 293a 0d0a  ey, done_key):..
+00038360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038370: 2020 2020 646f 6e65 203d 2074 656e 736f      done = tenso
+00038380: 7264 6963 742e 6765 7428 656e 7472 795f  rdict.get(entry_
+00038390: 6e61 6d65 2c20 6465 6661 756c 743d 4e6f  name, default=No
+000383a0: 6e65 290d 0a20 2020 2020 2020 2020 2020  ne)..           
+000383b0: 2020 2020 2020 2020 2069 6620 646f 6e65           if done
+000383c0: 2069 7320 6e6f 7420 4e6f 6e65 3a0d 0a20   is not None:.. 
+000383d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000383e0: 2020 2020 2020 2062 7265 616b 0d0a 2020         break..  
+000383f0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00038400: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
+00038410: 2020 2020 2020 2020 2023 2049 7420 6d61           # It ma
+00038420: 7920 6265 2074 6865 2063 6173 6520 7468  y be the case th
+00038430: 6174 2072 6573 6574 2064 6964 206e 6f74  at reset did not
+00038440: 2070 726f 7669 6465 2061 2064 6f6e 6520   provide a done 
+00038450: 7374 6174 652c 2069 6e20 7768 6963 6820  state, in which 
+00038460: 6361 7365 0d0a 2020 2020 2020 2020 2020  case..          
+00038470: 2020 2020 2020 2020 2020 2320 7765 2066            # we f
+00038480: 616c 6c20 6261 636b 206f 6e20 7468 6520  all back on the 
+00038490: 7370 6563 0d0a 2020 2020 2020 2020 2020  spec..          
+000384a0: 2020 2020 2020 2020 2020 646f 6e65 203d            done =
+000384b0: 2073 656c 662e 7061 7265 6e74 2e6f 7574   self.parent.out
+000384c0: 7075 745f 7370 6563 5b22 6675 6c6c 5f64  put_spec["full_d
+000384d0: 6f6e 655f 7370 6563 222c 2065 6e74 7279  one_spec", entry
+000384e0: 5f6e 616d 655d 2e7a 6572 6f28 290d 0a20  _name].zero().. 
+000384f0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00038500: 6573 6574 203d 2074 6f72 6368 2e6f 6e65  eset = torch.one
+00038510: 735f 6c69 6b65 2864 6f6e 6529 0d0a 0d0a  s_like(done)....
+00038520: 2020 2020 2020 2020 2020 2020 7374 6570              step
+00038530: 5f63 6f75 6e74 203d 2074 656e 736f 7264  _count = tensord
+00038540: 6963 742e 6765 7428 7374 6570 5f63 6f75  ict.get(step_cou
+00038550: 6e74 5f6b 6579 2c20 6465 6661 756c 743d  nt_key, default=
+00038560: 4e6f 6e65 290d 0a20 2020 2020 2020 2020  None)..         
+00038570: 2020 2069 6620 7374 6570 5f63 6f75 6e74     if step_count
+00038580: 2069 7320 4e6f 6e65 3a0d 0a20 2020 2020   is None:..     
+00038590: 2020 2020 2020 2020 2020 2073 7465 705f             step_
+000385a0: 636f 756e 7420 3d20 7365 6c66 2e63 6f6e  count = self.con
+000385b0: 7461 696e 6572 2e6f 6273 6572 7661 7469  tainer.observati
+000385c0: 6f6e 5f73 7065 635b 7374 6570 5f63 6f75  on_spec[step_cou
+000385d0: 6e74 5f6b 6579 5d2e 7a65 726f 2829 0d0a  nt_key].zero()..
+000385e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000385f0: 6966 2073 7465 705f 636f 756e 742e 6465  if step_count.de
+00038600: 7669 6365 2021 3d20 7265 7365 742e 6465  vice != reset.de
+00038610: 7669 6365 3a0d 0a20 2020 2020 2020 2020  vice:..         
+00038620: 2020 2020 2020 2020 2020 2073 7465 705f             step_
+00038630: 636f 756e 7420 3d20 7374 6570 5f63 6f75  count = step_cou
+00038640: 6e74 2e74 6f28 7265 7365 742e 6465 7669  nt.to(reset.devi
+00038650: 6365 2c20 6e6f 6e5f 626c 6f63 6b69 6e67  ce, non_blocking
+00038660: 3d54 7275 6529 0d0a 0d0a 2020 2020 2020  =True)....      
+00038670: 2020 2020 2020 2320 7a65 726f 2074 6865        # zero the
+00038680: 2073 7465 7020 636f 756e 7420 6966 2072   step count if r
+00038690: 6573 6574 2069 7320 6e65 6564 6564 0d0a  eset is needed..
+000386a0: 2020 2020 2020 2020 2020 2020 7374 6570              step
+000386b0: 5f63 6f75 6e74 203d 2074 6f72 6368 2e77  _count = torch.w
+000386c0: 6865 7265 287e 6578 7061 6e64 5f61 735f  here(~expand_as_
+000386d0: 7269 6768 7428 7265 7365 742c 2073 7465  right(reset, ste
+000386e0: 705f 636f 756e 7429 2c20 7374 6570 5f63  p_count), step_c
+000386f0: 6f75 6e74 2c20 3029 0d0a 2020 2020 2020  ount, 0)..      
+00038700: 2020 2020 2020 7465 6e73 6f72 6469 6374        tensordict
+00038710: 5f72 6573 6574 2e73 6574 2873 7465 705f  _reset.set(step_
+00038720: 636f 756e 745f 6b65 792c 2073 7465 705f  count_key, step_
+00038730: 636f 756e 7429 0d0a 2020 2020 2020 2020  count)..        
+00038740: 2020 2020 6966 2073 656c 662e 6d61 785f      if self.max_
+00038750: 7374 6570 7320 6973 206e 6f74 204e 6f6e  steps is not Non
+00038760: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+00038770: 2020 2020 7472 756e 6361 7465 6420 3d20      truncated = 
+00038780: 7374 6570 5f63 6f75 6e74 203e 3d20 7365  step_count >= se
+00038790: 6c66 2e6d 6178 5f73 7465 7073 0d0a 2020  lf.max_steps..  
+000387a0: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+000387b0: 756e 6361 7465 6420 3d20 7472 756e 6361  uncated = trunca
+000387c0: 7465 6420 7c20 7465 6e73 6f72 6469 6374  ted | tensordict
+000387d0: 5f72 6573 6574 2e67 6574 2874 7275 6e63  _reset.get(trunc
+000387e0: 6174 6564 5f6b 6579 2c20 4661 6c73 6529  ated_key, False)
+000387f0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00038800: 2020 6966 2073 656c 662e 7570 6461 7465    if self.update
+00038810: 5f64 6f6e 653a 0d0a 2020 2020 2020 2020  _done:..        
+00038820: 2020 2020 2020 2020 2020 2020 2320 7765              # we
+00038830: 2061 7373 756d 6520 6e6f 2064 6f6e 6520   assume no done 
+00038840: 6166 7465 7220 7265 7365 740d 0a20 2020  after reset..   
+00038850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038860: 2074 656e 736f 7264 6963 745f 7265 7365   tensordict_rese
+00038870: 742e 7365 7428 646f 6e65 5f6b 6579 2c20  t.set(done_key, 
+00038880: 7472 756e 6361 7465 6429 0d0a 2020 2020  truncated)..    
+00038890: 2020 2020 2020 2020 2020 2020 7465 6e73              tens
+000388a0: 6f72 6469 6374 5f72 6573 6574 2e73 6574  ordict_reset.set
+000388b0: 2874 7275 6e63 6174 6564 5f6b 6579 2c20  (truncated_key, 
+000388c0: 7472 756e 6361 7465 6429 0d0a 2020 2020  truncated)..    
+000388d0: 2020 2020 7265 7475 726e 2074 656e 736f      return tenso
+000388e0: 7264 6963 745f 7265 7365 740d 0a0d 0a20  rdict_reset.... 
+000388f0: 2020 2064 6566 205f 7374 6570 280d 0a20     def _step(.. 
+00038900: 2020 2020 2020 2073 656c 662c 2074 656e         self, ten
+00038910: 736f 7264 6963 743a 2054 656e 736f 7244  sordict: TensorD
+00038920: 6963 7442 6173 652c 206e 6578 745f 7465  ictBase, next_te
+00038930: 6e73 6f72 6469 6374 3a20 5465 6e73 6f72  nsordict: Tensor
+00038940: 4469 6374 4261 7365 0d0a 2020 2020 2920  DictBase..    ) 
+00038950: 2d3e 2054 656e 736f 7244 6963 7442 6173  -> TensorDictBas
+00038960: 653a 0d0a 2020 2020 2020 2020 666f 7220  e:..        for 
+00038970: 7374 6570 5f63 6f75 6e74 5f6b 6579 2c20  step_count_key, 
+00038980: 7472 756e 6361 7465 645f 6b65 792c 2064  truncated_key, d
+00038990: 6f6e 655f 6b65 7920 696e 207a 6970 280d  one_key in zip(.
+000389a0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000389b0: 662e 7374 6570 5f63 6f75 6e74 5f6b 6579  f.step_count_key
+000389c0: 732c 0d0a 2020 2020 2020 2020 2020 2020  s,..            
+000389d0: 7365 6c66 2e74 7275 6e63 6174 6564 5f6b  self.truncated_k
+000389e0: 6579 732c 0d0a 2020 2020 2020 2020 2020  eys,..          
+000389f0: 2020 7365 6c66 2e64 6f6e 655f 6b65 7973    self.done_keys
+00038a00: 2c0d 0a20 2020 2020 2020 2029 3a0d 0a20  ,..        ):.. 
+00038a10: 2020 2020 2020 2020 2020 2073 7465 705f             step_
+00038a20: 636f 756e 7420 3d20 7465 6e73 6f72 6469  count = tensordi
+00038a30: 6374 2e67 6574 2873 7465 705f 636f 756e  ct.get(step_coun
+00038a40: 745f 6b65 7929 0d0a 2020 2020 2020 2020  t_key)..        
+00038a50: 2020 2020 6e65 7874 5f73 7465 705f 636f      next_step_co
+00038a60: 756e 7420 3d20 7374 6570 5f63 6f75 6e74  unt = step_count
+00038a70: 202b 2031 0d0a 2020 2020 2020 2020 2020   + 1..          
+00038a80: 2020 6e65 7874 5f74 656e 736f 7264 6963    next_tensordic
+00038a90: 742e 7365 7428 7374 6570 5f63 6f75 6e74  t.set(step_count
+00038aa0: 5f6b 6579 2c20 6e65 7874 5f73 7465 705f  _key, next_step_
+00038ab0: 636f 756e 7429 0d0a 0d0a 2020 2020 2020  count)....      
+00038ac0: 2020 2020 2020 6966 2073 656c 662e 6d61        if self.ma
+00038ad0: 785f 7374 6570 7320 6973 206e 6f74 204e  x_steps is not N
+00038ae0: 6f6e 653a 0d0a 2020 2020 2020 2020 2020  one:..          
+00038af0: 2020 2020 2020 7472 756e 6361 7465 6420        truncated 
+00038b00: 3d20 6e65 7874 5f73 7465 705f 636f 756e  = next_step_coun
+00038b10: 7420 3e3d 2073 656c 662e 6d61 785f 7374  t >= self.max_st
+00038b20: 6570 730d 0a20 2020 2020 2020 2020 2020  eps..           
+00038b30: 2020 2020 2074 7275 6e63 6174 6564 203d       truncated =
+00038b40: 2074 7275 6e63 6174 6564 207c 206e 6578   truncated | nex
+00038b50: 745f 7465 6e73 6f72 6469 6374 2e67 6574  t_tensordict.get
+00038b60: 2874 7275 6e63 6174 6564 5f6b 6579 2c20  (truncated_key, 
+00038b70: 4661 6c73 6529 0d0a 2020 2020 2020 2020  False)..        
+00038b80: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00038b90: 7570 6461 7465 5f64 6f6e 653a 0d0a 2020  update_done:..  
+00038ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038bb0: 2020 646f 6e65 203d 206e 6578 745f 7465    done = next_te
+00038bc0: 6e73 6f72 6469 6374 2e67 6574 2864 6f6e  nsordict.get(don
+00038bd0: 655f 6b65 792c 204e 6f6e 6529 0d0a 0d0a  e_key, None)....
+00038be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038bf0: 2020 2020 2320 7765 2063 616e 2068 6176      # we can hav
+00038c00: 6520 7465 726d 696e 6174 6564 2061 6e64  e terminated and
+00038c10: 2074 7275 6e63 6174 6564 0d0a 2020 2020   truncated..    
+00038c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038c30: 2320 7465 726d 696e 6174 6564 203d 206e  # terminated = n
+00038c40: 6578 745f 7465 6e73 6f72 6469 6374 2e67  ext_tensordict.g
+00038c50: 6574 2874 6572 6d69 6e61 7465 645f 6b65  et(terminated_ke
+00038c60: 792c 204e 6f6e 6529 0d0a 2020 2020 2020  y, None)..      
+00038c70: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00038c80: 6966 2074 6572 6d69 6e61 7465 6420 6973  if terminated is
+00038c90: 206e 6f74 204e 6f6e 653a 0d0a 2020 2020   not None:..    
+00038ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038cb0: 2320 2020 2020 7472 756e 6361 7465 6420  #     truncated 
+00038cc0: 3d20 7472 756e 6361 7465 6420 2620 7e74  = truncated & ~t
+00038cd0: 6572 6d69 6e61 7465 640d 0a0d 0a20 2020  erminated....   
+00038ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038cf0: 2064 6f6e 6520 3d20 7472 756e 6361 7465   done = truncate
+00038d00: 6420 7c20 646f 6e65 2020 2320 7765 2061  d | done  # we a
+00038d10: 7373 756d 6520 6e6f 2064 6f6e 6520 6166  ssume no done af
+00038d20: 7465 7220 7265 7365 740d 0a20 2020 2020  ter reset..     
+00038d30: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00038d40: 6578 745f 7465 6e73 6f72 6469 6374 2e73  ext_tensordict.s
+00038d50: 6574 2864 6f6e 655f 6b65 792c 2064 6f6e  et(done_key, don
+00038d60: 6529 0d0a 2020 2020 2020 2020 2020 2020  e)..            
+00038d70: 2020 2020 6e65 7874 5f74 656e 736f 7264      next_tensord
+00038d80: 6963 742e 7365 7428 7472 756e 6361 7465  ict.set(truncate
+00038d90: 645f 6b65 792c 2074 7275 6e63 6174 6564  d_key, truncated
+00038da0: 290d 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00038db0: 6e20 6e65 7874 5f74 656e 736f 7264 6963  n next_tensordic
+00038dc0: 740d 0a0d 0a20 2020 2064 6566 2074 7261  t....    def tra
+00038dd0: 6e73 666f 726d 5f6f 6273 6572 7661 7469  nsform_observati
+00038de0: 6f6e 5f73 7065 6328 0d0a 2020 2020 2020  on_spec(..      
+00038df0: 2020 7365 6c66 2c20 6f62 7365 7276 6174    self, observat
+00038e00: 696f 6e5f 7370 6563 3a20 436f 6d70 6f73  ion_spec: Compos
+00038e10: 6974 6553 7065 630d 0a20 2020 2029 202d  iteSpec..    ) -
+00038e20: 3e20 436f 6d70 6f73 6974 6553 7065 633a  > CompositeSpec:
+00038e30: 0d0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+00038e40: 2069 7369 6e73 7461 6e63 6528 6f62 7365   isinstance(obse
+00038e50: 7276 6174 696f 6e5f 7370 6563 2c20 436f  rvation_spec, Co
+00038e60: 6d70 6f73 6974 6553 7065 6329 3a0d 0a20  mpositeSpec):.. 
+00038e70: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00038e80: 2056 616c 7565 4572 726f 7228 0d0a 2020   ValueError(..  
+00038e90: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00038ea0: 6f62 7365 7276 6174 696f 6e5f 7370 6563  observation_spec
+00038eb0: 2077 6173 2065 7870 6563 7465 6420 746f   was expected to
+00038ec0: 2062 6520 6f66 2074 7970 6520 436f 6d70   be of type Comp
+00038ed0: 6f73 6974 6553 7065 632e 2047 6f74 207b  ositeSpec. Got {
+00038ee0: 7479 7065 286f 6273 6572 7661 7469 6f6e  type(observation
+00038ef0: 5f73 7065 6329 7d20 696e 7374 6561 642e  _spec)} instead.
+00038f00: 220d 0a20 2020 2020 2020 2020 2020 2029  "..            )
+00038f10: 0d0a 2020 2020 2020 2020 6675 6c6c 5f64  ..        full_d
+00038f20: 6f6e 655f 7370 6563 203d 2073 656c 662e  one_spec = self.
+00038f30: 7061 7265 6e74 2e6f 7574 7075 745f 7370  parent.output_sp
+00038f40: 6563 5b22 6675 6c6c 5f64 6f6e 655f 7370  ec["full_done_sp
+00038f50: 6563 225d 0d0a 2020 2020 2020 2020 666f  ec"]..        fo
+00038f60: 7220 7374 6570 5f63 6f75 6e74 5f6b 6579  r step_count_key
+00038f70: 2069 6e20 7365 6c66 2e73 7465 705f 636f   in self.step_co
+00038f80: 756e 745f 6b65 7973 3a0d 0a20 2020 2020  unt_keys:..     
+00038f90: 2020 2020 2020 2073 7465 705f 636f 756e         step_coun
+00038fa0: 745f 6b65 7920 3d20 756e 7261 7665 6c5f  t_key = unravel_
+00038fb0: 6b65 7928 7374 6570 5f63 6f75 6e74 5f6b  key(step_count_k
+00038fc0: 6579 290d 0a20 2020 2020 2020 2020 2020  ey)..           
+00038fd0: 2023 2066 696e 6420 6120 6d61 7463 6869   # find a matchi
+00038fe0: 6e67 2064 6f6e 6520 6b65 7920 2874 6865  ng done key (the
+00038ff0: 7265 206d 6967 6874 2062 6520 6d6f 7265  re might be more
+00039000: 2074 6861 6e20 6f6e 6529 0d0a 2020 2020   than one)..    
+00039010: 2020 2020 2020 2020 666f 7220 646f 6e65          for done
+00039020: 5f6b 6579 2069 6e20 7365 6c66 2e64 6f6e  _key in self.don
+00039030: 655f 6b65 7973 3a0d 0a20 2020 2020 2020  e_keys:..       
+00039040: 2020 2020 2020 2020 2023 2063 6865 636b           # check
+00039050: 2072 6f6f 740d 0a20 2020 2020 2020 2020   root..         
+00039060: 2020 2020 2020 2069 6620 7479 7065 2864         if type(d
+00039070: 6f6e 655f 6b65 7929 2021 3d20 7479 7065  one_key) != type
+00039080: 2873 7465 705f 636f 756e 745f 6b65 7929  (step_count_key)
+00039090: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+000390a0: 2020 2020 2020 2063 6f6e 7469 6e75 650d         continue.
+000390b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000390c0: 2069 6620 6973 696e 7374 616e 6365 2864   if isinstance(d
+000390d0: 6f6e 655f 6b65 792c 2074 7570 6c65 293a  one_key, tuple):
+000390e0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000390f0: 2020 2020 2020 6966 2064 6f6e 655f 6b65        if done_ke
+00039100: 795b 3a2d 315d 203d 3d20 7374 6570 5f63  y[:-1] == step_c
+00039110: 6f75 6e74 5f6b 6579 5b3a 2d31 5d3a 0d0a  ount_key[:-1]:..
+00039120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039130: 2020 2020 2020 2020 7368 6170 6520 3d20          shape = 
+00039140: 6675 6c6c 5f64 6f6e 655f 7370 6563 5b64  full_done_spec[d
+00039150: 6f6e 655f 6b65 795d 2e73 6861 7065 0d0a  one_key].shape..
+00039160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039170: 2020 2020 2020 2020 6272 6561 6b0d 0a20          break.. 
+00039180: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00039190: 6620 6973 696e 7374 616e 6365 2864 6f6e  f isinstance(don
+000391a0: 655f 6b65 792c 2073 7472 293a 0d0a 2020  e_key, str):..  
+000391b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000391c0: 2020 7368 6170 6520 3d20 6675 6c6c 5f64    shape = full_d
+000391d0: 6f6e 655f 7370 6563 5b64 6f6e 655f 6b65  one_spec[done_ke
+000391e0: 795d 2e73 6861 7065 0d0a 2020 2020 2020  y].shape..      
+000391f0: 2020 2020 2020 2020 2020 2020 2020 6272                br
+00039200: 6561 6b0d 0a0d 0a20 2020 2020 2020 2020  eak....         
+00039210: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
+00039220: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00039230: 4b65 7945 7272 6f72 280d 0a20 2020 2020  KeyError(..     
+00039240: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00039250: 2243 6f75 6c64 206e 6f74 2066 696e 6420  "Could not find 
+00039260: 726f 6f74 206f 6620 7374 6570 5f63 6f75  root of step_cou
+00039270: 6e74 5f6b 6579 207b 7374 6570 5f63 6f75  nt_key {step_cou
+00039280: 6e74 5f6b 6579 7d20 696e 2064 6f6e 6520  nt_key} in done 
+00039290: 6b65 7973 207b 7365 6c66 2e64 6f6e 655f  keys {self.done_
+000392a0: 6b65 7973 7d2e 220d 0a20 2020 2020 2020  keys}."..       
+000392b0: 2020 2020 2020 2020 2029 0d0a 2020 2020           )..    
+000392c0: 2020 2020 2020 2020 6f62 7365 7276 6174          observat
+000392d0: 696f 6e5f 7370 6563 5b73 7465 705f 636f  ion_spec[step_co
+000392e0: 756e 745f 6b65 795d 203d 2042 6f75 6e64  unt_key] = Bound
+000392f0: 6564 5465 6e73 6f72 5370 6563 280d 0a20  edTensorSpec(.. 
+00039300: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00039310: 6861 7065 3d73 6861 7065 2c0d 0a20 2020  hape=shape,..   
+00039320: 2020 2020 2020 2020 2020 2020 2064 7479               dty
+00039330: 7065 3d74 6f72 6368 2e69 6e74 3634 2c0d  pe=torch.int64,.
+00039340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039350: 2064 6576 6963 653d 6f62 7365 7276 6174   device=observat
+00039360: 696f 6e5f 7370 6563 2e64 6576 6963 652c  ion_spec.device,
+00039370: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00039380: 2020 6c6f 773d 302c 0d0a 2020 2020 2020    low=0,..      
+00039390: 2020 2020 2020 2020 2020 6869 6768 3d74            high=t
+000393a0: 6f72 6368 2e69 696e 666f 2874 6f72 6368  orch.iinfo(torch
+000393b0: 2e69 6e74 3634 292e 6d61 782c 0d0a 2020  .int64).max,..  
+000393c0: 2020 2020 2020 2020 2020 290d 0a20 2020            )..   
+000393d0: 2020 2020 2072 6574 7572 6e20 7375 7065       return supe
+000393e0: 7228 292e 7472 616e 7366 6f72 6d5f 6f62  r().transform_ob
+000393f0: 7365 7276 6174 696f 6e5f 7370 6563 286f  servation_spec(o
+00039400: 6273 6572 7661 7469 6f6e 5f73 7065 6329  bservation_spec)
+00039410: 0d0a 0d0a 2020 2020 6465 6620 7472 616e  ....    def tran
+00039420: 7366 6f72 6d5f 6f75 7470 7574 5f73 7065  sform_output_spe
+00039430: 6328 7365 6c66 2c20 6f75 7470 7574 5f73  c(self, output_s
+00039440: 7065 633a 2043 6f6d 706f 7369 7465 5370  pec: CompositeSp
+00039450: 6563 2920 2d3e 2043 6f6d 706f 7369 7465  ec) -> Composite
+00039460: 5370 6563 3a0d 0a20 2020 2020 2020 2069  Spec:..        i
+00039470: 6620 7365 6c66 2e6d 6178 5f73 7465 7073  f self.max_steps
+00039480: 3a0d 0a20 2020 2020 2020 2020 2020 2066  :..            f
+00039490: 756c 6c5f 646f 6e65 5f73 7065 6320 3d20  ull_done_spec = 
+000394a0: 7365 6c66 2e70 6172 656e 742e 6f75 7470  self.parent.outp
+000394b0: 7574 5f73 7065 635b 2266 756c 6c5f 646f  ut_spec["full_do
+000394c0: 6e65 5f73 7065 6322 5d0d 0a20 2020 2020  ne_spec"]..     
+000394d0: 2020 2020 2020 2066 6f72 2074 7275 6e63         for trunc
+000394e0: 6174 6564 5f6b 6579 2069 6e20 7365 6c66  ated_key in self
+000394f0: 2e74 7275 6e63 6174 6564 5f6b 6579 733a  .truncated_keys:
+00039500: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00039510: 2020 7472 756e 6361 7465 645f 6b65 7920    truncated_key 
+00039520: 3d20 756e 7261 7665 6c5f 6b65 7928 7472  = unravel_key(tr
+00039530: 756e 6361 7465 645f 6b65 7929 0d0a 2020  uncated_key)..  
+00039540: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00039550: 6669 6e64 2061 206d 6174 6368 696e 6720  find a matching 
+00039560: 646f 6e65 206b 6579 2028 7468 6572 6520  done key (there 
+00039570: 6d69 6768 7420 6265 206d 6f72 6520 7468  might be more th
+00039580: 616e 206f 6e65 290d 0a20 2020 2020 2020  an one)..       
+00039590: 2020 2020 2020 2020 2066 6f72 2064 6f6e           for don
+000395a0: 655f 6b65 7920 696e 2073 656c 662e 646f  e_key in self.do
+000395b0: 6e65 5f6b 6579 733a 0d0a 2020 2020 2020  ne_keys:..      
+000395c0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000395d0: 6368 6563 6b20 726f 6f74 0d0a 2020 2020  check root..    
+000395e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000395f0: 6966 2074 7970 6528 646f 6e65 5f6b 6579  if type(done_key
+00039600: 2920 213d 2074 7970 6528 7472 756e 6361  ) != type(trunca
+00039610: 7465 645f 6b65 7929 3a0d 0a20 2020 2020  ted_key):..     
+00039620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039630: 2020 2063 6f6e 7469 6e75 650d 0a20 2020     continue..   
+00039640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039650: 2069 6620 6973 696e 7374 616e 6365 2864   if isinstance(d
+00039660: 6f6e 655f 6b65 792c 2074 7570 6c65 293a  one_key, tuple):
+00039670: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00039680: 2020 2020 2020 2020 2020 6966 2064 6f6e            if don
+00039690: 655f 6b65 795b 3a2d 315d 203d 3d20 7472  e_key[:-1] == tr
+000396a0: 756e 6361 7465 645f 6b65 795b 3a2d 315d  uncated_key[:-1]
+000396b0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+000396c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000396d0: 6861 7065 203d 2066 756c 6c5f 646f 6e65  hape = full_done
+000396e0: 5f73 7065 635b 646f 6e65 5f6b 6579 5d2e  _spec[done_key].
+000396f0: 7368 6170 650d 0a20 2020 2020 2020 2020  shape..         
+00039700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039710: 2020 2062 7265 616b 0d0a 2020 2020 2020     break..      
+00039720: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00039730: 2069 7369 6e73 7461 6e63 6528 646f 6e65   isinstance(done
+00039740: 5f6b 6579 2c20 7374 7229 3a0d 0a20 2020  _key, str):..   
+00039750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039760: 2020 2020 2073 6861 7065 203d 2066 756c       shape = ful
+00039770: 6c5f 646f 6e65 5f73 7065 635b 646f 6e65  l_done_spec[done
+00039780: 5f6b 6579 5d2e 7368 6170 650d 0a20 2020  _key].shape..   
+00039790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000397a0: 2020 2020 2062 7265 616b 0d0a 0d0a 2020       break....  
+000397b0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+000397c0: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
+000397d0: 2020 2020 2020 2020 2072 6169 7365 204b           raise K
+000397e0: 6579 4572 726f 7228 0d0a 2020 2020 2020  eyError(..      
+000397f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039800: 2020 6622 436f 756c 6420 6e6f 7420 6669    f"Could not fi
+00039810: 6e64 2072 6f6f 7420 6f66 2074 7275 6e63  nd root of trunc
+00039820: 6174 6564 5f6b 6579 207b 7472 756e 6361  ated_key {trunca
+00039830: 7465 645f 6b65 797d 2069 6e20 646f 6e65  ted_key} in done
+00039840: 206b 6579 7320 7b73 656c 662e 646f 6e65   keys {self.done
+00039850: 5f6b 6579 737d 2e22 0d0a 2020 2020 2020  _keys}."..      
+00039860: 2020 2020 2020 2020 2020 2020 2020 290d                ).
+00039870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039880: 2066 756c 6c5f 646f 6e65 5f73 7065 635b   full_done_spec[
+00039890: 7472 756e 6361 7465 645f 6b65 795d 203d  truncated_key] =
+000398a0: 2044 6973 6372 6574 6554 656e 736f 7253   DiscreteTensorS
+000398b0: 7065 6328 0d0a 2020 2020 2020 2020 2020  pec(..          
+000398c0: 2020 2020 2020 2020 2020 322c 2064 7479            2, dty
+000398d0: 7065 3d74 6f72 6368 2e62 6f6f 6c2c 2064  pe=torch.bool, d
+000398e0: 6576 6963 653d 6f75 7470 7574 5f73 7065  evice=output_spe
+000398f0: 632e 6465 7669 6365 2c20 7368 6170 653d  c.device, shape=
+00039900: 7368 6170 650d 0a20 2020 2020 2020 2020  shape..         
+00039910: 2020 2020 2020 2029 0d0a 2020 2020 2020         )..      
+00039920: 2020 2020 2020 6966 2073 656c 662e 7570        if self.up
+00039930: 6461 7465 5f64 6f6e 653a 0d0a 2020 2020  date_done:..    
+00039940: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00039950: 646f 6e65 5f6b 6579 2069 6e20 7365 6c66  done_key in self
+00039960: 2e64 6f6e 655f 6b65 7973 3a0d 0a20 2020  .done_keys:..   
+00039970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039980: 2064 6f6e 655f 6b65 7920 3d20 756e 7261   done_key = unra
+00039990: 7665 6c5f 6b65 7928 646f 6e65 5f6b 6579  vel_key(done_key
+000399a0: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+000399b0: 2020 2020 2020 2023 2066 696e 6420 6120         # find a 
+000399c0: 6d61 7463 6869 6e67 2064 6f6e 6520 6b65  matching done ke
+000399d0: 7920 2874 6865 7265 206d 6967 6874 2062  y (there might b
+000399e0: 6520 6d6f 7265 2074 6861 6e20 6f6e 6529  e more than one)
+000399f0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00039a00: 2020 2020 2020 666f 7220 646f 6e65 5f6b        for done_k
+00039a10: 6579 2069 6e20 7365 6c66 2e64 6f6e 655f  ey in self.done_
+00039a20: 6b65 7973 3a0d 0a20 2020 2020 2020 2020  keys:..         
+00039a30: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00039a40: 2063 6865 636b 2072 6f6f 740d 0a20 2020   check root..   
 00039a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039a60: 2020 2066 756c 6c5f 646f 6e65 5f73 7065     full_done_spe
-00039a70: 635b 646f 6e65 5f6b 6579 5d20 3d20 4469  c[done_key] = Di
-00039a80: 7363 7265 7465 5465 6e73 6f72 5370 6563  screteTensorSpec
-00039a90: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
-00039aa0: 2020 2020 2020 2020 2020 2032 2c20 6474             2, dt
-00039ab0: 7970 653d 746f 7263 682e 626f 6f6c 2c20  ype=torch.bool, 
-00039ac0: 6465 7669 6365 3d6f 7574 7075 745f 7370  device=output_sp
-00039ad0: 6563 2e64 6576 6963 652c 2073 6861 7065  ec.device, shape
-00039ae0: 3d73 6861 7065 0d0a 2020 2020 2020 2020  =shape..        
-00039af0: 2020 2020 2020 2020 2020 2020 290d 0a20              ).. 
-00039b00: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
-00039b10: 745f 7370 6563 5b22 6675 6c6c 5f64 6f6e  t_spec["full_don
-00039b20: 655f 7370 6563 225d 203d 2066 756c 6c5f  e_spec"] = full_
-00039b30: 646f 6e65 5f73 7065 630d 0a20 2020 2020  done_spec..     
-00039b40: 2020 2072 6574 7572 6e20 7375 7065 7228     return super(
-00039b50: 292e 7472 616e 7366 6f72 6d5f 6f75 7470  ).transform_outp
-00039b60: 7574 5f73 7065 6328 6f75 7470 7574 5f73  ut_spec(output_s
-00039b70: 7065 6329 0d0a 0d0a 2020 2020 6465 6620  pec)....    def 
-00039b80: 7472 616e 7366 6f72 6d5f 696e 7075 745f  transform_input_
-00039b90: 7370 6563 2873 656c 662c 2069 6e70 7574  spec(self, input
-00039ba0: 5f73 7065 633a 2043 6f6d 706f 7369 7465  _spec: Composite
-00039bb0: 5370 6563 2920 2d3e 2043 6f6d 706f 7369  Spec) -> Composi
-00039bc0: 7465 5370 6563 3a0d 0a20 2020 2020 2020  teSpec:..       
-00039bd0: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
-00039be0: 6365 2869 6e70 7574 5f73 7065 632c 2043  ce(input_spec, C
-00039bf0: 6f6d 706f 7369 7465 5370 6563 293a 0d0a  ompositeSpec):..
-00039c00: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00039c10: 6520 5661 6c75 6545 7272 6f72 280d 0a20  e ValueError(.. 
-00039c20: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00039c30: 2269 6e70 7574 5f73 7065 6320 7761 7320  "input_spec was 
-00039c40: 6578 7065 6374 6564 2074 6f20 6265 206f  expected to be o
-00039c50: 6620 7479 7065 2043 6f6d 706f 7369 7465  f type Composite
-00039c60: 5370 6563 2e20 476f 7420 7b74 7970 6528  Spec. Got {type(
-00039c70: 696e 7075 745f 7370 6563 297d 2069 6e73  input_spec)} ins
-00039c80: 7465 6164 2e22 0d0a 2020 2020 2020 2020  tead."..        
-00039c90: 2020 2020 290d 0a20 2020 2020 2020 2069      )..        i
-00039ca0: 6620 696e 7075 745f 7370 6563 5b22 6675  f input_spec["fu
-00039cb0: 6c6c 5f73 7461 7465 5f73 7065 6322 5d20  ll_state_spec"] 
-00039cc0: 6973 204e 6f6e 653a 0d0a 2020 2020 2020  is None:..      
-00039cd0: 2020 2020 2020 696e 7075 745f 7370 6563        input_spec
-00039ce0: 5b22 6675 6c6c 5f73 7461 7465 5f73 7065  ["full_state_spe
-00039cf0: 6322 5d20 3d20 436f 6d70 6f73 6974 6553  c"] = CompositeS
-00039d00: 7065 6328 0d0a 2020 2020 2020 2020 2020  pec(..          
-00039d10: 2020 2020 2020 7368 6170 653d 696e 7075        shape=inpu
-00039d20: 745f 7370 6563 2e73 6861 7065 2c20 6465  t_spec.shape, de
-00039d30: 7669 6365 3d69 6e70 7574 5f73 7065 632e  vice=input_spec.
-00039d40: 6465 7669 6365 0d0a 2020 2020 2020 2020  device..        
-00039d50: 2020 2020 290d 0a0d 0a20 2020 2020 2020      )....       
-00039d60: 2066 756c 6c5f 646f 6e65 5f73 7065 6320   full_done_spec 
-00039d70: 3d20 7365 6c66 2e70 6172 656e 742e 6f75  = self.parent.ou
-00039d80: 7470 7574 5f73 7065 635b 2266 756c 6c5f  tput_spec["full_
-00039d90: 646f 6e65 5f73 7065 6322 5d0d 0a20 2020  done_spec"]..   
-00039da0: 2020 2020 2066 6f72 2073 7465 705f 636f       for step_co
-00039db0: 756e 745f 6b65 7920 696e 2073 656c 662e  unt_key in self.
-00039dc0: 7374 6570 5f63 6f75 6e74 5f6b 6579 733a  step_count_keys:
-00039dd0: 0d0a 2020 2020 2020 2020 2020 2020 7374  ..            st
-00039de0: 6570 5f63 6f75 6e74 5f6b 6579 203d 2075  ep_count_key = u
-00039df0: 6e72 6176 656c 5f6b 6579 2873 7465 705f  nravel_key(step_
-00039e00: 636f 756e 745f 6b65 7929 0d0a 2020 2020  count_key)..    
-00039e10: 2020 2020 2020 2020 2320 6669 6e64 2061          # find a
-00039e20: 206d 6174 6368 696e 6720 646f 6e65 206b   matching done k
-00039e30: 6579 2028 7468 6572 6520 6d69 6768 7420  ey (there might 
-00039e40: 6265 206d 6f72 6520 7468 616e 206f 6e65  be more than one
-00039e50: 290d 0a20 2020 2020 2020 2020 2020 2066  )..            f
-00039e60: 6f72 2064 6f6e 655f 6b65 7920 696e 2073  or done_key in s
-00039e70: 656c 662e 646f 6e65 5f6b 6579 733a 0d0a  elf.done_keys:..
-00039e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039e90: 2320 6368 6563 6b20 726f 6f74 0d0a 2020  # check root..  
-00039ea0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00039eb0: 2074 7970 6528 646f 6e65 5f6b 6579 2920   type(done_key) 
-00039ec0: 213d 2074 7970 6528 7374 6570 5f63 6f75  != type(step_cou
-00039ed0: 6e74 5f6b 6579 293a 0d0a 2020 2020 2020  nt_key):..      
-00039ee0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00039ef0: 6e74 696e 7565 0d0a 2020 2020 2020 2020  ntinue..        
-00039f00: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00039f10: 7461 6e63 6528 646f 6e65 5f6b 6579 2c20  tance(done_key, 
-00039f20: 7475 706c 6529 3a0d 0a20 2020 2020 2020  tuple):..       
-00039f30: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00039f40: 646f 6e65 5f6b 6579 5b3a 2d31 5d20 3d3d  done_key[:-1] ==
-00039f50: 2073 7465 705f 636f 756e 745f 6b65 795b   step_count_key[
-00039f60: 3a2d 315d 3a0d 0a20 2020 2020 2020 2020  :-1]:..         
-00039f70: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00039f80: 6861 7065 203d 2066 756c 6c5f 646f 6e65  hape = full_done
-00039f90: 5f73 7065 635b 646f 6e65 5f6b 6579 5d2e  _spec[done_key].
-00039fa0: 7368 6170 650d 0a20 2020 2020 2020 2020  shape..         
-00039fb0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00039fc0: 7265 616b 0d0a 2020 2020 2020 2020 2020  reak..          
-00039fd0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00039fe0: 6e63 6528 646f 6e65 5f6b 6579 2c20 7374  nce(done_key, st
-00039ff0: 7229 3a0d 0a20 2020 2020 2020 2020 2020  r):..           
-0003a000: 2020 2020 2020 2020 2073 6861 7065 203d           shape =
-0003a010: 2066 756c 6c5f 646f 6e65 5f73 7065 635b   full_done_spec[
-0003a020: 646f 6e65 5f6b 6579 5d2e 7368 6170 650d  done_key].shape.
-0003a030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003a040: 2020 2020 2062 7265 616b 0d0a 0d0a 2020       break....  
-0003a050: 2020 2020 2020 2020 2020 656c 7365 3a0d            else:.
-0003a060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003a070: 2072 6169 7365 204b 6579 4572 726f 7228   raise KeyError(
-0003a080: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0003a090: 2020 2020 2020 6622 436f 756c 6420 6e6f        f"Could no
-0003a0a0: 7420 6669 6e64 2072 6f6f 7420 6f66 2073  t find root of s
-0003a0b0: 7465 705f 636f 756e 745f 6b65 7920 7b73  tep_count_key {s
-0003a0c0: 7465 705f 636f 756e 745f 6b65 797d 2069  tep_count_key} i
-0003a0d0: 6e20 646f 6e65 206b 6579 7320 7b73 656c  n done keys {sel
-0003a0e0: 662e 646f 6e65 5f6b 6579 737d 2e22 0d0a  f.done_keys}."..
-0003a0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a100: 290d 0a0d 0a20 2020 2020 2020 2020 2020  )....           
-0003a110: 2069 6e70 7574 5f73 7065 635b 0d0a 2020   input_spec[..  
-0003a120: 2020 2020 2020 2020 2020 2020 2020 756e                un
-0003a130: 7261 7665 6c5f 6b65 7928 2822 6675 6c6c  ravel_key(("full
-0003a140: 5f73 7461 7465 5f73 7065 6322 2c20 7374  _state_spec", st
-0003a150: 6570 5f63 6f75 6e74 5f6b 6579 2929 0d0a  ep_count_key))..
-0003a160: 2020 2020 2020 2020 2020 2020 5d20 3d20              ] = 
-0003a170: 426f 756e 6465 6454 656e 736f 7253 7065  BoundedTensorSpe
-0003a180: 6328 0d0a 2020 2020 2020 2020 2020 2020  c(..            
-0003a190: 2020 2020 7368 6170 653d 7368 6170 652c      shape=shape,
-0003a1a0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0003a1b0: 2020 6474 7970 653d 746f 7263 682e 696e    dtype=torch.in
-0003a1c0: 7436 342c 0d0a 2020 2020 2020 2020 2020  t64,..          
-0003a1d0: 2020 2020 2020 6465 7669 6365 3d69 6e70        device=inp
-0003a1e0: 7574 5f73 7065 632e 6465 7669 6365 2c0d  ut_spec.device,.
-0003a1f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003a200: 206c 6f77 3d30 2c0d 0a20 2020 2020 2020   low=0,..       
-0003a210: 2020 2020 2020 2020 2068 6967 683d 746f           high=to
-0003a220: 7263 682e 6969 6e66 6f28 746f 7263 682e  rch.iinfo(torch.
-0003a230: 696e 7436 3429 2e6d 6178 2c0d 0a20 2020  int64).max,..   
-0003a240: 2020 2020 2020 2020 2029 0d0a 0d0a 2020           )....  
-0003a250: 2020 2020 2020 7265 7475 726e 2069 6e70        return inp
-0003a260: 7574 5f73 7065 630d 0a0d 0a20 2020 2064  ut_spec....    d
-0003a270: 6566 2066 6f72 7761 7264 2873 656c 662c  ef forward(self,
-0003a280: 2074 656e 736f 7264 6963 743a 2054 656e   tensordict: Ten
-0003a290: 736f 7244 6963 7442 6173 6529 202d 3e20  sorDictBase) -> 
-0003a2a0: 5465 6e73 6f72 4469 6374 4261 7365 3a0d  TensorDictBase:.
-0003a2b0: 0a20 2020 2020 2020 2072 6169 7365 204e  .        raise N
-0003a2c0: 6f74 496d 706c 656d 656e 7465 6445 7272  otImplementedErr
-0003a2d0: 6f72 280d 0a20 2020 2020 2020 2020 2020  or(..           
-0003a2e0: 2022 5374 6570 436f 756e 7465 7220 6361   "StepCounter ca
-0003a2f0: 6e6e 6f74 2062 6520 6361 6c6c 6564 2069  nnot be called i
-0003a300: 6e64 6570 656e 6465 6e74 6c79 2c20 6f6e  ndependently, on
-0003a310: 6c79 2069 7473 2073 7465 7020 616e 6420  ly its step and 
-0003a320: 7265 7365 7420 6d65 7468 6f64 7320 220d  reset methods ".
-0003a330: 0a20 2020 2020 2020 2020 2020 2022 6172  .            "ar
-0003a340: 6520 6675 6e63 7469 6f6e 616c 2e20 5468  e functional. Th
-0003a350: 6520 7265 6173 6f6e 2066 6f72 2074 6869  e reason for thi
-0003a360: 7320 6973 2074 6861 7420 6974 2069 7320  s is that it is 
-0003a370: 6861 7264 2074 6f20 636f 6e73 6964 6572  hard to consider
-0003a380: 2075 7369 6e67 2022 0d0a 2020 2020 2020   using "..      
-0003a390: 2020 2020 2020 2253 7465 7043 6f75 6e74        "StepCount
-0003a3a0: 6572 2077 6974 6820 6e6f 6e2d 7365 7175  er with non-sequ
-0003a3b0: 656e 7469 616c 2064 6174 612c 2073 7563  ential data, suc
-0003a3c0: 6820 6173 2074 686f 7365 2063 6f6c 6c65  h as those colle
-0003a3d0: 6374 6564 2062 7920 6120 7265 706c 6179  cted by a replay
-0003a3e0: 2062 7566 6665 7220 220d 0a20 2020 2020   buffer "..     
-0003a3f0: 2020 2020 2020 2022 6f72 2061 2064 6174         "or a dat
-0003a400: 6173 6574 2e20 4966 2079 6f75 206e 6565  aset. If you nee
-0003a410: 6420 5374 6570 436f 756e 7465 7220 746f  d StepCounter to
-0003a420: 2077 6f72 6b20 6f6e 2061 2062 6174 6368   work on a batch
-0003a430: 206f 6620 7365 7175 656e 7469 616c 2064   of sequential d
-0003a440: 6174 6120 220d 0a20 2020 2020 2020 2020  ata "..         
-0003a450: 2020 2022 2869 6520 6173 204c 5354 4d20     "(ie as LSTM 
-0003a460: 776f 756c 6420 776f 726b 206f 7665 7220  would work over 
-0003a470: 6120 7768 6f6c 6520 7365 7175 656e 6365  a whole sequence
-0003a480: 206f 6620 6461 7461 292c 2066 696c 6520   of data), file 
-0003a490: 616e 2069 7373 7565 206f 6e20 220d 0a20  an issue on ".. 
-0003a4a0: 2020 2020 2020 2020 2020 2022 546f 7263             "Torc
-0003a4b0: 6852 4c20 7265 7175 6573 7469 6e67 2074  hRL requesting t
-0003a4c0: 6861 7420 6665 6174 7572 652e 220d 0a20  hat feature.".. 
-0003a4d0: 2020 2020 2020 2029 0d0a 0d0a 0d0a 636c         )......cl
-0003a4e0: 6173 7320 4578 636c 7564 6554 7261 6e73  ass ExcludeTrans
-0003a4f0: 666f 726d 2854 7261 6e73 666f 726d 293a  form(Transform):
-0003a500: 0d0a 2020 2020 2222 2245 7863 6c75 6465  ..    """Exclude
-0003a510: 7320 6b65 7973 2066 726f 6d20 7468 6520  s keys from the 
-0003a520: 6461 7461 2e0d 0a0d 0a20 2020 2041 7267  data.....    Arg
-0003a530: 733a 0d0a 2020 2020 2020 2020 2a65 7863  s:..        *exc
-0003a540: 6c75 6465 645f 6b65 7973 2028 6974 6572  luded_keys (iter
-0003a550: 6162 6c65 206f 6620 4e65 7374 6564 4b65  able of NestedKe
-0003a560: 7929 3a20 5468 6520 6e61 6d65 206f 6620  y): The name of 
-0003a570: 7468 6520 6b65 7973 2074 6f20 6578 636c  the keys to excl
-0003a580: 7564 652e 2049 6620 7468 6520 6b65 7920  ude. If the key 
-0003a590: 6973 0d0a 2020 2020 2020 2020 2020 2020  is..            
-0003a5a0: 6e6f 7420 7072 6573 656e 742c 2069 7420  not present, it 
-0003a5b0: 6973 2073 696d 706c 7920 6967 6e6f 7265  is simply ignore
-0003a5c0: 642e 0d0a 2020 2020 2020 2020 696e 7665  d...        inve
-0003a5d0: 7273 6520 2862 6f6f 6c2c 206f 7074 696f  rse (bool, optio
-0003a5e0: 6e61 6c29 3a20 6966 2060 6054 7275 6560  nal): if ``True`
-0003a5f0: 602c 2074 6865 2065 7863 6c75 7369 6f6e  `, the exclusion
-0003a600: 2077 696c 6c20 6f63 6375 7220 6475 7269   will occur duri
-0003a610: 6e67 2074 6865 2060 6069 6e76 6060 2063  ng the ``inv`` c
-0003a620: 616c 6c2e 0d0a 2020 2020 2020 2020 2020  all...          
-0003a630: 2020 4465 6661 756c 7473 2074 6f20 6060    Defaults to ``
-0003a640: 4661 6c73 6560 602e 0d0a 0d0a 2020 2020  False``.....    
-0003a650: 4578 616d 706c 6573 3a0d 0a20 2020 2020  Examples:..     
-0003a660: 2020 203e 3e3e 2069 6d70 6f72 7420 6779     >>> import gy
-0003a670: 6d6e 6173 6975 6d0d 0a20 2020 2020 2020  mnasium..       
-0003a680: 203e 3e3e 2066 726f 6d20 746f 7263 6872   >>> from torchr
-0003a690: 6c2e 656e 7673 2069 6d70 6f72 7420 4779  l.envs import Gy
-0003a6a0: 6d57 7261 7070 6572 0d0a 2020 2020 2020  mWrapper..      
-0003a6b0: 2020 3e3e 3e20 656e 7620 3d20 5472 616e    >>> env = Tran
-0003a6c0: 7366 6f72 6d65 6445 6e76 280d 0a20 2020  sformedEnv(..   
-0003a6d0: 2020 2020 202e 2e2e 2020 2020 2047 796d       ...     Gym
-0003a6e0: 5772 6170 7065 7228 6779 6d6e 6173 6975  Wrapper(gymnasiu
-0003a6f0: 6d2e 6d61 6b65 2822 5065 6e64 756c 756d  m.make("Pendulum
-0003a700: 2d76 3122 2929 2c0d 0a20 2020 2020 2020  -v1")),..       
-0003a710: 202e 2e2e 2020 2020 2045 7863 6c75 6465   ...     Exclude
-0003a720: 5472 616e 7366 6f72 6d28 2274 7275 6e63  Transform("trunc
-0003a730: 6174 6564 2229 0d0a 2020 2020 2020 2020  ated")..        
-0003a740: 2e2e 2e20 290d 0a20 2020 2020 2020 203e  ... )..        >
-0003a750: 3e3e 2065 6e76 2e72 6f6c 6c6f 7574 2833  >> env.rollout(3
-0003a760: 290d 0a20 2020 2020 2020 2054 656e 736f  )..        Tenso
-0003a770: 7244 6963 7428 0d0a 2020 2020 2020 2020  rDict(..        
-0003a780: 2020 2020 6669 656c 6473 3d7b 0d0a 2020      fields={..  
-0003a790: 2020 2020 2020 2020 2020 2020 2020 6163                ac
-0003a7a0: 7469 6f6e 3a20 5465 6e73 6f72 2873 6861  tion: Tensor(sha
-0003a7b0: 7065 3d74 6f72 6368 2e53 697a 6528 5b33  pe=torch.Size([3
-0003a7c0: 2c20 315d 292c 2064 6576 6963 653d 6370  , 1]), device=cp
-0003a7d0: 752c 2064 7479 7065 3d74 6f72 6368 2e66  u, dtype=torch.f
-0003a7e0: 6c6f 6174 3332 2c20 6973 5f73 6861 7265  loat32, is_share
-0003a7f0: 643d 4661 6c73 6529 2c0d 0a20 2020 2020  d=False),..     
-0003a800: 2020 2020 2020 2020 2020 2064 6f6e 653a             done:
-0003a810: 2054 656e 736f 7228 7368 6170 653d 746f   Tensor(shape=to
-0003a820: 7263 682e 5369 7a65 285b 332c 2031 5d29  rch.Size([3, 1])
-0003a830: 2c20 6465 7669 6365 3d63 7075 2c20 6474  , device=cpu, dt
-0003a840: 7970 653d 746f 7263 682e 626f 6f6c 2c20  ype=torch.bool, 
-0003a850: 6973 5f73 6861 7265 643d 4661 6c73 6529  is_shared=False)
-0003a860: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
-0003a870: 2020 206e 6578 743a 2054 656e 736f 7244     next: TensorD
-0003a880: 6963 7428 0d0a 2020 2020 2020 2020 2020  ict(..          
-0003a890: 2020 2020 2020 2020 2020 6669 656c 6473            fields
-0003a8a0: 3d7b 0d0a 2020 2020 2020 2020 2020 2020  ={..            
-0003a8b0: 2020 2020 2020 2020 2020 2020 646f 6e65              done
-0003a8c0: 3a20 5465 6e73 6f72 2873 6861 7065 3d74  : Tensor(shape=t
-0003a8d0: 6f72 6368 2e53 697a 6528 5b33 2c20 315d  orch.Size([3, 1]
-0003a8e0: 292c 2064 6576 6963 653d 6370 752c 2064  ), device=cpu, d
-0003a8f0: 7479 7065 3d74 6f72 6368 2e62 6f6f 6c2c  type=torch.bool,
-0003a900: 2069 735f 7368 6172 6564 3d46 616c 7365   is_shared=False
-0003a910: 292c 0d0a 2020 2020 2020 2020 2020 2020  ),..            
-0003a920: 2020 2020 2020 2020 2020 2020 6f62 7365              obse
-0003a930: 7276 6174 696f 6e3a 2054 656e 736f 7228  rvation: Tensor(
-0003a940: 7368 6170 653d 746f 7263 682e 5369 7a65  shape=torch.Size
-0003a950: 285b 332c 2033 5d29 2c20 6465 7669 6365  ([3, 3]), device
-0003a960: 3d63 7075 2c20 6474 7970 653d 746f 7263  =cpu, dtype=torc
-0003a970: 682e 666c 6f61 7433 322c 2069 735f 7368  h.float32, is_sh
-0003a980: 6172 6564 3d46 616c 7365 292c 0d0a 2020  ared=False),..  
-0003a990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a9a0: 2020 2020 2020 7265 7761 7264 3a20 5465        reward: Te
-0003a9b0: 6e73 6f72 2873 6861 7065 3d74 6f72 6368  nsor(shape=torch
-0003a9c0: 2e53 697a 6528 5b33 2c20 315d 292c 2064  .Size([3, 1]), d
-0003a9d0: 6576 6963 653d 6370 752c 2064 7479 7065  evice=cpu, dtype
-0003a9e0: 3d74 6f72 6368 2e66 6c6f 6174 3332 2c20  =torch.float32, 
-0003a9f0: 6973 5f73 6861 7265 643d 4661 6c73 6529  is_shared=False)
-0003aa00: 7d2c 0d0a 2020 2020 2020 2020 2020 2020  },..            
-0003aa10: 2020 2020 2020 2020 6261 7463 685f 7369          batch_si
-0003aa20: 7a65 3d74 6f72 6368 2e53 697a 6528 5b33  ze=torch.Size([3
-0003aa30: 5d29 2c0d 0a20 2020 2020 2020 2020 2020  ]),..           
-0003aa40: 2020 2020 2020 2020 2064 6576 6963 653d           device=
-0003aa50: 6370 752c 0d0a 2020 2020 2020 2020 2020  cpu,..          
-0003aa60: 2020 2020 2020 2020 2020 6973 5f73 6861            is_sha
-0003aa70: 7265 643d 4661 6c73 6529 2c0d 0a20 2020  red=False),..   
-0003aa80: 2020 2020 2020 2020 2020 2020 206f 6273               obs
-0003aa90: 6572 7661 7469 6f6e 3a20 5465 6e73 6f72  ervation: Tensor
-0003aaa0: 2873 6861 7065 3d74 6f72 6368 2e53 697a  (shape=torch.Siz
-0003aab0: 6528 5b33 2c20 335d 292c 2064 6576 6963  e([3, 3]), devic
-0003aac0: 653d 6370 752c 2064 7479 7065 3d74 6f72  e=cpu, dtype=tor
-0003aad0: 6368 2e66 6c6f 6174 3332 2c20 6973 5f73  ch.float32, is_s
-0003aae0: 6861 7265 643d 4661 6c73 6529 7d2c 0d0a  hared=False)},..
-0003aaf0: 2020 2020 2020 2020 2020 2020 6261 7463              batc
-0003ab00: 685f 7369 7a65 3d74 6f72 6368 2e53 697a  h_size=torch.Siz
-0003ab10: 6528 5b33 5d29 2c0d 0a20 2020 2020 2020  e([3]),..       
-0003ab20: 2020 2020 2064 6576 6963 653d 6370 752c       device=cpu,
-0003ab30: 0d0a 2020 2020 2020 2020 2020 2020 6973  ..            is
-0003ab40: 5f73 6861 7265 643d 4661 6c73 6529 0d0a  _shared=False)..
-0003ab50: 0d0a 2020 2020 2222 220d 0a0d 0a20 2020  ..    """....   
-0003ab60: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-0003ab70: 6c66 2c20 2a65 7863 6c75 6465 645f 6b65  lf, *excluded_ke
-0003ab80: 7973 2c20 696e 7665 7273 653a 2062 6f6f  ys, inverse: boo
-0003ab90: 6c20 3d20 4661 6c73 6529 3a0d 0a20 2020  l = False):..   
-0003aba0: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
-0003abb0: 6e69 745f 5f28 290d 0a20 2020 2020 2020  nit__()..       
-0003abc0: 2074 7279 3a0d 0a20 2020 2020 2020 2020   try:..         
-0003abd0: 2020 2065 7863 6c75 6465 645f 6b65 7973     excluded_keys
-0003abe0: 203d 2075 6e72 6176 656c 5f6b 6579 5f6c   = unravel_key_l
-0003abf0: 6973 7428 6578 636c 7564 6564 5f6b 6579  ist(excluded_key
-0003ac00: 7329 0d0a 2020 2020 2020 2020 6578 6365  s)..        exce
-0003ac10: 7074 2054 7970 6545 7272 6f72 3a0d 0a20  pt TypeError:.. 
-0003ac20: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0003ac30: 2054 7970 6545 7272 6f72 280d 0a20 2020   TypeError(..   
-0003ac40: 2020 2020 2020 2020 2020 2020 2022 6578               "ex
-0003ac50: 636c 7564 6564 206b 6579 7320 6d75 7374  cluded keys must
-0003ac60: 2062 6520 6120 6c69 7374 206f 7220 7475   be a list or tu
-0003ac70: 706c 6520 6f66 2073 7472 696e 6773 206f  ple of strings o
-0003ac80: 7220 7475 706c 6573 206f 6620 7374 7269  r tuples of stri
-0003ac90: 6e67 732e 220d 0a20 2020 2020 2020 2020  ngs."..         
-0003aca0: 2020 2029 0d0a 2020 2020 2020 2020 7365     )..        se
-0003acb0: 6c66 2e65 7863 6c75 6465 645f 6b65 7973  lf.excluded_keys
-0003acc0: 203d 2065 7863 6c75 6465 645f 6b65 7973   = excluded_keys
-0003acd0: 0d0a 2020 2020 2020 2020 7365 6c66 2e69  ..        self.i
-0003ace0: 6e76 6572 7365 203d 2069 6e76 6572 7365  nverse = inverse
-0003acf0: 0d0a 0d0a 2020 2020 6465 6620 5f63 616c  ....    def _cal
-0003ad00: 6c28 7365 6c66 2c20 7465 6e73 6f72 6469  l(self, tensordi
-0003ad10: 6374 3a20 5465 6e73 6f72 4469 6374 4261  ct: TensorDictBa
-0003ad20: 7365 2920 2d3e 2054 656e 736f 7244 6963  se) -> TensorDic
-0003ad30: 7442 6173 653a 0d0a 2020 2020 2020 2020  tBase:..        
-0003ad40: 6966 206e 6f74 2073 656c 662e 696e 7665  if not self.inve
-0003ad50: 7273 653a 0d0a 2020 2020 2020 2020 2020  rse:..          
-0003ad60: 2020 7265 7475 726e 2074 656e 736f 7264    return tensord
-0003ad70: 6963 742e 6578 636c 7564 6528 2a73 656c  ict.exclude(*sel
-0003ad80: 662e 6578 636c 7564 6564 5f6b 6579 7329  f.excluded_keys)
-0003ad90: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-0003ada0: 2074 656e 736f 7264 6963 740d 0a0d 0a20   tensordict.... 
-0003adb0: 2020 2064 6566 205f 696e 765f 6361 6c6c     def _inv_call
-0003adc0: 2873 656c 662c 2074 656e 736f 7264 6963  (self, tensordic
-0003add0: 743a 2054 656e 736f 7244 6963 7442 6173  t: TensorDictBas
-0003ade0: 6529 202d 3e20 5465 6e73 6f72 4469 6374  e) -> TensorDict
-0003adf0: 4261 7365 3a0d 0a20 2020 2020 2020 2069  Base:..        i
-0003ae00: 6620 7365 6c66 2e69 6e76 6572 7365 3a0d  f self.inverse:.
-0003ae10: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0003ae20: 7572 6e20 7465 6e73 6f72 6469 6374 2e65  urn tensordict.e
-0003ae30: 7863 6c75 6465 282a 7365 6c66 2e65 7863  xclude(*self.exc
-0003ae40: 6c75 6465 645f 6b65 7973 290d 0a20 2020  luded_keys)..   
-0003ae50: 2020 2020 2072 6574 7572 6e20 7465 6e73       return tens
-0003ae60: 6f72 6469 6374 0d0a 0d0a 2020 2020 666f  ordict....    fo
-0003ae70: 7277 6172 6420 3d20 5f63 616c 6c0d 0a0d  rward = _call...
-0003ae80: 0a20 2020 2064 6566 205f 7265 7365 7428  .    def _reset(
-0003ae90: 0d0a 2020 2020 2020 2020 7365 6c66 2c20  ..        self, 
-0003aea0: 7465 6e73 6f72 6469 6374 3a20 5465 6e73  tensordict: Tens
-0003aeb0: 6f72 4469 6374 4261 7365 2c20 7465 6e73  orDictBase, tens
-0003aec0: 6f72 6469 6374 5f72 6573 6574 3a20 5465  ordict_reset: Te
-0003aed0: 6e73 6f72 4469 6374 4261 7365 0d0a 2020  nsorDictBase..  
-0003aee0: 2020 2920 2d3e 2054 656e 736f 7244 6963    ) -> TensorDic
-0003aef0: 7442 6173 653a 0d0a 2020 2020 2020 2020  tBase:..        
-0003af00: 6966 206e 6f74 2073 656c 662e 696e 7665  if not self.inve
-0003af10: 7273 653a 0d0a 2020 2020 2020 2020 2020  rse:..          
-0003af20: 2020 7265 7475 726e 2074 656e 736f 7264    return tensord
-0003af30: 6963 745f 7265 7365 742e 6578 636c 7564  ict_reset.exclud
-0003af40: 6528 2a73 656c 662e 6578 636c 7564 6564  e(*self.excluded
-0003af50: 5f6b 6579 7329 0d0a 2020 2020 2020 2020  _keys)..        
-0003af60: 7265 7475 726e 2074 656e 736f 7264 6963  return tensordic
-0003af70: 740d 0a0d 0a20 2020 2064 6566 2074 7261  t....    def tra
-0003af80: 6e73 666f 726d 5f6f 7574 7075 745f 7370  nsform_output_sp
-0003af90: 6563 2873 656c 662c 206f 7574 7075 745f  ec(self, output_
-0003afa0: 7370 6563 3a20 436f 6d70 6f73 6974 6553  spec: CompositeS
-0003afb0: 7065 6329 202d 3e20 436f 6d70 6f73 6974  pec) -> Composit
-0003afc0: 6553 7065 633a 0d0a 2020 2020 2020 2020  eSpec:..        
-0003afd0: 6966 206e 6f74 2073 656c 662e 696e 7665  if not self.inve
-0003afe0: 7273 653a 0d0a 2020 2020 2020 2020 2020  rse:..          
-0003aff0: 2020 6675 6c6c 5f64 6f6e 655f 7370 6563    full_done_spec
-0003b000: 203d 206f 7574 7075 745f 7370 6563 5b22   = output_spec["
-0003b010: 6675 6c6c 5f64 6f6e 655f 7370 6563 225d  full_done_spec"]
-0003b020: 0d0a 2020 2020 2020 2020 2020 2020 6675  ..            fu
-0003b030: 6c6c 5f72 6577 6172 645f 7370 6563 203d  ll_reward_spec =
-0003b040: 206f 7574 7075 745f 7370 6563 5b22 6675   output_spec["fu
-0003b050: 6c6c 5f72 6577 6172 645f 7370 6563 225d  ll_reward_spec"]
-0003b060: 0d0a 2020 2020 2020 2020 2020 2020 6675  ..            fu
-0003b070: 6c6c 5f6f 6273 6572 7661 7469 6f6e 5f73  ll_observation_s
-0003b080: 7065 6320 3d20 6f75 7470 7574 5f73 7065  pec = output_spe
-0003b090: 635b 2266 756c 6c5f 6f62 7365 7276 6174  c["full_observat
-0003b0a0: 696f 6e5f 7370 6563 225d 0d0a 2020 2020  ion_spec"]..    
-0003b0b0: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
-0003b0c0: 696e 2073 656c 662e 6578 636c 7564 6564  in self.excluded
-0003b0d0: 5f6b 6579 733a 0d0a 2020 2020 2020 2020  _keys:..        
-0003b0e0: 2020 2020 2020 2020 2320 646f 6e65 5f73          # done_s
-0003b0f0: 7065 630d 0a20 2020 2020 2020 2020 2020  pec..           
-0003b100: 2020 2020 2069 6620 756e 7261 7665 6c5f       if unravel_
-0003b110: 6b65 7928 6b65 7929 2069 6e20 6c69 7374  key(key) in list
-0003b120: 2866 756c 6c5f 646f 6e65 5f73 7065 632e  (full_done_spec.
-0003b130: 6b65 7973 2854 7275 652c 2054 7275 6529  keys(True, True)
-0003b140: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
-0003b150: 2020 2020 2020 2020 6465 6c20 6675 6c6c          del full
-0003b160: 5f64 6f6e 655f 7370 6563 5b6b 6579 5d0d  _done_spec[key].
-0003b170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003b180: 2020 2020 2063 6f6e 7469 6e75 650d 0a20       continue.. 
-0003b190: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0003b1a0: 2072 6577 6172 645f 7370 6563 0d0a 2020   reward_spec..  
-0003b1b0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0003b1c0: 2075 6e72 6176 656c 5f6b 6579 286b 6579   unravel_key(key
-0003b1d0: 2920 696e 206c 6973 7428 6675 6c6c 5f72  ) in list(full_r
-0003b1e0: 6577 6172 645f 7370 6563 2e6b 6579 7328  eward_spec.keys(
-0003b1f0: 5472 7565 2c20 5472 7565 2929 3a0d 0a20  True, True)):.. 
-0003b200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b210: 2020 2064 656c 2066 756c 6c5f 7265 7761     del full_rewa
-0003b220: 7264 5f73 7065 635b 6b65 795d 0d0a 2020  rd_spec[key]..  
-0003b230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b240: 2020 636f 6e74 696e 7565 0d0a 2020 2020    continue..    
-0003b250: 2020 2020 2020 2020 2020 2020 2320 6f62              # ob
-0003b260: 7365 7276 6174 696f 6e5f 7370 6563 0d0a  servation_spec..
-0003b270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b280: 6966 2075 6e72 6176 656c 5f6b 6579 286b  if unravel_key(k
-0003b290: 6579 2920 696e 206c 6973 7428 6675 6c6c  ey) in list(full
-0003b2a0: 5f6f 6273 6572 7661 7469 6f6e 5f73 7065  _observation_spe
-0003b2b0: 632e 6b65 7973 2854 7275 652c 2054 7275  c.keys(True, Tru
-0003b2c0: 6529 293a 0d0a 2020 2020 2020 2020 2020  e)):..          
-0003b2d0: 2020 2020 2020 2020 2020 6465 6c20 6675            del fu
-0003b2e0: 6c6c 5f6f 6273 6572 7661 7469 6f6e 5f73  ll_observation_s
-0003b2f0: 7065 635b 6b65 795d 0d0a 2020 2020 2020  pec[key]..      
-0003b300: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0003b310: 6e74 696e 7565 0d0a 2020 2020 2020 2020  ntinue..        
-0003b320: 2020 2020 2020 2020 7261 6973 6520 4b65          raise Ke
-0003b330: 7945 7272 6f72 2866 224b 6579 207b 6b65  yError(f"Key {ke
-0003b340: 797d 206e 6f74 2066 6f75 6e64 2069 6e20  y} not found in 
-0003b350: 7468 6520 656e 7669 726f 6e6d 656e 7420  the environment 
-0003b360: 6f75 7470 7574 732e 2229 0d0a 2020 2020  outputs.")..    
-0003b370: 2020 2020 7265 7475 726e 206f 7574 7075      return outpu
-0003b380: 745f 7370 6563 0d0a 0d0a 0d0a 636c 6173  t_spec......clas
-0003b390: 7320 5365 6c65 6374 5472 616e 7366 6f72  s SelectTransfor
-0003b3a0: 6d28 5472 616e 7366 6f72 6d29 3a0d 0a20  m(Transform):.. 
-0003b3b0: 2020 2022 2222 5365 6c65 6374 206b 6579     """Select key
-0003b3c0: 7320 6672 6f6d 2074 6865 2069 6e70 7574  s from the input
-0003b3d0: 2074 656e 736f 7264 6963 742e 0d0a 0d0a   tensordict.....
-0003b3e0: 2020 2020 496e 2067 656e 6572 616c 2c20      In general, 
-0003b3f0: 7468 6520 3a6f 626a 3a60 4578 636c 7564  the :obj:`Exclud
-0003b400: 6554 7261 6e73 666f 726d 6020 7368 6f75  eTransform` shou
-0003b410: 6c64 2062 6520 7072 6566 6572 7265 643a  ld be preferred:
-0003b420: 2074 6869 7320 7472 616e 7366 6f72 6d73   this transforms
-0003b430: 2061 6c73 6f0d 0a20 2020 2020 2020 2073   also..        s
-0003b440: 656c 6563 7473 2074 6865 2022 6163 7469  elects the "acti
-0003b450: 6f6e 2220 286f 7220 6f74 6865 7220 6b65  on" (or other ke
-0003b460: 7973 2066 726f 6d20 696e 7075 745f 7370  ys from input_sp
-0003b470: 6563 292c 2022 646f 6e65 2220 616e 6420  ec), "done" and 
-0003b480: 2272 6577 6172 6422 0d0a 2020 2020 2020  "reward"..      
-0003b490: 2020 6b65 7973 2062 7574 206f 7468 6572    keys but other
-0003b4a0: 206d 6179 2062 6520 6e65 6365 7373 6172   may be necessar
-0003b4b0: 792e 0d0a 0d0a 2020 2020 4172 6773 3a0d  y.....    Args:.
-0003b4c0: 0a20 2020 2020 2020 202a 7365 6c65 6374  .        *select
-0003b4d0: 6564 5f6b 6579 7320 2869 7465 7261 626c  ed_keys (iterabl
-0003b4e0: 6520 6f66 204e 6573 7465 644b 6579 293a  e of NestedKey):
-0003b4f0: 2054 6865 206e 616d 6520 6f66 2074 6865   The name of the
-0003b500: 206b 6579 7320 746f 2073 656c 6563 742e   keys to select.
-0003b510: 2049 6620 7468 6520 6b65 7920 6973 0d0a   If the key is..
-0003b520: 2020 2020 2020 2020 2020 2020 6e6f 7420              not 
-0003b530: 7072 6573 656e 742c 2069 7420 6973 2073  present, it is s
-0003b540: 696d 706c 7920 6967 6e6f 7265 642e 0d0a  imply ignored...
-0003b550: 0d0a 2020 2020 4b65 7977 6f72 6420 4172  ..    Keyword Ar
-0003b560: 6773 3a0d 0a20 2020 2020 2020 206b 6565  gs:..        kee
-0003b570: 705f 7265 7761 7264 7320 2862 6f6f 6c2c  p_rewards (bool,
-0003b580: 206f 7074 696f 6e61 6c29 3a20 6966 2060   optional): if `
-0003b590: 6046 616c 7365 6060 2c20 7468 6520 7265  `False``, the re
-0003b5a0: 7761 7264 206b 6579 7320 6d75 7374 2062  ward keys must b
-0003b5b0: 6520 7072 6f76 6964 6564 0d0a 2020 2020  e provided..    
-0003b5c0: 2020 2020 2020 2020 6966 2074 6865 7920          if they 
-0003b5d0: 7368 6f75 6c64 2062 6520 6b65 7074 2e20  should be kept. 
-0003b5e0: 4465 6661 756c 7473 2074 6f20 6060 5472  Defaults to ``Tr
-0003b5f0: 7565 6060 2e0d 0a20 2020 2020 2020 206b  ue``...        k
-0003b600: 6565 705f 646f 6e65 7320 2862 6f6f 6c2c  eep_dones (bool,
-0003b610: 206f 7074 696f 6e61 6c29 3a20 6966 2060   optional): if `
-0003b620: 6046 616c 7365 6060 2c20 7468 6520 646f  `False``, the do
-0003b630: 6e65 206b 6579 7320 6d75 7374 2062 6520  ne keys must be 
-0003b640: 7072 6f76 6964 6564 0d0a 2020 2020 2020  provided..      
-0003b650: 2020 2020 2020 6966 2074 6865 7920 7368        if they sh
-0003b660: 6f75 6c64 2062 6520 6b65 7074 2e20 4465  ould be kept. De
-0003b670: 6661 756c 7473 2074 6f20 6060 5472 7565  faults to ``True
-0003b680: 6060 2e0d 0a0d 0a20 2020 2020 2020 203e  ``.....        >
-0003b690: 3e3e 2069 6d70 6f72 7420 6779 6d6e 6173  >> import gymnas
-0003b6a0: 6975 6d0d 0a20 2020 2020 2020 203e 3e3e  ium..        >>>
-0003b6b0: 2066 726f 6d20 746f 7263 6872 6c2e 656e   from torchrl.en
-0003b6c0: 7673 2069 6d70 6f72 7420 4779 6d57 7261  vs import GymWra
-0003b6d0: 7070 6572 0d0a 2020 2020 2020 2020 3e3e  pper..        >>
-0003b6e0: 3e20 656e 7620 3d20 5472 616e 7366 6f72  > env = Transfor
-0003b6f0: 6d65 6445 6e76 280d 0a20 2020 2020 2020  medEnv(..       
-0003b700: 202e 2e2e 2020 2020 2047 796d 5772 6170   ...     GymWrap
-0003b710: 7065 7228 6779 6d6e 6173 6975 6d2e 6d61  per(gymnasium.ma
-0003b720: 6b65 2822 5065 6e64 756c 756d 2d76 3122  ke("Pendulum-v1"
-0003b730: 2929 2c0d 0a20 2020 2020 2020 202e 2e2e  )),..        ...
-0003b740: 2020 2020 2053 656c 6563 7454 7261 6e73       SelectTrans
-0003b750: 666f 726d 2822 6f62 7365 7276 6174 696f  form("observatio
-0003b760: 6e22 2c20 2272 6577 6172 6422 2c20 2264  n", "reward", "d
-0003b770: 6f6e 6522 2c20 6b65 6570 5f64 6f6e 6573  one", keep_dones
-0003b780: 3d46 616c 7365 292c 2023 2077 6520 6c65  =False), # we le
-0003b790: 6176 6520 646f 6e65 2062 6568 696e 640d  ave done behind.
-0003b7a0: 0a20 2020 2020 2020 202e 2e2e 2029 0d0a  .        ... )..
-0003b7b0: 2020 2020 2020 2020 3e3e 3e20 656e 762e          >>> env.
-0003b7c0: 726f 6c6c 6f75 7428 3329 2020 2320 7468  rollout(3)  # th
-0003b7d0: 6520 7472 756e 6361 7465 6420 6b65 7920  e truncated key 
-0003b7e0: 6973 206e 6f77 2061 6273 656e 740d 0a20  is now absent.. 
-0003b7f0: 2020 2020 2020 2054 656e 736f 7244 6963         TensorDic
-0003b800: 7428 0d0a 2020 2020 2020 2020 2020 2020  t(..            
-0003b810: 6669 656c 6473 3d7b 0d0a 2020 2020 2020  fields={..      
-0003b820: 2020 2020 2020 2020 2020 6163 7469 6f6e            action
-0003b830: 3a20 5465 6e73 6f72 2873 6861 7065 3d74  : Tensor(shape=t
-0003b840: 6f72 6368 2e53 697a 6528 5b33 2c20 315d  orch.Size([3, 1]
-0003b850: 292c 2064 6576 6963 653d 6370 752c 2064  ), device=cpu, d
-0003b860: 7479 7065 3d74 6f72 6368 2e66 6c6f 6174  type=torch.float
-0003b870: 3332 2c20 6973 5f73 6861 7265 643d 4661  32, is_shared=Fa
-0003b880: 6c73 6529 2c0d 0a20 2020 2020 2020 2020  lse),..         
-0003b890: 2020 2020 2020 2064 6f6e 653a 2054 656e         done: Ten
-0003b8a0: 736f 7228 7368 6170 653d 746f 7263 682e  sor(shape=torch.
-0003b8b0: 5369 7a65 285b 332c 2031 5d29 2c20 6465  Size([3, 1]), de
-0003b8c0: 7669 6365 3d63 7075 2c20 6474 7970 653d  vice=cpu, dtype=
-0003b8d0: 746f 7263 682e 626f 6f6c 2c20 6973 5f73  torch.bool, is_s
-0003b8e0: 6861 7265 643d 4661 6c73 6529 2c0d 0a20  hared=False),.. 
-0003b8f0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0003b900: 6578 743a 2054 656e 736f 7244 6963 7428  ext: TensorDict(
-0003b910: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0003b920: 2020 2020 2020 6669 656c 6473 3d7b 0d0a        fields={..
-0003b930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b940: 2020 2020 2020 2020 646f 6e65 3a20 5465          done: Te
-0003b950: 6e73 6f72 2873 6861 7065 3d74 6f72 6368  nsor(shape=torch
-0003b960: 2e53 697a 6528 5b33 2c20 315d 292c 2064  .Size([3, 1]), d
-0003b970: 6576 6963 653d 6370 752c 2064 7479 7065  evice=cpu, dtype
-0003b980: 3d74 6f72 6368 2e62 6f6f 6c2c 2069 735f  =torch.bool, is_
-0003b990: 7368 6172 6564 3d46 616c 7365 292c 0d0a  shared=False),..
-0003b9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b9b0: 2020 2020 2020 2020 6f62 7365 7276 6174          observat
-0003b9c0: 696f 6e3a 2054 656e 736f 7228 7368 6170  ion: Tensor(shap
-0003b9d0: 653d 746f 7263 682e 5369 7a65 285b 332c  e=torch.Size([3,
-0003b9e0: 2033 5d29 2c20 6465 7669 6365 3d63 7075   3]), device=cpu
-0003b9f0: 2c20 6474 7970 653d 746f 7263 682e 666c  , dtype=torch.fl
-0003ba00: 6f61 7433 322c 2069 735f 7368 6172 6564  oat32, is_shared
-0003ba10: 3d46 616c 7365 292c 0d0a 2020 2020 2020  =False),..      
-0003ba20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ba30: 2020 7265 7761 7264 3a20 5465 6e73 6f72    reward: Tensor
-0003ba40: 2873 6861 7065 3d74 6f72 6368 2e53 697a  (shape=torch.Siz
-0003ba50: 6528 5b33 2c20 315d 292c 2064 6576 6963  e([3, 1]), devic
-0003ba60: 653d 6370 752c 2064 7479 7065 3d74 6f72  e=cpu, dtype=tor
-0003ba70: 6368 2e66 6c6f 6174 3332 2c20 6973 5f73  ch.float32, is_s
-0003ba80: 6861 7265 643d 4661 6c73 6529 7d2c 0d0a  hared=False)},..
-0003ba90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003baa0: 2020 2020 6261 7463 685f 7369 7a65 3d74      batch_size=t
-0003bab0: 6f72 6368 2e53 697a 6528 5b33 5d29 2c0d  orch.Size([3]),.
-0003bac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003bad0: 2020 2020 2064 6576 6963 653d 6370 752c       device=cpu,
-0003bae0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0003baf0: 2020 2020 2020 6973 5f73 6861 7265 643d        is_shared=
-0003bb00: 4661 6c73 6529 2c0d 0a20 2020 2020 2020  False),..       
-0003bb10: 2020 2020 2020 2020 206f 6273 6572 7661           observa
-0003bb20: 7469 6f6e 3a20 5465 6e73 6f72 2873 6861  tion: Tensor(sha
-0003bb30: 7065 3d74 6f72 6368 2e53 697a 6528 5b33  pe=torch.Size([3
-0003bb40: 2c20 335d 292c 2064 6576 6963 653d 6370  , 3]), device=cp
-0003bb50: 752c 2064 7479 7065 3d74 6f72 6368 2e66  u, dtype=torch.f
-0003bb60: 6c6f 6174 3332 2c20 6973 5f73 6861 7265  loat32, is_share
-0003bb70: 643d 4661 6c73 6529 7d2c 0d0a 2020 2020  d=False)},..    
-0003bb80: 2020 2020 2020 2020 6261 7463 685f 7369          batch_si
-0003bb90: 7a65 3d74 6f72 6368 2e53 697a 6528 5b33  ze=torch.Size([3
-0003bba0: 5d29 2c0d 0a20 2020 2020 2020 2020 2020  ]),..           
-0003bbb0: 2064 6576 6963 653d 6370 752c 0d0a 2020   device=cpu,..  
-0003bbc0: 2020 2020 2020 2020 2020 6973 5f73 6861            is_sha
-0003bbd0: 7265 643d 4661 6c73 6529 0d0a 0d0a 2020  red=False)....  
-0003bbe0: 2020 2222 220d 0a0d 0a20 2020 2064 6566    """....    def
-0003bbf0: 205f 5f69 6e69 745f 5f28 0d0a 2020 2020   __init__(..    
-0003bc00: 2020 2020 7365 6c66 2c0d 0a20 2020 2020      self,..     
-0003bc10: 2020 202a 7365 6c65 6374 6564 5f6b 6579     *selected_key
-0003bc20: 733a 204e 6573 7465 644b 6579 2c0d 0a20  s: NestedKey,.. 
-0003bc30: 2020 2020 2020 206b 6565 705f 7265 7761         keep_rewa
-0003bc40: 7264 733a 2062 6f6f 6c20 3d20 5472 7565  rds: bool = True
-0003bc50: 2c0d 0a20 2020 2020 2020 206b 6565 705f  ,..        keep_
-0003bc60: 646f 6e65 733a 2062 6f6f 6c20 3d20 5472  dones: bool = Tr
-0003bc70: 7565 2c0d 0a20 2020 2029 3a0d 0a20 2020  ue,..    ):..   
-0003bc80: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
-0003bc90: 6e69 745f 5f28 290d 0a20 2020 2020 2020  nit__()..       
-0003bca0: 2074 7279 3a0d 0a20 2020 2020 2020 2020   try:..         
-0003bcb0: 2020 2073 656c 6563 7465 645f 6b65 7973     selected_keys
-0003bcc0: 203d 2075 6e72 6176 656c 5f6b 6579 5f6c   = unravel_key_l
-0003bcd0: 6973 7428 7365 6c65 6374 6564 5f6b 6579  ist(selected_key
-0003bce0: 7329 0d0a 2020 2020 2020 2020 6578 6365  s)..        exce
-0003bcf0: 7074 2054 7970 6545 7272 6f72 3a0d 0a20  pt TypeError:.. 
-0003bd00: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0003bd10: 2054 7970 6545 7272 6f72 280d 0a20 2020   TypeError(..   
-0003bd20: 2020 2020 2020 2020 2020 2020 2022 7365               "se
-0003bd30: 6c65 6374 6564 206b 6579 7320 6d75 7374  lected keys must
-0003bd40: 2062 6520 6120 6c69 7374 206f 7220 7475   be a list or tu
-0003bd50: 706c 6520 6f66 2073 7472 696e 6773 206f  ple of strings o
-0003bd60: 7220 7475 706c 6573 206f 6620 7374 7269  r tuples of stri
-0003bd70: 6e67 732e 220d 0a20 2020 2020 2020 2020  ngs."..         
-0003bd80: 2020 2029 0d0a 2020 2020 2020 2020 7365     )..        se
-0003bd90: 6c66 2e73 656c 6563 7465 645f 6b65 7973  lf.selected_keys
-0003bda0: 203d 2073 656c 6563 7465 645f 6b65 7973   = selected_keys
-0003bdb0: 0d0a 2020 2020 2020 2020 7365 6c66 2e6b  ..        self.k
-0003bdc0: 6565 705f 646f 6e65 5f6b 6579 7320 3d20  eep_done_keys = 
-0003bdd0: 6b65 6570 5f64 6f6e 6573 0d0a 2020 2020  keep_dones..    
-0003bde0: 2020 2020 7365 6c66 2e6b 6565 705f 7265      self.keep_re
-0003bdf0: 7761 7264 5f6b 6579 7320 3d20 6b65 6570  ward_keys = keep
-0003be00: 5f72 6577 6172 6473 0d0a 0d0a 2020 2020  _rewards....    
-0003be10: 6465 6620 5f63 616c 6c28 7365 6c66 2c20  def _call(self, 
-0003be20: 7465 6e73 6f72 6469 6374 3a20 5465 6e73  tensordict: Tens
-0003be30: 6f72 4469 6374 4261 7365 2920 2d3e 2054  orDictBase) -> T
-0003be40: 656e 736f 7244 6963 7442 6173 653a 0d0a  ensorDictBase:..
-0003be50: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0003be60: 7061 7265 6e74 2069 7320 6e6f 7420 4e6f  parent is not No
-0003be70: 6e65 3a0d 0a20 2020 2020 2020 2020 2020  ne:..           
-0003be80: 2069 6e70 7574 5f6b 6579 7320 3d20 7365   input_keys = se
-0003be90: 6c66 2e70 6172 656e 742e 7374 6174 655f  lf.parent.state_
-0003bea0: 7370 6563 2e6b 6579 7328 5472 7565 2c20  spec.keys(True, 
-0003beb0: 5472 7565 290d 0a20 2020 2020 2020 2065  True)..        e
-0003bec0: 6c73 653a 0d0a 2020 2020 2020 2020 2020  lse:..          
-0003bed0: 2020 696e 7075 745f 6b65 7973 203d 205b    input_keys = [
-0003bee0: 5d0d 0a20 2020 2020 2020 2069 6620 7365  ]..        if se
-0003bef0: 6c66 2e6b 6565 705f 7265 7761 7264 5f6b  lf.keep_reward_k
-0003bf00: 6579 733a 0d0a 2020 2020 2020 2020 2020  eys:..          
-0003bf10: 2020 7265 7761 7264 5f6b 6579 7320 3d20    reward_keys = 
-0003bf20: 7365 6c66 2e70 6172 656e 742e 7265 7761  self.parent.rewa
-0003bf30: 7264 5f6b 6579 7320 6966 2073 656c 662e  rd_keys if self.
-0003bf40: 7061 7265 6e74 2065 6c73 6520 5b22 7265  parent else ["re
-0003bf50: 7761 7264 225d 0d0a 2020 2020 2020 2020  ward"]..        
-0003bf60: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
-0003bf70: 2020 2072 6577 6172 645f 6b65 7973 203d     reward_keys =
-0003bf80: 205b 5d0d 0a20 2020 2020 2020 2069 6620   []..        if 
-0003bf90: 7365 6c66 2e6b 6565 705f 646f 6e65 5f6b  self.keep_done_k
-0003bfa0: 6579 733a 0d0a 2020 2020 2020 2020 2020  eys:..          
-0003bfb0: 2020 646f 6e65 5f6b 6579 7320 3d20 7365    done_keys = se
-0003bfc0: 6c66 2e70 6172 656e 742e 646f 6e65 5f6b  lf.parent.done_k
-0003bfd0: 6579 7320 6966 2073 656c 662e 7061 7265  eys if self.pare
-0003bfe0: 6e74 2065 6c73 6520 5b22 646f 6e65 225d  nt else ["done"]
-0003bff0: 0d0a 2020 2020 2020 2020 656c 7365 3a0d  ..        else:.
-0003c000: 0a20 2020 2020 2020 2020 2020 2064 6f6e  .            don
-0003c010: 655f 6b65 7973 203d 205b 5d0d 0a20 2020  e_keys = []..   
-0003c020: 2020 2020 2072 6574 7572 6e20 7465 6e73       return tens
-0003c030: 6f72 6469 6374 2e73 656c 6563 7428 0d0a  ordict.select(..
-0003c040: 2020 2020 2020 2020 2020 2020 2a73 656c              *sel
-0003c050: 662e 7365 6c65 6374 6564 5f6b 6579 732c  f.selected_keys,
-0003c060: 202a 7265 7761 7264 5f6b 6579 732c 202a   *reward_keys, *
-0003c070: 646f 6e65 5f6b 6579 732c 202a 696e 7075  done_keys, *inpu
-0003c080: 745f 6b65 7973 2c20 7374 7269 6374 3d46  t_keys, strict=F
-0003c090: 616c 7365 0d0a 2020 2020 2020 2020 290d  alse..        ).
-0003c0a0: 0a0d 0a20 2020 2066 6f72 7761 7264 203d  ...    forward =
-0003c0b0: 205f 6361 6c6c 0d0a 0d0a 2020 2020 6465   _call....    de
-0003c0c0: 6620 5f72 6573 6574 280d 0a20 2020 2020  f _reset(..     
-0003c0d0: 2020 2073 656c 662c 2074 656e 736f 7264     self, tensord
-0003c0e0: 6963 743a 2054 656e 736f 7244 6963 7442  ict: TensorDictB
-0003c0f0: 6173 652c 2074 656e 736f 7264 6963 745f  ase, tensordict_
-0003c100: 7265 7365 743a 2054 656e 736f 7244 6963  reset: TensorDic
-0003c110: 7442 6173 650d 0a20 2020 2029 202d 3e20  tBase..    ) -> 
-0003c120: 5465 6e73 6f72 4469 6374 4261 7365 3a0d  TensorDictBase:.
-0003c130: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0003c140: 2e70 6172 656e 7420 6973 206e 6f74 204e  .parent is not N
-0003c150: 6f6e 653a 0d0a 2020 2020 2020 2020 2020  one:..          
-0003c160: 2020 696e 7075 745f 6b65 7973 203d 2073    input_keys = s
-0003c170: 656c 662e 7061 7265 6e74 2e73 7461 7465  elf.parent.state
-0003c180: 5f73 7065 632e 6b65 7973 2854 7275 652c  _spec.keys(True,
-0003c190: 2054 7275 6529 0d0a 2020 2020 2020 2020   True)..        
-0003c1a0: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
-0003c1b0: 2020 2069 6e70 7574 5f6b 6579 7320 3d20     input_keys = 
-0003c1c0: 5b5d 0d0a 2020 2020 2020 2020 6966 2073  []..        if s
-0003c1d0: 656c 662e 6b65 6570 5f72 6577 6172 645f  elf.keep_reward_
-0003c1e0: 6b65 7973 3a0d 0a20 2020 2020 2020 2020  keys:..         
-0003c1f0: 2020 2072 6577 6172 645f 6b65 7973 203d     reward_keys =
-0003c200: 2073 656c 662e 7061 7265 6e74 2e72 6577   self.parent.rew
-0003c210: 6172 645f 6b65 7973 2069 6620 7365 6c66  ard_keys if self
-0003c220: 2e70 6172 656e 7420 656c 7365 205b 2272  .parent else ["r
-0003c230: 6577 6172 6422 5d0d 0a20 2020 2020 2020  eward"]..       
-0003c240: 2065 6c73 653a 0d0a 2020 2020 2020 2020   else:..        
-0003c250: 2020 2020 7265 7761 7264 5f6b 6579 7320      reward_keys 
-0003c260: 3d20 5b5d 0d0a 2020 2020 2020 2020 6966  = []..        if
-0003c270: 2073 656c 662e 6b65 6570 5f64 6f6e 655f   self.keep_done_
-0003c280: 6b65 7973 3a0d 0a20 2020 2020 2020 2020  keys:..         
-0003c290: 2020 2064 6f6e 655f 6b65 7973 203d 2073     done_keys = s
-0003c2a0: 656c 662e 7061 7265 6e74 2e64 6f6e 655f  elf.parent.done_
-0003c2b0: 6b65 7973 2069 6620 7365 6c66 2e70 6172  keys if self.par
-0003c2c0: 656e 7420 656c 7365 205b 2264 6f6e 6522  ent else ["done"
-0003c2d0: 5d0d 0a20 2020 2020 2020 2065 6c73 653a  ]..        else:
-0003c2e0: 0d0a 2020 2020 2020 2020 2020 2020 646f  ..            do
-0003c2f0: 6e65 5f6b 6579 7320 3d20 5b5d 0d0a 2020  ne_keys = []..  
-0003c300: 2020 2020 2020 7265 7475 726e 2074 656e        return ten
-0003c310: 736f 7264 6963 745f 7265 7365 742e 7365  sordict_reset.se
-0003c320: 6c65 6374 280d 0a20 2020 2020 2020 2020  lect(..         
-0003c330: 2020 202a 7365 6c66 2e73 656c 6563 7465     *self.selecte
-0003c340: 645f 6b65 7973 2c20 2a72 6577 6172 645f  d_keys, *reward_
-0003c350: 6b65 7973 2c20 2a64 6f6e 655f 6b65 7973  keys, *done_keys
-0003c360: 2c20 2a69 6e70 7574 5f6b 6579 732c 2073  , *input_keys, s
-0003c370: 7472 6963 743d 4661 6c73 650d 0a20 2020  trict=False..   
-0003c380: 2020 2020 2029 0d0a 0d0a 2020 2020 6465       )....    de
-0003c390: 6620 7472 616e 7366 6f72 6d5f 6f75 7470  f transform_outp
-0003c3a0: 7574 5f73 7065 6328 7365 6c66 2c20 6f75  ut_spec(self, ou
-0003c3b0: 7470 7574 5f73 7065 633a 2043 6f6d 706f  tput_spec: Compo
-0003c3c0: 7369 7465 5370 6563 2920 2d3e 2043 6f6d  siteSpec) -> Com
-0003c3d0: 706f 7369 7465 5370 6563 3a0d 0a20 2020  positeSpec:..   
-0003c3e0: 2020 2020 2066 756c 6c5f 646f 6e65 5f73       full_done_s
-0003c3f0: 7065 6320 3d20 6f75 7470 7574 5f73 7065  pec = output_spe
-0003c400: 635b 2266 756c 6c5f 646f 6e65 5f73 7065  c["full_done_spe
-0003c410: 6322 5d0d 0a20 2020 2020 2020 2066 756c  c"]..        ful
-0003c420: 6c5f 7265 7761 7264 5f73 7065 6320 3d20  l_reward_spec = 
-0003c430: 6f75 7470 7574 5f73 7065 635b 2266 756c  output_spec["ful
-0003c440: 6c5f 7265 7761 7264 5f73 7065 6322 5d0d  l_reward_spec"].
-0003c450: 0a20 2020 2020 2020 2066 756c 6c5f 6f62  .        full_ob
-0003c460: 7365 7276 6174 696f 6e5f 7370 6563 203d  servation_spec =
-0003c470: 206f 7574 7075 745f 7370 6563 5b22 6675   output_spec["fu
-0003c480: 6c6c 5f6f 6273 6572 7661 7469 6f6e 5f73  ll_observation_s
-0003c490: 7065 6322 5d0d 0a20 2020 2020 2020 2069  pec"]..        i
-0003c4a0: 6620 6e6f 7420 7365 6c66 2e6b 6565 705f  f not self.keep_
-0003c4b0: 646f 6e65 5f6b 6579 733a 0d0a 2020 2020  done_keys:..    
-0003c4c0: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
-0003c4d0: 696e 206c 6973 7428 6675 6c6c 5f64 6f6e  in list(full_don
-0003c4e0: 655f 7370 6563 2e6b 6579 7328 5472 7565  e_spec.keys(True
-0003c4f0: 2c20 5472 7565 2929 3a0d 0a20 2020 2020  , True)):..     
-0003c500: 2020 2020 2020 2020 2020 2069 6620 756e             if un
-0003c510: 7261 7665 6c5f 6b65 7928 6b65 7929 206e  ravel_key(key) n
-0003c520: 6f74 2069 6e20 7365 6c66 2e73 656c 6563  ot in self.selec
-0003c530: 7465 645f 6b65 7973 3a0d 0a20 2020 2020  ted_keys:..     
-0003c540: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0003c550: 656c 2066 756c 6c5f 646f 6e65 5f73 7065  el full_done_spe
-0003c560: 635b 6b65 795d 0d0a 0d0a 2020 2020 2020  c[key]....      
-0003c570: 2020 666f 7220 6b65 7920 696e 206c 6973    for key in lis
-0003c580: 7428 6675 6c6c 5f6f 6273 6572 7661 7469  t(full_observati
-0003c590: 6f6e 5f73 7065 632e 6b65 7973 2854 7275  on_spec.keys(Tru
-0003c5a0: 652c 2054 7275 6529 293a 0d0a 2020 2020  e, True)):..    
-0003c5b0: 2020 2020 2020 2020 6966 2075 6e72 6176          if unrav
-0003c5c0: 656c 5f6b 6579 286b 6579 2920 6e6f 7420  el_key(key) not 
-0003c5d0: 696e 2073 656c 662e 7365 6c65 6374 6564  in self.selected
-0003c5e0: 5f6b 6579 733a 0d0a 2020 2020 2020 2020  _keys:..        
-0003c5f0: 2020 2020 2020 2020 6465 6c20 6675 6c6c          del full
-0003c600: 5f6f 6273 6572 7661 7469 6f6e 5f73 7065  _observation_spe
-0003c610: 635b 6b65 795d 0d0a 0d0a 2020 2020 2020  c[key]....      
-0003c620: 2020 6966 206e 6f74 2073 656c 662e 6b65    if not self.ke
-0003c630: 6570 5f72 6577 6172 645f 6b65 7973 3a0d  ep_reward_keys:.
-0003c640: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0003c650: 206b 6579 2069 6e20 6c69 7374 2866 756c   key in list(ful
-0003c660: 6c5f 7265 7761 7264 5f73 7065 632e 6b65  l_reward_spec.ke
-0003c670: 7973 2854 7275 652c 2054 7275 6529 293a  ys(True, True)):
-0003c680: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0003c690: 2020 6966 2075 6e72 6176 656c 5f6b 6579    if unravel_key
-0003c6a0: 286b 6579 2920 6e6f 7420 696e 2073 656c  (key) not in sel
-0003c6b0: 662e 7365 6c65 6374 6564 5f6b 6579 733a  f.selected_keys:
-0003c6c0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0003c6d0: 2020 2020 2020 6465 6c20 6675 6c6c 5f72        del full_r
-0003c6e0: 6577 6172 645f 7370 6563 5b6b 6579 5d0d  eward_spec[key].
-0003c6f0: 0a0d 0a20 2020 2020 2020 2072 6574 7572  ...        retur
-0003c700: 6e20 6f75 7470 7574 5f73 7065 630d 0a0d  n output_spec...
-0003c710: 0a0d 0a63 6c61 7373 2054 696d 654d 6178  ...class TimeMax
-0003c720: 506f 6f6c 2854 7261 6e73 666f 726d 293a  Pool(Transform):
-0003c730: 0d0a 2020 2020 2222 2254 616b 6520 7468  ..    """Take th
-0003c740: 6520 6d61 7869 6d75 6d20 7661 6c75 6520  e maximum value 
-0003c750: 696e 2065 6163 6820 706f 7369 7469 6f6e  in each position
-0003c760: 206f 7665 7220 7468 6520 6c61 7374 2054   over the last T
-0003c770: 206f 6273 6572 7661 7469 6f6e 732e 0d0a   observations...
-0003c780: 0d0a 2020 2020 5468 6973 2074 7261 6e73  ..    This trans
-0003c790: 666f 726d 2074 616b 6520 7468 6520 6d61  form take the ma
-0003c7a0: 7869 6d75 6d20 7661 6c75 6520 696e 2065  ximum value in e
-0003c7b0: 6163 6820 706f 7369 7469 6f6e 2066 6f72  ach position for
-0003c7c0: 2061 6c6c 2069 6e5f 6b65 7973 2074 656e   all in_keys ten
-0003c7d0: 736f 7273 206f 7665 7220 7468 6520 6c61  sors over the la
-0003c7e0: 7374 2054 2074 696d 6520 7374 6570 732e  st T time steps.
-0003c7f0: 0d0a 0d0a 2020 2020 4172 6773 3a0d 0a20  ....    Args:.. 
-0003c800: 2020 2020 2020 2069 6e5f 6b65 7973 2028         in_keys (
-0003c810: 7365 7175 656e 6365 206f 6620 4e65 7374  sequence of Nest
-0003c820: 6564 4b65 792c 206f 7074 696f 6e61 6c29  edKey, optional)
-0003c830: 3a20 696e 7075 7420 6b65 7973 206f 6e20  : input keys on 
-0003c840: 7768 6963 6820 7468 6520 6d61 7820 706f  which the max po
-0003c850: 6f6c 2077 696c 6c20 6265 2061 7070 6c69  ol will be appli
-0003c860: 6564 2e20 4465 6661 756c 7473 2074 6f20  ed. Defaults to 
-0003c870: 226f 6273 6572 7661 7469 6f6e 2220 6966  "observation" if
-0003c880: 206c 6566 7420 656d 7074 792e 0d0a 2020   left empty...  
-0003c890: 2020 2020 2020 6f75 745f 6b65 7973 2028        out_keys (
-0003c8a0: 7365 7175 656e 6365 206f 6620 4e65 7374  sequence of Nest
-0003c8b0: 6564 4b65 792c 206f 7074 696f 6e61 6c29  edKey, optional)
-0003c8c0: 3a20 6f75 7470 7574 206b 6579 7320 7768  : output keys wh
-0003c8d0: 6572 6520 7468 6520 6f75 7470 7574 2077  ere the output w
-0003c8e0: 696c 6c20 6265 2077 7269 7474 656e 2e20  ill be written. 
-0003c8f0: 4465 6661 756c 7473 2074 6f20 6069 6e5f  Defaults to `in_
-0003c900: 6b65 7973 6020 6966 206c 6566 7420 656d  keys` if left em
-0003c910: 7074 792e 0d0a 2020 2020 2020 2020 5420  pty...        T 
-0003c920: 2869 6e74 2c20 6f70 7469 6f6e 616c 293a  (int, optional):
-0003c930: 204e 756d 6265 7220 6f66 2074 696d 6520   Number of time 
-0003c940: 7374 6570 7320 6f76 6572 2077 6869 6368  steps over which
-0003c950: 2074 6f20 6170 706c 7920 6d61 7820 706f   to apply max po
-0003c960: 6f6c 696e 672e 0d0a 2020 2020 2020 2020  oling...        
-0003c970: 7265 7365 745f 6b65 7920 284e 6573 7465  reset_key (Neste
-0003c980: 644b 6579 2c20 6f70 7469 6f6e 616c 293a  dKey, optional):
-0003c990: 2074 6865 2072 6573 6574 206b 6579 2074   the reset key t
-0003c9a0: 6f20 6265 2075 7365 6420 6173 2070 6172  o be used as par
-0003c9b0: 7469 616c 0d0a 2020 2020 2020 2020 2020  tial..          
-0003c9c0: 2020 7265 7365 7420 696e 6469 6361 746f    reset indicato
-0003c9d0: 722e 204d 7573 7420 6265 2075 6e69 7175  r. Must be uniqu
-0003c9e0: 652e 2049 6620 6e6f 7420 7072 6f76 6964  e. If not provid
-0003c9f0: 6564 2c20 6465 6661 756c 7473 2074 6f20  ed, defaults to 
-0003ca00: 7468 650d 0a20 2020 2020 2020 2020 2020  the..           
-0003ca10: 206f 6e6c 7920 7265 7365 7420 6b65 7920   only reset key 
-0003ca20: 6f66 2074 6865 2070 6172 656e 7420 656e  of the parent en
-0003ca30: 7669 726f 6e6d 656e 7420 2869 6620 6974  vironment (if it
-0003ca40: 2068 6173 206f 6e6c 7920 6f6e 6529 0d0a   has only one)..
-0003ca50: 2020 2020 2020 2020 2020 2020 616e 6420              and 
-0003ca60: 7261 6973 6573 2061 6e20 6578 6365 7074  raises an except
-0003ca70: 696f 6e20 6f74 6865 7277 6973 652e 0d0a  ion otherwise...
-0003ca80: 0d0a 2020 2020 4578 616d 706c 6573 3a0d  ..    Examples:.
-0003ca90: 0a20 2020 2020 2020 203e 3e3e 2066 726f  .        >>> fro
-0003caa0: 6d20 746f 7263 6872 6c2e 656e 7673 2069  m torchrl.envs i
-0003cab0: 6d70 6f72 7420 4779 6d45 6e76 0d0a 2020  mport GymEnv..  
-0003cac0: 2020 2020 2020 3e3e 3e20 6261 7365 5f65        >>> base_e
-0003cad0: 6e76 203d 2047 796d 456e 7628 2250 656e  nv = GymEnv("Pen
-0003cae0: 6475 6c75 6d2d 7631 2229 0d0a 2020 2020  dulum-v1")..    
-0003caf0: 2020 2020 3e3e 3e20 656e 7620 3d20 5472      >>> env = Tr
-0003cb00: 616e 7366 6f72 6d65 6445 6e76 2862 6173  ansformedEnv(bas
-0003cb10: 655f 656e 762c 2054 696d 654d 6178 506f  e_env, TimeMaxPo
-0003cb20: 6f6c 2869 6e5f 6b65 7973 3d5b 226f 6273  ol(in_keys=["obs
-0003cb30: 6572 7661 7469 6f6e 225d 2c20 543d 3130  ervation"], T=10
-0003cb40: 2929 0d0a 2020 2020 2020 2020 3e3e 3e20  ))..        >>> 
-0003cb50: 746f 7263 682e 6d61 6e75 616c 5f73 6565  torch.manual_see
-0003cb60: 6428 3029 0d0a 2020 2020 2020 2020 3e3e  d(0)..        >>
-0003cb70: 3e20 656e 762e 7365 745f 7365 6564 2830  > env.set_seed(0
-0003cb80: 290d 0a20 2020 2020 2020 203e 3e3e 2072  )..        >>> r
-0003cb90: 6f6c 6c6f 7574 203d 2065 6e76 2e72 6f6c  ollout = env.rol
-0003cba0: 6c6f 7574 2831 3029 0d0a 2020 2020 2020  lout(10)..      
-0003cbb0: 2020 3e3e 3e20 7072 696e 7428 726f 6c6c    >>> print(roll
-0003cbc0: 6f75 745b 226f 6273 6572 7661 7469 6f6e  out["observation
-0003cbd0: 225d 2920 2023 2076 616c 7565 7320 7368  "])  # values sh
-0003cbe0: 6f75 6c64 2062 6520 696e 6372 6561 7369  ould be increasi
-0003cbf0: 6e67 2075 7020 756e 7469 6c20 7468 6520  ng up until the 
-0003cc00: 3130 7468 2073 7465 700d 0a20 2020 2020  10th step..     
-0003cc10: 2020 2074 656e 736f 7228 5b5b 2030 2e30     tensor([[ 0.0
-0003cc20: 3030 302c 2020 302e 3030 3030 2c20 2030  000,  0.0000,  0
-0003cc30: 2e30 3030 305d 2c0d 0a20 2020 2020 2020  .0000],..       
-0003cc40: 2020 2020 2020 2020 205b 2030 2e30 3030           [ 0.000
-0003cc50: 302c 2020 302e 3030 3030 2c20 2030 2e30  0,  0.0000,  0.0
-0003cc60: 3030 305d 2c0d 0a20 2020 2020 2020 2020  000],..         
-0003cc70: 2020 2020 2020 205b 2030 2e30 3030 302c         [ 0.0000,
-0003cc80: 2020 302e 3030 3030 2c20 2030 2e30 3030    0.0000,  0.000
-0003cc90: 305d 2c0d 0a20 2020 2020 2020 2020 2020  0],..           
-0003cca0: 2020 2020 205b 2030 2e30 3030 302c 2020       [ 0.0000,  
-0003ccb0: 302e 3030 3030 2c20 2030 2e30 3030 305d  0.0000,  0.0000]
-0003ccc0: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
-0003ccd0: 2020 205b 2030 2e30 3030 302c 2020 302e     [ 0.0000,  0.
-0003cce0: 3032 3136 2c20 2030 2e30 3030 305d 2c0d  0216,  0.0000],.
-0003ccf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003cd00: 205b 2030 2e30 3030 302c 2020 302e 3131   [ 0.0000,  0.11
-0003cd10: 3439 2c20 2030 2e30 3030 305d 2c0d 0a20  49,  0.0000],.. 
-0003cd20: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-0003cd30: 2030 2e30 3030 302c 2020 302e 3139 3930   0.0000,  0.1990
-0003cd40: 2c20 2030 2e30 3030 305d 2c0d 0a20 2020  ,  0.0000],..   
-0003cd50: 2020 2020 2020 2020 2020 2020 205b 2030               [ 0
-0003cd60: 2e30 3030 302c 2020 302e 3237 3439 2c20  .0000,  0.2749, 
-0003cd70: 2030 2e30 3030 305d 2c0d 0a20 2020 2020   0.0000],..     
-0003cd80: 2020 2020 2020 2020 2020 205b 2030 2e30             [ 0.0
-0003cd90: 3030 302c 2020 302e 3332 3831 2c20 2030  000,  0.3281,  0
-0003cda0: 2e30 3030 305d 2c0d 0a20 2020 2020 2020  .0000],..       
-0003cdb0: 2020 2020 2020 2020 205b 2d30 2e39 3239           [-0.929
-0003cdc0: 302c 2020 302e 3337 3032 2c20 2d30 2e38  0,  0.3702, -0.8
-0003cdd0: 3937 385d 5d29 0d0a 0d0a 2020 2020 2e2e  978]])....    ..
-0003cde0: 206e 6f74 653a 3a20 3a63 6c61 7373 3a60   note:: :class:`
-0003cdf0: 7e54 696d 654d 6178 506f 6f6c 6020 6375  ~TimeMaxPool` cu
-0003ce00: 7272 656e 746c 7920 6f6e 6c79 2073 7570  rrently only sup
-0003ce10: 706f 7274 7320 6060 646f 6e65 6060 2073  ports ``done`` s
-0003ce20: 6967 6e61 6c20 6174 2074 6865 2072 6f6f  ignal at the roo
-0003ce30: 742e 0d0a 2020 2020 2020 2020 4e65 7374  t...        Nest
-0003ce40: 6564 2060 6064 6f6e 6560 602c 2073 7563  ed ``done``, suc
-0003ce50: 6820 6173 2074 686f 7365 2066 6f75 6e64  h as those found
-0003ce60: 2069 6e20 4d41 524c 2073 6574 7469 6e67   in MARL setting
-0003ce70: 732c 2061 7265 2063 7572 7265 6e74 6c79  s, are currently
-0003ce80: 206e 6f74 2073 7570 706f 7274 6564 2e0d   not supported..
-0003ce90: 0a20 2020 2020 2020 2049 6620 7468 6973  .        If this
-0003cea0: 2066 6561 7475 7265 2069 7320 6e65 6564   feature is need
-0003ceb0: 6564 2c20 706c 6561 7365 2072 6169 7365  ed, please raise
-0003cec0: 2061 6e20 6973 7375 6520 6f6e 2054 6f72   an issue on Tor
-0003ced0: 6368 524c 2072 6570 6f2e 0d0a 0d0a 2020  chRL repo.....  
-0003cee0: 2020 2222 220d 0a0d 0a20 2020 2069 6e76    """....    inv
-0003cef0: 6572 7469 626c 6520 3d20 4661 6c73 650d  ertible = False.
-0003cf00: 0a0d 0a20 2020 2064 6566 205f 5f69 6e69  ...    def __ini
-0003cf10: 745f 5f28 0d0a 2020 2020 2020 2020 7365  t__(..        se
-0003cf20: 6c66 2c0d 0a20 2020 2020 2020 2069 6e5f  lf,..        in_
-0003cf30: 6b65 7973 3a20 5365 7175 656e 6365 5b4e  keys: Sequence[N
-0003cf40: 6573 7465 644b 6579 5d20 7c20 4e6f 6e65  estedKey] | None
-0003cf50: 203d 204e 6f6e 652c 0d0a 2020 2020 2020   = None,..      
-0003cf60: 2020 6f75 745f 6b65 7973 3a20 5365 7175    out_keys: Sequ
-0003cf70: 656e 6365 5b4e 6573 7465 644b 6579 5d20  ence[NestedKey] 
-0003cf80: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0d0a  | None = None,..
-0003cf90: 2020 2020 2020 2020 543a 2069 6e74 203d          T: int =
-0003cfa0: 2031 2c0d 0a20 2020 2020 2020 2072 6573   1,..        res
-0003cfb0: 6574 5f6b 6579 3a20 4e65 7374 6564 4b65  et_key: NestedKe
-0003cfc0: 7920 7c20 4e6f 6e65 203d 204e 6f6e 652c  y | None = None,
-0003cfd0: 0d0a 2020 2020 293a 0d0a 2020 2020 2020  ..    ):..      
-0003cfe0: 2020 6966 2069 6e5f 6b65 7973 2069 7320    if in_keys is 
-0003cff0: 4e6f 6e65 3a0d 0a20 2020 2020 2020 2020  None:..         
-0003d000: 2020 2069 6e5f 6b65 7973 203d 205b 226f     in_keys = ["o
-0003d010: 6273 6572 7661 7469 6f6e 225d 0d0a 2020  bservation"]..  
-0003d020: 2020 2020 2020 6966 206f 7574 5f6b 6579        if out_key
-0003d030: 7320 6973 204e 6f6e 653a 0d0a 2020 2020  s is None:..    
-0003d040: 2020 2020 2020 2020 6f75 745f 6b65 7973          out_keys
-0003d050: 203d 2063 6f70 7928 696e 5f6b 6579 7329   = copy(in_keys)
-0003d060: 0d0a 2020 2020 2020 2020 7375 7065 7228  ..        super(
-0003d070: 292e 5f5f 696e 6974 5f5f 2869 6e5f 6b65  ).__init__(in_ke
-0003d080: 7973 3d69 6e5f 6b65 7973 2c20 6f75 745f  ys=in_keys, out_
-0003d090: 6b65 7973 3d6f 7574 5f6b 6579 7329 0d0a  keys=out_keys)..
-0003d0a0: 2020 2020 2020 2020 6966 2054 203c 2031          if T < 1
-0003d0b0: 3a0d 0a20 2020 2020 2020 2020 2020 2072  :..            r
-0003d0c0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-0003d0d0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0003d0e0: 2020 2254 696d 654d 6178 506f 6f6c 5472    "TimeMaxPoolTr
-0003d0f0: 616e 7366 6f72 6d20 5420 7061 7261 6d65  ansform T parame
-0003d100: 7465 7220 7368 6f75 6c64 2068 6176 6520  ter should have 
-0003d110: 6120 7661 6c75 6520 6772 6561 7465 7220  a value greater 
-0003d120: 6f72 2065 7175 616c 2074 6f20 6f6e 652e  or equal to one.
-0003d130: 220d 0a20 2020 2020 2020 2020 2020 2029  "..            )
-0003d140: 0d0a 2020 2020 2020 2020 6966 206c 656e  ..        if len
-0003d150: 2873 656c 662e 696e 5f6b 6579 7329 2021  (self.in_keys) !
-0003d160: 3d20 6c65 6e28 7365 6c66 2e6f 7574 5f6b  = len(self.out_k
-0003d170: 6579 7329 3a0d 0a20 2020 2020 2020 2020  eys):..         
-0003d180: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-0003d190: 726f 7228 0d0a 2020 2020 2020 2020 2020  ror(..          
-0003d1a0: 2020 2020 2020 2254 696d 654d 6178 506f        "TimeMaxPo
-0003d1b0: 6f6c 5472 616e 7366 6f72 6d20 696e 5f6b  olTransform in_k
-0003d1c0: 6579 7320 616e 6420 6f75 745f 6b65 7973  eys and out_keys
-0003d1d0: 2064 6f6e 2774 2068 6176 6520 7468 6520   don't have the 
-0003d1e0: 7361 6d65 206e 756d 6265 7220 6f66 2065  same number of e
-0003d1f0: 6c65 6d65 6e74 7322 0d0a 2020 2020 2020  lements"..      
-0003d200: 2020 2020 2020 290d 0a20 2020 2020 2020        )..       
-0003d210: 2073 656c 662e 6275 6666 6572 5f73 697a   self.buffer_siz
-0003d220: 6520 3d20 540d 0a20 2020 2020 2020 2066  e = T..        f
-0003d230: 6f72 2069 6e5f 6b65 7920 696e 2073 656c  or in_key in sel
-0003d240: 662e 696e 5f6b 6579 733a 0d0a 2020 2020  f.in_keys:..    
-0003d250: 2020 2020 2020 2020 6275 6666 6572 5f6e          buffer_n
-0003d260: 616d 6520 3d20 7365 6c66 2e5f 6275 6666  ame = self._buff
-0003d270: 6572 5f6e 616d 6528 696e 5f6b 6579 290d  er_name(in_key).
-0003d280: 0a20 2020 2020 2020 2020 2020 2073 6574  .            set
-0003d290: 6174 7472 280d 0a20 2020 2020 2020 2020  attr(..         
-0003d2a0: 2020 2020 2020 2073 656c 662c 0d0a 2020         self,..  
-0003d2b0: 2020 2020 2020 2020 2020 2020 2020 6275                bu
-0003d2c0: 6666 6572 5f6e 616d 652c 0d0a 2020 2020  ffer_name,..    
-0003d2d0: 2020 2020 2020 2020 2020 2020 746f 7263              torc
-0003d2e0: 682e 6e6e 2e70 6172 616d 6574 6572 2e55  h.nn.parameter.U
-0003d2f0: 6e69 6e69 7469 616c 697a 6564 4275 6666  ninitializedBuff
-0003d300: 6572 280d 0a20 2020 2020 2020 2020 2020  er(..           
-0003d310: 2020 2020 2020 2020 2064 6576 6963 653d           device=
-0003d320: 746f 7263 682e 6465 7669 6365 2822 6370  torch.device("cp
-0003d330: 7522 292c 2064 7479 7065 3d74 6f72 6368  u"), dtype=torch
-0003d340: 2e67 6574 5f64 6566 6175 6c74 5f64 7479  .get_default_dty
-0003d350: 7065 2829 0d0a 2020 2020 2020 2020 2020  pe()..          
-0003d360: 2020 2020 2020 292c 0d0a 2020 2020 2020        ),..      
-0003d370: 2020 2020 2020 290d 0a20 2020 2020 2020        )..       
-0003d380: 2073 656c 662e 7265 7365 745f 6b65 7920   self.reset_key 
-0003d390: 3d20 7265 7365 745f 6b65 790d 0a0d 0a20  = reset_key.... 
-0003d3a0: 2020 2040 7374 6174 6963 6d65 7468 6f64     @staticmethod
-0003d3b0: 0d0a 2020 2020 6465 6620 5f62 7566 6665  ..    def _buffe
-0003d3c0: 725f 6e61 6d65 2869 6e5f 6b65 7929 3a0d  r_name(in_key):.
-0003d3d0: 0a20 2020 2020 2020 2069 6e5f 6b65 795f  .        in_key_
-0003d3e0: 7374 7220 3d20 225f 222e 6a6f 696e 2869  str = "_".join(i
-0003d3f0: 6e5f 6b65 7929 2069 6620 6973 696e 7374  n_key) if isinst
-0003d400: 616e 6365 2869 6e5f 6b65 792c 2074 7570  ance(in_key, tup
-0003d410: 6c65 2920 656c 7365 2069 6e5f 6b65 790d  le) else in_key.
-0003d420: 0a20 2020 2020 2020 2062 7566 6665 725f  .        buffer_
-0003d430: 6e61 6d65 203d 2066 225f 6d61 7870 6f6f  name = f"_maxpoo
-0003d440: 6c5f 6275 6666 6572 5f7b 696e 5f6b 6579  l_buffer_{in_key
-0003d450: 5f73 7472 7d22 0d0a 2020 2020 2020 2020  _str}"..        
-0003d460: 7265 7475 726e 2062 7566 6665 725f 6e61  return buffer_na
-0003d470: 6d65 0d0a 0d0a 2020 2020 4070 726f 7065  me....    @prope
-0003d480: 7274 790d 0a20 2020 2064 6566 2072 6573  rty..    def res
-0003d490: 6574 5f6b 6579 2873 656c 6629 3a0d 0a20  et_key(self):.. 
-0003d4a0: 2020 2020 2020 2072 6573 6574 5f6b 6579         reset_key
-0003d4b0: 203d 2073 656c 662e 5f5f 6469 6374 5f5f   = self.__dict__
-0003d4c0: 2e67 6574 2822 5f72 6573 6574 5f6b 6579  .get("_reset_key
-0003d4d0: 222c 204e 6f6e 6529 0d0a 2020 2020 2020  ", None)..      
-0003d4e0: 2020 6966 2072 6573 6574 5f6b 6579 2069    if reset_key i
-0003d4f0: 7320 4e6f 6e65 3a0d 0a20 2020 2020 2020  s None:..       
-0003d500: 2020 2020 2072 6573 6574 5f6b 6579 7320       reset_keys 
-0003d510: 3d20 7365 6c66 2e70 6172 656e 742e 7265  = self.parent.re
-0003d520: 7365 745f 6b65 7973 0d0a 2020 2020 2020  set_keys..      
-0003d530: 2020 2020 2020 6966 206c 656e 2872 6573        if len(res
-0003d540: 6574 5f6b 6579 7329 203e 2031 3a0d 0a20  et_keys) > 1:.. 
-0003d550: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0003d560: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
-0003d570: 7228 0d0a 2020 2020 2020 2020 2020 2020  r(..            
-0003d580: 2020 2020 2020 2020 6622 476f 7420 6d6f          f"Got mo
-0003d590: 7265 2074 6861 6e20 6f6e 6520 7265 7365  re than one rese
-0003d5a0: 7420 6b65 7920 696e 2065 6e76 207b 7365  t key in env {se
-0003d5b0: 6c66 2e63 6f6e 7461 696e 6572 7d2c 2063  lf.container}, c
-0003d5c0: 616e 6e6f 7420 696e 6665 7220 7768 6963  annot infer whic
-0003d5d0: 6820 6f6e 6520 746f 2075 7365 2e20 436f  h one to use. Co
-0003d5e0: 6e73 6964 6572 2070 726f 7669 6469 6e67  nsider providing
-0003d5f0: 2074 6865 2072 6573 6574 206b 6579 2069   the reset key i
-0003d600: 6e20 7468 6520 7b74 7970 6528 7365 6c66  n the {type(self
-0003d610: 297d 2063 6f6e 7374 7275 6374 6f72 2e22  )} constructor."
-0003d620: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0003d630: 2020 290d 0a20 2020 2020 2020 2020 2020    )..           
-0003d640: 2072 6573 6574 5f6b 6579 203d 2073 656c   reset_key = sel
-0003d650: 662e 5f72 6573 6574 5f6b 6579 203d 2072  f._reset_key = r
-0003d660: 6573 6574 5f6b 6579 735b 305d 0d0a 2020  eset_keys[0]..  
-0003d670: 2020 2020 2020 7265 7475 726e 2072 6573        return res
-0003d680: 6574 5f6b 6579 0d0a 0d0a 2020 2020 4072  et_key....    @r
-0003d690: 6573 6574 5f6b 6579 2e73 6574 7465 720d  eset_key.setter.
-0003d6a0: 0a20 2020 2064 6566 2072 6573 6574 5f6b  .    def reset_k
-0003d6b0: 6579 2873 656c 662c 2076 616c 7565 293a  ey(self, value):
-0003d6c0: 0d0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
-0003d6d0: 7265 7365 745f 6b65 7920 3d20 7661 6c75  reset_key = valu
-0003d6e0: 650d 0a0d 0a20 2020 2064 6566 205f 7265  e....    def _re
-0003d6f0: 7365 7428 0d0a 2020 2020 2020 2020 7365  set(..        se
-0003d700: 6c66 2c20 7465 6e73 6f72 6469 6374 3a20  lf, tensordict: 
-0003d710: 5465 6e73 6f72 4469 6374 4261 7365 2c20  TensorDictBase, 
-0003d720: 7465 6e73 6f72 6469 6374 5f72 6573 6574  tensordict_reset
-0003d730: 3a20 5465 6e73 6f72 4469 6374 4261 7365  : TensorDictBase
-0003d740: 0d0a 2020 2020 2920 2d3e 2054 656e 736f  ..    ) -> Tenso
-0003d750: 7244 6963 7442 6173 653a 0d0a 0d0a 2020  rDictBase:....  
-0003d760: 2020 2020 2020 5f72 6573 6574 203d 205f        _reset = _
-0003d770: 6765 745f 7265 7365 7428 7365 6c66 2e72  get_reset(self.r
-0003d780: 6573 6574 5f6b 6579 2c20 7465 6e73 6f72  eset_key, tensor
-0003d790: 6469 6374 290d 0a20 2020 2020 2020 2066  dict)..        f
-0003d7a0: 6f72 2069 6e5f 6b65 7920 696e 2073 656c  or in_key in sel
-0003d7b0: 662e 696e 5f6b 6579 733a 0d0a 2020 2020  f.in_keys:..    
-0003d7c0: 2020 2020 2020 2020 6275 6666 6572 5f6e          buffer_n
-0003d7d0: 616d 6520 3d20 7365 6c66 2e5f 6275 6666  ame = self._buff
-0003d7e0: 6572 5f6e 616d 6528 696e 5f6b 6579 290d  er_name(in_key).
-0003d7f0: 0a20 2020 2020 2020 2020 2020 2062 7566  .            buf
-0003d800: 6665 7220 3d20 6765 7461 7474 7228 7365  fer = getattr(se
-0003d810: 6c66 2c20 6275 6666 6572 5f6e 616d 6529  lf, buffer_name)
-0003d820: 0d0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-0003d830: 2069 7369 6e73 7461 6e63 6528 6275 6666   isinstance(buff
-0003d840: 6572 2c20 746f 7263 682e 6e6e 2e70 6172  er, torch.nn.par
-0003d850: 616d 6574 6572 2e55 6e69 6e69 7469 616c  ameter.Uninitial
-0003d860: 697a 6564 4275 6666 6572 293a 0d0a 2020  izedBuffer):..  
-0003d870: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0003d880: 6e74 696e 7565 0d0a 2020 2020 2020 2020  ntinue..        
-0003d890: 2020 2020 6966 206e 6f74 205f 7265 7365      if not _rese
-0003d8a0: 742e 616c 6c28 293a 0d0a 2020 2020 2020  t.all():..      
-0003d8b0: 2020 2020 2020 2020 2020 5f72 6573 6574            _reset
-0003d8c0: 5f65 7870 203d 205f 7265 7365 742e 6578  _exp = _reset.ex
-0003d8d0: 7061 6e64 2862 7566 6665 722e 7368 6170  pand(buffer.shap
-0003d8e0: 655b 305d 2c20 2a5f 7265 7365 742e 7368  e[0], *_reset.sh
-0003d8f0: 6170 6529 0d0a 2020 2020 2020 2020 2020  ape)..          
-0003d900: 2020 2020 2020 6275 6666 6572 5b5f 7265        buffer[_re
-0003d910: 7365 745f 6578 705d 203d 2030 2e30 0d0a  set_exp] = 0.0..
-0003d920: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0003d930: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-0003d940: 2020 2062 7566 6665 722e 6669 6c6c 5f28     buffer.fill_(
-0003d950: 302e 3029 0d0a 2020 2020 2020 2020 7769  0.0)..        wi
-0003d960: 7468 205f 7365 745f 6d69 7373 696e 675f  th _set_missing_
-0003d970: 746f 6c65 7261 6e63 6528 7365 6c66 2c20  tolerance(self, 
-0003d980: 5472 7565 293a 0d0a 2020 2020 2020 2020  True):..        
-0003d990: 2020 2020 666f 7220 696e 5f6b 6579 2069      for in_key i
-0003d9a0: 6e20 7365 6c66 2e69 6e5f 6b65 7973 3a0d  n self.in_keys:.
-0003d9b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003d9c0: 2076 616c 5f72 6573 6574 203d 2074 656e   val_reset = ten
-0003d9d0: 736f 7264 6963 745f 7265 7365 742e 6765  sordict_reset.ge
-0003d9e0: 7428 696e 5f6b 6579 2c20 4e6f 6e65 290d  t(in_key, None).
-0003d9f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003da00: 2076 616c 5f70 7265 7620 3d20 7465 6e73   val_prev = tens
-0003da10: 6f72 6469 6374 2e67 6574 2869 6e5f 6b65  ordict.get(in_ke
-0003da20: 792c 204e 6f6e 6529 0d0a 2020 2020 2020  y, None)..      
-0003da30: 2020 2020 2020 2020 2020 2320 6966 2061            # if a
-0003da40: 6e20 696e 5f6b 6579 2069 7320 6d69 7373  n in_key is miss
-0003da50: 696e 672c 2077 6520 7472 7920 746f 2063  ing, we try to c
-0003da60: 6f70 7920 6974 2066 726f 6d20 7468 6520  opy it from the 
-0003da70: 7072 6576 696f 7573 2073 7465 700d 0a20  previous step.. 
-0003da80: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0003da90: 6620 7661 6c5f 7265 7365 7420 6973 204e  f val_reset is N
-0003daa0: 6f6e 6520 616e 6420 7661 6c5f 7072 6576  one and val_prev
-0003dab0: 2069 7320 6e6f 7420 4e6f 6e65 3a0d 0a20   is not None:.. 
-0003dac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003dad0: 2020 2074 656e 736f 7264 6963 745f 7265     tensordict_re
-0003dae0: 7365 742e 7365 7428 696e 5f6b 6579 2c20  set.set(in_key, 
-0003daf0: 7661 6c5f 7072 6576 290d 0a20 2020 2020  val_prev)..     
-0003db00: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0003db10: 7661 6c5f 7072 6576 2069 7320 4e6f 6e65  val_prev is None
-0003db20: 2061 6e64 2076 616c 5f72 6573 6574 2069   and val_reset i
-0003db30: 7320 4e6f 6e65 3a0d 0a20 2020 2020 2020  s None:..       
-0003db40: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-0003db50: 7365 204b 6579 4572 726f 7228 6622 436f  se KeyError(f"Co
-0003db60: 756c 6420 6e6f 7420 6669 6e64 207b 696e  uld not find {in
-0003db70: 5f6b 6579 7d20 696e 2074 6865 2072 6573  _key} in the res
-0003db80: 6574 2064 6174 612e 2229 0d0a 2020 2020  et data.")..    
-0003db90: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0003dba0: 656c 662e 5f63 616c 6c28 7465 6e73 6f72  elf._call(tensor
-0003dbb0: 6469 6374 5f72 6573 6574 2c20 5f72 6573  dict_reset, _res
-0003dbc0: 6574 3d5f 7265 7365 7429 0d0a 0d0a 2020  et=_reset)....  
-0003dbd0: 2020 6465 6620 5f6d 616b 655f 6d69 7373    def _make_miss
-0003dbe0: 696e 675f 6275 6666 6572 2873 656c 662c  ing_buffer(self,
-0003dbf0: 2074 656e 736f 7264 6963 742c 2069 6e5f   tensordict, in_
-0003dc00: 6b65 792c 2062 7566 6665 725f 6e61 6d65  key, buffer_name
-0003dc10: 293a 0d0a 2020 2020 2020 2020 6275 6666  ):..        buff
-0003dc20: 6572 203d 2067 6574 6174 7472 2873 656c  er = getattr(sel
-0003dc30: 662c 2062 7566 6665 725f 6e61 6d65 290d  f, buffer_name).
-0003dc40: 0a20 2020 2020 2020 2064 6174 6120 3d20  .        data = 
-0003dc50: 7465 6e73 6f72 6469 6374 2e67 6574 2869  tensordict.get(i
-0003dc60: 6e5f 6b65 7929 0d0a 2020 2020 2020 2020  n_key)..        
-0003dc70: 7369 7a65 203d 206c 6973 7428 6461 7461  size = list(data
-0003dc80: 2e73 6861 7065 290d 0a20 2020 2020 2020  .shape)..       
-0003dc90: 2073 697a 652e 696e 7365 7274 2830 2c20   size.insert(0, 
-0003dca0: 7365 6c66 2e62 7566 6665 725f 7369 7a65  self.buffer_size
-0003dcb0: 290d 0a20 2020 2020 2020 2062 7566 6665  )..        buffe
-0003dcc0: 722e 6d61 7465 7269 616c 697a 6528 7369  r.materialize(si
-0003dcd0: 7a65 290d 0a20 2020 2020 2020 2062 7566  ze)..        buf
-0003dce0: 6665 7220 3d20 6275 6666 6572 2e74 6f28  fer = buffer.to(
-0003dcf0: 6474 7970 653d 6461 7461 2e64 7479 7065  dtype=data.dtype
-0003dd00: 2c20 6465 7669 6365 3d64 6174 612e 6465  , device=data.de
-0003dd10: 7669 6365 292e 7a65 726f 5f28 290d 0a20  vice).zero_().. 
-0003dd20: 2020 2020 2020 2073 6574 6174 7472 2873         setattr(s
-0003dd30: 656c 662c 2062 7566 6665 725f 6e61 6d65  elf, buffer_name
-0003dd40: 2c20 6275 6666 6572 290d 0a20 2020 2020  , buffer)..     
-0003dd50: 2020 2072 6574 7572 6e20 6275 6666 6572     return buffer
-0003dd60: 0d0a 0d0a 2020 2020 6465 6620 5f63 616c  ....    def _cal
-0003dd70: 6c28 7365 6c66 2c20 7465 6e73 6f72 6469  l(self, tensordi
-0003dd80: 6374 3a20 5465 6e73 6f72 4469 6374 4261  ct: TensorDictBa
-0003dd90: 7365 2c20 5f72 6573 6574 3d4e 6f6e 6529  se, _reset=None)
-0003dda0: 202d 3e20 5465 6e73 6f72 4469 6374 4261   -> TensorDictBa
-0003ddb0: 7365 3a0d 0a20 2020 2020 2020 2022 2222  se:..        """
-0003ddc0: 5570 6461 7465 2074 6865 2065 7069 736f  Update the episo
-0003ddd0: 6465 2074 656e 736f 7264 6963 7420 7769  de tensordict wi
-0003dde0: 7468 206d 6178 2070 6f6f 6c65 6420 6b65  th max pooled ke
-0003ddf0: 7973 2e22 2222 0d0a 2020 2020 2020 2020  ys."""..        
-0003de00: 666f 7220 696e 5f6b 6579 2c20 6f75 745f  for in_key, out_
-0003de10: 6b65 7920 696e 207a 6970 2873 656c 662e  key in zip(self.
-0003de20: 696e 5f6b 6579 732c 2073 656c 662e 6f75  in_keys, self.ou
-0003de30: 745f 6b65 7973 293a 0d0a 2020 2020 2020  t_keys):..      
-0003de40: 2020 2020 2020 2320 4c61 7a79 2069 6e69        # Lazy ini
-0003de50: 7420 6f66 2062 7566 6665 7273 0d0a 2020  t of buffers..  
-0003de60: 2020 2020 2020 2020 2020 6275 6666 6572            buffer
-0003de70: 5f6e 616d 6520 3d20 7365 6c66 2e5f 6275  _name = self._bu
-0003de80: 6666 6572 5f6e 616d 6528 696e 5f6b 6579  ffer_name(in_key
-0003de90: 290d 0a20 2020 2020 2020 2020 2020 2062  )..            b
-0003dea0: 7566 6665 7220 3d20 6765 7461 7474 7228  uffer = getattr(
-0003deb0: 7365 6c66 2c20 6275 6666 6572 5f6e 616d  self, buffer_nam
-0003dec0: 6529 0d0a 2020 2020 2020 2020 2020 2020  e)..            
-0003ded0: 6966 2069 7369 6e73 7461 6e63 6528 6275  if isinstance(bu
-0003dee0: 6666 6572 2c20 746f 7263 682e 6e6e 2e70  ffer, torch.nn.p
-0003def0: 6172 616d 6574 6572 2e55 6e69 6e69 7469  arameter.Uniniti
-0003df00: 616c 697a 6564 4275 6666 6572 293a 0d0a  alizedBuffer):..
-0003df10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003df20: 6275 6666 6572 203d 2073 656c 662e 5f6d  buffer = self._m
-0003df30: 616b 655f 6d69 7373 696e 675f 6275 6666  ake_missing_buff
-0003df40: 6572 2874 656e 736f 7264 6963 742c 2069  er(tensordict, i
-0003df50: 6e5f 6b65 792c 2062 7566 6665 725f 6e61  n_key, buffer_na
-0003df60: 6d65 290d 0a20 2020 2020 2020 2020 2020  me)..           
-0003df70: 2069 6620 5f72 6573 6574 2069 7320 6e6f   if _reset is no
-0003df80: 7420 4e6f 6e65 3a0d 0a20 2020 2020 2020  t None:..       
-0003df90: 2020 2020 2020 2020 2023 2077 6520 6d75           # we mu
-0003dfa0: 7374 2075 7365 206f 6e6c 7920 7468 6520  st use only the 
-0003dfb0: 7265 7365 7420 6461 7461 0d0a 2020 2020  reset data..    
-0003dfc0: 2020 2020 2020 2020 2020 2020 6275 6666              buff
-0003dfd0: 6572 5b3a 2c20 5f72 6573 6574 5d20 3d20  er[:, _reset] = 
-0003dfe0: 746f 7263 682e 726f 6c6c 2862 7566 6665  torch.roll(buffe
-0003dff0: 725b 3a2c 205f 7265 7365 745d 2c20 7368  r[:, _reset], sh
-0003e000: 6966 7473 3d31 2c20 6469 6d73 3d30 290d  ifts=1, dims=0).
-0003e010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e020: 2023 2061 6464 206e 6577 206f 6273 0d0a   # add new obs..
-0003e030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e040: 6461 7461 203d 2074 656e 736f 7264 6963  data = tensordic
-0003e050: 742e 6765 7428 696e 5f6b 6579 290d 0a20  t.get(in_key).. 
-0003e060: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0003e070: 7566 6665 725b 302c 205f 7265 7365 745d  uffer[0, _reset]
-0003e080: 203d 2064 6174 615b 5f72 6573 6574 5d0d   = data[_reset].
-0003e090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e0a0: 2023 2061 7070 6c79 206d 6178 2070 6f6f   # apply max poo
-0003e0b0: 6c69 6e67 0d0a 2020 2020 2020 2020 2020  ling..          
-0003e0c0: 2020 2020 2020 706f 6f6c 6564 5f74 656e        pooled_ten
-0003e0d0: 736f 722c 205f 203d 2062 7566 6665 725b  sor, _ = buffer[
-0003e0e0: 3a2c 205f 7265 7365 745d 2e6d 6178 2864  :, _reset].max(d
-0003e0f0: 696d 3d30 290d 0a20 2020 2020 2020 2020  im=0)..         
-0003e100: 2020 2020 2020 2070 6f6f 6c65 645f 7465         pooled_te
-0003e110: 6e73 6f72 203d 2074 6f72 6368 2e7a 6572  nsor = torch.zer
-0003e120: 6f73 5f6c 696b 6528 6461 7461 292e 6d61  os_like(data).ma
-0003e130: 736b 6564 5f73 6361 7474 6572 5f28 0d0a  sked_scatter_(..
-0003e140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e150: 2020 2020 6578 7061 6e64 5f61 735f 7269      expand_as_ri
-0003e160: 6768 7428 5f72 6573 6574 2c20 6461 7461  ght(_reset, data
-0003e170: 292c 2070 6f6f 6c65 645f 7465 6e73 6f72  ), pooled_tensor
-0003e180: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0003e190: 2020 290d 0a20 2020 2020 2020 2020 2020    )..           
-0003e1a0: 2020 2020 2023 2061 6464 2074 6f20 7465       # add to te
-0003e1b0: 6e73 6f72 6469 6374 0d0a 2020 2020 2020  nsordict..      
-0003e1c0: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
-0003e1d0: 6469 6374 2e73 6574 286f 7574 5f6b 6579  dict.set(out_key
-0003e1e0: 2c20 706f 6f6c 6564 5f74 656e 736f 7229  , pooled_tensor)
-0003e1f0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0003e200: 2020 636f 6e74 696e 7565 0d0a 2020 2020    continue..    
-0003e210: 2020 2020 2020 2020 2320 7368 6966 7420          # shift 
-0003e220: 6f62 7320 3120 706f 7369 7469 6f6e 2074  obs 1 position t
-0003e230: 6f20 7468 6520 7269 6768 740d 0a20 2020  o the right..   
-0003e240: 2020 2020 2020 2020 2062 7566 6665 722e           buffer.
-0003e250: 636f 7079 5f28 746f 7263 682e 726f 6c6c  copy_(torch.roll
-0003e260: 2862 7566 6665 722c 2073 6869 6674 733d  (buffer, shifts=
-0003e270: 312c 2064 696d 733d 3029 290d 0a20 2020  1, dims=0))..   
-0003e280: 2020 2020 2020 2020 2023 2061 6464 206e           # add n
-0003e290: 6577 206f 6273 0d0a 2020 2020 2020 2020  ew obs..        
-0003e2a0: 2020 2020 6275 6666 6572 5b30 5d2e 636f      buffer[0].co
-0003e2b0: 7079 5f28 7465 6e73 6f72 6469 6374 2e67  py_(tensordict.g
-0003e2c0: 6574 2869 6e5f 6b65 7929 290d 0a20 2020  et(in_key))..   
-0003e2d0: 2020 2020 2020 2020 2023 2061 7070 6c79           # apply
-0003e2e0: 206d 6178 2070 6f6f 6c69 6e67 0d0a 2020   max pooling..  
-0003e2f0: 2020 2020 2020 2020 2020 706f 6f6c 6564            pooled
-0003e300: 5f74 656e 736f 722c 205f 203d 2062 7566  _tensor, _ = buf
-0003e310: 6665 722e 6d61 7828 6469 6d3d 3029 0d0a  fer.max(dim=0)..
-0003e320: 2020 2020 2020 2020 2020 2020 2320 6164              # ad
-0003e330: 6420 746f 2074 656e 736f 7264 6963 740d  d to tensordict.
-0003e340: 0a20 2020 2020 2020 2020 2020 2074 656e  .            ten
-0003e350: 736f 7264 6963 742e 7365 7428 6f75 745f  sordict.set(out_
-0003e360: 6b65 792c 2070 6f6f 6c65 645f 7465 6e73  key, pooled_tens
-0003e370: 6f72 290d 0a0d 0a20 2020 2020 2020 2072  or)....        r
-0003e380: 6574 7572 6e20 7465 6e73 6f72 6469 6374  eturn tensordict
-0003e390: 0d0a 0d0a 2020 2020 405f 6170 706c 795f  ....    @_apply_
-0003e3a0: 746f 5f63 6f6d 706f 7369 7465 0d0a 2020  to_composite..  
-0003e3b0: 2020 6465 6620 7472 616e 7366 6f72 6d5f    def transform_
-0003e3c0: 6f62 7365 7276 6174 696f 6e5f 7370 6563  observation_spec
-0003e3d0: 2873 656c 662c 206f 6273 6572 7661 7469  (self, observati
-0003e3e0: 6f6e 5f73 7065 633a 2054 656e 736f 7253  on_spec: TensorS
-0003e3f0: 7065 6329 202d 3e20 5465 6e73 6f72 5370  pec) -> TensorSp
-0003e400: 6563 3a0d 0a20 2020 2020 2020 2072 6574  ec:..        ret
-0003e410: 7572 6e20 6f62 7365 7276 6174 696f 6e5f  urn observation_
-0003e420: 7370 6563 0d0a 0d0a 2020 2020 6465 6620  spec....    def 
-0003e430: 666f 7277 6172 6428 7365 6c66 2c20 7465  forward(self, te
-0003e440: 6e73 6f72 6469 6374 3a20 5465 6e73 6f72  nsordict: Tensor
-0003e450: 4469 6374 4261 7365 2920 2d3e 2054 656e  DictBase) -> Ten
-0003e460: 736f 7244 6963 7442 6173 653a 0d0a 2020  sorDictBase:..  
-0003e470: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
-0003e480: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
-0003e490: 0d0a 2020 2020 2020 2020 2020 2020 2254  ..            "T
-0003e4a0: 696d 654d 6178 506f 6f6c 2063 616e 6e6f  imeMaxPool canno
-0003e4b0: 7420 6265 2063 616c 6c65 6420 696e 6465  t be called inde
-0003e4c0: 7065 6e64 656e 746c 792c 206f 6e6c 7920  pendently, only 
-0003e4d0: 6974 7320 7374 6570 2061 6e64 2072 6573  its step and res
-0003e4e0: 6574 206d 6574 686f 6473 2022 0d0a 2020  et methods "..  
-0003e4f0: 2020 2020 2020 2020 2020 2261 7265 2066            "are f
-0003e500: 756e 6374 696f 6e61 6c2e 2054 6865 2072  unctional. The r
-0003e510: 6561 736f 6e20 666f 7220 7468 6973 2069  eason for this i
-0003e520: 7320 7468 6174 2069 7420 6973 2068 6172  s that it is har
-0003e530: 6420 746f 2063 6f6e 7369 6465 7220 7573  d to consider us
-0003e540: 696e 6720 220d 0a20 2020 2020 2020 2020  ing "..         
-0003e550: 2020 2022 5469 6d65 4d61 7850 6f6f 6c20     "TimeMaxPool 
-0003e560: 7769 7468 206e 6f6e 2d73 6571 7565 6e74  with non-sequent
-0003e570: 6961 6c20 6461 7461 2c20 7375 6368 2061  ial data, such a
-0003e580: 7320 7468 6f73 6520 636f 6c6c 6563 7465  s those collecte
-0003e590: 6420 6279 2061 2072 6570 6c61 7920 6275  d by a replay bu
-0003e5a0: 6666 6572 2022 0d0a 2020 2020 2020 2020  ffer "..        
-0003e5b0: 2020 2020 226f 7220 6120 6461 7461 7365      "or a datase
-0003e5c0: 742e 2049 6620 796f 7520 6e65 6564 2054  t. If you need T
-0003e5d0: 696d 654d 6178 506f 6f6c 2074 6f20 776f  imeMaxPool to wo
-0003e5e0: 726b 206f 6e20 6120 6261 7463 6820 6f66  rk on a batch of
-0003e5f0: 2073 6571 7565 6e74 6961 6c20 6461 7461   sequential data
-0003e600: 2022 0d0a 2020 2020 2020 2020 2020 2020   "..            
-0003e610: 2228 6965 2061 7320 4c53 544d 2077 6f75  "(ie as LSTM wou
-0003e620: 6c64 2077 6f72 6b20 6f76 6572 2061 2077  ld work over a w
-0003e630: 686f 6c65 2073 6571 7565 6e63 6520 6f66  hole sequence of
-0003e640: 2064 6174 6129 2c20 6669 6c65 2061 6e20   data), file an 
-0003e650: 6973 7375 6520 6f6e 2022 0d0a 2020 2020  issue on "..    
-0003e660: 2020 2020 2020 2020 2254 6f72 6368 524c          "TorchRL
-0003e670: 2072 6571 7565 7374 696e 6720 7468 6174   requesting that
-0003e680: 2066 6561 7475 7265 2e22 0d0a 2020 2020   feature."..    
-0003e690: 2020 2020 290d 0a0d 0a0d 0a63 6c61 7373      )......class
-0003e6a0: 2052 616e 646f 6d43 726f 7054 656e 736f   RandomCropTenso
-0003e6b0: 7244 6963 7428 5472 616e 7366 6f72 6d29  rDict(Transform)
-0003e6c0: 3a0d 0a20 2020 2022 2222 4120 7472 616a  :..    """A traj
-0003e6d0: 6563 746f 7279 2073 7562 2d73 616d 706c  ectory sub-sampl
-0003e6e0: 6572 2066 6f72 2052 6570 6c61 7942 7566  er for ReplayBuf
-0003e6f0: 6665 7220 616e 6420 6d6f 6475 6c65 732e  fer and modules.
-0003e700: 0d0a 0d0a 2020 2020 4761 7468 6572 7320  ....    Gathers 
-0003e710: 6120 7375 622d 7365 7175 656e 6365 206f  a sub-sequence o
-0003e720: 6620 6120 6465 6669 6e65 6420 6c65 6e67  f a defined leng
-0003e730: 7468 2061 6c6f 6e67 2074 6865 206c 6173  th along the las
-0003e740: 7420 6469 6d65 6e73 696f 6e20 6f66 2074  t dimension of t
-0003e750: 6865 2069 6e70 7574 0d0a 2020 2020 7465  he input..    te
-0003e760: 6e73 6f72 6469 6374 2e0d 0a20 2020 2054  nsordict...    T
-0003e770: 6869 7320 6361 6e20 6265 2075 7365 6420  his can be used 
-0003e780: 746f 2067 6574 2063 726f 7070 6564 2074  to get cropped t
-0003e790: 7261 6a65 6374 6f72 6965 7320 6672 6f6d  rajectories from
-0003e7a0: 2074 7261 6a65 6374 6f72 6965 7320 7361   trajectories sa
-0003e7b0: 6d70 6c65 640d 0a20 2020 2066 726f 6d20  mpled..    from 
-0003e7c0: 6120 5265 706c 6179 4275 6666 6572 2e0d  a ReplayBuffer..
-0003e7d0: 0a0d 0a20 2020 2054 6869 7320 7472 616e  ...    This tran
-0003e7e0: 7366 6f72 6d20 6973 2070 7269 6d61 7269  sform is primari
-0003e7f0: 6c79 2064 6573 6967 6e65 6420 746f 2062  ly designed to b
-0003e800: 6520 7573 6564 2077 6974 6820 7265 706c  e used with repl
-0003e810: 6179 2062 7566 6665 7273 2061 6e64 206d  ay buffers and m
-0003e820: 6f64 756c 6573 2e0d 0a20 2020 2043 7572  odules...    Cur
-0003e830: 7265 6e74 6c79 2c20 6974 2063 616e 6e6f  rently, it canno
-0003e840: 7420 6265 2075 7365 6420 6173 2061 6e20  t be used as an 
-0003e850: 656e 7669 726f 6e6d 656e 7420 7472 616e  environment tran
-0003e860: 7366 6f72 6d2e 0d0a 2020 2020 446f 206e  sform...    Do n
-0003e870: 6f74 2068 6573 6974 6174 6520 746f 2072  ot hesitate to r
-0003e880: 6571 7565 7374 2066 6f72 2074 6869 7320  equest for this 
-0003e890: 6265 6861 7669 6f75 7220 7468 726f 7567  behaviour throug
-0003e8a0: 6820 616e 2069 7373 7565 2069 6620 7468  h an issue if th
-0003e8b0: 6973 2069 730d 0a20 2020 2064 6573 6972  is is..    desir
-0003e8c0: 6564 2e0d 0a0d 0a20 2020 2041 7267 733a  ed.....    Args:
-0003e8d0: 0d0a 2020 2020 2020 2020 7375 625f 7365  ..        sub_se
-0003e8e0: 715f 6c65 6e20 2869 6e74 293a 2074 6865  q_len (int): the
-0003e8f0: 206c 656e 6774 6820 6f66 2074 6865 2073   length of the s
-0003e900: 7562 2d74 7261 6a65 6374 6f72 7920 746f  ub-trajectory to
-0003e910: 2073 616d 706c 650d 0a20 2020 2020 2020   sample..       
-0003e920: 2073 616d 706c 655f 6469 6d20 2869 6e74   sample_dim (int
-0003e930: 2c20 6f70 7469 6f6e 616c 293a 2074 6865  , optional): the
-0003e940: 2064 696d 656e 7369 6f6e 2061 6c6f 6e67   dimension along
-0003e950: 2077 6869 6368 2074 6865 2063 726f 7070   which the cropp
-0003e960: 696e 670d 0a20 2020 2020 2020 2020 2020  ing..           
-0003e970: 2073 686f 756c 6420 6f63 6375 722e 204e   should occur. N
-0003e980: 6567 6174 6976 6520 6469 6d65 6e73 696f  egative dimensio
-0003e990: 6e73 2073 686f 756c 6420 6265 2070 7265  ns should be pre
-0003e9a0: 6665 7272 6564 2074 6f20 6d61 6b65 0d0a  ferred to make..
-0003e9b0: 2020 2020 2020 2020 2020 2020 7468 6520              the 
-0003e9c0: 7472 616e 7366 6f72 6d20 726f 6275 7374  transform robust
-0003e9d0: 2074 6f20 7465 6e73 6f72 6469 6374 7320   to tensordicts 
-0003e9e0: 6f66 2076 6172 7969 6e67 2062 6174 6368  of varying batch
-0003e9f0: 2064 696d 656e 7369 6f6e 732e 0d0a 2020   dimensions...  
-0003ea00: 2020 2020 2020 2020 2020 4465 6661 756c            Defaul
-0003ea10: 7473 2074 6f20 2d31 2028 7468 6520 6465  ts to -1 (the de
-0003ea20: 6661 756c 7420 7469 6d65 2064 696d 656e  fault time dimen
-0003ea30: 7369 6f6e 2069 6e20 546f 7263 6852 4c29  sion in TorchRL)
-0003ea40: 2e0d 0a20 2020 2020 2020 206d 6173 6b5f  ...        mask_
-0003ea50: 6b65 7920 284e 6573 7465 644b 6579 293a  key (NestedKey):
-0003ea60: 2049 6620 7072 6f76 6964 6564 2c20 7468   If provided, th
-0003ea70: 6973 2072 6570 7265 7365 6e74 7320 7468  is represents th
-0003ea80: 6520 6d61 736b 206b 6579 2074 6f20 6265  e mask key to be
-0003ea90: 206c 6f6f 6b65 640d 0a20 2020 2020 2020   looked..       
-0003eaa0: 2020 2020 2066 6f72 2077 6865 6e20 646f       for when do
-0003eab0: 696e 6720 7468 6520 7361 6d70 6c69 6e67  ing the sampling
-0003eac0: 2e20 4966 2070 726f 7669 6465 642c 2069  . If provided, i
-0003ead0: 7420 6f6e 6c79 2076 616c 6964 2065 6c65  t only valid ele
-0003eae0: 6d65 6e74 7320 7769 6c6c 0d0a 2020 2020  ments will..    
-0003eaf0: 2020 2020 2020 2020 6265 2072 6574 7572          be retur
-0003eb00: 6e65 642e 2049 7420 6973 2061 7373 756d  ned. It is assum
-0003eb10: 6564 2074 6861 7420 7468 6520 6d61 736b  ed that the mask
-0003eb20: 2069 7320 6120 626f 6f6c 6561 6e20 7465   is a boolean te
-0003eb30: 6e73 6f72 2077 6974 680d 0a20 2020 2020  nsor with..     
-0003eb40: 2020 2020 2020 2066 6972 7374 2054 7275         first Tru
-0003eb50: 6520 7661 6c75 6573 2061 6e64 2074 6865  e values and the
-0003eb60: 6e20 4661 6c73 6520 7661 6c75 6573 2c20  n False values, 
-0003eb70: 6e6f 7420 6d69 7865 6420 746f 6765 7468  not mixed togeth
-0003eb80: 6572 2e0d 0a20 2020 2020 2020 2020 2020  er...           
-0003eb90: 203a 636c 6173 733a 6052 616e 646f 6d43   :class:`RandomC
-0003eba0: 726f 7054 656e 736f 7244 6963 7460 2077  ropTensorDict` w
-0003ebb0: 696c 6c20 4e4f 5420 6368 6563 6b20 7468  ill NOT check th
-0003ebc0: 6174 2074 6869 7320 6973 2072 6573 7065  at this is respe
-0003ebd0: 6374 6564 0d0a 2020 2020 2020 2020 2020  cted..          
-0003ebe0: 2020 6865 6e63 6520 616e 7920 6572 726f    hence any erro
-0003ebf0: 7220 6361 7573 6564 2062 7920 616e 2069  r caused by an i
-0003ec00: 6d70 726f 7065 7220 6d61 736b 2072 6973  mproper mask ris
-0003ec10: 6b73 2074 6f20 676f 2075 6e6e 6f74 6963  ks to go unnotic
-0003ec20: 6564 2e0d 0a20 2020 2020 2020 2020 2020  ed...           
-0003ec30: 2044 6566 6175 6c74 733a 204e 6f6e 6520   Defaults: None 
-0003ec40: 286e 6f20 6d61 736b 206b 6579 292e 0d0a  (no mask key)...
-0003ec50: 2020 2020 2222 220d 0a0d 0a20 2020 2064      """....    d
-0003ec60: 6566 205f 5f69 6e69 745f 5f28 0d0a 2020  ef __init__(..  
-0003ec70: 2020 2020 2020 7365 6c66 2c0d 0a20 2020        self,..   
-0003ec80: 2020 2020 2073 7562 5f73 6571 5f6c 656e       sub_seq_len
-0003ec90: 3a20 696e 742c 0d0a 2020 2020 2020 2020  : int,..        
-0003eca0: 7361 6d70 6c65 5f64 696d 3a20 696e 7420  sample_dim: int 
-0003ecb0: 3d20 2d31 2c0d 0a20 2020 2020 2020 206d  = -1,..        m
-0003ecc0: 6173 6b5f 6b65 793a 204f 7074 696f 6e61  ask_key: Optiona
-0003ecd0: 6c5b 4e65 7374 6564 4b65 795d 203d 204e  l[NestedKey] = N
-0003ece0: 6f6e 652c 0d0a 2020 2020 293a 0d0a 2020  one,..    ):..  
-0003ecf0: 2020 2020 2020 7365 6c66 2e73 7562 5f73        self.sub_s
-0003ed00: 6571 5f6c 656e 203d 2073 7562 5f73 6571  eq_len = sub_seq
-0003ed10: 5f6c 656e 0d0a 2020 2020 2020 2020 6966  _len..        if
-0003ed20: 2073 616d 706c 655f 6469 6d20 3e20 303a   sample_dim > 0:
-0003ed30: 0d0a 2020 2020 2020 2020 2020 2020 7761  ..            wa
-0003ed40: 726e 696e 6773 2e77 6172 6e28 0d0a 2020  rnings.warn(..  
-0003ed50: 2020 2020 2020 2020 2020 2020 2020 2241                "A
-0003ed60: 2070 6f73 6974 6976 6520 7368 6170 6520   positive shape 
-0003ed70: 6861 7320 6265 656e 2070 6173 7365 6420  has been passed 
-0003ed80: 746f 2074 6865 2052 616e 646f 6d43 726f  to the RandomCro
-0003ed90: 7054 656e 736f 7244 6963 7420 220d 0a20  pTensorDict ".. 
-0003eda0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0003edb0: 636f 6e73 7472 7563 746f 722e 2054 6869  constructor. Thi
-0003edc0: 7320 6d61 7920 6861 7665 2075 6e65 7870  s may have unexp
-0003edd0: 6563 7465 6420 6265 6861 7669 6f75 7273  ected behaviours
-0003ede0: 2077 6865 6e20 7468 6520 220d 0a20 2020   when the "..   
-0003edf0: 2020 2020 2020 2020 2020 2020 2022 7061               "pa
-0003ee00: 7373 6564 2074 656e 736f 7264 6963 7473  ssed tensordicts
-0003ee10: 2068 6176 6520 696e 636f 6e73 6973 7465   have inconsiste
-0003ee20: 6e74 2062 6174 6368 2064 696d 656e 7369  nt batch dimensi
-0003ee30: 6f6e 732e 2022 0d0a 2020 2020 2020 2020  ons. "..        
-0003ee40: 2020 2020 2020 2020 2246 6f72 2063 6f6e          "For con
-0003ee50: 7465 7874 2c20 6279 2063 6f6e 7665 6e74  text, by convent
-0003ee60: 696f 6e2c 2054 6f72 6368 524c 2063 6f6e  ion, TorchRL con
-0003ee70: 6361 7465 6e61 7465 7320 7469 6d65 2073  catenates time s
-0003ee80: 7465 7073 2022 0d0a 2020 2020 2020 2020  teps "..        
-0003ee90: 2020 2020 2020 2020 2261 6c6f 6e67 2074          "along t
-0003eea0: 6865 206c 6173 7420 6469 6d65 6e73 696f  he last dimensio
-0003eeb0: 6e20 6f66 2074 6865 2074 656e 736f 7264  n of the tensord
-0003eec0: 6963 742e 220d 0a20 2020 2020 2020 2020  ict."..         
-0003eed0: 2020 2029 0d0a 2020 2020 2020 2020 7365     )..        se
-0003eee0: 6c66 2e73 616d 706c 655f 6469 6d20 3d20  lf.sample_dim = 
-0003eef0: 7361 6d70 6c65 5f64 696d 0d0a 2020 2020  sample_dim..    
-0003ef00: 2020 2020 7365 6c66 2e6d 6173 6b5f 6b65      self.mask_ke
-0003ef10: 7920 3d20 6d61 736b 5f6b 6579 0d0a 2020  y = mask_key..  
-0003ef20: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
-0003ef30: 696e 6974 5f5f 2829 0d0a 0d0a 2020 2020  init__()....    
-0003ef40: 6465 6620 666f 7277 6172 6428 7365 6c66  def forward(self
-0003ef50: 2c20 7465 6e73 6f72 6469 6374 3a20 5465  , tensordict: Te
-0003ef60: 6e73 6f72 4469 6374 4261 7365 2920 2d3e  nsorDictBase) ->
-0003ef70: 2054 656e 736f 7244 6963 7442 6173 653a   TensorDictBase:
-0003ef80: 0d0a 2020 2020 2020 2020 7368 6170 6520  ..        shape 
-0003ef90: 3d20 7465 6e73 6f72 6469 6374 2e73 6861  = tensordict.sha
-0003efa0: 7065 0d0a 2020 2020 2020 2020 6469 6d20  pe..        dim 
-0003efb0: 3d20 7365 6c66 2e73 616d 706c 655f 6469  = self.sample_di
-0003efc0: 6d0d 0a20 2020 2020 2020 2023 2073 6861  m..        # sha
-0003efd0: 7065 206d 7573 7420 6861 7665 2061 7420  pe must have at 
-0003efe0: 6c65 6173 7420 6f6e 6520 6469 6d65 6e73  least one dimens
-0003eff0: 696f 6e0d 0a20 2020 2020 2020 2069 6620  ion..        if 
-0003f000: 6e6f 7420 6c65 6e28 7368 6170 6529 3a0d  not len(shape):.
-0003f010: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-0003f020: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
-0003f030: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0003f040: 2020 2243 616e 6e6f 7420 7375 622d 7361    "Cannot sub-sa
-0003f050: 6d70 6c65 2066 726f 6d20 6120 7465 6e73  mple from a tens
-0003f060: 6f72 6469 6374 2077 6974 6820 616e 2065  ordict with an e
-0003f070: 6d70 7479 2073 6861 7065 2e22 0d0a 2020  mpty shape."..  
-0003f080: 2020 2020 2020 2020 2020 290d 0a20 2020            )..   
-0003f090: 2020 2020 2069 6620 7368 6170 655b 6469       if shape[di
-0003f0a0: 6d5d 203c 2073 656c 662e 7375 625f 7365  m] < self.sub_se
-0003f0b0: 715f 6c65 6e3a 0d0a 2020 2020 2020 2020  q_len:..        
-0003f0c0: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
-0003f0d0: 6545 7272 6f72 280d 0a20 2020 2020 2020  eError(..       
-0003f0e0: 2020 2020 2020 2020 2066 2243 616e 6e6f           f"Canno
-0003f0f0: 7420 7361 6d70 6c65 2074 7261 6a65 6374  t sample traject
-0003f100: 6f72 6965 7320 6f66 206c 656e 6774 6820  ories of length 
-0003f110: 7b73 656c 662e 7375 625f 7365 715f 6c65  {self.sub_seq_le
-0003f120: 6e7d 2061 6c6f 6e67 220d 0a20 2020 2020  n} along"..     
-0003f130: 2020 2020 2020 2020 2020 2066 2220 6469             f" di
-0003f140: 6d65 6e73 696f 6e20 7b64 696d 7d20 6769  mension {dim} gi
-0003f150: 7665 6e20 6120 7465 6e73 6f72 6469 6374  ven a tensordict
-0003f160: 206f 6620 7368 6170 6520 220d 0a20 2020   of shape "..   
-0003f170: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
-0003f180: 7465 6e73 6f72 6469 6374 2e73 6861 7065  tensordict.shape
-0003f190: 7d2e 2043 6f6e 7369 6465 7220 7265 6475  }. Consider redu
-0003f1a0: 6369 6e67 2074 6865 2073 7562 5f73 6571  cing the sub_seq
-0003f1b0: 5f6c 656e 2022 0d0a 2020 2020 2020 2020  _len "..        
-0003f1c0: 2020 2020 2020 2020 6622 7061 7261 6d65          f"parame
-0003f1d0: 7465 7220 6f72 2069 6e63 7265 6173 6520  ter or increase 
-0003f1e0: 7361 6d70 6c65 206c 656e 6774 682e 220d  sample length.".
-0003f1f0: 0a20 2020 2020 2020 2020 2020 2029 0d0a  .            )..
-0003f200: 2020 2020 2020 2020 6d61 785f 6964 785f          max_idx_
-0003f210: 3020 3d20 7368 6170 655b 6469 6d5d 202d  0 = shape[dim] -
-0003f220: 2073 656c 662e 7375 625f 7365 715f 6c65   self.sub_seq_le
-0003f230: 6e0d 0a20 2020 2020 2020 2069 6478 5f73  n..        idx_s
-0003f240: 6861 7065 203d 206c 6973 7428 7465 6e73  hape = list(tens
-0003f250: 6f72 6469 6374 2e73 6861 7065 290d 0a20  ordict.shape).. 
-0003f260: 2020 2020 2020 2069 6478 5f73 6861 7065         idx_shape
-0003f270: 5b64 696d 5d20 3d20 310d 0a20 2020 2020  [dim] = 1..     
-0003f280: 2020 2064 6576 6963 6520 3d20 7465 6e73     device = tens
-0003f290: 6f72 6469 6374 2e64 6576 6963 650d 0a20  ordict.device.. 
-0003f2a0: 2020 2020 2020 2069 6620 6465 7669 6365         if device
-0003f2b0: 2069 7320 4e6f 6e65 3a0d 0a20 2020 2020   is None:..     
-0003f2c0: 2020 2020 2020 2064 6576 6963 6520 3d20         device = 
-0003f2d0: 746f 7263 682e 6465 7669 6365 2822 6370  torch.device("cp
-0003f2e0: 7522 290d 0a20 2020 2020 2020 2069 6620  u")..        if 
-0003f2f0: 7365 6c66 2e6d 6173 6b5f 6b65 7920 6973  self.mask_key is
-0003f300: 204e 6f6e 6520 6f72 2073 656c 662e 6d61   None or self.ma
-0003f310: 736b 5f6b 6579 206e 6f74 2069 6e20 7465  sk_key not in te
-0003f320: 6e73 6f72 6469 6374 2e6b 6579 7328 0d0a  nsordict.keys(..
-0003f330: 2020 2020 2020 2020 2020 2020 6973 696e              isin
-0003f340: 7374 616e 6365 2873 656c 662e 6d61 736b  stance(self.mask
-0003f350: 5f6b 6579 2c20 7475 706c 6529 0d0a 2020  _key, tuple)..  
-0003f360: 2020 2020 2020 293a 0d0a 2020 2020 2020        ):..      
-0003f370: 2020 2020 2020 6964 785f 3020 3d20 746f        idx_0 = to
-0003f380: 7263 682e 7261 6e64 696e 7428 6d61 785f  rch.randint(max_
-0003f390: 6964 785f 302c 2069 6478 5f73 6861 7065  idx_0, idx_shape
-0003f3a0: 2c20 6465 7669 6365 3d64 6576 6963 6529  , device=device)
-0003f3b0: 0d0a 2020 2020 2020 2020 656c 7365 3a0d  ..        else:.
-0003f3c0: 0a20 2020 2020 2020 2020 2020 2023 2067  .            # g
-0003f3d0: 6574 2074 6865 2074 7261 6a20 6c65 6e67  et the traj leng
-0003f3e0: 7468 2066 6f72 2065 6163 6820 656e 7472  th for each entr
-0003f3f0: 790d 0a20 2020 2020 2020 2020 2020 206d  y..            m
-0003f400: 6173 6b20 3d20 7465 6e73 6f72 6469 6374  ask = tensordict
-0003f410: 2e67 6574 2873 656c 662e 6d61 736b 5f6b  .get(self.mask_k
-0003f420: 6579 290d 0a20 2020 2020 2020 2020 2020  ey)..           
-0003f430: 2069 6620 6d61 736b 2e73 6861 7065 2021   if mask.shape !
-0003f440: 3d20 7465 6e73 6f72 6469 6374 2e73 6861  = tensordict.sha
-0003f450: 7065 3a0d 0a20 2020 2020 2020 2020 2020  pe:..           
-0003f460: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-0003f470: 4572 726f 7228 0d0a 2020 2020 2020 2020  Error(..        
-0003f480: 2020 2020 2020 2020 2020 2020 2245 7870              "Exp
-0003f490: 6563 7465 6420 6120 6d61 736b 206f 6620  ected a mask of 
-0003f4a0: 7468 6520 7361 6d65 2073 6861 7065 2061  the same shape a
-0003f4b0: 7320 7468 6520 7465 6e73 6f72 6469 6374  s the tensordict
-0003f4c0: 2e20 476f 7420 220d 0a20 2020 2020 2020  . Got "..       
-0003f4d0: 2020 2020 2020 2020 2020 2020 2066 226d               f"m
-0003f4e0: 6173 6b2e 7368 6170 653d 7b6d 6173 6b2e  ask.shape={mask.
-0003f4f0: 7368 6170 657d 2061 6e64 2074 656e 736f  shape} and tenso
-0003f500: 7264 6963 742e 7368 6170 653d 220d 0a20  rdict.shape=".. 
-0003f510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f520: 2020 2066 227b 7465 6e73 6f72 6469 6374     f"{tensordict
-0003f530: 2e73 6861 7065 7d20 696e 7374 6561 642e  .shape} instead.
-0003f540: 220d 0a20 2020 2020 2020 2020 2020 2020  "..             
-0003f550: 2020 2029 0d0a 2020 2020 2020 2020 2020     )..          
-0003f560: 2020 7472 616a 5f6c 656e 6774 6873 203d    traj_lengths =
-0003f570: 206d 6173 6b2e 6375 6d73 756d 2873 656c   mask.cumsum(sel
-0003f580: 662e 7361 6d70 6c65 5f64 696d 292e 6d61  f.sample_dim).ma
-0003f590: 7828 7365 6c66 2e73 616d 706c 655f 6469  x(self.sample_di
-0003f5a0: 6d2c 2054 7275 6529 5b30 5d0d 0a20 2020  m, True)[0]..   
-0003f5b0: 2020 2020 2020 2020 2069 6620 2874 7261           if (tra
-0003f5c0: 6a5f 6c65 6e67 7468 7320 3c20 7365 6c66  j_lengths < self
-0003f5d0: 2e73 7562 5f73 6571 5f6c 656e 292e 616e  .sub_seq_len).an
-0003f5e0: 7928 293a 0d0a 2020 2020 2020 2020 2020  y():..          
-0003f5f0: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
-0003f600: 696d 6545 7272 6f72 280d 0a20 2020 2020  imeError(..     
-0003f610: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0003f620: 2243 616e 6e6f 7420 7361 6d70 6c65 2074  "Cannot sample t
-0003f630: 7261 6a65 6374 6f72 6965 7320 6f66 206c  rajectories of l
-0003f640: 656e 6774 6820 7b73 656c 662e 7375 625f  ength {self.sub_
-0003f650: 7365 715f 6c65 6e7d 2077 6865 6e20 7468  seq_len} when th
-0003f660: 6520 6d69 6e69 6d75 6d20 220d 0a20 2020  e minimum "..   
-0003f670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f680: 2066 2274 7261 6a65 6374 6f72 7920 6c65   f"trajectory le
-0003f690: 6e67 7468 2069 7320 7b74 7261 6a5f 6c65  ngth is {traj_le
-0003f6a0: 6e67 7468 732e 6d69 6e28 297d 2e22 0d0a  ngths.min()}."..
-0003f6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f6c0: 290d 0a20 2020 2020 2020 2020 2020 2023  )..            #
-0003f6d0: 2074 616b 6520 6120 7261 6e64 6f6d 206e   take a random n
-0003f6e0: 756d 6265 7220 6265 7477 6565 6e20 3020  umber between 0 
-0003f6f0: 616e 6420 7472 616a 5f6c 656e 6774 6873  and traj_lengths
-0003f700: 202d 2073 656c 662e 7375 625f 7365 715f   - self.sub_seq_
-0003f710: 6c65 6e0d 0a20 2020 2020 2020 2020 2020  len..           
-0003f720: 2069 6478 5f30 203d 2028 0d0a 2020 2020   idx_0 = (..    
-0003f730: 2020 2020 2020 2020 2020 2020 746f 7263              torc
-0003f740: 682e 7261 6e64 2869 6478 5f73 6861 7065  h.rand(idx_shape
-0003f750: 2c20 6465 7669 6365 3d64 6576 6963 6529  , device=device)
-0003f760: 202a 2028 7472 616a 5f6c 656e 6774 6873   * (traj_lengths
-0003f770: 202d 2073 656c 662e 7375 625f 7365 715f   - self.sub_seq_
-0003f780: 6c65 6e29 0d0a 2020 2020 2020 2020 2020  len)..          
-0003f790: 2020 292e 746f 2874 6f72 6368 2e6c 6f6e    ).to(torch.lon
-0003f7a0: 6729 0d0a 2020 2020 2020 2020 6172 616e  g)..        aran
-0003f7b0: 6765 203d 2074 6f72 6368 2e61 7261 6e67  ge = torch.arang
-0003f7c0: 6528 7365 6c66 2e73 7562 5f73 6571 5f6c  e(self.sub_seq_l
-0003f7d0: 656e 2c20 6465 7669 6365 3d69 6478 5f30  en, device=idx_0
-0003f7e0: 2e64 6576 6963 6529 0d0a 2020 2020 2020  .device)..      
-0003f7f0: 2020 6172 616e 6765 5f73 6861 7065 203d    arange_shape =
-0003f800: 205b 3120 666f 7220 5f20 696e 2072 616e   [1 for _ in ran
-0003f810: 6765 2874 656e 736f 7264 6963 742e 6e64  ge(tensordict.nd
-0003f820: 696d 656e 7369 6f6e 2829 295d 0d0a 2020  imension())]..  
-0003f830: 2020 2020 2020 6172 616e 6765 5f73 6861        arange_sha
-0003f840: 7065 5b64 696d 5d20 3d20 6c65 6e28 6172  pe[dim] = len(ar
-0003f850: 616e 6765 290d 0a20 2020 2020 2020 2061  ange)..        a
-0003f860: 7261 6e67 6520 3d20 6172 616e 6765 2e76  range = arange.v
-0003f870: 6965 7728 6172 616e 6765 5f73 6861 7065  iew(arange_shape
-0003f880: 290d 0a20 2020 2020 2020 2069 6478 203d  )..        idx =
-0003f890: 2069 6478 5f30 202b 2061 7261 6e67 650d   idx_0 + arange.
-0003f8a0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0003f8b0: 7465 6e73 6f72 6469 6374 2e67 6174 6865  tensordict.gathe
-0003f8c0: 7228 6469 6d3d 7365 6c66 2e73 616d 706c  r(dim=self.sampl
-0003f8d0: 655f 6469 6d2c 2069 6e64 6578 3d69 6478  e_dim, index=idx
-0003f8e0: 290d 0a0d 0a20 2020 2064 6566 205f 7265  )....    def _re
-0003f8f0: 7365 7428 0d0a 2020 2020 2020 2020 7365  set(..        se
-0003f900: 6c66 2c20 7465 6e73 6f72 6469 6374 3a20  lf, tensordict: 
-0003f910: 5465 6e73 6f72 4469 6374 4261 7365 2c20  TensorDictBase, 
-0003f920: 7465 6e73 6f72 6469 6374 5f72 6573 6574  tensordict_reset
-0003f930: 3a20 5465 6e73 6f72 4469 6374 4261 7365  : TensorDictBase
-0003f940: 0d0a 2020 2020 2920 2d3e 2054 656e 736f  ..    ) -> Tenso
-0003f950: 7244 6963 7442 6173 653a 0d0a 2020 2020  rDictBase:..    
-0003f960: 2020 2020 7769 7468 205f 7365 745f 6d69      with _set_mi
-0003f970: 7373 696e 675f 746f 6c65 7261 6e63 6528  ssing_tolerance(
-0003f980: 7365 6c66 2c20 5472 7565 293a 0d0a 2020  self, True):..  
-0003f990: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
-0003f9a0: 6469 6374 5f72 6573 6574 203d 2073 656c  dict_reset = sel
-0003f9b0: 662e 666f 7277 6172 6428 7465 6e73 6f72  f.forward(tensor
-0003f9c0: 6469 6374 5f72 6573 6574 290d 0a20 2020  dict_reset)..   
-0003f9d0: 2020 2020 2072 6574 7572 6e20 7465 6e73       return tens
-0003f9e0: 6f72 6469 6374 5f72 6573 6574 0d0a 0d0a  ordict_reset....
-0003f9f0: 0d0a 636c 6173 7320 496e 6974 5472 6163  ..class InitTrac
-0003fa00: 6b65 7228 5472 616e 7366 6f72 6d29 3a0d  ker(Transform):.
-0003fa10: 0a20 2020 2022 2222 5265 7365 7420 7472  .    """Reset tr
-0003fa20: 6163 6b65 722e 0d0a 0d0a 2020 2020 5468  acker.....    Th
-0003fa30: 6973 2074 7261 6e73 666f 726d 2070 6f70  is transform pop
-0003fa40: 756c 6174 6573 2074 6865 2073 7465 702f  ulates the step/
-0003fa50: 7265 7365 7420 7465 6e73 6f72 6469 6374  reset tensordict
-0003fa60: 2077 6974 6820 6120 7265 7365 7420 7472   with a reset tr
-0003fa70: 6163 6b65 7220 656e 7472 790d 0a20 2020  acker entry..   
-0003fa80: 2074 6861 7420 6973 2073 6574 2074 6f20   that is set to 
-0003fa90: 6060 5472 7565 6060 2077 6865 6e65 7665  ``True`` wheneve
-0003faa0: 7220 3a6d 6574 683a 607e 2e72 6573 6574  r :meth:`~.reset
-0003fab0: 6020 6973 2063 616c 6c65 642e 0d0a 0d0a  ` is called.....
-0003fac0: 2020 2020 4172 6773 3a0d 0a20 2020 2020      Args:..     
-0003fad0: 2020 2020 696e 6974 5f6b 6579 2028 4e65      init_key (Ne
-0003fae0: 7374 6564 4b65 792c 206f 7074 696f 6e61  stedKey, optiona
-0003faf0: 6c29 3a20 7468 6520 6b65 7920 746f 2062  l): the key to b
-0003fb00: 6520 7573 6564 2066 6f72 2074 6865 2074  e used for the t
-0003fb10: 7261 636b 6572 2065 6e74 7279 2e0d 0a0d  racker entry....
-0003fb20: 0a20 2020 2045 7861 6d70 6c65 733a 0d0a  .    Examples:..
-0003fb30: 2020 2020 2020 2020 3e3e 3e20 6672 6f6d          >>> from
-0003fb40: 2074 6f72 6368 726c 2e65 6e76 732e 6c69   torchrl.envs.li
-0003fb50: 6273 2e67 796d 2069 6d70 6f72 7420 4779  bs.gym import Gy
-0003fb60: 6d45 6e76 0d0a 2020 2020 2020 2020 3e3e  mEnv..        >>
-0003fb70: 3e20 656e 7620 3d20 5472 616e 7366 6f72  > env = Transfor
-0003fb80: 6d65 6445 6e76 2847 796d 456e 7628 2250  medEnv(GymEnv("P
-0003fb90: 656e 6475 6c75 6d2d 7631 2229 2c20 496e  endulum-v1"), In
-0003fba0: 6974 5472 6163 6b65 7228 2929 0d0a 2020  itTracker())..  
-0003fbb0: 2020 2020 2020 3e3e 3e20 7464 203d 2065        >>> td = e
-0003fbc0: 6e76 2e72 6573 6574 2829 0d0a 2020 2020  nv.reset()..    
-0003fbd0: 2020 2020 3e3e 3e20 7072 696e 7428 7464      >>> print(td
-0003fbe0: 5b22 6973 5f69 6e69 7422 5d29 0d0a 2020  ["is_init"])..  
-0003fbf0: 2020 2020 2020 7465 6e73 6f72 2854 7275        tensor(Tru
-0003fc00: 6529 0d0a 2020 2020 2020 2020 3e3e 3e20  e)..        >>> 
-0003fc10: 7464 203d 2065 6e76 2e72 616e 645f 7374  td = env.rand_st
-0003fc20: 6570 2874 6429 0d0a 2020 2020 2020 2020  ep(td)..        
-0003fc30: 3e3e 3e20 7072 696e 7428 7464 5b22 6e65  >>> print(td["ne
-0003fc40: 7874 222c 2022 6973 5f69 6e69 7422 5d29  xt", "is_init"])
-0003fc50: 0d0a 2020 2020 2020 2020 7465 6e73 6f72  ..        tensor
-0003fc60: 2846 616c 7365 290d 0a0d 0a20 2020 2022  (False)....    "
-0003fc70: 2222 0d0a 0d0a 2020 2020 6465 6620 5f5f  ""....    def __
-0003fc80: 696e 6974 5f5f 2873 656c 662c 2069 6e69  init__(self, ini
-0003fc90: 745f 6b65 793a 204e 6573 7465 644b 6579  t_key: NestedKey
-0003fca0: 203d 2022 6973 5f69 6e69 7422 293a 0d0a   = "is_init"):..
-0003fcb0: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
-0003fcc0: 7369 6e73 7461 6e63 6528 696e 6974 5f6b  sinstance(init_k
-0003fcd0: 6579 2c20 7374 7229 3a0d 0a20 2020 2020  ey, str):..     
-0003fce0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-0003fcf0: 7565 4572 726f 7228 2269 6e69 745f 6b65  ueError("init_ke
-0003fd00: 7920 6361 6e20 6f6e 6c79 2062 6520 6f66  y can only be of
-0003fd10: 2074 7970 6520 7374 722e 2229 0d0a 2020   type str.")..  
-0003fd20: 2020 2020 2020 7365 6c66 2e69 6e69 745f        self.init_
-0003fd30: 6b65 7920 3d20 696e 6974 5f6b 6579 0d0a  key = init_key..
-0003fd40: 2020 2020 2020 2020 7365 6c66 2e72 6573          self.res
-0003fd50: 6574 5f6b 6579 203d 2022 5f72 6573 6574  et_key = "_reset
-0003fd60: 220d 0a20 2020 2020 2020 2073 7570 6572  "..        super
-0003fd70: 2829 2e5f 5f69 6e69 745f 5f28 290d 0a0d  ().__init__()...
-0003fd80: 0a20 2020 2064 6566 2073 6574 5f63 6f6e  .    def set_con
-0003fd90: 7461 696e 6572 2873 656c 662c 2063 6f6e  tainer(self, con
-0003fda0: 7461 696e 6572 3a20 556e 696f 6e5b 5472  tainer: Union[Tr
-0003fdb0: 616e 7366 6f72 6d2c 2045 6e76 4261 7365  ansform, EnvBase
-0003fdc0: 5d29 202d 3e20 4e6f 6e65 3a0d 0a20 2020  ]) -> None:..   
-0003fdd0: 2020 2020 2073 656c 662e 5f69 6e69 745f       self._init_
-0003fde0: 6b65 7973 203d 204e 6f6e 650d 0a20 2020  keys = None..   
-0003fdf0: 2020 2020 2072 6574 7572 6e20 7375 7065       return supe
-0003fe00: 7228 292e 7365 745f 636f 6e74 6169 6e65  r().set_containe
-0003fe10: 7228 636f 6e74 6169 6e65 7229 0d0a 0d0a  r(container)....
-0003fe20: 2020 2020 4070 726f 7065 7274 790d 0a20      @property.. 
-0003fe30: 2020 2064 6566 206f 7574 5f6b 6579 7328     def out_keys(
-0003fe40: 7365 6c66 293a 0d0a 2020 2020 2020 2020  self):..        
-0003fe50: 7265 7475 726e 2073 656c 662e 696e 6974  return self.init
-0003fe60: 5f6b 6579 730d 0a0d 0a20 2020 2040 6f75  _keys....    @ou
-0003fe70: 745f 6b65 7973 2e73 6574 7465 720d 0a20  t_keys.setter.. 
-0003fe80: 2020 2064 6566 206f 7574 5f6b 6579 7328     def out_keys(
-0003fe90: 7365 6c66 2c20 7661 6c75 6529 3a0d 0a20  self, value):.. 
-0003fea0: 2020 2020 2020 2069 6620 7661 6c75 6520         if value 
-0003feb0: 696e 2028 4e6f 6e65 2c20 5b5d 293a 0d0a  in (None, []):..
-0003fec0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0003fed0: 726e 0d0a 2020 2020 2020 2020 7261 6973  rn..        rais
-0003fee0: 6520 5661 6c75 6545 7272 6f72 280d 0a20  e ValueError(.. 
-0003fef0: 2020 2020 2020 2020 2020 2022 4361 6e6e             "Cann
-0003ff00: 6f74 2073 6574 206e 6f6e 2d65 6d70 7479  ot set non-empty
-0003ff10: 206f 7574 2d6b 6579 7320 7768 656e 206f   out-keys when o
-0003ff20: 7574 2d6b 6579 7320 6172 6520 6465 6669  ut-keys are defi
-0003ff30: 6e65 6420 6279 2074 6865 2069 6e69 745f  ned by the init_
-0003ff40: 6b65 7920 7661 6c75 652e 220d 0a20 2020  key value."..   
-0003ff50: 2020 2020 2029 0d0a 0d0a 2020 2020 4070       )....    @p
-0003ff60: 726f 7065 7274 790d 0a20 2020 2064 6566  roperty..    def
-0003ff70: 2069 6e69 745f 6b65 7973 2873 656c 6629   init_keys(self)
-0003ff80: 3a0d 0a20 2020 2020 2020 2069 6e69 745f  :..        init_
-0003ff90: 6b65 7973 203d 2073 656c 662e 5f5f 6469  keys = self.__di
-0003ffa0: 6374 5f5f 2e67 6574 2822 5f69 6e69 745f  ct__.get("_init_
-0003ffb0: 6b65 7973 222c 204e 6f6e 6529 0d0a 2020  keys", None)..  
-0003ffc0: 2020 2020 2020 6966 2069 6e69 745f 6b65        if init_ke
-0003ffd0: 7973 2069 7320 6e6f 7420 4e6f 6e65 3a0d  ys is not None:.
-0003ffe0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0003fff0: 7572 6e20 696e 6974 5f6b 6579 730d 0a20  urn init_keys.. 
-00040000: 2020 2020 2020 2069 6e69 745f 6b65 7973         init_keys
-00040010: 203d 205b 5d0d 0a20 2020 2020 2020 2069   = []..        i
-00040020: 6620 7365 6c66 2e70 6172 656e 7420 6973  f self.parent is
-00040030: 204e 6f6e 653a 0d0a 2020 2020 2020 2020   None:..        
-00040040: 2020 2020 7261 6973 6520 4e6f 7449 6d70      raise NotImp
-00040050: 6c65 6d65 6e74 6564 4572 726f 7228 0d0a  lementedError(..
-00040060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040070: 464f 5257 4152 445f 4e4f 545f 494d 504c  FORWARD_NOT_IMPL
-00040080: 454d 454e 5445 442e 666f 726d 6174 2873  EMENTED.format(s
-00040090: 656c 662e 5f5f 636c 6173 735f 5f2e 5f5f  elf.__class__.__
-000400a0: 6e61 6d65 5f5f 290d 0a20 2020 2020 2020  name__)..       
-000400b0: 2020 2020 2029 0d0a 2020 2020 2020 2020       )..        
-000400c0: 666f 7220 7265 7365 745f 6b65 7920 696e  for reset_key in
-000400d0: 2073 656c 662e 7061 7265 6e74 2e5f 6669   self.parent._fi
-000400e0: 6c74 6572 6564 5f72 6573 6574 5f6b 6579  ltered_reset_key
-000400f0: 733a 0d0a 2020 2020 2020 2020 2020 2020  s:..            
-00040100: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
-00040110: 7365 745f 6b65 792c 2073 7472 293a 0d0a  set_key, str):..
-00040120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040130: 696e 6974 5f6b 6579 203d 2073 656c 662e  init_key = self.
-00040140: 696e 6974 5f6b 6579 0d0a 2020 2020 2020  init_key..      
-00040150: 2020 2020 2020 656c 7365 3a0d 0a20 2020        else:..   
-00040160: 2020 2020 2020 2020 2020 2020 2069 6e69               ini
-00040170: 745f 6b65 7920 3d20 756e 7261 7665 6c5f  t_key = unravel_
-00040180: 6b65 7928 2872 6573 6574 5f6b 6579 5b3a  key((reset_key[:
-00040190: 2d31 5d2c 2073 656c 662e 696e 6974 5f6b  -1], self.init_k
-000401a0: 6579 2929 0d0a 2020 2020 2020 2020 2020  ey))..          
-000401b0: 2020 696e 6974 5f6b 6579 732e 6170 7065    init_keys.appe
-000401c0: 6e64 2869 6e69 745f 6b65 7929 0d0a 2020  nd(init_key)..  
-000401d0: 2020 2020 2020 7365 6c66 2e5f 696e 6974        self._init
-000401e0: 5f6b 6579 7320 3d20 696e 6974 5f6b 6579  _keys = init_key
-000401f0: 730d 0a20 2020 2020 2020 2072 6574 7572  s..        retur
-00040200: 6e20 7365 6c66 2e5f 696e 6974 5f6b 6579  n self._init_key
-00040210: 730d 0a0d 0a20 2020 2040 7072 6f70 6572  s....    @proper
-00040220: 7479 0d0a 2020 2020 6465 6620 7265 7365  ty..    def rese
-00040230: 745f 6b65 7973 2873 656c 6629 3a0d 0a20  t_keys(self):.. 
-00040240: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00040250: 6c66 2e70 6172 656e 742e 5f66 696c 7465  lf.parent._filte
-00040260: 7265 645f 7265 7365 745f 6b65 7973 0d0a  red_reset_keys..
-00040270: 0d0a 2020 2020 6465 6620 5f63 616c 6c28  ..    def _call(
-00040280: 7365 6c66 2c20 7465 6e73 6f72 6469 6374  self, tensordict
-00040290: 3a20 5465 6e73 6f72 4469 6374 4261 7365  : TensorDictBase
-000402a0: 2920 2d3e 2054 656e 736f 7244 6963 7442  ) -> TensorDictB
-000402b0: 6173 653a 0d0a 2020 2020 2020 2020 666f  ase:..        fo
-000402c0: 7220 696e 6974 5f6b 6579 2069 6e20 7365  r init_key in se
-000402d0: 6c66 2e69 6e69 745f 6b65 7973 3a0d 0a20  lf.init_keys:.. 
-000402e0: 2020 2020 2020 2020 2020 2064 6f6e 655f             done_
-000402f0: 6b65 7920 3d20 5f72 6570 6c61 6365 5f6c  key = _replace_l
-00040300: 6173 7428 696e 6974 5f6b 6579 2c20 2264  ast(init_key, "d
-00040310: 6f6e 6522 290d 0a20 2020 2020 2020 2020  one")..         
-00040320: 2020 2069 6620 696e 6974 5f6b 6579 206e     if init_key n
-00040330: 6f74 2069 6e20 7465 6e73 6f72 6469 6374  ot in tensordict
-00040340: 2e6b 6579 7328 5472 7565 2c20 5472 7565  .keys(True, True
-00040350: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
-00040360: 2020 2020 6465 7669 6365 203d 2074 656e      device = ten
-00040370: 736f 7264 6963 742e 6465 7669 6365 0d0a  sordict.device..
-00040380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040390: 6966 2064 6576 6963 6520 6973 204e 6f6e  if device is Non
-000403a0: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
-000403b0: 2020 2020 2020 2020 6465 7669 6365 203d          device =
-000403c0: 2074 6f72 6368 2e64 6576 6963 6528 2263   torch.device("c
-000403d0: 7075 2229 0d0a 2020 2020 2020 2020 2020  pu")..          
-000403e0: 2020 2020 2020 7368 6170 6520 3d20 7365        shape = se
-000403f0: 6c66 2e70 6172 656e 742e 6675 6c6c 5f64  lf.parent.full_d
-00040400: 6f6e 655f 7370 6563 5b64 6f6e 655f 6b65  one_spec[done_ke
-00040410: 795d 2e73 6861 7065 0d0a 2020 2020 2020  y].shape..      
-00040420: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
-00040430: 6469 6374 2e73 6574 280d 0a20 2020 2020  dict.set(..     
-00040440: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00040450: 6e69 745f 6b65 792c 0d0a 2020 2020 2020  nit_key,..      
-00040460: 2020 2020 2020 2020 2020 2020 2020 746f                to
-00040470: 7263 682e 7a65 726f 7328 7368 6170 652c  rch.zeros(shape,
-00040480: 2064 6576 6963 653d 6465 7669 6365 2c20   device=device, 
-00040490: 6474 7970 653d 746f 7263 682e 626f 6f6c  dtype=torch.bool
-000404a0: 292c 0d0a 2020 2020 2020 2020 2020 2020  ),..            
-000404b0: 2020 2020 290d 0a20 2020 2020 2020 2072      )..        r
-000404c0: 6574 7572 6e20 7465 6e73 6f72 6469 6374  eturn tensordict
-000404d0: 0d0a 0d0a 2020 2020 6465 6620 5f72 6573  ....    def _res
-000404e0: 6574 280d 0a20 2020 2020 2020 2073 656c  et(..        sel
-000404f0: 662c 2074 656e 736f 7264 6963 743a 2054  f, tensordict: T
-00040500: 656e 736f 7244 6963 7442 6173 652c 2074  ensorDictBase, t
-00040510: 656e 736f 7264 6963 745f 7265 7365 743a  ensordict_reset:
-00040520: 2054 656e 736f 7244 6963 7442 6173 650d   TensorDictBase.
-00040530: 0a20 2020 2029 202d 3e20 5465 6e73 6f72  .    ) -> Tensor
-00040540: 4469 6374 4261 7365 3a0d 0a20 2020 2020  DictBase:..     
-00040550: 2020 2064 6576 6963 6520 3d20 7465 6e73     device = tens
-00040560: 6f72 6469 6374 2e64 6576 6963 650d 0a20  ordict.device.. 
-00040570: 2020 2020 2020 2069 6620 6465 7669 6365         if device
-00040580: 2069 7320 4e6f 6e65 3a0d 0a20 2020 2020   is None:..     
-00040590: 2020 2020 2020 2064 6576 6963 6520 3d20         device = 
-000405a0: 746f 7263 682e 6465 7669 6365 2822 6370  torch.device("cp
-000405b0: 7522 290d 0a20 2020 2020 2020 2066 6f72  u")..        for
-000405c0: 2072 6573 6574 5f6b 6579 2c20 696e 6974   reset_key, init
-000405d0: 5f6b 6579 2069 6e20 7a69 7028 7365 6c66  _key in zip(self
-000405e0: 2e72 6573 6574 5f6b 6579 732c 2073 656c  .reset_keys, sel
-000405f0: 662e 696e 6974 5f6b 6579 7329 3a0d 0a20  f.init_keys):.. 
-00040600: 2020 2020 2020 2020 2020 205f 7265 7365             _rese
-00040610: 7420 3d20 7465 6e73 6f72 6469 6374 2e67  t = tensordict.g
-00040620: 6574 2872 6573 6574 5f6b 6579 2c20 4e6f  et(reset_key, No
-00040630: 6e65 290d 0a20 2020 2020 2020 2020 2020  ne)..           
-00040640: 2069 6620 5f72 6573 6574 2069 7320 4e6f   if _reset is No
-00040650: 6e65 3a0d 0a20 2020 2020 2020 2020 2020  ne:..           
-00040660: 2020 2020 2064 6f6e 655f 6b65 7920 3d20       done_key = 
-00040670: 5f72 6570 6c61 6365 5f6c 6173 7428 696e  _replace_last(in
-00040680: 6974 5f6b 6579 2c20 2264 6f6e 6522 290d  it_key, "done").
-00040690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000406a0: 2073 6861 7065 203d 2073 656c 662e 7061   shape = self.pa
-000406b0: 7265 6e74 2e66 756c 6c5f 646f 6e65 5f73  rent.full_done_s
-000406c0: 7065 635b 646f 6e65 5f6b 6579 5d2e 7368  pec[done_key].sh
-000406d0: 6170 650d 0a20 2020 2020 2020 2020 2020  ape..           
-000406e0: 2020 2020 2074 656e 736f 7264 6963 745f       tensordict_
-000406f0: 7265 7365 742e 7365 7428 0d0a 2020 2020  reset.set(..    
-00040700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040710: 696e 6974 5f6b 6579 2c0d 0a20 2020 2020  init_key,..     
-00040720: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00040730: 6f72 6368 2e6f 6e65 7328 0d0a 2020 2020  orch.ones(..    
-00040740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040750: 2020 2020 7368 6170 652c 0d0a 2020 2020      shape,..    
-00040760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040770: 2020 2020 6465 7669 6365 3d64 6576 6963      device=devic
-00040780: 652c 0d0a 2020 2020 2020 2020 2020 2020  e,..            
-00040790: 2020 2020 2020 2020 2020 2020 6474 7970              dtyp
-000407a0: 653d 746f 7263 682e 626f 6f6c 2c0d 0a20  e=torch.bool,.. 
-000407b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000407c0: 2020 2029 2c0d 0a20 2020 2020 2020 2020     ),..         
-000407d0: 2020 2020 2020 2029 0d0a 2020 2020 2020         )..      
-000407e0: 2020 2020 2020 656c 7365 3a0d 0a20 2020        else:..   
-000407f0: 2020 2020 2020 2020 2020 2020 2069 6e69               ini
-00040800: 745f 7661 6c20 3d20 5f72 6573 6574 2e63  t_val = _reset.c
-00040810: 6c6f 6e65 2829 0d0a 2020 2020 2020 2020  lone()..        
-00040820: 2020 2020 2020 2020 7061 7265 6e74 5f74          parent_t
-00040830: 6420 3d20 280d 0a20 2020 2020 2020 2020  d = (..         
-00040840: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
-00040850: 7264 6963 745f 7265 7365 740d 0a20 2020  rdict_reset..   
-00040860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040870: 2069 6620 6973 696e 7374 616e 6365 2869   if isinstance(i
-00040880: 6e69 745f 6b65 792c 2073 7472 290d 0a20  nit_key, str).. 
-00040890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000408a0: 2020 2065 6c73 6520 7465 6e73 6f72 6469     else tensordi
-000408b0: 6374 5f72 6573 6574 2e67 6574 2869 6e69  ct_reset.get(ini
-000408c0: 745f 6b65 795b 3a2d 315d 290d 0a20 2020  t_key[:-1])..   
-000408d0: 2020 2020 2020 2020 2020 2020 2029 0d0a               )..
-000408e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000408f0: 6966 2069 6e69 745f 7661 6c2e 6e64 696d  if init_val.ndim
-00040900: 203d 3d20 7061 7265 6e74 5f74 642e 6e64   == parent_td.nd
-00040910: 696d 3a0d 0a20 2020 2020 2020 2020 2020  im:..           
-00040920: 2020 2020 2020 2020 2023 2075 6e73 7175           # unsqu
-00040930: 6565 7a65 2c20 746f 206d 6174 6368 2074  eeze, to match t
-00040940: 6865 2064 6f6e 6520 7368 6170 650d 0a20  he done shape.. 
-00040950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040960: 2020 2069 6e69 745f 7661 6c20 3d20 696e     init_val = in
-00040970: 6974 5f76 616c 2e75 6e73 7175 6565 7a65  it_val.unsqueeze
-00040980: 282d 3129 0d0a 2020 2020 2020 2020 2020  (-1)..          
-00040990: 2020 2020 2020 7465 6e73 6f72 6469 6374        tensordict
-000409a0: 5f72 6573 6574 2e73 6574 2869 6e69 745f  _reset.set(init_
-000409b0: 6b65 792c 2069 6e69 745f 7661 6c29 0d0a  key, init_val)..
-000409c0: 2020 2020 2020 2020 7265 7475 726e 2074          return t
-000409d0: 656e 736f 7264 6963 745f 7265 7365 740d  ensordict_reset.
-000409e0: 0a0d 0a20 2020 2064 6566 2074 7261 6e73  ...    def trans
-000409f0: 666f 726d 5f6f 6273 6572 7661 7469 6f6e  form_observation
-00040a00: 5f73 7065 6328 7365 6c66 2c20 6f62 7365  _spec(self, obse
-00040a10: 7276 6174 696f 6e5f 7370 6563 3a20 5465  rvation_spec: Te
-00040a20: 6e73 6f72 5370 6563 2920 2d3e 2054 656e  nsorSpec) -> Ten
-00040a30: 736f 7253 7065 633a 0d0a 2020 2020 2020  sorSpec:..      
-00040a40: 2020 6675 6c6c 5f64 6f6e 655f 7370 6563    full_done_spec
-00040a50: 203d 2073 656c 662e 7061 7265 6e74 2e6f   = self.parent.o
-00040a60: 7574 7075 745f 7370 6563 5b22 6675 6c6c  utput_spec["full
-00040a70: 5f64 6f6e 655f 7370 6563 225d 0d0a 2020  _done_spec"]..  
-00040a80: 2020 2020 2020 666f 7220 696e 6974 5f6b        for init_k
-00040a90: 6579 2069 6e20 7365 6c66 2e69 6e69 745f  ey in self.init_
-00040aa0: 6b65 7973 3a0d 0a20 2020 2020 2020 2020  keys:..         
-00040ab0: 2020 2066 6f72 2064 6f6e 655f 6b65 7920     for done_key 
-00040ac0: 696e 2073 656c 662e 7061 7265 6e74 2e64  in self.parent.d
-00040ad0: 6f6e 655f 6b65 7973 3a0d 0a20 2020 2020  one_keys:..     
-00040ae0: 2020 2020 2020 2020 2020 2023 2063 6865             # che
-00040af0: 636b 2072 6f6f 740d 0a20 2020 2020 2020  ck root..       
-00040b00: 2020 2020 2020 2020 2069 6620 7479 7065           if type
-00040b10: 2864 6f6e 655f 6b65 7929 2021 3d20 7479  (done_key) != ty
-00040b20: 7065 2869 6e69 745f 6b65 7929 3a0d 0a20  pe(init_key):.. 
-00040b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040b40: 2020 2063 6f6e 7469 6e75 650d 0a20 2020     continue..   
-00040b50: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00040b60: 6973 696e 7374 616e 6365 2864 6f6e 655f  isinstance(done_
-00040b70: 6b65 792c 2074 7570 6c65 293a 0d0a 2020  key, tuple):..  
+00039a60: 2020 2020 2069 6620 7479 7065 2864 6f6e       if type(don
+00039a70: 655f 6b65 7929 2021 3d20 7479 7065 2864  e_key) != type(d
+00039a80: 6f6e 655f 6b65 7929 3a0d 0a20 2020 2020  one_key):..     
+00039a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039aa0: 2020 2020 2020 2063 6f6e 7469 6e75 650d         continue.
+00039ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039ac0: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
+00039ad0: 7374 616e 6365 2864 6f6e 655f 6b65 792c  stance(done_key,
+00039ae0: 2074 7570 6c65 293a 0d0a 2020 2020 2020   tuple):..      
+00039af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039b00: 2020 2020 2020 6966 2064 6f6e 655f 6b65        if done_ke
+00039b10: 795b 3a2d 315d 203d 3d20 646f 6e65 5f6b  y[:-1] == done_k
+00039b20: 6579 5b3a 2d31 5d3a 0d0a 2020 2020 2020  ey[:-1]:..      
+00039b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039b40: 2020 2020 2020 2020 2020 7368 6170 6520            shape 
+00039b50: 3d20 6675 6c6c 5f64 6f6e 655f 7370 6563  = full_done_spec
+00039b60: 5b64 6f6e 655f 6b65 795d 2e73 6861 7065  [done_key].shape
+00039b70: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00039b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039b90: 2020 6272 6561 6b0d 0a20 2020 2020 2020    break..       
+00039ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039bb0: 2069 6620 6973 696e 7374 616e 6365 2864   if isinstance(d
+00039bc0: 6f6e 655f 6b65 792c 2073 7472 293a 0d0a  one_key, str):..
+00039bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039be0: 2020 2020 2020 2020 2020 2020 7368 6170              shap
+00039bf0: 6520 3d20 6675 6c6c 5f64 6f6e 655f 7370  e = full_done_sp
+00039c00: 6563 5b64 6f6e 655f 6b65 795d 2e73 6861  ec[done_key].sha
+00039c10: 7065 0d0a 2020 2020 2020 2020 2020 2020  pe..            
+00039c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039c30: 6272 6561 6b0d 0a0d 0a20 2020 2020 2020  break....       
+00039c40: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00039c50: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+00039c60: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00039c70: 6520 4b65 7945 7272 6f72 280d 0a20 2020  e KeyError(..   
+00039c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039c90: 2020 2020 2020 2020 2066 2243 6f75 6c64           f"Could
+00039ca0: 206e 6f74 2066 696e 6420 726f 6f74 206f   not find root o
+00039cb0: 6620 7374 6f70 5f6b 6579 207b 646f 6e65  f stop_key {done
+00039cc0: 5f6b 6579 7d20 696e 2064 6f6e 6520 6b65  _key} in done ke
+00039cd0: 7973 207b 7365 6c66 2e64 6f6e 655f 6b65  ys {self.done_ke
+00039ce0: 7973 7d2e 220d 0a20 2020 2020 2020 2020  ys}."..         
+00039cf0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00039d00: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00039d10: 2020 2020 2020 6675 6c6c 5f64 6f6e 655f        full_done_
+00039d20: 7370 6563 5b64 6f6e 655f 6b65 795d 203d  spec[done_key] =
+00039d30: 2044 6973 6372 6574 6554 656e 736f 7253   DiscreteTensorS
+00039d40: 7065 6328 0d0a 2020 2020 2020 2020 2020  pec(..          
+00039d50: 2020 2020 2020 2020 2020 2020 2020 322c                2,
+00039d60: 2064 7479 7065 3d74 6f72 6368 2e62 6f6f   dtype=torch.boo
+00039d70: 6c2c 2064 6576 6963 653d 6f75 7470 7574  l, device=output
+00039d80: 5f73 7065 632e 6465 7669 6365 2c20 7368  _spec.device, sh
+00039d90: 6170 653d 7368 6170 650d 0a20 2020 2020  ape=shape..     
+00039da0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00039db0: 0d0a 2020 2020 2020 2020 2020 2020 6f75  ..            ou
+00039dc0: 7470 7574 5f73 7065 635b 2266 756c 6c5f  tput_spec["full_
+00039dd0: 646f 6e65 5f73 7065 6322 5d20 3d20 6675  done_spec"] = fu
+00039de0: 6c6c 5f64 6f6e 655f 7370 6563 0d0a 2020  ll_done_spec..  
+00039df0: 2020 2020 2020 7265 7475 726e 2073 7570        return sup
+00039e00: 6572 2829 2e74 7261 6e73 666f 726d 5f6f  er().transform_o
+00039e10: 7574 7075 745f 7370 6563 286f 7574 7075  utput_spec(outpu
+00039e20: 745f 7370 6563 290d 0a0d 0a20 2020 2064  t_spec)....    d
+00039e30: 6566 2074 7261 6e73 666f 726d 5f69 6e70  ef transform_inp
+00039e40: 7574 5f73 7065 6328 7365 6c66 2c20 696e  ut_spec(self, in
+00039e50: 7075 745f 7370 6563 3a20 436f 6d70 6f73  put_spec: Compos
+00039e60: 6974 6553 7065 6329 202d 3e20 436f 6d70  iteSpec) -> Comp
+00039e70: 6f73 6974 6553 7065 633a 0d0a 2020 2020  ositeSpec:..    
+00039e80: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
+00039e90: 7461 6e63 6528 696e 7075 745f 7370 6563  tance(input_spec
+00039ea0: 2c20 436f 6d70 6f73 6974 6553 7065 6329  , CompositeSpec)
+00039eb0: 3a0d 0a20 2020 2020 2020 2020 2020 2072  :..            r
+00039ec0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00039ed0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00039ee0: 2020 6622 696e 7075 745f 7370 6563 2077    f"input_spec w
+00039ef0: 6173 2065 7870 6563 7465 6420 746f 2062  as expected to b
+00039f00: 6520 6f66 2074 7970 6520 436f 6d70 6f73  e of type Compos
+00039f10: 6974 6553 7065 632e 2047 6f74 207b 7479  iteSpec. Got {ty
+00039f20: 7065 2869 6e70 7574 5f73 7065 6329 7d20  pe(input_spec)} 
+00039f30: 696e 7374 6561 642e 220d 0a20 2020 2020  instead."..     
+00039f40: 2020 2020 2020 2029 0d0a 2020 2020 2020         )..      
+00039f50: 2020 6966 2069 6e70 7574 5f73 7065 635b    if input_spec[
+00039f60: 2266 756c 6c5f 7374 6174 655f 7370 6563  "full_state_spec
+00039f70: 225d 2069 7320 4e6f 6e65 3a0d 0a20 2020  "] is None:..   
+00039f80: 2020 2020 2020 2020 2069 6e70 7574 5f73           input_s
+00039f90: 7065 635b 2266 756c 6c5f 7374 6174 655f  pec["full_state_
+00039fa0: 7370 6563 225d 203d 2043 6f6d 706f 7369  spec"] = Composi
+00039fb0: 7465 5370 6563 280d 0a20 2020 2020 2020  teSpec(..       
+00039fc0: 2020 2020 2020 2020 2073 6861 7065 3d69           shape=i
+00039fd0: 6e70 7574 5f73 7065 632e 7368 6170 652c  nput_spec.shape,
+00039fe0: 2064 6576 6963 653d 696e 7075 745f 7370   device=input_sp
+00039ff0: 6563 2e64 6576 6963 650d 0a20 2020 2020  ec.device..     
+0003a000: 2020 2020 2020 2029 0d0a 0d0a 2020 2020         )....    
+0003a010: 2020 2020 6675 6c6c 5f64 6f6e 655f 7370      full_done_sp
+0003a020: 6563 203d 2073 656c 662e 7061 7265 6e74  ec = self.parent
+0003a030: 2e6f 7574 7075 745f 7370 6563 5b22 6675  .output_spec["fu
+0003a040: 6c6c 5f64 6f6e 655f 7370 6563 225d 0d0a  ll_done_spec"]..
+0003a050: 2020 2020 2020 2020 666f 7220 7374 6570          for step
+0003a060: 5f63 6f75 6e74 5f6b 6579 2069 6e20 7365  _count_key in se
+0003a070: 6c66 2e73 7465 705f 636f 756e 745f 6b65  lf.step_count_ke
+0003a080: 7973 3a0d 0a20 2020 2020 2020 2020 2020  ys:..           
+0003a090: 2073 7465 705f 636f 756e 745f 6b65 7920   step_count_key 
+0003a0a0: 3d20 756e 7261 7665 6c5f 6b65 7928 7374  = unravel_key(st
+0003a0b0: 6570 5f63 6f75 6e74 5f6b 6579 290d 0a20  ep_count_key).. 
+0003a0c0: 2020 2020 2020 2020 2020 2023 2066 696e             # fin
+0003a0d0: 6420 6120 6d61 7463 6869 6e67 2064 6f6e  d a matching don
+0003a0e0: 6520 6b65 7920 2874 6865 7265 206d 6967  e key (there mig
+0003a0f0: 6874 2062 6520 6d6f 7265 2074 6861 6e20  ht be more than 
+0003a100: 6f6e 6529 0d0a 2020 2020 2020 2020 2020  one)..          
+0003a110: 2020 666f 7220 646f 6e65 5f6b 6579 2069    for done_key i
+0003a120: 6e20 7365 6c66 2e64 6f6e 655f 6b65 7973  n self.done_keys
+0003a130: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+0003a140: 2020 2023 2063 6865 636b 2072 6f6f 740d     # check root.
+0003a150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a160: 2069 6620 7479 7065 2864 6f6e 655f 6b65   if type(done_ke
+0003a170: 7929 2021 3d20 7479 7065 2873 7465 705f  y) != type(step_
+0003a180: 636f 756e 745f 6b65 7929 3a0d 0a20 2020  count_key):..   
+0003a190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a1a0: 2063 6f6e 7469 6e75 650d 0a20 2020 2020   continue..     
+0003a1b0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+0003a1c0: 696e 7374 616e 6365 2864 6f6e 655f 6b65  instance(done_ke
+0003a1d0: 792c 2074 7570 6c65 293a 0d0a 2020 2020  y, tuple):..    
+0003a1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a1f0: 6966 2064 6f6e 655f 6b65 795b 3a2d 315d  if done_key[:-1]
+0003a200: 203d 3d20 7374 6570 5f63 6f75 6e74 5f6b   == step_count_k
+0003a210: 6579 5b3a 2d31 5d3a 0d0a 2020 2020 2020  ey[:-1]:..      
+0003a220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a230: 2020 7368 6170 6520 3d20 6675 6c6c 5f64    shape = full_d
+0003a240: 6f6e 655f 7370 6563 5b64 6f6e 655f 6b65  one_spec[done_ke
+0003a250: 795d 2e73 6861 7065 0d0a 2020 2020 2020  y].shape..      
+0003a260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a270: 2020 6272 6561 6b0d 0a20 2020 2020 2020    break..       
+0003a280: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
+0003a290: 7374 616e 6365 2864 6f6e 655f 6b65 792c  stance(done_key,
+0003a2a0: 2073 7472 293a 0d0a 2020 2020 2020 2020   str):..        
+0003a2b0: 2020 2020 2020 2020 2020 2020 7368 6170              shap
+0003a2c0: 6520 3d20 6675 6c6c 5f64 6f6e 655f 7370  e = full_done_sp
+0003a2d0: 6563 5b64 6f6e 655f 6b65 795d 2e73 6861  ec[done_key].sha
+0003a2e0: 7065 0d0a 2020 2020 2020 2020 2020 2020  pe..            
+0003a2f0: 2020 2020 2020 2020 6272 6561 6b0d 0a0d          break...
+0003a300: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0003a310: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+0003a320: 2020 2020 7261 6973 6520 4b65 7945 7272      raise KeyErr
+0003a330: 6f72 280d 0a20 2020 2020 2020 2020 2020  or(..           
+0003a340: 2020 2020 2020 2020 2066 2243 6f75 6c64           f"Could
+0003a350: 206e 6f74 2066 696e 6420 726f 6f74 206f   not find root o
+0003a360: 6620 7374 6570 5f63 6f75 6e74 5f6b 6579  f step_count_key
+0003a370: 207b 7374 6570 5f63 6f75 6e74 5f6b 6579   {step_count_key
+0003a380: 7d20 696e 2064 6f6e 6520 6b65 7973 207b  } in done keys {
+0003a390: 7365 6c66 2e64 6f6e 655f 6b65 7973 7d2e  self.done_keys}.
+0003a3a0: 220d 0a20 2020 2020 2020 2020 2020 2020  "..             
+0003a3b0: 2020 2029 0d0a 0d0a 2020 2020 2020 2020     )....        
+0003a3c0: 2020 2020 696e 7075 745f 7370 6563 5b0d      input_spec[.
+0003a3d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a3e0: 2075 6e72 6176 656c 5f6b 6579 2828 2266   unravel_key(("f
+0003a3f0: 756c 6c5f 7374 6174 655f 7370 6563 222c  ull_state_spec",
+0003a400: 2073 7465 705f 636f 756e 745f 6b65 7929   step_count_key)
+0003a410: 290d 0a20 2020 2020 2020 2020 2020 205d  )..            ]
+0003a420: 203d 2042 6f75 6e64 6564 5465 6e73 6f72   = BoundedTensor
+0003a430: 5370 6563 280d 0a20 2020 2020 2020 2020  Spec(..         
+0003a440: 2020 2020 2020 2073 6861 7065 3d73 6861         shape=sha
+0003a450: 7065 2c0d 0a20 2020 2020 2020 2020 2020  pe,..           
+0003a460: 2020 2020 2064 7479 7065 3d74 6f72 6368       dtype=torch
+0003a470: 2e69 6e74 3634 2c0d 0a20 2020 2020 2020  .int64,..       
+0003a480: 2020 2020 2020 2020 2064 6576 6963 653d           device=
+0003a490: 696e 7075 745f 7370 6563 2e64 6576 6963  input_spec.devic
+0003a4a0: 652c 0d0a 2020 2020 2020 2020 2020 2020  e,..            
+0003a4b0: 2020 2020 6c6f 773d 302c 0d0a 2020 2020      low=0,..    
+0003a4c0: 2020 2020 2020 2020 2020 2020 6869 6768              high
+0003a4d0: 3d74 6f72 6368 2e69 696e 666f 2874 6f72  =torch.iinfo(tor
+0003a4e0: 6368 2e69 6e74 3634 292e 6d61 782c 0d0a  ch.int64).max,..
+0003a4f0: 2020 2020 2020 2020 2020 2020 290d 0a0d              )...
+0003a500: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0003a510: 696e 7075 745f 7370 6563 0d0a 0d0a 2020  input_spec....  
+0003a520: 2020 6465 6620 666f 7277 6172 6428 7365    def forward(se
+0003a530: 6c66 2c20 7465 6e73 6f72 6469 6374 3a20  lf, tensordict: 
+0003a540: 5465 6e73 6f72 4469 6374 4261 7365 2920  TensorDictBase) 
+0003a550: 2d3e 2054 656e 736f 7244 6963 7442 6173  -> TensorDictBas
+0003a560: 653a 0d0a 2020 2020 2020 2020 7261 6973  e:..        rais
+0003a570: 6520 4e6f 7449 6d70 6c65 6d65 6e74 6564  e NotImplemented
+0003a580: 4572 726f 7228 0d0a 2020 2020 2020 2020  Error(..        
+0003a590: 2020 2020 2253 7465 7043 6f75 6e74 6572      "StepCounter
+0003a5a0: 2063 616e 6e6f 7420 6265 2063 616c 6c65   cannot be calle
+0003a5b0: 6420 696e 6465 7065 6e64 656e 746c 792c  d independently,
+0003a5c0: 206f 6e6c 7920 6974 7320 7374 6570 2061   only its step a
+0003a5d0: 6e64 2072 6573 6574 206d 6574 686f 6473  nd reset methods
+0003a5e0: 2022 0d0a 2020 2020 2020 2020 2020 2020   "..            
+0003a5f0: 2261 7265 2066 756e 6374 696f 6e61 6c2e  "are functional.
+0003a600: 2054 6865 2072 6561 736f 6e20 666f 7220   The reason for 
+0003a610: 7468 6973 2069 7320 7468 6174 2069 7420  this is that it 
+0003a620: 6973 2068 6172 6420 746f 2063 6f6e 7369  is hard to consi
+0003a630: 6465 7220 7573 696e 6720 220d 0a20 2020  der using "..   
+0003a640: 2020 2020 2020 2020 2022 5374 6570 436f           "StepCo
+0003a650: 756e 7465 7220 7769 7468 206e 6f6e 2d73  unter with non-s
+0003a660: 6571 7565 6e74 6961 6c20 6461 7461 2c20  equential data, 
+0003a670: 7375 6368 2061 7320 7468 6f73 6520 636f  such as those co
+0003a680: 6c6c 6563 7465 6420 6279 2061 2072 6570  llected by a rep
+0003a690: 6c61 7920 6275 6666 6572 2022 0d0a 2020  lay buffer "..  
+0003a6a0: 2020 2020 2020 2020 2020 226f 7220 6120            "or a 
+0003a6b0: 6461 7461 7365 742e 2049 6620 796f 7520  dataset. If you 
+0003a6c0: 6e65 6564 2053 7465 7043 6f75 6e74 6572  need StepCounter
+0003a6d0: 2074 6f20 776f 726b 206f 6e20 6120 6261   to work on a ba
+0003a6e0: 7463 6820 6f66 2073 6571 7565 6e74 6961  tch of sequentia
+0003a6f0: 6c20 6461 7461 2022 0d0a 2020 2020 2020  l data "..      
+0003a700: 2020 2020 2020 2228 6965 2061 7320 4c53        "(ie as LS
+0003a710: 544d 2077 6f75 6c64 2077 6f72 6b20 6f76  TM would work ov
+0003a720: 6572 2061 2077 686f 6c65 2073 6571 7565  er a whole seque
+0003a730: 6e63 6520 6f66 2064 6174 6129 2c20 6669  nce of data), fi
+0003a740: 6c65 2061 6e20 6973 7375 6520 6f6e 2022  le an issue on "
+0003a750: 0d0a 2020 2020 2020 2020 2020 2020 2254  ..            "T
+0003a760: 6f72 6368 524c 2072 6571 7565 7374 696e  orchRL requestin
+0003a770: 6720 7468 6174 2066 6561 7475 7265 2e22  g that feature."
+0003a780: 0d0a 2020 2020 2020 2020 290d 0a0d 0a0d  ..        ).....
+0003a790: 0a63 6c61 7373 2045 7863 6c75 6465 5472  .class ExcludeTr
+0003a7a0: 616e 7366 6f72 6d28 5472 616e 7366 6f72  ansform(Transfor
+0003a7b0: 6d29 3a0d 0a20 2020 2022 2222 4578 636c  m):..    """Excl
+0003a7c0: 7564 6573 206b 6579 7320 6672 6f6d 2074  udes keys from t
+0003a7d0: 6865 2064 6174 612e 0d0a 0d0a 2020 2020  he data.....    
+0003a7e0: 4172 6773 3a0d 0a20 2020 2020 2020 202a  Args:..        *
+0003a7f0: 6578 636c 7564 6564 5f6b 6579 7320 2869  excluded_keys (i
+0003a800: 7465 7261 626c 6520 6f66 204e 6573 7465  terable of Neste
+0003a810: 644b 6579 293a 2054 6865 206e 616d 6520  dKey): The name 
+0003a820: 6f66 2074 6865 206b 6579 7320 746f 2065  of the keys to e
+0003a830: 7863 6c75 6465 2e20 4966 2074 6865 206b  xclude. If the k
+0003a840: 6579 2069 730d 0a20 2020 2020 2020 2020  ey is..         
+0003a850: 2020 206e 6f74 2070 7265 7365 6e74 2c20     not present, 
+0003a860: 6974 2069 7320 7369 6d70 6c79 2069 676e  it is simply ign
+0003a870: 6f72 6564 2e0d 0a20 2020 2020 2020 2069  ored...        i
+0003a880: 6e76 6572 7365 2028 626f 6f6c 2c20 6f70  nverse (bool, op
+0003a890: 7469 6f6e 616c 293a 2069 6620 6060 5472  tional): if ``Tr
+0003a8a0: 7565 6060 2c20 7468 6520 6578 636c 7573  ue``, the exclus
+0003a8b0: 696f 6e20 7769 6c6c 206f 6363 7572 2064  ion will occur d
+0003a8c0: 7572 696e 6720 7468 6520 6060 696e 7660  uring the ``inv`
+0003a8d0: 6020 6361 6c6c 2e0d 0a20 2020 2020 2020  ` call...       
+0003a8e0: 2020 2020 2044 6566 6175 6c74 7320 746f       Defaults to
+0003a8f0: 2060 6046 616c 7365 6060 2e0d 0a0d 0a20   ``False``..... 
+0003a900: 2020 2045 7861 6d70 6c65 733a 0d0a 2020     Examples:..  
+0003a910: 2020 2020 2020 3e3e 3e20 696d 706f 7274        >>> import
+0003a920: 2067 796d 6e61 7369 756d 0d0a 2020 2020   gymnasium..    
+0003a930: 2020 2020 3e3e 3e20 6672 6f6d 2074 6f72      >>> from tor
+0003a940: 6368 726c 2e65 6e76 7320 696d 706f 7274  chrl.envs import
+0003a950: 2047 796d 5772 6170 7065 720d 0a20 2020   GymWrapper..   
+0003a960: 2020 2020 203e 3e3e 2065 6e76 203d 2054       >>> env = T
+0003a970: 7261 6e73 666f 726d 6564 456e 7628 0d0a  ransformedEnv(..
+0003a980: 2020 2020 2020 2020 2e2e 2e20 2020 2020          ...     
+0003a990: 4779 6d57 7261 7070 6572 2867 796d 6e61  GymWrapper(gymna
+0003a9a0: 7369 756d 2e6d 616b 6528 2250 656e 6475  sium.make("Pendu
+0003a9b0: 6c75 6d2d 7631 2229 292c 0d0a 2020 2020  lum-v1")),..    
+0003a9c0: 2020 2020 2e2e 2e20 2020 2020 4578 636c      ...     Excl
+0003a9d0: 7564 6554 7261 6e73 666f 726d 2822 7472  udeTransform("tr
+0003a9e0: 756e 6361 7465 6422 290d 0a20 2020 2020  uncated")..     
+0003a9f0: 2020 202e 2e2e 2029 0d0a 2020 2020 2020     ... )..      
+0003aa00: 2020 3e3e 3e20 656e 762e 726f 6c6c 6f75    >>> env.rollou
+0003aa10: 7428 3329 0d0a 2020 2020 2020 2020 5465  t(3)..        Te
+0003aa20: 6e73 6f72 4469 6374 280d 0a20 2020 2020  nsorDict(..     
+0003aa30: 2020 2020 2020 2066 6965 6c64 733d 7b0d         fields={.
+0003aa40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003aa50: 2061 6374 696f 6e3a 2054 656e 736f 7228   action: Tensor(
+0003aa60: 7368 6170 653d 746f 7263 682e 5369 7a65  shape=torch.Size
+0003aa70: 285b 332c 2031 5d29 2c20 6465 7669 6365  ([3, 1]), device
+0003aa80: 3d63 7075 2c20 6474 7970 653d 746f 7263  =cpu, dtype=torc
+0003aa90: 682e 666c 6f61 7433 322c 2069 735f 7368  h.float32, is_sh
+0003aaa0: 6172 6564 3d46 616c 7365 292c 0d0a 2020  ared=False),..  
+0003aab0: 2020 2020 2020 2020 2020 2020 2020 646f                do
+0003aac0: 6e65 3a20 5465 6e73 6f72 2873 6861 7065  ne: Tensor(shape
+0003aad0: 3d74 6f72 6368 2e53 697a 6528 5b33 2c20  =torch.Size([3, 
+0003aae0: 315d 292c 2064 6576 6963 653d 6370 752c  1]), device=cpu,
+0003aaf0: 2064 7479 7065 3d74 6f72 6368 2e62 6f6f   dtype=torch.boo
+0003ab00: 6c2c 2069 735f 7368 6172 6564 3d46 616c  l, is_shared=Fal
+0003ab10: 7365 292c 0d0a 2020 2020 2020 2020 2020  se),..          
+0003ab20: 2020 2020 2020 6e65 7874 3a20 5465 6e73        next: Tens
+0003ab30: 6f72 4469 6374 280d 0a20 2020 2020 2020  orDict(..       
+0003ab40: 2020 2020 2020 2020 2020 2020 2066 6965               fie
+0003ab50: 6c64 733d 7b0d 0a20 2020 2020 2020 2020  lds={..         
+0003ab60: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0003ab70: 6f6e 653a 2054 656e 736f 7228 7368 6170  one: Tensor(shap
+0003ab80: 653d 746f 7263 682e 5369 7a65 285b 332c  e=torch.Size([3,
+0003ab90: 2031 5d29 2c20 6465 7669 6365 3d63 7075   1]), device=cpu
+0003aba0: 2c20 6474 7970 653d 746f 7263 682e 626f  , dtype=torch.bo
+0003abb0: 6f6c 2c20 6973 5f73 6861 7265 643d 4661  ol, is_shared=Fa
+0003abc0: 6c73 6529 2c0d 0a20 2020 2020 2020 2020  lse),..         
+0003abd0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0003abe0: 6273 6572 7661 7469 6f6e 3a20 5465 6e73  bservation: Tens
+0003abf0: 6f72 2873 6861 7065 3d74 6f72 6368 2e53  or(shape=torch.S
+0003ac00: 697a 6528 5b33 2c20 335d 292c 2064 6576  ize([3, 3]), dev
+0003ac10: 6963 653d 6370 752c 2064 7479 7065 3d74  ice=cpu, dtype=t
+0003ac20: 6f72 6368 2e66 6c6f 6174 3332 2c20 6973  orch.float32, is
+0003ac30: 5f73 6861 7265 643d 4661 6c73 6529 2c0d  _shared=False),.
+0003ac40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003ac50: 2020 2020 2020 2020 2072 6577 6172 643a           reward:
+0003ac60: 2054 656e 736f 7228 7368 6170 653d 746f   Tensor(shape=to
+0003ac70: 7263 682e 5369 7a65 285b 332c 2031 5d29  rch.Size([3, 1])
+0003ac80: 2c20 6465 7669 6365 3d63 7075 2c20 6474  , device=cpu, dt
+0003ac90: 7970 653d 746f 7263 682e 666c 6f61 7433  ype=torch.float3
+0003aca0: 322c 2069 735f 7368 6172 6564 3d46 616c  2, is_shared=Fal
+0003acb0: 7365 297d 2c0d 0a20 2020 2020 2020 2020  se)},..         
+0003acc0: 2020 2020 2020 2020 2020 2062 6174 6368             batch
+0003acd0: 5f73 697a 653d 746f 7263 682e 5369 7a65  _size=torch.Size
+0003ace0: 285b 335d 292c 0d0a 2020 2020 2020 2020  ([3]),..        
+0003acf0: 2020 2020 2020 2020 2020 2020 6465 7669              devi
+0003ad00: 6365 3d63 7075 2c0d 0a20 2020 2020 2020  ce=cpu,..       
+0003ad10: 2020 2020 2020 2020 2020 2020 2069 735f               is_
+0003ad20: 7368 6172 6564 3d46 616c 7365 292c 0d0a  shared=False),..
+0003ad30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ad40: 6f62 7365 7276 6174 696f 6e3a 2054 656e  observation: Ten
+0003ad50: 736f 7228 7368 6170 653d 746f 7263 682e  sor(shape=torch.
+0003ad60: 5369 7a65 285b 332c 2033 5d29 2c20 6465  Size([3, 3]), de
+0003ad70: 7669 6365 3d63 7075 2c20 6474 7970 653d  vice=cpu, dtype=
+0003ad80: 746f 7263 682e 666c 6f61 7433 322c 2069  torch.float32, i
+0003ad90: 735f 7368 6172 6564 3d46 616c 7365 297d  s_shared=False)}
+0003ada0: 2c0d 0a20 2020 2020 2020 2020 2020 2062  ,..            b
+0003adb0: 6174 6368 5f73 697a 653d 746f 7263 682e  atch_size=torch.
+0003adc0: 5369 7a65 285b 335d 292c 0d0a 2020 2020  Size([3]),..    
+0003add0: 2020 2020 2020 2020 6465 7669 6365 3d63          device=c
+0003ade0: 7075 2c0d 0a20 2020 2020 2020 2020 2020  pu,..           
+0003adf0: 2069 735f 7368 6172 6564 3d46 616c 7365   is_shared=False
+0003ae00: 290d 0a0d 0a20 2020 2022 2222 0d0a 0d0a  )....    """....
+0003ae10: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+0003ae20: 2873 656c 662c 202a 6578 636c 7564 6564  (self, *excluded
+0003ae30: 5f6b 6579 732c 2069 6e76 6572 7365 3a20  _keys, inverse: 
+0003ae40: 626f 6f6c 203d 2046 616c 7365 293a 0d0a  bool = False):..
+0003ae50: 2020 2020 2020 2020 7375 7065 7228 292e          super().
+0003ae60: 5f5f 696e 6974 5f5f 2829 0d0a 2020 2020  __init__()..    
+0003ae70: 2020 2020 7472 793a 0d0a 2020 2020 2020      try:..      
+0003ae80: 2020 2020 2020 6578 636c 7564 6564 5f6b        excluded_k
+0003ae90: 6579 7320 3d20 756e 7261 7665 6c5f 6b65  eys = unravel_ke
+0003aea0: 795f 6c69 7374 2865 7863 6c75 6465 645f  y_list(excluded_
+0003aeb0: 6b65 7973 290d 0a20 2020 2020 2020 2065  keys)..        e
+0003aec0: 7863 6570 7420 5479 7065 4572 726f 723a  xcept TypeError:
+0003aed0: 0d0a 2020 2020 2020 2020 2020 2020 7261  ..            ra
+0003aee0: 6973 6520 5479 7065 4572 726f 7228 0d0a  ise TypeError(..
+0003aef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003af00: 2265 7863 6c75 6465 6420 6b65 7973 206d  "excluded keys m
+0003af10: 7573 7420 6265 2061 206c 6973 7420 6f72  ust be a list or
+0003af20: 2074 7570 6c65 206f 6620 7374 7269 6e67   tuple of string
+0003af30: 7320 6f72 2074 7570 6c65 7320 6f66 2073  s or tuples of s
+0003af40: 7472 696e 6773 2e22 0d0a 2020 2020 2020  trings."..      
+0003af50: 2020 2020 2020 290d 0a20 2020 2020 2020        )..       
+0003af60: 2073 656c 662e 6578 636c 7564 6564 5f6b   self.excluded_k
+0003af70: 6579 7320 3d20 6578 636c 7564 6564 5f6b  eys = excluded_k
+0003af80: 6579 730d 0a20 2020 2020 2020 2073 656c  eys..        sel
+0003af90: 662e 696e 7665 7273 6520 3d20 696e 7665  f.inverse = inve
+0003afa0: 7273 650d 0a0d 0a20 2020 2064 6566 205f  rse....    def _
+0003afb0: 6361 6c6c 2873 656c 662c 2074 656e 736f  call(self, tenso
+0003afc0: 7264 6963 743a 2054 656e 736f 7244 6963  rdict: TensorDic
+0003afd0: 7442 6173 6529 202d 3e20 5465 6e73 6f72  tBase) -> Tensor
+0003afe0: 4469 6374 4261 7365 3a0d 0a20 2020 2020  DictBase:..     
+0003aff0: 2020 2069 6620 6e6f 7420 7365 6c66 2e69     if not self.i
+0003b000: 6e76 6572 7365 3a0d 0a20 2020 2020 2020  nverse:..       
+0003b010: 2020 2020 2072 6574 7572 6e20 7465 6e73       return tens
+0003b020: 6f72 6469 6374 2e65 7863 6c75 6465 282a  ordict.exclude(*
+0003b030: 7365 6c66 2e65 7863 6c75 6465 645f 6b65  self.excluded_ke
+0003b040: 7973 290d 0a20 2020 2020 2020 2072 6574  ys)..        ret
+0003b050: 7572 6e20 7465 6e73 6f72 6469 6374 0d0a  urn tensordict..
+0003b060: 0d0a 2020 2020 6465 6620 5f69 6e76 5f63  ..    def _inv_c
+0003b070: 616c 6c28 7365 6c66 2c20 7465 6e73 6f72  all(self, tensor
+0003b080: 6469 6374 3a20 5465 6e73 6f72 4469 6374  dict: TensorDict
+0003b090: 4261 7365 2920 2d3e 2054 656e 736f 7244  Base) -> TensorD
+0003b0a0: 6963 7442 6173 653a 0d0a 2020 2020 2020  ictBase:..      
+0003b0b0: 2020 6966 2073 656c 662e 696e 7665 7273    if self.invers
+0003b0c0: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+0003b0d0: 7265 7475 726e 2074 656e 736f 7264 6963  return tensordic
+0003b0e0: 742e 6578 636c 7564 6528 2a73 656c 662e  t.exclude(*self.
+0003b0f0: 6578 636c 7564 6564 5f6b 6579 7329 0d0a  excluded_keys)..
+0003b100: 2020 2020 2020 2020 7265 7475 726e 2074          return t
+0003b110: 656e 736f 7264 6963 740d 0a0d 0a20 2020  ensordict....   
+0003b120: 2066 6f72 7761 7264 203d 205f 6361 6c6c   forward = _call
+0003b130: 0d0a 0d0a 2020 2020 6465 6620 5f72 6573  ....    def _res
+0003b140: 6574 280d 0a20 2020 2020 2020 2073 656c  et(..        sel
+0003b150: 662c 2074 656e 736f 7264 6963 743a 2054  f, tensordict: T
+0003b160: 656e 736f 7244 6963 7442 6173 652c 2074  ensorDictBase, t
+0003b170: 656e 736f 7264 6963 745f 7265 7365 743a  ensordict_reset:
+0003b180: 2054 656e 736f 7244 6963 7442 6173 650d   TensorDictBase.
+0003b190: 0a20 2020 2029 202d 3e20 5465 6e73 6f72  .    ) -> Tensor
+0003b1a0: 4469 6374 4261 7365 3a0d 0a20 2020 2020  DictBase:..     
+0003b1b0: 2020 2069 6620 6e6f 7420 7365 6c66 2e69     if not self.i
+0003b1c0: 6e76 6572 7365 3a0d 0a20 2020 2020 2020  nverse:..       
+0003b1d0: 2020 2020 2072 6574 7572 6e20 7465 6e73       return tens
+0003b1e0: 6f72 6469 6374 5f72 6573 6574 2e65 7863  ordict_reset.exc
+0003b1f0: 6c75 6465 282a 7365 6c66 2e65 7863 6c75  lude(*self.exclu
+0003b200: 6465 645f 6b65 7973 290d 0a20 2020 2020  ded_keys)..     
+0003b210: 2020 2072 6574 7572 6e20 7465 6e73 6f72     return tensor
+0003b220: 6469 6374 0d0a 0d0a 2020 2020 6465 6620  dict....    def 
+0003b230: 7472 616e 7366 6f72 6d5f 6f75 7470 7574  transform_output
+0003b240: 5f73 7065 6328 7365 6c66 2c20 6f75 7470  _spec(self, outp
+0003b250: 7574 5f73 7065 633a 2043 6f6d 706f 7369  ut_spec: Composi
+0003b260: 7465 5370 6563 2920 2d3e 2043 6f6d 706f  teSpec) -> Compo
+0003b270: 7369 7465 5370 6563 3a0d 0a20 2020 2020  siteSpec:..     
+0003b280: 2020 2069 6620 6e6f 7420 7365 6c66 2e69     if not self.i
+0003b290: 6e76 6572 7365 3a0d 0a20 2020 2020 2020  nverse:..       
+0003b2a0: 2020 2020 2066 756c 6c5f 646f 6e65 5f73       full_done_s
+0003b2b0: 7065 6320 3d20 6f75 7470 7574 5f73 7065  pec = output_spe
+0003b2c0: 635b 2266 756c 6c5f 646f 6e65 5f73 7065  c["full_done_spe
+0003b2d0: 6322 5d0d 0a20 2020 2020 2020 2020 2020  c"]..           
+0003b2e0: 2066 756c 6c5f 7265 7761 7264 5f73 7065   full_reward_spe
+0003b2f0: 6320 3d20 6f75 7470 7574 5f73 7065 635b  c = output_spec[
+0003b300: 2266 756c 6c5f 7265 7761 7264 5f73 7065  "full_reward_spe
+0003b310: 6322 5d0d 0a20 2020 2020 2020 2020 2020  c"]..           
+0003b320: 2066 756c 6c5f 6f62 7365 7276 6174 696f   full_observatio
+0003b330: 6e5f 7370 6563 203d 206f 7574 7075 745f  n_spec = output_
+0003b340: 7370 6563 5b22 6675 6c6c 5f6f 6273 6572  spec["full_obser
+0003b350: 7661 7469 6f6e 5f73 7065 6322 5d0d 0a20  vation_spec"].. 
+0003b360: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+0003b370: 6579 2069 6e20 7365 6c66 2e65 7863 6c75  ey in self.exclu
+0003b380: 6465 645f 6b65 7973 3a0d 0a20 2020 2020  ded_keys:..     
+0003b390: 2020 2020 2020 2020 2020 2023 2064 6f6e             # don
+0003b3a0: 655f 7370 6563 0d0a 2020 2020 2020 2020  e_spec..        
+0003b3b0: 2020 2020 2020 2020 6966 2075 6e72 6176          if unrav
+0003b3c0: 656c 5f6b 6579 286b 6579 2920 696e 206c  el_key(key) in l
+0003b3d0: 6973 7428 6675 6c6c 5f64 6f6e 655f 7370  ist(full_done_sp
+0003b3e0: 6563 2e6b 6579 7328 5472 7565 2c20 5472  ec.keys(True, Tr
+0003b3f0: 7565 2929 3a0d 0a20 2020 2020 2020 2020  ue)):..         
+0003b400: 2020 2020 2020 2020 2020 2064 656c 2066             del f
+0003b410: 756c 6c5f 646f 6e65 5f73 7065 635b 6b65  ull_done_spec[ke
+0003b420: 795d 0d0a 2020 2020 2020 2020 2020 2020  y]..            
+0003b430: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+0003b440: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0003b450: 2020 2320 7265 7761 7264 5f73 7065 630d    # reward_spec.
+0003b460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003b470: 2069 6620 756e 7261 7665 6c5f 6b65 7928   if unravel_key(
+0003b480: 6b65 7929 2069 6e20 6c69 7374 2866 756c  key) in list(ful
+0003b490: 6c5f 7265 7761 7264 5f73 7065 632e 6b65  l_reward_spec.ke
+0003b4a0: 7973 2854 7275 652c 2054 7275 6529 293a  ys(True, True)):
+0003b4b0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0003b4c0: 2020 2020 2020 6465 6c20 6675 6c6c 5f72        del full_r
+0003b4d0: 6577 6172 645f 7370 6563 5b6b 6579 5d0d  eward_spec[key].
+0003b4e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003b4f0: 2020 2020 2063 6f6e 7469 6e75 650d 0a20       continue.. 
+0003b500: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0003b510: 206f 6273 6572 7661 7469 6f6e 5f73 7065   observation_spe
+0003b520: 630d 0a20 2020 2020 2020 2020 2020 2020  c..             
+0003b530: 2020 2069 6620 756e 7261 7665 6c5f 6b65     if unravel_ke
+0003b540: 7928 6b65 7929 2069 6e20 6c69 7374 2866  y(key) in list(f
+0003b550: 756c 6c5f 6f62 7365 7276 6174 696f 6e5f  ull_observation_
+0003b560: 7370 6563 2e6b 6579 7328 5472 7565 2c20  spec.keys(True, 
+0003b570: 5472 7565 2929 3a0d 0a20 2020 2020 2020  True)):..       
+0003b580: 2020 2020 2020 2020 2020 2020 2064 656c               del
+0003b590: 2066 756c 6c5f 6f62 7365 7276 6174 696f   full_observatio
+0003b5a0: 6e5f 7370 6563 5b6b 6579 5d0d 0a20 2020  n_spec[key]..   
+0003b5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b5c0: 2063 6f6e 7469 6e75 650d 0a20 2020 2020   continue..     
+0003b5d0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0003b5e0: 204b 6579 4572 726f 7228 6622 4b65 7920   KeyError(f"Key 
+0003b5f0: 7b6b 6579 7d20 6e6f 7420 666f 756e 6420  {key} not found 
+0003b600: 696e 2074 6865 2065 6e76 6972 6f6e 6d65  in the environme
+0003b610: 6e74 206f 7574 7075 7473 2e22 290d 0a20  nt outputs.").. 
+0003b620: 2020 2020 2020 2072 6574 7572 6e20 6f75         return ou
+0003b630: 7470 7574 5f73 7065 630d 0a0d 0a0d 0a63  tput_spec......c
+0003b640: 6c61 7373 2053 656c 6563 7454 7261 6e73  lass SelectTrans
+0003b650: 666f 726d 2854 7261 6e73 666f 726d 293a  form(Transform):
+0003b660: 0d0a 2020 2020 2222 2253 656c 6563 7420  ..    """Select 
+0003b670: 6b65 7973 2066 726f 6d20 7468 6520 696e  keys from the in
+0003b680: 7075 7420 7465 6e73 6f72 6469 6374 2e0d  put tensordict..
+0003b690: 0a0d 0a20 2020 2049 6e20 6765 6e65 7261  ...    In genera
+0003b6a0: 6c2c 2074 6865 203a 6f62 6a3a 6045 7863  l, the :obj:`Exc
+0003b6b0: 6c75 6465 5472 616e 7366 6f72 6d60 2073  ludeTransform` s
+0003b6c0: 686f 756c 6420 6265 2070 7265 6665 7272  hould be preferr
+0003b6d0: 6564 3a20 7468 6973 2074 7261 6e73 666f  ed: this transfo
+0003b6e0: 726d 7320 616c 736f 0d0a 2020 2020 2020  rms also..      
+0003b6f0: 2020 7365 6c65 6374 7320 7468 6520 2261    selects the "a
+0003b700: 6374 696f 6e22 2028 6f72 206f 7468 6572  ction" (or other
+0003b710: 206b 6579 7320 6672 6f6d 2069 6e70 7574   keys from input
+0003b720: 5f73 7065 6329 2c20 2264 6f6e 6522 2061  _spec), "done" a
+0003b730: 6e64 2022 7265 7761 7264 220d 0a20 2020  nd "reward"..   
+0003b740: 2020 2020 206b 6579 7320 6275 7420 6f74       keys but ot
+0003b750: 6865 7220 6d61 7920 6265 206e 6563 6573  her may be neces
+0003b760: 7361 7279 2e0d 0a0d 0a20 2020 2041 7267  sary.....    Arg
+0003b770: 733a 0d0a 2020 2020 2020 2020 2a73 656c  s:..        *sel
+0003b780: 6563 7465 645f 6b65 7973 2028 6974 6572  ected_keys (iter
+0003b790: 6162 6c65 206f 6620 4e65 7374 6564 4b65  able of NestedKe
+0003b7a0: 7929 3a20 5468 6520 6e61 6d65 206f 6620  y): The name of 
+0003b7b0: 7468 6520 6b65 7973 2074 6f20 7365 6c65  the keys to sele
+0003b7c0: 6374 2e20 4966 2074 6865 206b 6579 2069  ct. If the key i
+0003b7d0: 730d 0a20 2020 2020 2020 2020 2020 206e  s..            n
+0003b7e0: 6f74 2070 7265 7365 6e74 2c20 6974 2069  ot present, it i
+0003b7f0: 7320 7369 6d70 6c79 2069 676e 6f72 6564  s simply ignored
+0003b800: 2e0d 0a0d 0a20 2020 204b 6579 776f 7264  .....    Keyword
+0003b810: 2041 7267 733a 0d0a 2020 2020 2020 2020   Args:..        
+0003b820: 6b65 6570 5f72 6577 6172 6473 2028 626f  keep_rewards (bo
+0003b830: 6f6c 2c20 6f70 7469 6f6e 616c 293a 2069  ol, optional): i
+0003b840: 6620 6060 4661 6c73 6560 602c 2074 6865  f ``False``, the
+0003b850: 2072 6577 6172 6420 6b65 7973 206d 7573   reward keys mus
+0003b860: 7420 6265 2070 726f 7669 6465 640d 0a20  t be provided.. 
+0003b870: 2020 2020 2020 2020 2020 2069 6620 7468             if th
+0003b880: 6579 2073 686f 756c 6420 6265 206b 6570  ey should be kep
+0003b890: 742e 2044 6566 6175 6c74 7320 746f 2060  t. Defaults to `
+0003b8a0: 6054 7275 6560 602e 0d0a 2020 2020 2020  `True``...      
+0003b8b0: 2020 6b65 6570 5f64 6f6e 6573 2028 626f    keep_dones (bo
+0003b8c0: 6f6c 2c20 6f70 7469 6f6e 616c 293a 2069  ol, optional): i
+0003b8d0: 6620 6060 4661 6c73 6560 602c 2074 6865  f ``False``, the
+0003b8e0: 2064 6f6e 6520 6b65 7973 206d 7573 7420   done keys must 
+0003b8f0: 6265 2070 726f 7669 6465 640d 0a20 2020  be provided..   
+0003b900: 2020 2020 2020 2020 2069 6620 7468 6579           if they
+0003b910: 2073 686f 756c 6420 6265 206b 6570 742e   should be kept.
+0003b920: 2044 6566 6175 6c74 7320 746f 2060 6054   Defaults to ``T
+0003b930: 7275 6560 602e 0d0a 0d0a 2020 2020 2020  rue``.....      
+0003b940: 2020 3e3e 3e20 696d 706f 7274 2067 796d    >>> import gym
+0003b950: 6e61 7369 756d 0d0a 2020 2020 2020 2020  nasium..        
+0003b960: 3e3e 3e20 6672 6f6d 2074 6f72 6368 726c  >>> from torchrl
+0003b970: 2e65 6e76 7320 696d 706f 7274 2047 796d  .envs import Gym
+0003b980: 5772 6170 7065 720d 0a20 2020 2020 2020  Wrapper..       
+0003b990: 203e 3e3e 2065 6e76 203d 2054 7261 6e73   >>> env = Trans
+0003b9a0: 666f 726d 6564 456e 7628 0d0a 2020 2020  formedEnv(..    
+0003b9b0: 2020 2020 2e2e 2e20 2020 2020 4779 6d57      ...     GymW
+0003b9c0: 7261 7070 6572 2867 796d 6e61 7369 756d  rapper(gymnasium
+0003b9d0: 2e6d 616b 6528 2250 656e 6475 6c75 6d2d  .make("Pendulum-
+0003b9e0: 7631 2229 292c 0d0a 2020 2020 2020 2020  v1")),..        
+0003b9f0: 2e2e 2e20 2020 2020 5365 6c65 6374 5472  ...     SelectTr
+0003ba00: 616e 7366 6f72 6d28 226f 6273 6572 7661  ansform("observa
+0003ba10: 7469 6f6e 222c 2022 7265 7761 7264 222c  tion", "reward",
+0003ba20: 2022 646f 6e65 222c 206b 6565 705f 646f   "done", keep_do
+0003ba30: 6e65 733d 4661 6c73 6529 2c20 2320 7765  nes=False), # we
+0003ba40: 206c 6561 7665 2064 6f6e 6520 6265 6869   leave done behi
+0003ba50: 6e64 0d0a 2020 2020 2020 2020 2e2e 2e20  nd..        ... 
+0003ba60: 290d 0a20 2020 2020 2020 203e 3e3e 2065  )..        >>> e
+0003ba70: 6e76 2e72 6f6c 6c6f 7574 2833 2920 2023  nv.rollout(3)  #
+0003ba80: 2074 6865 2074 7275 6e63 6174 6564 206b   the truncated k
+0003ba90: 6579 2069 7320 6e6f 7720 6162 7365 6e74  ey is now absent
+0003baa0: 0d0a 2020 2020 2020 2020 5465 6e73 6f72  ..        Tensor
+0003bab0: 4469 6374 280d 0a20 2020 2020 2020 2020  Dict(..         
+0003bac0: 2020 2066 6965 6c64 733d 7b0d 0a20 2020     fields={..   
+0003bad0: 2020 2020 2020 2020 2020 2020 2061 6374               act
+0003bae0: 696f 6e3a 2054 656e 736f 7228 7368 6170  ion: Tensor(shap
+0003baf0: 653d 746f 7263 682e 5369 7a65 285b 332c  e=torch.Size([3,
+0003bb00: 2031 5d29 2c20 6465 7669 6365 3d63 7075   1]), device=cpu
+0003bb10: 2c20 6474 7970 653d 746f 7263 682e 666c  , dtype=torch.fl
+0003bb20: 6f61 7433 322c 2069 735f 7368 6172 6564  oat32, is_shared
+0003bb30: 3d46 616c 7365 292c 0d0a 2020 2020 2020  =False),..      
+0003bb40: 2020 2020 2020 2020 2020 646f 6e65 3a20            done: 
+0003bb50: 5465 6e73 6f72 2873 6861 7065 3d74 6f72  Tensor(shape=tor
+0003bb60: 6368 2e53 697a 6528 5b33 2c20 315d 292c  ch.Size([3, 1]),
+0003bb70: 2064 6576 6963 653d 6370 752c 2064 7479   device=cpu, dty
+0003bb80: 7065 3d74 6f72 6368 2e62 6f6f 6c2c 2069  pe=torch.bool, i
+0003bb90: 735f 7368 6172 6564 3d46 616c 7365 292c  s_shared=False),
+0003bba0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0003bbb0: 2020 6e65 7874 3a20 5465 6e73 6f72 4469    next: TensorDi
+0003bbc0: 6374 280d 0a20 2020 2020 2020 2020 2020  ct(..           
+0003bbd0: 2020 2020 2020 2020 2066 6965 6c64 733d           fields=
+0003bbe0: 7b0d 0a20 2020 2020 2020 2020 2020 2020  {..             
+0003bbf0: 2020 2020 2020 2020 2020 2064 6f6e 653a             done:
+0003bc00: 2054 656e 736f 7228 7368 6170 653d 746f   Tensor(shape=to
+0003bc10: 7263 682e 5369 7a65 285b 332c 2031 5d29  rch.Size([3, 1])
+0003bc20: 2c20 6465 7669 6365 3d63 7075 2c20 6474  , device=cpu, dt
+0003bc30: 7970 653d 746f 7263 682e 626f 6f6c 2c20  ype=torch.bool, 
+0003bc40: 6973 5f73 6861 7265 643d 4661 6c73 6529  is_shared=False)
+0003bc50: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+0003bc60: 2020 2020 2020 2020 2020 206f 6273 6572             obser
+0003bc70: 7661 7469 6f6e 3a20 5465 6e73 6f72 2873  vation: Tensor(s
+0003bc80: 6861 7065 3d74 6f72 6368 2e53 697a 6528  hape=torch.Size(
+0003bc90: 5b33 2c20 335d 292c 2064 6576 6963 653d  [3, 3]), device=
+0003bca0: 6370 752c 2064 7479 7065 3d74 6f72 6368  cpu, dtype=torch
+0003bcb0: 2e66 6c6f 6174 3332 2c20 6973 5f73 6861  .float32, is_sha
+0003bcc0: 7265 643d 4661 6c73 6529 2c0d 0a20 2020  red=False),..   
+0003bcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bce0: 2020 2020 2072 6577 6172 643a 2054 656e       reward: Ten
+0003bcf0: 736f 7228 7368 6170 653d 746f 7263 682e  sor(shape=torch.
+0003bd00: 5369 7a65 285b 332c 2031 5d29 2c20 6465  Size([3, 1]), de
+0003bd10: 7669 6365 3d63 7075 2c20 6474 7970 653d  vice=cpu, dtype=
+0003bd20: 746f 7263 682e 666c 6f61 7433 322c 2069  torch.float32, i
+0003bd30: 735f 7368 6172 6564 3d46 616c 7365 297d  s_shared=False)}
+0003bd40: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+0003bd50: 2020 2020 2020 2062 6174 6368 5f73 697a         batch_siz
+0003bd60: 653d 746f 7263 682e 5369 7a65 285b 335d  e=torch.Size([3]
+0003bd70: 292c 0d0a 2020 2020 2020 2020 2020 2020  ),..            
+0003bd80: 2020 2020 2020 2020 6465 7669 6365 3d63          device=c
+0003bd90: 7075 2c0d 0a20 2020 2020 2020 2020 2020  pu,..           
+0003bda0: 2020 2020 2020 2020 2069 735f 7368 6172           is_shar
+0003bdb0: 6564 3d46 616c 7365 292c 0d0a 2020 2020  ed=False),..    
+0003bdc0: 2020 2020 2020 2020 2020 2020 6f62 7365              obse
+0003bdd0: 7276 6174 696f 6e3a 2054 656e 736f 7228  rvation: Tensor(
+0003bde0: 7368 6170 653d 746f 7263 682e 5369 7a65  shape=torch.Size
+0003bdf0: 285b 332c 2033 5d29 2c20 6465 7669 6365  ([3, 3]), device
+0003be00: 3d63 7075 2c20 6474 7970 653d 746f 7263  =cpu, dtype=torc
+0003be10: 682e 666c 6f61 7433 322c 2069 735f 7368  h.float32, is_sh
+0003be20: 6172 6564 3d46 616c 7365 297d 2c0d 0a20  ared=False)},.. 
+0003be30: 2020 2020 2020 2020 2020 2062 6174 6368             batch
+0003be40: 5f73 697a 653d 746f 7263 682e 5369 7a65  _size=torch.Size
+0003be50: 285b 335d 292c 0d0a 2020 2020 2020 2020  ([3]),..        
+0003be60: 2020 2020 6465 7669 6365 3d63 7075 2c0d      device=cpu,.
+0003be70: 0a20 2020 2020 2020 2020 2020 2069 735f  .            is_
+0003be80: 7368 6172 6564 3d46 616c 7365 290d 0a0d  shared=False)...
+0003be90: 0a20 2020 2022 2222 0d0a 0d0a 2020 2020  .    """....    
+0003bea0: 6465 6620 5f5f 696e 6974 5f5f 280d 0a20  def __init__(.. 
+0003beb0: 2020 2020 2020 2073 656c 662c 0d0a 2020         self,..  
+0003bec0: 2020 2020 2020 2a73 656c 6563 7465 645f        *selected_
+0003bed0: 6b65 7973 3a20 4e65 7374 6564 4b65 792c  keys: NestedKey,
+0003bee0: 0d0a 2020 2020 2020 2020 6b65 6570 5f72  ..        keep_r
+0003bef0: 6577 6172 6473 3a20 626f 6f6c 203d 2054  ewards: bool = T
+0003bf00: 7275 652c 0d0a 2020 2020 2020 2020 6b65  rue,..        ke
+0003bf10: 6570 5f64 6f6e 6573 3a20 626f 6f6c 203d  ep_dones: bool =
+0003bf20: 2054 7275 652c 0d0a 2020 2020 293a 0d0a   True,..    ):..
+0003bf30: 2020 2020 2020 2020 7375 7065 7228 292e          super().
+0003bf40: 5f5f 696e 6974 5f5f 2829 0d0a 2020 2020  __init__()..    
+0003bf50: 2020 2020 7472 793a 0d0a 2020 2020 2020      try:..      
+0003bf60: 2020 2020 2020 7365 6c65 6374 6564 5f6b        selected_k
+0003bf70: 6579 7320 3d20 756e 7261 7665 6c5f 6b65  eys = unravel_ke
+0003bf80: 795f 6c69 7374 2873 656c 6563 7465 645f  y_list(selected_
+0003bf90: 6b65 7973 290d 0a20 2020 2020 2020 2065  keys)..        e
+0003bfa0: 7863 6570 7420 5479 7065 4572 726f 723a  xcept TypeError:
+0003bfb0: 0d0a 2020 2020 2020 2020 2020 2020 7261  ..            ra
+0003bfc0: 6973 6520 5479 7065 4572 726f 7228 0d0a  ise TypeError(..
+0003bfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bfe0: 2273 656c 6563 7465 6420 6b65 7973 206d  "selected keys m
+0003bff0: 7573 7420 6265 2061 206c 6973 7420 6f72  ust be a list or
+0003c000: 2074 7570 6c65 206f 6620 7374 7269 6e67   tuple of string
+0003c010: 7320 6f72 2074 7570 6c65 7320 6f66 2073  s or tuples of s
+0003c020: 7472 696e 6773 2e22 0d0a 2020 2020 2020  trings."..      
+0003c030: 2020 2020 2020 290d 0a20 2020 2020 2020        )..       
+0003c040: 2073 656c 662e 7365 6c65 6374 6564 5f6b   self.selected_k
+0003c050: 6579 7320 3d20 7365 6c65 6374 6564 5f6b  eys = selected_k
+0003c060: 6579 730d 0a20 2020 2020 2020 2073 656c  eys..        sel
+0003c070: 662e 6b65 6570 5f64 6f6e 655f 6b65 7973  f.keep_done_keys
+0003c080: 203d 206b 6565 705f 646f 6e65 730d 0a20   = keep_dones.. 
+0003c090: 2020 2020 2020 2073 656c 662e 6b65 6570         self.keep
+0003c0a0: 5f72 6577 6172 645f 6b65 7973 203d 206b  _reward_keys = k
+0003c0b0: 6565 705f 7265 7761 7264 730d 0a0d 0a20  eep_rewards.... 
+0003c0c0: 2020 2064 6566 205f 6361 6c6c 2873 656c     def _call(sel
+0003c0d0: 662c 2074 656e 736f 7264 6963 743a 2054  f, tensordict: T
+0003c0e0: 656e 736f 7244 6963 7442 6173 6529 202d  ensorDictBase) -
+0003c0f0: 3e20 5465 6e73 6f72 4469 6374 4261 7365  > TensorDictBase
+0003c100: 3a0d 0a20 2020 2020 2020 2069 6620 7365  :..        if se
+0003c110: 6c66 2e70 6172 656e 7420 6973 206e 6f74  lf.parent is not
+0003c120: 204e 6f6e 653a 0d0a 2020 2020 2020 2020   None:..        
+0003c130: 2020 2020 696e 7075 745f 6b65 7973 203d      input_keys =
+0003c140: 2073 656c 662e 7061 7265 6e74 2e73 7461   self.parent.sta
+0003c150: 7465 5f73 7065 632e 6b65 7973 2854 7275  te_spec.keys(Tru
+0003c160: 652c 2054 7275 6529 0d0a 2020 2020 2020  e, True)..      
+0003c170: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
+0003c180: 2020 2020 2069 6e70 7574 5f6b 6579 7320       input_keys 
+0003c190: 3d20 5b5d 0d0a 2020 2020 2020 2020 6966  = []..        if
+0003c1a0: 2073 656c 662e 6b65 6570 5f72 6577 6172   self.keep_rewar
+0003c1b0: 645f 6b65 7973 3a0d 0a20 2020 2020 2020  d_keys:..       
+0003c1c0: 2020 2020 2072 6577 6172 645f 6b65 7973       reward_keys
+0003c1d0: 203d 2073 656c 662e 7061 7265 6e74 2e72   = self.parent.r
+0003c1e0: 6577 6172 645f 6b65 7973 2069 6620 7365  eward_keys if se
+0003c1f0: 6c66 2e70 6172 656e 7420 656c 7365 205b  lf.parent else [
+0003c200: 2272 6577 6172 6422 5d0d 0a20 2020 2020  "reward"]..     
+0003c210: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
+0003c220: 2020 2020 2020 7265 7761 7264 5f6b 6579        reward_key
+0003c230: 7320 3d20 5b5d 0d0a 2020 2020 2020 2020  s = []..        
+0003c240: 6966 2073 656c 662e 6b65 6570 5f64 6f6e  if self.keep_don
+0003c250: 655f 6b65 7973 3a0d 0a20 2020 2020 2020  e_keys:..       
+0003c260: 2020 2020 2064 6f6e 655f 6b65 7973 203d       done_keys =
+0003c270: 2073 656c 662e 7061 7265 6e74 2e64 6f6e   self.parent.don
+0003c280: 655f 6b65 7973 2069 6620 7365 6c66 2e70  e_keys if self.p
+0003c290: 6172 656e 7420 656c 7365 205b 2264 6f6e  arent else ["don
+0003c2a0: 6522 5d0d 0a20 2020 2020 2020 2065 6c73  e"]..        els
+0003c2b0: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+0003c2c0: 646f 6e65 5f6b 6579 7320 3d20 5b5d 0d0a  done_keys = []..
+0003c2d0: 2020 2020 2020 2020 7265 7475 726e 2074          return t
+0003c2e0: 656e 736f 7264 6963 742e 7365 6c65 6374  ensordict.select
+0003c2f0: 280d 0a20 2020 2020 2020 2020 2020 202a  (..            *
+0003c300: 7365 6c66 2e73 656c 6563 7465 645f 6b65  self.selected_ke
+0003c310: 7973 2c20 2a72 6577 6172 645f 6b65 7973  ys, *reward_keys
+0003c320: 2c20 2a64 6f6e 655f 6b65 7973 2c20 2a69  , *done_keys, *i
+0003c330: 6e70 7574 5f6b 6579 732c 2073 7472 6963  nput_keys, stric
+0003c340: 743d 4661 6c73 650d 0a20 2020 2020 2020  t=False..       
+0003c350: 2029 0d0a 0d0a 2020 2020 666f 7277 6172   )....    forwar
+0003c360: 6420 3d20 5f63 616c 6c0d 0a0d 0a20 2020  d = _call....   
+0003c370: 2064 6566 205f 7265 7365 7428 0d0a 2020   def _reset(..  
+0003c380: 2020 2020 2020 7365 6c66 2c20 7465 6e73        self, tens
+0003c390: 6f72 6469 6374 3a20 5465 6e73 6f72 4469  ordict: TensorDi
+0003c3a0: 6374 4261 7365 2c20 7465 6e73 6f72 6469  ctBase, tensordi
+0003c3b0: 6374 5f72 6573 6574 3a20 5465 6e73 6f72  ct_reset: Tensor
+0003c3c0: 4469 6374 4261 7365 0d0a 2020 2020 2920  DictBase..    ) 
+0003c3d0: 2d3e 2054 656e 736f 7244 6963 7442 6173  -> TensorDictBas
+0003c3e0: 653a 0d0a 2020 2020 2020 2020 6966 2073  e:..        if s
+0003c3f0: 656c 662e 7061 7265 6e74 2069 7320 6e6f  elf.parent is no
+0003c400: 7420 4e6f 6e65 3a0d 0a20 2020 2020 2020  t None:..       
+0003c410: 2020 2020 2069 6e70 7574 5f6b 6579 7320       input_keys 
+0003c420: 3d20 7365 6c66 2e70 6172 656e 742e 7374  = self.parent.st
+0003c430: 6174 655f 7370 6563 2e6b 6579 7328 5472  ate_spec.keys(Tr
+0003c440: 7565 2c20 5472 7565 290d 0a20 2020 2020  ue, True)..     
+0003c450: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
+0003c460: 2020 2020 2020 696e 7075 745f 6b65 7973        input_keys
+0003c470: 203d 205b 5d0d 0a20 2020 2020 2020 2069   = []..        i
+0003c480: 6620 7365 6c66 2e6b 6565 705f 7265 7761  f self.keep_rewa
+0003c490: 7264 5f6b 6579 733a 0d0a 2020 2020 2020  rd_keys:..      
+0003c4a0: 2020 2020 2020 7265 7761 7264 5f6b 6579        reward_key
+0003c4b0: 7320 3d20 7365 6c66 2e70 6172 656e 742e  s = self.parent.
+0003c4c0: 7265 7761 7264 5f6b 6579 7320 6966 2073  reward_keys if s
+0003c4d0: 656c 662e 7061 7265 6e74 2065 6c73 6520  elf.parent else 
+0003c4e0: 5b22 7265 7761 7264 225d 0d0a 2020 2020  ["reward"]..    
+0003c4f0: 2020 2020 656c 7365 3a0d 0a20 2020 2020      else:..     
+0003c500: 2020 2020 2020 2072 6577 6172 645f 6b65         reward_ke
+0003c510: 7973 203d 205b 5d0d 0a20 2020 2020 2020  ys = []..       
+0003c520: 2069 6620 7365 6c66 2e6b 6565 705f 646f   if self.keep_do
+0003c530: 6e65 5f6b 6579 733a 0d0a 2020 2020 2020  ne_keys:..      
+0003c540: 2020 2020 2020 646f 6e65 5f6b 6579 7320        done_keys 
+0003c550: 3d20 7365 6c66 2e70 6172 656e 742e 646f  = self.parent.do
+0003c560: 6e65 5f6b 6579 7320 6966 2073 656c 662e  ne_keys if self.
+0003c570: 7061 7265 6e74 2065 6c73 6520 5b22 646f  parent else ["do
+0003c580: 6e65 225d 0d0a 2020 2020 2020 2020 656c  ne"]..        el
+0003c590: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
+0003c5a0: 2064 6f6e 655f 6b65 7973 203d 205b 5d0d   done_keys = [].
+0003c5b0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0003c5c0: 7465 6e73 6f72 6469 6374 5f72 6573 6574  tensordict_reset
+0003c5d0: 2e73 656c 6563 7428 0d0a 2020 2020 2020  .select(..      
+0003c5e0: 2020 2020 2020 2a73 656c 662e 7365 6c65        *self.sele
+0003c5f0: 6374 6564 5f6b 6579 732c 202a 7265 7761  cted_keys, *rewa
+0003c600: 7264 5f6b 6579 732c 202a 646f 6e65 5f6b  rd_keys, *done_k
+0003c610: 6579 732c 202a 696e 7075 745f 6b65 7973  eys, *input_keys
+0003c620: 2c20 7374 7269 6374 3d46 616c 7365 0d0a  , strict=False..
+0003c630: 2020 2020 2020 2020 290d 0a0d 0a20 2020          )....   
+0003c640: 2064 6566 2074 7261 6e73 666f 726d 5f6f   def transform_o
+0003c650: 7574 7075 745f 7370 6563 2873 656c 662c  utput_spec(self,
+0003c660: 206f 7574 7075 745f 7370 6563 3a20 436f   output_spec: Co
+0003c670: 6d70 6f73 6974 6553 7065 6329 202d 3e20  mpositeSpec) -> 
+0003c680: 436f 6d70 6f73 6974 6553 7065 633a 0d0a  CompositeSpec:..
+0003c690: 2020 2020 2020 2020 6675 6c6c 5f64 6f6e          full_don
+0003c6a0: 655f 7370 6563 203d 206f 7574 7075 745f  e_spec = output_
+0003c6b0: 7370 6563 5b22 6675 6c6c 5f64 6f6e 655f  spec["full_done_
+0003c6c0: 7370 6563 225d 0d0a 2020 2020 2020 2020  spec"]..        
+0003c6d0: 6675 6c6c 5f72 6577 6172 645f 7370 6563  full_reward_spec
+0003c6e0: 203d 206f 7574 7075 745f 7370 6563 5b22   = output_spec["
+0003c6f0: 6675 6c6c 5f72 6577 6172 645f 7370 6563  full_reward_spec
+0003c700: 225d 0d0a 2020 2020 2020 2020 6675 6c6c  "]..        full
+0003c710: 5f6f 6273 6572 7661 7469 6f6e 5f73 7065  _observation_spe
+0003c720: 6320 3d20 6f75 7470 7574 5f73 7065 635b  c = output_spec[
+0003c730: 2266 756c 6c5f 6f62 7365 7276 6174 696f  "full_observatio
+0003c740: 6e5f 7370 6563 225d 0d0a 2020 2020 2020  n_spec"]..      
+0003c750: 2020 6966 206e 6f74 2073 656c 662e 6b65    if not self.ke
+0003c760: 6570 5f64 6f6e 655f 6b65 7973 3a0d 0a20  ep_done_keys:.. 
+0003c770: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+0003c780: 6579 2069 6e20 6c69 7374 2866 756c 6c5f  ey in list(full_
+0003c790: 646f 6e65 5f73 7065 632e 6b65 7973 2854  done_spec.keys(T
+0003c7a0: 7275 652c 2054 7275 6529 293a 0d0a 2020  rue, True)):..  
+0003c7b0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0003c7c0: 2075 6e72 6176 656c 5f6b 6579 286b 6579   unravel_key(key
+0003c7d0: 2920 6e6f 7420 696e 2073 656c 662e 7365  ) not in self.se
+0003c7e0: 6c65 6374 6564 5f6b 6579 733a 0d0a 2020  lected_keys:..  
+0003c7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c800: 2020 6465 6c20 6675 6c6c 5f64 6f6e 655f    del full_done_
+0003c810: 7370 6563 5b6b 6579 5d0d 0a0d 0a20 2020  spec[key]....   
+0003c820: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
+0003c830: 6c69 7374 2866 756c 6c5f 6f62 7365 7276  list(full_observ
+0003c840: 6174 696f 6e5f 7370 6563 2e6b 6579 7328  ation_spec.keys(
+0003c850: 5472 7565 2c20 5472 7565 2929 3a0d 0a20  True, True)):.. 
+0003c860: 2020 2020 2020 2020 2020 2069 6620 756e             if un
+0003c870: 7261 7665 6c5f 6b65 7928 6b65 7929 206e  ravel_key(key) n
+0003c880: 6f74 2069 6e20 7365 6c66 2e73 656c 6563  ot in self.selec
+0003c890: 7465 645f 6b65 7973 3a0d 0a20 2020 2020  ted_keys:..     
+0003c8a0: 2020 2020 2020 2020 2020 2064 656c 2066             del f
+0003c8b0: 756c 6c5f 6f62 7365 7276 6174 696f 6e5f  ull_observation_
+0003c8c0: 7370 6563 5b6b 6579 5d0d 0a0d 0a20 2020  spec[key]....   
+0003c8d0: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+0003c8e0: 2e6b 6565 705f 7265 7761 7264 5f6b 6579  .keep_reward_key
+0003c8f0: 733a 0d0a 2020 2020 2020 2020 2020 2020  s:..            
+0003c900: 666f 7220 6b65 7920 696e 206c 6973 7428  for key in list(
+0003c910: 6675 6c6c 5f72 6577 6172 645f 7370 6563  full_reward_spec
+0003c920: 2e6b 6579 7328 5472 7565 2c20 5472 7565  .keys(True, True
+0003c930: 2929 3a0d 0a20 2020 2020 2020 2020 2020  )):..           
+0003c940: 2020 2020 2069 6620 756e 7261 7665 6c5f       if unravel_
+0003c950: 6b65 7928 6b65 7929 206e 6f74 2069 6e20  key(key) not in 
+0003c960: 7365 6c66 2e73 656c 6563 7465 645f 6b65  self.selected_ke
+0003c970: 7973 3a0d 0a20 2020 2020 2020 2020 2020  ys:..           
+0003c980: 2020 2020 2020 2020 2064 656c 2066 756c           del ful
+0003c990: 6c5f 7265 7761 7264 5f73 7065 635b 6b65  l_reward_spec[ke
+0003c9a0: 795d 0d0a 0d0a 2020 2020 2020 2020 7265  y]....        re
+0003c9b0: 7475 726e 206f 7574 7075 745f 7370 6563  turn output_spec
+0003c9c0: 0d0a 0d0a 0d0a 636c 6173 7320 5469 6d65  ......class Time
+0003c9d0: 4d61 7850 6f6f 6c28 5472 616e 7366 6f72  MaxPool(Transfor
+0003c9e0: 6d29 3a0d 0a20 2020 2022 2222 5461 6b65  m):..    """Take
+0003c9f0: 2074 6865 206d 6178 696d 756d 2076 616c   the maximum val
+0003ca00: 7565 2069 6e20 6561 6368 2070 6f73 6974  ue in each posit
+0003ca10: 696f 6e20 6f76 6572 2074 6865 206c 6173  ion over the las
+0003ca20: 7420 5420 6f62 7365 7276 6174 696f 6e73  t T observations
+0003ca30: 2e0d 0a0d 0a20 2020 2054 6869 7320 7472  .....    This tr
+0003ca40: 616e 7366 6f72 6d20 7461 6b65 2074 6865  ansform take the
+0003ca50: 206d 6178 696d 756d 2076 616c 7565 2069   maximum value i
+0003ca60: 6e20 6561 6368 2070 6f73 6974 696f 6e20  n each position 
+0003ca70: 666f 7220 616c 6c20 696e 5f6b 6579 7320  for all in_keys 
+0003ca80: 7465 6e73 6f72 7320 6f76 6572 2074 6865  tensors over the
+0003ca90: 206c 6173 7420 5420 7469 6d65 2073 7465   last T time ste
+0003caa0: 7073 2e0d 0a0d 0a20 2020 2041 7267 733a  ps.....    Args:
+0003cab0: 0d0a 2020 2020 2020 2020 696e 5f6b 6579  ..        in_key
+0003cac0: 7320 2873 6571 7565 6e63 6520 6f66 204e  s (sequence of N
+0003cad0: 6573 7465 644b 6579 2c20 6f70 7469 6f6e  estedKey, option
+0003cae0: 616c 293a 2069 6e70 7574 206b 6579 7320  al): input keys 
+0003caf0: 6f6e 2077 6869 6368 2074 6865 206d 6178  on which the max
+0003cb00: 2070 6f6f 6c20 7769 6c6c 2062 6520 6170   pool will be ap
+0003cb10: 706c 6965 642e 2044 6566 6175 6c74 7320  plied. Defaults 
+0003cb20: 746f 2022 6f62 7365 7276 6174 696f 6e22  to "observation"
+0003cb30: 2069 6620 6c65 6674 2065 6d70 7479 2e0d   if left empty..
+0003cb40: 0a20 2020 2020 2020 206f 7574 5f6b 6579  .        out_key
+0003cb50: 7320 2873 6571 7565 6e63 6520 6f66 204e  s (sequence of N
+0003cb60: 6573 7465 644b 6579 2c20 6f70 7469 6f6e  estedKey, option
+0003cb70: 616c 293a 206f 7574 7075 7420 6b65 7973  al): output keys
+0003cb80: 2077 6865 7265 2074 6865 206f 7574 7075   where the outpu
+0003cb90: 7420 7769 6c6c 2062 6520 7772 6974 7465  t will be writte
+0003cba0: 6e2e 2044 6566 6175 6c74 7320 746f 2060  n. Defaults to `
+0003cbb0: 696e 5f6b 6579 7360 2069 6620 6c65 6674  in_keys` if left
+0003cbc0: 2065 6d70 7479 2e0d 0a20 2020 2020 2020   empty...       
+0003cbd0: 2054 2028 696e 742c 206f 7074 696f 6e61   T (int, optiona
+0003cbe0: 6c29 3a20 4e75 6d62 6572 206f 6620 7469  l): Number of ti
+0003cbf0: 6d65 2073 7465 7073 206f 7665 7220 7768  me steps over wh
+0003cc00: 6963 6820 746f 2061 7070 6c79 206d 6178  ich to apply max
+0003cc10: 2070 6f6f 6c69 6e67 2e0d 0a20 2020 2020   pooling...     
+0003cc20: 2020 2072 6573 6574 5f6b 6579 2028 4e65     reset_key (Ne
+0003cc30: 7374 6564 4b65 792c 206f 7074 696f 6e61  stedKey, optiona
+0003cc40: 6c29 3a20 7468 6520 7265 7365 7420 6b65  l): the reset ke
+0003cc50: 7920 746f 2062 6520 7573 6564 2061 7320  y to be used as 
+0003cc60: 7061 7274 6961 6c0d 0a20 2020 2020 2020  partial..       
+0003cc70: 2020 2020 2072 6573 6574 2069 6e64 6963       reset indic
+0003cc80: 6174 6f72 2e20 4d75 7374 2062 6520 756e  ator. Must be un
+0003cc90: 6971 7565 2e20 4966 206e 6f74 2070 726f  ique. If not pro
+0003cca0: 7669 6465 642c 2064 6566 6175 6c74 7320  vided, defaults 
+0003ccb0: 746f 2074 6865 0d0a 2020 2020 2020 2020  to the..        
+0003ccc0: 2020 2020 6f6e 6c79 2072 6573 6574 206b      only reset k
+0003ccd0: 6579 206f 6620 7468 6520 7061 7265 6e74  ey of the parent
+0003cce0: 2065 6e76 6972 6f6e 6d65 6e74 2028 6966   environment (if
+0003ccf0: 2069 7420 6861 7320 6f6e 6c79 206f 6e65   it has only one
+0003cd00: 290d 0a20 2020 2020 2020 2020 2020 2061  )..            a
+0003cd10: 6e64 2072 6169 7365 7320 616e 2065 7863  nd raises an exc
+0003cd20: 6570 7469 6f6e 206f 7468 6572 7769 7365  eption otherwise
+0003cd30: 2e0d 0a0d 0a20 2020 2045 7861 6d70 6c65  .....    Example
+0003cd40: 733a 0d0a 2020 2020 2020 2020 3e3e 3e20  s:..        >>> 
+0003cd50: 6672 6f6d 2074 6f72 6368 726c 2e65 6e76  from torchrl.env
+0003cd60: 7320 696d 706f 7274 2047 796d 456e 760d  s import GymEnv.
+0003cd70: 0a20 2020 2020 2020 203e 3e3e 2062 6173  .        >>> bas
+0003cd80: 655f 656e 7620 3d20 4779 6d45 6e76 2822  e_env = GymEnv("
+0003cd90: 5065 6e64 756c 756d 2d76 3122 290d 0a20  Pendulum-v1").. 
+0003cda0: 2020 2020 2020 203e 3e3e 2065 6e76 203d         >>> env =
+0003cdb0: 2054 7261 6e73 666f 726d 6564 456e 7628   TransformedEnv(
+0003cdc0: 6261 7365 5f65 6e76 2c20 5469 6d65 4d61  base_env, TimeMa
+0003cdd0: 7850 6f6f 6c28 696e 5f6b 6579 733d 5b22  xPool(in_keys=["
+0003cde0: 6f62 7365 7276 6174 696f 6e22 5d2c 2054  observation"], T
+0003cdf0: 3d31 3029 290d 0a20 2020 2020 2020 203e  =10))..        >
+0003ce00: 3e3e 2074 6f72 6368 2e6d 616e 7561 6c5f  >> torch.manual_
+0003ce10: 7365 6564 2830 290d 0a20 2020 2020 2020  seed(0)..       
+0003ce20: 203e 3e3e 2065 6e76 2e73 6574 5f73 6565   >>> env.set_see
+0003ce30: 6428 3029 0d0a 2020 2020 2020 2020 3e3e  d(0)..        >>
+0003ce40: 3e20 726f 6c6c 6f75 7420 3d20 656e 762e  > rollout = env.
+0003ce50: 726f 6c6c 6f75 7428 3130 290d 0a20 2020  rollout(10)..   
+0003ce60: 2020 2020 203e 3e3e 2070 7269 6e74 2872       >>> print(r
+0003ce70: 6f6c 6c6f 7574 5b22 6f62 7365 7276 6174  ollout["observat
+0003ce80: 696f 6e22 5d29 2020 2320 7661 6c75 6573  ion"])  # values
+0003ce90: 2073 686f 756c 6420 6265 2069 6e63 7265   should be incre
+0003cea0: 6173 696e 6720 7570 2075 6e74 696c 2074  asing up until t
+0003ceb0: 6865 2031 3074 6820 7374 6570 0d0a 2020  he 10th step..  
+0003cec0: 2020 2020 2020 7465 6e73 6f72 285b 5b20        tensor([[ 
+0003ced0: 302e 3030 3030 2c20 2030 2e30 3030 302c  0.0000,  0.0000,
+0003cee0: 2020 302e 3030 3030 5d2c 0d0a 2020 2020    0.0000],..    
+0003cef0: 2020 2020 2020 2020 2020 2020 5b20 302e              [ 0.
+0003cf00: 3030 3030 2c20 2030 2e30 3030 302c 2020  0000,  0.0000,  
+0003cf10: 302e 3030 3030 5d2c 0d0a 2020 2020 2020  0.0000],..      
+0003cf20: 2020 2020 2020 2020 2020 5b20 302e 3030            [ 0.00
+0003cf30: 3030 2c20 2030 2e30 3030 302c 2020 302e  00,  0.0000,  0.
+0003cf40: 3030 3030 5d2c 0d0a 2020 2020 2020 2020  0000],..        
+0003cf50: 2020 2020 2020 2020 5b20 302e 3030 3030          [ 0.0000
+0003cf60: 2c20 2030 2e30 3030 302c 2020 302e 3030  ,  0.0000,  0.00
+0003cf70: 3030 5d2c 0d0a 2020 2020 2020 2020 2020  00],..          
+0003cf80: 2020 2020 2020 5b20 302e 3030 3030 2c20        [ 0.0000, 
+0003cf90: 2030 2e30 3231 362c 2020 302e 3030 3030   0.0216,  0.0000
+0003cfa0: 5d2c 0d0a 2020 2020 2020 2020 2020 2020  ],..            
+0003cfb0: 2020 2020 5b20 302e 3030 3030 2c20 2030      [ 0.0000,  0
+0003cfc0: 2e31 3134 392c 2020 302e 3030 3030 5d2c  .1149,  0.0000],
+0003cfd0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0003cfe0: 2020 5b20 302e 3030 3030 2c20 2030 2e31    [ 0.0000,  0.1
+0003cff0: 3939 302c 2020 302e 3030 3030 5d2c 0d0a  990,  0.0000],..
+0003d000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d010: 5b20 302e 3030 3030 2c20 2030 2e32 3734  [ 0.0000,  0.274
+0003d020: 392c 2020 302e 3030 3030 5d2c 0d0a 2020  9,  0.0000],..  
+0003d030: 2020 2020 2020 2020 2020 2020 2020 5b20                [ 
+0003d040: 302e 3030 3030 2c20 2030 2e33 3238 312c  0.0000,  0.3281,
+0003d050: 2020 302e 3030 3030 5d2c 0d0a 2020 2020    0.0000],..    
+0003d060: 2020 2020 2020 2020 2020 2020 5b2d 302e              [-0.
+0003d070: 3932 3930 2c20 2030 2e33 3730 322c 202d  9290,  0.3702, -
+0003d080: 302e 3839 3738 5d5d 290d 0a0d 0a20 2020  0.8978]])....   
+0003d090: 202e 2e20 6e6f 7465 3a3a 203a 636c 6173   .. note:: :clas
+0003d0a0: 733a 607e 5469 6d65 4d61 7850 6f6f 6c60  s:`~TimeMaxPool`
+0003d0b0: 2063 7572 7265 6e74 6c79 206f 6e6c 7920   currently only 
+0003d0c0: 7375 7070 6f72 7473 2060 6064 6f6e 6560  supports ``done`
+0003d0d0: 6020 7369 676e 616c 2061 7420 7468 6520  ` signal at the 
+0003d0e0: 726f 6f74 2e0d 0a20 2020 2020 2020 204e  root...        N
+0003d0f0: 6573 7465 6420 6060 646f 6e65 6060 2c20  ested ``done``, 
+0003d100: 7375 6368 2061 7320 7468 6f73 6520 666f  such as those fo
+0003d110: 756e 6420 696e 204d 4152 4c20 7365 7474  und in MARL sett
+0003d120: 696e 6773 2c20 6172 6520 6375 7272 656e  ings, are curren
+0003d130: 746c 7920 6e6f 7420 7375 7070 6f72 7465  tly not supporte
+0003d140: 642e 0d0a 2020 2020 2020 2020 4966 2074  d...        If t
+0003d150: 6869 7320 6665 6174 7572 6520 6973 206e  his feature is n
+0003d160: 6565 6465 642c 2070 6c65 6173 6520 7261  eeded, please ra
+0003d170: 6973 6520 616e 2069 7373 7565 206f 6e20  ise an issue on 
+0003d180: 546f 7263 6852 4c20 7265 706f 2e0d 0a0d  TorchRL repo....
+0003d190: 0a20 2020 2022 2222 0d0a 0d0a 2020 2020  .    """....    
+0003d1a0: 696e 7665 7274 6962 6c65 203d 2046 616c  invertible = Fal
+0003d1b0: 7365 0d0a 0d0a 2020 2020 6465 6620 5f5f  se....    def __
+0003d1c0: 696e 6974 5f5f 280d 0a20 2020 2020 2020  init__(..       
+0003d1d0: 2073 656c 662c 0d0a 2020 2020 2020 2020   self,..        
+0003d1e0: 696e 5f6b 6579 733a 2053 6571 7565 6e63  in_keys: Sequenc
+0003d1f0: 655b 4e65 7374 6564 4b65 795d 207c 204e  e[NestedKey] | N
+0003d200: 6f6e 6520 3d20 4e6f 6e65 2c0d 0a20 2020  one = None,..   
+0003d210: 2020 2020 206f 7574 5f6b 6579 733a 2053       out_keys: S
+0003d220: 6571 7565 6e63 655b 4e65 7374 6564 4b65  equence[NestedKe
+0003d230: 795d 207c 204e 6f6e 6520 3d20 4e6f 6e65  y] | None = None
+0003d240: 2c0d 0a20 2020 2020 2020 2054 3a20 696e  ,..        T: in
+0003d250: 7420 3d20 312c 0d0a 2020 2020 2020 2020  t = 1,..        
+0003d260: 7265 7365 745f 6b65 793a 204e 6573 7465  reset_key: Neste
+0003d270: 644b 6579 207c 204e 6f6e 6520 3d20 4e6f  dKey | None = No
+0003d280: 6e65 2c0d 0a20 2020 2029 3a0d 0a20 2020  ne,..    ):..   
+0003d290: 2020 2020 2069 6620 696e 5f6b 6579 7320       if in_keys 
+0003d2a0: 6973 204e 6f6e 653a 0d0a 2020 2020 2020  is None:..      
+0003d2b0: 2020 2020 2020 696e 5f6b 6579 7320 3d20        in_keys = 
+0003d2c0: 5b22 6f62 7365 7276 6174 696f 6e22 5d0d  ["observation"].
+0003d2d0: 0a20 2020 2020 2020 2069 6620 6f75 745f  .        if out_
+0003d2e0: 6b65 7973 2069 7320 4e6f 6e65 3a0d 0a20  keys is None:.. 
+0003d2f0: 2020 2020 2020 2020 2020 206f 7574 5f6b             out_k
+0003d300: 6579 7320 3d20 636f 7079 2869 6e5f 6b65  eys = copy(in_ke
+0003d310: 7973 290d 0a20 2020 2020 2020 2073 7570  ys)..        sup
+0003d320: 6572 2829 2e5f 5f69 6e69 745f 5f28 696e  er().__init__(in
+0003d330: 5f6b 6579 733d 696e 5f6b 6579 732c 206f  _keys=in_keys, o
+0003d340: 7574 5f6b 6579 733d 6f75 745f 6b65 7973  ut_keys=out_keys
+0003d350: 290d 0a20 2020 2020 2020 2069 6620 5420  )..        if T 
+0003d360: 3c20 313a 0d0a 2020 2020 2020 2020 2020  < 1:..          
+0003d370: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+0003d380: 6f72 280d 0a20 2020 2020 2020 2020 2020  or(..           
+0003d390: 2020 2020 2022 5469 6d65 4d61 7850 6f6f       "TimeMaxPoo
+0003d3a0: 6c54 7261 6e73 666f 726d 2054 2070 6172  lTransform T par
+0003d3b0: 616d 6574 6572 2073 686f 756c 6420 6861  ameter should ha
+0003d3c0: 7665 2061 2076 616c 7565 2067 7265 6174  ve a value great
+0003d3d0: 6572 206f 7220 6571 7561 6c20 746f 206f  er or equal to o
+0003d3e0: 6e65 2e22 0d0a 2020 2020 2020 2020 2020  ne."..          
+0003d3f0: 2020 290d 0a20 2020 2020 2020 2069 6620    )..        if 
+0003d400: 6c65 6e28 7365 6c66 2e69 6e5f 6b65 7973  len(self.in_keys
+0003d410: 2920 213d 206c 656e 2873 656c 662e 6f75  ) != len(self.ou
+0003d420: 745f 6b65 7973 293a 0d0a 2020 2020 2020  t_keys):..      
+0003d430: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+0003d440: 6545 7272 6f72 280d 0a20 2020 2020 2020  eError(..       
+0003d450: 2020 2020 2020 2020 2022 5469 6d65 4d61           "TimeMa
+0003d460: 7850 6f6f 6c54 7261 6e73 666f 726d 2069  xPoolTransform i
+0003d470: 6e5f 6b65 7973 2061 6e64 206f 7574 5f6b  n_keys and out_k
+0003d480: 6579 7320 646f 6e27 7420 6861 7665 2074  eys don't have t
+0003d490: 6865 2073 616d 6520 6e75 6d62 6572 206f  he same number o
+0003d4a0: 6620 656c 656d 656e 7473 220d 0a20 2020  f elements"..   
+0003d4b0: 2020 2020 2020 2020 2029 0d0a 2020 2020           )..    
+0003d4c0: 2020 2020 7365 6c66 2e62 7566 6665 725f      self.buffer_
+0003d4d0: 7369 7a65 203d 2054 0d0a 2020 2020 2020  size = T..      
+0003d4e0: 2020 666f 7220 696e 5f6b 6579 2069 6e20    for in_key in 
+0003d4f0: 7365 6c66 2e69 6e5f 6b65 7973 3a0d 0a20  self.in_keys:.. 
+0003d500: 2020 2020 2020 2020 2020 2062 7566 6665             buffe
+0003d510: 725f 6e61 6d65 203d 2073 656c 662e 5f62  r_name = self._b
+0003d520: 7566 6665 725f 6e61 6d65 2869 6e5f 6b65  uffer_name(in_ke
+0003d530: 7929 0d0a 2020 2020 2020 2020 2020 2020  y)..            
+0003d540: 7365 7461 7474 7228 0d0a 2020 2020 2020  setattr(..      
+0003d550: 2020 2020 2020 2020 2020 7365 6c66 2c0d            self,.
+0003d560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d570: 2062 7566 6665 725f 6e61 6d65 2c0d 0a20   buffer_name,.. 
+0003d580: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0003d590: 6f72 6368 2e6e 6e2e 7061 7261 6d65 7465  orch.nn.paramete
+0003d5a0: 722e 556e 696e 6974 6961 6c69 7a65 6442  r.UninitializedB
+0003d5b0: 7566 6665 7228 0d0a 2020 2020 2020 2020  uffer(..        
+0003d5c0: 2020 2020 2020 2020 2020 2020 6465 7669              devi
+0003d5d0: 6365 3d74 6f72 6368 2e64 6576 6963 6528  ce=torch.device(
+0003d5e0: 2263 7075 2229 2c20 6474 7970 653d 746f  "cpu"), dtype=to
+0003d5f0: 7263 682e 6765 745f 6465 6661 756c 745f  rch.get_default_
+0003d600: 6474 7970 6528 290d 0a20 2020 2020 2020  dtype()..       
+0003d610: 2020 2020 2020 2020 2029 2c0d 0a20 2020           ),..   
+0003d620: 2020 2020 2020 2020 2029 0d0a 2020 2020           )..    
+0003d630: 2020 2020 7365 6c66 2e72 6573 6574 5f6b      self.reset_k
+0003d640: 6579 203d 2072 6573 6574 5f6b 6579 0d0a  ey = reset_key..
+0003d650: 0d0a 2020 2020 4073 7461 7469 636d 6574  ..    @staticmet
+0003d660: 686f 640d 0a20 2020 2064 6566 205f 6275  hod..    def _bu
+0003d670: 6666 6572 5f6e 616d 6528 696e 5f6b 6579  ffer_name(in_key
+0003d680: 293a 0d0a 2020 2020 2020 2020 696e 5f6b  ):..        in_k
+0003d690: 6579 5f73 7472 203d 2022 5f22 2e6a 6f69  ey_str = "_".joi
+0003d6a0: 6e28 696e 5f6b 6579 2920 6966 2069 7369  n(in_key) if isi
+0003d6b0: 6e73 7461 6e63 6528 696e 5f6b 6579 2c20  nstance(in_key, 
+0003d6c0: 7475 706c 6529 2065 6c73 6520 696e 5f6b  tuple) else in_k
+0003d6d0: 6579 0d0a 2020 2020 2020 2020 6275 6666  ey..        buff
+0003d6e0: 6572 5f6e 616d 6520 3d20 6622 5f6d 6178  er_name = f"_max
+0003d6f0: 706f 6f6c 5f62 7566 6665 725f 7b69 6e5f  pool_buffer_{in_
+0003d700: 6b65 795f 7374 727d 220d 0a20 2020 2020  key_str}"..     
+0003d710: 2020 2072 6574 7572 6e20 6275 6666 6572     return buffer
+0003d720: 5f6e 616d 650d 0a0d 0a20 2020 2040 7072  _name....    @pr
+0003d730: 6f70 6572 7479 0d0a 2020 2020 6465 6620  operty..    def 
+0003d740: 7265 7365 745f 6b65 7928 7365 6c66 293a  reset_key(self):
+0003d750: 0d0a 2020 2020 2020 2020 7265 7365 745f  ..        reset_
+0003d760: 6b65 7920 3d20 7365 6c66 2e5f 5f64 6963  key = self.__dic
+0003d770: 745f 5f2e 6765 7428 225f 7265 7365 745f  t__.get("_reset_
+0003d780: 6b65 7922 2c20 4e6f 6e65 290d 0a20 2020  key", None)..   
+0003d790: 2020 2020 2069 6620 7265 7365 745f 6b65       if reset_ke
+0003d7a0: 7920 6973 204e 6f6e 653a 0d0a 2020 2020  y is None:..    
+0003d7b0: 2020 2020 2020 2020 7265 7365 745f 6b65          reset_ke
+0003d7c0: 7973 203d 2073 656c 662e 7061 7265 6e74  ys = self.parent
+0003d7d0: 2e72 6573 6574 5f6b 6579 730d 0a20 2020  .reset_keys..   
+0003d7e0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
+0003d7f0: 7265 7365 745f 6b65 7973 2920 3e20 313a  reset_keys) > 1:
+0003d800: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0003d810: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
+0003d820: 7272 6f72 280d 0a20 2020 2020 2020 2020  rror(..         
+0003d830: 2020 2020 2020 2020 2020 2066 2247 6f74             f"Got
+0003d840: 206d 6f72 6520 7468 616e 206f 6e65 2072   more than one r
+0003d850: 6573 6574 206b 6579 2069 6e20 656e 7620  eset key in env 
+0003d860: 7b73 656c 662e 636f 6e74 6169 6e65 727d  {self.container}
+0003d870: 2c20 6361 6e6e 6f74 2069 6e66 6572 2077  , cannot infer w
+0003d880: 6869 6368 206f 6e65 2074 6f20 7573 652e  hich one to use.
+0003d890: 2043 6f6e 7369 6465 7220 7072 6f76 6964   Consider provid
+0003d8a0: 696e 6720 7468 6520 7265 7365 7420 6b65  ing the reset ke
+0003d8b0: 7920 696e 2074 6865 207b 7479 7065 2873  y in the {type(s
+0003d8c0: 656c 6629 7d20 636f 6e73 7472 7563 746f  elf)} constructo
+0003d8d0: 722e 220d 0a20 2020 2020 2020 2020 2020  r."..           
+0003d8e0: 2020 2020 2029 0d0a 2020 2020 2020 2020       )..        
+0003d8f0: 2020 2020 7265 7365 745f 6b65 7920 3d20      reset_key = 
+0003d900: 7365 6c66 2e5f 7265 7365 745f 6b65 7920  self._reset_key 
+0003d910: 3d20 7265 7365 745f 6b65 7973 5b30 5d0d  = reset_keys[0].
+0003d920: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0003d930: 7265 7365 745f 6b65 790d 0a0d 0a20 2020  reset_key....   
+0003d940: 2040 7265 7365 745f 6b65 792e 7365 7474   @reset_key.sett
+0003d950: 6572 0d0a 2020 2020 6465 6620 7265 7365  er..    def rese
+0003d960: 745f 6b65 7928 7365 6c66 2c20 7661 6c75  t_key(self, valu
+0003d970: 6529 3a0d 0a20 2020 2020 2020 2073 656c  e):..        sel
+0003d980: 662e 5f72 6573 6574 5f6b 6579 203d 2076  f._reset_key = v
+0003d990: 616c 7565 0d0a 0d0a 2020 2020 6465 6620  alue....    def 
+0003d9a0: 5f72 6573 6574 280d 0a20 2020 2020 2020  _reset(..       
+0003d9b0: 2073 656c 662c 2074 656e 736f 7264 6963   self, tensordic
+0003d9c0: 743a 2054 656e 736f 7244 6963 7442 6173  t: TensorDictBas
+0003d9d0: 652c 2074 656e 736f 7264 6963 745f 7265  e, tensordict_re
+0003d9e0: 7365 743a 2054 656e 736f 7244 6963 7442  set: TensorDictB
+0003d9f0: 6173 650d 0a20 2020 2029 202d 3e20 5465  ase..    ) -> Te
+0003da00: 6e73 6f72 4469 6374 4261 7365 3a0d 0a0d  nsorDictBase:...
+0003da10: 0a20 2020 2020 2020 205f 7265 7365 7420  .        _reset 
+0003da20: 3d20 5f67 6574 5f72 6573 6574 2873 656c  = _get_reset(sel
+0003da30: 662e 7265 7365 745f 6b65 792c 2074 656e  f.reset_key, ten
+0003da40: 736f 7264 6963 7429 0d0a 2020 2020 2020  sordict)..      
+0003da50: 2020 666f 7220 696e 5f6b 6579 2069 6e20    for in_key in 
+0003da60: 7365 6c66 2e69 6e5f 6b65 7973 3a0d 0a20  self.in_keys:.. 
+0003da70: 2020 2020 2020 2020 2020 2062 7566 6665             buffe
+0003da80: 725f 6e61 6d65 203d 2073 656c 662e 5f62  r_name = self._b
+0003da90: 7566 6665 725f 6e61 6d65 2869 6e5f 6b65  uffer_name(in_ke
+0003daa0: 7929 0d0a 2020 2020 2020 2020 2020 2020  y)..            
+0003dab0: 6275 6666 6572 203d 2067 6574 6174 7472  buffer = getattr
+0003dac0: 2873 656c 662c 2062 7566 6665 725f 6e61  (self, buffer_na
+0003dad0: 6d65 290d 0a20 2020 2020 2020 2020 2020  me)..           
+0003dae0: 2069 6620 6973 696e 7374 616e 6365 2862   if isinstance(b
+0003daf0: 7566 6665 722c 2074 6f72 6368 2e6e 6e2e  uffer, torch.nn.
+0003db00: 7061 7261 6d65 7465 722e 556e 696e 6974  parameter.Uninit
+0003db10: 6961 6c69 7a65 6442 7566 6665 7229 3a0d  ializedBuffer):.
+0003db20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003db30: 2063 6f6e 7469 6e75 650d 0a20 2020 2020   continue..     
+0003db40: 2020 2020 2020 2069 6620 6e6f 7420 5f72         if not _r
+0003db50: 6573 6574 2e61 6c6c 2829 3a0d 0a20 2020  eset.all():..   
+0003db60: 2020 2020 2020 2020 2020 2020 205f 7265               _re
+0003db70: 7365 745f 6578 7020 3d20 5f72 6573 6574  set_exp = _reset
+0003db80: 2e65 7870 616e 6428 6275 6666 6572 2e73  .expand(buffer.s
+0003db90: 6861 7065 5b30 5d2c 202a 5f72 6573 6574  hape[0], *_reset
+0003dba0: 2e73 6861 7065 290d 0a20 2020 2020 2020  .shape)..       
+0003dbb0: 2020 2020 2020 2020 2062 7566 6665 725b           buffer[
+0003dbc0: 5f72 6573 6574 5f65 7870 5d20 3d20 302e  _reset_exp] = 0.
+0003dbd0: 300d 0a20 2020 2020 2020 2020 2020 2065  0..            e
+0003dbe0: 6c73 653a 0d0a 2020 2020 2020 2020 2020  lse:..          
+0003dbf0: 2020 2020 2020 6275 6666 6572 2e66 696c        buffer.fil
+0003dc00: 6c5f 2830 2e30 290d 0a20 2020 2020 2020  l_(0.0)..       
+0003dc10: 2077 6974 6820 5f73 6574 5f6d 6973 7369   with _set_missi
+0003dc20: 6e67 5f74 6f6c 6572 616e 6365 2873 656c  ng_tolerance(sel
+0003dc30: 662c 2054 7275 6529 3a0d 0a20 2020 2020  f, True):..     
+0003dc40: 2020 2020 2020 2066 6f72 2069 6e5f 6b65         for in_ke
+0003dc50: 7920 696e 2073 656c 662e 696e 5f6b 6579  y in self.in_key
+0003dc60: 733a 0d0a 2020 2020 2020 2020 2020 2020  s:..            
+0003dc70: 2020 2020 7661 6c5f 7265 7365 7420 3d20      val_reset = 
+0003dc80: 7465 6e73 6f72 6469 6374 5f72 6573 6574  tensordict_reset
+0003dc90: 2e67 6574 2869 6e5f 6b65 792c 204e 6f6e  .get(in_key, Non
+0003dca0: 6529 0d0a 2020 2020 2020 2020 2020 2020  e)..            
+0003dcb0: 2020 2020 7661 6c5f 7072 6576 203d 2074      val_prev = t
+0003dcc0: 656e 736f 7264 6963 742e 6765 7428 696e  ensordict.get(in
+0003dcd0: 5f6b 6579 2c20 4e6f 6e65 290d 0a20 2020  _key, None)..   
+0003dce0: 2020 2020 2020 2020 2020 2020 2023 2069               # i
+0003dcf0: 6620 616e 2069 6e5f 6b65 7920 6973 206d  f an in_key is m
+0003dd00: 6973 7369 6e67 2c20 7765 2074 7279 2074  issing, we try t
+0003dd10: 6f20 636f 7079 2069 7420 6672 6f6d 2074  o copy it from t
+0003dd20: 6865 2070 7265 7669 6f75 7320 7374 6570  he previous step
+0003dd30: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0003dd40: 2020 6966 2076 616c 5f72 6573 6574 2069    if val_reset i
+0003dd50: 7320 4e6f 6e65 2061 6e64 2076 616c 5f70  s None and val_p
+0003dd60: 7265 7620 6973 206e 6f74 204e 6f6e 653a  rev is not None:
+0003dd70: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0003dd80: 2020 2020 2020 7465 6e73 6f72 6469 6374        tensordict
+0003dd90: 5f72 6573 6574 2e73 6574 2869 6e5f 6b65  _reset.set(in_ke
+0003dda0: 792c 2076 616c 5f70 7265 7629 0d0a 2020  y, val_prev)..  
+0003ddb0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0003ddc0: 6966 2076 616c 5f70 7265 7620 6973 204e  if val_prev is N
+0003ddd0: 6f6e 6520 616e 6420 7661 6c5f 7265 7365  one and val_rese
+0003dde0: 7420 6973 204e 6f6e 653a 0d0a 2020 2020  t is None:..    
+0003ddf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003de00: 7261 6973 6520 4b65 7945 7272 6f72 2866  raise KeyError(f
+0003de10: 2243 6f75 6c64 206e 6f74 2066 696e 6420  "Could not find 
+0003de20: 7b69 6e5f 6b65 797d 2069 6e20 7468 6520  {in_key} in the 
+0003de30: 7265 7365 7420 6461 7461 2e22 290d 0a20  reset data.").. 
+0003de40: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0003de50: 6e20 7365 6c66 2e5f 6361 6c6c 2874 656e  n self._call(ten
+0003de60: 736f 7264 6963 745f 7265 7365 742c 205f  sordict_reset, _
+0003de70: 7265 7365 743d 5f72 6573 6574 290d 0a0d  reset=_reset)...
+0003de80: 0a20 2020 2064 6566 205f 6d61 6b65 5f6d  .    def _make_m
+0003de90: 6973 7369 6e67 5f62 7566 6665 7228 7365  issing_buffer(se
+0003dea0: 6c66 2c20 7465 6e73 6f72 6469 6374 2c20  lf, tensordict, 
+0003deb0: 696e 5f6b 6579 2c20 6275 6666 6572 5f6e  in_key, buffer_n
+0003dec0: 616d 6529 3a0d 0a20 2020 2020 2020 2062  ame):..        b
+0003ded0: 7566 6665 7220 3d20 6765 7461 7474 7228  uffer = getattr(
+0003dee0: 7365 6c66 2c20 6275 6666 6572 5f6e 616d  self, buffer_nam
+0003def0: 6529 0d0a 2020 2020 2020 2020 6461 7461  e)..        data
+0003df00: 203d 2074 656e 736f 7264 6963 742e 6765   = tensordict.ge
+0003df10: 7428 696e 5f6b 6579 290d 0a20 2020 2020  t(in_key)..     
+0003df20: 2020 2073 697a 6520 3d20 6c69 7374 2864     size = list(d
+0003df30: 6174 612e 7368 6170 6529 0d0a 2020 2020  ata.shape)..    
+0003df40: 2020 2020 7369 7a65 2e69 6e73 6572 7428      size.insert(
+0003df50: 302c 2073 656c 662e 6275 6666 6572 5f73  0, self.buffer_s
+0003df60: 697a 6529 0d0a 2020 2020 2020 2020 6275  ize)..        bu
+0003df70: 6666 6572 2e6d 6174 6572 6961 6c69 7a65  ffer.materialize
+0003df80: 2873 697a 6529 0d0a 2020 2020 2020 2020  (size)..        
+0003df90: 6275 6666 6572 203d 2062 7566 6665 722e  buffer = buffer.
+0003dfa0: 746f 2864 7479 7065 3d64 6174 612e 6474  to(dtype=data.dt
+0003dfb0: 7970 652c 2064 6576 6963 653d 6461 7461  ype, device=data
+0003dfc0: 2e64 6576 6963 6529 2e7a 6572 6f5f 2829  .device).zero_()
+0003dfd0: 0d0a 2020 2020 2020 2020 7365 7461 7474  ..        setatt
+0003dfe0: 7228 7365 6c66 2c20 6275 6666 6572 5f6e  r(self, buffer_n
+0003dff0: 616d 652c 2062 7566 6665 7229 0d0a 2020  ame, buffer)..  
+0003e000: 2020 2020 2020 7265 7475 726e 2062 7566        return buf
+0003e010: 6665 720d 0a0d 0a20 2020 2064 6566 205f  fer....    def _
+0003e020: 6361 6c6c 2873 656c 662c 2074 656e 736f  call(self, tenso
+0003e030: 7264 6963 743a 2054 656e 736f 7244 6963  rdict: TensorDic
+0003e040: 7442 6173 652c 205f 7265 7365 743d 4e6f  tBase, _reset=No
+0003e050: 6e65 2920 2d3e 2054 656e 736f 7244 6963  ne) -> TensorDic
+0003e060: 7442 6173 653a 0d0a 2020 2020 2020 2020  tBase:..        
+0003e070: 2222 2255 7064 6174 6520 7468 6520 6570  """Update the ep
+0003e080: 6973 6f64 6520 7465 6e73 6f72 6469 6374  isode tensordict
+0003e090: 2077 6974 6820 6d61 7820 706f 6f6c 6564   with max pooled
+0003e0a0: 206b 6579 732e 2222 220d 0a20 2020 2020   keys."""..     
+0003e0b0: 2020 2066 6f72 2069 6e5f 6b65 792c 206f     for in_key, o
+0003e0c0: 7574 5f6b 6579 2069 6e20 7a69 7028 7365  ut_key in zip(se
+0003e0d0: 6c66 2e69 6e5f 6b65 7973 2c20 7365 6c66  lf.in_keys, self
+0003e0e0: 2e6f 7574 5f6b 6579 7329 3a0d 0a20 2020  .out_keys):..   
+0003e0f0: 2020 2020 2020 2020 2023 204c 617a 7920           # Lazy 
+0003e100: 696e 6974 206f 6620 6275 6666 6572 730d  init of buffers.
+0003e110: 0a20 2020 2020 2020 2020 2020 2062 7566  .            buf
+0003e120: 6665 725f 6e61 6d65 203d 2073 656c 662e  fer_name = self.
+0003e130: 5f62 7566 6665 725f 6e61 6d65 2869 6e5f  _buffer_name(in_
+0003e140: 6b65 7929 0d0a 2020 2020 2020 2020 2020  key)..          
+0003e150: 2020 6275 6666 6572 203d 2067 6574 6174    buffer = getat
+0003e160: 7472 2873 656c 662c 2062 7566 6665 725f  tr(self, buffer_
+0003e170: 6e61 6d65 290d 0a20 2020 2020 2020 2020  name)..         
+0003e180: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+0003e190: 2862 7566 6665 722c 2074 6f72 6368 2e6e  (buffer, torch.n
+0003e1a0: 6e2e 7061 7261 6d65 7465 722e 556e 696e  n.parameter.Unin
+0003e1b0: 6974 6961 6c69 7a65 6442 7566 6665 7229  itializedBuffer)
+0003e1c0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+0003e1d0: 2020 2062 7566 6665 7220 3d20 7365 6c66     buffer = self
+0003e1e0: 2e5f 6d61 6b65 5f6d 6973 7369 6e67 5f62  ._make_missing_b
+0003e1f0: 7566 6665 7228 7465 6e73 6f72 6469 6374  uffer(tensordict
+0003e200: 2c20 696e 5f6b 6579 2c20 6275 6666 6572  , in_key, buffer
+0003e210: 5f6e 616d 6529 0d0a 2020 2020 2020 2020  _name)..        
+0003e220: 2020 2020 6966 205f 7265 7365 7420 6973      if _reset is
+0003e230: 206e 6f74 204e 6f6e 653a 0d0a 2020 2020   not None:..    
+0003e240: 2020 2020 2020 2020 2020 2020 2320 7765              # we
+0003e250: 206d 7573 7420 7573 6520 6f6e 6c79 2074   must use only t
+0003e260: 6865 2072 6573 6574 2064 6174 610d 0a20  he reset data.. 
+0003e270: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0003e280: 7566 6665 725b 3a2c 205f 7265 7365 745d  uffer[:, _reset]
+0003e290: 203d 2074 6f72 6368 2e72 6f6c 6c28 6275   = torch.roll(bu
+0003e2a0: 6666 6572 5b3a 2c20 5f72 6573 6574 5d2c  ffer[:, _reset],
+0003e2b0: 2073 6869 6674 733d 312c 2064 696d 733d   shifts=1, dims=
+0003e2c0: 3029 0d0a 2020 2020 2020 2020 2020 2020  0)..            
+0003e2d0: 2020 2020 2320 6164 6420 6e65 7720 6f62      # add new ob
+0003e2e0: 730d 0a20 2020 2020 2020 2020 2020 2020  s..             
+0003e2f0: 2020 2064 6174 6120 3d20 7465 6e73 6f72     data = tensor
+0003e300: 6469 6374 2e67 6574 2869 6e5f 6b65 7929  dict.get(in_key)
+0003e310: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0003e320: 2020 6275 6666 6572 5b30 2c20 5f72 6573    buffer[0, _res
+0003e330: 6574 5d20 3d20 6461 7461 5b5f 7265 7365  et] = data[_rese
+0003e340: 745d 0d0a 2020 2020 2020 2020 2020 2020  t]..            
+0003e350: 2020 2020 2320 6170 706c 7920 6d61 7820      # apply max 
+0003e360: 706f 6f6c 696e 670d 0a20 2020 2020 2020  pooling..       
+0003e370: 2020 2020 2020 2020 2070 6f6f 6c65 645f           pooled_
+0003e380: 7465 6e73 6f72 2c20 5f20 3d20 6275 6666  tensor, _ = buff
+0003e390: 6572 5b3a 2c20 5f72 6573 6574 5d2e 6d61  er[:, _reset].ma
+0003e3a0: 7828 6469 6d3d 3029 0d0a 2020 2020 2020  x(dim=0)..      
+0003e3b0: 2020 2020 2020 2020 2020 706f 6f6c 6564            pooled
+0003e3c0: 5f74 656e 736f 7220 3d20 746f 7263 682e  _tensor = torch.
+0003e3d0: 7a65 726f 735f 6c69 6b65 2864 6174 6129  zeros_like(data)
+0003e3e0: 2e6d 6173 6b65 645f 7363 6174 7465 725f  .masked_scatter_
+0003e3f0: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
+0003e400: 2020 2020 2020 2065 7870 616e 645f 6173         expand_as
+0003e410: 5f72 6967 6874 285f 7265 7365 742c 2064  _right(_reset, d
+0003e420: 6174 6129 2c20 706f 6f6c 6564 5f74 656e  ata), pooled_ten
+0003e430: 736f 720d 0a20 2020 2020 2020 2020 2020  sor..           
+0003e440: 2020 2020 2029 0d0a 2020 2020 2020 2020       )..        
+0003e450: 2020 2020 2020 2020 2320 6164 6420 746f          # add to
+0003e460: 2074 656e 736f 7264 6963 740d 0a20 2020   tensordict..   
+0003e470: 2020 2020 2020 2020 2020 2020 2074 656e               ten
+0003e480: 736f 7264 6963 742e 7365 7428 6f75 745f  sordict.set(out_
+0003e490: 6b65 792c 2070 6f6f 6c65 645f 7465 6e73  key, pooled_tens
+0003e4a0: 6f72 290d 0a20 2020 2020 2020 2020 2020  or)..           
+0003e4b0: 2020 2020 2063 6f6e 7469 6e75 650d 0a20       continue.. 
+0003e4c0: 2020 2020 2020 2020 2020 2023 2073 6869             # shi
+0003e4d0: 6674 206f 6273 2031 2070 6f73 6974 696f  ft obs 1 positio
+0003e4e0: 6e20 746f 2074 6865 2072 6967 6874 0d0a  n to the right..
+0003e4f0: 2020 2020 2020 2020 2020 2020 6275 6666              buff
+0003e500: 6572 2e63 6f70 795f 2874 6f72 6368 2e72  er.copy_(torch.r
+0003e510: 6f6c 6c28 6275 6666 6572 2c20 7368 6966  oll(buffer, shif
+0003e520: 7473 3d31 2c20 6469 6d73 3d30 2929 0d0a  ts=1, dims=0))..
+0003e530: 2020 2020 2020 2020 2020 2020 2320 6164              # ad
+0003e540: 6420 6e65 7720 6f62 730d 0a20 2020 2020  d new obs..     
+0003e550: 2020 2020 2020 2062 7566 6665 725b 305d         buffer[0]
+0003e560: 2e63 6f70 795f 2874 656e 736f 7264 6963  .copy_(tensordic
+0003e570: 742e 6765 7428 696e 5f6b 6579 2929 0d0a  t.get(in_key))..
+0003e580: 2020 2020 2020 2020 2020 2020 2320 6170              # ap
+0003e590: 706c 7920 6d61 7820 706f 6f6c 696e 670d  ply max pooling.
+0003e5a0: 0a20 2020 2020 2020 2020 2020 2070 6f6f  .            poo
+0003e5b0: 6c65 645f 7465 6e73 6f72 2c20 5f20 3d20  led_tensor, _ = 
+0003e5c0: 6275 6666 6572 2e6d 6178 2864 696d 3d30  buffer.max(dim=0
+0003e5d0: 290d 0a20 2020 2020 2020 2020 2020 2023  )..            #
+0003e5e0: 2061 6464 2074 6f20 7465 6e73 6f72 6469   add to tensordi
+0003e5f0: 6374 0d0a 2020 2020 2020 2020 2020 2020  ct..            
+0003e600: 7465 6e73 6f72 6469 6374 2e73 6574 286f  tensordict.set(o
+0003e610: 7574 5f6b 6579 2c20 706f 6f6c 6564 5f74  ut_key, pooled_t
+0003e620: 656e 736f 7229 0d0a 0d0a 2020 2020 2020  ensor)....      
+0003e630: 2020 7265 7475 726e 2074 656e 736f 7264    return tensord
+0003e640: 6963 740d 0a0d 0a20 2020 2040 5f61 7070  ict....    @_app
+0003e650: 6c79 5f74 6f5f 636f 6d70 6f73 6974 650d  ly_to_composite.
+0003e660: 0a20 2020 2064 6566 2074 7261 6e73 666f  .    def transfo
+0003e670: 726d 5f6f 6273 6572 7661 7469 6f6e 5f73  rm_observation_s
+0003e680: 7065 6328 7365 6c66 2c20 6f62 7365 7276  pec(self, observ
+0003e690: 6174 696f 6e5f 7370 6563 3a20 5465 6e73  ation_spec: Tens
+0003e6a0: 6f72 5370 6563 2920 2d3e 2054 656e 736f  orSpec) -> Tenso
+0003e6b0: 7253 7065 633a 0d0a 2020 2020 2020 2020  rSpec:..        
+0003e6c0: 7265 7475 726e 206f 6273 6572 7661 7469  return observati
+0003e6d0: 6f6e 5f73 7065 630d 0a0d 0a20 2020 2064  on_spec....    d
+0003e6e0: 6566 2066 6f72 7761 7264 2873 656c 662c  ef forward(self,
+0003e6f0: 2074 656e 736f 7264 6963 743a 2054 656e   tensordict: Ten
+0003e700: 736f 7244 6963 7442 6173 6529 202d 3e20  sorDictBase) -> 
+0003e710: 5465 6e73 6f72 4469 6374 4261 7365 3a0d  TensorDictBase:.
+0003e720: 0a20 2020 2020 2020 2072 6169 7365 204e  .        raise N
+0003e730: 6f74 496d 706c 656d 656e 7465 6445 7272  otImplementedErr
+0003e740: 6f72 280d 0a20 2020 2020 2020 2020 2020  or(..           
+0003e750: 2022 5469 6d65 4d61 7850 6f6f 6c20 6361   "TimeMaxPool ca
+0003e760: 6e6e 6f74 2062 6520 6361 6c6c 6564 2069  nnot be called i
+0003e770: 6e64 6570 656e 6465 6e74 6c79 2c20 6f6e  ndependently, on
+0003e780: 6c79 2069 7473 2073 7465 7020 616e 6420  ly its step and 
+0003e790: 7265 7365 7420 6d65 7468 6f64 7320 220d  reset methods ".
+0003e7a0: 0a20 2020 2020 2020 2020 2020 2022 6172  .            "ar
+0003e7b0: 6520 6675 6e63 7469 6f6e 616c 2e20 5468  e functional. Th
+0003e7c0: 6520 7265 6173 6f6e 2066 6f72 2074 6869  e reason for thi
+0003e7d0: 7320 6973 2074 6861 7420 6974 2069 7320  s is that it is 
+0003e7e0: 6861 7264 2074 6f20 636f 6e73 6964 6572  hard to consider
+0003e7f0: 2075 7369 6e67 2022 0d0a 2020 2020 2020   using "..      
+0003e800: 2020 2020 2020 2254 696d 654d 6178 506f        "TimeMaxPo
+0003e810: 6f6c 2077 6974 6820 6e6f 6e2d 7365 7175  ol with non-sequ
+0003e820: 656e 7469 616c 2064 6174 612c 2073 7563  ential data, suc
+0003e830: 6820 6173 2074 686f 7365 2063 6f6c 6c65  h as those colle
+0003e840: 6374 6564 2062 7920 6120 7265 706c 6179  cted by a replay
+0003e850: 2062 7566 6665 7220 220d 0a20 2020 2020   buffer "..     
+0003e860: 2020 2020 2020 2022 6f72 2061 2064 6174         "or a dat
+0003e870: 6173 6574 2e20 4966 2079 6f75 206e 6565  aset. If you nee
+0003e880: 6420 5469 6d65 4d61 7850 6f6f 6c20 746f  d TimeMaxPool to
+0003e890: 2077 6f72 6b20 6f6e 2061 2062 6174 6368   work on a batch
+0003e8a0: 206f 6620 7365 7175 656e 7469 616c 2064   of sequential d
+0003e8b0: 6174 6120 220d 0a20 2020 2020 2020 2020  ata "..         
+0003e8c0: 2020 2022 2869 6520 6173 204c 5354 4d20     "(ie as LSTM 
+0003e8d0: 776f 756c 6420 776f 726b 206f 7665 7220  would work over 
+0003e8e0: 6120 7768 6f6c 6520 7365 7175 656e 6365  a whole sequence
+0003e8f0: 206f 6620 6461 7461 292c 2066 696c 6520   of data), file 
+0003e900: 616e 2069 7373 7565 206f 6e20 220d 0a20  an issue on ".. 
+0003e910: 2020 2020 2020 2020 2020 2022 546f 7263             "Torc
+0003e920: 6852 4c20 7265 7175 6573 7469 6e67 2074  hRL requesting t
+0003e930: 6861 7420 6665 6174 7572 652e 220d 0a20  hat feature.".. 
+0003e940: 2020 2020 2020 2029 0d0a 0d0a 0d0a 636c         )......cl
+0003e950: 6173 7320 5261 6e64 6f6d 4372 6f70 5465  ass RandomCropTe
+0003e960: 6e73 6f72 4469 6374 2854 7261 6e73 666f  nsorDict(Transfo
+0003e970: 726d 293a 0d0a 2020 2020 2222 2241 2074  rm):..    """A t
+0003e980: 7261 6a65 6374 6f72 7920 7375 622d 7361  rajectory sub-sa
+0003e990: 6d70 6c65 7220 666f 7220 5265 706c 6179  mpler for Replay
+0003e9a0: 4275 6666 6572 2061 6e64 206d 6f64 756c  Buffer and modul
+0003e9b0: 6573 2e0d 0a0d 0a20 2020 2047 6174 6865  es.....    Gathe
+0003e9c0: 7273 2061 2073 7562 2d73 6571 7565 6e63  rs a sub-sequenc
+0003e9d0: 6520 6f66 2061 2064 6566 696e 6564 206c  e of a defined l
+0003e9e0: 656e 6774 6820 616c 6f6e 6720 7468 6520  ength along the 
+0003e9f0: 6c61 7374 2064 696d 656e 7369 6f6e 206f  last dimension o
+0003ea00: 6620 7468 6520 696e 7075 740d 0a20 2020  f the input..   
+0003ea10: 2074 656e 736f 7264 6963 742e 0d0a 2020   tensordict...  
+0003ea20: 2020 5468 6973 2063 616e 2062 6520 7573    This can be us
+0003ea30: 6564 2074 6f20 6765 7420 6372 6f70 7065  ed to get croppe
+0003ea40: 6420 7472 616a 6563 746f 7269 6573 2066  d trajectories f
+0003ea50: 726f 6d20 7472 616a 6563 746f 7269 6573  rom trajectories
+0003ea60: 2073 616d 706c 6564 0d0a 2020 2020 6672   sampled..    fr
+0003ea70: 6f6d 2061 2052 6570 6c61 7942 7566 6665  om a ReplayBuffe
+0003ea80: 722e 0d0a 0d0a 2020 2020 5468 6973 2074  r.....    This t
+0003ea90: 7261 6e73 666f 726d 2069 7320 7072 696d  ransform is prim
+0003eaa0: 6172 696c 7920 6465 7369 676e 6564 2074  arily designed t
+0003eab0: 6f20 6265 2075 7365 6420 7769 7468 2072  o be used with r
+0003eac0: 6570 6c61 7920 6275 6666 6572 7320 616e  eplay buffers an
+0003ead0: 6420 6d6f 6475 6c65 732e 0d0a 2020 2020  d modules...    
+0003eae0: 4375 7272 656e 746c 792c 2069 7420 6361  Currently, it ca
+0003eaf0: 6e6e 6f74 2062 6520 7573 6564 2061 7320  nnot be used as 
+0003eb00: 616e 2065 6e76 6972 6f6e 6d65 6e74 2074  an environment t
+0003eb10: 7261 6e73 666f 726d 2e0d 0a20 2020 2044  ransform...    D
+0003eb20: 6f20 6e6f 7420 6865 7369 7461 7465 2074  o not hesitate t
+0003eb30: 6f20 7265 7175 6573 7420 666f 7220 7468  o request for th
+0003eb40: 6973 2062 6568 6176 696f 7572 2074 6872  is behaviour thr
+0003eb50: 6f75 6768 2061 6e20 6973 7375 6520 6966  ough an issue if
+0003eb60: 2074 6869 7320 6973 0d0a 2020 2020 6465   this is..    de
+0003eb70: 7369 7265 642e 0d0a 0d0a 2020 2020 4172  sired.....    Ar
+0003eb80: 6773 3a0d 0a20 2020 2020 2020 2073 7562  gs:..        sub
+0003eb90: 5f73 6571 5f6c 656e 2028 696e 7429 3a20  _seq_len (int): 
+0003eba0: 7468 6520 6c65 6e67 7468 206f 6620 7468  the length of th
+0003ebb0: 6520 7375 622d 7472 616a 6563 746f 7279  e sub-trajectory
+0003ebc0: 2074 6f20 7361 6d70 6c65 0d0a 2020 2020   to sample..    
+0003ebd0: 2020 2020 7361 6d70 6c65 5f64 696d 2028      sample_dim (
+0003ebe0: 696e 742c 206f 7074 696f 6e61 6c29 3a20  int, optional): 
+0003ebf0: 7468 6520 6469 6d65 6e73 696f 6e20 616c  the dimension al
+0003ec00: 6f6e 6720 7768 6963 6820 7468 6520 6372  ong which the cr
+0003ec10: 6f70 7069 6e67 0d0a 2020 2020 2020 2020  opping..        
+0003ec20: 2020 2020 7368 6f75 6c64 206f 6363 7572      should occur
+0003ec30: 2e20 4e65 6761 7469 7665 2064 696d 656e  . Negative dimen
+0003ec40: 7369 6f6e 7320 7368 6f75 6c64 2062 6520  sions should be 
+0003ec50: 7072 6566 6572 7265 6420 746f 206d 616b  preferred to mak
+0003ec60: 650d 0a20 2020 2020 2020 2020 2020 2074  e..            t
+0003ec70: 6865 2074 7261 6e73 666f 726d 2072 6f62  he transform rob
+0003ec80: 7573 7420 746f 2074 656e 736f 7264 6963  ust to tensordic
+0003ec90: 7473 206f 6620 7661 7279 696e 6720 6261  ts of varying ba
+0003eca0: 7463 6820 6469 6d65 6e73 696f 6e73 2e0d  tch dimensions..
+0003ecb0: 0a20 2020 2020 2020 2020 2020 2044 6566  .            Def
+0003ecc0: 6175 6c74 7320 746f 202d 3120 2874 6865  aults to -1 (the
+0003ecd0: 2064 6566 6175 6c74 2074 696d 6520 6469   default time di
+0003ece0: 6d65 6e73 696f 6e20 696e 2054 6f72 6368  mension in Torch
+0003ecf0: 524c 292e 0d0a 2020 2020 2020 2020 6d61  RL)...        ma
+0003ed00: 736b 5f6b 6579 2028 4e65 7374 6564 4b65  sk_key (NestedKe
+0003ed10: 7929 3a20 4966 2070 726f 7669 6465 642c  y): If provided,
+0003ed20: 2074 6869 7320 7265 7072 6573 656e 7473   this represents
+0003ed30: 2074 6865 206d 6173 6b20 6b65 7920 746f   the mask key to
+0003ed40: 2062 6520 6c6f 6f6b 6564 0d0a 2020 2020   be looked..    
+0003ed50: 2020 2020 2020 2020 666f 7220 7768 656e          for when
+0003ed60: 2064 6f69 6e67 2074 6865 2073 616d 706c   doing the sampl
+0003ed70: 696e 672e 2049 6620 7072 6f76 6964 6564  ing. If provided
+0003ed80: 2c20 6974 206f 6e6c 7920 7661 6c69 6420  , it only valid 
+0003ed90: 656c 656d 656e 7473 2077 696c 6c0d 0a20  elements will.. 
+0003eda0: 2020 2020 2020 2020 2020 2062 6520 7265             be re
+0003edb0: 7475 726e 6564 2e20 4974 2069 7320 6173  turned. It is as
+0003edc0: 7375 6d65 6420 7468 6174 2074 6865 206d  sumed that the m
+0003edd0: 6173 6b20 6973 2061 2062 6f6f 6c65 616e  ask is a boolean
+0003ede0: 2074 656e 736f 7220 7769 7468 0d0a 2020   tensor with..  
+0003edf0: 2020 2020 2020 2020 2020 6669 7273 7420            first 
+0003ee00: 5472 7565 2076 616c 7565 7320 616e 6420  True values and 
+0003ee10: 7468 656e 2046 616c 7365 2076 616c 7565  then False value
+0003ee20: 732c 206e 6f74 206d 6978 6564 2074 6f67  s, not mixed tog
+0003ee30: 6574 6865 722e 0d0a 2020 2020 2020 2020  ether...        
+0003ee40: 2020 2020 3a63 6c61 7373 3a60 5261 6e64      :class:`Rand
+0003ee50: 6f6d 4372 6f70 5465 6e73 6f72 4469 6374  omCropTensorDict
+0003ee60: 6020 7769 6c6c 204e 4f54 2063 6865 636b  ` will NOT check
+0003ee70: 2074 6861 7420 7468 6973 2069 7320 7265   that this is re
+0003ee80: 7370 6563 7465 640d 0a20 2020 2020 2020  spected..       
+0003ee90: 2020 2020 2068 656e 6365 2061 6e79 2065       hence any e
+0003eea0: 7272 6f72 2063 6175 7365 6420 6279 2061  rror caused by a
+0003eeb0: 6e20 696d 7072 6f70 6572 206d 6173 6b20  n improper mask 
+0003eec0: 7269 736b 7320 746f 2067 6f20 756e 6e6f  risks to go unno
+0003eed0: 7469 6365 642e 0d0a 2020 2020 2020 2020  ticed...        
+0003eee0: 2020 2020 4465 6661 756c 7473 3a20 4e6f      Defaults: No
+0003eef0: 6e65 2028 6e6f 206d 6173 6b20 6b65 7929  ne (no mask key)
+0003ef00: 2e0d 0a20 2020 2022 2222 0d0a 0d0a 2020  ...    """....  
+0003ef10: 2020 6465 6620 5f5f 696e 6974 5f5f 280d    def __init__(.
+0003ef20: 0a20 2020 2020 2020 2073 656c 662c 0d0a  .        self,..
+0003ef30: 2020 2020 2020 2020 7375 625f 7365 715f          sub_seq_
+0003ef40: 6c65 6e3a 2069 6e74 2c0d 0a20 2020 2020  len: int,..     
+0003ef50: 2020 2073 616d 706c 655f 6469 6d3a 2069     sample_dim: i
+0003ef60: 6e74 203d 202d 312c 0d0a 2020 2020 2020  nt = -1,..      
+0003ef70: 2020 6d61 736b 5f6b 6579 3a20 4f70 7469    mask_key: Opti
+0003ef80: 6f6e 616c 5b4e 6573 7465 644b 6579 5d20  onal[NestedKey] 
+0003ef90: 3d20 4e6f 6e65 2c0d 0a20 2020 2029 3a0d  = None,..    ):.
+0003efa0: 0a20 2020 2020 2020 2073 656c 662e 7375  .        self.su
+0003efb0: 625f 7365 715f 6c65 6e20 3d20 7375 625f  b_seq_len = sub_
+0003efc0: 7365 715f 6c65 6e0d 0a20 2020 2020 2020  seq_len..       
+0003efd0: 2069 6620 7361 6d70 6c65 5f64 696d 203e   if sample_dim >
+0003efe0: 2030 3a0d 0a20 2020 2020 2020 2020 2020   0:..           
+0003eff0: 2077 6172 6e69 6e67 732e 7761 726e 280d   warnings.warn(.
+0003f000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f010: 2022 4120 706f 7369 7469 7665 2073 6861   "A positive sha
+0003f020: 7065 2068 6173 2062 6565 6e20 7061 7373  pe has been pass
+0003f030: 6564 2074 6f20 7468 6520 5261 6e64 6f6d  ed to the Random
+0003f040: 4372 6f70 5465 6e73 6f72 4469 6374 2022  CropTensorDict "
+0003f050: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0003f060: 2020 2263 6f6e 7374 7275 6374 6f72 2e20    "constructor. 
+0003f070: 5468 6973 206d 6179 2068 6176 6520 756e  This may have un
+0003f080: 6578 7065 6374 6564 2062 6568 6176 696f  expected behavio
+0003f090: 7572 7320 7768 656e 2074 6865 2022 0d0a  urs when the "..
+0003f0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f0b0: 2270 6173 7365 6420 7465 6e73 6f72 6469  "passed tensordi
+0003f0c0: 6374 7320 6861 7665 2069 6e63 6f6e 7369  cts have inconsi
+0003f0d0: 7374 656e 7420 6261 7463 6820 6469 6d65  stent batch dime
+0003f0e0: 6e73 696f 6e73 2e20 220d 0a20 2020 2020  nsions. "..     
+0003f0f0: 2020 2020 2020 2020 2020 2022 466f 7220             "For 
+0003f100: 636f 6e74 6578 742c 2062 7920 636f 6e76  context, by conv
+0003f110: 656e 7469 6f6e 2c20 546f 7263 6852 4c20  ention, TorchRL 
+0003f120: 636f 6e63 6174 656e 6174 6573 2074 696d  concatenates tim
+0003f130: 6520 7374 6570 7320 220d 0a20 2020 2020  e steps "..     
+0003f140: 2020 2020 2020 2020 2020 2022 616c 6f6e             "alon
+0003f150: 6720 7468 6520 6c61 7374 2064 696d 656e  g the last dimen
+0003f160: 7369 6f6e 206f 6620 7468 6520 7465 6e73  sion of the tens
+0003f170: 6f72 6469 6374 2e22 0d0a 2020 2020 2020  ordict."..      
+0003f180: 2020 2020 2020 290d 0a20 2020 2020 2020        )..       
+0003f190: 2073 656c 662e 7361 6d70 6c65 5f64 696d   self.sample_dim
+0003f1a0: 203d 2073 616d 706c 655f 6469 6d0d 0a20   = sample_dim.. 
+0003f1b0: 2020 2020 2020 2073 656c 662e 6d61 736b         self.mask
+0003f1c0: 5f6b 6579 203d 206d 6173 6b5f 6b65 790d  _key = mask_key.
+0003f1d0: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
+0003f1e0: 2e5f 5f69 6e69 745f 5f28 290d 0a0d 0a20  .__init__().... 
+0003f1f0: 2020 2064 6566 2066 6f72 7761 7264 2873     def forward(s
+0003f200: 656c 662c 2074 656e 736f 7264 6963 743a  elf, tensordict:
+0003f210: 2054 656e 736f 7244 6963 7442 6173 6529   TensorDictBase)
+0003f220: 202d 3e20 5465 6e73 6f72 4469 6374 4261   -> TensorDictBa
+0003f230: 7365 3a0d 0a20 2020 2020 2020 2073 6861  se:..        sha
+0003f240: 7065 203d 2074 656e 736f 7264 6963 742e  pe = tensordict.
+0003f250: 7368 6170 650d 0a20 2020 2020 2020 2064  shape..        d
+0003f260: 696d 203d 2073 656c 662e 7361 6d70 6c65  im = self.sample
+0003f270: 5f64 696d 0d0a 2020 2020 2020 2020 2320  _dim..        # 
+0003f280: 7368 6170 6520 6d75 7374 2068 6176 6520  shape must have 
+0003f290: 6174 206c 6561 7374 206f 6e65 2064 696d  at least one dim
+0003f2a0: 656e 7369 6f6e 0d0a 2020 2020 2020 2020  ension..        
+0003f2b0: 6966 206e 6f74 206c 656e 2873 6861 7065  if not len(shape
+0003f2c0: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
+0003f2d0: 7261 6973 6520 5275 6e74 696d 6545 7272  raise RuntimeErr
+0003f2e0: 6f72 280d 0a20 2020 2020 2020 2020 2020  or(..           
+0003f2f0: 2020 2020 2022 4361 6e6e 6f74 2073 7562       "Cannot sub
+0003f300: 2d73 616d 706c 6520 6672 6f6d 2061 2074  -sample from a t
+0003f310: 656e 736f 7264 6963 7420 7769 7468 2061  ensordict with a
+0003f320: 6e20 656d 7074 7920 7368 6170 652e 220d  n empty shape.".
+0003f330: 0a20 2020 2020 2020 2020 2020 2029 0d0a  .            )..
+0003f340: 2020 2020 2020 2020 6966 2073 6861 7065          if shape
+0003f350: 5b64 696d 5d20 3c20 7365 6c66 2e73 7562  [dim] < self.sub
+0003f360: 5f73 6571 5f6c 656e 3a0d 0a20 2020 2020  _seq_len:..     
+0003f370: 2020 2020 2020 2072 6169 7365 2052 756e         raise Run
+0003f380: 7469 6d65 4572 726f 7228 0d0a 2020 2020  timeError(..    
+0003f390: 2020 2020 2020 2020 2020 2020 6622 4361              f"Ca
+0003f3a0: 6e6e 6f74 2073 616d 706c 6520 7472 616a  nnot sample traj
+0003f3b0: 6563 746f 7269 6573 206f 6620 6c65 6e67  ectories of leng
+0003f3c0: 7468 207b 7365 6c66 2e73 7562 5f73 6571  th {self.sub_seq
+0003f3d0: 5f6c 656e 7d20 616c 6f6e 6722 0d0a 2020  _len} along"..  
+0003f3e0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0003f3f0: 2064 696d 656e 7369 6f6e 207b 6469 6d7d   dimension {dim}
+0003f400: 2067 6976 656e 2061 2074 656e 736f 7264   given a tensord
+0003f410: 6963 7420 6f66 2073 6861 7065 2022 0d0a  ict of shape "..
+0003f420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f430: 6622 7b74 656e 736f 7264 6963 742e 7368  f"{tensordict.sh
+0003f440: 6170 657d 2e20 436f 6e73 6964 6572 2072  ape}. Consider r
+0003f450: 6564 7563 696e 6720 7468 6520 7375 625f  educing the sub_
+0003f460: 7365 715f 6c65 6e20 220d 0a20 2020 2020  seq_len "..     
+0003f470: 2020 2020 2020 2020 2020 2066 2270 6172             f"par
+0003f480: 616d 6574 6572 206f 7220 696e 6372 6561  ameter or increa
+0003f490: 7365 2073 616d 706c 6520 6c65 6e67 7468  se sample length
+0003f4a0: 2e22 0d0a 2020 2020 2020 2020 2020 2020  ."..            
+0003f4b0: 290d 0a20 2020 2020 2020 206d 6178 5f69  )..        max_i
+0003f4c0: 6478 5f30 203d 2073 6861 7065 5b64 696d  dx_0 = shape[dim
+0003f4d0: 5d20 2d20 7365 6c66 2e73 7562 5f73 6571  ] - self.sub_seq
+0003f4e0: 5f6c 656e 0d0a 2020 2020 2020 2020 6964  _len..        id
+0003f4f0: 785f 7368 6170 6520 3d20 6c69 7374 2874  x_shape = list(t
+0003f500: 656e 736f 7264 6963 742e 7368 6170 6529  ensordict.shape)
+0003f510: 0d0a 2020 2020 2020 2020 6964 785f 7368  ..        idx_sh
+0003f520: 6170 655b 6469 6d5d 203d 2031 0d0a 2020  ape[dim] = 1..  
+0003f530: 2020 2020 2020 6465 7669 6365 203d 2074        device = t
+0003f540: 656e 736f 7264 6963 742e 6465 7669 6365  ensordict.device
+0003f550: 0d0a 2020 2020 2020 2020 6966 2064 6576  ..        if dev
+0003f560: 6963 6520 6973 204e 6f6e 653a 0d0a 2020  ice is None:..  
+0003f570: 2020 2020 2020 2020 2020 6465 7669 6365            device
+0003f580: 203d 2074 6f72 6368 2e64 6576 6963 6528   = torch.device(
+0003f590: 2263 7075 2229 0d0a 2020 2020 2020 2020  "cpu")..        
+0003f5a0: 6966 2073 656c 662e 6d61 736b 5f6b 6579  if self.mask_key
+0003f5b0: 2069 7320 4e6f 6e65 206f 7220 7365 6c66   is None or self
+0003f5c0: 2e6d 6173 6b5f 6b65 7920 6e6f 7420 696e  .mask_key not in
+0003f5d0: 2074 656e 736f 7264 6963 742e 6b65 7973   tensordict.keys
+0003f5e0: 280d 0a20 2020 2020 2020 2020 2020 2069  (..            i
+0003f5f0: 7369 6e73 7461 6e63 6528 7365 6c66 2e6d  sinstance(self.m
+0003f600: 6173 6b5f 6b65 792c 2074 7570 6c65 290d  ask_key, tuple).
+0003f610: 0a20 2020 2020 2020 2029 3a0d 0a20 2020  .        ):..   
+0003f620: 2020 2020 2020 2020 2069 6478 5f30 203d           idx_0 =
+0003f630: 2074 6f72 6368 2e72 616e 6469 6e74 286d   torch.randint(m
+0003f640: 6178 5f69 6478 5f30 2c20 6964 785f 7368  ax_idx_0, idx_sh
+0003f650: 6170 652c 2064 6576 6963 653d 6465 7669  ape, device=devi
+0003f660: 6365 290d 0a20 2020 2020 2020 2065 6c73  ce)..        els
+0003f670: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+0003f680: 2320 6765 7420 7468 6520 7472 616a 206c  # get the traj l
+0003f690: 656e 6774 6820 666f 7220 6561 6368 2065  ength for each e
+0003f6a0: 6e74 7279 0d0a 2020 2020 2020 2020 2020  ntry..          
+0003f6b0: 2020 6d61 736b 203d 2074 656e 736f 7264    mask = tensord
+0003f6c0: 6963 742e 6765 7428 7365 6c66 2e6d 6173  ict.get(self.mas
+0003f6d0: 6b5f 6b65 7929 0d0a 2020 2020 2020 2020  k_key)..        
+0003f6e0: 2020 2020 6966 206d 6173 6b2e 7368 6170      if mask.shap
+0003f6f0: 6520 213d 2074 656e 736f 7264 6963 742e  e != tensordict.
+0003f700: 7368 6170 653a 0d0a 2020 2020 2020 2020  shape:..        
+0003f710: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+0003f720: 6c75 6545 7272 6f72 280d 0a20 2020 2020  lueError(..     
+0003f730: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0003f740: 4578 7065 6374 6564 2061 206d 6173 6b20  Expected a mask 
+0003f750: 6f66 2074 6865 2073 616d 6520 7368 6170  of the same shap
+0003f760: 6520 6173 2074 6865 2074 656e 736f 7264  e as the tensord
+0003f770: 6963 742e 2047 6f74 2022 0d0a 2020 2020  ict. Got "..    
+0003f780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f790: 6622 6d61 736b 2e73 6861 7065 3d7b 6d61  f"mask.shape={ma
+0003f7a0: 736b 2e73 6861 7065 7d20 616e 6420 7465  sk.shape} and te
+0003f7b0: 6e73 6f72 6469 6374 2e73 6861 7065 3d22  nsordict.shape="
+0003f7c0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0003f7d0: 2020 2020 2020 6622 7b74 656e 736f 7264        f"{tensord
+0003f7e0: 6963 742e 7368 6170 657d 2069 6e73 7465  ict.shape} inste
+0003f7f0: 6164 2e22 0d0a 2020 2020 2020 2020 2020  ad."..          
+0003f800: 2020 2020 2020 290d 0a20 2020 2020 2020        )..       
+0003f810: 2020 2020 2074 7261 6a5f 6c65 6e67 7468       traj_length
+0003f820: 7320 3d20 6d61 736b 2e63 756d 7375 6d28  s = mask.cumsum(
+0003f830: 7365 6c66 2e73 616d 706c 655f 6469 6d29  self.sample_dim)
+0003f840: 2e6d 6178 2873 656c 662e 7361 6d70 6c65  .max(self.sample
+0003f850: 5f64 696d 2c20 5472 7565 295b 305d 0d0a  _dim, True)[0]..
+0003f860: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0003f870: 7472 616a 5f6c 656e 6774 6873 203c 2073  traj_lengths < s
+0003f880: 656c 662e 7375 625f 7365 715f 6c65 6e29  elf.sub_seq_len)
+0003f890: 2e61 6e79 2829 3a0d 0a20 2020 2020 2020  .any():..       
+0003f8a0: 2020 2020 2020 2020 2072 6169 7365 2052           raise R
+0003f8b0: 756e 7469 6d65 4572 726f 7228 0d0a 2020  untimeError(..  
+0003f8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f8d0: 2020 6622 4361 6e6e 6f74 2073 616d 706c    f"Cannot sampl
+0003f8e0: 6520 7472 616a 6563 746f 7269 6573 206f  e trajectories o
+0003f8f0: 6620 6c65 6e67 7468 207b 7365 6c66 2e73  f length {self.s
+0003f900: 7562 5f73 6571 5f6c 656e 7d20 7768 656e  ub_seq_len} when
+0003f910: 2074 6865 206d 696e 696d 756d 2022 0d0a   the minimum "..
+0003f920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f930: 2020 2020 6622 7472 616a 6563 746f 7279      f"trajectory
+0003f940: 206c 656e 6774 6820 6973 207b 7472 616a   length is {traj
+0003f950: 5f6c 656e 6774 6873 2e6d 696e 2829 7d2e  _lengths.min()}.
+0003f960: 220d 0a20 2020 2020 2020 2020 2020 2020  "..             
+0003f970: 2020 2029 0d0a 2020 2020 2020 2020 2020     )..          
+0003f980: 2020 2320 7461 6b65 2061 2072 616e 646f    # take a rando
+0003f990: 6d20 6e75 6d62 6572 2062 6574 7765 656e  m number between
+0003f9a0: 2030 2061 6e64 2074 7261 6a5f 6c65 6e67   0 and traj_leng
+0003f9b0: 7468 7320 2d20 7365 6c66 2e73 7562 5f73  ths - self.sub_s
+0003f9c0: 6571 5f6c 656e 0d0a 2020 2020 2020 2020  eq_len..        
+0003f9d0: 2020 2020 6964 785f 3020 3d20 280d 0a20      idx_0 = (.. 
+0003f9e0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0003f9f0: 6f72 6368 2e72 616e 6428 6964 785f 7368  orch.rand(idx_sh
+0003fa00: 6170 652c 2064 6576 6963 653d 6465 7669  ape, device=devi
+0003fa10: 6365 2920 2a20 2874 7261 6a5f 6c65 6e67  ce) * (traj_leng
+0003fa20: 7468 7320 2d20 7365 6c66 2e73 7562 5f73  ths - self.sub_s
+0003fa30: 6571 5f6c 656e 290d 0a20 2020 2020 2020  eq_len)..       
+0003fa40: 2020 2020 2029 2e74 6f28 746f 7263 682e       ).to(torch.
+0003fa50: 6c6f 6e67 290d 0a20 2020 2020 2020 2061  long)..        a
+0003fa60: 7261 6e67 6520 3d20 746f 7263 682e 6172  range = torch.ar
+0003fa70: 616e 6765 2873 656c 662e 7375 625f 7365  ange(self.sub_se
+0003fa80: 715f 6c65 6e2c 2064 6576 6963 653d 6964  q_len, device=id
+0003fa90: 785f 302e 6465 7669 6365 290d 0a20 2020  x_0.device)..   
+0003faa0: 2020 2020 2061 7261 6e67 655f 7368 6170       arange_shap
+0003fab0: 6520 3d20 5b31 2066 6f72 205f 2069 6e20  e = [1 for _ in 
+0003fac0: 7261 6e67 6528 7465 6e73 6f72 6469 6374  range(tensordict
+0003fad0: 2e6e 6469 6d65 6e73 696f 6e28 2929 5d0d  .ndimension())].
+0003fae0: 0a20 2020 2020 2020 2061 7261 6e67 655f  .        arange_
+0003faf0: 7368 6170 655b 6469 6d5d 203d 206c 656e  shape[dim] = len
+0003fb00: 2861 7261 6e67 6529 0d0a 2020 2020 2020  (arange)..      
+0003fb10: 2020 6172 616e 6765 203d 2061 7261 6e67    arange = arang
+0003fb20: 652e 7669 6577 2861 7261 6e67 655f 7368  e.view(arange_sh
+0003fb30: 6170 6529 0d0a 2020 2020 2020 2020 6964  ape)..        id
+0003fb40: 7820 3d20 6964 785f 3020 2b20 6172 616e  x = idx_0 + aran
+0003fb50: 6765 0d0a 2020 2020 2020 2020 7265 7475  ge..        retu
+0003fb60: 726e 2074 656e 736f 7264 6963 742e 6761  rn tensordict.ga
+0003fb70: 7468 6572 2864 696d 3d73 656c 662e 7361  ther(dim=self.sa
+0003fb80: 6d70 6c65 5f64 696d 2c20 696e 6465 783d  mple_dim, index=
+0003fb90: 6964 7829 0d0a 0d0a 2020 2020 6465 6620  idx)....    def 
+0003fba0: 5f72 6573 6574 280d 0a20 2020 2020 2020  _reset(..       
+0003fbb0: 2073 656c 662c 2074 656e 736f 7264 6963   self, tensordic
+0003fbc0: 743a 2054 656e 736f 7244 6963 7442 6173  t: TensorDictBas
+0003fbd0: 652c 2074 656e 736f 7264 6963 745f 7265  e, tensordict_re
+0003fbe0: 7365 743a 2054 656e 736f 7244 6963 7442  set: TensorDictB
+0003fbf0: 6173 650d 0a20 2020 2029 202d 3e20 5465  ase..    ) -> Te
+0003fc00: 6e73 6f72 4469 6374 4261 7365 3a0d 0a20  nsorDictBase:.. 
+0003fc10: 2020 2020 2020 2077 6974 6820 5f73 6574         with _set
+0003fc20: 5f6d 6973 7369 6e67 5f74 6f6c 6572 616e  _missing_toleran
+0003fc30: 6365 2873 656c 662c 2054 7275 6529 3a0d  ce(self, True):.
+0003fc40: 0a20 2020 2020 2020 2020 2020 2074 656e  .            ten
+0003fc50: 736f 7264 6963 745f 7265 7365 7420 3d20  sordict_reset = 
+0003fc60: 7365 6c66 2e66 6f72 7761 7264 2874 656e  self.forward(ten
+0003fc70: 736f 7264 6963 745f 7265 7365 7429 0d0a  sordict_reset)..
+0003fc80: 2020 2020 2020 2020 7265 7475 726e 2074          return t
+0003fc90: 656e 736f 7264 6963 745f 7265 7365 740d  ensordict_reset.
+0003fca0: 0a0d 0a0d 0a63 6c61 7373 2049 6e69 7454  .....class InitT
+0003fcb0: 7261 636b 6572 2854 7261 6e73 666f 726d  racker(Transform
+0003fcc0: 293a 0d0a 2020 2020 2222 2252 6573 6574  ):..    """Reset
+0003fcd0: 2074 7261 636b 6572 2e0d 0a0d 0a20 2020   tracker.....   
+0003fce0: 2054 6869 7320 7472 616e 7366 6f72 6d20   This transform 
+0003fcf0: 706f 7075 6c61 7465 7320 7468 6520 7374  populates the st
+0003fd00: 6570 2f72 6573 6574 2074 656e 736f 7264  ep/reset tensord
+0003fd10: 6963 7420 7769 7468 2061 2072 6573 6574  ict with a reset
+0003fd20: 2074 7261 636b 6572 2065 6e74 7279 0d0a   tracker entry..
+0003fd30: 2020 2020 7468 6174 2069 7320 7365 7420      that is set 
+0003fd40: 746f 2060 6054 7275 6560 6020 7768 656e  to ``True`` when
+0003fd50: 6576 6572 203a 6d65 7468 3a60 7e2e 7265  ever :meth:`~.re
+0003fd60: 7365 7460 2069 7320 6361 6c6c 6564 2e0d  set` is called..
+0003fd70: 0a0d 0a20 2020 2041 7267 733a 0d0a 2020  ...    Args:..  
+0003fd80: 2020 2020 2020 2069 6e69 745f 6b65 7920         init_key 
+0003fd90: 284e 6573 7465 644b 6579 2c20 6f70 7469  (NestedKey, opti
+0003fda0: 6f6e 616c 293a 2074 6865 206b 6579 2074  onal): the key t
+0003fdb0: 6f20 6265 2075 7365 6420 666f 7220 7468  o be used for th
+0003fdc0: 6520 7472 6163 6b65 7220 656e 7472 792e  e tracker entry.
+0003fdd0: 0d0a 0d0a 2020 2020 4578 616d 706c 6573  ....    Examples
+0003fde0: 3a0d 0a20 2020 2020 2020 203e 3e3e 2066  :..        >>> f
+0003fdf0: 726f 6d20 746f 7263 6872 6c2e 656e 7673  rom torchrl.envs
+0003fe00: 2e6c 6962 732e 6779 6d20 696d 706f 7274  .libs.gym import
+0003fe10: 2047 796d 456e 760d 0a20 2020 2020 2020   GymEnv..       
+0003fe20: 203e 3e3e 2065 6e76 203d 2054 7261 6e73   >>> env = Trans
+0003fe30: 666f 726d 6564 456e 7628 4779 6d45 6e76  formedEnv(GymEnv
+0003fe40: 2822 5065 6e64 756c 756d 2d76 3122 292c  ("Pendulum-v1"),
+0003fe50: 2049 6e69 7454 7261 636b 6572 2829 290d   InitTracker()).
+0003fe60: 0a20 2020 2020 2020 203e 3e3e 2074 6420  .        >>> td 
+0003fe70: 3d20 656e 762e 7265 7365 7428 290d 0a20  = env.reset().. 
+0003fe80: 2020 2020 2020 203e 3e3e 2070 7269 6e74         >>> print
+0003fe90: 2874 645b 2269 735f 696e 6974 225d 290d  (td["is_init"]).
+0003fea0: 0a20 2020 2020 2020 2074 656e 736f 7228  .        tensor(
+0003feb0: 5472 7565 290d 0a20 2020 2020 2020 203e  True)..        >
+0003fec0: 3e3e 2074 6420 3d20 656e 762e 7261 6e64  >> td = env.rand
+0003fed0: 5f73 7465 7028 7464 290d 0a20 2020 2020  _step(td)..     
+0003fee0: 2020 203e 3e3e 2070 7269 6e74 2874 645b     >>> print(td[
+0003fef0: 226e 6578 7422 2c20 2269 735f 696e 6974  "next", "is_init
+0003ff00: 225d 290d 0a20 2020 2020 2020 2074 656e  "])..        ten
+0003ff10: 736f 7228 4661 6c73 6529 0d0a 0d0a 2020  sor(False)....  
+0003ff20: 2020 2222 220d 0a0d 0a20 2020 2064 6566    """....    def
+0003ff30: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+0003ff40: 696e 6974 5f6b 6579 3a20 4e65 7374 6564  init_key: Nested
+0003ff50: 4b65 7920 3d20 2269 735f 696e 6974 2229  Key = "is_init")
+0003ff60: 3a0d 0a20 2020 2020 2020 2069 6620 6e6f  :..        if no
+0003ff70: 7420 6973 696e 7374 616e 6365 2869 6e69  t isinstance(ini
+0003ff80: 745f 6b65 792c 2073 7472 293a 0d0a 2020  t_key, str):..  
+0003ff90: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0003ffa0: 5661 6c75 6545 7272 6f72 2822 696e 6974  ValueError("init
+0003ffb0: 5f6b 6579 2063 616e 206f 6e6c 7920 6265  _key can only be
+0003ffc0: 206f 6620 7479 7065 2073 7472 2e22 290d   of type str.").
+0003ffd0: 0a20 2020 2020 2020 2073 656c 662e 696e  .        self.in
+0003ffe0: 6974 5f6b 6579 203d 2069 6e69 745f 6b65  it_key = init_ke
+0003fff0: 790d 0a20 2020 2020 2020 2073 656c 662e  y..        self.
+00040000: 7265 7365 745f 6b65 7920 3d20 225f 7265  reset_key = "_re
+00040010: 7365 7422 0d0a 2020 2020 2020 2020 7375  set"..        su
+00040020: 7065 7228 292e 5f5f 696e 6974 5f5f 2829  per().__init__()
+00040030: 0d0a 0d0a 2020 2020 6465 6620 7365 745f  ....    def set_
+00040040: 636f 6e74 6169 6e65 7228 7365 6c66 2c20  container(self, 
+00040050: 636f 6e74 6169 6e65 723a 2055 6e69 6f6e  container: Union
+00040060: 5b54 7261 6e73 666f 726d 2c20 456e 7642  [Transform, EnvB
+00040070: 6173 655d 2920 2d3e 204e 6f6e 653a 0d0a  ase]) -> None:..
+00040080: 2020 2020 2020 2020 7365 6c66 2e5f 696e          self._in
+00040090: 6974 5f6b 6579 7320 3d20 4e6f 6e65 0d0a  it_keys = None..
+000400a0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+000400b0: 7570 6572 2829 2e73 6574 5f63 6f6e 7461  uper().set_conta
+000400c0: 696e 6572 2863 6f6e 7461 696e 6572 290d  iner(container).
+000400d0: 0a0d 0a20 2020 2040 7072 6f70 6572 7479  ...    @property
+000400e0: 0d0a 2020 2020 6465 6620 6f75 745f 6b65  ..    def out_ke
+000400f0: 7973 2873 656c 6629 3a0d 0a20 2020 2020  ys(self):..     
+00040100: 2020 2072 6574 7572 6e20 7365 6c66 2e69     return self.i
+00040110: 6e69 745f 6b65 7973 0d0a 0d0a 2020 2020  nit_keys....    
+00040120: 406f 7574 5f6b 6579 732e 7365 7474 6572  @out_keys.setter
+00040130: 0d0a 2020 2020 6465 6620 6f75 745f 6b65  ..    def out_ke
+00040140: 7973 2873 656c 662c 2076 616c 7565 293a  ys(self, value):
+00040150: 0d0a 2020 2020 2020 2020 6966 2076 616c  ..        if val
+00040160: 7565 2069 6e20 284e 6f6e 652c 205b 5d29  ue in (None, [])
+00040170: 3a0d 0a20 2020 2020 2020 2020 2020 2072  :..            r
+00040180: 6574 7572 6e0d 0a20 2020 2020 2020 2072  eturn..        r
+00040190: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+000401a0: 0d0a 2020 2020 2020 2020 2020 2020 2243  ..            "C
+000401b0: 616e 6e6f 7420 7365 7420 6e6f 6e2d 656d  annot set non-em
+000401c0: 7074 7920 6f75 742d 6b65 7973 2077 6865  pty out-keys whe
+000401d0: 6e20 6f75 742d 6b65 7973 2061 7265 2064  n out-keys are d
+000401e0: 6566 696e 6564 2062 7920 7468 6520 696e  efined by the in
+000401f0: 6974 5f6b 6579 2076 616c 7565 2e22 0d0a  it_key value."..
+00040200: 2020 2020 2020 2020 290d 0a0d 0a20 2020          )....   
+00040210: 2040 7072 6f70 6572 7479 0d0a 2020 2020   @property..    
+00040220: 6465 6620 696e 6974 5f6b 6579 7328 7365  def init_keys(se
+00040230: 6c66 293a 0d0a 2020 2020 2020 2020 696e  lf):..        in
+00040240: 6974 5f6b 6579 7320 3d20 7365 6c66 2e5f  it_keys = self._
+00040250: 5f64 6963 745f 5f2e 6765 7428 225f 696e  _dict__.get("_in
+00040260: 6974 5f6b 6579 7322 2c20 4e6f 6e65 290d  it_keys", None).
+00040270: 0a20 2020 2020 2020 2069 6620 696e 6974  .        if init
+00040280: 5f6b 6579 7320 6973 206e 6f74 204e 6f6e  _keys is not Non
+00040290: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+000402a0: 7265 7475 726e 2069 6e69 745f 6b65 7973  return init_keys
+000402b0: 0d0a 2020 2020 2020 2020 696e 6974 5f6b  ..        init_k
+000402c0: 6579 7320 3d20 5b5d 0d0a 2020 2020 2020  eys = []..      
+000402d0: 2020 6966 2073 656c 662e 7061 7265 6e74    if self.parent
+000402e0: 2069 7320 4e6f 6e65 3a0d 0a20 2020 2020   is None:..     
+000402f0: 2020 2020 2020 2072 6169 7365 204e 6f74         raise Not
+00040300: 496d 706c 656d 656e 7465 6445 7272 6f72  ImplementedError
+00040310: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
+00040320: 2020 2046 4f52 5741 5244 5f4e 4f54 5f49     FORWARD_NOT_I
+00040330: 4d50 4c45 4d45 4e54 4544 2e66 6f72 6d61  MPLEMENTED.forma
+00040340: 7428 7365 6c66 2e5f 5f63 6c61 7373 5f5f  t(self.__class__
+00040350: 2e5f 5f6e 616d 655f 5f29 0d0a 2020 2020  .__name__)..    
+00040360: 2020 2020 2020 2020 290d 0a20 2020 2020          )..     
+00040370: 2020 2066 6f72 2072 6573 6574 5f6b 6579     for reset_key
+00040380: 2069 6e20 7365 6c66 2e70 6172 656e 742e   in self.parent.
+00040390: 5f66 696c 7465 7265 645f 7265 7365 745f  _filtered_reset_
+000403a0: 6b65 7973 3a0d 0a20 2020 2020 2020 2020  keys:..         
+000403b0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+000403c0: 2872 6573 6574 5f6b 6579 2c20 7374 7229  (reset_key, str)
+000403d0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+000403e0: 2020 2069 6e69 745f 6b65 7920 3d20 7365     init_key = se
+000403f0: 6c66 2e69 6e69 745f 6b65 790d 0a20 2020  lf.init_key..   
+00040400: 2020 2020 2020 2020 2065 6c73 653a 0d0a           else:..
+00040410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040420: 696e 6974 5f6b 6579 203d 2075 6e72 6176  init_key = unrav
+00040430: 656c 5f6b 6579 2828 7265 7365 745f 6b65  el_key((reset_ke
+00040440: 795b 3a2d 315d 2c20 7365 6c66 2e69 6e69  y[:-1], self.ini
+00040450: 745f 6b65 7929 290d 0a20 2020 2020 2020  t_key))..       
+00040460: 2020 2020 2069 6e69 745f 6b65 7973 2e61       init_keys.a
+00040470: 7070 656e 6428 696e 6974 5f6b 6579 290d  ppend(init_key).
+00040480: 0a20 2020 2020 2020 2073 656c 662e 5f69  .        self._i
+00040490: 6e69 745f 6b65 7973 203d 2069 6e69 745f  nit_keys = init_
+000404a0: 6b65 7973 0d0a 2020 2020 2020 2020 7265  keys..        re
+000404b0: 7475 726e 2073 656c 662e 5f69 6e69 745f  turn self._init_
+000404c0: 6b65 7973 0d0a 0d0a 2020 2020 4070 726f  keys....    @pro
+000404d0: 7065 7274 790d 0a20 2020 2064 6566 2072  perty..    def r
+000404e0: 6573 6574 5f6b 6579 7328 7365 6c66 293a  eset_keys(self):
+000404f0: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00040500: 2073 656c 662e 7061 7265 6e74 2e5f 6669   self.parent._fi
+00040510: 6c74 6572 6564 5f72 6573 6574 5f6b 6579  ltered_reset_key
+00040520: 730d 0a0d 0a20 2020 2064 6566 205f 6361  s....    def _ca
+00040530: 6c6c 2873 656c 662c 2074 656e 736f 7264  ll(self, tensord
+00040540: 6963 743a 2054 656e 736f 7244 6963 7442  ict: TensorDictB
+00040550: 6173 6529 202d 3e20 5465 6e73 6f72 4469  ase) -> TensorDi
+00040560: 6374 4261 7365 3a0d 0a20 2020 2020 2020  ctBase:..       
+00040570: 2066 6f72 2069 6e69 745f 6b65 7920 696e   for init_key in
+00040580: 2073 656c 662e 696e 6974 5f6b 6579 733a   self.init_keys:
+00040590: 0d0a 2020 2020 2020 2020 2020 2020 646f  ..            do
+000405a0: 6e65 5f6b 6579 203d 205f 7265 706c 6163  ne_key = _replac
+000405b0: 655f 6c61 7374 2869 6e69 745f 6b65 792c  e_last(init_key,
+000405c0: 2022 646f 6e65 2229 0d0a 2020 2020 2020   "done")..      
+000405d0: 2020 2020 2020 6966 2069 6e69 745f 6b65        if init_ke
+000405e0: 7920 6e6f 7420 696e 2074 656e 736f 7264  y not in tensord
+000405f0: 6963 742e 6b65 7973 2854 7275 652c 2054  ict.keys(True, T
+00040600: 7275 6529 3a0d 0a20 2020 2020 2020 2020  rue):..         
+00040610: 2020 2020 2020 2064 6576 6963 6520 3d20         device = 
+00040620: 7465 6e73 6f72 6469 6374 2e64 6576 6963  tensordict.devic
+00040630: 650d 0a20 2020 2020 2020 2020 2020 2020  e..             
+00040640: 2020 2069 6620 6465 7669 6365 2069 7320     if device is 
+00040650: 4e6f 6e65 3a0d 0a20 2020 2020 2020 2020  None:..         
+00040660: 2020 2020 2020 2020 2020 2064 6576 6963             devic
+00040670: 6520 3d20 746f 7263 682e 6465 7669 6365  e = torch.device
+00040680: 2822 6370 7522 290d 0a20 2020 2020 2020  ("cpu")..       
+00040690: 2020 2020 2020 2020 2073 6861 7065 203d           shape =
+000406a0: 2073 656c 662e 7061 7265 6e74 2e66 756c   self.parent.ful
+000406b0: 6c5f 646f 6e65 5f73 7065 635b 646f 6e65  l_done_spec[done
+000406c0: 5f6b 6579 5d2e 7368 6170 650d 0a20 2020  _key].shape..   
+000406d0: 2020 2020 2020 2020 2020 2020 2074 656e               ten
+000406e0: 736f 7264 6963 742e 7365 7428 0d0a 2020  sordict.set(..  
+000406f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040700: 2020 696e 6974 5f6b 6579 2c0d 0a20 2020    init_key,..   
+00040710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040720: 2074 6f72 6368 2e7a 6572 6f73 2873 6861   torch.zeros(sha
+00040730: 7065 2c20 6465 7669 6365 3d64 6576 6963  pe, device=devic
+00040740: 652c 2064 7479 7065 3d74 6f72 6368 2e62  e, dtype=torch.b
+00040750: 6f6f 6c29 2c0d 0a20 2020 2020 2020 2020  ool),..         
+00040760: 2020 2020 2020 2029 0d0a 2020 2020 2020         )..      
+00040770: 2020 7265 7475 726e 2074 656e 736f 7264    return tensord
+00040780: 6963 740d 0a0d 0a20 2020 2064 6566 205f  ict....    def _
+00040790: 7265 7365 7428 0d0a 2020 2020 2020 2020  reset(..        
+000407a0: 7365 6c66 2c20 7465 6e73 6f72 6469 6374  self, tensordict
+000407b0: 3a20 5465 6e73 6f72 4469 6374 4261 7365  : TensorDictBase
+000407c0: 2c20 7465 6e73 6f72 6469 6374 5f72 6573  , tensordict_res
+000407d0: 6574 3a20 5465 6e73 6f72 4469 6374 4261  et: TensorDictBa
+000407e0: 7365 0d0a 2020 2020 2920 2d3e 2054 656e  se..    ) -> Ten
+000407f0: 736f 7244 6963 7442 6173 653a 0d0a 2020  sorDictBase:..  
+00040800: 2020 2020 2020 6465 7669 6365 203d 2074        device = t
+00040810: 656e 736f 7264 6963 742e 6465 7669 6365  ensordict.device
+00040820: 0d0a 2020 2020 2020 2020 6966 2064 6576  ..        if dev
+00040830: 6963 6520 6973 204e 6f6e 653a 0d0a 2020  ice is None:..  
+00040840: 2020 2020 2020 2020 2020 6465 7669 6365            device
+00040850: 203d 2074 6f72 6368 2e64 6576 6963 6528   = torch.device(
+00040860: 2263 7075 2229 0d0a 2020 2020 2020 2020  "cpu")..        
+00040870: 666f 7220 7265 7365 745f 6b65 792c 2069  for reset_key, i
+00040880: 6e69 745f 6b65 7920 696e 207a 6970 2873  nit_key in zip(s
+00040890: 656c 662e 7265 7365 745f 6b65 7973 2c20  elf.reset_keys, 
+000408a0: 7365 6c66 2e69 6e69 745f 6b65 7973 293a  self.init_keys):
+000408b0: 0d0a 2020 2020 2020 2020 2020 2020 5f72  ..            _r
+000408c0: 6573 6574 203d 2074 656e 736f 7264 6963  eset = tensordic
+000408d0: 742e 6765 7428 7265 7365 745f 6b65 792c  t.get(reset_key,
+000408e0: 204e 6f6e 6529 0d0a 2020 2020 2020 2020   None)..        
+000408f0: 2020 2020 6966 205f 7265 7365 7420 6973      if _reset is
+00040900: 204e 6f6e 653a 0d0a 2020 2020 2020 2020   None:..        
+00040910: 2020 2020 2020 2020 646f 6e65 5f6b 6579          done_key
+00040920: 203d 205f 7265 706c 6163 655f 6c61 7374   = _replace_last
+00040930: 2869 6e69 745f 6b65 792c 2022 646f 6e65  (init_key, "done
+00040940: 2229 0d0a 2020 2020 2020 2020 2020 2020  ")..            
+00040950: 2020 2020 7368 6170 6520 3d20 7365 6c66      shape = self
+00040960: 2e70 6172 656e 742e 6675 6c6c 5f64 6f6e  .parent.full_don
+00040970: 655f 7370 6563 5b64 6f6e 655f 6b65 795d  e_spec[done_key]
+00040980: 2e73 6861 7065 0d0a 2020 2020 2020 2020  .shape..        
+00040990: 2020 2020 2020 2020 7465 6e73 6f72 6469          tensordi
+000409a0: 6374 5f72 6573 6574 2e73 6574 280d 0a20  ct_reset.set(.. 
+000409b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000409c0: 2020 2069 6e69 745f 6b65 792c 0d0a 2020     init_key,..  
+000409d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000409e0: 2020 746f 7263 682e 6f6e 6573 280d 0a20    torch.ones(.. 
+000409f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040a00: 2020 2020 2020 2073 6861 7065 2c0d 0a20         shape,.. 
+00040a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040a20: 2020 2020 2020 2064 6576 6963 653d 6465         device=de
+00040a30: 7669 6365 2c0d 0a20 2020 2020 2020 2020  vice,..         
+00040a40: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00040a50: 7479 7065 3d74 6f72 6368 2e62 6f6f 6c2c  type=torch.bool,
+00040a60: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00040a70: 2020 2020 2020 292c 0d0a 2020 2020 2020        ),..      
+00040a80: 2020 2020 2020 2020 2020 290d 0a20 2020            )..   
+00040a90: 2020 2020 2020 2020 2065 6c73 653a 0d0a           else:..
+00040aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040ab0: 696e 6974 5f76 616c 203d 205f 7265 7365  init_val = _rese
+00040ac0: 742e 636c 6f6e 6528 290d 0a20 2020 2020  t.clone()..     
+00040ad0: 2020 2020 2020 2020 2020 2070 6172 656e             paren
+00040ae0: 745f 7464 203d 2028 0d0a 2020 2020 2020  t_td = (..      
+00040af0: 2020 2020 2020 2020 2020 2020 2020 7465                te
+00040b00: 6e73 6f72 6469 6374 5f72 6573 6574 0d0a  nsordict_reset..
+00040b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040b20: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00040b30: 6528 696e 6974 5f6b 6579 2c20 7374 7229  e(init_key, str)
+00040b40: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00040b50: 2020 2020 2020 656c 7365 2074 656e 736f        else tenso
+00040b60: 7264 6963 745f 7265 7365 742e 6765 7428  rdict_reset.get(
+00040b70: 696e 6974 5f6b 6579 5b3a 2d31 5d29 0d0a  init_key[:-1])..
 00040b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040b90: 2020 6966 2064 6f6e 655f 6b65 795b 3a2d    if done_key[:-
-00040ba0: 315d 203d 3d20 696e 6974 5f6b 6579 5b3a  1] == init_key[:
-00040bb0: 2d31 5d3a 0d0a 2020 2020 2020 2020 2020  -1]:..          
-00040bc0: 2020 2020 2020 2020 2020 2020 2020 7368                sh
-00040bd0: 6170 6520 3d20 6675 6c6c 5f64 6f6e 655f  ape = full_done_
-00040be0: 7370 6563 5b64 6f6e 655f 6b65 795d 2e73  spec[done_key].s
-00040bf0: 6861 7065 0d0a 2020 2020 2020 2020 2020  hape..          
-00040c00: 2020 2020 2020 2020 2020 2020 2020 6272                br
-00040c10: 6561 6b0d 0a20 2020 2020 2020 2020 2020  eak..           
-00040c20: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-00040c30: 6365 2864 6f6e 655f 6b65 792c 2073 7472  ce(done_key, str
-00040c40: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
-00040c50: 2020 2020 2020 2020 7368 6170 6520 3d20          shape = 
-00040c60: 6675 6c6c 5f64 6f6e 655f 7370 6563 5b64  full_done_spec[d
-00040c70: 6f6e 655f 6b65 795d 2e73 6861 7065 0d0a  one_key].shape..
-00040c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040c90: 2020 2020 6272 6561 6b0d 0a20 2020 2020      break..     
-00040ca0: 2020 2020 2020 2065 6c73 653a 0d0a 2020         else:..  
-00040cb0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00040cc0: 6973 6520 4b65 7945 7272 6f72 280d 0a20  ise KeyError(.. 
-00040cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040ce0: 2020 2066 2243 6f75 6c64 206e 6f74 2066     f"Could not f
-00040cf0: 696e 6420 726f 6f74 206f 6620 696e 6974  ind root of init
-00040d00: 5f6b 6579 207b 696e 6974 5f6b 6579 7d20  _key {init_key} 
-00040d10: 7769 7468 696e 2064 6f6e 655f 6b65 7973  within done_keys
-00040d20: 207b 7365 6c66 2e70 6172 656e 742e 646f   {self.parent.do
-00040d30: 6e65 5f6b 6579 737d 2e22 0d0a 2020 2020  ne_keys}."..    
-00040d40: 2020 2020 2020 2020 2020 2020 290d 0a20              ).. 
-00040d50: 2020 2020 2020 2020 2020 206f 6273 6572             obser
-00040d60: 7661 7469 6f6e 5f73 7065 635b 696e 6974  vation_spec[init
-00040d70: 5f6b 6579 5d20 3d20 4469 7363 7265 7465  _key] = Discrete
-00040d80: 5465 6e73 6f72 5370 6563 280d 0a20 2020  TensorSpec(..   
-00040d90: 2020 2020 2020 2020 2020 2020 2032 2c0d               2,.
-00040da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00040db0: 2064 7479 7065 3d74 6f72 6368 2e62 6f6f   dtype=torch.boo
-00040dc0: 6c2c 0d0a 2020 2020 2020 2020 2020 2020  l,..            
-00040dd0: 2020 2020 6465 7669 6365 3d73 656c 662e      device=self.
-00040de0: 7061 7265 6e74 2e64 6576 6963 652c 0d0a  parent.device,..
-00040df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040e00: 7368 6170 653d 7368 6170 652c 0d0a 2020  shape=shape,..  
-00040e10: 2020 2020 2020 2020 2020 290d 0a20 2020            )..   
-00040e20: 2020 2020 2072 6574 7572 6e20 6f62 7365       return obse
-00040e30: 7276 6174 696f 6e5f 7370 6563 0d0a 0d0a  rvation_spec....
-00040e40: 2020 2020 6465 6620 666f 7277 6172 6428      def forward(
-00040e50: 7365 6c66 2c20 7465 6e73 6f72 6469 6374  self, tensordict
-00040e60: 3a20 5465 6e73 6f72 4469 6374 4261 7365  : TensorDictBase
-00040e70: 2920 2d3e 2054 656e 736f 7244 6963 7442  ) -> TensorDictB
-00040e80: 6173 653a 0d0a 2020 2020 2020 2020 7261  ase:..        ra
-00040e90: 6973 6520 4e6f 7449 6d70 6c65 6d65 6e74  ise NotImplement
-00040ea0: 6564 4572 726f 7228 0d0a 2020 2020 2020  edError(..      
-00040eb0: 2020 2020 2020 464f 5257 4152 445f 4e4f        FORWARD_NO
-00040ec0: 545f 494d 504c 454d 454e 5445 442e 666f  T_IMPLEMENTED.fo
-00040ed0: 726d 6174 2873 656c 662e 5f5f 636c 6173  rmat(self.__clas
-00040ee0: 735f 5f2e 5f5f 6e61 6d65 5f5f 290d 0a20  s__.__name__).. 
-00040ef0: 2020 2020 2020 2029 0d0a 0d0a 0d0a 636c         )......cl
-00040f00: 6173 7320 5265 6e61 6d65 5472 616e 7366  ass RenameTransf
-00040f10: 6f72 6d28 5472 616e 7366 6f72 6d29 3a0d  orm(Transform):.
-00040f20: 0a20 2020 2022 2222 4120 7472 616e 7366  .    """A transf
-00040f30: 6f72 6d20 746f 2072 656e 616d 6520 656e  orm to rename en
-00040f40: 7472 6965 7320 696e 2074 6865 206f 7574  tries in the out
-00040f50: 7075 7420 7465 6e73 6f72 6469 6374 2e0d  put tensordict..
-00040f60: 0a0d 0a20 2020 2041 7267 733a 0d0a 2020  ...    Args:..  
-00040f70: 2020 2020 2020 696e 5f6b 6579 7320 2873        in_keys (s
-00040f80: 6571 7565 6e63 6520 6f66 204e 6573 7465  equence of Neste
-00040f90: 644b 6579 293a 2074 6865 2065 6e74 7269  dKey): the entri
-00040fa0: 6573 2074 6f20 7265 6e61 6d65 0d0a 2020  es to rename..  
-00040fb0: 2020 2020 2020 6f75 745f 6b65 7973 2028        out_keys (
-00040fc0: 7365 7175 656e 6365 206f 6620 4e65 7374  sequence of Nest
-00040fd0: 6564 4b65 7929 3a20 7468 6520 6e61 6d65  edKey): the name
-00040fe0: 206f 6620 7468 6520 656e 7472 6965 7320   of the entries 
-00040ff0: 6166 7465 7220 7265 6e61 6d69 6e67 2e0d  after renaming..
-00041000: 0a20 2020 2020 2020 2069 6e5f 6b65 7973  .        in_keys
-00041010: 5f69 6e76 2028 7365 7175 656e 6365 206f  _inv (sequence o
-00041020: 6620 4e65 7374 6564 4b65 792c 206f 7074  f NestedKey, opt
-00041030: 696f 6e61 6c29 3a20 7468 6520 656e 7472  ional): the entr
-00041040: 6965 7320 746f 2072 656e 616d 6520 6265  ies to rename be
-00041050: 666f 7265 0d0a 2020 2020 2020 2020 2020  fore..          
-00041060: 2020 7061 7373 696e 6720 7468 6520 696e    passing the in
-00041070: 7075 7420 7465 6e73 6f72 6469 6374 2074  put tensordict t
-00041080: 6f20 3a6d 6574 683a 6045 6e76 4261 7365  o :meth:`EnvBase
-00041090: 2e5f 7374 6570 602e 0d0a 2020 2020 2020  ._step`...      
-000410a0: 2020 6f75 745f 6b65 7973 5f69 6e76 2028    out_keys_inv (
-000410b0: 7365 7175 656e 6365 206f 6620 4e65 7374  sequence of Nest
-000410c0: 6564 4b65 792c 206f 7074 696f 6e61 6c29  edKey, optional)
-000410d0: 3a20 7468 6520 6e61 6d65 7320 6f66 2074  : the names of t
-000410e0: 6865 2072 656e 616d 6564 0d0a 2020 2020  he renamed..    
-000410f0: 2020 2020 2020 2020 656e 7472 6965 7320          entries 
-00041100: 7061 7373 6564 2074 6f20 3a6d 6574 683a  passed to :meth:
-00041110: 6045 6e76 4261 7365 2e5f 7374 6570 602e  `EnvBase._step`.
-00041120: 0d0a 2020 2020 2020 2020 6372 6561 7465  ..        create
-00041130: 5f63 6f70 7920 2862 6f6f 6c2c 206f 7074  _copy (bool, opt
-00041140: 696f 6e61 6c29 3a20 6966 2060 6054 7275  ional): if ``Tru
-00041150: 6560 602c 2074 6865 2065 6e74 7269 6573  e``, the entries
-00041160: 2077 696c 6c20 6265 2063 6f70 6965 640d   will be copied.
-00041170: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
-00041180: 6820 6120 6469 6666 6572 656e 7420 6e61  h a different na
-00041190: 6d65 2072 6174 6865 7220 7468 616e 2062  me rather than b
-000411a0: 6569 6e67 2072 656e 616d 6564 2e20 5468  eing renamed. Th
-000411b0: 6973 2061 6c6c 6f77 7320 666f 720d 0a20  is allows for.. 
-000411c0: 2020 2020 2020 2020 2020 2072 656e 616d             renam
-000411d0: 696e 6720 696d 6d75 7461 626c 6520 656e  ing immutable en
-000411e0: 7472 6965 7320 7375 6368 2061 7320 6060  tries such as ``
-000411f0: 2272 6577 6172 6422 6060 2061 6e64 2060  "reward"`` and `
-00041200: 6022 646f 6e65 2260 602e 0d0a 0d0a 2020  `"done"``.....  
-00041210: 2020 4578 616d 706c 6573 3a0d 0a20 2020    Examples:..   
-00041220: 2020 2020 203e 3e3e 2066 726f 6d20 746f       >>> from to
-00041230: 7263 6872 6c2e 656e 7673 2e6c 6962 732e  rchrl.envs.libs.
-00041240: 6779 6d20 696d 706f 7274 2047 796d 456e  gym import GymEn
-00041250: 760d 0a20 2020 2020 2020 203e 3e3e 2065  v..        >>> e
-00041260: 6e76 203d 2054 7261 6e73 666f 726d 6564  nv = Transformed
-00041270: 456e 7628 0d0a 2020 2020 2020 2020 2e2e  Env(..        ..
-00041280: 2e20 2020 2020 4779 6d45 6e76 2822 5065  .     GymEnv("Pe
-00041290: 6e64 756c 756d 2d76 3122 292c 0d0a 2020  ndulum-v1"),..  
-000412a0: 2020 2020 2020 2e2e 2e20 2020 2020 5265        ...     Re
-000412b0: 6e61 6d65 5472 616e 7366 6f72 6d28 5b22  nameTransform(["
-000412c0: 6f62 7365 7276 6174 696f 6e22 2c20 5d2c  observation", ],
-000412d0: 205b 2273 7475 6666 222c 5d2c 2063 7265   ["stuff",], cre
-000412e0: 6174 655f 636f 7079 3d46 616c 7365 292c  ate_copy=False),
-000412f0: 0d0a 2020 2020 2020 2020 2e2e 2e20 290d  ..        ... ).
-00041300: 0a20 2020 2020 2020 203e 3e3e 2074 656e  .        >>> ten
-00041310: 736f 7264 6963 7420 3d20 656e 762e 726f  sordict = env.ro
-00041320: 6c6c 6f75 7428 3329 0d0a 2020 2020 2020  llout(3)..      
-00041330: 2020 3e3e 3e20 7072 696e 7428 7465 6e73    >>> print(tens
-00041340: 6f72 6469 6374 290d 0a20 2020 2020 2020  ordict)..       
-00041350: 2054 656e 736f 7244 6963 7428 0d0a 2020   TensorDict(..  
-00041360: 2020 2020 2020 2020 2020 6669 656c 6473            fields
-00041370: 3d7b 0d0a 2020 2020 2020 2020 2020 2020  ={..            
-00041380: 2020 2020 6163 7469 6f6e 3a20 5465 6e73      action: Tens
-00041390: 6f72 2873 6861 7065 3d74 6f72 6368 2e53  or(shape=torch.S
-000413a0: 697a 6528 5b33 2c20 315d 292c 2064 6576  ize([3, 1]), dev
-000413b0: 6963 653d 6370 752c 2064 7479 7065 3d74  ice=cpu, dtype=t
-000413c0: 6f72 6368 2e66 6c6f 6174 3332 2c20 6973  orch.float32, is
-000413d0: 5f73 6861 7265 643d 4661 6c73 6529 2c0d  _shared=False),.
-000413e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000413f0: 2064 6f6e 653a 2054 656e 736f 7228 7368   done: Tensor(sh
-00041400: 6170 653d 746f 7263 682e 5369 7a65 285b  ape=torch.Size([
-00041410: 332c 2031 5d29 2c20 6465 7669 6365 3d63  3, 1]), device=c
-00041420: 7075 2c20 6474 7970 653d 746f 7263 682e  pu, dtype=torch.
-00041430: 626f 6f6c 2c20 6973 5f73 6861 7265 643d  bool, is_shared=
-00041440: 4661 6c73 6529 2c0d 0a20 2020 2020 2020  False),..       
-00041450: 2020 2020 2020 2020 206e 6578 743a 2054           next: T
-00041460: 656e 736f 7244 6963 7428 0d0a 2020 2020  ensorDict(..    
-00041470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041480: 6669 656c 6473 3d7b 0d0a 2020 2020 2020  fields={..      
-00041490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000414a0: 2020 646f 6e65 3a20 5465 6e73 6f72 2873    done: Tensor(s
-000414b0: 6861 7065 3d74 6f72 6368 2e53 697a 6528  hape=torch.Size(
-000414c0: 5b33 2c20 315d 292c 2064 6576 6963 653d  [3, 1]), device=
-000414d0: 6370 752c 2064 7479 7065 3d74 6f72 6368  cpu, dtype=torch
-000414e0: 2e62 6f6f 6c2c 2069 735f 7368 6172 6564  .bool, is_shared
-000414f0: 3d46 616c 7365 292c 0d0a 2020 2020 2020  =False),..      
-00041500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041510: 2020 7265 7761 7264 3a20 5465 6e73 6f72    reward: Tensor
-00041520: 2873 6861 7065 3d74 6f72 6368 2e53 697a  (shape=torch.Siz
-00041530: 6528 5b33 2c20 315d 292c 2064 6576 6963  e([3, 1]), devic
-00041540: 653d 6370 752c 2064 7479 7065 3d74 6f72  e=cpu, dtype=tor
-00041550: 6368 2e66 6c6f 6174 3332 2c20 6973 5f73  ch.float32, is_s
-00041560: 6861 7265 643d 4661 6c73 6529 2c0d 0a20  hared=False),.. 
-00041570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041580: 2020 2020 2020 2073 7475 6666 3a20 5465         stuff: Te
-00041590: 6e73 6f72 2873 6861 7065 3d74 6f72 6368  nsor(shape=torch
-000415a0: 2e53 697a 6528 5b33 2c20 335d 292c 2064  .Size([3, 3]), d
-000415b0: 6576 6963 653d 6370 752c 2064 7479 7065  evice=cpu, dtype
-000415c0: 3d74 6f72 6368 2e66 6c6f 6174 3332 2c20  =torch.float32, 
-000415d0: 6973 5f73 6861 7265 643d 4661 6c73 6529  is_shared=False)
-000415e0: 7d2c 0d0a 2020 2020 2020 2020 2020 2020  },..            
-000415f0: 2020 2020 2020 2020 6261 7463 685f 7369          batch_si
-00041600: 7a65 3d74 6f72 6368 2e53 697a 6528 5b33  ze=torch.Size([3
-00041610: 5d29 2c0d 0a20 2020 2020 2020 2020 2020  ]),..           
-00041620: 2020 2020 2020 2020 2064 6576 6963 653d           device=
-00041630: 6370 752c 0d0a 2020 2020 2020 2020 2020  cpu,..          
-00041640: 2020 2020 2020 2020 2020 6973 5f73 6861            is_sha
-00041650: 7265 643d 4661 6c73 6529 2c0d 0a20 2020  red=False),..   
-00041660: 2020 2020 2020 2020 2020 2020 2073 7475               stu
-00041670: 6666 3a20 5465 6e73 6f72 2873 6861 7065  ff: Tensor(shape
-00041680: 3d74 6f72 6368 2e53 697a 6528 5b33 2c20  =torch.Size([3, 
-00041690: 335d 292c 2064 6576 6963 653d 6370 752c  3]), device=cpu,
-000416a0: 2064 7479 7065 3d74 6f72 6368 2e66 6c6f   dtype=torch.flo
-000416b0: 6174 3332 2c20 6973 5f73 6861 7265 643d  at32, is_shared=
-000416c0: 4661 6c73 6529 7d2c 0d0a 2020 2020 2020  False)},..      
-000416d0: 2020 2020 2020 6261 7463 685f 7369 7a65        batch_size
-000416e0: 3d74 6f72 6368 2e53 697a 6528 5b33 5d29  =torch.Size([3])
-000416f0: 2c0d 0a20 2020 2020 2020 2020 2020 2064  ,..            d
-00041700: 6576 6963 653d 6370 752c 0d0a 2020 2020  evice=cpu,..    
-00041710: 2020 2020 2020 2020 6973 5f73 6861 7265          is_share
-00041720: 643d 4661 6c73 6529 0d0a 2020 2020 2020  d=False)..      
-00041730: 2020 3e3e 3e20 2320 6966 2074 6865 206f    >>> # if the o
-00041740: 7574 7075 7420 6973 2061 6c73 6f20 616e  utput is also an
-00041750: 2069 6e70 7574 2c20 7765 206e 6565 6420   input, we need 
-00041760: 746f 2072 656e 616d 6520 6966 2062 6f74  to rename if bot
-00041770: 6820 7761 7973 3a0d 0a20 2020 2020 2020  h ways:..       
-00041780: 203e 3e3e 2066 726f 6d20 746f 7263 6872   >>> from torchr
-00041790: 6c2e 656e 7673 2e6c 6962 732e 6272 6178  l.envs.libs.brax
-000417a0: 2069 6d70 6f72 7420 4272 6178 456e 760d   import BraxEnv.
-000417b0: 0a20 2020 2020 2020 203e 3e3e 2065 6e76  .        >>> env
-000417c0: 203d 2054 7261 6e73 666f 726d 6564 456e   = TransformedEn
-000417d0: 7628 0d0a 2020 2020 2020 2020 2e2e 2e20  v(..        ... 
-000417e0: 2020 2020 4272 6178 456e 7628 2266 6173      BraxEnv("fas
-000417f0: 7422 292c 0d0a 2020 2020 2020 2020 2e2e  t"),..        ..
-00041800: 2e20 2020 2020 5265 6e61 6d65 5472 616e  .     RenameTran
-00041810: 7366 6f72 6d28 5b22 7374 6174 6522 5d2c  sform(["state"],
-00041820: 205b 226e 6577 6e61 6d65 225d 2c20 5b22   ["newname"], ["
-00041830: 7374 6174 6522 5d2c 205b 226e 6577 6e61  state"], ["newna
-00041840: 6d65 225d 290d 0a20 2020 2020 2020 202e  me"])..        .
-00041850: 2e2e 2029 0d0a 2020 2020 2020 2020 3e3e  .. )..        >>
-00041860: 3e20 5f20 3d20 656e 762e 7365 745f 7365  > _ = env.set_se
-00041870: 6564 2831 290d 0a20 2020 2020 2020 203e  ed(1)..        >
-00041880: 3e3e 2074 656e 736f 7264 6963 7420 3d20  >> tensordict = 
-00041890: 656e 762e 726f 6c6c 6f75 7428 3329 0d0a  env.rollout(3)..
-000418a0: 2020 2020 2020 2020 3e3e 3e20 6173 7365          >>> asse
-000418b0: 7274 2022 6e65 776e 616d 6522 2069 6e20  rt "newname" in 
-000418c0: 7465 6e73 6f72 6469 6374 2e6b 6579 7328  tensordict.keys(
-000418d0: 290d 0a20 2020 2020 2020 203e 3e3e 2061  )..        >>> a
-000418e0: 7373 6572 7420 2273 7461 7465 2220 6e6f  ssert "state" no
-000418f0: 7420 696e 2074 656e 736f 7264 6963 742e  t in tensordict.
-00041900: 6b65 7973 2829 0d0a 0d0a 2020 2020 2222  keys()....    ""
-00041910: 220d 0a0d 0a20 2020 2064 6566 205f 5f69  "....    def __i
-00041920: 6e69 745f 5f28 0d0a 2020 2020 2020 2020  nit__(..        
-00041930: 7365 6c66 2c20 696e 5f6b 6579 732c 206f  self, in_keys, o
-00041940: 7574 5f6b 6579 732c 2069 6e5f 6b65 7973  ut_keys, in_keys
-00041950: 5f69 6e76 3d4e 6f6e 652c 206f 7574 5f6b  _inv=None, out_k
-00041960: 6579 735f 696e 763d 4e6f 6e65 2c20 6372  eys_inv=None, cr
-00041970: 6561 7465 5f63 6f70 793d 4661 6c73 650d  eate_copy=False.
-00041980: 0a20 2020 2029 3a0d 0a20 2020 2020 2020  .    ):..       
-00041990: 2069 6620 696e 5f6b 6579 735f 696e 7620   if in_keys_inv 
-000419a0: 6973 204e 6f6e 653a 0d0a 2020 2020 2020  is None:..      
-000419b0: 2020 2020 2020 696e 5f6b 6579 735f 696e        in_keys_in
-000419c0: 7620 3d20 5b5d 0d0a 2020 2020 2020 2020  v = []..        
-000419d0: 6966 206f 7574 5f6b 6579 735f 696e 7620  if out_keys_inv 
-000419e0: 6973 204e 6f6e 653a 0d0a 2020 2020 2020  is None:..      
-000419f0: 2020 2020 2020 6f75 745f 6b65 7973 5f69        out_keys_i
-00041a00: 6e76 203d 2063 6f70 7928 696e 5f6b 6579  nv = copy(in_key
-00041a10: 735f 696e 7629 0d0a 2020 2020 2020 2020  s_inv)..        
-00041a20: 7365 6c66 2e63 7265 6174 655f 636f 7079  self.create_copy
-00041a30: 203d 2063 7265 6174 655f 636f 7079 0d0a   = create_copy..
-00041a40: 2020 2020 2020 2020 7375 7065 7228 292e          super().
-00041a50: 5f5f 696e 6974 5f5f 2869 6e5f 6b65 7973  __init__(in_keys
-00041a60: 2c20 6f75 745f 6b65 7973 2c20 696e 5f6b  , out_keys, in_k
-00041a70: 6579 735f 696e 762c 206f 7574 5f6b 6579  eys_inv, out_key
-00041a80: 735f 696e 7629 0d0a 2020 2020 2020 2020  s_inv)..        
-00041a90: 6966 206c 656e 2873 656c 662e 696e 5f6b  if len(self.in_k
-00041aa0: 6579 7329 2021 3d20 6c65 6e28 7365 6c66  eys) != len(self
-00041ab0: 2e6f 7574 5f6b 6579 7329 3a0d 0a20 2020  .out_keys):..   
-00041ac0: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-00041ad0: 616c 7565 4572 726f 7228 0d0a 2020 2020  alueError(..    
-00041ae0: 2020 2020 2020 2020 2020 2020 6622 5468              f"Th
-00041af0: 6520 6e75 6d62 6572 206f 6620 696e 5f6b  e number of in_k
-00041b00: 6579 7320 287b 6c65 6e28 7365 6c66 2e69  eys ({len(self.i
-00041b10: 6e5f 6b65 7973 297d 2920 7368 6f75 6c64  n_keys)}) should
-00041b20: 206d 6174 6368 2074 6865 206e 756d 6265   match the numbe
-00041b30: 7220 6f66 206f 7574 5f6b 6579 7320 287b  r of out_keys ({
-00041b40: 6c65 6e28 7365 6c66 2e6f 7574 5f6b 6579  len(self.out_key
-00041b50: 7329 7d29 2e22 0d0a 2020 2020 2020 2020  s)})."..        
-00041b60: 2020 2020 290d 0a20 2020 2020 2020 2069      )..        i
-00041b70: 6620 6c65 6e28 7365 6c66 2e69 6e5f 6b65  f len(self.in_ke
-00041b80: 7973 5f69 6e76 2920 213d 206c 656e 2873  ys_inv) != len(s
-00041b90: 656c 662e 6f75 745f 6b65 7973 5f69 6e76  elf.out_keys_inv
-00041ba0: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
-00041bb0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00041bc0: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
-00041bd0: 2020 2066 2254 6865 206e 756d 6265 7220     f"The number 
-00041be0: 6f66 2069 6e5f 6b65 7973 5f69 6e76 2028  of in_keys_inv (
-00041bf0: 7b6c 656e 2873 656c 662e 696e 5f6b 6579  {len(self.in_key
-00041c00: 735f 696e 7629 7d29 2073 686f 756c 6420  s_inv)}) should 
-00041c10: 6d61 7463 6820 7468 6520 6e75 6d62 6572  match the number
-00041c20: 206f 6620 6f75 745f 6b65 7973 5f69 6e76   of out_keys_inv
-00041c30: 2028 7b6c 656e 2873 656c 662e 6f75 745f   ({len(self.out_
-00041c40: 6b65 7973 297d 292e 220d 0a20 2020 2020  keys)})."..     
-00041c50: 2020 2020 2020 2029 0d0a 2020 2020 2020         )..      
-00041c60: 2020 6966 206c 656e 2873 6574 286f 7574    if len(set(out
-00041c70: 5f6b 6579 7329 2e69 6e74 6572 7365 6374  _keys).intersect
-00041c80: 696f 6e28 696e 5f6b 6579 7329 293a 0d0a  ion(in_keys)):..
-00041c90: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00041ca0: 6520 5661 6c75 6545 7272 6f72 280d 0a20  e ValueError(.. 
-00041cb0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00041cc0: 2243 616e 6e6f 7420 6861 7665 206d 6174  "Cannot have mat
-00041cd0: 6368 696e 6720 696e 2061 6e64 206f 7574  ching in and out
-00041ce0: 5f6b 6579 7320 6265 6361 7573 6520 6f72  _keys because or
-00041cf0: 6465 7220 6973 2075 6e63 6c65 6172 2e20  der is unclear. 
-00041d00: 220d 0a20 2020 2020 2020 2020 2020 2020  "..             
-00041d10: 2020 2066 2250 6c65 6173 6520 7573 6520     f"Please use 
-00041d20: 7365 7061 7261 7465 6420 7472 616e 7366  separated transf
-00041d30: 6f72 6d73 2e20 220d 0a20 2020 2020 2020  orms. "..       
-00041d40: 2020 2020 2020 2020 2066 2247 6f74 2069           f"Got i
-00041d50: 6e5f 6b65 7973 3d7b 696e 5f6b 6579 737d  n_keys={in_keys}
-00041d60: 2061 6e64 206f 7574 5f6b 6579 733d 7b6f   and out_keys={o
-00041d70: 7574 5f6b 6579 737d 2e22 0d0a 2020 2020  ut_keys}."..    
-00041d80: 2020 2020 2020 2020 290d 0a0d 0a20 2020          )....   
-00041d90: 2064 6566 205f 6361 6c6c 2873 656c 662c   def _call(self,
-00041da0: 2074 656e 736f 7264 6963 743a 2054 656e   tensordict: Ten
-00041db0: 736f 7244 6963 7442 6173 6529 202d 3e20  sorDictBase) -> 
-00041dc0: 5465 6e73 6f72 4469 6374 4261 7365 3a0d  TensorDictBase:.
-00041dd0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00041de0: 2e63 7265 6174 655f 636f 7079 3a0d 0a20  .create_copy:.. 
-00041df0: 2020 2020 2020 2020 2020 206f 7574 203d             out =
-00041e00: 2074 656e 736f 7264 6963 742e 7365 6c65   tensordict.sele
-00041e10: 6374 282a 7365 6c66 2e69 6e5f 6b65 7973  ct(*self.in_keys
-00041e20: 2c20 7374 7269 6374 3d6e 6f74 2073 656c  , strict=not sel
-00041e30: 662e 5f6d 6973 7369 6e67 5f74 6f6c 6572  f._missing_toler
-00041e40: 616e 6365 290d 0a20 2020 2020 2020 2020  ance)..         
-00041e50: 2020 2066 6f72 2069 6e5f 6b65 792c 206f     for in_key, o
-00041e60: 7574 5f6b 6579 2069 6e20 7a69 7028 7365  ut_key in zip(se
-00041e70: 6c66 2e69 6e5f 6b65 7973 2c20 7365 6c66  lf.in_keys, self
-00041e80: 2e6f 7574 5f6b 6579 7329 3a0d 0a20 2020  .out_keys):..   
-00041e90: 2020 2020 2020 2020 2020 2020 2074 7279               try
-00041ea0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-00041eb0: 2020 2020 2020 2074 656e 736f 7264 6963         tensordic
-00041ec0: 742e 7265 6e61 6d65 5f6b 6579 5f28 696e  t.rename_key_(in
-00041ed0: 5f6b 6579 2c20 6f75 745f 6b65 7929 0d0a  _key, out_key)..
-00041ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041ef0: 6578 6365 7074 204b 6579 4572 726f 723a  except KeyError:
-00041f00: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00041f10: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
-00041f20: 662e 5f6d 6973 7369 6e67 5f74 6f6c 6572  f._missing_toler
-00041f30: 616e 6365 3a0d 0a20 2020 2020 2020 2020  ance:..         
-00041f40: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00041f50: 6169 7365 0d0a 2020 2020 2020 2020 2020  aise..          
-00041f60: 2020 7465 6e73 6f72 6469 6374 203d 2074    tensordict = t
-00041f70: 656e 736f 7264 6963 742e 7570 6461 7465  ensordict.update
-00041f80: 286f 7574 290d 0a20 2020 2020 2020 2065  (out)..        e
-00041f90: 6c73 653a 0d0a 2020 2020 2020 2020 2020  lse:..          
-00041fa0: 2020 666f 7220 696e 5f6b 6579 2c20 6f75    for in_key, ou
-00041fb0: 745f 6b65 7920 696e 207a 6970 2873 656c  t_key in zip(sel
-00041fc0: 662e 696e 5f6b 6579 732c 2073 656c 662e  f.in_keys, self.
-00041fd0: 6f75 745f 6b65 7973 293a 0d0a 2020 2020  out_keys):..    
-00041fe0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00041ff0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00042000: 2020 2020 2020 7465 6e73 6f72 6469 6374        tensordict
-00042010: 2e72 656e 616d 655f 6b65 795f 2869 6e5f  .rename_key_(in_
-00042020: 6b65 792c 206f 7574 5f6b 6579 290d 0a20  key, out_key).. 
-00042030: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00042040: 7863 6570 7420 4b65 7945 7272 6f72 3a0d  xcept KeyError:.
-00042050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00042060: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
-00042070: 2e5f 6d69 7373 696e 675f 746f 6c65 7261  ._missing_tolera
-00042080: 6e63 653a 0d0a 2020 2020 2020 2020 2020  nce:..          
-00042090: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-000420a0: 6973 650d 0a20 2020 2020 2020 2072 6574  ise..        ret
-000420b0: 7572 6e20 7465 6e73 6f72 6469 6374 0d0a  urn tensordict..
-000420c0: 0d0a 2020 2020 666f 7277 6172 6420 3d20  ..    forward = 
-000420d0: 5f63 616c 6c0d 0a0d 0a20 2020 2064 6566  _call....    def
-000420e0: 205f 7265 7365 7428 0d0a 2020 2020 2020   _reset(..      
-000420f0: 2020 7365 6c66 2c20 7465 6e73 6f72 6469    self, tensordi
-00042100: 6374 3a20 5465 6e73 6f72 4469 6374 4261  ct: TensorDictBa
-00042110: 7365 2c20 7465 6e73 6f72 6469 6374 5f72  se, tensordict_r
-00042120: 6573 6574 3a20 5465 6e73 6f72 4469 6374  eset: TensorDict
-00042130: 4261 7365 0d0a 2020 2020 2920 2d3e 2054  Base..    ) -> T
-00042140: 656e 736f 7244 6963 7442 6173 653a 0d0a  ensorDictBase:..
-00042150: 2020 2020 2020 2020 7769 7468 205f 7365          with _se
-00042160: 745f 6d69 7373 696e 675f 746f 6c65 7261  t_missing_tolera
-00042170: 6e63 6528 7365 6c66 2c20 5472 7565 293a  nce(self, True):
-00042180: 0d0a 2020 2020 2020 2020 2020 2020 7265  ..            re
-00042190: 7475 726e 2073 656c 662e 5f63 616c 6c28  turn self._call(
-000421a0: 7465 6e73 6f72 6469 6374 5f72 6573 6574  tensordict_reset
-000421b0: 290d 0a0d 0a20 2020 2064 6566 205f 696e  )....    def _in
-000421c0: 765f 6361 6c6c 2873 656c 662c 2074 656e  v_call(self, ten
-000421d0: 736f 7264 6963 743a 2054 656e 736f 7244  sordict: TensorD
-000421e0: 6963 7442 6173 6529 202d 3e20 5465 6e73  ictBase) -> Tens
-000421f0: 6f72 4469 6374 4261 7365 3a0d 0a20 2020  orDictBase:..   
-00042200: 2020 2020 2023 206e 6f20 696e 2d70 6c61       # no in-pla
-00042210: 6365 206d 6f64 6966 0d0a 2020 2020 2020  ce modif..      
-00042220: 2020 6966 2073 656c 662e 6372 6561 7465    if self.create
-00042230: 5f63 6f70 793a 0d0a 2020 2020 2020 2020  _copy:..        
-00042240: 2020 2020 6f75 7420 3d20 7465 6e73 6f72      out = tensor
-00042250: 6469 6374 2e73 656c 6563 7428 0d0a 2020  dict.select(..  
-00042260: 2020 2020 2020 2020 2020 2020 2020 2a73                *s
-00042270: 656c 662e 6f75 745f 6b65 7973 5f69 6e76  elf.out_keys_inv
-00042280: 2c20 7374 7269 6374 3d6e 6f74 2073 656c  , strict=not sel
-00042290: 662e 5f6d 6973 7369 6e67 5f74 6f6c 6572  f._missing_toler
-000422a0: 616e 6365 0d0a 2020 2020 2020 2020 2020  ance..          
-000422b0: 2020 290d 0a20 2020 2020 2020 2020 2020    )..           
-000422c0: 2066 6f72 2069 6e5f 6b65 792c 206f 7574   for in_key, out
-000422d0: 5f6b 6579 2069 6e20 7a69 7028 7365 6c66  _key in zip(self
-000422e0: 2e69 6e5f 6b65 7973 5f69 6e76 2c20 7365  .in_keys_inv, se
-000422f0: 6c66 2e6f 7574 5f6b 6579 735f 696e 7629  lf.out_keys_inv)
-00042300: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-00042310: 2020 2074 7279 3a0d 0a20 2020 2020 2020     try:..       
-00042320: 2020 2020 2020 2020 2020 2020 206f 7574               out
-00042330: 2e72 656e 616d 655f 6b65 795f 286f 7574  .rename_key_(out
-00042340: 5f6b 6579 2c20 696e 5f6b 6579 290d 0a20  _key, in_key).. 
-00042350: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00042360: 7863 6570 7420 4b65 7945 7272 6f72 3a0d  xcept KeyError:.
-00042370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00042380: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
-00042390: 2e5f 6d69 7373 696e 675f 746f 6c65 7261  ._missing_tolera
-000423a0: 6e63 653a 0d0a 2020 2020 2020 2020 2020  nce:..          
-000423b0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-000423c0: 6973 650d 0a0d 0a20 2020 2020 2020 2020  ise....         
-000423d0: 2020 2074 656e 736f 7264 6963 7420 3d20     tensordict = 
-000423e0: 7465 6e73 6f72 6469 6374 2e75 7064 6174  tensordict.updat
-000423f0: 6528 6f75 7429 0d0a 2020 2020 2020 2020  e(out)..        
-00042400: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
-00042410: 2020 2066 6f72 2069 6e5f 6b65 792c 206f     for in_key, o
-00042420: 7574 5f6b 6579 2069 6e20 7a69 7028 7365  ut_key in zip(se
-00042430: 6c66 2e69 6e5f 6b65 7973 5f69 6e76 2c20  lf.in_keys_inv, 
-00042440: 7365 6c66 2e6f 7574 5f6b 6579 735f 696e  self.out_keys_in
-00042450: 7629 3a0d 0a20 2020 2020 2020 2020 2020  v):..           
-00042460: 2020 2020 2074 7279 3a0d 0a20 2020 2020       try:..     
-00042470: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00042480: 656e 736f 7264 6963 742e 7265 6e61 6d65  ensordict.rename
-00042490: 5f6b 6579 5f28 6f75 745f 6b65 792c 2069  _key_(out_key, i
-000424a0: 6e5f 6b65 7929 0d0a 2020 2020 2020 2020  n_key)..        
-000424b0: 2020 2020 2020 2020 6578 6365 7074 204b          except K
-000424c0: 6579 4572 726f 723a 0d0a 2020 2020 2020  eyError:..      
-000424d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000424e0: 206e 6f74 2073 656c 662e 5f6d 6973 7369   not self._missi
-000424f0: 6e67 5f74 6f6c 6572 616e 6365 3a0d 0a20  ng_tolerance:.. 
-00042500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042510: 2020 2020 2020 2072 6169 7365 0d0a 2020         raise..  
-00042520: 2020 2020 2020 7265 7475 726e 2074 656e        return ten
-00042530: 736f 7264 6963 740d 0a0d 0a20 2020 2064  sordict....    d
-00042540: 6566 2074 7261 6e73 666f 726d 5f6f 7574  ef transform_out
-00042550: 7075 745f 7370 6563 2873 656c 662c 206f  put_spec(self, o
-00042560: 7574 7075 745f 7370 6563 3a20 436f 6d70  utput_spec: Comp
-00042570: 6f73 6974 6553 7065 6329 202d 3e20 436f  ositeSpec) -> Co
-00042580: 6d70 6f73 6974 6553 7065 633a 0d0a 2020  mpositeSpec:..  
-00042590: 2020 2020 2020 666f 7220 646f 6e65 5f6b        for done_k
-000425a0: 6579 2069 6e20 7365 6c66 2e70 6172 656e  ey in self.paren
-000425b0: 742e 646f 6e65 5f6b 6579 733a 0d0a 2020  t.done_keys:..  
-000425c0: 2020 2020 2020 2020 2020 6966 2064 6f6e            if don
-000425d0: 655f 6b65 7920 696e 2073 656c 662e 696e  e_key in self.in
-000425e0: 5f6b 6579 733a 0d0a 2020 2020 2020 2020  _keys:..        
-000425f0: 2020 2020 2020 2020 666f 7220 692c 206f          for i, o
-00042600: 7574 5f6b 6579 2069 6e20 656e 756d 6572  ut_key in enumer
-00042610: 6174 6528 7365 6c66 2e6f 7574 5f6b 6579  ate(self.out_key
-00042620: 7329 3a20 2023 206e 6f71 613a 2042 3030  s):  # noqa: B00
-00042630: 370d 0a20 2020 2020 2020 2020 2020 2020  7..             
-00042640: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
-00042650: 6e5f 6b65 7973 5b69 5d20 3d3d 2064 6f6e  n_keys[i] == don
-00042660: 655f 6b65 793a 0d0a 2020 2020 2020 2020  e_key:..        
-00042670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042680: 6272 6561 6b0d 0a20 2020 2020 2020 2020  break..         
-00042690: 2020 2020 2020 2065 6c73 653a 0d0a 2020         else:..  
-000426a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000426b0: 2020 2320 756e 7265 6163 6861 626c 650d    # unreachable.
-000426c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000426d0: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
-000426e0: 6d65 4572 726f 720d 0a20 2020 2020 2020  meError..       
-000426f0: 2020 2020 2020 2020 206f 7574 7075 745f           output_
-00042700: 7370 6563 5b22 6675 6c6c 5f64 6f6e 655f  spec["full_done_
-00042710: 7370 6563 225d 5b6f 7574 5f6b 6579 5d20  spec"][out_key] 
-00042720: 3d20 6f75 7470 7574 5f73 7065 635b 2266  = output_spec["f
-00042730: 756c 6c5f 646f 6e65 5f73 7065 6322 5d5b  ull_done_spec"][
-00042740: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00042750: 2020 2020 2020 646f 6e65 5f6b 6579 0d0a        done_key..
-00042760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042770: 5d2e 636c 6f6e 6528 290d 0a20 2020 2020  ].clone()..     
-00042780: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00042790: 7420 7365 6c66 2e63 7265 6174 655f 636f  t self.create_co
-000427a0: 7079 3a0d 0a20 2020 2020 2020 2020 2020  py:..           
-000427b0: 2020 2020 2020 2020 2064 656c 206f 7574           del out
-000427c0: 7075 745f 7370 6563 5b22 6675 6c6c 5f64  put_spec["full_d
-000427d0: 6f6e 655f 7370 6563 225d 5b64 6f6e 655f  one_spec"][done_
-000427e0: 6b65 795d 0d0a 2020 2020 2020 2020 666f  key]..        fo
-000427f0: 7220 7265 7761 7264 5f6b 6579 2069 6e20  r reward_key in 
-00042800: 7365 6c66 2e70 6172 656e 742e 7265 7761  self.parent.rewa
-00042810: 7264 5f6b 6579 733a 0d0a 2020 2020 2020  rd_keys:..      
-00042820: 2020 2020 2020 6966 2072 6577 6172 645f        if reward_
-00042830: 6b65 7920 696e 2073 656c 662e 696e 5f6b  key in self.in_k
-00042840: 6579 733a 0d0a 2020 2020 2020 2020 2020  eys:..          
-00042850: 2020 2020 2020 666f 7220 692c 206f 7574        for i, out
-00042860: 5f6b 6579 2069 6e20 656e 756d 6572 6174  _key in enumerat
-00042870: 6528 7365 6c66 2e6f 7574 5f6b 6579 7329  e(self.out_keys)
-00042880: 3a20 2023 206e 6f71 613a 2042 3030 370d  :  # noqa: B007.
-00042890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000428a0: 2020 2020 2069 6620 7365 6c66 2e69 6e5f       if self.in_
-000428b0: 6b65 7973 5b69 5d20 3d3d 2072 6577 6172  keys[i] == rewar
-000428c0: 645f 6b65 793a 0d0a 2020 2020 2020 2020  d_key:..        
-000428d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000428e0: 6272 6561 6b0d 0a20 2020 2020 2020 2020  break..         
-000428f0: 2020 2020 2020 2065 6c73 653a 0d0a 2020         else:..  
-00042900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042910: 2020 2320 756e 7265 6163 6861 626c 650d    # unreachable.
-00042920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00042930: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
-00042940: 6d65 4572 726f 720d 0a20 2020 2020 2020  meError..       
-00042950: 2020 2020 2020 2020 206f 7574 7075 745f           output_
-00042960: 7370 6563 5b22 6675 6c6c 5f72 6577 6172  spec["full_rewar
-00042970: 645f 7370 6563 225d 5b6f 7574 5f6b 6579  d_spec"][out_key
-00042980: 5d20 3d20 6f75 7470 7574 5f73 7065 635b  ] = output_spec[
-00042990: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000429a0: 2020 2020 2020 2266 756c 6c5f 7265 7761        "full_rewa
-000429b0: 7264 5f73 7065 6322 0d0a 2020 2020 2020  rd_spec"..      
-000429c0: 2020 2020 2020 2020 2020 5d5b 7265 7761            ][rewa
-000429d0: 7264 5f6b 6579 5d2e 636c 6f6e 6528 290d  rd_key].clone().
-000429e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000429f0: 2069 6620 6e6f 7420 7365 6c66 2e63 7265   if not self.cre
-00042a00: 6174 655f 636f 7079 3a0d 0a20 2020 2020  ate_copy:..     
-00042a10: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00042a20: 656c 206f 7574 7075 745f 7370 6563 5b22  el output_spec["
-00042a30: 6675 6c6c 5f72 6577 6172 645f 7370 6563  full_reward_spec
-00042a40: 225d 5b72 6577 6172 645f 6b65 795d 0d0a  "][reward_key]..
-00042a50: 2020 2020 2020 2020 666f 7220 6f62 7365          for obse
-00042a60: 7276 6174 696f 6e5f 6b65 7920 696e 2073  rvation_key in s
-00042a70: 656c 662e 7061 7265 6e74 2e66 756c 6c5f  elf.parent.full_
-00042a80: 6f62 7365 7276 6174 696f 6e5f 7370 6563  observation_spec
-00042a90: 2e6b 6579 7328 5472 7565 293a 0d0a 2020  .keys(True):..  
-00042aa0: 2020 2020 2020 2020 2020 6966 206f 6273            if obs
-00042ab0: 6572 7661 7469 6f6e 5f6b 6579 2069 6e20  ervation_key in 
-00042ac0: 7365 6c66 2e69 6e5f 6b65 7973 3a0d 0a20  self.in_keys:.. 
-00042ad0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00042ae0: 6f72 2069 2c20 6f75 745f 6b65 7920 696e  or i, out_key in
-00042af0: 2065 6e75 6d65 7261 7465 2873 656c 662e   enumerate(self.
-00042b00: 6f75 745f 6b65 7973 293a 2020 2320 6e6f  out_keys):  # no
-00042b10: 7161 3a20 4230 3037 0d0a 2020 2020 2020  qa: B007..      
-00042b20: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00042b30: 2073 656c 662e 696e 5f6b 6579 735b 695d   self.in_keys[i]
-00042b40: 203d 3d20 6f62 7365 7276 6174 696f 6e5f   == observation_
-00042b50: 6b65 793a 0d0a 2020 2020 2020 2020 2020  key:..          
-00042b60: 2020 2020 2020 2020 2020 2020 2020 6272                br
-00042b70: 6561 6b0d 0a20 2020 2020 2020 2020 2020  eak..           
-00042b80: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
-00042b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042ba0: 2320 756e 7265 6163 6861 626c 650d 0a20  # unreachable.. 
-00042bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042bc0: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
-00042bd0: 4572 726f 720d 0a20 2020 2020 2020 2020  Error..         
-00042be0: 2020 2020 2020 206f 7574 7075 745f 7370         output_sp
-00042bf0: 6563 5b22 6675 6c6c 5f6f 6273 6572 7661  ec["full_observa
-00042c00: 7469 6f6e 5f73 7065 6322 5d5b 6f75 745f  tion_spec"][out_
-00042c10: 6b65 795d 203d 206f 7574 7075 745f 7370  key] = output_sp
-00042c20: 6563 5b0d 0a20 2020 2020 2020 2020 2020  ec[..           
-00042c30: 2020 2020 2020 2020 2022 6675 6c6c 5f6f           "full_o
-00042c40: 6273 6572 7661 7469 6f6e 5f73 7065 6322  bservation_spec"
-00042c50: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00042c60: 2020 5d5b 6f62 7365 7276 6174 696f 6e5f    ][observation_
-00042c70: 6b65 795d 2e63 6c6f 6e65 2829 0d0a 2020  key].clone()..  
-00042c80: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00042c90: 206e 6f74 2073 656c 662e 6372 6561 7465   not self.create
-00042ca0: 5f63 6f70 793a 0d0a 2020 2020 2020 2020  _copy:..        
-00042cb0: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
-00042cc0: 6f75 7470 7574 5f73 7065 635b 2266 756c  output_spec["ful
-00042cd0: 6c5f 6f62 7365 7276 6174 696f 6e5f 7370  l_observation_sp
-00042ce0: 6563 225d 5b6f 6273 6572 7661 7469 6f6e  ec"][observation
-00042cf0: 5f6b 6579 5d0d 0a20 2020 2020 2020 2072  _key]..        r
-00042d00: 6574 7572 6e20 6f75 7470 7574 5f73 7065  eturn output_spe
-00042d10: 630d 0a0d 0a20 2020 2064 6566 2074 7261  c....    def tra
-00042d20: 6e73 666f 726d 5f69 6e70 7574 5f73 7065  nsform_input_spe
-00042d30: 6328 7365 6c66 2c20 696e 7075 745f 7370  c(self, input_sp
-00042d40: 6563 3a20 436f 6d70 6f73 6974 6553 7065  ec: CompositeSpe
-00042d50: 6329 202d 3e20 436f 6d70 6f73 6974 6553  c) -> CompositeS
-00042d60: 7065 633a 0d0a 2020 2020 2020 2020 666f  pec:..        fo
-00042d70: 7220 6163 7469 6f6e 5f6b 6579 2069 6e20  r action_key in 
-00042d80: 7365 6c66 2e70 6172 656e 742e 6163 7469  self.parent.acti
-00042d90: 6f6e 5f6b 6579 733a 0d0a 2020 2020 2020  on_keys:..      
-00042da0: 2020 2020 2020 6966 2061 6374 696f 6e5f        if action_
-00042db0: 6b65 7920 696e 2073 656c 662e 696e 5f6b  key in self.in_k
-00042dc0: 6579 733a 0d0a 2020 2020 2020 2020 2020  eys:..          
-00042dd0: 2020 2020 2020 666f 7220 692c 206f 7574        for i, out
-00042de0: 5f6b 6579 2069 6e20 656e 756d 6572 6174  _key in enumerat
-00042df0: 6528 7365 6c66 2e6f 7574 5f6b 6579 7329  e(self.out_keys)
-00042e00: 3a20 2023 206e 6f71 613a 2042 3030 370d  :  # noqa: B007.
-00042e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00042e20: 2020 2020 2069 6620 7365 6c66 2e69 6e5f       if self.in_
-00042e30: 6b65 7973 5b69 5d20 3d3d 2061 6374 696f  keys[i] == actio
-00042e40: 6e5f 6b65 793a 0d0a 2020 2020 2020 2020  n_key:..        
-00042e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042e60: 6272 6561 6b0d 0a20 2020 2020 2020 2020  break..         
-00042e70: 2020 2020 2020 2065 6c73 653a 0d0a 2020         else:..  
-00042e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042e90: 2020 2320 756e 7265 6163 6861 626c 650d    # unreachable.
-00042ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00042eb0: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
-00042ec0: 6d65 4572 726f 720d 0a20 2020 2020 2020  meError..       
-00042ed0: 2020 2020 2020 2020 2069 6e70 7574 5f73           input_s
-00042ee0: 7065 635b 2266 756c 6c5f 6163 7469 6f6e  pec["full_action
-00042ef0: 5f73 7065 6322 5d5b 6f75 745f 6b65 795d  _spec"][out_key]
-00042f00: 203d 2069 6e70 7574 5f73 7065 635b 0d0a   = input_spec[..
-00042f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042f20: 2020 2020 2266 756c 6c5f 6163 7469 6f6e      "full_action
-00042f30: 5f73 7065 6322 0d0a 2020 2020 2020 2020  _spec"..        
-00042f40: 2020 2020 2020 2020 5d5b 6163 7469 6f6e          ][action
-00042f50: 5f6b 6579 5d2e 636c 6f6e 6528 290d 0a20  _key].clone().. 
-00042f60: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00042f70: 6620 6e6f 7420 7365 6c66 2e63 7265 6174  f not self.creat
-00042f80: 655f 636f 7079 3a0d 0a20 2020 2020 2020  e_copy:..       
-00042f90: 2020 2020 2020 2020 2020 2020 2064 656c               del
-00042fa0: 2069 6e70 7574 5f73 7065 635b 2266 756c   input_spec["ful
-00042fb0: 6c5f 6163 7469 6f6e 5f73 7065 6322 5d5b  l_action_spec"][
-00042fc0: 6163 7469 6f6e 5f6b 6579 5d0d 0a20 2020  action_key]..   
-00042fd0: 2020 2020 2066 6f72 2073 7461 7465 5f6b       for state_k
-00042fe0: 6579 2069 6e20 7365 6c66 2e70 6172 656e  ey in self.paren
-00042ff0: 742e 6675 6c6c 5f73 7461 7465 5f73 7065  t.full_state_spe
-00043000: 632e 6b65 7973 2854 7275 6529 3a0d 0a20  c.keys(True):.. 
-00043010: 2020 2020 2020 2020 2020 2069 6620 7374             if st
-00043020: 6174 655f 6b65 7920 696e 2073 656c 662e  ate_key in self.
-00043030: 696e 5f6b 6579 733a 0d0a 2020 2020 2020  in_keys:..      
-00043040: 2020 2020 2020 2020 2020 666f 7220 692c            for i,
-00043050: 206f 7574 5f6b 6579 2069 6e20 656e 756d   out_key in enum
-00043060: 6572 6174 6528 7365 6c66 2e6f 7574 5f6b  erate(self.out_k
-00043070: 6579 7329 3a20 2023 206e 6f71 613a 2042  eys):  # noqa: B
-00043080: 3030 370d 0a20 2020 2020 2020 2020 2020  007..           
-00043090: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-000430a0: 2e69 6e5f 6b65 7973 5b69 5d20 3d3d 2073  .in_keys[i] == s
-000430b0: 7461 7465 5f6b 6579 3a0d 0a20 2020 2020  tate_key:..     
-000430c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000430d0: 2020 2062 7265 616b 0d0a 2020 2020 2020     break..      
-000430e0: 2020 2020 2020 2020 2020 656c 7365 3a0d            else:.
-000430f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00043100: 2020 2020 2023 2075 6e72 6561 6368 6162       # unreachab
-00043110: 6c65 0d0a 2020 2020 2020 2020 2020 2020  le..            
-00043120: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
-00043130: 6e74 696d 6545 7272 6f72 0d0a 2020 2020  ntimeError..    
-00043140: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
-00043150: 745f 7370 6563 5b22 6675 6c6c 5f73 7461  t_spec["full_sta
-00043160: 7465 5f73 7065 6322 5d5b 6f75 745f 6b65  te_spec"][out_ke
-00043170: 795d 203d 2069 6e70 7574 5f73 7065 635b  y] = input_spec[
-00043180: 2266 756c 6c5f 7374 6174 655f 7370 6563  "full_state_spec
-00043190: 225d 5b0d 0a20 2020 2020 2020 2020 2020  "][..           
-000431a0: 2020 2020 2020 2020 2073 7461 7465 5f6b           state_k
-000431b0: 6579 0d0a 2020 2020 2020 2020 2020 2020  ey..            
-000431c0: 2020 2020 5d2e 636c 6f6e 6528 290d 0a20      ].clone().. 
-000431d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000431e0: 6620 6e6f 7420 7365 6c66 2e63 7265 6174  f not self.creat
-000431f0: 655f 636f 7079 3a0d 0a20 2020 2020 2020  e_copy:..       
-00043200: 2020 2020 2020 2020 2020 2020 2064 656c               del
-00043210: 2069 6e70 7574 5f73 7065 635b 2266 756c   input_spec["ful
-00043220: 6c5f 7374 6174 655f 7370 6563 225d 5b73  l_state_spec"][s
-00043230: 7461 7465 5f6b 6579 5d0d 0a20 2020 2020  tate_key]..     
-00043240: 2020 2072 6574 7572 6e20 696e 7075 745f     return input_
-00043250: 7370 6563 0d0a 0d0a 0d0a 636c 6173 7320  spec......class 
-00043260: 5265 7761 7264 3247 6f54 7261 6e73 666f  Reward2GoTransfo
-00043270: 726d 2854 7261 6e73 666f 726d 293a 0d0a  rm(Transform):..
-00043280: 2020 2020 2222 2243 616c 6375 6c61 7465      """Calculate
-00043290: 7320 7468 6520 7265 7761 7264 2074 6f20  s the reward to 
-000432a0: 676f 2062 6173 6564 206f 6e20 7468 6520  go based on the 
-000432b0: 6570 6973 6f64 6520 7265 7761 7264 2061  episode reward a
-000432c0: 6e64 2061 2064 6973 636f 756e 7420 6661  nd a discount fa
-000432d0: 6374 6f72 2e0d 0a0d 0a20 2020 2041 7320  ctor.....    As 
-000432e0: 7468 6520 3a63 6c61 7373 3a60 7e2e 5265  the :class:`~.Re
-000432f0: 7761 7264 3247 6f54 7261 6e73 666f 726d  ward2GoTransform
-00043300: 6020 6973 206f 6e6c 7920 616e 2069 6e76  ` is only an inv
-00043310: 6572 7365 2074 7261 6e73 666f 726d 2074  erse transform t
-00043320: 6865 2060 6069 6e5f 6b65 7973 6060 2077  he ``in_keys`` w
-00043330: 696c 6c20 6265 2064 6972 6563 746c 7920  ill be directly 
-00043340: 7573 6564 2066 6f72 2074 6865 2060 6069  used for the ``i
-00043350: 6e5f 6b65 7973 5f69 6e76 6060 2e0d 0a20  n_keys_inv``... 
-00043360: 2020 2054 6865 2072 6577 6172 642d 746f     The reward-to
-00043370: 2d67 6f20 6361 6e20 6265 206f 6e6c 7920  -go can be only 
-00043380: 6361 6c63 756c 6174 6564 206f 6e63 6520  calculated once 
-00043390: 7468 6520 6570 6973 6f64 6520 6973 2066  the episode is f
-000433a0: 696e 6973 6865 642e 2054 6865 7265 666f  inished. Therefo
-000433b0: 7265 2c20 7468 6520 7472 616e 7366 6f72  re, the transfor
-000433c0: 6d20 7368 6f75 6c64 2062 6520 6170 706c  m should be appl
-000433d0: 6965 6420 746f 2074 6865 2072 6570 6c61  ied to the repla
-000433e0: 7920 6275 6666 6572 0d0a 2020 2020 616e  y buffer..    an
-000433f0: 6420 6e6f 7420 746f 2074 6865 2063 6f6c  d not to the col
-00043400: 6c65 6374 6f72 206f 7220 7769 7468 696e  lector or within
-00043410: 2061 6e20 656e 7669 726f 6e6d 656e 742e   an environment.
-00043420: 0d0a 0d0a 2020 2020 4172 6773 3a0d 0a20  ....    Args:.. 
-00043430: 2020 2020 2020 2067 616d 6d61 2028 666c         gamma (fl
-00043440: 6f61 7420 6f72 2074 6f72 6368 2e54 656e  oat or torch.Ten
-00043450: 736f 7229 3a20 7468 6520 6469 7363 6f75  sor): the discou
-00043460: 6e74 2066 6163 746f 722e 2044 6566 6175  nt factor. Defau
-00043470: 6c74 7320 746f 2031 2e30 2e0d 0a20 2020  lts to 1.0...   
-00043480: 2020 2020 2069 6e5f 6b65 7973 2028 7365       in_keys (se
-00043490: 7175 656e 6365 206f 6620 4e65 7374 6564  quence of Nested
-000434a0: 4b65 7929 3a20 7468 6520 656e 7472 6965  Key): the entrie
-000434b0: 7320 746f 2072 656e 616d 652e 2044 6566  s to rename. Def
-000434c0: 6175 6c74 7320 746f 0d0a 2020 2020 2020  aults to..      
-000434d0: 2020 2020 2020 6060 2822 6e65 7874 222c        ``("next",
-000434e0: 2022 7265 7761 7264 2229 6060 2069 6620   "reward")`` if 
-000434f0: 6e6f 6e65 2069 7320 7072 6f76 6964 6564  none is provided
-00043500: 2e0d 0a20 2020 2020 2020 206f 7574 5f6b  ...        out_k
-00043510: 6579 7320 2873 6571 7565 6e63 6520 6f66  eys (sequence of
-00043520: 204e 6573 7465 644b 6579 293a 2074 6865   NestedKey): the
-00043530: 2065 6e74 7269 6573 2074 6f20 7265 6e61   entries to rena
-00043540: 6d65 2e20 4465 6661 756c 7473 2074 6f0d  me. Defaults to.
-00043550: 0a20 2020 2020 2020 2020 2020 2074 6865  .            the
-00043560: 2076 616c 7565 7320 6f66 2060 6069 6e5f   values of ``in_
-00043570: 6b65 7973 6060 2069 6620 6e6f 6e65 2069  keys`` if none i
-00043580: 7320 7072 6f76 6964 6564 2e0d 0a20 2020  s provided...   
-00043590: 2020 2020 2064 6f6e 655f 6b65 7920 284e       done_key (N
-000435a0: 6573 7465 644b 6579 293a 2074 6865 2064  estedKey): the d
-000435b0: 6f6e 6520 656e 7472 792e 2044 6566 6175  one entry. Defau
-000435c0: 6c74 7320 746f 2060 6022 646f 6e65 2260  lts to ``"done"`
-000435d0: 602e 0d0a 2020 2020 2020 2020 7472 756e  `...        trun
-000435e0: 6361 7465 645f 6b65 7920 284e 6573 7465  cated_key (Neste
-000435f0: 644b 6579 293a 2074 6865 2074 7275 6e63  dKey): the trunc
-00043600: 6174 6564 2065 6e74 7279 2e20 4465 6661  ated entry. Defa
-00043610: 756c 7473 2074 6f20 6060 2274 7275 6e63  ults to ``"trunc
-00043620: 6174 6564 2260 602e 0d0a 2020 2020 2020  ated"``...      
-00043630: 2020 2020 2020 4966 206e 6f20 7472 756e        If no trun
-00043640: 6361 7465 6420 656e 7472 7920 6973 2066  cated entry is f
-00043650: 6f75 6e64 2c20 6f6e 6c79 2074 6865 2060  ound, only the `
-00043660: 6022 646f 6e65 2260 6020 7769 6c6c 2062  `"done"`` will b
-00043670: 6520 7573 6564 2e0d 0a0d 0a20 2020 2045  e used.....    E
-00043680: 7861 6d70 6c65 733a 0d0a 2020 2020 2020  xamples:..      
-00043690: 2020 3e3e 3e20 2320 5573 696e 6720 7468    >>> # Using th
-000436a0: 6973 2074 7261 6e73 666f 726d 2061 7320  is transform as 
-000436b0: 7061 7274 206f 6620 6120 7265 706c 6179  part of a replay
-000436c0: 2062 7566 6665 720d 0a20 2020 2020 2020   buffer..       
-000436d0: 203e 3e3e 2066 726f 6d20 746f 7263 6872   >>> from torchr
-000436e0: 6c2e 6461 7461 2069 6d70 6f72 7420 5265  l.data import Re
-000436f0: 706c 6179 4275 6666 6572 2c20 4c61 7a79  playBuffer, Lazy
-00043700: 5465 6e73 6f72 5374 6f72 6167 650d 0a20  TensorStorage.. 
-00043710: 2020 2020 2020 203e 3e3e 2074 6f72 6368         >>> torch
-00043720: 2e6d 616e 7561 6c5f 7365 6564 2830 290d  .manual_seed(0).
-00043730: 0a20 2020 2020 2020 203e 3e3e 2072 3267  .        >>> r2g
-00043740: 203d 2052 6577 6172 6432 476f 5472 616e   = Reward2GoTran
-00043750: 7366 6f72 6d28 6761 6d6d 613d 302e 3939  sform(gamma=0.99
-00043760: 2c20 6f75 745f 6b65 7973 3d5b 2272 6577  , out_keys=["rew
-00043770: 6172 645f 746f 5f67 6f22 5d29 0d0a 2020  ard_to_go"])..  
-00043780: 2020 2020 2020 3e3e 3e20 7262 203d 2052        >>> rb = R
-00043790: 6570 6c61 7942 7566 6665 7228 7374 6f72  eplayBuffer(stor
-000437a0: 6167 653d 4c61 7a79 5465 6e73 6f72 5374  age=LazyTensorSt
-000437b0: 6f72 6167 6528 3130 3029 2c20 7472 616e  orage(100), tran
-000437c0: 7366 6f72 6d3d 7232 6729 0d0a 2020 2020  sform=r2g)..    
-000437d0: 2020 2020 3e3e 3e20 6261 7463 682c 2074      >>> batch, t
-000437e0: 696d 6573 7465 7073 203d 2034 2c20 350d  imesteps = 4, 5.
-000437f0: 0a20 2020 2020 2020 203e 3e3e 2064 6f6e  .        >>> don
-00043800: 6520 3d20 746f 7263 682e 7a65 726f 7328  e = torch.zeros(
-00043810: 6261 7463 682c 2074 696d 6573 7465 7073  batch, timesteps
-00043820: 2c20 312c 2064 7479 7065 3d74 6f72 6368  , 1, dtype=torch
-00043830: 2e62 6f6f 6c29 0d0a 2020 2020 2020 2020  .bool)..        
-00043840: 3e3e 3e20 666f 7220 6920 696e 2072 616e  >>> for i in ran
-00043850: 6765 2862 6174 6368 293a 0d0a 2020 2020  ge(batch):..    
-00043860: 2020 2020 2e2e 2e20 2020 2020 7768 696c      ...     whil
-00043870: 6520 6e6f 7420 646f 6e65 5b69 5d2e 616e  e not done[i].an
-00043880: 7928 293a 0d0a 2020 2020 2020 2020 2e2e  y():..        ..
-00043890: 2e20 2020 2020 2020 2020 646f 6e65 5b69  .         done[i
-000438a0: 5d20 3d20 646f 6e65 5b69 5d2e 6265 726e  ] = done[i].bern
-000438b0: 6f75 6c6c 695f 2830 2e31 290d 0a20 2020  oulli_(0.1)..   
-000438c0: 2020 2020 203e 3e3e 2072 6577 6172 6420       >>> reward 
-000438d0: 3d20 746f 7263 682e 6f6e 6573 2862 6174  = torch.ones(bat
-000438e0: 6368 2c20 7469 6d65 7374 6570 732c 2031  ch, timesteps, 1
-000438f0: 290d 0a20 2020 2020 2020 203e 3e3e 2074  )..        >>> t
-00043900: 6420 3d20 5465 6e73 6f72 4469 6374 280d  d = TensorDict(.
-00043910: 0a20 2020 2020 2020 202e 2e2e 2020 2020  .        ...    
-00043920: 207b 226e 6578 7422 3a20 7b22 646f 6e65   {"next": {"done
-00043930: 223a 2064 6f6e 652c 2022 7265 7761 7264  ": done, "reward
-00043940: 223a 2072 6577 6172 647d 7d2c 0d0a 2020  ": reward}},..  
-00043950: 2020 2020 2020 2e2e 2e20 2020 2020 5b62        ...     [b
-00043960: 6174 6368 2c20 7469 6d65 7374 6570 735d  atch, timesteps]
-00043970: 2c0d 0a20 2020 2020 2020 202e 2e2e 2029  ,..        ... )
-00043980: 0d0a 2020 2020 2020 2020 3e3e 3e20 7262  ..        >>> rb
-00043990: 2e65 7874 656e 6428 7464 290d 0a20 2020  .extend(td)..   
-000439a0: 2020 2020 203e 3e3e 2073 616d 706c 6520       >>> sample 
-000439b0: 3d20 7262 2e73 616d 706c 6528 3129 0d0a  = rb.sample(1)..
-000439c0: 2020 2020 2020 2020 3e3e 3e20 7072 696e          >>> prin
-000439d0: 7428 7361 6d70 6c65 5b22 6e65 7874 222c  t(sample["next",
-000439e0: 2022 7265 7761 7264 225d 290d 0a20 2020   "reward"])..   
-000439f0: 2020 2020 2074 656e 736f 7228 5b5b 5b31       tensor([[[1
-00043a00: 2e5d 2c0d 0a20 2020 2020 2020 2020 2020  .],..           
-00043a10: 2020 2020 2020 5b31 2e5d 2c0d 0a20 2020        [1.],..   
-00043a20: 2020 2020 2020 2020 2020 2020 2020 5b31                [1
-00043a30: 2e5d 2c0d 0a20 2020 2020 2020 2020 2020  .],..           
-00043a40: 2020 2020 2020 5b31 2e5d 2c0d 0a20 2020        [1.],..   
-00043a50: 2020 2020 2020 2020 2020 2020 2020 5b31                [1
-00043a60: 2e5d 5d5d 290d 0a20 2020 2020 2020 203e  .]]])..        >
-00043a70: 3e3e 2070 7269 6e74 2873 616d 706c 655b  >> print(sample[
-00043a80: 2272 6577 6172 645f 746f 5f67 6f22 5d29  "reward_to_go"])
-00043a90: 0d0a 2020 2020 2020 2020 7465 6e73 6f72  ..        tensor
-00043aa0: 285b 5b5b 342e 3930 3130 5d2c 0d0a 2020  ([[[4.9010],..  
-00043ab0: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-00043ac0: 332e 3934 3034 5d2c 0d0a 2020 2020 2020  3.9404],..      
-00043ad0: 2020 2020 2020 2020 2020 205b 322e 3937             [2.97
-00043ae0: 3031 5d2c 0d0a 2020 2020 2020 2020 2020  01],..          
-00043af0: 2020 2020 2020 205b 312e 3939 3030 5d2c         [1.9900],
-00043b00: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00043b10: 2020 205b 312e 3030 3030 5d5d 5d29 0d0a     [1.0000]]])..
-00043b20: 0d0a 2020 2020 4f6e 6520 6361 6e20 616c  ..    One can al
-00043b30: 736f 2075 7365 2074 6869 7320 7472 616e  so use this tran
-00043b40: 7366 6f72 6d20 6469 7265 6374 6c79 2077  sform directly w
-00043b50: 6974 6820 6120 636f 6c6c 6563 746f 723a  ith a collector:
-00043b60: 206d 616b 6520 7375 7265 2074 6f0d 0a20   make sure to.. 
-00043b70: 2020 2061 7070 656e 6420 7468 6520 6069     append the `i
-00043b80: 6e76 6020 6d65 7468 6f64 206f 6620 7468  nv` method of th
-00043b90: 6520 7472 616e 7366 6f72 6d2e 0d0a 0d0a  e transform.....
-00043ba0: 2020 2020 4578 616d 706c 6573 3a0d 0a20      Examples:.. 
-00043bb0: 2020 2020 2020 203e 3e3e 2066 726f 6d20         >>> from 
-00043bc0: 746f 7263 6872 6c2e 656e 7673 2e75 7469  torchrl.envs.uti
-00043bd0: 6c73 2069 6d70 6f72 7420 5261 6e64 6f6d  ls import Random
-00043be0: 506f 6c69 6379 2020 2020 2020 2020 3e3e  Policy        >>
-00043bf0: 3e20 6672 6f6d 2074 6f72 6368 726c 2e63  > from torchrl.c
-00043c00: 6f6c 6c65 6374 6f72 7320 696d 706f 7274  ollectors import
-00043c10: 2053 796e 6344 6174 6143 6f6c 6c65 6374   SyncDataCollect
-00043c20: 6f72 0d0a 2020 2020 2020 2020 3e3e 3e20  or..        >>> 
-00043c30: 6672 6f6d 2074 6f72 6368 726c 2e65 6e76  from torchrl.env
-00043c40: 732e 6c69 6273 2e67 796d 2069 6d70 6f72  s.libs.gym impor
-00043c50: 7420 4779 6d45 6e76 0d0a 2020 2020 2020  t GymEnv..      
-00043c60: 2020 3e3e 3e20 7420 3d20 5265 7761 7264    >>> t = Reward
-00043c70: 3247 6f54 7261 6e73 666f 726d 2867 616d  2GoTransform(gam
-00043c80: 6d61 3d30 2e39 392c 206f 7574 5f6b 6579  ma=0.99, out_key
-00043c90: 733d 5b22 7265 7761 7264 5f74 6f5f 676f  s=["reward_to_go
-00043ca0: 225d 290d 0a20 2020 2020 2020 203e 3e3e  "])..        >>>
-00043cb0: 2065 6e76 203d 2047 796d 456e 7628 2250   env = GymEnv("P
-00043cc0: 656e 6475 6c75 6d2d 7631 2229 0d0a 2020  endulum-v1")..  
-00043cd0: 2020 2020 2020 3e3e 3e20 636f 6c6c 6563        >>> collec
-00043ce0: 746f 7220 3d20 5379 6e63 4461 7461 436f  tor = SyncDataCo
-00043cf0: 6c6c 6563 746f 7228 0d0a 2020 2020 2020  llector(..      
-00043d00: 2020 2e2e 2e20 2020 2020 656e 762c 0d0a    ...     env,..
-00043d10: 2020 2020 2020 2020 2e2e 2e20 2020 2020          ...     
-00043d20: 5261 6e64 6f6d 506f 6c69 6379 2865 6e76  RandomPolicy(env
-00043d30: 2e61 6374 696f 6e5f 7370 6563 292c 0d0a  .action_spec),..
-00043d40: 2020 2020 2020 2020 2e2e 2e20 2020 2020          ...     
-00043d50: 6672 616d 6573 5f70 6572 5f62 6174 6368  frames_per_batch
-00043d60: 3d32 3030 2c0d 0a20 2020 2020 2020 202e  =200,..        .
-00043d70: 2e2e 2020 2020 2074 6f74 616c 5f66 7261  ..     total_fra
-00043d80: 6d65 733d 2d31 2c0d 0a20 2020 2020 2020  mes=-1,..       
-00043d90: 202e 2e2e 2020 2020 2070 6f73 7470 726f   ...     postpro
-00043da0: 633d 742e 696e 760d 0a20 2020 2020 2020  c=t.inv..       
-00043db0: 202e 2e2e 2029 0d0a 2020 2020 2020 2020   ... )..        
-00043dc0: 3e3e 3e20 666f 7220 6461 7461 2069 6e20  >>> for data in 
-00043dd0: 636f 6c6c 6563 746f 723a 0d0a 2020 2020  collector:..    
-00043de0: 2020 2020 2e2e 2e20 2020 2020 6272 6561      ...     brea
-00043df0: 6b0d 0a20 2020 2020 2020 203e 3e3e 2070  k..        >>> p
-00043e00: 7269 6e74 2864 6174 6129 0d0a 2020 2020  rint(data)..    
-00043e10: 2020 2020 5465 6e73 6f72 4469 6374 280d      TensorDict(.
-00043e20: 0a20 2020 2020 2020 2020 2020 2066 6965  .            fie
-00043e30: 6c64 733d 7b0d 0a20 2020 2020 2020 2020  lds={..         
-00043e40: 2020 2020 2020 2061 6374 696f 6e3a 2054         action: T
-00043e50: 656e 736f 7228 7368 6170 653d 746f 7263  ensor(shape=torc
-00043e60: 682e 5369 7a65 285b 3230 302c 2031 5d29  h.Size([200, 1])
-00043e70: 2c20 6465 7669 6365 3d63 7075 2c20 6474  , device=cpu, dt
-00043e80: 7970 653d 746f 7263 682e 666c 6f61 7433  ype=torch.float3
-00043e90: 322c 2069 735f 7368 6172 6564 3d46 616c  2, is_shared=Fal
-00043ea0: 7365 292c 0d0a 2020 2020 2020 2020 2020  se),..          
-00043eb0: 2020 2020 2020 636f 6c6c 6563 746f 723a        collector:
-00043ec0: 2054 656e 736f 7244 6963 7428 0d0a 2020   TensorDict(..  
-00043ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043ee0: 2020 6669 656c 6473 3d7b 0d0a 2020 2020    fields={..    
-00043ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043f00: 2020 2020 7472 616a 5f69 6473 3a20 5465      traj_ids: Te
-00043f10: 6e73 6f72 2873 6861 7065 3d74 6f72 6368  nsor(shape=torch
-00043f20: 2e53 697a 6528 5b32 3030 5d29 2c20 6465  .Size([200]), de
-00043f30: 7669 6365 3d63 7075 2c20 6474 7970 653d  vice=cpu, dtype=
-00043f40: 746f 7263 682e 696e 7436 342c 2069 735f  torch.int64, is_
-00043f50: 7368 6172 6564 3d46 616c 7365 297d 2c0d  shared=False)},.
-00043f60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00043f70: 2020 2020 2062 6174 6368 5f73 697a 653d       batch_size=
-00043f80: 746f 7263 682e 5369 7a65 285b 3230 305d  torch.Size([200]
-00043f90: 292c 0d0a 2020 2020 2020 2020 2020 2020  ),..            
-00043fa0: 2020 2020 2020 2020 6465 7669 6365 3d63          device=c
-00043fb0: 7075 2c0d 0a20 2020 2020 2020 2020 2020  pu,..           
-00043fc0: 2020 2020 2020 2020 2069 735f 7368 6172           is_shar
-00043fd0: 6564 3d46 616c 7365 292c 0d0a 2020 2020  ed=False),..    
-00043fe0: 2020 2020 2020 2020 2020 2020 646f 6e65              done
-00043ff0: 3a20 5465 6e73 6f72 2873 6861 7065 3d74  : Tensor(shape=t
-00044000: 6f72 6368 2e53 697a 6528 5b32 3030 2c20  orch.Size([200, 
-00044010: 315d 292c 2064 6576 6963 653d 6370 752c  1]), device=cpu,
-00044020: 2064 7479 7065 3d74 6f72 6368 2e62 6f6f   dtype=torch.boo
-00044030: 6c2c 2069 735f 7368 6172 6564 3d46 616c  l, is_shared=Fal
-00044040: 7365 292c 0d0a 2020 2020 2020 2020 2020  se),..          
-00044050: 2020 2020 2020 6e65 7874 3a20 5465 6e73        next: Tens
-00044060: 6f72 4469 6374 280d 0a20 2020 2020 2020  orDict(..       
-00044070: 2020 2020 2020 2020 2020 2020 2066 6965               fie
-00044080: 6c64 733d 7b0d 0a20 2020 2020 2020 2020  lds={..         
-00044090: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000440a0: 6f6e 653a 2054 656e 736f 7228 7368 6170  one: Tensor(shap
-000440b0: 653d 746f 7263 682e 5369 7a65 285b 3230  e=torch.Size([20
-000440c0: 302c 2031 5d29 2c20 6465 7669 6365 3d63  0, 1]), device=c
-000440d0: 7075 2c20 6474 7970 653d 746f 7263 682e  pu, dtype=torch.
-000440e0: 626f 6f6c 2c20 6973 5f73 6861 7265 643d  bool, is_shared=
-000440f0: 4661 6c73 6529 2c0d 0a20 2020 2020 2020  False),..       
-00044100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044110: 206f 6273 6572 7661 7469 6f6e 3a20 5465   observation: Te
-00044120: 6e73 6f72 2873 6861 7065 3d74 6f72 6368  nsor(shape=torch
-00044130: 2e53 697a 6528 5b32 3030 2c20 335d 292c  .Size([200, 3]),
-00044140: 2064 6576 6963 653d 6370 752c 2064 7479   device=cpu, dty
-00044150: 7065 3d74 6f72 6368 2e66 6c6f 6174 3332  pe=torch.float32
-00044160: 2c20 6973 5f73 6861 7265 643d 4661 6c73  , is_shared=Fals
-00044170: 6529 2c0d 0a20 2020 2020 2020 2020 2020  e),..           
-00044180: 2020 2020 2020 2020 2020 2020 2072 6577               rew
-00044190: 6172 643a 2054 656e 736f 7228 7368 6170  ard: Tensor(shap
-000441a0: 653d 746f 7263 682e 5369 7a65 285b 3230  e=torch.Size([20
-000441b0: 302c 2031 5d29 2c20 6465 7669 6365 3d63  0, 1]), device=c
-000441c0: 7075 2c20 6474 7970 653d 746f 7263 682e  pu, dtype=torch.
-000441d0: 666c 6f61 7433 322c 2069 735f 7368 6172  float32, is_shar
-000441e0: 6564 3d46 616c 7365 297d 2c0d 0a20 2020  ed=False)},..   
-000441f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044200: 2062 6174 6368 5f73 697a 653d 746f 7263   batch_size=torc
-00044210: 682e 5369 7a65 285b 3230 305d 292c 0d0a  h.Size([200]),..
-00044220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044230: 2020 2020 6465 7669 6365 3d63 7075 2c0d      device=cpu,.
-00044240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00044250: 2020 2020 2069 735f 7368 6172 6564 3d46       is_shared=F
-00044260: 616c 7365 292c 0d0a 2020 2020 2020 2020  alse),..        
-00044270: 2020 2020 2020 2020 6f62 7365 7276 6174          observat
-00044280: 696f 6e3a 2054 656e 736f 7228 7368 6170  ion: Tensor(shap
-00044290: 653d 746f 7263 682e 5369 7a65 285b 3230  e=torch.Size([20
-000442a0: 302c 2033 5d29 2c20 6465 7669 6365 3d63  0, 3]), device=c
-000442b0: 7075 2c20 6474 7970 653d 746f 7263 682e  pu, dtype=torch.
-000442c0: 666c 6f61 7433 322c 2069 735f 7368 6172  float32, is_shar
-000442d0: 6564 3d46 616c 7365 292c 0d0a 2020 2020  ed=False),..    
-000442e0: 2020 2020 2020 2020 2020 2020 7265 7761              rewa
-000442f0: 7264 3a20 5465 6e73 6f72 2873 6861 7065  rd: Tensor(shape
-00044300: 3d74 6f72 6368 2e53 697a 6528 5b32 3030  =torch.Size([200
-00044310: 2c20 315d 292c 2064 6576 6963 653d 6370  , 1]), device=cp
-00044320: 752c 2064 7479 7065 3d74 6f72 6368 2e66  u, dtype=torch.f
-00044330: 6c6f 6174 3332 2c20 6973 5f73 6861 7265  loat32, is_share
-00044340: 643d 4661 6c73 6529 2c0d 0a20 2020 2020  d=False),..     
-00044350: 2020 2020 2020 2020 2020 2072 6577 6172             rewar
-00044360: 645f 746f 5f67 6f3a 2054 656e 736f 7228  d_to_go: Tensor(
-00044370: 7368 6170 653d 746f 7263 682e 5369 7a65  shape=torch.Size
-00044380: 285b 3230 302c 2031 5d29 2c20 6465 7669  ([200, 1]), devi
-00044390: 6365 3d63 7075 2c20 6474 7970 653d 746f  ce=cpu, dtype=to
-000443a0: 7263 682e 666c 6f61 7433 322c 2069 735f  rch.float32, is_
-000443b0: 7368 6172 6564 3d46 616c 7365 297d 2c0d  shared=False)},.
-000443c0: 0a20 2020 2020 2020 2020 2020 2062 6174  .            bat
-000443d0: 6368 5f73 697a 653d 746f 7263 682e 5369  ch_size=torch.Si
-000443e0: 7a65 285b 3230 305d 292c 0d0a 2020 2020  ze([200]),..    
-000443f0: 2020 2020 2020 2020 6465 7669 6365 3d63          device=c
-00044400: 7075 2c0d 0a20 2020 2020 2020 2020 2020  pu,..           
-00044410: 2069 735f 7368 6172 6564 3d46 616c 7365   is_shared=False
-00044420: 290d 0a0d 0a20 2020 2055 7369 6e67 2074  )....    Using t
-00044430: 6869 7320 7472 616e 7366 6f72 6d20 6173  his transform as
-00044440: 2070 6172 7420 6f66 2061 6e20 656e 7620   part of an env 
-00044450: 7769 6c6c 2072 6169 7365 2061 6e20 6578  will raise an ex
-00044460: 6365 7074 696f 6e0d 0a0d 0a20 2020 2045  ception....    E
-00044470: 7861 6d70 6c65 733a 0d0a 2020 2020 2020  xamples:..      
-00044480: 2020 3e3e 3e20 7420 3d20 5265 7761 7264    >>> t = Reward
-00044490: 3247 6f54 7261 6e73 666f 726d 2867 616d  2GoTransform(gam
-000444a0: 6d61 3d30 2e39 3929 0d0a 2020 2020 2020  ma=0.99)..      
-000444b0: 2020 3e3e 3e20 5472 616e 7366 6f72 6d65    >>> Transforme
-000444c0: 6445 6e76 2847 796d 456e 7628 2250 656e  dEnv(GymEnv("Pen
-000444d0: 6475 6c75 6d2d 7631 2229 2c20 7429 2020  dulum-v1"), t)  
-000444e0: 2320 6372 6173 6865 730d 0a0d 0a20 2020  # crashes....   
-000444f0: 202e 2e20 6e6f 7465 3a3a 2049 6e20 7365   .. note:: In se
-00044500: 7474 696e 6773 2077 6865 7265 206d 756c  ttings where mul
-00044510: 7469 706c 6520 646f 6e65 2065 6e74 7269  tiple done entri
-00044520: 6573 2061 7265 2070 7265 7365 6e74 2c20  es are present, 
-00044530: 6f6e 6520 7368 6f75 6c64 2062 7569 6c64  one should build
-00044540: 0d0a 2020 2020 2020 2020 6120 7369 6e67  ..        a sing
-00044550: 6c65 203a 636c 6173 733a 607e 5265 7761  le :class:`~Rewa
-00044560: 7264 3247 6f54 7261 6e73 666f 726d 6020  rd2GoTransform` 
-00044570: 666f 7220 6561 6368 2064 6f6e 652d 7265  for each done-re
-00044580: 7761 7264 2070 6169 722e 0d0a 0d0a 2020  ward pair.....  
-00044590: 2020 2222 220d 0a0d 0a20 2020 2045 4e56    """....    ENV
-000445a0: 5f45 5252 203d 2028 0d0a 2020 2020 2020  _ERR = (..      
-000445b0: 2020 2254 6865 2052 6577 6172 6432 476f    "The Reward2Go
-000445c0: 5472 616e 7366 6f72 6d20 6973 206f 6e6c  Transform is onl
-000445d0: 7920 616e 2069 6e76 6572 7365 2074 7261  y an inverse tra
-000445e0: 6e73 666f 726d 2061 6e64 2063 616e 2022  nsform and can "
-000445f0: 0d0a 2020 2020 2020 2020 226f 6e6c 7920  ..        "only 
-00044600: 6265 2061 7070 6c69 6564 2074 6f20 7468  be applied to th
-00044610: 6520 7265 706c 6179 2062 7566 6665 722e  e replay buffer.
-00044620: 220d 0a20 2020 2029 0d0a 0d0a 2020 2020  "..    )....    
-00044630: 6465 6620 5f5f 696e 6974 5f5f 280d 0a20  def __init__(.. 
-00044640: 2020 2020 2020 2073 656c 662c 0d0a 2020         self,..  
-00044650: 2020 2020 2020 6761 6d6d 613a 204f 7074        gamma: Opt
-00044660: 696f 6e61 6c5b 556e 696f 6e5b 666c 6f61  ional[Union[floa
-00044670: 742c 2074 6f72 6368 2e54 656e 736f 725d  t, torch.Tensor]
-00044680: 5d20 3d20 312e 302c 0d0a 2020 2020 2020  ] = 1.0,..      
-00044690: 2020 696e 5f6b 6579 733a 2053 6571 7565    in_keys: Seque
-000446a0: 6e63 655b 4e65 7374 6564 4b65 795d 207c  nce[NestedKey] |
-000446b0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0d 0a20   None = None,.. 
-000446c0: 2020 2020 2020 206f 7574 5f6b 6579 733a         out_keys:
-000446d0: 2053 6571 7565 6e63 655b 4e65 7374 6564   Sequence[Nested
-000446e0: 4b65 795d 207c 204e 6f6e 6520 3d20 4e6f  Key] | None = No
-000446f0: 6e65 2c0d 0a20 2020 2020 2020 2064 6f6e  ne,..        don
-00044700: 655f 6b65 793a 204f 7074 696f 6e61 6c5b  e_key: Optional[
-00044710: 4e65 7374 6564 4b65 795d 203d 2022 646f  NestedKey] = "do
-00044720: 6e65 222c 0d0a 2020 2020 293a 0d0a 2020  ne",..    ):..  
-00044730: 2020 2020 2020 6966 2069 6e5f 6b65 7973        if in_keys
-00044740: 2069 7320 4e6f 6e65 3a0d 0a20 2020 2020   is None:..     
-00044750: 2020 2020 2020 2069 6e5f 6b65 7973 203d         in_keys =
-00044760: 205b 2822 6e65 7874 222c 2022 7265 7761   [("next", "rewa
-00044770: 7264 2229 5d0d 0a20 2020 2020 2020 2069  rd")]..        i
-00044780: 6620 6f75 745f 6b65 7973 2069 7320 4e6f  f out_keys is No
-00044790: 6e65 3a0d 0a20 2020 2020 2020 2020 2020  ne:..           
-000447a0: 206f 7574 5f6b 6579 7320 3d20 636f 7079   out_keys = copy
-000447b0: 2869 6e5f 6b65 7973 290d 0a20 2020 2020  (in_keys)..     
-000447c0: 2020 2023 206f 7574 5f6b 6579 7320 3d20     # out_keys = 
-000447d0: 5b22 7265 7761 7264 5f74 6f5f 676f 225d  ["reward_to_go"]
-000447e0: 0d0a 2020 2020 2020 2020 7375 7065 7228  ..        super(
-000447f0: 292e 5f5f 696e 6974 5f5f 280d 0a20 2020  ).__init__(..   
-00044800: 2020 2020 2020 2020 2069 6e5f 6b65 7973           in_keys
-00044810: 3d69 6e5f 6b65 7973 2c0d 0a20 2020 2020  =in_keys,..     
-00044820: 2020 2020 2020 2069 6e5f 6b65 7973 5f69         in_keys_i
-00044830: 6e76 3d69 6e5f 6b65 7973 2c0d 0a20 2020  nv=in_keys,..   
-00044840: 2020 2020 2020 2020 206f 7574 5f6b 6579           out_key
-00044850: 735f 696e 763d 6f75 745f 6b65 7973 2c0d  s_inv=out_keys,.
-00044860: 0a20 2020 2020 2020 2029 0d0a 2020 2020  .        )..    
-00044870: 2020 2020 7365 6c66 2e64 6f6e 655f 6b65      self.done_ke
-00044880: 7920 3d20 646f 6e65 5f6b 6579 0d0a 0d0a  y = done_key....
-00044890: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
-000448a0: 7369 6e73 7461 6e63 6528 6761 6d6d 612c  sinstance(gamma,
-000448b0: 2074 6f72 6368 2e54 656e 736f 7229 3a0d   torch.Tensor):.
-000448c0: 0a20 2020 2020 2020 2020 2020 2067 616d  .            gam
-000448d0: 6d61 203d 2074 6f72 6368 2e74 656e 736f  ma = torch.tenso
-000448e0: 7228 6761 6d6d 6129 0d0a 0d0a 2020 2020  r(gamma)....    
-000448f0: 2020 2020 7365 6c66 2e72 6567 6973 7465      self.registe
-00044900: 725f 6275 6666 6572 2822 6761 6d6d 6122  r_buffer("gamma"
-00044910: 2c20 6761 6d6d 6129 0d0a 0d0a 2020 2020  , gamma)....    
-00044920: 6465 6620 5f69 6e76 5f63 616c 6c28 7365  def _inv_call(se
-00044930: 6c66 2c20 7465 6e73 6f72 6469 6374 3a20  lf, tensordict: 
-00044940: 5465 6e73 6f72 4469 6374 4261 7365 2920  TensorDictBase) 
-00044950: 2d3e 2054 656e 736f 7244 6963 7442 6173  -> TensorDictBas
-00044960: 653a 0d0a 2020 2020 2020 2020 6966 2073  e:..        if s
-00044970: 656c 662e 7061 7265 6e74 2069 7320 6e6f  elf.parent is no
-00044980: 7420 4e6f 6e65 3a0d 0a20 2020 2020 2020  t None:..       
-00044990: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-000449a0: 4572 726f 7228 7365 6c66 2e45 4e56 5f45  Error(self.ENV_E
-000449b0: 5252 290d 0a20 2020 2020 2020 2064 6f6e  RR)..        don
-000449c0: 6520 3d20 7465 6e73 6f72 6469 6374 2e67  e = tensordict.g
-000449d0: 6574 2828 226e 6578 7422 2c20 7365 6c66  et(("next", self
-000449e0: 2e64 6f6e 655f 6b65 7929 290d 0a0d 0a20  .done_key)).... 
-000449f0: 2020 2020 2020 2069 6620 6e6f 7420 646f         if not do
-00044a00: 6e65 2e61 6e79 282d 3229 2e61 6c6c 2829  ne.any(-2).all()
-00044a10: 3a0d 0a20 2020 2020 2020 2020 2020 2072  :..            r
-00044a20: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
-00044a30: 7228 0d0a 2020 2020 2020 2020 2020 2020  r(..            
-00044a40: 2020 2020 224e 6f20 6570 6973 6f64 6520      "No episode 
-00044a50: 656e 6473 2066 6f75 6e64 2074 6f20 6361  ends found to ca
-00044a60: 6c63 756c 6174 6520 7468 6520 7265 7761  lculate the rewa
-00044a70: 7264 2074 6f20 676f 2e20 4d61 6b65 2073  rd to go. Make s
-00044a80: 7572 6520 7468 6174 2074 6865 206e 756d  ure that the num
-00044a90: 6265 7220 6f66 2066 7261 6d65 735f 7065  ber of frames_pe
-00044aa0: 725f 6261 7463 6820 6973 206c 6172 6765  r_batch is large
-00044ab0: 7220 7468 616e 206e 756d 6265 7220 6f66  r than number of
-00044ac0: 2073 7465 7073 2070 6572 2065 7069 736f   steps per episo
-00044ad0: 6465 2e22 0d0a 2020 2020 2020 2020 2020  de."..          
-00044ae0: 2020 290d 0a20 2020 2020 2020 2066 6f75    )..        fou
-00044af0: 6e64 203d 2046 616c 7365 0d0a 2020 2020  nd = False..    
-00044b00: 2020 2020 666f 7220 696e 5f6b 6579 2c20      for in_key, 
-00044b10: 6f75 745f 6b65 7920 696e 207a 6970 2873  out_key in zip(s
-00044b20: 656c 662e 696e 5f6b 6579 735f 696e 762c  elf.in_keys_inv,
-00044b30: 2073 656c 662e 6f75 745f 6b65 7973 5f69   self.out_keys_i
-00044b40: 6e76 293a 0d0a 2020 2020 2020 2020 2020  nv):..          
-00044b50: 2020 6966 2069 6e5f 6b65 7920 696e 2074    if in_key in t
-00044b60: 656e 736f 7264 6963 742e 6b65 7973 2869  ensordict.keys(i
-00044b70: 6e63 6c75 6465 5f6e 6573 7465 643d 5472  nclude_nested=Tr
-00044b80: 7565 293a 0d0a 2020 2020 2020 2020 2020  ue):..          
-00044b90: 2020 2020 2020 666f 756e 6420 3d20 5472        found = Tr
-00044ba0: 7565 0d0a 2020 2020 2020 2020 2020 2020  ue..            
-00044bb0: 2020 2020 6974 656d 203d 2073 656c 662e      item = self.
-00044bc0: 5f69 6e76 5f61 7070 6c79 5f74 7261 6e73  _inv_apply_trans
-00044bd0: 666f 726d 2874 656e 736f 7264 6963 742e  form(tensordict.
-00044be0: 6765 7428 696e 5f6b 6579 292c 2064 6f6e  get(in_key), don
-00044bf0: 6529 0d0a 2020 2020 2020 2020 2020 2020  e)..            
-00044c00: 2020 2020 7465 6e73 6f72 6469 6374 2e73      tensordict.s
-00044c10: 6574 286f 7574 5f6b 6579 2c20 6974 656d  et(out_key, item
-00044c20: 290d 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
-00044c30: 7420 666f 756e 643a 0d0a 2020 2020 2020  t found:..      
-00044c40: 2020 2020 2020 7261 6973 6520 4b65 7945        raise KeyE
-00044c50: 7272 6f72 2866 2243 6f75 6c64 206e 6f74  rror(f"Could not
-00044c60: 2066 696e 6420 616e 7920 6f66 2074 6865   find any of the
-00044c70: 2069 6e70 7574 206b 6579 7320 7b73 656c   input keys {sel
-00044c80: 662e 696e 5f6b 6579 737d 2e22 290d 0a20  f.in_keys}.").. 
-00044c90: 2020 2020 2020 2072 6574 7572 6e20 7465         return te
-00044ca0: 6e73 6f72 6469 6374 0d0a 0d0a 2020 2020  nsordict....    
-00044cb0: 6465 6620 666f 7277 6172 6428 7365 6c66  def forward(self
-00044cc0: 2c20 7465 6e73 6f72 6469 6374 3a20 5465  , tensordict: Te
-00044cd0: 6e73 6f72 4469 6374 4261 7365 2920 2d3e  nsorDictBase) ->
-00044ce0: 2054 656e 736f 7244 6963 7442 6173 653a   TensorDictBase:
-00044cf0: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00044d00: 2074 656e 736f 7264 6963 740d 0a0d 0a20   tensordict.... 
-00044d10: 2020 2064 6566 205f 6361 6c6c 2873 656c     def _call(sel
-00044d20: 662c 2074 656e 736f 7264 6963 743a 2054  f, tensordict: T
-00044d30: 656e 736f 7244 6963 7442 6173 6529 202d  ensorDictBase) -
-00044d40: 3e20 5465 6e73 6f72 4469 6374 4261 7365  > TensorDictBase
-00044d50: 3a0d 0a20 2020 2020 2020 2072 6169 7365  :..        raise
-00044d60: 2056 616c 7565 4572 726f 7228 7365 6c66   ValueError(self
-00044d70: 2e45 4e56 5f45 5252 290d 0a0d 0a20 2020  .ENV_ERR)....   
-00044d80: 2064 6566 205f 696e 765f 6170 706c 795f   def _inv_apply_
-00044d90: 7472 616e 7366 6f72 6d28 0d0a 2020 2020  transform(..    
-00044da0: 2020 2020 7365 6c66 2c20 7265 7761 7264      self, reward
-00044db0: 3a20 746f 7263 682e 5465 6e73 6f72 2c20  : torch.Tensor, 
-00044dc0: 646f 6e65 3a20 746f 7263 682e 5465 6e73  done: torch.Tens
-00044dd0: 6f72 0d0a 2020 2020 2920 2d3e 2074 6f72  or..    ) -> tor
-00044de0: 6368 2e54 656e 736f 723a 0d0a 2020 2020  ch.Tensor:..    
-00044df0: 2020 2020 7265 7475 726e 2072 6577 6172      return rewar
-00044e00: 6432 676f 2872 6577 6172 642c 2064 6f6e  d2go(reward, don
-00044e10: 652c 2073 656c 662e 6761 6d6d 6129 0d0a  e, self.gamma)..
-00044e20: 0d0a 2020 2020 6465 6620 7365 745f 636f  ..    def set_co
-00044e30: 6e74 6169 6e65 7228 7365 6c66 2c20 636f  ntainer(self, co
-00044e40: 6e74 6169 6e65 7229 3a0d 0a20 2020 2020  ntainer):..     
-00044e50: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-00044e60: 2863 6f6e 7461 696e 6572 2c20 456e 7642  (container, EnvB
-00044e70: 6173 6529 206f 7220 636f 6e74 6169 6e65  ase) or containe
-00044e80: 722e 7061 7265 6e74 2069 7320 6e6f 7420  r.parent is not 
-00044e90: 4e6f 6e65 3a0d 0a20 2020 2020 2020 2020  None:..         
-00044ea0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-00044eb0: 726f 7228 7365 6c66 2e45 4e56 5f45 5252  ror(self.ENV_ERR
-00044ec0: 290d 0a0d 0a0d 0a63 6c61 7373 2041 6374  )......class Act
-00044ed0: 696f 6e4d 6173 6b28 5472 616e 7366 6f72  ionMask(Transfor
-00044ee0: 6d29 3a0d 0a20 2020 2022 2222 416e 2061  m):..    """An a
-00044ef0: 6461 7074 6976 6520 6163 7469 6f6e 206d  daptive action m
-00044f00: 6173 6b65 722e 0d0a 0d0a 2020 2020 5468  asker.....    Th
-00044f10: 6973 2074 7261 6e73 666f 726d 2072 6561  is transform rea
-00044f20: 6473 2074 6865 206d 6173 6b20 6672 6f6d  ds the mask from
-00044f30: 2074 6865 2069 6e70 7574 2074 656e 736f   the input tenso
-00044f40: 7264 6963 7420 6166 7465 7220 7468 6520  rdict after the 
-00044f50: 7374 6570 2069 7320 6578 6563 7574 6564  step is executed
-00044f60: 2c0d 0a20 2020 2061 6e64 2061 6461 7074  ,..    and adapt
-00044f70: 7320 7468 6520 6d61 736b 206f 6620 7468  s the mask of th
-00044f80: 6520 6f6e 652d 686f 7420 2f20 6361 7465  e one-hot / cate
-00044f90: 676f 7269 6361 6c20 6163 7469 6f6e 2073  gorical action s
-00044fa0: 7065 632e 0d0a 0d0a 2020 2020 2020 2e2e  pec.....      ..
-00044fb0: 206e 6f74 653a 3a20 5468 6973 2074 7261   note:: This tra
-00044fc0: 6e73 666f 726d 2077 696c 6c20 6661 696c  nsform will fail
-00044fd0: 2077 6865 6e20 7573 6564 2077 6974 686f   when used witho
-00044fe0: 7574 2061 6e20 656e 7669 726f 6e6d 656e  ut an environmen
-00044ff0: 742e 0d0a 0d0a 2020 2020 4172 6773 3a0d  t.....    Args:.
-00045000: 0a20 2020 2020 2020 2061 6374 696f 6e5f  .        action_
-00045010: 6b65 7920 284e 6573 7465 644b 6579 2c20  key (NestedKey, 
-00045020: 6f70 7469 6f6e 616c 293a 2074 6865 206b  optional): the k
-00045030: 6579 2077 6865 7265 2074 6865 2061 6374  ey where the act
-00045040: 696f 6e20 7465 6e73 6f72 2063 616e 2062  ion tensor can b
-00045050: 6520 666f 756e 642e 0d0a 2020 2020 2020  e found...      
-00045060: 2020 2020 2020 4465 6661 756c 7473 2074        Defaults t
-00045070: 6f20 6060 2261 6374 696f 6e22 6060 2e0d  o ``"action"``..
-00045080: 0a20 2020 2020 2020 206d 6173 6b5f 6b65  .        mask_ke
-00045090: 7920 284e 6573 7465 644b 6579 2c20 6f70  y (NestedKey, op
-000450a0: 7469 6f6e 616c 293a 2074 6865 206b 6579  tional): the key
-000450b0: 2077 6865 7265 2074 6865 2061 6374 696f   where the actio
-000450c0: 6e20 6d61 736b 2063 616e 2062 6520 666f  n mask can be fo
-000450d0: 756e 642e 0d0a 2020 2020 2020 2020 2020  und...          
-000450e0: 2020 4465 6661 756c 7473 2074 6f20 6060    Defaults to ``
-000450f0: 2261 6374 696f 6e5f 6d61 736b 2260 602e  "action_mask"``.
-00045100: 0d0a 0d0a 2020 2020 4578 616d 706c 6573  ....    Examples
-00045110: 3a0d 0a20 2020 2020 2020 203e 3e3e 2069  :..        >>> i
-00045120: 6d70 6f72 7420 746f 7263 680d 0a20 2020  mport torch..   
-00045130: 2020 2020 203e 3e3e 2066 726f 6d20 746f       >>> from to
-00045140: 7263 6872 6c2e 6461 7461 2e74 656e 736f  rchrl.data.tenso
-00045150: 725f 7370 6563 7320 696d 706f 7274 2044  r_specs import D
-00045160: 6973 6372 6574 6554 656e 736f 7253 7065  iscreteTensorSpe
-00045170: 632c 2042 696e 6172 7944 6973 6372 6574  c, BinaryDiscret
-00045180: 6554 656e 736f 7253 7065 632c 2055 6e62  eTensorSpec, Unb
-00045190: 6f75 6e64 6564 436f 6e74 696e 756f 7573  oundedContinuous
-000451a0: 5465 6e73 6f72 5370 6563 2c20 436f 6d70  TensorSpec, Comp
-000451b0: 6f73 6974 6553 7065 630d 0a20 2020 2020  ositeSpec..     
-000451c0: 2020 203e 3e3e 2066 726f 6d20 746f 7263     >>> from torc
-000451d0: 6872 6c2e 656e 7673 2e74 7261 6e73 666f  hrl.envs.transfo
-000451e0: 726d 7320 696d 706f 7274 2041 6374 696f  rms import Actio
-000451f0: 6e4d 6173 6b2c 2054 7261 6e73 666f 726d  nMask, Transform
-00045200: 6564 456e 760d 0a20 2020 2020 2020 203e  edEnv..        >
-00045210: 3e3e 2066 726f 6d20 746f 7263 6872 6c2e  >> from torchrl.
-00045220: 656e 7673 2e63 6f6d 6d6f 6e20 696d 706f  envs.common impo
-00045230: 7274 2045 6e76 4261 7365 0d0a 2020 2020  rt EnvBase..    
-00045240: 2020 2020 3e3e 3e20 636c 6173 7320 4d61      >>> class Ma
-00045250: 736b 6564 456e 7628 456e 7642 6173 6529  skedEnv(EnvBase)
-00045260: 3a0d 0a20 2020 2020 2020 202e 2e2e 2020  :..        ...  
-00045270: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-00045280: 7365 6c66 2c20 2a61 7267 732c 202a 2a6b  self, *args, **k
-00045290: 7761 7267 7329 3a0d 0a20 2020 2020 2020  wargs):..       
-000452a0: 202e 2e2e 2020 2020 2020 2020 2073 7570   ...         sup
-000452b0: 6572 2829 2e5f 5f69 6e69 745f 5f28 2a61  er().__init__(*a
-000452c0: 7267 732c 202a 2a6b 7761 7267 7329 0d0a  rgs, **kwargs)..
-000452d0: 2020 2020 2020 2020 2e2e 2e20 2020 2020          ...     
-000452e0: 2020 2020 7365 6c66 2e61 6374 696f 6e5f      self.action_
-000452f0: 7370 6563 203d 2044 6973 6372 6574 6554  spec = DiscreteT
-00045300: 656e 736f 7253 7065 6328 3429 0d0a 2020  ensorSpec(4)..  
-00045310: 2020 2020 2020 2e2e 2e20 2020 2020 2020        ...       
-00045320: 2020 7365 6c66 2e73 7461 7465 5f73 7065    self.state_spe
-00045330: 6320 3d20 436f 6d70 6f73 6974 6553 7065  c = CompositeSpe
-00045340: 6328 6163 7469 6f6e 5f6d 6173 6b3d 4269  c(action_mask=Bi
-00045350: 6e61 7279 4469 7363 7265 7465 5465 6e73  naryDiscreteTens
-00045360: 6f72 5370 6563 2834 2c20 6474 7970 653d  orSpec(4, dtype=
-00045370: 746f 7263 682e 626f 6f6c 2929 0d0a 2020  torch.bool))..  
-00045380: 2020 2020 2020 2e2e 2e20 2020 2020 2020        ...       
-00045390: 2020 7365 6c66 2e6f 6273 6572 7661 7469    self.observati
-000453a0: 6f6e 5f73 7065 6320 3d20 436f 6d70 6f73  on_spec = Compos
-000453b0: 6974 6553 7065 6328 6f62 733d 556e 626f  iteSpec(obs=Unbo
-000453c0: 756e 6465 6443 6f6e 7469 6e75 6f75 7354  undedContinuousT
-000453d0: 656e 736f 7253 7065 6328 3329 290d 0a20  ensorSpec(3)).. 
-000453e0: 2020 2020 2020 202e 2e2e 2020 2020 2020         ...      
-000453f0: 2020 2073 656c 662e 7265 7761 7264 5f73     self.reward_s
-00045400: 7065 6320 3d20 556e 626f 756e 6465 6443  pec = UnboundedC
-00045410: 6f6e 7469 6e75 6f75 7354 656e 736f 7253  ontinuousTensorS
-00045420: 7065 6328 3129 0d0a 2020 2020 2020 2020  pec(1)..        
-00045430: 2e2e 2e0d 0a20 2020 2020 2020 202e 2e2e  .....        ...
-00045440: 2020 2020 2064 6566 205f 7265 7365 7428       def _reset(
-00045450: 7365 6c66 2c20 7465 6e73 6f72 6469 6374  self, tensordict
-00045460: 3d4e 6f6e 6529 3a0d 0a20 2020 2020 2020  =None):..       
-00045470: 202e 2e2e 2020 2020 2020 2020 2074 6420   ...         td 
-00045480: 3d20 7365 6c66 2e6f 6273 6572 7661 7469  = self.observati
-00045490: 6f6e 5f73 7065 632e 7261 6e64 2829 0d0a  on_spec.rand()..
-000454a0: 2020 2020 2020 2020 2e2e 2e20 2020 2020          ...     
-000454b0: 2020 2020 7464 2e75 7064 6174 6528 746f      td.update(to
-000454c0: 7263 682e 6f6e 6573 5f6c 696b 6528 7365  rch.ones_like(se
-000454d0: 6c66 2e73 7461 7465 5f73 7065 632e 7261  lf.state_spec.ra
-000454e0: 6e64 2829 2929 0d0a 2020 2020 2020 2020  nd()))..        
-000454f0: 2e2e 2e20 2020 2020 2020 2020 7265 7475  ...         retu
-00045500: 726e 2074 640d 0a20 2020 2020 2020 202e  rn td..        .
-00045510: 2e2e 0d0a 2020 2020 2020 2020 2e2e 2e20  ....        ... 
-00045520: 2020 2020 6465 6620 5f73 7465 7028 7365      def _step(se
-00045530: 6c66 2c20 6461 7461 293a 0d0a 2020 2020  lf, data):..    
-00045540: 2020 2020 2e2e 2e20 2020 2020 2020 2020      ...         
-00045550: 7464 203d 2073 656c 662e 6f62 7365 7276  td = self.observ
-00045560: 6174 696f 6e5f 7370 6563 2e72 616e 6428  ation_spec.rand(
-00045570: 290d 0a20 2020 2020 2020 202e 2e2e 2020  )..        ...  
-00045580: 2020 2020 2020 206d 6173 6b20 3d20 6461         mask = da
-00045590: 7461 2e67 6574 2822 6163 7469 6f6e 5f6d  ta.get("action_m
-000455a0: 6173 6b22 290d 0a20 2020 2020 2020 202e  ask")..        .
-000455b0: 2e2e 2020 2020 2020 2020 2061 6374 696f  ..         actio
-000455c0: 6e20 3d20 6461 7461 2e67 6574 2822 6163  n = data.get("ac
-000455d0: 7469 6f6e 2229 0d0a 2020 2020 2020 2020  tion")..        
-000455e0: 2e2e 2e20 2020 2020 2020 2020 6d61 736b  ...         mask
-000455f0: 203d 206d 6173 6b2e 7363 6174 7465 7228   = mask.scatter(
-00045600: 2d31 2c20 6163 7469 6f6e 2e75 6e73 7175  -1, action.unsqu
-00045610: 6565 7a65 282d 3129 2c20 3029 0d0a 2020  eeze(-1), 0)..  
-00045620: 2020 2020 2020 2e2e 2e0d 0a20 2020 2020        .....     
-00045630: 2020 202e 2e2e 2020 2020 2020 2020 2074     ...         t
-00045640: 642e 7365 7428 2261 6374 696f 6e5f 6d61  d.set("action_ma
-00045650: 736b 222c 206d 6173 6b29 0d0a 2020 2020  sk", mask)..    
-00045660: 2020 2020 2e2e 2e20 2020 2020 2020 2020      ...         
-00045670: 7464 2e73 6574 2822 7265 7761 7264 222c  td.set("reward",
-00045680: 2073 656c 662e 7265 7761 7264 5f73 7065   self.reward_spe
-00045690: 632e 7261 6e64 2829 290d 0a20 2020 2020  c.rand())..     
-000456a0: 2020 202e 2e2e 2020 2020 2020 2020 2074     ...         t
-000456b0: 642e 7365 7428 2264 6f6e 6522 2c20 7e6d  d.set("done", ~m
-000456c0: 6173 6b2e 616e 7928 292e 7669 6577 2831  ask.any().view(1
-000456d0: 2929 0d0a 2020 2020 2020 2020 2e2e 2e20  ))..        ... 
-000456e0: 2020 2020 2020 2020 7265 7475 726e 2074          return t
-000456f0: 640d 0a20 2020 2020 2020 202e 2e2e 0d0a  d..        .....
-00045700: 2020 2020 2020 2020 2e2e 2e20 2020 2020          ...     
-00045710: 6465 6620 5f73 6574 5f73 6565 6428 7365  def _set_seed(se
-00045720: 6c66 2c20 7365 6564 293a 0d0a 2020 2020  lf, seed):..    
-00045730: 2020 2020 2e2e 2e20 2020 2020 2020 2020      ...         
-00045740: 7265 7475 726e 2073 6565 640d 0a20 2020  return seed..   
-00045750: 2020 2020 202e 2e2e 0d0a 2020 2020 2020       .....      
-00045760: 2020 3e3e 3e20 746f 7263 682e 6d61 6e75    >>> torch.manu
-00045770: 616c 5f73 6565 6428 3029 0d0a 2020 2020  al_seed(0)..    
-00045780: 2020 2020 3e3e 3e20 6261 7365 5f65 6e76      >>> base_env
-00045790: 203d 204d 6173 6b65 6445 6e76 2829 0d0a   = MaskedEnv()..
-000457a0: 2020 2020 2020 2020 3e3e 3e20 656e 7620          >>> env 
-000457b0: 3d20 5472 616e 7366 6f72 6d65 6445 6e76  = TransformedEnv
-000457c0: 2862 6173 655f 656e 762c 2041 6374 696f  (base_env, Actio
-000457d0: 6e4d 6173 6b28 2929 0d0a 2020 2020 2020  nMask())..      
-000457e0: 2020 3e3e 3e20 7220 3d20 656e 762e 726f    >>> r = env.ro
-000457f0: 6c6c 6f75 7428 3130 290d 0a20 2020 2020  llout(10)..     
-00045800: 2020 203e 3e3e 2065 6e76 203d 2054 7261     >>> env = Tra
-00045810: 6e73 666f 726d 6564 456e 7628 6261 7365  nsformedEnv(base
-00045820: 5f65 6e76 2c20 4163 7469 6f6e 4d61 736b  _env, ActionMask
-00045830: 2829 290d 0a20 2020 2020 2020 203e 3e3e  ())..        >>>
-00045840: 2072 203d 2065 6e76 2e72 6f6c 6c6f 7574   r = env.rollout
-00045850: 2831 3029 0d0a 2020 2020 2020 2020 3e3e  (10)..        >>
-00045860: 3e20 725b 2261 6374 696f 6e5f 6d61 736b  > r["action_mask
-00045870: 225d 0d0a 2020 2020 2020 2020 7465 6e73  "]..        tens
-00045880: 6f72 285b 5b20 5472 7565 2c20 2054 7275  or([[ True,  Tru
-00045890: 652c 2020 5472 7565 2c20 2054 7275 655d  e,  True,  True]
-000458a0: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
-000458b0: 2020 205b 2054 7275 652c 2020 5472 7565     [ True,  True
-000458c0: 2c20 4661 6c73 652c 2020 5472 7565 5d2c  , False,  True],
-000458d0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000458e0: 2020 5b20 5472 7565 2c20 2054 7275 652c    [ True,  True,
-000458f0: 2046 616c 7365 2c20 4661 6c73 655d 2c0d   False, False],.
-00045900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00045910: 205b 2054 7275 652c 2046 616c 7365 2c20   [ True, False, 
-00045920: 4661 6c73 652c 2046 616c 7365 5d5d 290d  False, False]]).
-00045930: 0a0d 0a20 2020 2022 2222 0d0a 0d0a 2020  ...    """....  
-00045940: 2020 4143 4345 5054 4544 5f53 5045 4353    ACCEPTED_SPECS
-00045950: 203d 2028 0d0a 2020 2020 2020 2020 4f6e   = (..        On
-00045960: 6548 6f74 4469 7363 7265 7465 5465 6e73  eHotDiscreteTens
-00045970: 6f72 5370 6563 2c0d 0a20 2020 2020 2020  orSpec,..       
-00045980: 2044 6973 6372 6574 6554 656e 736f 7253   DiscreteTensorS
-00045990: 7065 632c 0d0a 2020 2020 2020 2020 4d75  pec,..        Mu
-000459a0: 6c74 694f 6e65 486f 7444 6973 6372 6574  ltiOneHotDiscret
-000459b0: 6554 656e 736f 7253 7065 632c 0d0a 2020  eTensorSpec,..  
-000459c0: 2020 2020 2020 4d75 6c74 6944 6973 6372        MultiDiscr
-000459d0: 6574 6554 656e 736f 7253 7065 632c 0d0a  eteTensorSpec,..
-000459e0: 2020 2020 290d 0a20 2020 2053 5045 435f      )..    SPEC_
-000459f0: 5459 5045 5f45 5252 4f52 203d 2022 5468  TYPE_ERROR = "Th
-00045a00: 6520 6163 7469 6f6e 2073 7065 6320 6d75  e action spec mu
-00045a10: 7374 2062 6520 6f6e 6520 6f66 207b 7d2e  st be one of {}.
-00045a20: 2047 6f74 207b 7d20 696e 7374 6561 642e   Got {} instead.
-00045a30: 220d 0a0d 0a20 2020 2064 6566 205f 5f69  "....    def __i
-00045a40: 6e69 745f 5f28 0d0a 2020 2020 2020 2020  nit__(..        
-00045a50: 7365 6c66 2c20 6163 7469 6f6e 5f6b 6579  self, action_key
-00045a60: 3a20 4e65 7374 6564 4b65 7920 3d20 2261  : NestedKey = "a
-00045a70: 6374 696f 6e22 2c20 6d61 736b 5f6b 6579  ction", mask_key
-00045a80: 3a20 4e65 7374 6564 4b65 7920 3d20 2261  : NestedKey = "a
-00045a90: 6374 696f 6e5f 6d61 736b 220d 0a20 2020  ction_mask"..   
-00045aa0: 2029 3a0d 0a20 2020 2020 2020 2069 6620   ):..        if 
-00045ab0: 6e6f 7420 6973 696e 7374 616e 6365 2861  not isinstance(a
-00045ac0: 6374 696f 6e5f 6b65 792c 2028 7475 706c  ction_key, (tupl
-00045ad0: 652c 2073 7472 2929 3a0d 0a20 2020 2020  e, str)):..     
-00045ae0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00045af0: 7565 4572 726f 7228 0d0a 2020 2020 2020  ueError(..      
-00045b00: 2020 2020 2020 2020 2020 6622 5468 6520            f"The 
-00045b10: 6163 7469 6f6e 206b 6579 206d 7573 7420  action key must 
-00045b20: 6265 2061 206e 6573 7465 6420 6b65 792e  be a nested key.
-00045b30: 2047 6f74 207b 7479 7065 2861 6374 696f   Got {type(actio
-00045b40: 6e5f 6b65 7929 7d20 696e 7374 6561 642e  n_key)} instead.
-00045b50: 220d 0a20 2020 2020 2020 2020 2020 2029  "..            )
-00045b60: 0d0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-00045b70: 2069 7369 6e73 7461 6e63 6528 6d61 736b   isinstance(mask
-00045b80: 5f6b 6579 2c20 2874 7570 6c65 2c20 7374  _key, (tuple, st
-00045b90: 7229 293a 0d0a 2020 2020 2020 2020 2020  r)):..          
-00045ba0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-00045bb0: 6f72 280d 0a20 2020 2020 2020 2020 2020  or(..           
-00045bc0: 2020 2020 2066 2254 6865 206d 6173 6b20       f"The mask 
-00045bd0: 6b65 7920 6d75 7374 2062 6520 6120 6e65  key must be a ne
-00045be0: 7374 6564 206b 6579 2e20 476f 7420 7b74  sted key. Got {t
-00045bf0: 7970 6528 6d61 736b 5f6b 6579 297d 2069  ype(mask_key)} i
-00045c00: 6e73 7465 6164 2e22 0d0a 2020 2020 2020  nstead."..      
-00045c10: 2020 2020 2020 290d 0a20 2020 2020 2020        )..       
-00045c20: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
-00045c30: 5f28 0d0a 2020 2020 2020 2020 2020 2020  _(..            
-00045c40: 696e 5f6b 6579 733d 5b61 6374 696f 6e5f  in_keys=[action_
-00045c50: 6b65 792c 206d 6173 6b5f 6b65 795d 2c20  key, mask_key], 
-00045c60: 6f75 745f 6b65 7973 3d5b 5d2c 2069 6e5f  out_keys=[], in_
-00045c70: 6b65 7973 5f69 6e76 3d5b 5d2c 206f 7574  keys_inv=[], out
-00045c80: 5f6b 6579 735f 696e 763d 5b5d 0d0a 2020  _keys_inv=[]..  
-00045c90: 2020 2020 2020 290d 0a0d 0a20 2020 2064        )....    d
-00045ca0: 6566 2066 6f72 7761 7264 2873 656c 662c  ef forward(self,
-00045cb0: 2074 656e 736f 7264 6963 743a 2054 656e   tensordict: Ten
-00045cc0: 736f 7244 6963 7442 6173 6529 202d 3e20  sorDictBase) -> 
-00045cd0: 5465 6e73 6f72 4469 6374 4261 7365 3a0d  TensorDictBase:.
-00045ce0: 0a20 2020 2020 2020 2072 6169 7365 2052  .        raise R
-00045cf0: 756e 7469 6d65 4572 726f 7228 464f 5257  untimeError(FORW
-00045d00: 4152 445f 4e4f 545f 494d 504c 454d 454e  ARD_NOT_IMPLEMEN
-00045d10: 5445 442e 666f 726d 6174 2874 7970 6528  TED.format(type(
-00045d20: 7365 6c66 2929 290d 0a0d 0a20 2020 2064  self)))....    d
-00045d30: 6566 205f 6361 6c6c 2873 656c 662c 2074  ef _call(self, t
-00045d40: 656e 736f 7264 6963 743a 2054 656e 736f  ensordict: Tenso
-00045d50: 7244 6963 7442 6173 6529 202d 3e20 5465  rDictBase) -> Te
-00045d60: 6e73 6f72 4469 6374 4261 7365 3a0d 0a20  nsorDictBase:.. 
-00045d70: 2020 2020 2020 2070 6172 656e 7420 3d20         parent = 
-00045d80: 7365 6c66 2e70 6172 656e 740d 0a20 2020  self.parent..   
-00045d90: 2020 2020 2069 6620 7061 7265 6e74 2069       if parent i
-00045da0: 7320 4e6f 6e65 3a0d 0a20 2020 2020 2020  s None:..       
-00045db0: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
-00045dc0: 6d65 4572 726f 7228 0d0a 2020 2020 2020  meError(..      
-00045dd0: 2020 2020 2020 2020 2020 6622 7b74 7970            f"{typ
-00045de0: 6528 7365 6c66 297d 2e70 6172 656e 7420  e(self)}.parent 
-00045df0: 6361 6e6e 6f74 2062 6520 4e6f 6e65 3a20  cannot be None: 
-00045e00: 6d61 6b65 2073 7572 6520 7468 6973 2074  make sure this t
-00045e10: 7261 6e73 666f 726d 2069 7320 6578 6563  ransform is exec
-00045e20: 7574 6564 2077 6974 6869 6e20 616e 2065  uted within an e
-00045e30: 6e76 6972 6f6e 6d65 6e74 2e22 0d0a 2020  nvironment."..  
-00045e40: 2020 2020 2020 2020 2020 290d 0a20 2020            )..   
-00045e50: 2020 2020 206d 6173 6b20 3d20 7465 6e73       mask = tens
-00045e60: 6f72 6469 6374 2e67 6574 2873 656c 662e  ordict.get(self.
-00045e70: 696e 5f6b 6579 735b 315d 290d 0a20 2020  in_keys[1])..   
-00045e80: 2020 2020 2061 6374 696f 6e5f 7370 6563       action_spec
-00045e90: 203d 2073 656c 662e 636f 6e74 6169 6e65   = self.containe
-00045ea0: 722e 6163 7469 6f6e 5f73 7065 630d 0a20  r.action_spec.. 
-00045eb0: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
-00045ec0: 696e 7374 616e 6365 2861 6374 696f 6e5f  instance(action_
-00045ed0: 7370 6563 2c20 7365 6c66 2e41 4343 4550  spec, self.ACCEP
-00045ee0: 5445 445f 5350 4543 5329 3a0d 0a20 2020  TED_SPECS):..   
-00045ef0: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-00045f00: 616c 7565 4572 726f 7228 0d0a 2020 2020  alueError(..    
-00045f10: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00045f20: 2e53 5045 435f 5459 5045 5f45 5252 4f52  .SPEC_TYPE_ERROR
-00045f30: 2e66 6f72 6d61 7428 7365 6c66 2e41 4343  .format(self.ACC
-00045f40: 4550 5445 445f 5350 4543 532c 2074 7970  EPTED_SPECS, typ
-00045f50: 6528 6163 7469 6f6e 5f73 7065 6329 290d  e(action_spec)).
-00045f60: 0a20 2020 2020 2020 2020 2020 2029 0d0a  .            )..
-00045f70: 2020 2020 2020 2020 6163 7469 6f6e 5f73          action_s
-00045f80: 7065 632e 7570 6461 7465 5f6d 6173 6b28  pec.update_mask(
-00045f90: 6d61 736b 2e74 6f28 6163 7469 6f6e 5f73  mask.to(action_s
-00045fa0: 7065 632e 6465 7669 6365 2929 0d0a 2020  pec.device))..  
-00045fb0: 2020 2020 2020 7265 7475 726e 2074 656e        return ten
-00045fc0: 736f 7264 6963 740d 0a0d 0a20 2020 2064  sordict....    d
-00045fd0: 6566 205f 7265 7365 7428 0d0a 2020 2020  ef _reset(..    
-00045fe0: 2020 2020 7365 6c66 2c20 7465 6e73 6f72      self, tensor
-00045ff0: 6469 6374 3a20 5465 6e73 6f72 4469 6374  dict: TensorDict
-00046000: 4261 7365 2c20 7465 6e73 6f72 6469 6374  Base, tensordict
-00046010: 5f72 6573 6574 3a20 5465 6e73 6f72 4469  _reset: TensorDi
-00046020: 6374 4261 7365 0d0a 2020 2020 2920 2d3e  ctBase..    ) ->
-00046030: 2054 656e 736f 7244 6963 7442 6173 653a   TensorDictBase:
-00046040: 0d0a 2020 2020 2020 2020 6163 7469 6f6e  ..        action
-00046050: 5f73 7065 6320 3d20 7365 6c66 2e63 6f6e  _spec = self.con
-00046060: 7461 696e 6572 2e61 6374 696f 6e5f 7370  tainer.action_sp
-00046070: 6563 0d0a 2020 2020 2020 2020 6966 206e  ec..        if n
-00046080: 6f74 2069 7369 6e73 7461 6e63 6528 6163  ot isinstance(ac
-00046090: 7469 6f6e 5f73 7065 632c 2073 656c 662e  tion_spec, self.
-000460a0: 4143 4345 5054 4544 5f53 5045 4353 293a  ACCEPTED_SPECS):
-000460b0: 0d0a 2020 2020 2020 2020 2020 2020 7261  ..            ra
-000460c0: 6973 6520 5661 6c75 6545 7272 6f72 280d  ise ValueError(.
-000460d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000460e0: 2073 656c 662e 5350 4543 5f54 5950 455f   self.SPEC_TYPE_
-000460f0: 4552 524f 522e 666f 726d 6174 2873 656c  ERROR.format(sel
-00046100: 662e 4143 4345 5054 4544 5f53 5045 4353  f.ACCEPTED_SPECS
-00046110: 2c20 7479 7065 2861 6374 696f 6e5f 7370  , type(action_sp
-00046120: 6563 2929 0d0a 2020 2020 2020 2020 2020  ec))..          
-00046130: 2020 290d 0a20 2020 2020 2020 206d 6173    )..        mas
-00046140: 6b20 3d20 7465 6e73 6f72 6469 6374 2e67  k = tensordict.g
-00046150: 6574 2873 656c 662e 696e 5f6b 6579 735b  et(self.in_keys[
-00046160: 315d 2c20 4e6f 6e65 290d 0a20 2020 2020  1], None)..     
-00046170: 2020 2069 6620 6d61 736b 2069 7320 6e6f     if mask is no
-00046180: 7420 4e6f 6e65 3a0d 0a20 2020 2020 2020  t None:..       
-00046190: 2020 2020 206d 6173 6b20 3d20 6d61 736b       mask = mask
-000461a0: 2e74 6f28 6163 7469 6f6e 5f73 7065 632e  .to(action_spec.
-000461b0: 6465 7669 6365 290d 0a20 2020 2020 2020  device)..       
-000461c0: 2061 6374 696f 6e5f 7370 6563 2e75 7064   action_spec.upd
-000461d0: 6174 655f 6d61 736b 286d 6173 6b29 0d0a  ate_mask(mask)..
-000461e0: 0d0a 2020 2020 2020 2020 2320 544f 444f  ..        # TODO
-000461f0: 3a20 4368 6563 6b20 7468 6174 2074 6869  : Check that thi
-00046200: 7320 6d61 6b65 7320 7365 6e73 650d 0a20  s makes sense.. 
-00046210: 2020 2020 2020 2077 6974 6820 5f73 6574         with _set
-00046220: 5f6d 6973 7369 6e67 5f74 6f6c 6572 616e  _missing_toleran
-00046230: 6365 2873 656c 662c 2054 7275 6529 3a0d  ce(self, True):.
-00046240: 0a20 2020 2020 2020 2020 2020 2074 656e  .            ten
-00046250: 736f 7264 6963 745f 7265 7365 7420 3d20  sordict_reset = 
-00046260: 7365 6c66 2e5f 6361 6c6c 2874 656e 736f  self._call(tenso
-00046270: 7264 6963 745f 7265 7365 7429 0d0a 2020  rdict_reset)..  
-00046280: 2020 2020 2020 7265 7475 726e 2074 656e        return ten
-00046290: 736f 7264 6963 745f 7265 7365 740d 0a0d  sordict_reset...
-000462a0: 0a0d 0a63 6c61 7373 2056 6563 4779 6d45  ...class VecGymE
-000462b0: 6e76 5472 616e 7366 6f72 6d28 5472 616e  nvTransform(Tran
-000462c0: 7366 6f72 6d29 3a0d 0a20 2020 2022 2222  sform):..    """
-000462d0: 4120 7472 616e 7366 6f72 6d20 666f 7220  A transform for 
-000462e0: 4779 6d57 7261 7070 6572 2073 7562 636c  GymWrapper subcl
-000462f0: 6173 7365 7320 7468 6174 2068 616e 646c  asses that handl
-00046300: 6573 2074 6865 2061 7574 6f2d 7265 7365  es the auto-rese
-00046310: 7420 696e 2061 2063 6f6e 7369 7374 656e  t in a consisten
-00046320: 7420 7761 792e 0d0a 0d0a 2020 2020 4779  t way.....    Gy
-00046330: 6d2c 2067 796d 6e61 7369 756d 2061 6e64  m, gymnasium and
-00046340: 2053 4233 2070 726f 7669 6465 2076 6563   SB3 provide vec
-00046350: 746f 7269 7a65 6420 2872 6561 642c 2070  torized (read, p
-00046360: 6172 616c 6c65 6c20 6f72 2062 6174 6368  arallel or batch
-00046370: 6564 2920 656e 7669 726f 6e6d 656e 7473  ed) environments
-00046380: 0d0a 2020 2020 7468 6174 2061 7265 2061  ..    that are a
-00046390: 7574 6f6d 6174 6963 616c 6c79 2072 6573  utomatically res
-000463a0: 6574 2e20 5768 656e 2074 6869 7320 6f63  et. When this oc
-000463b0: 6375 7273 2c20 7468 6520 6163 7475 616c  curs, the actual
-000463c0: 206f 6273 6572 7661 7469 6f6e 2072 6573   observation res
-000463d0: 756c 7469 6e67 0d0a 2020 2020 6672 6f6d  ulting..    from
-000463e0: 2074 6865 2061 6374 696f 6e20 6973 2073   the action is s
-000463f0: 6176 6564 2077 6974 6869 6e20 6120 6b65  aved within a ke
-00046400: 7920 696e 2074 6865 2069 6e66 6f2e 0d0a  y in the info...
-00046410: 2020 2020 5468 6520 636c 6173 7320 3a63      The class :c
-00046420: 6c61 7373 3a60 746f 7263 6872 6c2e 656e  lass:`torchrl.en
-00046430: 7673 2e6c 6962 732e 6779 6d2e 7465 726d  vs.libs.gym.term
-00046440: 696e 616c 5f6f 6273 5f72 6561 6465 7260  inal_obs_reader`
-00046450: 2072 6561 6473 2074 6861 7420 6f62 7365   reads that obse
-00046460: 7276 6174 696f 6e0d 0a20 2020 2061 6e64  rvation..    and
-00046470: 2073 746f 7265 7320 6974 2069 6e20 6120   stores it in a 
-00046480: 6060 2266 696e 616c 2260 6020 6b65 7920  ``"final"`` key 
-00046490: 7769 7468 696e 2074 6865 206f 7574 7075  within the outpu
-000464a0: 7420 7465 6e73 6f72 6469 6374 2e0d 0a20  t tensordict... 
-000464b0: 2020 2049 6e20 7475 726e 2c20 7468 6973     In turn, this
-000464c0: 2074 7261 6e73 666f 726d 2072 6561 6473   transform reads
-000464d0: 2074 6861 7420 6669 6e61 6c20 6461 7461   that final data
-000464e0: 2c20 7377 6170 7320 6974 2077 6974 6820  , swaps it with 
-000464f0: 7468 6520 6f62 7365 7276 6174 696f 6e0d  the observation.
-00046500: 0a20 2020 2077 7269 7474 656e 2069 6e20  .    written in 
-00046510: 6974 7320 706c 6163 6520 7468 6174 2072  its place that r
-00046520: 6573 756c 7473 2066 726f 6d20 7468 6520  esults from the 
-00046530: 6163 7475 616c 2072 6573 6574 2c20 616e  actual reset, an
-00046540: 6420 7361 7665 7320 7468 650d 0a20 2020  d saves the..   
-00046550: 2072 6573 6574 206f 7574 7075 7420 696e   reset output in
-00046560: 2061 2070 7269 7661 7465 2063 6f6e 7461   a private conta
-00046570: 696e 6572 2e20 5468 6520 7265 7375 6c74  iner. The result
-00046580: 696e 6720 6461 7461 2074 7275 6c79 2072  ing data truly r
-00046590: 6566 6c65 6374 730d 0a20 2020 2074 6865  eflects..    the
-000465a0: 206f 7574 7075 7420 6f66 2074 6865 2073   output of the s
-000465b0: 7465 702e 0d0a 0d0a 2020 2020 5468 6973  tep.....    This
-000465c0: 2063 6c61 7373 2077 6f72 6b73 2066 726f   class works fro
-000465d0: 6d20 6779 6d20 302e 3133 2074 696c 6c20  m gym 0.13 till 
-000465e0: 7468 6520 6d6f 7374 2072 6563 656e 7420  the most recent 
-000465f0: 6779 6d6e 6173 6975 6d20 7665 7273 696f  gymnasium versio
-00046600: 6e2e 0d0a 0d0a 2020 2020 2e2e 206e 6f74  n.....    .. not
-00046610: 653a 3a20 4779 6d20 7665 7273 696f 6e73  e:: Gym versions
-00046620: 203c 2030 2e32 3220 6469 6420 6e6f 7420   < 0.22 did not 
-00046630: 7265 7475 726e 2074 6865 2066 696e 616c  return the final
-00046640: 206f 6273 6572 7661 7469 6f6e 732e 2046   observations. F
-00046650: 6f72 2074 6865 7365 2c0d 0a20 2020 2020  or these,..     
-00046660: 2020 2077 6520 7369 6d70 6c79 2066 696c     we simply fil
-00046670: 6c20 7468 6520 6e65 7874 206f 6273 6572  l the next obser
-00046680: 7661 7469 6f6e 7320 7769 7468 204e 614e  vations with NaN
-00046690: 2028 6265 6361 7573 6520 6974 2069 7320   (because it is 
-000466a0: 6c6f 7374 2920 616e 640d 0a20 2020 2020  lost) and..     
-000466b0: 2020 2064 6f20 7468 6520 7377 6170 2061     do the swap a
-000466c0: 7420 7468 6520 6e65 7874 2073 7465 702e  t the next step.
-000466d0: 0d0a 0d0a 2020 2020 5468 656e 2c20 7768  ....    Then, wh
-000466e0: 656e 2063 616c 6c69 6e67 2060 656e 762e  en calling `env.
-000466f0: 7265 7365 7460 2c20 7468 6520 7361 7665  reset`, the save
-00046700: 6420 6461 7461 2069 7320 7772 6974 7465  d data is writte
-00046710: 6e20 6261 636b 2077 6865 7265 2069 7420  n back where it 
-00046720: 6265 6c6f 6e67 730d 0a20 2020 2028 616e  belongs..    (an
-00046730: 6420 7468 6520 6072 6573 6574 6020 6973  d the `reset` is
-00046740: 2061 206e 6f2d 6f70 292e 0d0a 0d0a 2020   a no-op).....  
-00046750: 2020 5468 6973 2074 7261 6e73 666f 726d    This transform
-00046760: 2069 7320 6175 746f 6d61 7469 6361 6c6c   is automaticall
-00046770: 7920 6170 7065 6e64 6564 2074 6f20 7468  y appended to th
-00046780: 6520 6779 6d20 656e 7620 7768 656e 6576  e gym env whenev
-00046790: 6572 2074 6865 2077 7261 7070 6572 0d0a  er the wrapper..
-000467a0: 2020 2020 6973 2063 7265 6174 6564 2077      is created w
-000467b0: 6974 6820 616e 2061 7379 6e63 2065 6e76  ith an async env
-000467c0: 2e0d 0a0d 0a20 2020 2041 7267 733a 0d0a  .....    Args:..
-000467d0: 2020 2020 2020 2020 6669 6e61 6c5f 6e61          final_na
-000467e0: 6d65 2028 7374 722c 206f 7074 696f 6e61  me (str, optiona
-000467f0: 6c29 3a20 7468 6520 6e61 6d65 206f 6620  l): the name of 
-00046800: 7468 6520 6669 6e61 6c20 6f62 7365 7276  the final observ
-00046810: 6174 696f 6e20 696e 2074 6865 2064 6963  ation in the dic
-00046820: 742e 0d0a 2020 2020 2020 2020 2020 2020  t...            
-00046830: 4465 6661 756c 7473 2074 6f20 6022 6669  Defaults to `"fi
-00046840: 6e61 6c22 602e 0d0a 0d0a 2020 2020 2e2e  nal"`.....    ..
-00046850: 206e 6f74 653a 3a20 496e 2067 656e 6572   note:: In gener
-00046860: 616c 2c20 7468 6973 2063 6c61 7373 2073  al, this class s
-00046870: 686f 756c 6420 6e6f 7420 6265 2068 616e  hould not be han
-00046880: 646c 6564 2064 6972 6563 746c 792e 2049  dled directly. I
-00046890: 7420 6973 0d0a 2020 2020 2020 2020 6372  t is..        cr
-000468a0: 6561 7465 6420 7768 656e 6576 6572 2061  eated whenever a
-000468b0: 2076 6563 746f 7269 7a65 6420 656e 7669   vectorized envi
-000468c0: 726f 6e6d 656e 7420 6973 2070 6c61 6365  ronment is place
-000468d0: 6420 7769 7468 696e 2061 203a 636c 6173  d within a :clas
-000468e0: 733a 6047 796d 5772 6170 7065 7260 2e0d  s:`GymWrapper`..
-000468f0: 0a0d 0a20 2020 2022 2222 0d0a 0d0a 2020  ...    """....  
-00046900: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-00046910: 656c 662c 2066 696e 616c 5f6e 616d 653d  elf, final_name=
-00046920: 2266 696e 616c 2229 3a0d 0a20 2020 2020  "final"):..     
-00046930: 2020 2073 656c 662e 6669 6e61 6c5f 6e61     self.final_na
-00046940: 6d65 203d 2066 696e 616c 5f6e 616d 650d  me = final_name.
-00046950: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
-00046960: 2e5f 5f69 6e69 745f 5f28 290d 0a20 2020  .__init__()..   
-00046970: 2020 2020 2073 656c 662e 5f6d 656d 6f20       self._memo 
-00046980: 3d20 7b7d 0d0a 0d0a 2020 2020 6465 6620  = {}....    def 
-00046990: 7365 745f 636f 6e74 6169 6e65 7228 7365  set_container(se
-000469a0: 6c66 2c20 636f 6e74 6169 6e65 723a 2055  lf, container: U
-000469b0: 6e69 6f6e 5b54 7261 6e73 666f 726d 2c20  nion[Transform, 
-000469c0: 456e 7642 6173 655d 2920 2d3e 204e 6f6e  EnvBase]) -> Non
-000469d0: 653a 0d0a 2020 2020 2020 2020 6f75 7420  e:..        out 
-000469e0: 3d20 7375 7065 7228 292e 7365 745f 636f  = super().set_co
-000469f0: 6e74 6169 6e65 7228 636f 6e74 6169 6e65  ntainer(containe
-00046a00: 7229 0d0a 2020 2020 2020 2020 7365 6c66  r)..        self
-00046a10: 2e5f 646f 6e65 5f6b 6579 7320 3d20 4e6f  ._done_keys = No
-00046a20: 6e65 0d0a 2020 2020 2020 2020 7365 6c66  ne..        self
-00046a30: 2e5f 6f62 735f 6b65 7973 203d 204e 6f6e  ._obs_keys = Non
-00046a40: 650d 0a20 2020 2020 2020 2072 6574 7572  e..        retur
-00046a50: 6e20 6f75 740d 0a0d 0a20 2020 2064 6566  n out....    def
-00046a60: 205f 7374 6570 280d 0a20 2020 2020 2020   _step(..       
-00046a70: 2073 656c 662c 2074 656e 736f 7264 6963   self, tensordic
-00046a80: 743a 2054 656e 736f 7244 6963 7442 6173  t: TensorDictBas
-00046a90: 652c 206e 6578 745f 7465 6e73 6f72 6469  e, next_tensordi
-00046aa0: 6374 3a20 5465 6e73 6f72 4469 6374 4261  ct: TensorDictBa
-00046ab0: 7365 0d0a 2020 2020 2920 2d3e 2054 656e  se..    ) -> Ten
-00046ac0: 736f 7244 6963 7442 6173 653a 0d0a 2020  sorDictBase:..  
-00046ad0: 2020 2020 2020 2320 7361 7665 2074 6865        # save the
-00046ae0: 2066 696e 616c 2069 6e66 6f0d 0a20 2020   final info..   
-00046af0: 2020 2020 2064 6f6e 6520 3d20 4661 6c73       done = Fals
-00046b00: 650d 0a20 2020 2020 2020 2066 6f72 2064  e..        for d
-00046b10: 6f6e 655f 6b65 7920 696e 2073 656c 662e  one_key in self.
-00046b20: 646f 6e65 5f6b 6579 733a 0d0a 2020 2020  done_keys:..    
-00046b30: 2020 2020 2020 2020 2320 7765 2061 7373          # we ass
-00046b40: 756d 6520 646f 6e65 7320 6361 6e20 6265  ume dones can be
-00046b50: 2062 726f 6164 6361 7374 0d0a 2020 2020   broadcast..    
-00046b60: 2020 2020 2020 2020 646f 6e65 203d 2064          done = d
-00046b70: 6f6e 6520 7c20 6e65 7874 5f74 656e 736f  one | next_tenso
-00046b80: 7264 6963 742e 6765 7428 646f 6e65 5f6b  rdict.get(done_k
-00046b90: 6579 290d 0a20 2020 2020 2020 2069 6620  ey)..        if 
-00046ba0: 646f 6e65 2069 7320 4661 6c73 653a 0d0a  done is False:..
-00046bb0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00046bc0: 6520 5275 6e74 696d 6545 7272 6f72 280d  e RuntimeError(.
-00046bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00046be0: 2066 2243 6f75 6c64 206e 6f74 2066 696e   f"Could not fin
-00046bf0: 6420 616e 7920 646f 6e65 2073 6967 6e61  d any done signa
-00046c00: 6c20 696e 2074 656e 736f 7264 6963 743a  l in tensordict:
-00046c10: 5c6e 7b74 656e 736f 7264 6963 747d 220d  \n{tensordict}".
-00046c20: 0a20 2020 2020 2020 2020 2020 2029 0d0a  .            )..
-00046c30: 2020 2020 2020 2020 7365 6c66 2e5f 6d65          self._me
-00046c40: 6d6f 5b22 646f 6e65 225d 203d 2064 6f6e  mo["done"] = don
-00046c50: 650d 0a20 2020 2020 2020 2066 696e 616c  e..        final
-00046c60: 203d 206e 6578 745f 7465 6e73 6f72 6469   = next_tensordi
-00046c70: 6374 2e70 6f70 2873 656c 662e 6669 6e61  ct.pop(self.fina
-00046c80: 6c5f 6e61 6d65 2c20 4e6f 6e65 290d 0a20  l_name, None).. 
-00046c90: 2020 2020 2020 2023 2069 6620 616e 7974         # if anyt
-00046ca0: 6869 6e67 2773 2064 6f6e 652c 2077 6520  hing's done, we 
-00046cb0: 6e65 6564 2074 6f20 7377 6170 2074 6865  need to swap the
-00046cc0: 2066 696e 616c 206f 6273 0d0a 2020 2020   final obs..    
-00046cd0: 2020 2020 6966 2064 6f6e 652e 616e 7928      if done.any(
-00046ce0: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
-00046cf0: 646f 6e65 203d 2064 6f6e 652e 7371 7565  done = done.sque
-00046d00: 657a 6528 2d31 290d 0a20 2020 2020 2020  eze(-1)..       
-00046d10: 2020 2020 2069 6620 6669 6e61 6c20 6973       if final is
-00046d20: 206e 6f74 204e 6f6e 653a 0d0a 2020 2020   not None:..    
-00046d30: 2020 2020 2020 2020 2020 2020 7361 7665              save
-00046d40: 645f 6e65 7874 203d 206e 6578 745f 7465  d_next = next_te
-00046d50: 6e73 6f72 6469 6374 2e73 656c 6563 7428  nsordict.select(
-00046d60: 2a66 696e 616c 2e6b 6579 7328 5472 7565  *final.keys(True
-00046d70: 2c20 5472 7565 2929 2e63 6c6f 6e65 2829  , True)).clone()
-00046d80: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00046d90: 2020 6e65 7874 5f74 656e 736f 7264 6963    next_tensordic
-00046da0: 745b 646f 6e65 5d20 3d20 6669 6e61 6c5b  t[done] = final[
-00046db0: 646f 6e65 5d0d 0a20 2020 2020 2020 2020  done]..         
-00046dc0: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
-00046dd0: 2020 2020 2020 2020 2020 7361 7665 645f            saved_
-00046de0: 6e65 7874 203d 206e 6578 745f 7465 6e73  next = next_tens
-00046df0: 6f72 6469 6374 2e73 656c 6563 7428 2a73  ordict.select(*s
-00046e00: 656c 662e 6f62 735f 6b65 7973 292e 636c  elf.obs_keys).cl
-00046e10: 6f6e 6528 290d 0a20 2020 2020 2020 2020  one()..         
-00046e20: 2020 2020 2020 2066 6f72 206f 6273 5f6b         for obs_k
-00046e30: 6579 2069 6e20 7365 6c66 2e6f 6273 5f6b  ey in self.obs_k
-00046e40: 6579 733a 0d0a 2020 2020 2020 2020 2020  eys:..          
-00046e50: 2020 2020 2020 2020 2020 6e65 7874 5f74            next_t
-00046e60: 656e 736f 7264 6963 745b 6f62 735f 6b65  ensordict[obs_ke
-00046e70: 795d 5b64 6f6e 655d 203d 2074 6f72 6368  y][done] = torch
-00046e80: 2e74 656e 736f 7228 6e70 2e6e 616e 290d  .tensor(np.nan).
-00046e90: 0a0d 0a20 2020 2020 2020 2020 2020 2073  ...            s
-00046ea0: 656c 662e 5f6d 656d 6f5b 2273 6176 6564  elf._memo["saved
-00046eb0: 5f6e 6578 7422 5d20 3d20 7361 7665 645f  _next"] = saved_
-00046ec0: 6e65 7874 0d0a 2020 2020 2020 2020 656c  next..        el
-00046ed0: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
-00046ee0: 2073 656c 662e 5f6d 656d 6f5b 2273 6176   self._memo["sav
-00046ef0: 6564 5f6e 6578 7422 5d20 3d20 4e6f 6e65  ed_next"] = None
-00046f00: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00046f10: 206e 6578 745f 7465 6e73 6f72 6469 6374   next_tensordict
-00046f20: 0d0a 0d0a 2020 2020 6465 6620 5f72 6573  ....    def _res
-00046f30: 6574 280d 0a20 2020 2020 2020 2073 656c  et(..        sel
-00046f40: 662c 2074 656e 736f 7264 6963 743a 2054  f, tensordict: T
-00046f50: 656e 736f 7244 6963 7442 6173 652c 2074  ensorDictBase, t
-00046f60: 656e 736f 7264 6963 745f 7265 7365 743a  ensordict_reset:
-00046f70: 2054 656e 736f 7244 6963 7442 6173 650d   TensorDictBase.
-00046f80: 0a20 2020 2029 202d 3e20 5465 6e73 6f72  .    ) -> Tensor
-00046f90: 4469 6374 4261 7365 3a0d 0a20 2020 2020  DictBase:..     
-00046fa0: 2020 2064 6f6e 6520 3d20 7365 6c66 2e5f     done = self._
-00046fb0: 6d65 6d6f 2e67 6574 2822 646f 6e65 222c  memo.get("done",
-00046fc0: 204e 6f6e 6529 0d0a 2020 2020 2020 2020   None)..        
-00046fd0: 7265 7365 7420 3d20 7465 6e73 6f72 6469  reset = tensordi
-00046fe0: 6374 2e67 6574 2822 5f72 6573 6574 222c  ct.get("_reset",
-00046ff0: 2064 6f6e 6529 0d0a 2020 2020 2020 2020   done)..        
-00047000: 6966 2064 6f6e 6520 6973 206e 6f74 204e  if done is not N
-00047010: 6f6e 653a 0d0a 2020 2020 2020 2020 2020  one:..          
-00047020: 2020 646f 6e65 203d 2064 6f6e 652e 7669    done = done.vi
-00047030: 6577 5f61 7328 7265 7365 7429 0d0a 2020  ew_as(reset)..  
-00047040: 2020 2020 2020 6966 2028 0d0a 2020 2020        if (..    
-00047050: 2020 2020 2020 2020 7265 7365 7420 6973          reset is
-00047060: 206e 6f74 2064 6f6e 650d 0a20 2020 2020   not done..     
-00047070: 2020 2020 2020 2061 6e64 2028 7265 7365         and (rese
-00047080: 7420 213d 2064 6f6e 6529 2e61 6e79 2829  t != done).any()
-00047090: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-000470a0: 6974 2063 616e 2068 6170 7065 6e20 7468  it can happen th
-000470b0: 6174 2061 6c6c 2061 7265 2072 6573 6574  at all are reset
-000470c0: 2c20 696e 2077 6869 6368 2063 6173 650d  , in which case.
-000470d0: 0a20 2020 2020 2020 2020 2020 2023 2069  .            # i
-000470e0: 7427 7320 6669 6e65 2028 646f 6573 6e27  t's fine (doesn'
-000470f0: 7420 6e65 6564 2074 6f20 6d61 7463 6820  t need to match 
-00047100: 646f 6e65 290d 0a20 2020 2020 2020 2020  done)..         
-00047110: 2020 2061 6e64 206e 6f74 2072 6573 6574     and not reset
-00047120: 2e61 6c6c 2829 0d0a 2020 2020 2020 2020  .all()..        
-00047130: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
-00047140: 7261 6973 6520 5275 6e74 696d 6545 7272  raise RuntimeErr
-00047150: 6f72 280d 0a20 2020 2020 2020 2020 2020  or(..           
-00047160: 2020 2020 2022 4361 6e6e 6f74 2070 6172       "Cannot par
-00047170: 7469 616c 6c79 2072 6573 6574 2061 2067  tially reset a g
-00047180: 796d 286e 6173 6975 6d29 2061 7379 6e63  ym(nasium) async
-00047190: 2065 6e76 2077 6974 6820 6120 220d 0a20   env with a ".. 
-000471a0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000471b0: 7265 7365 7420 6d61 736b 2074 6861 7420  reset mask that 
-000471c0: 646f 6573 206e 6f74 206d 6174 6368 2074  does not match t
-000471d0: 6865 2064 6f6e 6520 6d61 736b 2e20 220d  he done mask. ".
-000471e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000471f0: 2066 2247 6f74 2072 6573 6574 3d7b 7265   f"Got reset={re
-00047200: 7365 747d 5c6e 616e 6420 646f 6e65 3d7b  set}\nand done={
-00047210: 646f 6e65 7d22 0d0a 2020 2020 2020 2020  done}"..        
-00047220: 2020 2020 290d 0a20 2020 2020 2020 2023      )..        #
-00047230: 2069 6620 6e6f 7420 7265 7365 742e 616e   if not reset.an
-00047240: 7928 292c 2077 6520 646f 6e27 7420 6e65  y(), we don't ne
-00047250: 6564 2074 6f20 646f 2061 6e79 7468 696e  ed to do anythin
-00047260: 672e 0d0a 2020 2020 2020 2020 2320 6966  g...        # if
-00047270: 2072 6573 6574 2e61 6c6c 2829 2c20 7765   reset.all(), we
-00047280: 2064 6f6e 2774 2065 6974 6865 7220 2862   don't either (b
-00047290: 6320 4779 6d57 7261 7070 6572 2077 696c  c GymWrapper wil
-000472a0: 6c20 6361 6c6c 2061 2070 6c61 696e 2072  l call a plain r
-000472b0: 6573 6574 292e 0d0a 2020 2020 2020 2020  eset)...        
-000472c0: 6966 2072 6573 6574 2069 7320 6e6f 7420  if reset is not 
-000472d0: 4e6f 6e65 2061 6e64 2072 6573 6574 2e61  None and reset.a
-000472e0: 6e79 2829 3a0d 0a20 2020 2020 2020 2020  ny():..         
-000472f0: 2020 2073 6176 6564 5f6e 6578 7420 3d20     saved_next = 
-00047300: 7365 6c66 2e5f 6d65 6d6f 5b22 7361 7665  self._memo["save
-00047310: 645f 6e65 7874 225d 0d0a 2020 2020 2020  d_next"]..      
-00047320: 2020 2020 2020 6966 2073 6176 6564 5f6e        if saved_n
-00047330: 6578 7420 6973 204e 6f6e 653a 0d0a 2020  ext is None:..  
-00047340: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00047350: 2072 6573 6574 2e61 6c6c 2829 3a0d 0a20   reset.all():.. 
-00047360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047370: 2020 2023 2057 6527 7265 2066 696e 653a     # We're fine:
-00047380: 2074 6869 7320 6d65 616e 7320 7468 6174   this means that
-00047390: 2061 2066 756c 6c20 7265 7365 7420 7761   a full reset wa
-000473a0: 7320 7061 7373 6564 2061 6e64 2074 6865  s passed and the
-000473b0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000473c0: 2020 2020 2020 2320 656e 7620 7761 7320        # env was 
-000473d0: 6d61 6e75 616c 6c79 2072 6573 6574 0d0a  manually reset..
-000473e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000473f0: 2020 2020 7465 6e73 6f72 6469 6374 5f72      tensordict_r
-00047400: 6573 6574 2e70 6f70 2873 656c 662e 6669  eset.pop(self.fi
-00047410: 6e61 6c5f 6e61 6d65 2c20 4e6f 6e65 290d  nal_name, None).
-00047420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00047430: 2020 2020 2072 6574 7572 6e20 7465 6e73       return tens
-00047440: 6f72 6469 6374 5f72 6573 6574 0d0a 2020  ordict_reset..  
-00047450: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00047460: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
-00047470: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
-00047480: 2020 2020 2020 2022 4469 6420 6e6f 7420         "Did not 
-00047490: 6669 6e64 2061 2073 6176 6564 2074 656e  find a saved ten
-000474a0: 736f 7264 6963 7420 7768 696c 6520 7468  sordict while th
-000474b0: 6520 7265 7365 7420 6d61 736b 2077 6173  e reset mask was
-000474c0: 2022 0d0a 2020 2020 2020 2020 2020 2020   "..            
-000474d0: 2020 2020 2020 2020 6622 6e6f 7420 656d          f"not em
-000474e0: 7074 793a 2072 6573 6574 3d7b 7265 7365  pty: reset={rese
-000474f0: 747d 2e20 446f 6e65 2077 6173 207b 646f  t}. Done was {do
-00047500: 6e65 7d2e 220d 0a20 2020 2020 2020 2020  ne}."..         
-00047510: 2020 2020 2020 2029 0d0a 2020 2020 2020         )..      
-00047520: 2020 2020 2020 2320 7265 7365 7420 3d20        # reset = 
-00047530: 7265 7365 742e 7669 6577 2874 656e 736f  reset.view(tenso
-00047540: 7264 6963 742e 7368 6170 6529 0d0a 2020  rdict.shape)..  
-00047550: 2020 2020 2020 2020 2020 2320 7765 2068            # we h
-00047560: 6176 6520 6120 6461 7461 2063 6f6e 7461  ave a data conta
-00047570: 696e 6572 2066 726f 6d20 7468 6520 7072  iner from the pr
-00047580: 6576 696f 7573 2063 616c 6c20 746f 2073  evious call to s
-00047590: 7465 700d 0a20 2020 2020 2020 2020 2020  tep..           
-000475a0: 2023 2074 6861 7420 636f 6e74 6169 6e73   # that contains
-000475b0: 2070 6172 7420 6f66 2074 6865 206f 6273   part of the obs
-000475c0: 6572 7661 7469 6f6e 2077 6520 6e65 6564  ervation we need
-000475d0: 2e0d 0a20 2020 2020 2020 2020 2020 2023  ...            #
-000475e0: 2057 6520 6361 6e20 7361 6665 6c79 2070   We can safely p
-000475f0: 6c61 6365 2074 6865 6d20 6261 636b 2069  lace them back i
-00047600: 6e20 7468 6520 7265 7365 7420 7265 7375  n the reset resu
-00047610: 6c74 2074 656e 736f 7264 6963 743a 0d0a  lt tensordict:..
-00047620: 2020 2020 2020 2020 2020 2020 2320 696e              # in
-00047630: 2065 6e76 2e72 6f6c 6c6f 7574 2829 2c20   env.rollout(), 
-00047640: 7468 6520 7265 7375 6c74 206f 6620 7265  the result of re
-00047650: 7365 7428 2920 6973 2061 7373 756d 6564  set() is assumed
-00047660: 2074 6f20 6265 206a 7573 740d 0a20 2020   to be just..   
-00047670: 2020 2020 2020 2020 2023 2074 6865 2074           # the t
-00047680: 6420 6672 6f6d 2070 7265 7669 6f75 7320  d from previous 
-00047690: 7374 6570 2077 6974 6820 7570 6461 7465  step with update
-000476a0: 6420 7661 6c75 6573 2066 726f 6d20 7265  d values from re
-000476b0: 7365 742e 0d0a 2020 2020 2020 2020 2020  set...          
-000476c0: 2020 2320 496e 206f 7572 2063 6173 652c    # In our case,
-000476d0: 2069 7420 7769 6c6c 2061 6c77 6179 7320   it will always 
-000476e0: 6265 2074 6865 2063 6173 6520 7468 6174  be the case that
-000476f0: 2061 6c6c 2074 6865 7365 2076 616c 7565   all these value
-00047700: 730d 0a20 2020 2020 2020 2020 2020 2023  s..            #
-00047710: 2061 7265 2070 726f 7065 726c 7920 7365   are properly se
-00047720: 742e 0d0a 2020 2020 2020 2020 2020 2020  t...            
-00047730: 2320 636f 6c6c 6563 746f 7273 2065 7665  # collectors eve
-00047740: 6e20 7461 6b65 2063 6172 6520 6f66 2064  n take care of d
-00047750: 6f69 6e67 2061 6e20 6578 7472 6120 6d61  oing an extra ma
-00047760: 736b 696e 6720 736f 2069 7427 7320 6576  sking so it's ev
-00047770: 656e 0d0a 2020 2020 2020 2020 2020 2020  en..            
-00047780: 2320 7361 6665 722e 0d0a 2020 2020 2020  # safer...      
-00047790: 2020 2020 2020 7465 6e73 6f72 6469 6374        tensordict
-000477a0: 5f72 6573 6574 2e75 7064 6174 6528 7361  _reset.update(sa
-000477b0: 7665 645f 6e65 7874 290d 0a20 2020 2020  ved_next)..     
-000477c0: 2020 2020 2020 2066 6f72 2064 6f6e 655f         for done_
-000477d0: 6b65 7920 696e 2073 656c 662e 646f 6e65  key in self.done
-000477e0: 5f6b 6579 733a 0d0a 2020 2020 2020 2020  _keys:..        
-000477f0: 2020 2020 2020 2020 2320 4d61 6b65 2073          # Make s
-00047800: 7572 6520 7468 6174 2061 6c6c 2064 6f6e  ure that all don
-00047810: 6520 6172 6520 4661 6c73 650d 0a20 2020  e are False..   
-00047820: 2020 2020 2020 2020 2020 2020 2064 6f6e               don
-00047830: 6520 3d20 7465 6e73 6f72 6469 6374 2e67  e = tensordict.g
-00047840: 6574 2864 6f6e 655f 6b65 792c 204e 6f6e  et(done_key, Non
-00047850: 6529 0d0a 2020 2020 2020 2020 2020 2020  e)..            
-00047860: 2020 2020 6966 2064 6f6e 6520 6973 206e      if done is n
-00047870: 6f74 204e 6f6e 653a 0d0a 2020 2020 2020  ot None:..      
-00047880: 2020 2020 2020 2020 2020 2020 2020 646f                do
-00047890: 6e65 203d 2064 6f6e 652e 636c 6f6e 6528  ne = done.clone(
-000478a0: 292e 6669 6c6c 5f28 3029 0d0a 2020 2020  ).fill_(0)..    
-000478b0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000478c0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-000478d0: 2020 2020 2020 2064 6f6e 6520 3d20 746f         done = to
-000478e0: 7263 682e 7a65 726f 7328 0d0a 2020 2020  rch.zeros(..    
-000478f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047900: 2020 2020 282a 7465 6e73 6f72 6469 6374      (*tensordict
-00047910: 2e62 6174 6368 5f73 697a 652c 2031 292c  .batch_size, 1),
-00047920: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00047930: 2020 2020 2020 2020 2020 6465 7669 6365            device
-00047940: 3d74 656e 736f 7264 6963 742e 6465 7669  =tensordict.devi
-00047950: 6365 2c0d 0a20 2020 2020 2020 2020 2020  ce,..           
-00047960: 2020 2020 2020 2020 2020 2020 2064 7479               dty
-00047970: 7065 3d74 6f72 6368 2e62 6f6f 6c2c 0d0a  pe=torch.bool,..
-00047980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047990: 2020 2020 290d 0a20 2020 2020 2020 2020      )..         
-000479a0: 2020 2020 2020 2074 656e 736f 7264 6963         tensordic
-000479b0: 742e 7365 7428 646f 6e65 5f6b 6579 2c20  t.set(done_key, 
-000479c0: 646f 6e65 290d 0a20 2020 2020 2020 2074  done)..        t
-000479d0: 656e 736f 7264 6963 745f 7265 7365 742e  ensordict_reset.
-000479e0: 706f 7028 7365 6c66 2e66 696e 616c 5f6e  pop(self.final_n
-000479f0: 616d 652c 204e 6f6e 6529 0d0a 2020 2020  ame, None)..    
-00047a00: 2020 2020 7265 7475 726e 2074 656e 736f      return tenso
-00047a10: 7264 6963 745f 7265 7365 740d 0a0d 0a20  rdict_reset.... 
-00047a20: 2020 2040 7072 6f70 6572 7479 0d0a 2020     @property..  
-00047a30: 2020 6465 6620 646f 6e65 5f6b 6579 7328    def done_keys(
-00047a40: 7365 6c66 2920 2d3e 204c 6973 745b 4e65  self) -> List[Ne
-00047a50: 7374 6564 4b65 795d 3a0d 0a20 2020 2020  stedKey]:..     
-00047a60: 2020 206b 6579 7320 3d20 7365 6c66 2e5f     keys = self._
-00047a70: 5f64 6963 745f 5f2e 6765 7428 225f 646f  _dict__.get("_do
-00047a80: 6e65 5f6b 6579 7322 2c20 4e6f 6e65 290d  ne_keys", None).
-00047a90: 0a20 2020 2020 2020 2069 6620 6b65 7973  .        if keys
-00047aa0: 2069 7320 4e6f 6e65 3a0d 0a20 2020 2020   is None:..     
-00047ab0: 2020 2020 2020 206b 6579 7320 3d20 7365         keys = se
-00047ac0: 6c66 2e70 6172 656e 742e 646f 6e65 5f6b  lf.parent.done_k
-00047ad0: 6579 730d 0a20 2020 2020 2020 2020 2020  eys..           
-00047ae0: 2023 2077 6520 6a75 7374 2077 616e 7420   # we just want 
-00047af0: 7468 6520 2264 6f6e 6522 206b 6579 0d0a  the "done" key..
-00047b00: 2020 2020 2020 2020 2020 2020 5f64 6f6e              _don
-00047b10: 655f 6b65 7973 203d 205b 5d0d 0a20 2020  e_keys = []..   
-00047b20: 2020 2020 2020 2020 2066 6f72 206b 6579           for key
-00047b30: 2069 6e20 6b65 7973 3a0d 0a20 2020 2020   in keys:..     
-00047b40: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00047b50: 7420 6973 696e 7374 616e 6365 286b 6579  t isinstance(key
-00047b60: 2c20 7475 706c 6529 3a0d 0a20 2020 2020  , tuple):..     
-00047b70: 2020 2020 2020 2020 2020 2020 2020 206b                 k
-00047b80: 6579 203d 2028 6b65 792c 290d 0a20 2020  ey = (key,)..   
-00047b90: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00047ba0: 6b65 795b 2d31 5d20 3d3d 2022 646f 6e65  key[-1] == "done
-00047bb0: 223a 0d0a 2020 2020 2020 2020 2020 2020  ":..            
-00047bc0: 2020 2020 2020 2020 5f64 6f6e 655f 6b65          _done_ke
-00047bd0: 7973 2e61 7070 656e 6428 756e 7261 7665  ys.append(unrave
-00047be0: 6c5f 6b65 7928 6b65 7929 290d 0a20 2020  l_key(key))..   
-00047bf0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-00047c00: 6c65 6e28 5f64 6f6e 655f 6b65 7973 293a  len(_done_keys):
-00047c10: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00047c20: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
-00047c30: 7272 6f72 2822 436f 756c 6420 6e6f 7420  rror("Could not 
-00047c40: 6669 6e64 2061 2027 646f 6e65 2720 6b65  find a 'done' ke
-00047c50: 7920 696e 2074 6865 2065 6e76 2073 7065  y in the env spe
-00047c60: 6373 2e22 290d 0a20 2020 2020 2020 2020  cs.")..         
-00047c70: 2020 2073 656c 662e 5f64 6f6e 655f 6b65     self._done_ke
-00047c80: 7973 203d 205f 646f 6e65 5f6b 6579 730d  ys = _done_keys.
-00047c90: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00047ca0: 6b65 7973 0d0a 0d0a 2020 2020 4070 726f  keys....    @pro
-00047cb0: 7065 7274 790d 0a20 2020 2064 6566 206f  perty..    def o
-00047cc0: 6273 5f6b 6579 7328 7365 6c66 2920 2d3e  bs_keys(self) ->
-00047cd0: 204c 6973 745b 4e65 7374 6564 4b65 795d   List[NestedKey]
-00047ce0: 3a0d 0a20 2020 2020 2020 206b 6579 7320  :..        keys 
-00047cf0: 3d20 7365 6c66 2e5f 5f64 6963 745f 5f2e  = self.__dict__.
-00047d00: 6765 7428 225f 6f62 735f 6b65 7973 222c  get("_obs_keys",
-00047d10: 204e 6f6e 6529 0d0a 2020 2020 2020 2020   None)..        
-00047d20: 6966 206b 6579 7320 6973 204e 6f6e 653a  if keys is None:
-00047d30: 0d0a 2020 2020 2020 2020 2020 2020 6b65  ..            ke
-00047d40: 7973 203d 206c 6973 7428 7365 6c66 2e70  ys = list(self.p
-00047d50: 6172 656e 742e 6f62 7365 7276 6174 696f  arent.observatio
-00047d60: 6e5f 7370 6563 2e6b 6579 7328 5472 7565  n_spec.keys(True
-00047d70: 2c20 5472 7565 2929 0d0a 2020 2020 2020  , True))..      
-00047d80: 2020 2020 2020 7365 6c66 2e5f 6f62 735f        self._obs_
-00047d90: 6b65 7973 203d 206b 6579 730d 0a20 2020  keys = keys..   
-00047da0: 2020 2020 2072 6574 7572 6e20 6b65 7973       return keys
-00047db0: 0d0a 0d0a 2020 2020 6465 6620 7472 616e  ....    def tran
-00047dc0: 7366 6f72 6d5f 6f62 7365 7276 6174 696f  sform_observatio
-00047dd0: 6e5f 7370 6563 2873 656c 662c 206f 6273  n_spec(self, obs
-00047de0: 6572 7661 7469 6f6e 5f73 7065 633a 2054  ervation_spec: T
-00047df0: 656e 736f 7253 7065 6329 202d 3e20 5465  ensorSpec) -> Te
-00047e00: 6e73 6f72 5370 6563 3a0d 0a20 2020 2020  nsorSpec:..     
-00047e10: 2020 2069 6620 7365 6c66 2e66 696e 616c     if self.final
-00047e20: 5f6e 616d 6520 696e 206f 6273 6572 7661  _name in observa
-00047e30: 7469 6f6e 5f73 7065 632e 6b65 7973 2854  tion_spec.keys(T
-00047e40: 7275 6529 3a0d 0a20 2020 2020 2020 2020  rue):..         
-00047e50: 2020 2064 656c 206f 6273 6572 7661 7469     del observati
-00047e60: 6f6e 5f73 7065 635b 7365 6c66 2e66 696e  on_spec[self.fin
-00047e70: 616c 5f6e 616d 655d 0d0a 2020 2020 2020  al_name]..      
-00047e80: 2020 7265 7475 726e 206f 6273 6572 7661    return observa
-00047e90: 7469 6f6e 5f73 7065 630d 0a0d 0a20 2020  tion_spec....   
-00047ea0: 2064 6566 2066 6f72 7761 7264 2873 656c   def forward(sel
-00047eb0: 662c 2074 656e 736f 7264 6963 743a 2054  f, tensordict: T
-00047ec0: 656e 736f 7244 6963 7442 6173 6529 202d  ensorDictBase) -
-00047ed0: 3e20 5465 6e73 6f72 4469 6374 4261 7365  > TensorDictBase
-00047ee0: 3a0d 0a20 2020 2020 2020 2072 6169 7365  :..        raise
-00047ef0: 2052 756e 7469 6d65 4572 726f 7228 464f   RuntimeError(FO
-00047f00: 5257 4152 445f 4e4f 545f 494d 504c 454d  RWARD_NOT_IMPLEM
-00047f10: 454e 5445 442e 666f 726d 6174 2874 7970  ENTED.format(typ
-00047f20: 6528 7365 6c66 2929 290d 0a0d 0a0d 0a63  e(self)))......c
-00047f30: 6c61 7373 2042 7572 6e49 6e54 7261 6e73  lass BurnInTrans
-00047f40: 666f 726d 2854 7261 6e73 666f 726d 293a  form(Transform):
-00047f50: 0d0a 2020 2020 2222 2254 7261 6e73 666f  ..    """Transfo
-00047f60: 726d 2074 6f20 7061 7274 6961 6c6c 7920  rm to partially 
-00047f70: 6275 726e 2d69 6e20 6461 7461 2073 6571  burn-in data seq
-00047f80: 7565 6e63 6573 2e0d 0a0d 0a20 2020 2054  uences.....    T
-00047f90: 6869 7320 7472 616e 7366 6f72 6d20 6973  his transform is
-00047fa0: 2075 7365 6675 6c20 746f 206f 6274 6169   useful to obtai
-00047fb0: 6e20 7570 2d74 6f2d 6461 7465 2072 6563  n up-to-date rec
-00047fc0: 7572 7265 6e74 2073 7461 7465 7320 7768  urrent states wh
-00047fd0: 656e 0d0a 2020 2020 7468 6579 2061 7265  en..    they are
-00047fe0: 206e 6f74 2061 7661 696c 6162 6c65 2e20   not available. 
-00047ff0: 4974 2062 7572 6e73 2d69 6e20 6120 6e75  It burns-in a nu
-00048000: 6d62 6572 206f 6620 7374 6570 7320 616c  mber of steps al
-00048010: 6f6e 6720 7468 6520 7469 6d65 2064 696d  ong the time dim
-00048020: 656e 7369 6f6e 0d0a 2020 2020 6672 6f6d  ension..    from
-00048030: 2073 616d 706c 6564 2073 6571 7565 6e74   sampled sequent
-00048040: 6961 6c20 6461 7461 2073 6c69 6365 7320  ial data slices 
-00048050: 616e 6420 7265 7475 7273 2074 6865 2072  and returs the r
-00048060: 656d 6169 6e69 6e67 2064 6174 6120 7365  emaining data se
-00048070: 7175 656e 6365 2077 6974 680d 0a20 2020  quence with..   
-00048080: 2074 6865 2062 7572 6e74 2d69 6e20 6461   the burnt-in da
-00048090: 7461 2069 6e20 6974 7320 696e 6974 6961  ta in its initia
-000480a0: 6c20 7469 6d65 2073 7465 702e 2054 6869  l time step. Thi
-000480b0: 7320 7472 616e 7366 6f72 6d20 6973 2069  s transform is i
-000480c0: 6e74 656e 6465 6420 746f 2062 6520 7573  ntended to be us
-000480d0: 6564 2061 7320 610d 0a20 2020 2072 6570  ed as a..    rep
-000480e0: 6c61 7920 6275 6666 6572 2074 7261 6e73  lay buffer trans
-000480f0: 666f 726d 2c20 6e6f 7420 6173 2061 6e20  form, not as an 
-00048100: 656e 7669 726f 6e6d 656e 7420 7472 616e  environment tran
-00048110: 7366 6f72 6d2e 0d0a 0d0a 2020 2020 4172  sform.....    Ar
-00048120: 6773 3a0d 0a20 2020 2020 2020 206d 6f64  gs:..        mod
-00048130: 756c 6573 2028 7365 7175 656e 6365 206f  ules (sequence o
-00048140: 6620 5465 6e73 6f72 4469 6374 4d6f 6475  f TensorDictModu
-00048150: 6c65 293a 2041 206c 6973 7420 6f66 206d  le): A list of m
-00048160: 6f64 756c 6573 2075 7365 6420 746f 2062  odules used to b
-00048170: 7572 6e2d 696e 2064 6174 6120 7365 7175  urn-in data sequ
-00048180: 656e 6365 732e 0d0a 2020 2020 2020 2020  ences...        
-00048190: 6275 726e 5f69 6e20 2869 6e74 293a 2054  burn_in (int): T
-000481a0: 6865 206e 756d 6265 7220 6f66 2074 696d  he number of tim
-000481b0: 6520 7374 6570 7320 746f 2062 7572 6e20  e steps to burn 
-000481c0: 696e 2e0d 0a20 2020 2020 2020 206f 7574  in...        out
-000481d0: 5f6b 6579 7320 2873 6571 7565 6e63 6520  _keys (sequence 
-000481e0: 6f66 204e 6573 7465 644b 6579 2c20 6f70  of NestedKey, op
-000481f0: 7469 6f6e 616c 293a 2064 6573 7469 6e61  tional): destina
-00048200: 7469 6f6e 206b 6579 732e 2044 6566 6175  tion keys. Defau
-00048210: 6c74 7320 746f 0d0a 2020 2020 2020 2020  lts to..        
-00048220: 616c 6c20 7468 6520 6d6f 6475 6c65 7320  all the modules 
-00048230: 606f 7574 5f6b 6579 7360 2074 6861 7420  `out_keys` that 
-00048240: 706f 696e 7420 746f 2074 6865 206e 6578  point to the nex
-00048250: 7420 7469 6d65 2073 7465 7020 2865 2e67  t time step (e.g
-00048260: 2e20 6022 6869 6464 656e 2260 2069 6620  . `"hidden"` if 
-00048270: 600d 0a20 2020 2020 2020 2028 226e 6578  `..        ("nex
-00048280: 7422 2c20 2268 6964 6465 6e22 2960 2069  t", "hidden")` i
-00048290: 7320 7061 7274 206f 6620 7468 6520 606f  s part of the `o
-000482a0: 7574 5f6b 6579 7360 206f 6620 6120 6d6f  ut_keys` of a mo
-000482b0: 6475 6c65 292e 0d0a 0d0a 2020 2020 2e2e  dule).....    ..
-000482c0: 206e 6f74 653a 3a0d 0a20 2020 2020 2020   note::..       
-000482d0: 2054 6869 7320 7472 616e 7366 6f72 6d20   This transform 
-000482e0: 6578 7065 6374 7320 6173 2069 6e70 7574  expects as input
-000482f0: 7320 5465 6e73 6f72 4469 6374 7320 7769  s TensorDicts wi
-00048300: 7468 2069 7473 206c 6173 7420 6469 6d65  th its last dime
-00048310: 6e73 696f 6e20 6265 696e 6720 7468 650d  nsion being the.
-00048320: 0a20 2020 2020 2020 2074 696d 6520 6469  .        time di
-00048330: 6d65 6e73 696f 6e2e 2049 7420 616c 736f  mension. It also
-00048340: 2020 6173 7375 6d65 7320 7468 6174 2061    assumes that a
-00048350: 6c6c 2070 726f 7669 6465 6420 6d6f 6475  ll provided modu
-00048360: 6c65 7320 6361 6e20 7072 6f63 6573 730d  les can process.
-00048370: 0a20 2020 2020 2020 2073 6571 7565 6e74  .        sequent
-00048380: 6961 6c20 6461 7461 2e0d 0a0d 0a20 2020  ial data.....   
-00048390: 2045 7861 6d70 6c65 733a 0d0a 2020 2020   Examples:..    
-000483a0: 2020 2020 3e3e 3e20 696d 706f 7274 2074      >>> import t
-000483b0: 6f72 6368 0d0a 2020 2020 2020 2020 3e3e  orch..        >>
-000483c0: 3e20 6672 6f6d 2074 656e 736f 7264 6963  > from tensordic
-000483d0: 7420 696d 706f 7274 2054 656e 736f 7244  t import TensorD
-000483e0: 6963 740d 0a20 2020 2020 2020 203e 3e3e  ict..        >>>
-000483f0: 2066 726f 6d20 746f 7263 6872 6c2e 656e   from torchrl.en
-00048400: 7673 2e74 7261 6e73 666f 726d 7320 696d  vs.transforms im
-00048410: 706f 7274 2042 7572 6e49 6e54 7261 6e73  port BurnInTrans
-00048420: 666f 726d 0d0a 2020 2020 2020 2020 3e3e  form..        >>
-00048430: 3e20 6672 6f6d 2074 6f72 6368 726c 2e6d  > from torchrl.m
-00048440: 6f64 756c 6573 2069 6d70 6f72 7420 4752  odules import GR
-00048450: 554d 6f64 756c 650d 0a20 2020 2020 2020  UModule..       
-00048460: 203e 3e3e 2067 7275 5f6d 6f64 756c 6520   >>> gru_module 
-00048470: 3d20 4752 554d 6f64 756c 6528 0d0a 2020  = GRUModule(..  
-00048480: 2020 2020 2020 2e2e 2e20 2020 2020 696e        ...     in
-00048490: 7075 745f 7369 7a65 3d31 302c 0d0a 2020  put_size=10,..  
-000484a0: 2020 2020 2020 2e2e 2e20 2020 2020 6869        ...     hi
-000484b0: 6464 656e 5f73 697a 653d 3130 2c0d 0a20  dden_size=10,.. 
-000484c0: 2020 2020 2020 202e 2e2e 2020 2020 2069         ...     i
-000484d0: 6e5f 6b65 7973 3d5b 226f 6273 6572 7661  n_keys=["observa
-000484e0: 7469 6f6e 222c 2022 6869 6464 656e 225d  tion", "hidden"]
-000484f0: 2c0d 0a20 2020 2020 2020 202e 2e2e 2020  ,..        ...  
-00048500: 2020 206f 7574 5f6b 6579 733d 5b22 696e     out_keys=["in
-00048510: 7465 726d 6564 6961 7465 222c 2028 226e  termediate", ("n
-00048520: 6578 7422 2c20 2268 6964 6465 6e22 295d  ext", "hidden")]
-00048530: 2c0d 0a20 2020 2020 2020 202e 2e2e 2029  ,..        ... )
-00048540: 2e73 6574 5f72 6563 7572 7265 6e74 5f6d  .set_recurrent_m
-00048550: 6f64 6528 5472 7565 290d 0a20 2020 2020  ode(True)..     
-00048560: 2020 203e 3e3e 2062 7572 6e5f 696e 5f74     >>> burn_in_t
-00048570: 7261 6e73 666f 726d 203d 2042 7572 6e49  ransform = BurnI
-00048580: 6e54 7261 6e73 666f 726d 280d 0a20 2020  nTransform(..   
-00048590: 2020 2020 202e 2e2e 2020 2020 206d 6f64       ...     mod
-000485a0: 756c 6573 3d5b 6772 755f 6d6f 6475 6c65  ules=[gru_module
-000485b0: 5d2c 0d0a 2020 2020 2020 2020 2e2e 2e20  ],..        ... 
-000485c0: 2020 2020 6275 726e 5f69 6e3d 352c 0d0a      burn_in=5,..
-000485d0: 2020 2020 2020 2020 2e2e 2e20 290d 0a20          ... ).. 
-000485e0: 2020 2020 2020 203e 3e3e 2074 6420 3d20         >>> td = 
-000485f0: 5465 6e73 6f72 4469 6374 287b 0d0a 2020  TensorDict({..  
-00048600: 2020 2020 2020 2e2e 2e20 2020 2020 226f        ...     "o
-00048610: 6273 6572 7661 7469 6f6e 223a 2074 6f72  bservation": tor
-00048620: 6368 2e72 616e 646e 2832 2c20 3130 2c20  ch.randn(2, 10, 
-00048630: 3130 292c 0d0a 2020 2020 2020 2020 2e2e  10),..        ..
-00048640: 2e20 2020 2020 2022 6869 6464 656e 223a  .      "hidden":
-00048650: 2074 6f72 6368 2e72 616e 646e 2832 2c20   torch.randn(2, 
-00048660: 3130 2c20 6772 755f 6d6f 6475 6c65 2e67  10, gru_module.g
-00048670: 7275 2e6e 756d 5f6c 6179 6572 732c 2031  ru.num_layers, 1
-00048680: 3029 2c0d 0a20 2020 2020 2020 202e 2e2e  0),..        ...
-00048690: 2020 2020 2020 2269 735f 696e 6974 223a        "is_init":
-000486a0: 2074 6f72 6368 2e7a 6572 6f73 2832 2c20   torch.zeros(2, 
-000486b0: 3130 2c20 3129 2c0d 0a20 2020 2020 2020  10, 1),..       
-000486c0: 202e 2e2e 207d 2c20 6261 7463 685f 7369   ... }, batch_si
-000486d0: 7a65 3d5b 322c 2031 305d 290d 0a20 2020  ze=[2, 10])..   
-000486e0: 2020 2020 203e 3e3e 2074 6420 3d20 6275       >>> td = bu
-000486f0: 726e 5f69 6e5f 7472 616e 7366 6f72 6d28  rn_in_transform(
-00048700: 7464 290d 0a20 2020 2020 2020 203e 3e3e  td)..        >>>
-00048710: 2074 642e 7368 6170 650d 0a20 2020 2020   td.shape..     
-00048720: 2020 2074 6f72 6368 2e53 697a 6528 5b32     torch.Size([2
-00048730: 2c20 355d 290d 0a20 2020 2020 2020 203e  , 5])..        >
-00048740: 3e3e 2074 642e 6765 7428 2268 6964 6465  >> td.get("hidde
-00048750: 6e22 292e 6162 7328 292e 7375 6d28 290d  n").abs().sum().
-00048760: 0a20 2020 2020 2020 2074 656e 736f 7228  .        tensor(
-00048770: 3836 2e33 3030 3829 0d0a 0d0a 2020 2020  86.3008)....    
-00048780: 2020 2020 3e3e 3e20 6672 6f6d 2074 6f72      >>> from tor
-00048790: 6368 726c 2e64 6174 6120 696d 706f 7274  chrl.data import
-000487a0: 204c 617a 794d 656d 6d61 7053 746f 7261   LazyMemmapStora
-000487b0: 6765 2c20 5465 6e73 6f72 4469 6374 5265  ge, TensorDictRe
-000487c0: 706c 6179 4275 6666 6572 0d0a 2020 2020  playBuffer..    
-000487d0: 2020 2020 3e3e 3e20 6275 6666 6572 203d      >>> buffer =
-000487e0: 2054 656e 736f 7244 6963 7452 6570 6c61   TensorDictRepla
-000487f0: 7942 7566 6665 7228 0d0a 2020 2020 2020  yBuffer(..      
-00048800: 2020 2e2e 2e20 2020 2020 7374 6f72 6167    ...     storag
-00048810: 653d 4c61 7a79 4d65 6d6d 6170 5374 6f72  e=LazyMemmapStor
-00048820: 6167 6528 3229 2c0d 0a20 2020 2020 2020  age(2),..       
-00048830: 202e 2e2e 2020 2020 2062 6174 6368 5f73   ...     batch_s
-00048840: 697a 653d 312c 0d0a 2020 2020 2020 2020  ize=1,..        
-00048850: 2e2e 2e20 290d 0a20 2020 2020 2020 203e  ... )..        >
-00048860: 3e3e 2062 7566 6665 722e 6170 7065 6e64  >> buffer.append
-00048870: 5f74 7261 6e73 666f 726d 2862 7572 6e5f  _transform(burn_
-00048880: 696e 5f74 7261 6e73 666f 726d 290d 0a20  in_transform).. 
-00048890: 2020 2020 2020 203e 3e3e 2074 6420 3d20         >>> td = 
-000488a0: 5465 6e73 6f72 4469 6374 287b 0d0a 2020  TensorDict({..  
-000488b0: 2020 2020 2020 2e2e 2e20 2020 2020 226f        ...     "o
-000488c0: 6273 6572 7661 7469 6f6e 223a 2074 6f72  bservation": tor
-000488d0: 6368 2e72 616e 646e 2832 2c20 3130 2c20  ch.randn(2, 10, 
-000488e0: 3130 292c 0d0a 2020 2020 2020 2020 2e2e  10),..        ..
-000488f0: 2e20 2020 2020 2022 6869 6464 656e 223a  .      "hidden":
-00048900: 2074 6f72 6368 2e72 616e 646e 2832 2c20   torch.randn(2, 
-00048910: 3130 2c20 6772 755f 6d6f 6475 6c65 2e67  10, gru_module.g
-00048920: 7275 2e6e 756d 5f6c 6179 6572 732c 2031  ru.num_layers, 1
-00048930: 3029 2c0d 0a20 2020 2020 2020 202e 2e2e  0),..        ...
-00048940: 2020 2020 2020 2269 735f 696e 6974 223a        "is_init":
-00048950: 2074 6f72 6368 2e7a 6572 6f73 2832 2c20   torch.zeros(2, 
-00048960: 3130 2c20 3129 2c0d 0a20 2020 2020 2020  10, 1),..       
-00048970: 202e 2e2e 207d 2c20 6261 7463 685f 7369   ... }, batch_si
-00048980: 7a65 3d5b 322c 2031 305d 290d 0a20 2020  ze=[2, 10])..   
-00048990: 2020 2020 203e 3e3e 2062 7566 6665 722e       >>> buffer.
-000489a0: 6578 7465 6e64 2874 6429 0d0a 2020 2020  extend(td)..    
-000489b0: 2020 2020 3e3e 3e20 7464 203d 2062 7566      >>> td = buf
-000489c0: 6665 722e 7361 6d70 6c65 2831 290d 0a20  fer.sample(1).. 
-000489d0: 2020 2020 2020 203e 3e3e 2074 642e 7368         >>> td.sh
-000489e0: 6170 650d 0a20 2020 2020 2020 2074 6f72  ape..        tor
-000489f0: 6368 2e53 697a 6528 5b31 2c20 355d 290d  ch.Size([1, 5]).
-00048a00: 0a20 2020 2020 2020 203e 3e3e 2074 642e  .        >>> td.
-00048a10: 6765 7428 2268 6964 6465 6e22 292e 6162  get("hidden").ab
-00048a20: 7328 292e 7375 6d28 290d 0a20 2020 2020  s().sum()..     
-00048a30: 2020 2074 656e 736f 7228 3337 2e30 3334     tensor(37.034
-00048a40: 3429 0d0a 2020 2020 2222 220d 0a0d 0a20  4)..    """.... 
-00048a50: 2020 2069 6e76 6572 7469 626c 6520 3d20     invertible = 
-00048a60: 4661 6c73 650d 0a0d 0a20 2020 2064 6566  False....    def
-00048a70: 205f 5f69 6e69 745f 5f28 0d0a 2020 2020   __init__(..    
-00048a80: 2020 2020 7365 6c66 2c0d 0a20 2020 2020      self,..     
-00048a90: 2020 206d 6f64 756c 6573 3a20 5365 7175     modules: Sequ
-00048aa0: 656e 6365 5b54 656e 736f 7244 6963 744d  ence[TensorDictM
-00048ab0: 6f64 756c 6542 6173 655d 2c0d 0a20 2020  oduleBase],..   
-00048ac0: 2020 2020 2062 7572 6e5f 696e 3a20 696e       burn_in: in
-00048ad0: 742c 0d0a 2020 2020 2020 2020 6f75 745f  t,..        out_
-00048ae0: 6b65 7973 3a20 5365 7175 656e 6365 5b4e  keys: Sequence[N
-00048af0: 6573 7465 644b 6579 5d20 7c20 4e6f 6e65  estedKey] | None
-00048b00: 203d 204e 6f6e 652c 0d0a 2020 2020 293a   = None,..    ):
-00048b10: 0d0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-00048b20: 2069 7369 6e73 7461 6e63 6528 6d6f 6475   isinstance(modu
-00048b30: 6c65 732c 2053 6571 7565 6e63 6529 3a0d  les, Sequence):.
-00048b40: 0a20 2020 2020 2020 2020 2020 206d 6f64  .            mod
-00048b50: 756c 6573 203d 205b 6d6f 6475 6c65 735d  ules = [modules]
-00048b60: 0d0a 0d0a 2020 2020 2020 2020 666f 7220  ....        for 
-00048b70: 6d6f 6475 6c65 2069 6e20 6d6f 6475 6c65  module in module
-00048b80: 733a 0d0a 2020 2020 2020 2020 2020 2020  s:..            
-00048b90: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
-00048ba0: 6528 6d6f 6475 6c65 2c20 5465 6e73 6f72  e(module, Tensor
-00048bb0: 4469 6374 4d6f 6475 6c65 4261 7365 293a  DictModuleBase):
-00048bc0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00048bd0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-00048be0: 6f72 280d 0a20 2020 2020 2020 2020 2020  or(..           
-00048bf0: 2020 2020 2020 2020 2066 2241 6c6c 206d           f"All m
-00048c00: 6f64 756c 6573 206d 7573 7420 6265 2054  odules must be T
-00048c10: 656e 736f 7244 6963 744d 6f64 756c 6573  ensorDictModules
-00048c20: 2c20 6275 7420 6120 7b74 7970 6528 6d6f  , but a {type(mo
-00048c30: 6475 6c65 297d 2077 6173 2070 726f 7669  dule)} was provi
-00048c40: 6465 642e 220d 0a20 2020 2020 2020 2020  ded."..         
-00048c50: 2020 2020 2020 2029 0d0a 0d0a 2020 2020         )....    
-00048c60: 2020 2020 696e 5f6b 6579 7320 3d20 7365      in_keys = se
-00048c70: 7428 290d 0a20 2020 2020 2020 2066 6f72  t()..        for
-00048c80: 206d 6f64 756c 6520 696e 206d 6f64 756c   module in modul
-00048c90: 6573 3a0d 0a20 2020 2020 2020 2020 2020  es:..           
-00048ca0: 2069 6e5f 6b65 7973 2e75 7064 6174 6528   in_keys.update(
-00048cb0: 6d6f 6475 6c65 2e69 6e5f 6b65 7973 290d  module.in_keys).
-00048cc0: 0a0d 0a20 2020 2020 2020 2069 6620 6f75  ...        if ou
-00048cd0: 745f 6b65 7973 2069 7320 4e6f 6e65 3a0d  t_keys is None:.
-00048ce0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-00048cf0: 5f6b 6579 7320 3d20 7365 7428 290d 0a20  _keys = set().. 
-00048d00: 2020 2020 2020 2020 2020 2066 6f72 206d             for m
-00048d10: 6f64 756c 6520 696e 206d 6f64 756c 6573  odule in modules
-00048d20: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-00048d30: 2020 2066 6f72 206b 6579 2069 6e20 6d6f     for key in mo
-00048d40: 6475 6c65 2e6f 7574 5f6b 6579 733a 0d0a  dule.out_keys:..
-00048d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048d60: 2020 2020 6966 206b 6579 5b30 5d20 3d3d      if key[0] ==
-00048d70: 2022 6e65 7874 223a 0d0a 2020 2020 2020   "next":..      
-00048d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048d90: 2020 6f75 745f 6b65 7973 2e61 6464 286b    out_keys.add(k
-00048da0: 6579 5b31 5d29 0d0a 2020 2020 2020 2020  ey[1])..        
-00048db0: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
-00048dc0: 2020 206f 7574 5f6b 6579 735f 203d 2073     out_keys_ = s
-00048dd0: 6574 2829 0d0a 2020 2020 2020 2020 2020  et()..          
-00048de0: 2020 666f 7220 6b65 7920 696e 206f 7574    for key in out
-00048df0: 5f6b 6579 733a 0d0a 2020 2020 2020 2020  _keys:..        
-00048e00: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00048e10: 7461 6e63 6528 6b65 792c 2074 7570 6c65  tance(key, tuple
-00048e20: 2920 616e 6420 6b65 795b 305d 203d 3d20  ) and key[0] == 
-00048e30: 226e 6578 7422 3a0d 0a20 2020 2020 2020  "next":..       
-00048e40: 2020 2020 2020 2020 2020 2020 206b 6579               key
-00048e50: 203d 206b 6579 5b31 5d0d 0a20 2020 2020   = key[1]..     
-00048e60: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00048e70: 6172 6e69 6e67 732e 7761 726e 280d 0a20  arnings.warn(.. 
-00048e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048e90: 2020 2020 2020 2066 2254 6865 2027 6e65         f"The 'ne
-00048ea0: 7874 2720 6b65 7920 6973 206e 6f74 206e  xt' key is not n
-00048eb0: 6565 6465 6420 696e 2074 6865 2042 7572  eeded in the Bur
-00048ec0: 6e49 6e54 7261 6e73 666f 726d 2060 6f75  nInTransform `ou
-00048ed0: 745f 6b65 7960 207b 6b65 797d 2061 6e64  t_key` {key} and
-00048ee0: 2022 0d0a 2020 2020 2020 2020 2020 2020   "..            
-00048ef0: 2020 2020 2020 2020 2020 2020 6622 7769              f"wi
-00048f00: 6c6c 2062 6520 6967 6e6f 7265 642e 2054  ll be ignored. T
-00048f10: 6869 7320 7472 616e 7366 6f72 6d20 616c  his transform al
-00048f20: 7265 6164 7920 6173 7375 6d65 7320 7468  ready assumes th
-00048f30: 6174 2060 6f75 745f 6b65 7973 6020 7769  at `out_keys` wi
-00048f40: 6c6c 2062 6520 220d 0a20 2020 2020 2020  ll be "..       
-00048f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048f60: 2066 2272 6574 7269 6576 6564 2066 726f   f"retrieved fro
-00048f70: 6d20 7468 6520 6e65 7874 2074 696d 6520  m the next time 
-00048f80: 7374 6570 206f 6620 7468 6520 6275 726e  step of the burn
-00048f90: 742d 696e 2064 6174 612e 220d 0a20 2020  t-in data."..   
-00048fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048fb0: 2029 0d0a 2020 2020 2020 2020 2020 2020   )..            
-00048fc0: 2020 2020 6f75 745f 6b65 7973 5f2e 6164      out_keys_.ad
-00048fd0: 6428 6b65 7929 0d0a 2020 2020 2020 2020  d(key)..        
-00048fe0: 2020 2020 6f75 745f 6b65 7973 203d 206f      out_keys = o
-00048ff0: 7574 5f6b 6579 735f 0d0a 0d0a 2020 2020  ut_keys_....    
-00049000: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
-00049010: 6974 5f5f 2869 6e5f 6b65 7973 3d69 6e5f  it__(in_keys=in_
-00049020: 6b65 7973 2c20 6f75 745f 6b65 7973 3d6f  keys, out_keys=o
-00049030: 7574 5f6b 6579 7329 0d0a 2020 2020 2020  ut_keys)..      
-00049040: 2020 7365 6c66 2e6d 6f64 756c 6573 203d    self.modules =
-00049050: 206d 6f64 756c 6573 0d0a 2020 2020 2020   modules..      
-00049060: 2020 7365 6c66 2e62 7572 6e5f 696e 203d    self.burn_in =
-00049070: 2062 7572 6e5f 696e 0d0a 0d0a 2020 2020   burn_in....    
-00049080: 6465 6620 5f63 616c 6c28 7365 6c66 2c20  def _call(self, 
-00049090: 7465 6e73 6f72 6469 6374 3a20 5465 6e73  tensordict: Tens
-000490a0: 6f72 4469 6374 4261 7365 2920 2d3e 2054  orDictBase) -> T
-000490b0: 656e 736f 7244 6963 7442 6173 653a 0d0a  ensorDictBase:..
-000490c0: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
-000490d0: 6e74 696d 6545 7272 6f72 2822 4275 726e  ntimeError("Burn
-000490e0: 496e 5472 616e 7366 6f72 6d20 6361 6e20  InTransform can 
-000490f0: 6f6e 6c79 2062 6520 6170 7065 6e64 6564  only be appended
-00049100: 2074 6f20 6120 5265 706c 6179 4275 6666   to a ReplayBuff
-00049110: 6572 2229 0d0a 0d0a 2020 2020 6465 6620  er")....    def 
-00049120: 5f73 7465 7028 0d0a 2020 2020 2020 2020  _step(..        
-00049130: 7365 6c66 2c20 7465 6e73 6f72 6469 6374  self, tensordict
-00049140: 3a20 5465 6e73 6f72 4469 6374 4261 7365  : TensorDictBase
-00049150: 2c20 6e65 7874 5f74 656e 736f 7264 6963  , next_tensordic
-00049160: 743a 2054 656e 736f 7244 6963 7442 6173  t: TensorDictBas
-00049170: 650d 0a20 2020 2029 202d 3e20 5465 6e73  e..    ) -> Tens
-00049180: 6f72 4469 6374 4261 7365 3a0d 0a20 2020  orDictBase:..   
-00049190: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
-000491a0: 6d65 4572 726f 7228 2242 7572 6e49 6e54  meError("BurnInT
-000491b0: 7261 6e73 666f 726d 2063 616e 206f 6e6c  ransform can onl
-000491c0: 7920 6265 2061 7070 656e 6465 6420 746f  y be appended to
-000491d0: 2061 2052 6570 6c61 7942 7566 6665 722e   a ReplayBuffer.
-000491e0: 2229 0d0a 0d0a 2020 2020 6465 6620 666f  ")....    def fo
-000491f0: 7277 6172 6428 7365 6c66 2c20 7465 6e73  rward(self, tens
-00049200: 6f72 6469 6374 3a20 5465 6e73 6f72 4469  ordict: TensorDi
-00049210: 6374 4261 7365 2920 2d3e 2054 656e 736f  ctBase) -> Tenso
-00049220: 7244 6963 7442 6173 653a 0d0a 0d0a 2020  rDictBase:....  
-00049230: 2020 2020 2020 6966 2073 656c 662e 6275        if self.bu
-00049240: 726e 5f69 6e20 3d3d 2030 3a0d 0a20 2020  rn_in == 0:..   
-00049250: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00049260: 7465 6e73 6f72 6469 6374 0d0a 0d0a 2020  tensordict....  
-00049270: 2020 2020 2020 7464 5f64 6576 6963 6520        td_device 
-00049280: 3d20 7465 6e73 6f72 6469 6374 2e64 6576  = tensordict.dev
-00049290: 6963 650d 0a20 2020 2020 2020 2042 2c20  ice..        B, 
-000492a0: 542c 202a 6578 7472 615f 6469 6d73 203d  T, *extra_dims =
-000492b0: 2074 656e 736f 7264 6963 742e 6261 7463   tensordict.batc
-000492c0: 685f 7369 7a65 0d0a 0d0a 2020 2020 2020  h_size....      
-000492d0: 2020 2320 5370 6c69 7420 7468 6520 7465    # Split the te
-000492e0: 6e73 6f72 2064 6963 7420 696e 746f 2062  nsor dict into b
-000492f0: 7572 6e2d 696e 2064 6174 6120 616e 6420  urn-in data and 
-00049300: 7468 6520 7265 7374 2e0d 0a20 2020 2020  the rest...     
-00049310: 2020 2074 645f 6275 726e 5f69 6e20 3d20     td_burn_in = 
-00049320: 7465 6e73 6f72 6469 6374 5b2e 2e2e 2c20  tensordict[..., 
-00049330: 3a20 7365 6c66 2e62 7572 6e5f 696e 5d0d  : self.burn_in].
-00049340: 0a20 2020 2020 2020 2074 645f 6f75 7420  .        td_out 
-00049350: 3d20 7465 6e73 6f72 6469 6374 5b2e 2e2e  = tensordict[...
-00049360: 2c20 7365 6c66 2e62 7572 6e5f 696e 203a  , self.burn_in :
-00049370: 5d0d 0a0d 0a20 2020 2020 2020 2023 2042  ]....        # B
-00049380: 7572 6e20 696e 2074 6865 2072 6563 7572  urn in the recur
-00049390: 7265 6e74 2073 7461 7465 2e0d 0a20 2020  rent state...   
-000493a0: 2020 2020 2077 6974 6820 746f 7263 682e       with torch.
-000493b0: 6e6f 5f67 7261 6428 293a 0d0a 2020 2020  no_grad():..    
-000493c0: 2020 2020 2020 2020 666f 7220 6d6f 6475          for modu
-000493d0: 6c65 2069 6e20 7365 6c66 2e6d 6f64 756c  le in self.modul
-000493e0: 6573 3a0d 0a20 2020 2020 2020 2020 2020  es:..           
-000493f0: 2020 2020 206d 6f64 756c 655f 6465 7669       module_devi
-00049400: 6365 203d 206e 6578 7428 6d6f 6475 6c65  ce = next(module
-00049410: 2e70 6172 616d 6574 6572 7328 2929 2e64  .parameters()).d
-00049420: 6576 6963 6520 6f72 204e 6f6e 650d 0a20  evice or None.. 
-00049430: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00049440: 645f 6275 726e 5f69 6e20 3d20 7464 5f62  d_burn_in = td_b
-00049450: 7572 6e5f 696e 2e74 6f28 6d6f 6475 6c65  urn_in.to(module
-00049460: 5f64 6576 6963 6529 0d0a 2020 2020 2020  _device)..      
-00049470: 2020 2020 2020 2020 2020 7464 5f62 7572            td_bur
-00049480: 6e5f 696e 203d 206d 6f64 756c 6528 7464  n_in = module(td
-00049490: 5f62 7572 6e5f 696e 290d 0a20 2020 2020  _burn_in)..     
-000494a0: 2020 2074 645f 6275 726e 5f69 6e20 3d20     td_burn_in = 
-000494b0: 7464 5f62 7572 6e5f 696e 2e74 6f28 7464  td_burn_in.to(td
-000494c0: 5f64 6576 6963 6529 0d0a 0d0a 2020 2020  _device)....    
-000494d0: 2020 2020 2320 5570 6461 7465 206f 7574      # Update out
-000494e0: 2054 656e 736f 7244 6963 7420 7769 7468   TensorDict with
-000494f0: 2074 6865 2062 7572 6e74 2d69 6e20 6461   the burnt-in da
-00049500: 7461 2e0d 0a20 2020 2020 2020 2066 6f72  ta...        for
-00049510: 206f 7574 5f6b 6579 2069 6e20 7365 6c66   out_key in self
-00049520: 2e6f 7574 5f6b 6579 733a 0d0a 2020 2020  .out_keys:..    
-00049530: 2020 2020 2020 2020 6966 206f 7574 5f6b          if out_k
-00049540: 6579 206e 6f74 2069 6e20 7464 5f6f 7574  ey not in td_out
-00049550: 2e6b 6579 7328 696e 636c 7564 655f 6e65  .keys(include_ne
-00049560: 7374 6564 3d54 7275 6529 3a0d 0a20 2020  sted=True):..   
-00049570: 2020 2020 2020 2020 2020 2020 2074 645f               td_
-00049580: 6f75 742e 7365 7428 0d0a 2020 2020 2020  out.set(..      
-00049590: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
-000495a0: 745f 6b65 792c 0d0a 2020 2020 2020 2020  t_key,..        
-000495b0: 2020 2020 2020 2020 2020 2020 746f 7263              torc
-000495c0: 682e 7a65 726f 7328 0d0a 2020 2020 2020  h.zeros(..      
-000495d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000495e0: 2020 422c 2054 202d 2073 656c 662e 6275    B, T - self.bu
-000495f0: 726e 5f69 6e2c 202a 7465 6e73 6f72 6469  rn_in, *tensordi
-00049600: 6374 2e67 6574 286f 7574 5f6b 6579 292e  ct.get(out_key).
-00049610: 7368 6170 655b 323a 5d0d 0a20 2020 2020  shape[2:]..     
-00049620: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00049630: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
-00049640: 2020 2029 0d0a 2020 2020 2020 2020 2020     )..          
-00049650: 2020 7464 5f6f 7574 5b2e 2e2e 2c20 305d    td_out[..., 0]
-00049660: 5b6f 7574 5f6b 6579 5d2e 636f 7079 5f28  [out_key].copy_(
-00049670: 7464 5f62 7572 6e5f 696e 5b22 6e65 7874  td_burn_in["next
-00049680: 225d 5b2e 2e2e 2c20 2d31 5d5b 6f75 745f  "][..., -1][out_
-00049690: 6b65 795d 290d 0a0d 0a20 2020 2020 2020  key])....       
-000496a0: 2072 6574 7572 6e20 7464 5f6f 7574 0d0a   return td_out..
-000496b0: 0d0a 2020 2020 6465 6620 5f5f 7265 7072  ..    def __repr
-000496c0: 5f5f 2873 656c 6629 202d 3e20 7374 723a  __(self) -> str:
-000496d0: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-000496e0: 2066 227b 7365 6c66 2e5f 5f63 6c61 7373   f"{self.__class
-000496f0: 5f5f 2e5f 5f6e 616d 655f 5f7d 2862 7572  __.__name__}(bur
-00049700: 6e5f 696e 3d7b 7365 6c66 2e62 7572 6e5f  n_in={self.burn_
-00049710: 696e 7d2c 2069 6e5f 6b65 7973 3d7b 7365  in}, in_keys={se
-00049720: 6c66 2e69 6e5f 6b65 7973 7d2c 206f 7574  lf.in_keys}, out
-00049730: 5f6b 6579 733d 7b73 656c 662e 6f75 745f  _keys={self.out_
-00049740: 6b65 7973 7d29 220d 0a0d 0a0d 0a63 6c61  keys})"......cla
-00049750: 7373 2053 6967 6e54 7261 6e73 666f 726d  ss SignTransform
-00049760: 2854 7261 6e73 666f 726d 293a 0d0a 2020  (Transform):..  
-00049770: 2020 2222 2241 2074 7261 6e73 666f 726d    """A transform
-00049780: 2074 6f20 636f 6d70 7574 6520 7468 6520   to compute the 
-00049790: 7369 676e 7320 6f66 2054 656e 736f 7244  signs of TensorD
-000497a0: 6963 7420 7661 6c75 6573 2e0d 0a0d 0a20  ict values..... 
-000497b0: 2020 2054 6869 7320 7472 616e 7366 6f72     This transfor
-000497c0: 6d20 7265 6164 7320 7468 6520 7465 6e73  m reads the tens
-000497d0: 6f72 7320 696e 2060 6069 6e5f 6b65 7973  ors in ``in_keys
-000497e0: 6060 2061 6e64 2060 6069 6e5f 6b65 7973  `` and ``in_keys
-000497f0: 5f69 6e76 6060 2c20 636f 6d70 7574 6573  _inv``, computes
-00049800: 2074 6865 0d0a 2020 2020 7369 676e 7320   the..    signs 
-00049810: 6f66 2074 6865 6972 2065 6c65 6d65 6e74  of their element
-00049820: 7320 616e 6420 7772 6974 6573 2074 6865  s and writes the
-00049830: 2072 6573 756c 7469 6e67 2073 6967 6e20   resulting sign 
-00049840: 7465 6e73 6f72 7320 746f 2060 606f 7574  tensors to ``out
-00049850: 5f6b 6579 7360 6020 616e 640d 0a20 2020  _keys`` and..   
-00049860: 2060 606f 7574 5f6b 6579 735f 696e 7660   ``out_keys_inv`
-00049870: 6020 7265 7370 6563 7469 7665 6c79 2e0d  ` respectively..
-00049880: 0a0d 0a20 2020 2041 7267 733a 0d0a 2020  ...    Args:..  
-00049890: 2020 2020 2020 696e 5f6b 6579 7320 286c        in_keys (l
-000498a0: 6973 7420 6f66 204e 6573 7465 644b 6579  ist of NestedKey
-000498b0: 7329 3a20 696e 7075 7420 656e 7472 6965  s): input entrie
-000498c0: 7320 2872 6561 6429 0d0a 2020 2020 2020  s (read)..      
-000498d0: 2020 6f75 745f 6b65 7973 2028 6c69 7374    out_keys (list
-000498e0: 206f 6620 4e65 7374 6564 4b65 7973 293a   of NestedKeys):
-000498f0: 2069 6e70 7574 2065 6e74 7269 6573 2028   input entries (
-00049900: 7772 6974 6529 0d0a 2020 2020 2020 2020  write)..        
-00049910: 696e 5f6b 6579 735f 696e 7620 286c 6973  in_keys_inv (lis
-00049920: 7420 6f66 204e 6573 7465 644b 6579 7329  t of NestedKeys)
-00049930: 3a20 696e 7075 7420 656e 7472 6965 7320  : input entries 
-00049940: 2872 6561 6429 2064 7572 696e 6720 3a6d  (read) during :m
-00049950: 6574 683a 607e 2e69 6e76 6020 6361 6c6c  eth:`~.inv` call
-00049960: 732e 0d0a 2020 2020 2020 2020 6f75 745f  s...        out_
-00049970: 6b65 7973 5f69 6e76 2028 6c69 7374 206f  keys_inv (list o
-00049980: 6620 4e65 7374 6564 4b65 7973 293a 2069  f NestedKeys): i
-00049990: 6e70 7574 2065 6e74 7269 6573 2028 7772  nput entries (wr
-000499a0: 6974 6529 2064 7572 696e 6720 3a6d 6574  ite) during :met
-000499b0: 683a 607e 2e69 6e76 6020 6361 6c6c 732e  h:`~.inv` calls.
-000499c0: 0d0a 0d0a 2020 2020 4578 616d 706c 6573  ....    Examples
-000499d0: 3a0d 0a20 2020 2020 2020 203e 3e3e 2066  :..        >>> f
-000499e0: 726f 6d20 746f 7263 6872 6c2e 656e 7673  rom torchrl.envs
-000499f0: 2069 6d70 6f72 7420 4779 6d45 6e76 2c20   import GymEnv, 
-00049a00: 5472 616e 7366 6f72 6d65 6445 6e76 2c20  TransformedEnv, 
-00049a10: 5369 676e 5472 616e 7366 6f72 6d0d 0a20  SignTransform.. 
-00049a20: 2020 2020 2020 203e 3e3e 2062 6173 655f         >>> base_
-00049a30: 656e 7620 3d20 4779 6d45 6e76 2822 5065  env = GymEnv("Pe
-00049a40: 6e64 756c 756d 2d76 3122 290d 0a20 2020  ndulum-v1")..   
-00049a50: 2020 2020 203e 3e3e 2065 6e76 203d 2054       >>> env = T
-00049a60: 7261 6e73 666f 726d 6564 456e 7628 6261  ransformedEnv(ba
-00049a70: 7365 5f65 6e76 2c20 5369 676e 5472 616e  se_env, SignTran
-00049a80: 7366 6f72 6d28 696e 5f6b 6579 733d 5b27  sform(in_keys=['
-00049a90: 6f62 7365 7276 6174 696f 6e27 5d29 290d  observation'])).
-00049aa0: 0a20 2020 2020 2020 203e 3e3e 2072 203d  .        >>> r =
-00049ab0: 2065 6e76 2e72 6f6c 6c6f 7574 2831 3030   env.rollout(100
-00049ac0: 290d 0a20 2020 2020 2020 203e 3e3e 206f  )..        >>> o
-00049ad0: 6273 203d 2072 5b22 6f62 7365 7276 6174  bs = r["observat
-00049ae0: 696f 6e22 5d0d 0a20 2020 2020 2020 203e  ion"]..        >
-00049af0: 3e3e 2061 7373 6572 7420 2874 6f72 6368  >> assert (torch
-00049b00: 2e6c 6f67 6963 616c 5f6f 7228 746f 7263  .logical_or(torc
-00049b10: 682e 6c6f 6769 6361 6c5f 6f72 286f 6273  h.logical_or(obs
-00049b20: 203d 3d20 2d31 2c20 6f62 7320 3d3d 2031   == -1, obs == 1
-00049b30: 292c 206f 6273 203d 3d20 302e 3029 292e  ), obs == 0.0)).
-00049b40: 616c 6c28 290d 0a20 2020 2022 2222 0d0a  all()..    """..
-00049b50: 0d0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
-00049b60: 5f5f 280d 0a20 2020 2020 2020 2073 656c  __(..        sel
-00049b70: 662c 0d0a 2020 2020 2020 2020 696e 5f6b  f,..        in_k
-00049b80: 6579 733d 4e6f 6e65 2c0d 0a20 2020 2020  eys=None,..     
-00049b90: 2020 206f 7574 5f6b 6579 733d 4e6f 6e65     out_keys=None
-00049ba0: 2c0d 0a20 2020 2020 2020 2069 6e5f 6b65  ,..        in_ke
-00049bb0: 7973 5f69 6e76 3d4e 6f6e 652c 0d0a 2020  ys_inv=None,..  
-00049bc0: 2020 2020 2020 6f75 745f 6b65 7973 5f69        out_keys_i
-00049bd0: 6e76 3d4e 6f6e 652c 0d0a 2020 2020 293a  nv=None,..    ):
-00049be0: 0d0a 2020 2020 2020 2020 6966 2069 6e5f  ..        if in_
-00049bf0: 6b65 7973 2069 7320 4e6f 6e65 3a0d 0a20  keys is None:.. 
-00049c00: 2020 2020 2020 2020 2020 2069 6e5f 6b65             in_ke
-00049c10: 7973 203d 205b 5d0d 0a20 2020 2020 2020  ys = []..       
-00049c20: 2069 6620 6f75 745f 6b65 7973 2069 7320   if out_keys is 
-00049c30: 4e6f 6e65 3a0d 0a20 2020 2020 2020 2020  None:..         
-00049c40: 2020 206f 7574 5f6b 6579 7320 3d20 636f     out_keys = co
-00049c50: 7079 2869 6e5f 6b65 7973 290d 0a20 2020  py(in_keys)..   
-00049c60: 2020 2020 2069 6620 696e 5f6b 6579 735f       if in_keys_
-00049c70: 696e 7620 6973 204e 6f6e 653a 0d0a 2020  inv is None:..  
-00049c80: 2020 2020 2020 2020 2020 696e 5f6b 6579            in_key
-00049c90: 735f 696e 7620 3d20 5b5d 0d0a 2020 2020  s_inv = []..    
-00049ca0: 2020 2020 6966 206f 7574 5f6b 6579 735f      if out_keys_
-00049cb0: 696e 7620 6973 204e 6f6e 653a 0d0a 2020  inv is None:..  
-00049cc0: 2020 2020 2020 2020 2020 6f75 745f 6b65            out_ke
-00049cd0: 7973 5f69 6e76 203d 2063 6f70 7928 696e  ys_inv = copy(in
-00049ce0: 5f6b 6579 735f 696e 7629 0d0a 2020 2020  _keys_inv)..    
-00049cf0: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
-00049d00: 6974 5f5f 2869 6e5f 6b65 7973 2c20 6f75  it__(in_keys, ou
-00049d10: 745f 6b65 7973 2c20 696e 5f6b 6579 735f  t_keys, in_keys_
-00049d20: 696e 762c 206f 7574 5f6b 6579 735f 696e  inv, out_keys_in
-00049d30: 7629 0d0a 0d0a 2020 2020 6465 6620 5f61  v)....    def _a
-00049d40: 7070 6c79 5f74 7261 6e73 666f 726d 2873  pply_transform(s
-00049d50: 656c 662c 206f 6273 3a20 746f 7263 682e  elf, obs: torch.
-00049d60: 5465 6e73 6f72 2920 2d3e 2074 6f72 6368  Tensor) -> torch
-00049d70: 2e54 656e 736f 723a 0d0a 2020 2020 2020  .Tensor:..      
-00049d80: 2020 7265 7475 726e 206f 6273 2e73 6967    return obs.sig
-00049d90: 6e28 290d 0a0d 0a20 2020 2064 6566 205f  n()....    def _
-00049da0: 696e 765f 6170 706c 795f 7472 616e 7366  inv_apply_transf
-00049db0: 6f72 6d28 7365 6c66 2c20 7374 6174 653a  orm(self, state:
-00049dc0: 2074 6f72 6368 2e54 656e 736f 7229 202d   torch.Tensor) -
-00049dd0: 3e20 746f 7263 682e 5465 6e73 6f72 3a0d  > torch.Tensor:.
-00049de0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00049df0: 7374 6174 652e 7369 676e 2829 0d0a 0d0a  state.sign()....
-00049e00: 2020 2020 405f 6170 706c 795f 746f 5f63      @_apply_to_c
-00049e10: 6f6d 706f 7369 7465 0d0a 2020 2020 6465  omposite..    de
-00049e20: 6620 7472 616e 7366 6f72 6d5f 6f62 7365  f transform_obse
-00049e30: 7276 6174 696f 6e5f 7370 6563 2873 656c  rvation_spec(sel
-00049e40: 662c 206f 6273 6572 7661 7469 6f6e 5f73  f, observation_s
-00049e50: 7065 633a 2054 656e 736f 7253 7065 6329  pec: TensorSpec)
-00049e60: 202d 3e20 5465 6e73 6f72 5370 6563 3a0d   -> TensorSpec:.
-00049e70: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00049e80: 426f 756e 6465 6454 656e 736f 7253 7065  BoundedTensorSpe
-00049e90: 6328 0d0a 2020 2020 2020 2020 2020 2020  c(..            
-00049ea0: 7368 6170 653d 6f62 7365 7276 6174 696f  shape=observatio
-00049eb0: 6e5f 7370 6563 2e73 6861 7065 2c0d 0a20  n_spec.shape,.. 
-00049ec0: 2020 2020 2020 2020 2020 2064 6576 6963             devic
-00049ed0: 653d 6f62 7365 7276 6174 696f 6e5f 7370  e=observation_sp
-00049ee0: 6563 2e64 6576 6963 652c 0d0a 2020 2020  ec.device,..    
-00049ef0: 2020 2020 2020 2020 6474 7970 653d 6f62          dtype=ob
-00049f00: 7365 7276 6174 696f 6e5f 7370 6563 2e64  servation_spec.d
-00049f10: 7479 7065 2c0d 0a20 2020 2020 2020 2020  type,..         
-00049f20: 2020 2068 6967 683d 312e 302c 0d0a 2020     high=1.0,..  
-00049f30: 2020 2020 2020 2020 2020 6c6f 773d 2d31            low=-1
-00049f40: 2e30 2c0d 0a20 2020 2020 2020 2029 0d0a  .0,..        )..
-00049f50: 0d0a 2020 2020 6465 6620 7472 616e 7366  ..    def transf
-00049f60: 6f72 6d5f 7265 7761 7264 5f73 7065 6328  orm_reward_spec(
-00049f70: 7365 6c66 2c20 7265 7761 7264 5f73 7065  self, reward_spe
-00049f80: 633a 2054 656e 736f 7253 7065 6329 202d  c: TensorSpec) -
-00049f90: 3e20 5465 6e73 6f72 5370 6563 3a0d 0a20  > TensorSpec:.. 
-00049fa0: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
-00049fb0: 6e20 7365 6c66 2e69 6e5f 6b65 7973 3a0d  n self.in_keys:.
-00049fc0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00049fd0: 6b65 7920 696e 2073 656c 662e 7061 7265  key in self.pare
-00049fe0: 6e74 2e72 6577 6172 645f 6b65 7973 3a0d  nt.reward_keys:.
-00049ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004a000: 2073 7065 6320 3d20 7365 6c66 2e70 6172   spec = self.par
-0004a010: 656e 742e 6f75 7470 7574 5f73 7065 635b  ent.output_spec[
-0004a020: 2266 756c 6c5f 7265 7761 7264 5f73 7065  "full_reward_spe
-0004a030: 6322 5d5b 6b65 795d 0d0a 2020 2020 2020  c"][key]..      
-0004a040: 2020 2020 2020 2020 2020 7365 6c66 2e70            self.p
-0004a050: 6172 656e 742e 6f75 7470 7574 5f73 7065  arent.output_spe
-0004a060: 635b 2266 756c 6c5f 7265 7761 7264 5f73  c["full_reward_s
-0004a070: 7065 6322 5d5b 6b65 795d 203d 2042 6f75  pec"][key] = Bou
-0004a080: 6e64 6564 5465 6e73 6f72 5370 6563 280d  ndedTensorSpec(.
-0004a090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004a0a0: 2020 2020 2073 6861 7065 3d73 7065 632e       shape=spec.
-0004a0b0: 7368 6170 652c 0d0a 2020 2020 2020 2020  shape,..        
-0004a0c0: 2020 2020 2020 2020 2020 2020 6465 7669              devi
-0004a0d0: 6365 3d73 7065 632e 6465 7669 6365 2c0d  ce=spec.device,.
-0004a0e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004a0f0: 2020 2020 2064 7479 7065 3d73 7065 632e       dtype=spec.
-0004a100: 6474 7970 652c 0d0a 2020 2020 2020 2020  dtype,..        
-0004a110: 2020 2020 2020 2020 2020 2020 6869 6768              high
-0004a120: 3d31 2e30 2c0d 0a20 2020 2020 2020 2020  =1.0,..         
-0004a130: 2020 2020 2020 2020 2020 206c 6f77 3d2d             low=-
-0004a140: 312e 302c 0d0a 2020 2020 2020 2020 2020  1.0,..          
-0004a150: 2020 2020 2020 290d 0a20 2020 2020 2020        )..       
-0004a160: 2072 6574 7572 6e20 7365 6c66 2e70 6172   return self.par
-0004a170: 656e 742e 6f75 7470 7574 5f73 7065 635b  ent.output_spec[
-0004a180: 2266 756c 6c5f 7265 7761 7264 5f73 7065  "full_reward_spe
-0004a190: 6322 5d0d 0a0d 0a20 2020 2064 6566 205f  c"]....    def _
-0004a1a0: 7265 7365 7428 0d0a 2020 2020 2020 2020  reset(..        
-0004a1b0: 7365 6c66 2c20 7465 6e73 6f72 6469 6374  self, tensordict
-0004a1c0: 3a20 5465 6e73 6f72 4469 6374 4261 7365  : TensorDictBase
-0004a1d0: 2c20 7465 6e73 6f72 6469 6374 5f72 6573  , tensordict_res
-0004a1e0: 6574 3a20 5465 6e73 6f72 4469 6374 4261  et: TensorDictBa
-0004a1f0: 7365 0d0a 2020 2020 2920 2d3e 2054 656e  se..    ) -> Ten
-0004a200: 736f 7244 6963 7442 6173 653a 0d0a 2020  sorDictBase:..  
-0004a210: 2020 2020 2020 7769 7468 205f 7365 745f        with _set_
-0004a220: 6d69 7373 696e 675f 746f 6c65 7261 6e63  missing_toleranc
-0004a230: 6528 7365 6c66 2c20 5472 7565 293a 0d0a  e(self, True):..
-0004a240: 2020 2020 2020 2020 2020 2020 7465 6e73              tens
-0004a250: 6f72 6469 6374 5f72 6573 6574 203d 2073  ordict_reset = s
-0004a260: 656c 662e 5f63 616c 6c28 7465 6e73 6f72  elf._call(tensor
-0004a270: 6469 6374 5f72 6573 6574 290d 0a20 2020  dict_reset)..   
-0004a280: 2020 2020 2072 6574 7572 6e20 7465 6e73       return tens
-0004a290: 6f72 6469 6374 5f72 6573 6574 0d0a 0d0a  ordict_reset....
-0004a2a0: 0d0a 636c 6173 7320 5265 6d6f 7665 456d  ..class RemoveEm
-0004a2b0: 7074 7953 7065 6373 2854 7261 6e73 666f  ptySpecs(Transfo
-0004a2c0: 726d 293a 0d0a 2020 2020 2222 2252 656d  rm):..    """Rem
-0004a2d0: 6f76 6573 2065 6d70 7479 2073 7065 6373  oves empty specs
-0004a2e0: 2061 6e64 2063 6f6e 7465 6e74 2066 726f   and content fro
-0004a2f0: 6d20 616e 2065 6e76 6972 6f6e 6d65 6e74  m an environment
-0004a300: 2e0d 0a0d 0a20 2020 2045 7861 6d70 6c65  .....    Example
-0004a310: 733a 0d0a 2020 2020 2020 2020 3e3e 3e20  s:..        >>> 
-0004a320: 696d 706f 7274 2074 6f72 6368 0d0a 2020  import torch..  
-0004a330: 2020 2020 2020 3e3e 3e20 6672 6f6d 2074        >>> from t
-0004a340: 656e 736f 7264 6963 7420 696d 706f 7274  ensordict import
-0004a350: 2054 656e 736f 7244 6963 740d 0a20 2020   TensorDict..   
-0004a360: 2020 2020 203e 3e3e 2066 726f 6d20 746f       >>> from to
-0004a370: 7263 6872 6c2e 6461 7461 2069 6d70 6f72  rchrl.data impor
-0004a380: 7420 556e 626f 756e 6465 6443 6f6e 7469  t UnboundedConti
-0004a390: 6e75 6f75 7354 656e 736f 7253 7065 632c  nuousTensorSpec,
-0004a3a0: 2043 6f6d 706f 7369 7465 5370 6563 2c20   CompositeSpec, 
-0004a3b0: 5c0d 0a20 2020 2020 2020 202e 2e2e 2020  \..        ...  
-0004a3c0: 2020 2044 6973 6372 6574 6554 656e 736f     DiscreteTenso
-0004a3d0: 7253 7065 630d 0a20 2020 2020 2020 203e  rSpec..        >
-0004a3e0: 3e3e 2066 726f 6d20 746f 7263 6872 6c2e  >> from torchrl.
-0004a3f0: 656e 7673 2069 6d70 6f72 7420 456e 7642  envs import EnvB
-0004a400: 6173 652c 2054 7261 6e73 666f 726d 6564  ase, Transformed
-0004a410: 456e 762c 2052 656d 6f76 6545 6d70 7479  Env, RemoveEmpty
-0004a420: 5370 6563 730d 0a20 2020 2020 2020 203e  Specs..        >
-0004a430: 3e3e 0d0a 2020 2020 2020 2020 3e3e 3e0d  >>..        >>>.
-0004a440: 0a20 2020 2020 2020 203e 3e3e 2063 6c61  .        >>> cla
-0004a450: 7373 2044 756d 6d79 456e 7628 456e 7642  ss DummyEnv(EnvB
-0004a460: 6173 6529 3a0d 0a20 2020 2020 2020 202e  ase):..        .
-0004a470: 2e2e 2020 2020 2064 6566 205f 5f69 6e69  ..     def __ini
-0004a480: 745f 5f28 7365 6c66 2c20 2a61 7267 732c  t__(self, *args,
-0004a490: 202a 2a6b 7761 7267 7329 3a0d 0a20 2020   **kwargs):..   
-0004a4a0: 2020 2020 202e 2e2e 2020 2020 2020 2020       ...        
-0004a4b0: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
-0004a4c0: 5f28 2a61 7267 732c 202a 2a6b 7761 7267  _(*args, **kwarg
-0004a4d0: 7329 0d0a 2020 2020 2020 2020 2e2e 2e20  s)..        ... 
-0004a4e0: 2020 2020 2020 2020 7365 6c66 2e6f 6273          self.obs
-0004a4f0: 6572 7661 7469 6f6e 5f73 7065 6320 3d20  ervation_spec = 
-0004a500: 436f 6d70 6f73 6974 6553 7065 6328 0d0a  CompositeSpec(..
-0004a510: 2020 2020 2020 2020 2e2e 2e20 2020 2020          ...     
-0004a520: 2020 2020 2020 2020 6f62 7365 7276 6174          observat
-0004a530: 696f 6e3d 556e 626f 756e 6465 6443 6f6e  ion=UnboundedCon
-0004a540: 7469 6e75 6f75 7354 656e 736f 7253 7065  tinuousTensorSpe
-0004a550: 6328 282a 7365 6c66 2e62 6174 6368 5f73  c((*self.batch_s
-0004a560: 697a 652c 2033 2929 2c0d 0a20 2020 2020  ize, 3)),..     
-0004a570: 2020 202e 2e2e 2020 2020 2020 2020 2020     ...          
-0004a580: 2020 206f 7468 6572 3d43 6f6d 706f 7369     other=Composi
-0004a590: 7465 5370 6563 280d 0a20 2020 2020 2020  teSpec(..       
-0004a5a0: 202e 2e2e 2020 2020 2020 2020 2020 2020   ...            
-0004a5b0: 2020 2020 2061 6e6f 7468 6572 5f6f 7468       another_oth
-0004a5c0: 6572 3d43 6f6d 706f 7369 7465 5370 6563  er=CompositeSpec
-0004a5d0: 2873 6861 7065 3d73 656c 662e 6261 7463  (shape=self.batc
-0004a5e0: 685f 7369 7a65 292c 0d0a 2020 2020 2020  h_size),..      
-0004a5f0: 2020 2e2e 2e20 2020 2020 2020 2020 2020    ...           
-0004a600: 2020 2020 2020 7368 6170 653d 7365 6c66        shape=self
-0004a610: 2e62 6174 6368 5f73 697a 652c 0d0a 2020  .batch_size,..  
-0004a620: 2020 2020 2020 2e2e 2e20 2020 2020 2020        ...       
-0004a630: 2020 2020 2020 292c 0d0a 2020 2020 2020        ),..      
-0004a640: 2020 2e2e 2e20 2020 2020 2020 2020 2020    ...           
-0004a650: 2020 7368 6170 653d 7365 6c66 2e62 6174    shape=self.bat
-0004a660: 6368 5f73 697a 652c 0d0a 2020 2020 2020  ch_size,..      
-0004a670: 2020 2e2e 2e20 2020 2020 2020 2020 290d    ...         ).
-0004a680: 0a20 2020 2020 2020 202e 2e2e 2020 2020  .        ...    
-0004a690: 2020 2020 2073 656c 662e 6163 7469 6f6e       self.action
-0004a6a0: 5f73 7065 6320 3d20 556e 626f 756e 6465  _spec = Unbounde
-0004a6b0: 6443 6f6e 7469 6e75 6f75 7354 656e 736f  dContinuousTenso
-0004a6c0: 7253 7065 6328 282a 7365 6c66 2e62 6174  rSpec((*self.bat
-0004a6d0: 6368 5f73 697a 652c 2033 2929 0d0a 2020  ch_size, 3))..  
-0004a6e0: 2020 2020 2020 2e2e 2e20 2020 2020 2020        ...       
-0004a6f0: 2020 7365 6c66 2e64 6f6e 655f 7370 6563    self.done_spec
-0004a700: 203d 2044 6973 6372 6574 6554 656e 736f   = DiscreteTenso
-0004a710: 7253 7065 6328 0d0a 2020 2020 2020 2020  rSpec(..        
-0004a720: 2e2e 2e20 2020 2020 2020 2020 2020 2020  ...             
-0004a730: 322c 2028 2a73 656c 662e 6261 7463 685f  2, (*self.batch_
-0004a740: 7369 7a65 2c20 3129 2c20 6474 7970 653d  size, 1), dtype=
-0004a750: 746f 7263 682e 626f 6f6c 0d0a 2020 2020  torch.bool..    
-0004a760: 2020 2020 2e2e 2e20 2020 2020 2020 2020      ...         
+00040b90: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+00040ba0: 2020 2069 6620 696e 6974 5f76 616c 2e6e     if init_val.n
+00040bb0: 6469 6d20 3d3d 2070 6172 656e 745f 7464  dim == parent_td
+00040bc0: 2e6e 6469 6d3a 0d0a 2020 2020 2020 2020  .ndim:..        
+00040bd0: 2020 2020 2020 2020 2020 2020 2320 756e              # un
+00040be0: 7371 7565 657a 652c 2074 6f20 6d61 7463  squeeze, to matc
+00040bf0: 6820 7468 6520 646f 6e65 2073 6861 7065  h the done shape
+00040c00: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00040c10: 2020 2020 2020 696e 6974 5f76 616c 203d        init_val =
+00040c20: 2069 6e69 745f 7661 6c2e 756e 7371 7565   init_val.unsque
+00040c30: 657a 6528 2d31 290d 0a20 2020 2020 2020  eze(-1)..       
+00040c40: 2020 2020 2020 2020 2074 656e 736f 7264           tensord
+00040c50: 6963 745f 7265 7365 742e 7365 7428 696e  ict_reset.set(in
+00040c60: 6974 5f6b 6579 2c20 696e 6974 5f76 616c  it_key, init_val
+00040c70: 290d 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00040c80: 6e20 7465 6e73 6f72 6469 6374 5f72 6573  n tensordict_res
+00040c90: 6574 0d0a 0d0a 2020 2020 6465 6620 7472  et....    def tr
+00040ca0: 616e 7366 6f72 6d5f 6f62 7365 7276 6174  ansform_observat
+00040cb0: 696f 6e5f 7370 6563 2873 656c 662c 206f  ion_spec(self, o
+00040cc0: 6273 6572 7661 7469 6f6e 5f73 7065 633a  bservation_spec:
+00040cd0: 2054 656e 736f 7253 7065 6329 202d 3e20   TensorSpec) -> 
+00040ce0: 5465 6e73 6f72 5370 6563 3a0d 0a20 2020  TensorSpec:..   
+00040cf0: 2020 2020 2066 756c 6c5f 646f 6e65 5f73       full_done_s
+00040d00: 7065 6320 3d20 7365 6c66 2e70 6172 656e  pec = self.paren
+00040d10: 742e 6f75 7470 7574 5f73 7065 635b 2266  t.output_spec["f
+00040d20: 756c 6c5f 646f 6e65 5f73 7065 6322 5d0d  ull_done_spec"].
+00040d30: 0a20 2020 2020 2020 2066 6f72 2069 6e69  .        for ini
+00040d40: 745f 6b65 7920 696e 2073 656c 662e 696e  t_key in self.in
+00040d50: 6974 5f6b 6579 733a 0d0a 2020 2020 2020  it_keys:..      
+00040d60: 2020 2020 2020 666f 7220 646f 6e65 5f6b        for done_k
+00040d70: 6579 2069 6e20 7365 6c66 2e70 6172 656e  ey in self.paren
+00040d80: 742e 646f 6e65 5f6b 6579 733a 0d0a 2020  t.done_keys:..  
+00040d90: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00040da0: 6368 6563 6b20 726f 6f74 0d0a 2020 2020  check root..    
+00040db0: 2020 2020 2020 2020 2020 2020 6966 2074              if t
+00040dc0: 7970 6528 646f 6e65 5f6b 6579 2920 213d  ype(done_key) !=
+00040dd0: 2074 7970 6528 696e 6974 5f6b 6579 293a   type(init_key):
+00040de0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00040df0: 2020 2020 2020 636f 6e74 696e 7565 0d0a        continue..
+00040e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040e10: 6966 2069 7369 6e73 7461 6e63 6528 646f  if isinstance(do
+00040e20: 6e65 5f6b 6579 2c20 7475 706c 6529 3a0d  ne_key, tuple):.
+00040e30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00040e40: 2020 2020 2069 6620 646f 6e65 5f6b 6579       if done_key
+00040e50: 5b3a 2d31 5d20 3d3d 2069 6e69 745f 6b65  [:-1] == init_ke
+00040e60: 795b 3a2d 315d 3a0d 0a20 2020 2020 2020  y[:-1]:..       
+00040e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040e80: 2073 6861 7065 203d 2066 756c 6c5f 646f   shape = full_do
+00040e90: 6e65 5f73 7065 635b 646f 6e65 5f6b 6579  ne_spec[done_key
+00040ea0: 5d2e 7368 6170 650d 0a20 2020 2020 2020  ].shape..       
+00040eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040ec0: 2062 7265 616b 0d0a 2020 2020 2020 2020   break..        
+00040ed0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00040ee0: 7461 6e63 6528 646f 6e65 5f6b 6579 2c20  tance(done_key, 
+00040ef0: 7374 7229 3a0d 0a20 2020 2020 2020 2020  str):..         
+00040f00: 2020 2020 2020 2020 2020 2073 6861 7065             shape
+00040f10: 203d 2066 756c 6c5f 646f 6e65 5f73 7065   = full_done_spe
+00040f20: 635b 646f 6e65 5f6b 6579 5d2e 7368 6170  c[done_key].shap
+00040f30: 650d 0a20 2020 2020 2020 2020 2020 2020  e..             
+00040f40: 2020 2020 2020 2062 7265 616b 0d0a 2020         break..  
+00040f50: 2020 2020 2020 2020 2020 656c 7365 3a0d            else:.
+00040f60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00040f70: 2072 6169 7365 204b 6579 4572 726f 7228   raise KeyError(
+00040f80: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00040f90: 2020 2020 2020 6622 436f 756c 6420 6e6f        f"Could no
+00040fa0: 7420 6669 6e64 2072 6f6f 7420 6f66 2069  t find root of i
+00040fb0: 6e69 745f 6b65 7920 7b69 6e69 745f 6b65  nit_key {init_ke
+00040fc0: 797d 2077 6974 6869 6e20 646f 6e65 5f6b  y} within done_k
+00040fd0: 6579 7320 7b73 656c 662e 7061 7265 6e74  eys {self.parent
+00040fe0: 2e64 6f6e 655f 6b65 7973 7d2e 220d 0a20  .done_keys}.".. 
+00040ff0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00041000: 0d0a 2020 2020 2020 2020 2020 2020 6f62  ..            ob
+00041010: 7365 7276 6174 696f 6e5f 7370 6563 5b69  servation_spec[i
+00041020: 6e69 745f 6b65 795d 203d 2044 6973 6372  nit_key] = Discr
+00041030: 6574 6554 656e 736f 7253 7065 6328 0d0a  eteTensorSpec(..
+00041040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041050: 322c 0d0a 2020 2020 2020 2020 2020 2020  2,..            
+00041060: 2020 2020 6474 7970 653d 746f 7263 682e      dtype=torch.
+00041070: 626f 6f6c 2c0d 0a20 2020 2020 2020 2020  bool,..         
+00041080: 2020 2020 2020 2064 6576 6963 653d 7365         device=se
+00041090: 6c66 2e70 6172 656e 742e 6465 7669 6365  lf.parent.device
+000410a0: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+000410b0: 2020 2073 6861 7065 3d73 6861 7065 2c0d     shape=shape,.
+000410c0: 0a20 2020 2020 2020 2020 2020 2029 0d0a  .            )..
+000410d0: 2020 2020 2020 2020 7265 7475 726e 206f          return o
+000410e0: 6273 6572 7661 7469 6f6e 5f73 7065 630d  bservation_spec.
+000410f0: 0a0d 0a20 2020 2064 6566 2066 6f72 7761  ...    def forwa
+00041100: 7264 2873 656c 662c 2074 656e 736f 7264  rd(self, tensord
+00041110: 6963 743a 2054 656e 736f 7244 6963 7442  ict: TensorDictB
+00041120: 6173 6529 202d 3e20 5465 6e73 6f72 4469  ase) -> TensorDi
+00041130: 6374 4261 7365 3a0d 0a20 2020 2020 2020  ctBase:..       
+00041140: 2072 6169 7365 204e 6f74 496d 706c 656d   raise NotImplem
+00041150: 656e 7465 6445 7272 6f72 280d 0a20 2020  entedError(..   
+00041160: 2020 2020 2020 2020 2046 4f52 5741 5244           FORWARD
+00041170: 5f4e 4f54 5f49 4d50 4c45 4d45 4e54 4544  _NOT_IMPLEMENTED
+00041180: 2e66 6f72 6d61 7428 7365 6c66 2e5f 5f63  .format(self.__c
+00041190: 6c61 7373 5f5f 2e5f 5f6e 616d 655f 5f29  lass__.__name__)
+000411a0: 0d0a 2020 2020 2020 2020 290d 0a0d 0a0d  ..        ).....
+000411b0: 0a63 6c61 7373 2052 656e 616d 6554 7261  .class RenameTra
+000411c0: 6e73 666f 726d 2854 7261 6e73 666f 726d  nsform(Transform
+000411d0: 293a 0d0a 2020 2020 2222 2241 2074 7261  ):..    """A tra
+000411e0: 6e73 666f 726d 2074 6f20 7265 6e61 6d65  nsform to rename
+000411f0: 2065 6e74 7269 6573 2069 6e20 7468 6520   entries in the 
+00041200: 6f75 7470 7574 2074 656e 736f 7264 6963  output tensordic
+00041210: 742e 0d0a 0d0a 2020 2020 4172 6773 3a0d  t.....    Args:.
+00041220: 0a20 2020 2020 2020 2069 6e5f 6b65 7973  .        in_keys
+00041230: 2028 7365 7175 656e 6365 206f 6620 4e65   (sequence of Ne
+00041240: 7374 6564 4b65 7929 3a20 7468 6520 656e  stedKey): the en
+00041250: 7472 6965 7320 746f 2072 656e 616d 650d  tries to rename.
+00041260: 0a20 2020 2020 2020 206f 7574 5f6b 6579  .        out_key
+00041270: 7320 2873 6571 7565 6e63 6520 6f66 204e  s (sequence of N
+00041280: 6573 7465 644b 6579 293a 2074 6865 206e  estedKey): the n
+00041290: 616d 6520 6f66 2074 6865 2065 6e74 7269  ame of the entri
+000412a0: 6573 2061 6674 6572 2072 656e 616d 696e  es after renamin
+000412b0: 672e 0d0a 2020 2020 2020 2020 696e 5f6b  g...        in_k
+000412c0: 6579 735f 696e 7620 2873 6571 7565 6e63  eys_inv (sequenc
+000412d0: 6520 6f66 204e 6573 7465 644b 6579 2c20  e of NestedKey, 
+000412e0: 6f70 7469 6f6e 616c 293a 2074 6865 2065  optional): the e
+000412f0: 6e74 7269 6573 2074 6f20 7265 6e61 6d65  ntries to rename
+00041300: 2062 6566 6f72 650d 0a20 2020 2020 2020   before..       
+00041310: 2020 2020 2070 6173 7369 6e67 2074 6865       passing the
+00041320: 2069 6e70 7574 2074 656e 736f 7264 6963   input tensordic
+00041330: 7420 746f 203a 6d65 7468 3a60 456e 7642  t to :meth:`EnvB
+00041340: 6173 652e 5f73 7465 7060 2e0d 0a20 2020  ase._step`...   
+00041350: 2020 2020 206f 7574 5f6b 6579 735f 696e       out_keys_in
+00041360: 7620 2873 6571 7565 6e63 6520 6f66 204e  v (sequence of N
+00041370: 6573 7465 644b 6579 2c20 6f70 7469 6f6e  estedKey, option
+00041380: 616c 293a 2074 6865 206e 616d 6573 206f  al): the names o
+00041390: 6620 7468 6520 7265 6e61 6d65 640d 0a20  f the renamed.. 
+000413a0: 2020 2020 2020 2020 2020 2065 6e74 7269             entri
+000413b0: 6573 2070 6173 7365 6420 746f 203a 6d65  es passed to :me
+000413c0: 7468 3a60 456e 7642 6173 652e 5f73 7465  th:`EnvBase._ste
+000413d0: 7060 2e0d 0a20 2020 2020 2020 2063 7265  p`...        cre
+000413e0: 6174 655f 636f 7079 2028 626f 6f6c 2c20  ate_copy (bool, 
+000413f0: 6f70 7469 6f6e 616c 293a 2069 6620 6060  optional): if ``
+00041400: 5472 7565 6060 2c20 7468 6520 656e 7472  True``, the entr
+00041410: 6965 7320 7769 6c6c 2062 6520 636f 7069  ies will be copi
+00041420: 6564 0d0a 2020 2020 2020 2020 2020 2020  ed..            
+00041430: 7769 7468 2061 2064 6966 6665 7265 6e74  with a different
+00041440: 206e 616d 6520 7261 7468 6572 2074 6861   name rather tha
+00041450: 6e20 6265 696e 6720 7265 6e61 6d65 642e  n being renamed.
+00041460: 2054 6869 7320 616c 6c6f 7773 2066 6f72   This allows for
+00041470: 0d0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+00041480: 6e61 6d69 6e67 2069 6d6d 7574 6162 6c65  naming immutable
+00041490: 2065 6e74 7269 6573 2073 7563 6820 6173   entries such as
+000414a0: 2060 6022 7265 7761 7264 2260 6020 616e   ``"reward"`` an
+000414b0: 6420 6060 2264 6f6e 6522 6060 2e0d 0a0d  d ``"done"``....
+000414c0: 0a20 2020 2045 7861 6d70 6c65 733a 0d0a  .    Examples:..
+000414d0: 2020 2020 2020 2020 3e3e 3e20 6672 6f6d          >>> from
+000414e0: 2074 6f72 6368 726c 2e65 6e76 732e 6c69   torchrl.envs.li
+000414f0: 6273 2e67 796d 2069 6d70 6f72 7420 4779  bs.gym import Gy
+00041500: 6d45 6e76 0d0a 2020 2020 2020 2020 3e3e  mEnv..        >>
+00041510: 3e20 656e 7620 3d20 5472 616e 7366 6f72  > env = Transfor
+00041520: 6d65 6445 6e76 280d 0a20 2020 2020 2020  medEnv(..       
+00041530: 202e 2e2e 2020 2020 2047 796d 456e 7628   ...     GymEnv(
+00041540: 2250 656e 6475 6c75 6d2d 7631 2229 2c0d  "Pendulum-v1"),.
+00041550: 0a20 2020 2020 2020 202e 2e2e 2020 2020  .        ...    
+00041560: 2052 656e 616d 6554 7261 6e73 666f 726d   RenameTransform
+00041570: 285b 226f 6273 6572 7661 7469 6f6e 222c  (["observation",
+00041580: 205d 2c20 5b22 7374 7566 6622 2c5d 2c20   ], ["stuff",], 
+00041590: 6372 6561 7465 5f63 6f70 793d 4661 6c73  create_copy=Fals
+000415a0: 6529 2c0d 0a20 2020 2020 2020 202e 2e2e  e),..        ...
+000415b0: 2029 0d0a 2020 2020 2020 2020 3e3e 3e20   )..        >>> 
+000415c0: 7465 6e73 6f72 6469 6374 203d 2065 6e76  tensordict = env
+000415d0: 2e72 6f6c 6c6f 7574 2833 290d 0a20 2020  .rollout(3)..   
+000415e0: 2020 2020 203e 3e3e 2070 7269 6e74 2874       >>> print(t
+000415f0: 656e 736f 7264 6963 7429 0d0a 2020 2020  ensordict)..    
+00041600: 2020 2020 5465 6e73 6f72 4469 6374 280d      TensorDict(.
+00041610: 0a20 2020 2020 2020 2020 2020 2066 6965  .            fie
+00041620: 6c64 733d 7b0d 0a20 2020 2020 2020 2020  lds={..         
+00041630: 2020 2020 2020 2061 6374 696f 6e3a 2054         action: T
+00041640: 656e 736f 7228 7368 6170 653d 746f 7263  ensor(shape=torc
+00041650: 682e 5369 7a65 285b 332c 2031 5d29 2c20  h.Size([3, 1]), 
+00041660: 6465 7669 6365 3d63 7075 2c20 6474 7970  device=cpu, dtyp
+00041670: 653d 746f 7263 682e 666c 6f61 7433 322c  e=torch.float32,
+00041680: 2069 735f 7368 6172 6564 3d46 616c 7365   is_shared=False
+00041690: 292c 0d0a 2020 2020 2020 2020 2020 2020  ),..            
+000416a0: 2020 2020 646f 6e65 3a20 5465 6e73 6f72      done: Tensor
+000416b0: 2873 6861 7065 3d74 6f72 6368 2e53 697a  (shape=torch.Siz
+000416c0: 6528 5b33 2c20 315d 292c 2064 6576 6963  e([3, 1]), devic
+000416d0: 653d 6370 752c 2064 7479 7065 3d74 6f72  e=cpu, dtype=tor
+000416e0: 6368 2e62 6f6f 6c2c 2069 735f 7368 6172  ch.bool, is_shar
+000416f0: 6564 3d46 616c 7365 292c 0d0a 2020 2020  ed=False),..    
+00041700: 2020 2020 2020 2020 2020 2020 6e65 7874              next
+00041710: 3a20 5465 6e73 6f72 4469 6374 280d 0a20  : TensorDict(.. 
+00041720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041730: 2020 2066 6965 6c64 733d 7b0d 0a20 2020     fields={..   
+00041740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041750: 2020 2020 2064 6f6e 653a 2054 656e 736f       done: Tenso
+00041760: 7228 7368 6170 653d 746f 7263 682e 5369  r(shape=torch.Si
+00041770: 7a65 285b 332c 2031 5d29 2c20 6465 7669  ze([3, 1]), devi
+00041780: 6365 3d63 7075 2c20 6474 7970 653d 746f  ce=cpu, dtype=to
+00041790: 7263 682e 626f 6f6c 2c20 6973 5f73 6861  rch.bool, is_sha
+000417a0: 7265 643d 4661 6c73 6529 2c0d 0a20 2020  red=False),..   
+000417b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000417c0: 2020 2020 2072 6577 6172 643a 2054 656e       reward: Ten
+000417d0: 736f 7228 7368 6170 653d 746f 7263 682e  sor(shape=torch.
+000417e0: 5369 7a65 285b 332c 2031 5d29 2c20 6465  Size([3, 1]), de
+000417f0: 7669 6365 3d63 7075 2c20 6474 7970 653d  vice=cpu, dtype=
+00041800: 746f 7263 682e 666c 6f61 7433 322c 2069  torch.float32, i
+00041810: 735f 7368 6172 6564 3d46 616c 7365 292c  s_shared=False),
+00041820: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00041830: 2020 2020 2020 2020 2020 7374 7566 663a            stuff:
+00041840: 2054 656e 736f 7228 7368 6170 653d 746f   Tensor(shape=to
+00041850: 7263 682e 5369 7a65 285b 332c 2033 5d29  rch.Size([3, 3])
+00041860: 2c20 6465 7669 6365 3d63 7075 2c20 6474  , device=cpu, dt
+00041870: 7970 653d 746f 7263 682e 666c 6f61 7433  ype=torch.float3
+00041880: 322c 2069 735f 7368 6172 6564 3d46 616c  2, is_shared=Fal
+00041890: 7365 297d 2c0d 0a20 2020 2020 2020 2020  se)},..         
+000418a0: 2020 2020 2020 2020 2020 2062 6174 6368             batch
+000418b0: 5f73 697a 653d 746f 7263 682e 5369 7a65  _size=torch.Size
+000418c0: 285b 335d 292c 0d0a 2020 2020 2020 2020  ([3]),..        
+000418d0: 2020 2020 2020 2020 2020 2020 6465 7669              devi
+000418e0: 6365 3d63 7075 2c0d 0a20 2020 2020 2020  ce=cpu,..       
+000418f0: 2020 2020 2020 2020 2020 2020 2069 735f               is_
+00041900: 7368 6172 6564 3d46 616c 7365 292c 0d0a  shared=False),..
+00041910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041920: 7374 7566 663a 2054 656e 736f 7228 7368  stuff: Tensor(sh
+00041930: 6170 653d 746f 7263 682e 5369 7a65 285b  ape=torch.Size([
+00041940: 332c 2033 5d29 2c20 6465 7669 6365 3d63  3, 3]), device=c
+00041950: 7075 2c20 6474 7970 653d 746f 7263 682e  pu, dtype=torch.
+00041960: 666c 6f61 7433 322c 2069 735f 7368 6172  float32, is_shar
+00041970: 6564 3d46 616c 7365 297d 2c0d 0a20 2020  ed=False)},..   
+00041980: 2020 2020 2020 2020 2062 6174 6368 5f73           batch_s
+00041990: 697a 653d 746f 7263 682e 5369 7a65 285b  ize=torch.Size([
+000419a0: 335d 292c 0d0a 2020 2020 2020 2020 2020  3]),..          
+000419b0: 2020 6465 7669 6365 3d63 7075 2c0d 0a20    device=cpu,.. 
+000419c0: 2020 2020 2020 2020 2020 2069 735f 7368             is_sh
+000419d0: 6172 6564 3d46 616c 7365 290d 0a20 2020  ared=False)..   
+000419e0: 2020 2020 203e 3e3e 2023 2069 6620 7468       >>> # if th
+000419f0: 6520 6f75 7470 7574 2069 7320 616c 736f  e output is also
+00041a00: 2061 6e20 696e 7075 742c 2077 6520 6e65   an input, we ne
+00041a10: 6564 2074 6f20 7265 6e61 6d65 2069 6620  ed to rename if 
+00041a20: 626f 7468 2077 6179 733a 0d0a 2020 2020  both ways:..    
+00041a30: 2020 2020 3e3e 3e20 6672 6f6d 2074 6f72      >>> from tor
+00041a40: 6368 726c 2e65 6e76 732e 6c69 6273 2e62  chrl.envs.libs.b
+00041a50: 7261 7820 696d 706f 7274 2042 7261 7845  rax import BraxE
+00041a60: 6e76 0d0a 2020 2020 2020 2020 3e3e 3e20  nv..        >>> 
+00041a70: 656e 7620 3d20 5472 616e 7366 6f72 6d65  env = Transforme
+00041a80: 6445 6e76 280d 0a20 2020 2020 2020 202e  dEnv(..        .
+00041a90: 2e2e 2020 2020 2042 7261 7845 6e76 2822  ..     BraxEnv("
+00041aa0: 6661 7374 2229 2c0d 0a20 2020 2020 2020  fast"),..       
+00041ab0: 202e 2e2e 2020 2020 2052 656e 616d 6554   ...     RenameT
+00041ac0: 7261 6e73 666f 726d 285b 2273 7461 7465  ransform(["state
+00041ad0: 225d 2c20 5b22 6e65 776e 616d 6522 5d2c  "], ["newname"],
+00041ae0: 205b 2273 7461 7465 225d 2c20 5b22 6e65   ["state"], ["ne
+00041af0: 776e 616d 6522 5d29 0d0a 2020 2020 2020  wname"])..      
+00041b00: 2020 2e2e 2e20 290d 0a20 2020 2020 2020    ... )..       
+00041b10: 203e 3e3e 205f 203d 2065 6e76 2e73 6574   >>> _ = env.set
+00041b20: 5f73 6565 6428 3129 0d0a 2020 2020 2020  _seed(1)..      
+00041b30: 2020 3e3e 3e20 7465 6e73 6f72 6469 6374    >>> tensordict
+00041b40: 203d 2065 6e76 2e72 6f6c 6c6f 7574 2833   = env.rollout(3
+00041b50: 290d 0a20 2020 2020 2020 203e 3e3e 2061  )..        >>> a
+00041b60: 7373 6572 7420 226e 6577 6e61 6d65 2220  ssert "newname" 
+00041b70: 696e 2074 656e 736f 7264 6963 742e 6b65  in tensordict.ke
+00041b80: 7973 2829 0d0a 2020 2020 2020 2020 3e3e  ys()..        >>
+00041b90: 3e20 6173 7365 7274 2022 7374 6174 6522  > assert "state"
+00041ba0: 206e 6f74 2069 6e20 7465 6e73 6f72 6469   not in tensordi
+00041bb0: 6374 2e6b 6579 7328 290d 0a0d 0a20 2020  ct.keys()....   
+00041bc0: 2022 2222 0d0a 0d0a 2020 2020 6465 6620   """....    def 
+00041bd0: 5f5f 696e 6974 5f5f 280d 0a20 2020 2020  __init__(..     
+00041be0: 2020 2073 656c 662c 2069 6e5f 6b65 7973     self, in_keys
+00041bf0: 2c20 6f75 745f 6b65 7973 2c20 696e 5f6b  , out_keys, in_k
+00041c00: 6579 735f 696e 763d 4e6f 6e65 2c20 6f75  eys_inv=None, ou
+00041c10: 745f 6b65 7973 5f69 6e76 3d4e 6f6e 652c  t_keys_inv=None,
+00041c20: 2063 7265 6174 655f 636f 7079 3d46 616c   create_copy=Fal
+00041c30: 7365 0d0a 2020 2020 293a 0d0a 2020 2020  se..    ):..    
+00041c40: 2020 2020 6966 2069 6e5f 6b65 7973 5f69      if in_keys_i
+00041c50: 6e76 2069 7320 4e6f 6e65 3a0d 0a20 2020  nv is None:..   
+00041c60: 2020 2020 2020 2020 2069 6e5f 6b65 7973           in_keys
+00041c70: 5f69 6e76 203d 205b 5d0d 0a20 2020 2020  _inv = []..     
+00041c80: 2020 2069 6620 6f75 745f 6b65 7973 5f69     if out_keys_i
+00041c90: 6e76 2069 7320 4e6f 6e65 3a0d 0a20 2020  nv is None:..   
+00041ca0: 2020 2020 2020 2020 206f 7574 5f6b 6579           out_key
+00041cb0: 735f 696e 7620 3d20 636f 7079 2869 6e5f  s_inv = copy(in_
+00041cc0: 6b65 7973 5f69 6e76 290d 0a20 2020 2020  keys_inv)..     
+00041cd0: 2020 2073 656c 662e 6372 6561 7465 5f63     self.create_c
+00041ce0: 6f70 7920 3d20 6372 6561 7465 5f63 6f70  opy = create_cop
+00041cf0: 790d 0a20 2020 2020 2020 2073 7570 6572  y..        super
+00041d00: 2829 2e5f 5f69 6e69 745f 5f28 696e 5f6b  ().__init__(in_k
+00041d10: 6579 732c 206f 7574 5f6b 6579 732c 2069  eys, out_keys, i
+00041d20: 6e5f 6b65 7973 5f69 6e76 2c20 6f75 745f  n_keys_inv, out_
+00041d30: 6b65 7973 5f69 6e76 290d 0a20 2020 2020  keys_inv)..     
+00041d40: 2020 2069 6620 6c65 6e28 7365 6c66 2e69     if len(self.i
+00041d50: 6e5f 6b65 7973 2920 213d 206c 656e 2873  n_keys) != len(s
+00041d60: 656c 662e 6f75 745f 6b65 7973 293a 0d0a  elf.out_keys):..
+00041d70: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00041d80: 6520 5661 6c75 6545 7272 6f72 280d 0a20  e ValueError(.. 
+00041d90: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00041da0: 2254 6865 206e 756d 6265 7220 6f66 2069  "The number of i
+00041db0: 6e5f 6b65 7973 2028 7b6c 656e 2873 656c  n_keys ({len(sel
+00041dc0: 662e 696e 5f6b 6579 7329 7d29 2073 686f  f.in_keys)}) sho
+00041dd0: 756c 6420 6d61 7463 6820 7468 6520 6e75  uld match the nu
+00041de0: 6d62 6572 206f 6620 6f75 745f 6b65 7973  mber of out_keys
+00041df0: 2028 7b6c 656e 2873 656c 662e 6f75 745f   ({len(self.out_
+00041e00: 6b65 7973 297d 292e 220d 0a20 2020 2020  keys)})."..     
+00041e10: 2020 2020 2020 2029 0d0a 2020 2020 2020         )..      
+00041e20: 2020 6966 206c 656e 2873 656c 662e 696e    if len(self.in
+00041e30: 5f6b 6579 735f 696e 7629 2021 3d20 6c65  _keys_inv) != le
+00041e40: 6e28 7365 6c66 2e6f 7574 5f6b 6579 735f  n(self.out_keys_
+00041e50: 696e 7629 3a0d 0a20 2020 2020 2020 2020  inv):..         
+00041e60: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00041e70: 726f 7228 0d0a 2020 2020 2020 2020 2020  ror(..          
+00041e80: 2020 2020 2020 6622 5468 6520 6e75 6d62        f"The numb
+00041e90: 6572 206f 6620 696e 5f6b 6579 735f 696e  er of in_keys_in
+00041ea0: 7620 287b 6c65 6e28 7365 6c66 2e69 6e5f  v ({len(self.in_
+00041eb0: 6b65 7973 5f69 6e76 297d 2920 7368 6f75  keys_inv)}) shou
+00041ec0: 6c64 206d 6174 6368 2074 6865 206e 756d  ld match the num
+00041ed0: 6265 7220 6f66 206f 7574 5f6b 6579 735f  ber of out_keys_
+00041ee0: 696e 7620 287b 6c65 6e28 7365 6c66 2e6f  inv ({len(self.o
+00041ef0: 7574 5f6b 6579 7329 7d29 2e22 0d0a 2020  ut_keys)})."..  
+00041f00: 2020 2020 2020 2020 2020 290d 0a20 2020            )..   
+00041f10: 2020 2020 2069 6620 6c65 6e28 7365 7428       if len(set(
+00041f20: 6f75 745f 6b65 7973 292e 696e 7465 7273  out_keys).inters
+00041f30: 6563 7469 6f6e 2869 6e5f 6b65 7973 2929  ection(in_keys))
+00041f40: 3a0d 0a20 2020 2020 2020 2020 2020 2072  :..            r
+00041f50: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00041f60: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00041f70: 2020 6622 4361 6e6e 6f74 2068 6176 6520    f"Cannot have 
+00041f80: 6d61 7463 6869 6e67 2069 6e20 616e 6420  matching in and 
+00041f90: 6f75 745f 6b65 7973 2062 6563 6175 7365  out_keys because
+00041fa0: 206f 7264 6572 2069 7320 756e 636c 6561   order is unclea
+00041fb0: 722e 2022 0d0a 2020 2020 2020 2020 2020  r. "..          
+00041fc0: 2020 2020 2020 6622 506c 6561 7365 2075        f"Please u
+00041fd0: 7365 2073 6570 6172 6174 6564 2074 7261  se separated tra
+00041fe0: 6e73 666f 726d 732e 2022 0d0a 2020 2020  nsforms. "..    
+00041ff0: 2020 2020 2020 2020 2020 2020 6622 476f              f"Go
+00042000: 7420 696e 5f6b 6579 733d 7b69 6e5f 6b65  t in_keys={in_ke
+00042010: 7973 7d20 616e 6420 6f75 745f 6b65 7973  ys} and out_keys
+00042020: 3d7b 6f75 745f 6b65 7973 7d2e 220d 0a20  ={out_keys}.".. 
+00042030: 2020 2020 2020 2020 2020 2029 0d0a 0d0a             )....
+00042040: 2020 2020 6465 6620 5f63 616c 6c28 7365      def _call(se
+00042050: 6c66 2c20 7465 6e73 6f72 6469 6374 3a20  lf, tensordict: 
+00042060: 5465 6e73 6f72 4469 6374 4261 7365 2920  TensorDictBase) 
+00042070: 2d3e 2054 656e 736f 7244 6963 7442 6173  -> TensorDictBas
+00042080: 653a 0d0a 2020 2020 2020 2020 6966 2073  e:..        if s
+00042090: 656c 662e 6372 6561 7465 5f63 6f70 793a  elf.create_copy:
+000420a0: 0d0a 2020 2020 2020 2020 2020 2020 6f75  ..            ou
+000420b0: 7420 3d20 7465 6e73 6f72 6469 6374 2e73  t = tensordict.s
+000420c0: 656c 6563 7428 2a73 656c 662e 696e 5f6b  elect(*self.in_k
+000420d0: 6579 732c 2073 7472 6963 743d 6e6f 7420  eys, strict=not 
+000420e0: 7365 6c66 2e5f 6d69 7373 696e 675f 746f  self._missing_to
+000420f0: 6c65 7261 6e63 6529 0d0a 2020 2020 2020  lerance)..      
+00042100: 2020 2020 2020 666f 7220 696e 5f6b 6579        for in_key
+00042110: 2c20 6f75 745f 6b65 7920 696e 207a 6970  , out_key in zip
+00042120: 2873 656c 662e 696e 5f6b 6579 732c 2073  (self.in_keys, s
+00042130: 656c 662e 6f75 745f 6b65 7973 293a 0d0a  elf.out_keys):..
+00042140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042150: 7472 793a 0d0a 2020 2020 2020 2020 2020  try:..          
+00042160: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
+00042170: 6469 6374 2e72 656e 616d 655f 6b65 795f  dict.rename_key_
+00042180: 2869 6e5f 6b65 792c 206f 7574 5f6b 6579  (in_key, out_key
+00042190: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+000421a0: 2020 2065 7863 6570 7420 4b65 7945 7272     except KeyErr
+000421b0: 6f72 3a0d 0a20 2020 2020 2020 2020 2020  or:..           
+000421c0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+000421d0: 7365 6c66 2e5f 6d69 7373 696e 675f 746f  self._missing_to
+000421e0: 6c65 7261 6e63 653a 0d0a 2020 2020 2020  lerance:..      
+000421f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042200: 2020 7261 6973 650d 0a20 2020 2020 2020    raise..       
+00042210: 2020 2020 2074 656e 736f 7264 6963 7420       tensordict 
+00042220: 3d20 7465 6e73 6f72 6469 6374 2e75 7064  = tensordict.upd
+00042230: 6174 6528 6f75 7429 0d0a 2020 2020 2020  ate(out)..      
+00042240: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
+00042250: 2020 2020 2066 6f72 2069 6e5f 6b65 792c       for in_key,
+00042260: 206f 7574 5f6b 6579 2069 6e20 7a69 7028   out_key in zip(
+00042270: 7365 6c66 2e69 6e5f 6b65 7973 2c20 7365  self.in_keys, se
+00042280: 6c66 2e6f 7574 5f6b 6579 7329 3a0d 0a20  lf.out_keys):.. 
+00042290: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000422a0: 7279 3a0d 0a20 2020 2020 2020 2020 2020  ry:..           
+000422b0: 2020 2020 2020 2020 2074 656e 736f 7264           tensord
+000422c0: 6963 742e 7265 6e61 6d65 5f6b 6579 5f28  ict.rename_key_(
+000422d0: 696e 5f6b 6579 2c20 6f75 745f 6b65 7929  in_key, out_key)
+000422e0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000422f0: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
+00042300: 723a 0d0a 2020 2020 2020 2020 2020 2020  r:..            
+00042310: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+00042320: 656c 662e 5f6d 6973 7369 6e67 5f74 6f6c  elf._missing_tol
+00042330: 6572 616e 6365 3a0d 0a20 2020 2020 2020  erance:..       
+00042340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042350: 2072 6169 7365 0d0a 2020 2020 2020 2020   raise..        
+00042360: 7265 7475 726e 2074 656e 736f 7264 6963  return tensordic
+00042370: 740d 0a0d 0a20 2020 2066 6f72 7761 7264  t....    forward
+00042380: 203d 205f 6361 6c6c 0d0a 0d0a 2020 2020   = _call....    
+00042390: 6465 6620 5f72 6573 6574 280d 0a20 2020  def _reset(..   
+000423a0: 2020 2020 2073 656c 662c 2074 656e 736f       self, tenso
+000423b0: 7264 6963 743a 2054 656e 736f 7244 6963  rdict: TensorDic
+000423c0: 7442 6173 652c 2074 656e 736f 7264 6963  tBase, tensordic
+000423d0: 745f 7265 7365 743a 2054 656e 736f 7244  t_reset: TensorD
+000423e0: 6963 7442 6173 650d 0a20 2020 2029 202d  ictBase..    ) -
+000423f0: 3e20 5465 6e73 6f72 4469 6374 4261 7365  > TensorDictBase
+00042400: 3a0d 0a20 2020 2020 2020 2077 6974 6820  :..        with 
+00042410: 5f73 6574 5f6d 6973 7369 6e67 5f74 6f6c  _set_missing_tol
+00042420: 6572 616e 6365 2873 656c 662c 2054 7275  erance(self, Tru
+00042430: 6529 3a0d 0a20 2020 2020 2020 2020 2020  e):..           
+00042440: 2072 6574 7572 6e20 7365 6c66 2e5f 6361   return self._ca
+00042450: 6c6c 2874 656e 736f 7264 6963 745f 7265  ll(tensordict_re
+00042460: 7365 7429 0d0a 0d0a 2020 2020 6465 6620  set)....    def 
+00042470: 5f69 6e76 5f63 616c 6c28 7365 6c66 2c20  _inv_call(self, 
+00042480: 7465 6e73 6f72 6469 6374 3a20 5465 6e73  tensordict: Tens
+00042490: 6f72 4469 6374 4261 7365 2920 2d3e 2054  orDictBase) -> T
+000424a0: 656e 736f 7244 6963 7442 6173 653a 0d0a  ensorDictBase:..
+000424b0: 2020 2020 2020 2020 2320 6e6f 2069 6e2d          # no in-
+000424c0: 706c 6163 6520 6d6f 6469 660d 0a20 2020  place modif..   
+000424d0: 2020 2020 2069 6620 7365 6c66 2e63 7265       if self.cre
+000424e0: 6174 655f 636f 7079 3a0d 0a20 2020 2020  ate_copy:..     
+000424f0: 2020 2020 2020 206f 7574 203d 2074 656e         out = ten
+00042500: 736f 7264 6963 742e 7365 6c65 6374 280d  sordict.select(.
+00042510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00042520: 202a 7365 6c66 2e6f 7574 5f6b 6579 735f   *self.out_keys_
+00042530: 696e 762c 2073 7472 6963 743d 6e6f 7420  inv, strict=not 
+00042540: 7365 6c66 2e5f 6d69 7373 696e 675f 746f  self._missing_to
+00042550: 6c65 7261 6e63 650d 0a20 2020 2020 2020  lerance..       
+00042560: 2020 2020 2029 0d0a 2020 2020 2020 2020       )..        
+00042570: 2020 2020 666f 7220 696e 5f6b 6579 2c20      for in_key, 
+00042580: 6f75 745f 6b65 7920 696e 207a 6970 2873  out_key in zip(s
+00042590: 656c 662e 696e 5f6b 6579 735f 696e 762c  elf.in_keys_inv,
+000425a0: 2073 656c 662e 6f75 745f 6b65 7973 5f69   self.out_keys_i
+000425b0: 6e76 293a 0d0a 2020 2020 2020 2020 2020  nv):..          
+000425c0: 2020 2020 2020 7472 793a 0d0a 2020 2020        try:..    
+000425d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000425e0: 6f75 742e 7265 6e61 6d65 5f6b 6579 5f28  out.rename_key_(
+000425f0: 6f75 745f 6b65 792c 2069 6e5f 6b65 7929  out_key, in_key)
+00042600: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00042610: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
+00042620: 723a 0d0a 2020 2020 2020 2020 2020 2020  r:..            
+00042630: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+00042640: 656c 662e 5f6d 6973 7369 6e67 5f74 6f6c  elf._missing_tol
+00042650: 6572 616e 6365 3a0d 0a20 2020 2020 2020  erance:..       
+00042660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042670: 2072 6169 7365 0d0a 0d0a 2020 2020 2020   raise....      
+00042680: 2020 2020 2020 7465 6e73 6f72 6469 6374        tensordict
+00042690: 203d 2074 656e 736f 7264 6963 742e 7570   = tensordict.up
+000426a0: 6461 7465 286f 7574 290d 0a20 2020 2020  date(out)..     
+000426b0: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
+000426c0: 2020 2020 2020 666f 7220 696e 5f6b 6579        for in_key
+000426d0: 2c20 6f75 745f 6b65 7920 696e 207a 6970  , out_key in zip
+000426e0: 2873 656c 662e 696e 5f6b 6579 735f 696e  (self.in_keys_in
+000426f0: 762c 2073 656c 662e 6f75 745f 6b65 7973  v, self.out_keys
+00042700: 5f69 6e76 293a 0d0a 2020 2020 2020 2020  _inv):..        
+00042710: 2020 2020 2020 2020 7472 793a 0d0a 2020          try:..  
+00042720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042730: 2020 7465 6e73 6f72 6469 6374 2e72 656e    tensordict.ren
+00042740: 616d 655f 6b65 795f 286f 7574 5f6b 6579  ame_key_(out_key
+00042750: 2c20 696e 5f6b 6579 290d 0a20 2020 2020  , in_key)..     
+00042760: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00042770: 7420 4b65 7945 7272 6f72 3a0d 0a20 2020  t KeyError:..   
+00042780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042790: 2069 6620 6e6f 7420 7365 6c66 2e5f 6d69   if not self._mi
+000427a0: 7373 696e 675f 746f 6c65 7261 6e63 653a  ssing_tolerance:
+000427b0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000427c0: 2020 2020 2020 2020 2020 7261 6973 650d            raise.
+000427d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000427e0: 7465 6e73 6f72 6469 6374 0d0a 0d0a 2020  tensordict....  
+000427f0: 2020 6465 6620 7472 616e 7366 6f72 6d5f    def transform_
+00042800: 6f75 7470 7574 5f73 7065 6328 7365 6c66  output_spec(self
+00042810: 2c20 6f75 7470 7574 5f73 7065 633a 2043  , output_spec: C
+00042820: 6f6d 706f 7369 7465 5370 6563 2920 2d3e  ompositeSpec) ->
+00042830: 2043 6f6d 706f 7369 7465 5370 6563 3a0d   CompositeSpec:.
+00042840: 0a20 2020 2020 2020 2066 6f72 2064 6f6e  .        for don
+00042850: 655f 6b65 7920 696e 2073 656c 662e 7061  e_key in self.pa
+00042860: 7265 6e74 2e64 6f6e 655f 6b65 7973 3a0d  rent.done_keys:.
+00042870: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00042880: 646f 6e65 5f6b 6579 2069 6e20 7365 6c66  done_key in self
+00042890: 2e69 6e5f 6b65 7973 3a0d 0a20 2020 2020  .in_keys:..     
+000428a0: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+000428b0: 2c20 6f75 745f 6b65 7920 696e 2065 6e75  , out_key in enu
+000428c0: 6d65 7261 7465 2873 656c 662e 6f75 745f  merate(self.out_
+000428d0: 6b65 7973 293a 2020 2320 6e6f 7161 3a20  keys):  # noqa: 
+000428e0: 4230 3037 0d0a 2020 2020 2020 2020 2020  B007..          
+000428f0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+00042900: 662e 696e 5f6b 6579 735b 695d 203d 3d20  f.in_keys[i] == 
+00042910: 646f 6e65 5f6b 6579 3a0d 0a20 2020 2020  done_key:..     
+00042920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042930: 2020 2062 7265 616b 0d0a 2020 2020 2020     break..      
+00042940: 2020 2020 2020 2020 2020 656c 7365 3a0d            else:.
+00042950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00042960: 2020 2020 2023 2075 6e72 6561 6368 6162       # unreachab
+00042970: 6c65 0d0a 2020 2020 2020 2020 2020 2020  le..            
+00042980: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
+00042990: 6e74 696d 6545 7272 6f72 0d0a 2020 2020  ntimeError..    
+000429a0: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+000429b0: 7574 5f73 7065 635b 2266 756c 6c5f 646f  ut_spec["full_do
+000429c0: 6e65 5f73 7065 6322 5d5b 6f75 745f 6b65  ne_spec"][out_ke
+000429d0: 795d 203d 206f 7574 7075 745f 7370 6563  y] = output_spec
+000429e0: 5b22 6675 6c6c 5f64 6f6e 655f 7370 6563  ["full_done_spec
+000429f0: 225d 5b0d 0a20 2020 2020 2020 2020 2020  "][..           
+00042a00: 2020 2020 2020 2020 2064 6f6e 655f 6b65           done_ke
+00042a10: 790d 0a20 2020 2020 2020 2020 2020 2020  y..             
+00042a20: 2020 205d 2e63 6c6f 6e65 2829 0d0a 2020     ].clone()..  
+00042a30: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00042a40: 206e 6f74 2073 656c 662e 6372 6561 7465   not self.create
+00042a50: 5f63 6f70 793a 0d0a 2020 2020 2020 2020  _copy:..        
+00042a60: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
+00042a70: 6f75 7470 7574 5f73 7065 635b 2266 756c  output_spec["ful
+00042a80: 6c5f 646f 6e65 5f73 7065 6322 5d5b 646f  l_done_spec"][do
+00042a90: 6e65 5f6b 6579 5d0d 0a20 2020 2020 2020  ne_key]..       
+00042aa0: 2066 6f72 2072 6577 6172 645f 6b65 7920   for reward_key 
+00042ab0: 696e 2073 656c 662e 7061 7265 6e74 2e72  in self.parent.r
+00042ac0: 6577 6172 645f 6b65 7973 3a0d 0a20 2020  eward_keys:..   
+00042ad0: 2020 2020 2020 2020 2069 6620 7265 7761           if rewa
+00042ae0: 7264 5f6b 6579 2069 6e20 7365 6c66 2e69  rd_key in self.i
+00042af0: 6e5f 6b65 7973 3a0d 0a20 2020 2020 2020  n_keys:..       
+00042b00: 2020 2020 2020 2020 2066 6f72 2069 2c20           for i, 
+00042b10: 6f75 745f 6b65 7920 696e 2065 6e75 6d65  out_key in enume
+00042b20: 7261 7465 2873 656c 662e 6f75 745f 6b65  rate(self.out_ke
+00042b30: 7973 293a 2020 2320 6e6f 7161 3a20 4230  ys):  # noqa: B0
+00042b40: 3037 0d0a 2020 2020 2020 2020 2020 2020  07..            
+00042b50: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00042b60: 696e 5f6b 6579 735b 695d 203d 3d20 7265  in_keys[i] == re
+00042b70: 7761 7264 5f6b 6579 3a0d 0a20 2020 2020  ward_key:..     
+00042b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042b90: 2020 2062 7265 616b 0d0a 2020 2020 2020     break..      
+00042ba0: 2020 2020 2020 2020 2020 656c 7365 3a0d            else:.
+00042bb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00042bc0: 2020 2020 2023 2075 6e72 6561 6368 6162       # unreachab
+00042bd0: 6c65 0d0a 2020 2020 2020 2020 2020 2020  le..            
+00042be0: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
+00042bf0: 6e74 696d 6545 7272 6f72 0d0a 2020 2020  ntimeError..    
+00042c00: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+00042c10: 7574 5f73 7065 635b 2266 756c 6c5f 7265  ut_spec["full_re
+00042c20: 7761 7264 5f73 7065 6322 5d5b 6f75 745f  ward_spec"][out_
+00042c30: 6b65 795d 203d 206f 7574 7075 745f 7370  key] = output_sp
+00042c40: 6563 5b0d 0a20 2020 2020 2020 2020 2020  ec[..           
+00042c50: 2020 2020 2020 2020 2022 6675 6c6c 5f72           "full_r
+00042c60: 6577 6172 645f 7370 6563 220d 0a20 2020  eward_spec"..   
+00042c70: 2020 2020 2020 2020 2020 2020 205d 5b72               ][r
+00042c80: 6577 6172 645f 6b65 795d 2e63 6c6f 6e65  eward_key].clone
+00042c90: 2829 0d0a 2020 2020 2020 2020 2020 2020  ()..            
+00042ca0: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+00042cb0: 6372 6561 7465 5f63 6f70 793a 0d0a 2020  create_copy:..  
+00042cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042cd0: 2020 6465 6c20 6f75 7470 7574 5f73 7065    del output_spe
+00042ce0: 635b 2266 756c 6c5f 7265 7761 7264 5f73  c["full_reward_s
+00042cf0: 7065 6322 5d5b 7265 7761 7264 5f6b 6579  pec"][reward_key
+00042d00: 5d0d 0a20 2020 2020 2020 2066 6f72 206f  ]..        for o
+00042d10: 6273 6572 7661 7469 6f6e 5f6b 6579 2069  bservation_key i
+00042d20: 6e20 7365 6c66 2e70 6172 656e 742e 6675  n self.parent.fu
+00042d30: 6c6c 5f6f 6273 6572 7661 7469 6f6e 5f73  ll_observation_s
+00042d40: 7065 632e 6b65 7973 2854 7275 6529 3a0d  pec.keys(True):.
+00042d50: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00042d60: 6f62 7365 7276 6174 696f 6e5f 6b65 7920  observation_key 
+00042d70: 696e 2073 656c 662e 696e 5f6b 6579 733a  in self.in_keys:
+00042d80: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00042d90: 2020 666f 7220 692c 206f 7574 5f6b 6579    for i, out_key
+00042da0: 2069 6e20 656e 756d 6572 6174 6528 7365   in enumerate(se
+00042db0: 6c66 2e6f 7574 5f6b 6579 7329 3a20 2023  lf.out_keys):  #
+00042dc0: 206e 6f71 613a 2042 3030 370d 0a20 2020   noqa: B007..   
+00042dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042de0: 2069 6620 7365 6c66 2e69 6e5f 6b65 7973   if self.in_keys
+00042df0: 5b69 5d20 3d3d 206f 6273 6572 7661 7469  [i] == observati
+00042e00: 6f6e 5f6b 6579 3a0d 0a20 2020 2020 2020  on_key:..       
+00042e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042e20: 2062 7265 616b 0d0a 2020 2020 2020 2020   break..        
+00042e30: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
+00042e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042e50: 2020 2023 2075 6e72 6561 6368 6162 6c65     # unreachable
+00042e60: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00042e70: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
+00042e80: 696d 6545 7272 6f72 0d0a 2020 2020 2020  imeError..      
+00042e90: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+00042ea0: 5f73 7065 635b 2266 756c 6c5f 6f62 7365  _spec["full_obse
+00042eb0: 7276 6174 696f 6e5f 7370 6563 225d 5b6f  rvation_spec"][o
+00042ec0: 7574 5f6b 6579 5d20 3d20 6f75 7470 7574  ut_key] = output
+00042ed0: 5f73 7065 635b 0d0a 2020 2020 2020 2020  _spec[..        
+00042ee0: 2020 2020 2020 2020 2020 2020 2266 756c              "ful
+00042ef0: 6c5f 6f62 7365 7276 6174 696f 6e5f 7370  l_observation_sp
+00042f00: 6563 220d 0a20 2020 2020 2020 2020 2020  ec"..           
+00042f10: 2020 2020 205d 5b6f 6273 6572 7661 7469       ][observati
+00042f20: 6f6e 5f6b 6579 5d2e 636c 6f6e 6528 290d  on_key].clone().
+00042f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00042f40: 2069 6620 6e6f 7420 7365 6c66 2e63 7265   if not self.cre
+00042f50: 6174 655f 636f 7079 3a0d 0a20 2020 2020  ate_copy:..     
+00042f60: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00042f70: 656c 206f 7574 7075 745f 7370 6563 5b22  el output_spec["
+00042f80: 6675 6c6c 5f6f 6273 6572 7661 7469 6f6e  full_observation
+00042f90: 5f73 7065 6322 5d5b 6f62 7365 7276 6174  _spec"][observat
+00042fa0: 696f 6e5f 6b65 795d 0d0a 2020 2020 2020  ion_key]..      
+00042fb0: 2020 7265 7475 726e 206f 7574 7075 745f    return output_
+00042fc0: 7370 6563 0d0a 0d0a 2020 2020 6465 6620  spec....    def 
+00042fd0: 7472 616e 7366 6f72 6d5f 696e 7075 745f  transform_input_
+00042fe0: 7370 6563 2873 656c 662c 2069 6e70 7574  spec(self, input
+00042ff0: 5f73 7065 633a 2043 6f6d 706f 7369 7465  _spec: Composite
+00043000: 5370 6563 2920 2d3e 2043 6f6d 706f 7369  Spec) -> Composi
+00043010: 7465 5370 6563 3a0d 0a20 2020 2020 2020  teSpec:..       
+00043020: 2066 6f72 2061 6374 696f 6e5f 6b65 7920   for action_key 
+00043030: 696e 2073 656c 662e 7061 7265 6e74 2e61  in self.parent.a
+00043040: 6374 696f 6e5f 6b65 7973 3a0d 0a20 2020  ction_keys:..   
+00043050: 2020 2020 2020 2020 2069 6620 6163 7469           if acti
+00043060: 6f6e 5f6b 6579 2069 6e20 7365 6c66 2e69  on_key in self.i
+00043070: 6e5f 6b65 7973 3a0d 0a20 2020 2020 2020  n_keys:..       
+00043080: 2020 2020 2020 2020 2066 6f72 2069 2c20           for i, 
+00043090: 6f75 745f 6b65 7920 696e 2065 6e75 6d65  out_key in enume
+000430a0: 7261 7465 2873 656c 662e 6f75 745f 6b65  rate(self.out_ke
+000430b0: 7973 293a 2020 2320 6e6f 7161 3a20 4230  ys):  # noqa: B0
+000430c0: 3037 0d0a 2020 2020 2020 2020 2020 2020  07..            
+000430d0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000430e0: 696e 5f6b 6579 735b 695d 203d 3d20 6163  in_keys[i] == ac
+000430f0: 7469 6f6e 5f6b 6579 3a0d 0a20 2020 2020  tion_key:..     
+00043100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043110: 2020 2062 7265 616b 0d0a 2020 2020 2020     break..      
+00043120: 2020 2020 2020 2020 2020 656c 7365 3a0d            else:.
+00043130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00043140: 2020 2020 2023 2075 6e72 6561 6368 6162       # unreachab
+00043150: 6c65 0d0a 2020 2020 2020 2020 2020 2020  le..            
+00043160: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
+00043170: 6e74 696d 6545 7272 6f72 0d0a 2020 2020  ntimeError..    
+00043180: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+00043190: 745f 7370 6563 5b22 6675 6c6c 5f61 6374  t_spec["full_act
+000431a0: 696f 6e5f 7370 6563 225d 5b6f 7574 5f6b  ion_spec"][out_k
+000431b0: 6579 5d20 3d20 696e 7075 745f 7370 6563  ey] = input_spec
+000431c0: 5b0d 0a20 2020 2020 2020 2020 2020 2020  [..             
+000431d0: 2020 2020 2020 2022 6675 6c6c 5f61 6374         "full_act
+000431e0: 696f 6e5f 7370 6563 220d 0a20 2020 2020  ion_spec"..     
+000431f0: 2020 2020 2020 2020 2020 205d 5b61 6374             ][act
+00043200: 696f 6e5f 6b65 795d 2e63 6c6f 6e65 2829  ion_key].clone()
+00043210: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00043220: 2020 6966 206e 6f74 2073 656c 662e 6372    if not self.cr
+00043230: 6561 7465 5f63 6f70 793a 0d0a 2020 2020  eate_copy:..    
+00043240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043250: 6465 6c20 696e 7075 745f 7370 6563 5b22  del input_spec["
+00043260: 6675 6c6c 5f61 6374 696f 6e5f 7370 6563  full_action_spec
+00043270: 225d 5b61 6374 696f 6e5f 6b65 795d 0d0a  "][action_key]..
+00043280: 2020 2020 2020 2020 666f 7220 7374 6174          for stat
+00043290: 655f 6b65 7920 696e 2073 656c 662e 7061  e_key in self.pa
+000432a0: 7265 6e74 2e66 756c 6c5f 7374 6174 655f  rent.full_state_
+000432b0: 7370 6563 2e6b 6579 7328 5472 7565 293a  spec.keys(True):
+000432c0: 0d0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+000432d0: 2073 7461 7465 5f6b 6579 2069 6e20 7365   state_key in se
+000432e0: 6c66 2e69 6e5f 6b65 7973 3a0d 0a20 2020  lf.in_keys:..   
+000432f0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00043300: 2069 2c20 6f75 745f 6b65 7920 696e 2065   i, out_key in e
+00043310: 6e75 6d65 7261 7465 2873 656c 662e 6f75  numerate(self.ou
+00043320: 745f 6b65 7973 293a 2020 2320 6e6f 7161  t_keys):  # noqa
+00043330: 3a20 4230 3037 0d0a 2020 2020 2020 2020  : B007..        
+00043340: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00043350: 656c 662e 696e 5f6b 6579 735b 695d 203d  elf.in_keys[i] =
+00043360: 3d20 7374 6174 655f 6b65 793a 0d0a 2020  = state_key:..  
+00043370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043380: 2020 2020 2020 6272 6561 6b0d 0a20 2020        break..   
+00043390: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+000433a0: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+000433b0: 2020 2020 2020 2020 2320 756e 7265 6163          # unreac
+000433c0: 6861 626c 650d 0a20 2020 2020 2020 2020  hable..         
+000433d0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000433e0: 2052 756e 7469 6d65 4572 726f 720d 0a20   RuntimeError.. 
+000433f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00043400: 6e70 7574 5f73 7065 635b 2266 756c 6c5f  nput_spec["full_
+00043410: 7374 6174 655f 7370 6563 225d 5b6f 7574  state_spec"][out
+00043420: 5f6b 6579 5d20 3d20 696e 7075 745f 7370  _key] = input_sp
+00043430: 6563 5b22 6675 6c6c 5f73 7461 7465 5f73  ec["full_state_s
+00043440: 7065 6322 5d5b 0d0a 2020 2020 2020 2020  pec"][..        
+00043450: 2020 2020 2020 2020 2020 2020 7374 6174              stat
+00043460: 655f 6b65 790d 0a20 2020 2020 2020 2020  e_key..         
+00043470: 2020 2020 2020 205d 2e63 6c6f 6e65 2829         ].clone()
+00043480: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00043490: 2020 6966 206e 6f74 2073 656c 662e 6372    if not self.cr
+000434a0: 6561 7465 5f63 6f70 793a 0d0a 2020 2020  eate_copy:..    
+000434b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000434c0: 6465 6c20 696e 7075 745f 7370 6563 5b22  del input_spec["
+000434d0: 6675 6c6c 5f73 7461 7465 5f73 7065 6322  full_state_spec"
+000434e0: 5d5b 7374 6174 655f 6b65 795d 0d0a 2020  ][state_key]..  
+000434f0: 2020 2020 2020 7265 7475 726e 2069 6e70        return inp
+00043500: 7574 5f73 7065 630d 0a0d 0a0d 0a63 6c61  ut_spec......cla
+00043510: 7373 2052 6577 6172 6432 476f 5472 616e  ss Reward2GoTran
+00043520: 7366 6f72 6d28 5472 616e 7366 6f72 6d29  sform(Transform)
+00043530: 3a0d 0a20 2020 2022 2222 4361 6c63 756c  :..    """Calcul
+00043540: 6174 6573 2074 6865 2072 6577 6172 6420  ates the reward 
+00043550: 746f 2067 6f20 6261 7365 6420 6f6e 2074  to go based on t
+00043560: 6865 2065 7069 736f 6465 2072 6577 6172  he episode rewar
+00043570: 6420 616e 6420 6120 6469 7363 6f75 6e74  d and a discount
+00043580: 2066 6163 746f 722e 0d0a 0d0a 2020 2020   factor.....    
+00043590: 4173 2074 6865 203a 636c 6173 733a 607e  As the :class:`~
+000435a0: 2e52 6577 6172 6432 476f 5472 616e 7366  .Reward2GoTransf
+000435b0: 6f72 6d60 2069 7320 6f6e 6c79 2061 6e20  orm` is only an 
+000435c0: 696e 7665 7273 6520 7472 616e 7366 6f72  inverse transfor
+000435d0: 6d20 7468 6520 6060 696e 5f6b 6579 7360  m the ``in_keys`
+000435e0: 6020 7769 6c6c 2062 6520 6469 7265 6374  ` will be direct
+000435f0: 6c79 2075 7365 6420 666f 7220 7468 6520  ly used for the 
+00043600: 6060 696e 5f6b 6579 735f 696e 7660 602e  ``in_keys_inv``.
+00043610: 0d0a 2020 2020 5468 6520 7265 7761 7264  ..    The reward
+00043620: 2d74 6f2d 676f 2063 616e 2062 6520 6f6e  -to-go can be on
+00043630: 6c79 2063 616c 6375 6c61 7465 6420 6f6e  ly calculated on
+00043640: 6365 2074 6865 2065 7069 736f 6465 2069  ce the episode i
+00043650: 7320 6669 6e69 7368 6564 2e20 5468 6572  s finished. Ther
+00043660: 6566 6f72 652c 2074 6865 2074 7261 6e73  efore, the trans
+00043670: 666f 726d 2073 686f 756c 6420 6265 2061  form should be a
+00043680: 7070 6c69 6564 2074 6f20 7468 6520 7265  pplied to the re
+00043690: 706c 6179 2062 7566 6665 720d 0a20 2020  play buffer..   
+000436a0: 2061 6e64 206e 6f74 2074 6f20 7468 6520   and not to the 
+000436b0: 636f 6c6c 6563 746f 7220 6f72 2077 6974  collector or wit
+000436c0: 6869 6e20 616e 2065 6e76 6972 6f6e 6d65  hin an environme
+000436d0: 6e74 2e0d 0a0d 0a20 2020 2041 7267 733a  nt.....    Args:
+000436e0: 0d0a 2020 2020 2020 2020 6761 6d6d 6120  ..        gamma 
+000436f0: 2866 6c6f 6174 206f 7220 746f 7263 682e  (float or torch.
+00043700: 5465 6e73 6f72 293a 2074 6865 2064 6973  Tensor): the dis
+00043710: 636f 756e 7420 6661 6374 6f72 2e20 4465  count factor. De
+00043720: 6661 756c 7473 2074 6f20 312e 302e 0d0a  faults to 1.0...
+00043730: 2020 2020 2020 2020 696e 5f6b 6579 7320          in_keys 
+00043740: 2873 6571 7565 6e63 6520 6f66 204e 6573  (sequence of Nes
+00043750: 7465 644b 6579 293a 2074 6865 2065 6e74  tedKey): the ent
+00043760: 7269 6573 2074 6f20 7265 6e61 6d65 2e20  ries to rename. 
+00043770: 4465 6661 756c 7473 2074 6f0d 0a20 2020  Defaults to..   
+00043780: 2020 2020 2020 2020 2060 6028 226e 6578           ``("nex
+00043790: 7422 2c20 2272 6577 6172 6422 2960 6020  t", "reward")`` 
+000437a0: 6966 206e 6f6e 6520 6973 2070 726f 7669  if none is provi
+000437b0: 6465 642e 0d0a 2020 2020 2020 2020 6f75  ded...        ou
+000437c0: 745f 6b65 7973 2028 7365 7175 656e 6365  t_keys (sequence
+000437d0: 206f 6620 4e65 7374 6564 4b65 7929 3a20   of NestedKey): 
+000437e0: 7468 6520 656e 7472 6965 7320 746f 2072  the entries to r
+000437f0: 656e 616d 652e 2044 6566 6175 6c74 7320  ename. Defaults 
+00043800: 746f 0d0a 2020 2020 2020 2020 2020 2020  to..            
+00043810: 7468 6520 7661 6c75 6573 206f 6620 6060  the values of ``
+00043820: 696e 5f6b 6579 7360 6020 6966 206e 6f6e  in_keys`` if non
+00043830: 6520 6973 2070 726f 7669 6465 642e 0d0a  e is provided...
+00043840: 2020 2020 2020 2020 646f 6e65 5f6b 6579          done_key
+00043850: 2028 4e65 7374 6564 4b65 7929 3a20 7468   (NestedKey): th
+00043860: 6520 646f 6e65 2065 6e74 7279 2e20 4465  e done entry. De
+00043870: 6661 756c 7473 2074 6f20 6060 2264 6f6e  faults to ``"don
+00043880: 6522 6060 2e0d 0a20 2020 2020 2020 2074  e"``...        t
+00043890: 7275 6e63 6174 6564 5f6b 6579 2028 4e65  runcated_key (Ne
+000438a0: 7374 6564 4b65 7929 3a20 7468 6520 7472  stedKey): the tr
+000438b0: 756e 6361 7465 6420 656e 7472 792e 2044  uncated entry. D
+000438c0: 6566 6175 6c74 7320 746f 2060 6022 7472  efaults to ``"tr
+000438d0: 756e 6361 7465 6422 6060 2e0d 0a20 2020  uncated"``...   
+000438e0: 2020 2020 2020 2020 2049 6620 6e6f 2074           If no t
+000438f0: 7275 6e63 6174 6564 2065 6e74 7279 2069  runcated entry i
+00043900: 7320 666f 756e 642c 206f 6e6c 7920 7468  s found, only th
+00043910: 6520 6060 2264 6f6e 6522 6060 2077 696c  e ``"done"`` wil
+00043920: 6c20 6265 2075 7365 642e 0d0a 0d0a 2020  l be used.....  
+00043930: 2020 4578 616d 706c 6573 3a0d 0a20 2020    Examples:..   
+00043940: 2020 2020 203e 3e3e 2023 2055 7369 6e67       >>> # Using
+00043950: 2074 6869 7320 7472 616e 7366 6f72 6d20   this transform 
+00043960: 6173 2070 6172 7420 6f66 2061 2072 6570  as part of a rep
+00043970: 6c61 7920 6275 6666 6572 0d0a 2020 2020  lay buffer..    
+00043980: 2020 2020 3e3e 3e20 6672 6f6d 2074 6f72      >>> from tor
+00043990: 6368 726c 2e64 6174 6120 696d 706f 7274  chrl.data import
+000439a0: 2052 6570 6c61 7942 7566 6665 722c 204c   ReplayBuffer, L
+000439b0: 617a 7954 656e 736f 7253 746f 7261 6765  azyTensorStorage
+000439c0: 0d0a 2020 2020 2020 2020 3e3e 3e20 746f  ..        >>> to
+000439d0: 7263 682e 6d61 6e75 616c 5f73 6565 6428  rch.manual_seed(
+000439e0: 3029 0d0a 2020 2020 2020 2020 3e3e 3e20  0)..        >>> 
+000439f0: 7232 6720 3d20 5265 7761 7264 3247 6f54  r2g = Reward2GoT
+00043a00: 7261 6e73 666f 726d 2867 616d 6d61 3d30  ransform(gamma=0
+00043a10: 2e39 392c 206f 7574 5f6b 6579 733d 5b22  .99, out_keys=["
+00043a20: 7265 7761 7264 5f74 6f5f 676f 225d 290d  reward_to_go"]).
+00043a30: 0a20 2020 2020 2020 203e 3e3e 2072 6220  .        >>> rb 
+00043a40: 3d20 5265 706c 6179 4275 6666 6572 2873  = ReplayBuffer(s
+00043a50: 746f 7261 6765 3d4c 617a 7954 656e 736f  torage=LazyTenso
+00043a60: 7253 746f 7261 6765 2831 3030 292c 2074  rStorage(100), t
+00043a70: 7261 6e73 666f 726d 3d72 3267 290d 0a20  ransform=r2g).. 
+00043a80: 2020 2020 2020 203e 3e3e 2062 6174 6368         >>> batch
+00043a90: 2c20 7469 6d65 7374 6570 7320 3d20 342c  , timesteps = 4,
+00043aa0: 2035 0d0a 2020 2020 2020 2020 3e3e 3e20   5..        >>> 
+00043ab0: 646f 6e65 203d 2074 6f72 6368 2e7a 6572  done = torch.zer
+00043ac0: 6f73 2862 6174 6368 2c20 7469 6d65 7374  os(batch, timest
+00043ad0: 6570 732c 2031 2c20 6474 7970 653d 746f  eps, 1, dtype=to
+00043ae0: 7263 682e 626f 6f6c 290d 0a20 2020 2020  rch.bool)..     
+00043af0: 2020 203e 3e3e 2066 6f72 2069 2069 6e20     >>> for i in 
+00043b00: 7261 6e67 6528 6261 7463 6829 3a0d 0a20  range(batch):.. 
+00043b10: 2020 2020 2020 202e 2e2e 2020 2020 2077         ...     w
+00043b20: 6869 6c65 206e 6f74 2064 6f6e 655b 695d  hile not done[i]
+00043b30: 2e61 6e79 2829 3a0d 0a20 2020 2020 2020  .any():..       
+00043b40: 202e 2e2e 2020 2020 2020 2020 2064 6f6e   ...         don
+00043b50: 655b 695d 203d 2064 6f6e 655b 695d 2e62  e[i] = done[i].b
+00043b60: 6572 6e6f 756c 6c69 5f28 302e 3129 0d0a  ernoulli_(0.1)..
+00043b70: 2020 2020 2020 2020 3e3e 3e20 7265 7761          >>> rewa
+00043b80: 7264 203d 2074 6f72 6368 2e6f 6e65 7328  rd = torch.ones(
+00043b90: 6261 7463 682c 2074 696d 6573 7465 7073  batch, timesteps
+00043ba0: 2c20 3129 0d0a 2020 2020 2020 2020 3e3e  , 1)..        >>
+00043bb0: 3e20 7464 203d 2054 656e 736f 7244 6963  > td = TensorDic
+00043bc0: 7428 0d0a 2020 2020 2020 2020 2e2e 2e20  t(..        ... 
+00043bd0: 2020 2020 7b22 6e65 7874 223a 207b 2264      {"next": {"d
+00043be0: 6f6e 6522 3a20 646f 6e65 2c20 2272 6577  one": done, "rew
+00043bf0: 6172 6422 3a20 7265 7761 7264 7d7d 2c0d  ard": reward}},.
+00043c00: 0a20 2020 2020 2020 202e 2e2e 2020 2020  .        ...    
+00043c10: 205b 6261 7463 682c 2074 696d 6573 7465   [batch, timeste
+00043c20: 7073 5d2c 0d0a 2020 2020 2020 2020 2e2e  ps],..        ..
+00043c30: 2e20 290d 0a20 2020 2020 2020 203e 3e3e  . )..        >>>
+00043c40: 2072 622e 6578 7465 6e64 2874 6429 0d0a   rb.extend(td)..
+00043c50: 2020 2020 2020 2020 3e3e 3e20 7361 6d70          >>> samp
+00043c60: 6c65 203d 2072 622e 7361 6d70 6c65 2831  le = rb.sample(1
+00043c70: 290d 0a20 2020 2020 2020 203e 3e3e 2070  )..        >>> p
+00043c80: 7269 6e74 2873 616d 706c 655b 226e 6578  rint(sample["nex
+00043c90: 7422 2c20 2272 6577 6172 6422 5d29 0d0a  t", "reward"])..
+00043ca0: 2020 2020 2020 2020 7465 6e73 6f72 285b          tensor([
+00043cb0: 5b5b 312e 5d2c 0d0a 2020 2020 2020 2020  [[1.],..        
+00043cc0: 2020 2020 2020 2020 205b 312e 5d2c 0d0a           [1.],..
+00043cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043ce0: 205b 312e 5d2c 0d0a 2020 2020 2020 2020   [1.],..        
+00043cf0: 2020 2020 2020 2020 205b 312e 5d2c 0d0a           [1.],..
+00043d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043d10: 205b 312e 5d5d 5d29 0d0a 2020 2020 2020   [1.]]])..      
+00043d20: 2020 3e3e 3e20 7072 696e 7428 7361 6d70    >>> print(samp
+00043d30: 6c65 5b22 7265 7761 7264 5f74 6f5f 676f  le["reward_to_go
+00043d40: 225d 290d 0a20 2020 2020 2020 2074 656e  "])..        ten
+00043d50: 736f 7228 5b5b 5b34 2e39 3031 305d 2c0d  sor([[[4.9010],.
+00043d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00043d70: 2020 5b33 2e39 3430 345d 2c0d 0a20 2020    [3.9404],..   
+00043d80: 2020 2020 2020 2020 2020 2020 2020 5b32                [2
+00043d90: 2e39 3730 315d 2c0d 0a20 2020 2020 2020  .9701],..       
+00043da0: 2020 2020 2020 2020 2020 5b31 2e39 3930            [1.990
+00043db0: 305d 2c0d 0a20 2020 2020 2020 2020 2020  0],..           
+00043dc0: 2020 2020 2020 5b31 2e30 3030 305d 5d5d        [1.0000]]]
+00043dd0: 290d 0a0d 0a20 2020 204f 6e65 2063 616e  )....    One can
+00043de0: 2061 6c73 6f20 7573 6520 7468 6973 2074   also use this t
+00043df0: 7261 6e73 666f 726d 2064 6972 6563 746c  ransform directl
+00043e00: 7920 7769 7468 2061 2063 6f6c 6c65 6374  y with a collect
+00043e10: 6f72 3a20 6d61 6b65 2073 7572 6520 746f  or: make sure to
+00043e20: 0d0a 2020 2020 6170 7065 6e64 2074 6865  ..    append the
+00043e30: 2060 696e 7660 206d 6574 686f 6420 6f66   `inv` method of
+00043e40: 2074 6865 2074 7261 6e73 666f 726d 2e0d   the transform..
+00043e50: 0a0d 0a20 2020 2045 7861 6d70 6c65 733a  ...    Examples:
+00043e60: 0d0a 2020 2020 2020 2020 3e3e 3e20 6672  ..        >>> fr
+00043e70: 6f6d 2074 6f72 6368 726c 2e65 6e76 732e  om torchrl.envs.
+00043e80: 7574 696c 7320 696d 706f 7274 2052 616e  utils import Ran
+00043e90: 646f 6d50 6f6c 6963 7920 2020 2020 2020  domPolicy       
+00043ea0: 203e 3e3e 2066 726f 6d20 746f 7263 6872   >>> from torchr
+00043eb0: 6c2e 636f 6c6c 6563 746f 7273 2069 6d70  l.collectors imp
+00043ec0: 6f72 7420 5379 6e63 4461 7461 436f 6c6c  ort SyncDataColl
+00043ed0: 6563 746f 720d 0a20 2020 2020 2020 203e  ector..        >
+00043ee0: 3e3e 2066 726f 6d20 746f 7263 6872 6c2e  >> from torchrl.
+00043ef0: 656e 7673 2e6c 6962 732e 6779 6d20 696d  envs.libs.gym im
+00043f00: 706f 7274 2047 796d 456e 760d 0a20 2020  port GymEnv..   
+00043f10: 2020 2020 203e 3e3e 2074 203d 2052 6577       >>> t = Rew
+00043f20: 6172 6432 476f 5472 616e 7366 6f72 6d28  ard2GoTransform(
+00043f30: 6761 6d6d 613d 302e 3939 2c20 6f75 745f  gamma=0.99, out_
+00043f40: 6b65 7973 3d5b 2272 6577 6172 645f 746f  keys=["reward_to
+00043f50: 5f67 6f22 5d29 0d0a 2020 2020 2020 2020  _go"])..        
+00043f60: 3e3e 3e20 656e 7620 3d20 4779 6d45 6e76  >>> env = GymEnv
+00043f70: 2822 5065 6e64 756c 756d 2d76 3122 290d  ("Pendulum-v1").
+00043f80: 0a20 2020 2020 2020 203e 3e3e 2063 6f6c  .        >>> col
+00043f90: 6c65 6374 6f72 203d 2053 796e 6344 6174  lector = SyncDat
+00043fa0: 6143 6f6c 6c65 6374 6f72 280d 0a20 2020  aCollector(..   
+00043fb0: 2020 2020 202e 2e2e 2020 2020 2065 6e76       ...     env
+00043fc0: 2c0d 0a20 2020 2020 2020 202e 2e2e 2020  ,..        ...  
+00043fd0: 2020 2052 616e 646f 6d50 6f6c 6963 7928     RandomPolicy(
+00043fe0: 656e 762e 6163 7469 6f6e 5f73 7065 6329  env.action_spec)
+00043ff0: 2c0d 0a20 2020 2020 2020 202e 2e2e 2020  ,..        ...  
+00044000: 2020 2066 7261 6d65 735f 7065 725f 6261     frames_per_ba
+00044010: 7463 683d 3230 302c 0d0a 2020 2020 2020  tch=200,..      
+00044020: 2020 2e2e 2e20 2020 2020 746f 7461 6c5f    ...     total_
+00044030: 6672 616d 6573 3d2d 312c 0d0a 2020 2020  frames=-1,..    
+00044040: 2020 2020 2e2e 2e20 2020 2020 706f 7374      ...     post
+00044050: 7072 6f63 3d74 2e69 6e76 0d0a 2020 2020  proc=t.inv..    
+00044060: 2020 2020 2e2e 2e20 290d 0a20 2020 2020      ... )..     
+00044070: 2020 203e 3e3e 2066 6f72 2064 6174 6120     >>> for data 
+00044080: 696e 2063 6f6c 6c65 6374 6f72 3a0d 0a20  in collector:.. 
+00044090: 2020 2020 2020 202e 2e2e 2020 2020 2062         ...     b
+000440a0: 7265 616b 0d0a 2020 2020 2020 2020 3e3e  reak..        >>
+000440b0: 3e20 7072 696e 7428 6461 7461 290d 0a20  > print(data).. 
+000440c0: 2020 2020 2020 2054 656e 736f 7244 6963         TensorDic
+000440d0: 7428 0d0a 2020 2020 2020 2020 2020 2020  t(..            
+000440e0: 6669 656c 6473 3d7b 0d0a 2020 2020 2020  fields={..      
+000440f0: 2020 2020 2020 2020 2020 6163 7469 6f6e            action
+00044100: 3a20 5465 6e73 6f72 2873 6861 7065 3d74  : Tensor(shape=t
+00044110: 6f72 6368 2e53 697a 6528 5b32 3030 2c20  orch.Size([200, 
+00044120: 315d 292c 2064 6576 6963 653d 6370 752c  1]), device=cpu,
+00044130: 2064 7479 7065 3d74 6f72 6368 2e66 6c6f   dtype=torch.flo
+00044140: 6174 3332 2c20 6973 5f73 6861 7265 643d  at32, is_shared=
+00044150: 4661 6c73 6529 2c0d 0a20 2020 2020 2020  False),..       
+00044160: 2020 2020 2020 2020 2063 6f6c 6c65 6374           collect
+00044170: 6f72 3a20 5465 6e73 6f72 4469 6374 280d  or: TensorDict(.
+00044180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00044190: 2020 2020 2066 6965 6c64 733d 7b0d 0a20       fields={.. 
+000441a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000441b0: 2020 2020 2020 2074 7261 6a5f 6964 733a         traj_ids:
+000441c0: 2054 656e 736f 7228 7368 6170 653d 746f   Tensor(shape=to
+000441d0: 7263 682e 5369 7a65 285b 3230 305d 292c  rch.Size([200]),
+000441e0: 2064 6576 6963 653d 6370 752c 2064 7479   device=cpu, dty
+000441f0: 7065 3d74 6f72 6368 2e69 6e74 3634 2c20  pe=torch.int64, 
+00044200: 6973 5f73 6861 7265 643d 4661 6c73 6529  is_shared=False)
+00044210: 7d2c 0d0a 2020 2020 2020 2020 2020 2020  },..            
+00044220: 2020 2020 2020 2020 6261 7463 685f 7369          batch_si
+00044230: 7a65 3d74 6f72 6368 2e53 697a 6528 5b32  ze=torch.Size([2
+00044240: 3030 5d29 2c0d 0a20 2020 2020 2020 2020  00]),..         
+00044250: 2020 2020 2020 2020 2020 2064 6576 6963             devic
+00044260: 653d 6370 752c 0d0a 2020 2020 2020 2020  e=cpu,..        
+00044270: 2020 2020 2020 2020 2020 2020 6973 5f73              is_s
+00044280: 6861 7265 643d 4661 6c73 6529 2c0d 0a20  hared=False),.. 
+00044290: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000442a0: 6f6e 653a 2054 656e 736f 7228 7368 6170  one: Tensor(shap
+000442b0: 653d 746f 7263 682e 5369 7a65 285b 3230  e=torch.Size([20
+000442c0: 302c 2031 5d29 2c20 6465 7669 6365 3d63  0, 1]), device=c
+000442d0: 7075 2c20 6474 7970 653d 746f 7263 682e  pu, dtype=torch.
+000442e0: 626f 6f6c 2c20 6973 5f73 6861 7265 643d  bool, is_shared=
+000442f0: 4661 6c73 6529 2c0d 0a20 2020 2020 2020  False),..       
+00044300: 2020 2020 2020 2020 206e 6578 743a 2054           next: T
+00044310: 656e 736f 7244 6963 7428 0d0a 2020 2020  ensorDict(..    
+00044320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044330: 6669 656c 6473 3d7b 0d0a 2020 2020 2020  fields={..      
+00044340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044350: 2020 646f 6e65 3a20 5465 6e73 6f72 2873    done: Tensor(s
+00044360: 6861 7065 3d74 6f72 6368 2e53 697a 6528  hape=torch.Size(
+00044370: 5b32 3030 2c20 315d 292c 2064 6576 6963  [200, 1]), devic
+00044380: 653d 6370 752c 2064 7479 7065 3d74 6f72  e=cpu, dtype=tor
+00044390: 6368 2e62 6f6f 6c2c 2069 735f 7368 6172  ch.bool, is_shar
+000443a0: 6564 3d46 616c 7365 292c 0d0a 2020 2020  ed=False),..    
+000443b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000443c0: 2020 2020 6f62 7365 7276 6174 696f 6e3a      observation:
+000443d0: 2054 656e 736f 7228 7368 6170 653d 746f   Tensor(shape=to
+000443e0: 7263 682e 5369 7a65 285b 3230 302c 2033  rch.Size([200, 3
+000443f0: 5d29 2c20 6465 7669 6365 3d63 7075 2c20  ]), device=cpu, 
+00044400: 6474 7970 653d 746f 7263 682e 666c 6f61  dtype=torch.floa
+00044410: 7433 322c 2069 735f 7368 6172 6564 3d46  t32, is_shared=F
+00044420: 616c 7365 292c 0d0a 2020 2020 2020 2020  alse),..        
+00044430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044440: 7265 7761 7264 3a20 5465 6e73 6f72 2873  reward: Tensor(s
+00044450: 6861 7065 3d74 6f72 6368 2e53 697a 6528  hape=torch.Size(
+00044460: 5b32 3030 2c20 315d 292c 2064 6576 6963  [200, 1]), devic
+00044470: 653d 6370 752c 2064 7479 7065 3d74 6f72  e=cpu, dtype=tor
+00044480: 6368 2e66 6c6f 6174 3332 2c20 6973 5f73  ch.float32, is_s
+00044490: 6861 7265 643d 4661 6c73 6529 7d2c 0d0a  hared=False)},..
+000444a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000444b0: 2020 2020 6261 7463 685f 7369 7a65 3d74      batch_size=t
+000444c0: 6f72 6368 2e53 697a 6528 5b32 3030 5d29  orch.Size([200])
+000444d0: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+000444e0: 2020 2020 2020 2064 6576 6963 653d 6370         device=cp
+000444f0: 752c 0d0a 2020 2020 2020 2020 2020 2020  u,..            
+00044500: 2020 2020 2020 2020 6973 5f73 6861 7265          is_share
+00044510: 643d 4661 6c73 6529 2c0d 0a20 2020 2020  d=False),..     
+00044520: 2020 2020 2020 2020 2020 206f 6273 6572             obser
+00044530: 7661 7469 6f6e 3a20 5465 6e73 6f72 2873  vation: Tensor(s
+00044540: 6861 7065 3d74 6f72 6368 2e53 697a 6528  hape=torch.Size(
+00044550: 5b32 3030 2c20 335d 292c 2064 6576 6963  [200, 3]), devic
+00044560: 653d 6370 752c 2064 7479 7065 3d74 6f72  e=cpu, dtype=tor
+00044570: 6368 2e66 6c6f 6174 3332 2c20 6973 5f73  ch.float32, is_s
+00044580: 6861 7265 643d 4661 6c73 6529 2c0d 0a20  hared=False),.. 
+00044590: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000445a0: 6577 6172 643a 2054 656e 736f 7228 7368  eward: Tensor(sh
+000445b0: 6170 653d 746f 7263 682e 5369 7a65 285b  ape=torch.Size([
+000445c0: 3230 302c 2031 5d29 2c20 6465 7669 6365  200, 1]), device
+000445d0: 3d63 7075 2c20 6474 7970 653d 746f 7263  =cpu, dtype=torc
+000445e0: 682e 666c 6f61 7433 322c 2069 735f 7368  h.float32, is_sh
+000445f0: 6172 6564 3d46 616c 7365 292c 0d0a 2020  ared=False),..  
+00044600: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00044610: 7761 7264 5f74 6f5f 676f 3a20 5465 6e73  ward_to_go: Tens
+00044620: 6f72 2873 6861 7065 3d74 6f72 6368 2e53  or(shape=torch.S
+00044630: 697a 6528 5b32 3030 2c20 315d 292c 2064  ize([200, 1]), d
+00044640: 6576 6963 653d 6370 752c 2064 7479 7065  evice=cpu, dtype
+00044650: 3d74 6f72 6368 2e66 6c6f 6174 3332 2c20  =torch.float32, 
+00044660: 6973 5f73 6861 7265 643d 4661 6c73 6529  is_shared=False)
+00044670: 7d2c 0d0a 2020 2020 2020 2020 2020 2020  },..            
+00044680: 6261 7463 685f 7369 7a65 3d74 6f72 6368  batch_size=torch
+00044690: 2e53 697a 6528 5b32 3030 5d29 2c0d 0a20  .Size([200]),.. 
+000446a0: 2020 2020 2020 2020 2020 2064 6576 6963             devic
+000446b0: 653d 6370 752c 0d0a 2020 2020 2020 2020  e=cpu,..        
+000446c0: 2020 2020 6973 5f73 6861 7265 643d 4661      is_shared=Fa
+000446d0: 6c73 6529 0d0a 0d0a 2020 2020 5573 696e  lse)....    Usin
+000446e0: 6720 7468 6973 2074 7261 6e73 666f 726d  g this transform
+000446f0: 2061 7320 7061 7274 206f 6620 616e 2065   as part of an e
+00044700: 6e76 2077 696c 6c20 7261 6973 6520 616e  nv will raise an
+00044710: 2065 7863 6570 7469 6f6e 0d0a 0d0a 2020   exception....  
+00044720: 2020 4578 616d 706c 6573 3a0d 0a20 2020    Examples:..   
+00044730: 2020 2020 203e 3e3e 2074 203d 2052 6577       >>> t = Rew
+00044740: 6172 6432 476f 5472 616e 7366 6f72 6d28  ard2GoTransform(
+00044750: 6761 6d6d 613d 302e 3939 290d 0a20 2020  gamma=0.99)..   
+00044760: 2020 2020 203e 3e3e 2054 7261 6e73 666f       >>> Transfo
+00044770: 726d 6564 456e 7628 4779 6d45 6e76 2822  rmedEnv(GymEnv("
+00044780: 5065 6e64 756c 756d 2d76 3122 292c 2074  Pendulum-v1"), t
+00044790: 2920 2023 2063 7261 7368 6573 0d0a 0d0a  )  # crashes....
+000447a0: 2020 2020 2e2e 206e 6f74 653a 3a20 496e      .. note:: In
+000447b0: 2073 6574 7469 6e67 7320 7768 6572 6520   settings where 
+000447c0: 6d75 6c74 6970 6c65 2064 6f6e 6520 656e  multiple done en
+000447d0: 7472 6965 7320 6172 6520 7072 6573 656e  tries are presen
+000447e0: 742c 206f 6e65 2073 686f 756c 6420 6275  t, one should bu
+000447f0: 696c 640d 0a20 2020 2020 2020 2061 2073  ild..        a s
+00044800: 696e 676c 6520 3a63 6c61 7373 3a60 7e52  ingle :class:`~R
+00044810: 6577 6172 6432 476f 5472 616e 7366 6f72  eward2GoTransfor
+00044820: 6d60 2066 6f72 2065 6163 6820 646f 6e65  m` for each done
+00044830: 2d72 6577 6172 6420 7061 6972 2e0d 0a0d  -reward pair....
+00044840: 0a20 2020 2022 2222 0d0a 0d0a 2020 2020  .    """....    
+00044850: 454e 565f 4552 5220 3d20 280d 0a20 2020  ENV_ERR = (..   
+00044860: 2020 2020 2022 5468 6520 5265 7761 7264       "The Reward
+00044870: 3247 6f54 7261 6e73 666f 726d 2069 7320  2GoTransform is 
+00044880: 6f6e 6c79 2061 6e20 696e 7665 7273 6520  only an inverse 
+00044890: 7472 616e 7366 6f72 6d20 616e 6420 6361  transform and ca
+000448a0: 6e20 220d 0a20 2020 2020 2020 2022 6f6e  n "..        "on
+000448b0: 6c79 2062 6520 6170 706c 6965 6420 746f  ly be applied to
+000448c0: 2074 6865 2072 6570 6c61 7920 6275 6666   the replay buff
+000448d0: 6572 2e22 0d0a 2020 2020 290d 0a0d 0a20  er."..    ).... 
+000448e0: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+000448f0: 0d0a 2020 2020 2020 2020 7365 6c66 2c0d  ..        self,.
+00044900: 0a20 2020 2020 2020 2067 616d 6d61 3a20  .        gamma: 
+00044910: 4f70 7469 6f6e 616c 5b55 6e69 6f6e 5b66  Optional[Union[f
+00044920: 6c6f 6174 2c20 746f 7263 682e 5465 6e73  loat, torch.Tens
+00044930: 6f72 5d5d 203d 2031 2e30 2c0d 0a20 2020  or]] = 1.0,..   
+00044940: 2020 2020 2069 6e5f 6b65 7973 3a20 5365       in_keys: Se
+00044950: 7175 656e 6365 5b4e 6573 7465 644b 6579  quence[NestedKey
+00044960: 5d20 7c20 4e6f 6e65 203d 204e 6f6e 652c  ] | None = None,
+00044970: 0d0a 2020 2020 2020 2020 6f75 745f 6b65  ..        out_ke
+00044980: 7973 3a20 5365 7175 656e 6365 5b4e 6573  ys: Sequence[Nes
+00044990: 7465 644b 6579 5d20 7c20 4e6f 6e65 203d  tedKey] | None =
+000449a0: 204e 6f6e 652c 0d0a 2020 2020 2020 2020   None,..        
+000449b0: 646f 6e65 5f6b 6579 3a20 4f70 7469 6f6e  done_key: Option
+000449c0: 616c 5b4e 6573 7465 644b 6579 5d20 3d20  al[NestedKey] = 
+000449d0: 2264 6f6e 6522 2c0d 0a20 2020 2029 3a0d  "done",..    ):.
+000449e0: 0a20 2020 2020 2020 2069 6620 696e 5f6b  .        if in_k
+000449f0: 6579 7320 6973 204e 6f6e 653a 0d0a 2020  eys is None:..  
+00044a00: 2020 2020 2020 2020 2020 696e 5f6b 6579            in_key
+00044a10: 7320 3d20 5b28 226e 6578 7422 2c20 2272  s = [("next", "r
+00044a20: 6577 6172 6422 295d 0d0a 2020 2020 2020  eward")]..      
+00044a30: 2020 6966 206f 7574 5f6b 6579 7320 6973    if out_keys is
+00044a40: 204e 6f6e 653a 0d0a 2020 2020 2020 2020   None:..        
+00044a50: 2020 2020 6f75 745f 6b65 7973 203d 2063      out_keys = c
+00044a60: 6f70 7928 696e 5f6b 6579 7329 0d0a 2020  opy(in_keys)..  
+00044a70: 2020 2020 2020 2320 6f75 745f 6b65 7973        # out_keys
+00044a80: 203d 205b 2272 6577 6172 645f 746f 5f67   = ["reward_to_g
+00044a90: 6f22 5d0d 0a20 2020 2020 2020 2073 7570  o"]..        sup
+00044aa0: 6572 2829 2e5f 5f69 6e69 745f 5f28 0d0a  er().__init__(..
+00044ab0: 2020 2020 2020 2020 2020 2020 696e 5f6b              in_k
+00044ac0: 6579 733d 696e 5f6b 6579 732c 0d0a 2020  eys=in_keys,..  
+00044ad0: 2020 2020 2020 2020 2020 696e 5f6b 6579            in_key
+00044ae0: 735f 696e 763d 696e 5f6b 6579 732c 0d0a  s_inv=in_keys,..
+00044af0: 2020 2020 2020 2020 2020 2020 6f75 745f              out_
+00044b00: 6b65 7973 5f69 6e76 3d6f 7574 5f6b 6579  keys_inv=out_key
+00044b10: 732c 0d0a 2020 2020 2020 2020 290d 0a20  s,..        ).. 
+00044b20: 2020 2020 2020 2073 656c 662e 646f 6e65         self.done
+00044b30: 5f6b 6579 203d 2064 6f6e 655f 6b65 790d  _key = done_key.
+00044b40: 0a0d 0a20 2020 2020 2020 2069 6620 6e6f  ...        if no
+00044b50: 7420 6973 696e 7374 616e 6365 2867 616d  t isinstance(gam
+00044b60: 6d61 2c20 746f 7263 682e 5465 6e73 6f72  ma, torch.Tensor
+00044b70: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
+00044b80: 6761 6d6d 6120 3d20 746f 7263 682e 7465  gamma = torch.te
+00044b90: 6e73 6f72 2867 616d 6d61 290d 0a0d 0a20  nsor(gamma).... 
+00044ba0: 2020 2020 2020 2073 656c 662e 7265 6769         self.regi
+00044bb0: 7374 6572 5f62 7566 6665 7228 2267 616d  ster_buffer("gam
+00044bc0: 6d61 222c 2067 616d 6d61 290d 0a0d 0a20  ma", gamma).... 
+00044bd0: 2020 2064 6566 205f 696e 765f 6361 6c6c     def _inv_call
+00044be0: 2873 656c 662c 2074 656e 736f 7264 6963  (self, tensordic
+00044bf0: 743a 2054 656e 736f 7244 6963 7442 6173  t: TensorDictBas
+00044c00: 6529 202d 3e20 5465 6e73 6f72 4469 6374  e) -> TensorDict
+00044c10: 4261 7365 3a0d 0a20 2020 2020 2020 2069  Base:..        i
+00044c20: 6620 7365 6c66 2e70 6172 656e 7420 6973  f self.parent is
+00044c30: 206e 6f74 204e 6f6e 653a 0d0a 2020 2020   not None:..    
+00044c40: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+00044c50: 6c75 6545 7272 6f72 2873 656c 662e 454e  lueError(self.EN
+00044c60: 565f 4552 5229 0d0a 2020 2020 2020 2020  V_ERR)..        
+00044c70: 646f 6e65 203d 2074 656e 736f 7264 6963  done = tensordic
+00044c80: 742e 6765 7428 2822 6e65 7874 222c 2073  t.get(("next", s
+00044c90: 656c 662e 646f 6e65 5f6b 6579 2929 0d0a  elf.done_key))..
+00044ca0: 0d0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+00044cb0: 2064 6f6e 652e 616e 7928 2d32 292e 616c   done.any(-2).al
+00044cc0: 6c28 293a 0d0a 2020 2020 2020 2020 2020  l():..          
+00044cd0: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
+00044ce0: 7272 6f72 280d 0a20 2020 2020 2020 2020  rror(..         
+00044cf0: 2020 2020 2020 2022 4e6f 2065 7069 736f         "No episo
+00044d00: 6465 2065 6e64 7320 666f 756e 6420 746f  de ends found to
+00044d10: 2063 616c 6375 6c61 7465 2074 6865 2072   calculate the r
+00044d20: 6577 6172 6420 746f 2067 6f2e 204d 616b  eward to go. Mak
+00044d30: 6520 7375 7265 2074 6861 7420 7468 6520  e sure that the 
+00044d40: 6e75 6d62 6572 206f 6620 6672 616d 6573  number of frames
+00044d50: 5f70 6572 5f62 6174 6368 2069 7320 6c61  _per_batch is la
+00044d60: 7267 6572 2074 6861 6e20 6e75 6d62 6572  rger than number
+00044d70: 206f 6620 7374 6570 7320 7065 7220 6570   of steps per ep
+00044d80: 6973 6f64 652e 220d 0a20 2020 2020 2020  isode."..       
+00044d90: 2020 2020 2029 0d0a 2020 2020 2020 2020       )..        
+00044da0: 666f 756e 6420 3d20 4661 6c73 650d 0a20  found = False.. 
+00044db0: 2020 2020 2020 2066 6f72 2069 6e5f 6b65         for in_ke
+00044dc0: 792c 206f 7574 5f6b 6579 2069 6e20 7a69  y, out_key in zi
+00044dd0: 7028 7365 6c66 2e69 6e5f 6b65 7973 5f69  p(self.in_keys_i
+00044de0: 6e76 2c20 7365 6c66 2e6f 7574 5f6b 6579  nv, self.out_key
+00044df0: 735f 696e 7629 3a0d 0a20 2020 2020 2020  s_inv):..       
+00044e00: 2020 2020 2069 6620 696e 5f6b 6579 2069       if in_key i
+00044e10: 6e20 7465 6e73 6f72 6469 6374 2e6b 6579  n tensordict.key
+00044e20: 7328 696e 636c 7564 655f 6e65 7374 6564  s(include_nested
+00044e30: 3d54 7275 6529 3a0d 0a20 2020 2020 2020  =True):..       
+00044e40: 2020 2020 2020 2020 2066 6f75 6e64 203d           found =
+00044e50: 2054 7275 650d 0a20 2020 2020 2020 2020   True..         
+00044e60: 2020 2020 2020 2069 7465 6d20 3d20 7365         item = se
+00044e70: 6c66 2e5f 696e 765f 6170 706c 795f 7472  lf._inv_apply_tr
+00044e80: 616e 7366 6f72 6d28 7465 6e73 6f72 6469  ansform(tensordi
+00044e90: 6374 2e67 6574 2869 6e5f 6b65 7929 2c20  ct.get(in_key), 
+00044ea0: 646f 6e65 290d 0a20 2020 2020 2020 2020  done)..         
+00044eb0: 2020 2020 2020 2074 656e 736f 7264 6963         tensordic
+00044ec0: 742e 7365 7428 6f75 745f 6b65 792c 2069  t.set(out_key, i
+00044ed0: 7465 6d29 0d0a 2020 2020 2020 2020 6966  tem)..        if
+00044ee0: 206e 6f74 2066 6f75 6e64 3a0d 0a20 2020   not found:..   
+00044ef0: 2020 2020 2020 2020 2072 6169 7365 204b           raise K
+00044f00: 6579 4572 726f 7228 6622 436f 756c 6420  eyError(f"Could 
+00044f10: 6e6f 7420 6669 6e64 2061 6e79 206f 6620  not find any of 
+00044f20: 7468 6520 696e 7075 7420 6b65 7973 207b  the input keys {
+00044f30: 7365 6c66 2e69 6e5f 6b65 7973 7d2e 2229  self.in_keys}.")
+00044f40: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00044f50: 2074 656e 736f 7264 6963 740d 0a0d 0a20   tensordict.... 
+00044f60: 2020 2064 6566 2066 6f72 7761 7264 2873     def forward(s
+00044f70: 656c 662c 2074 656e 736f 7264 6963 743a  elf, tensordict:
+00044f80: 2054 656e 736f 7244 6963 7442 6173 6529   TensorDictBase)
+00044f90: 202d 3e20 5465 6e73 6f72 4469 6374 4261   -> TensorDictBa
+00044fa0: 7365 3a0d 0a20 2020 2020 2020 2072 6574  se:..        ret
+00044fb0: 7572 6e20 7465 6e73 6f72 6469 6374 0d0a  urn tensordict..
+00044fc0: 0d0a 2020 2020 6465 6620 5f63 616c 6c28  ..    def _call(
+00044fd0: 7365 6c66 2c20 7465 6e73 6f72 6469 6374  self, tensordict
+00044fe0: 3a20 5465 6e73 6f72 4469 6374 4261 7365  : TensorDictBase
+00044ff0: 2920 2d3e 2054 656e 736f 7244 6963 7442  ) -> TensorDictB
+00045000: 6173 653a 0d0a 2020 2020 2020 2020 7261  ase:..        ra
+00045010: 6973 6520 5661 6c75 6545 7272 6f72 2873  ise ValueError(s
+00045020: 656c 662e 454e 565f 4552 5229 0d0a 0d0a  elf.ENV_ERR)....
+00045030: 2020 2020 6465 6620 5f69 6e76 5f61 7070      def _inv_app
+00045040: 6c79 5f74 7261 6e73 666f 726d 280d 0a20  ly_transform(.. 
+00045050: 2020 2020 2020 2073 656c 662c 2072 6577         self, rew
+00045060: 6172 643a 2074 6f72 6368 2e54 656e 736f  ard: torch.Tenso
+00045070: 722c 2064 6f6e 653a 2074 6f72 6368 2e54  r, done: torch.T
+00045080: 656e 736f 720d 0a20 2020 2029 202d 3e20  ensor..    ) -> 
+00045090: 746f 7263 682e 5465 6e73 6f72 3a0d 0a20  torch.Tensor:.. 
+000450a0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+000450b0: 7761 7264 3267 6f28 7265 7761 7264 2c20  ward2go(reward, 
+000450c0: 646f 6e65 2c20 7365 6c66 2e67 616d 6d61  done, self.gamma
+000450d0: 290d 0a0d 0a20 2020 2064 6566 2073 6574  )....    def set
+000450e0: 5f63 6f6e 7461 696e 6572 2873 656c 662c  _container(self,
+000450f0: 2063 6f6e 7461 696e 6572 293a 0d0a 2020   container):..  
+00045100: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00045110: 6e63 6528 636f 6e74 6169 6e65 722c 2045  nce(container, E
+00045120: 6e76 4261 7365 2920 6f72 2063 6f6e 7461  nvBase) or conta
+00045130: 696e 6572 2e70 6172 656e 7420 6973 206e  iner.parent is n
+00045140: 6f74 204e 6f6e 653a 0d0a 2020 2020 2020  ot None:..      
+00045150: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+00045160: 6545 7272 6f72 2873 656c 662e 454e 565f  eError(self.ENV_
+00045170: 4552 5229 0d0a 0d0a 0d0a 636c 6173 7320  ERR)......class 
+00045180: 4163 7469 6f6e 4d61 736b 2854 7261 6e73  ActionMask(Trans
+00045190: 666f 726d 293a 0d0a 2020 2020 2222 2241  form):..    """A
+000451a0: 6e20 6164 6170 7469 7665 2061 6374 696f  n adaptive actio
+000451b0: 6e20 6d61 736b 6572 2e0d 0a0d 0a20 2020  n masker.....   
+000451c0: 2054 6869 7320 7472 616e 7366 6f72 6d20   This transform 
+000451d0: 7265 6164 7320 7468 6520 6d61 736b 2066  reads the mask f
+000451e0: 726f 6d20 7468 6520 696e 7075 7420 7465  rom the input te
+000451f0: 6e73 6f72 6469 6374 2061 6674 6572 2074  nsordict after t
+00045200: 6865 2073 7465 7020 6973 2065 7865 6375  he step is execu
+00045210: 7465 642c 0d0a 2020 2020 616e 6420 6164  ted,..    and ad
+00045220: 6170 7473 2074 6865 206d 6173 6b20 6f66  apts the mask of
+00045230: 2074 6865 206f 6e65 2d68 6f74 202f 2063   the one-hot / c
+00045240: 6174 6567 6f72 6963 616c 2061 6374 696f  ategorical actio
+00045250: 6e20 7370 6563 2e0d 0a0d 0a20 2020 2020  n spec.....     
+00045260: 202e 2e20 6e6f 7465 3a3a 2054 6869 7320   .. note:: This 
+00045270: 7472 616e 7366 6f72 6d20 7769 6c6c 2066  transform will f
+00045280: 6169 6c20 7768 656e 2075 7365 6420 7769  ail when used wi
+00045290: 7468 6f75 7420 616e 2065 6e76 6972 6f6e  thout an environ
+000452a0: 6d65 6e74 2e0d 0a0d 0a20 2020 2041 7267  ment.....    Arg
+000452b0: 733a 0d0a 2020 2020 2020 2020 6163 7469  s:..        acti
+000452c0: 6f6e 5f6b 6579 2028 4e65 7374 6564 4b65  on_key (NestedKe
+000452d0: 792c 206f 7074 696f 6e61 6c29 3a20 7468  y, optional): th
+000452e0: 6520 6b65 7920 7768 6572 6520 7468 6520  e key where the 
+000452f0: 6163 7469 6f6e 2074 656e 736f 7220 6361  action tensor ca
+00045300: 6e20 6265 2066 6f75 6e64 2e0d 0a20 2020  n be found...   
+00045310: 2020 2020 2020 2020 2044 6566 6175 6c74           Default
+00045320: 7320 746f 2060 6022 6163 7469 6f6e 2260  s to ``"action"`
+00045330: 602e 0d0a 2020 2020 2020 2020 6d61 736b  `...        mask
+00045340: 5f6b 6579 2028 4e65 7374 6564 4b65 792c  _key (NestedKey,
+00045350: 206f 7074 696f 6e61 6c29 3a20 7468 6520   optional): the 
+00045360: 6b65 7920 7768 6572 6520 7468 6520 6163  key where the ac
+00045370: 7469 6f6e 206d 6173 6b20 6361 6e20 6265  tion mask can be
+00045380: 2066 6f75 6e64 2e0d 0a20 2020 2020 2020   found...       
+00045390: 2020 2020 2044 6566 6175 6c74 7320 746f       Defaults to
+000453a0: 2060 6022 6163 7469 6f6e 5f6d 6173 6b22   ``"action_mask"
+000453b0: 6060 2e0d 0a0d 0a20 2020 2045 7861 6d70  ``.....    Examp
+000453c0: 6c65 733a 0d0a 2020 2020 2020 2020 3e3e  les:..        >>
+000453d0: 3e20 696d 706f 7274 2074 6f72 6368 0d0a  > import torch..
+000453e0: 2020 2020 2020 2020 3e3e 3e20 6672 6f6d          >>> from
+000453f0: 2074 6f72 6368 726c 2e64 6174 612e 7465   torchrl.data.te
+00045400: 6e73 6f72 5f73 7065 6373 2069 6d70 6f72  nsor_specs impor
+00045410: 7420 4469 7363 7265 7465 5465 6e73 6f72  t DiscreteTensor
+00045420: 5370 6563 2c20 4269 6e61 7279 4469 7363  Spec, BinaryDisc
+00045430: 7265 7465 5465 6e73 6f72 5370 6563 2c20  reteTensorSpec, 
+00045440: 556e 626f 756e 6465 6443 6f6e 7469 6e75  UnboundedContinu
+00045450: 6f75 7354 656e 736f 7253 7065 632c 2043  ousTensorSpec, C
+00045460: 6f6d 706f 7369 7465 5370 6563 0d0a 2020  ompositeSpec..  
+00045470: 2020 2020 2020 3e3e 3e20 6672 6f6d 2074        >>> from t
+00045480: 6f72 6368 726c 2e65 6e76 732e 7472 616e  orchrl.envs.tran
+00045490: 7366 6f72 6d73 2069 6d70 6f72 7420 4163  sforms import Ac
+000454a0: 7469 6f6e 4d61 736b 2c20 5472 616e 7366  tionMask, Transf
+000454b0: 6f72 6d65 6445 6e76 0d0a 2020 2020 2020  ormedEnv..      
+000454c0: 2020 3e3e 3e20 6672 6f6d 2074 6f72 6368    >>> from torch
+000454d0: 726c 2e65 6e76 732e 636f 6d6d 6f6e 2069  rl.envs.common i
+000454e0: 6d70 6f72 7420 456e 7642 6173 650d 0a20  mport EnvBase.. 
+000454f0: 2020 2020 2020 203e 3e3e 2063 6c61 7373         >>> class
+00045500: 204d 6173 6b65 6445 6e76 2845 6e76 4261   MaskedEnv(EnvBa
+00045510: 7365 293a 0d0a 2020 2020 2020 2020 2e2e  se):..        ..
+00045520: 2e20 2020 2020 6465 6620 5f5f 696e 6974  .     def __init
+00045530: 5f5f 2873 656c 662c 202a 6172 6773 2c20  __(self, *args, 
+00045540: 2a2a 6b77 6172 6773 293a 0d0a 2020 2020  **kwargs):..    
+00045550: 2020 2020 2e2e 2e20 2020 2020 2020 2020      ...         
+00045560: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
+00045570: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
+00045580: 290d 0a20 2020 2020 2020 202e 2e2e 2020  )..        ...  
+00045590: 2020 2020 2020 2073 656c 662e 6163 7469         self.acti
+000455a0: 6f6e 5f73 7065 6320 3d20 4469 7363 7265  on_spec = Discre
+000455b0: 7465 5465 6e73 6f72 5370 6563 2834 290d  teTensorSpec(4).
+000455c0: 0a20 2020 2020 2020 202e 2e2e 2020 2020  .        ...    
+000455d0: 2020 2020 2073 656c 662e 7374 6174 655f       self.state_
+000455e0: 7370 6563 203d 2043 6f6d 706f 7369 7465  spec = Composite
+000455f0: 5370 6563 2861 6374 696f 6e5f 6d61 736b  Spec(action_mask
+00045600: 3d42 696e 6172 7944 6973 6372 6574 6554  =BinaryDiscreteT
+00045610: 656e 736f 7253 7065 6328 342c 2064 7479  ensorSpec(4, dty
+00045620: 7065 3d74 6f72 6368 2e62 6f6f 6c29 290d  pe=torch.bool)).
+00045630: 0a20 2020 2020 2020 202e 2e2e 2020 2020  .        ...    
+00045640: 2020 2020 2073 656c 662e 6f62 7365 7276       self.observ
+00045650: 6174 696f 6e5f 7370 6563 203d 2043 6f6d  ation_spec = Com
+00045660: 706f 7369 7465 5370 6563 286f 6273 3d55  positeSpec(obs=U
+00045670: 6e62 6f75 6e64 6564 436f 6e74 696e 756f  nboundedContinuo
+00045680: 7573 5465 6e73 6f72 5370 6563 2833 2929  usTensorSpec(3))
+00045690: 0d0a 2020 2020 2020 2020 2e2e 2e20 2020  ..        ...   
+000456a0: 2020 2020 2020 7365 6c66 2e72 6577 6172        self.rewar
+000456b0: 645f 7370 6563 203d 2055 6e62 6f75 6e64  d_spec = Unbound
+000456c0: 6564 436f 6e74 696e 756f 7573 5465 6e73  edContinuousTens
+000456d0: 6f72 5370 6563 2831 290d 0a20 2020 2020  orSpec(1)..     
+000456e0: 2020 202e 2e2e 0d0a 2020 2020 2020 2020     .....        
+000456f0: 2e2e 2e20 2020 2020 6465 6620 5f72 6573  ...     def _res
+00045700: 6574 2873 656c 662c 2074 656e 736f 7264  et(self, tensord
+00045710: 6963 743d 4e6f 6e65 293a 0d0a 2020 2020  ict=None):..    
+00045720: 2020 2020 2e2e 2e20 2020 2020 2020 2020      ...         
+00045730: 7464 203d 2073 656c 662e 6f62 7365 7276  td = self.observ
+00045740: 6174 696f 6e5f 7370 6563 2e72 616e 6428  ation_spec.rand(
+00045750: 290d 0a20 2020 2020 2020 202e 2e2e 2020  )..        ...  
+00045760: 2020 2020 2020 2074 642e 7570 6461 7465         td.update
+00045770: 2874 6f72 6368 2e6f 6e65 735f 6c69 6b65  (torch.ones_like
+00045780: 2873 656c 662e 7374 6174 655f 7370 6563  (self.state_spec
+00045790: 2e72 616e 6428 2929 290d 0a20 2020 2020  .rand()))..     
+000457a0: 2020 202e 2e2e 2020 2020 2020 2020 2072     ...         r
+000457b0: 6574 7572 6e20 7464 0d0a 2020 2020 2020  eturn td..      
+000457c0: 2020 2e2e 2e0d 0a20 2020 2020 2020 202e    .....        .
+000457d0: 2e2e 2020 2020 2064 6566 205f 7374 6570  ..     def _step
+000457e0: 2873 656c 662c 2064 6174 6129 3a0d 0a20  (self, data):.. 
+000457f0: 2020 2020 2020 202e 2e2e 2020 2020 2020         ...      
+00045800: 2020 2074 6420 3d20 7365 6c66 2e6f 6273     td = self.obs
+00045810: 6572 7661 7469 6f6e 5f73 7065 632e 7261  ervation_spec.ra
+00045820: 6e64 2829 0d0a 2020 2020 2020 2020 2e2e  nd()..        ..
+00045830: 2e20 2020 2020 2020 2020 6d61 736b 203d  .         mask =
+00045840: 2064 6174 612e 6765 7428 2261 6374 696f   data.get("actio
+00045850: 6e5f 6d61 736b 2229 0d0a 2020 2020 2020  n_mask")..      
+00045860: 2020 2e2e 2e20 2020 2020 2020 2020 6163    ...         ac
+00045870: 7469 6f6e 203d 2064 6174 612e 6765 7428  tion = data.get(
+00045880: 2261 6374 696f 6e22 290d 0a20 2020 2020  "action")..     
+00045890: 2020 202e 2e2e 2020 2020 2020 2020 206d     ...         m
+000458a0: 6173 6b20 3d20 6d61 736b 2e73 6361 7474  ask = mask.scatt
+000458b0: 6572 282d 312c 2061 6374 696f 6e2e 756e  er(-1, action.un
+000458c0: 7371 7565 657a 6528 2d31 292c 2030 290d  squeeze(-1), 0).
+000458d0: 0a20 2020 2020 2020 202e 2e2e 0d0a 2020  .        .....  
+000458e0: 2020 2020 2020 2e2e 2e20 2020 2020 2020        ...       
+000458f0: 2020 7464 2e73 6574 2822 6163 7469 6f6e    td.set("action
+00045900: 5f6d 6173 6b22 2c20 6d61 736b 290d 0a20  _mask", mask).. 
+00045910: 2020 2020 2020 202e 2e2e 2020 2020 2020         ...      
+00045920: 2020 2074 642e 7365 7428 2272 6577 6172     td.set("rewar
+00045930: 6422 2c20 7365 6c66 2e72 6577 6172 645f  d", self.reward_
+00045940: 7370 6563 2e72 616e 6428 2929 0d0a 2020  spec.rand())..  
+00045950: 2020 2020 2020 2e2e 2e20 2020 2020 2020        ...       
+00045960: 2020 7464 2e73 6574 2822 646f 6e65 222c    td.set("done",
+00045970: 207e 6d61 736b 2e61 6e79 2829 2e76 6965   ~mask.any().vie
+00045980: 7728 3129 290d 0a20 2020 2020 2020 202e  w(1))..        .
+00045990: 2e2e 2020 2020 2020 2020 2072 6574 7572  ..         retur
+000459a0: 6e20 7464 0d0a 2020 2020 2020 2020 2e2e  n td..        ..
+000459b0: 2e0d 0a20 2020 2020 2020 202e 2e2e 2020  ...        ...  
+000459c0: 2020 2064 6566 205f 7365 745f 7365 6564     def _set_seed
+000459d0: 2873 656c 662c 2073 6565 6429 3a0d 0a20  (self, seed):.. 
+000459e0: 2020 2020 2020 202e 2e2e 2020 2020 2020         ...      
+000459f0: 2020 2072 6574 7572 6e20 7365 6564 0d0a     return seed..
+00045a00: 2020 2020 2020 2020 2e2e 2e0d 0a20 2020          .....   
+00045a10: 2020 2020 203e 3e3e 2074 6f72 6368 2e6d       >>> torch.m
+00045a20: 616e 7561 6c5f 7365 6564 2830 290d 0a20  anual_seed(0).. 
+00045a30: 2020 2020 2020 203e 3e3e 2062 6173 655f         >>> base_
+00045a40: 656e 7620 3d20 4d61 736b 6564 456e 7628  env = MaskedEnv(
+00045a50: 290d 0a20 2020 2020 2020 203e 3e3e 2065  )..        >>> e
+00045a60: 6e76 203d 2054 7261 6e73 666f 726d 6564  nv = Transformed
+00045a70: 456e 7628 6261 7365 5f65 6e76 2c20 4163  Env(base_env, Ac
+00045a80: 7469 6f6e 4d61 736b 2829 290d 0a20 2020  tionMask())..   
+00045a90: 2020 2020 203e 3e3e 2072 203d 2065 6e76       >>> r = env
+00045aa0: 2e72 6f6c 6c6f 7574 2831 3029 0d0a 2020  .rollout(10)..  
+00045ab0: 2020 2020 2020 3e3e 3e20 656e 7620 3d20        >>> env = 
+00045ac0: 5472 616e 7366 6f72 6d65 6445 6e76 2862  TransformedEnv(b
+00045ad0: 6173 655f 656e 762c 2041 6374 696f 6e4d  ase_env, ActionM
+00045ae0: 6173 6b28 2929 0d0a 2020 2020 2020 2020  ask())..        
+00045af0: 3e3e 3e20 7220 3d20 656e 762e 726f 6c6c  >>> r = env.roll
+00045b00: 6f75 7428 3130 290d 0a20 2020 2020 2020  out(10)..       
+00045b10: 203e 3e3e 2072 5b22 6163 7469 6f6e 5f6d   >>> r["action_m
+00045b20: 6173 6b22 5d0d 0a20 2020 2020 2020 2074  ask"]..        t
+00045b30: 656e 736f 7228 5b5b 2054 7275 652c 2020  ensor([[ True,  
+00045b40: 5472 7565 2c20 2054 7275 652c 2020 5472  True,  True,  Tr
+00045b50: 7565 5d2c 0d0a 2020 2020 2020 2020 2020  ue],..          
+00045b60: 2020 2020 2020 5b20 5472 7565 2c20 2054        [ True,  T
+00045b70: 7275 652c 2046 616c 7365 2c20 2054 7275  rue, False,  Tru
+00045b80: 655d 2c0d 0a20 2020 2020 2020 2020 2020  e],..           
+00045b90: 2020 2020 205b 2054 7275 652c 2020 5472       [ True,  Tr
+00045ba0: 7565 2c20 4661 6c73 652c 2046 616c 7365  ue, False, False
+00045bb0: 5d2c 0d0a 2020 2020 2020 2020 2020 2020  ],..            
+00045bc0: 2020 2020 5b20 5472 7565 2c20 4661 6c73      [ True, Fals
+00045bd0: 652c 2046 616c 7365 2c20 4661 6c73 655d  e, False, False]
+00045be0: 5d29 0d0a 0d0a 2020 2020 2222 220d 0a0d  ])....    """...
+00045bf0: 0a20 2020 2041 4343 4550 5445 445f 5350  .    ACCEPTED_SP
+00045c00: 4543 5320 3d20 280d 0a20 2020 2020 2020  ECS = (..       
+00045c10: 204f 6e65 486f 7444 6973 6372 6574 6554   OneHotDiscreteT
+00045c20: 656e 736f 7253 7065 632c 0d0a 2020 2020  ensorSpec,..    
+00045c30: 2020 2020 4469 7363 7265 7465 5465 6e73      DiscreteTens
+00045c40: 6f72 5370 6563 2c0d 0a20 2020 2020 2020  orSpec,..       
+00045c50: 204d 756c 7469 4f6e 6548 6f74 4469 7363   MultiOneHotDisc
+00045c60: 7265 7465 5465 6e73 6f72 5370 6563 2c0d  reteTensorSpec,.
+00045c70: 0a20 2020 2020 2020 204d 756c 7469 4469  .        MultiDi
+00045c80: 7363 7265 7465 5465 6e73 6f72 5370 6563  screteTensorSpec
+00045c90: 2c0d 0a20 2020 2029 0d0a 2020 2020 5350  ,..    )..    SP
+00045ca0: 4543 5f54 5950 455f 4552 524f 5220 3d20  EC_TYPE_ERROR = 
+00045cb0: 2254 6865 2061 6374 696f 6e20 7370 6563  "The action spec
+00045cc0: 206d 7573 7420 6265 206f 6e65 206f 6620   must be one of 
+00045cd0: 7b7d 2e20 476f 7420 7b7d 2069 6e73 7465  {}. Got {} inste
+00045ce0: 6164 2e22 0d0a 0d0a 2020 2020 6465 6620  ad."....    def 
+00045cf0: 5f5f 696e 6974 5f5f 280d 0a20 2020 2020  __init__(..     
+00045d00: 2020 2073 656c 662c 2061 6374 696f 6e5f     self, action_
+00045d10: 6b65 793a 204e 6573 7465 644b 6579 203d  key: NestedKey =
+00045d20: 2022 6163 7469 6f6e 222c 206d 6173 6b5f   "action", mask_
+00045d30: 6b65 793a 204e 6573 7465 644b 6579 203d  key: NestedKey =
+00045d40: 2022 6163 7469 6f6e 5f6d 6173 6b22 0d0a   "action_mask"..
+00045d50: 2020 2020 293a 0d0a 2020 2020 2020 2020      ):..        
+00045d60: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
+00045d70: 6528 6163 7469 6f6e 5f6b 6579 2c20 2874  e(action_key, (t
+00045d80: 7570 6c65 2c20 7374 7229 293a 0d0a 2020  uple, str)):..  
+00045d90: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00045da0: 5661 6c75 6545 7272 6f72 280d 0a20 2020  ValueError(..   
+00045db0: 2020 2020 2020 2020 2020 2020 2066 2254               f"T
+00045dc0: 6865 2061 6374 696f 6e20 6b65 7920 6d75  he action key mu
+00045dd0: 7374 2062 6520 6120 6e65 7374 6564 206b  st be a nested k
+00045de0: 6579 2e20 476f 7420 7b74 7970 6528 6163  ey. Got {type(ac
+00045df0: 7469 6f6e 5f6b 6579 297d 2069 6e73 7465  tion_key)} inste
+00045e00: 6164 2e22 0d0a 2020 2020 2020 2020 2020  ad."..          
+00045e10: 2020 290d 0a20 2020 2020 2020 2069 6620    )..        if 
+00045e20: 6e6f 7420 6973 696e 7374 616e 6365 286d  not isinstance(m
+00045e30: 6173 6b5f 6b65 792c 2028 7475 706c 652c  ask_key, (tuple,
+00045e40: 2073 7472 2929 3a0d 0a20 2020 2020 2020   str)):..       
+00045e50: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00045e60: 4572 726f 7228 0d0a 2020 2020 2020 2020  Error(..        
+00045e70: 2020 2020 2020 2020 6622 5468 6520 6d61          f"The ma
+00045e80: 736b 206b 6579 206d 7573 7420 6265 2061  sk key must be a
+00045e90: 206e 6573 7465 6420 6b65 792e 2047 6f74   nested key. Got
+00045ea0: 207b 7479 7065 286d 6173 6b5f 6b65 7929   {type(mask_key)
+00045eb0: 7d20 696e 7374 6561 642e 220d 0a20 2020  } instead."..   
+00045ec0: 2020 2020 2020 2020 2029 0d0a 2020 2020           )..    
+00045ed0: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
+00045ee0: 6974 5f5f 280d 0a20 2020 2020 2020 2020  it__(..         
+00045ef0: 2020 2069 6e5f 6b65 7973 3d5b 6163 7469     in_keys=[acti
+00045f00: 6f6e 5f6b 6579 2c20 6d61 736b 5f6b 6579  on_key, mask_key
+00045f10: 5d2c 206f 7574 5f6b 6579 733d 5b5d 2c20  ], out_keys=[], 
+00045f20: 696e 5f6b 6579 735f 696e 763d 5b5d 2c20  in_keys_inv=[], 
+00045f30: 6f75 745f 6b65 7973 5f69 6e76 3d5b 5d0d  out_keys_inv=[].
+00045f40: 0a20 2020 2020 2020 2029 0d0a 0d0a 2020  .        )....  
+00045f50: 2020 6465 6620 666f 7277 6172 6428 7365    def forward(se
+00045f60: 6c66 2c20 7465 6e73 6f72 6469 6374 3a20  lf, tensordict: 
+00045f70: 5465 6e73 6f72 4469 6374 4261 7365 2920  TensorDictBase) 
+00045f80: 2d3e 2054 656e 736f 7244 6963 7442 6173  -> TensorDictBas
+00045f90: 653a 0d0a 2020 2020 2020 2020 7261 6973  e:..        rais
+00045fa0: 6520 5275 6e74 696d 6545 7272 6f72 2846  e RuntimeError(F
+00045fb0: 4f52 5741 5244 5f4e 4f54 5f49 4d50 4c45  ORWARD_NOT_IMPLE
+00045fc0: 4d45 4e54 4544 2e66 6f72 6d61 7428 7479  MENTED.format(ty
+00045fd0: 7065 2873 656c 6629 2929 0d0a 0d0a 2020  pe(self)))....  
+00045fe0: 2020 6465 6620 5f63 616c 6c28 7365 6c66    def _call(self
+00045ff0: 2c20 7465 6e73 6f72 6469 6374 3a20 5465  , tensordict: Te
+00046000: 6e73 6f72 4469 6374 4261 7365 2920 2d3e  nsorDictBase) ->
+00046010: 2054 656e 736f 7244 6963 7442 6173 653a   TensorDictBase:
+00046020: 0d0a 2020 2020 2020 2020 7061 7265 6e74  ..        parent
+00046030: 203d 2073 656c 662e 7061 7265 6e74 0d0a   = self.parent..
+00046040: 2020 2020 2020 2020 6966 2070 6172 656e          if paren
+00046050: 7420 6973 204e 6f6e 653a 0d0a 2020 2020  t is None:..    
+00046060: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
+00046070: 6e74 696d 6545 7272 6f72 280d 0a20 2020  ntimeError(..   
+00046080: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
+00046090: 7479 7065 2873 656c 6629 7d2e 7061 7265  type(self)}.pare
+000460a0: 6e74 2063 616e 6e6f 7420 6265 204e 6f6e  nt cannot be Non
+000460b0: 653a 206d 616b 6520 7375 7265 2074 6869  e: make sure thi
+000460c0: 7320 7472 616e 7366 6f72 6d20 6973 2065  s transform is e
+000460d0: 7865 6375 7465 6420 7769 7468 696e 2061  xecuted within a
+000460e0: 6e20 656e 7669 726f 6e6d 656e 742e 220d  n environment.".
+000460f0: 0a20 2020 2020 2020 2020 2020 2029 0d0a  .            )..
+00046100: 2020 2020 2020 2020 6d61 736b 203d 2074          mask = t
+00046110: 656e 736f 7264 6963 742e 6765 7428 7365  ensordict.get(se
+00046120: 6c66 2e69 6e5f 6b65 7973 5b31 5d29 0d0a  lf.in_keys[1])..
+00046130: 2020 2020 2020 2020 6163 7469 6f6e 5f73          action_s
+00046140: 7065 6320 3d20 7365 6c66 2e63 6f6e 7461  pec = self.conta
+00046150: 696e 6572 2e61 6374 696f 6e5f 7370 6563  iner.action_spec
+00046160: 0d0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+00046170: 2069 7369 6e73 7461 6e63 6528 6163 7469   isinstance(acti
+00046180: 6f6e 5f73 7065 632c 2073 656c 662e 4143  on_spec, self.AC
+00046190: 4345 5054 4544 5f53 5045 4353 293a 0d0a  CEPTED_SPECS):..
+000461a0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+000461b0: 6520 5661 6c75 6545 7272 6f72 280d 0a20  e ValueError(.. 
+000461c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000461d0: 656c 662e 5350 4543 5f54 5950 455f 4552  elf.SPEC_TYPE_ER
+000461e0: 524f 522e 666f 726d 6174 2873 656c 662e  ROR.format(self.
+000461f0: 4143 4345 5054 4544 5f53 5045 4353 2c20  ACCEPTED_SPECS, 
+00046200: 7479 7065 2861 6374 696f 6e5f 7370 6563  type(action_spec
+00046210: 2929 0d0a 2020 2020 2020 2020 2020 2020  ))..            
+00046220: 290d 0a20 2020 2020 2020 2061 6374 696f  )..        actio
+00046230: 6e5f 7370 6563 2e75 7064 6174 655f 6d61  n_spec.update_ma
+00046240: 736b 286d 6173 6b2e 746f 2861 6374 696f  sk(mask.to(actio
+00046250: 6e5f 7370 6563 2e64 6576 6963 6529 290d  n_spec.device)).
+00046260: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00046270: 7465 6e73 6f72 6469 6374 0d0a 0d0a 2020  tensordict....  
+00046280: 2020 6465 6620 5f72 6573 6574 280d 0a20    def _reset(.. 
+00046290: 2020 2020 2020 2073 656c 662c 2074 656e         self, ten
+000462a0: 736f 7264 6963 743a 2054 656e 736f 7244  sordict: TensorD
+000462b0: 6963 7442 6173 652c 2074 656e 736f 7264  ictBase, tensord
+000462c0: 6963 745f 7265 7365 743a 2054 656e 736f  ict_reset: Tenso
+000462d0: 7244 6963 7442 6173 650d 0a20 2020 2029  rDictBase..    )
+000462e0: 202d 3e20 5465 6e73 6f72 4469 6374 4261   -> TensorDictBa
+000462f0: 7365 3a0d 0a20 2020 2020 2020 2061 6374  se:..        act
+00046300: 696f 6e5f 7370 6563 203d 2073 656c 662e  ion_spec = self.
+00046310: 636f 6e74 6169 6e65 722e 6163 7469 6f6e  container.action
+00046320: 5f73 7065 630d 0a20 2020 2020 2020 2069  _spec..        i
+00046330: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
+00046340: 2861 6374 696f 6e5f 7370 6563 2c20 7365  (action_spec, se
+00046350: 6c66 2e41 4343 4550 5445 445f 5350 4543  lf.ACCEPTED_SPEC
+00046360: 5329 3a0d 0a20 2020 2020 2020 2020 2020  S):..           
+00046370: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00046380: 7228 0d0a 2020 2020 2020 2020 2020 2020  r(..            
+00046390: 2020 2020 7365 6c66 2e53 5045 435f 5459      self.SPEC_TY
+000463a0: 5045 5f45 5252 4f52 2e66 6f72 6d61 7428  PE_ERROR.format(
+000463b0: 7365 6c66 2e41 4343 4550 5445 445f 5350  self.ACCEPTED_SP
+000463c0: 4543 532c 2074 7970 6528 6163 7469 6f6e  ECS, type(action
+000463d0: 5f73 7065 6329 290d 0a20 2020 2020 2020  _spec))..       
+000463e0: 2020 2020 2029 0d0a 2020 2020 2020 2020       )..        
+000463f0: 6d61 736b 203d 2074 656e 736f 7264 6963  mask = tensordic
+00046400: 742e 6765 7428 7365 6c66 2e69 6e5f 6b65  t.get(self.in_ke
+00046410: 7973 5b31 5d2c 204e 6f6e 6529 0d0a 2020  ys[1], None)..  
+00046420: 2020 2020 2020 6966 206d 6173 6b20 6973        if mask is
+00046430: 206e 6f74 204e 6f6e 653a 0d0a 2020 2020   not None:..    
+00046440: 2020 2020 2020 2020 6d61 736b 203d 206d          mask = m
+00046450: 6173 6b2e 746f 2861 6374 696f 6e5f 7370  ask.to(action_sp
+00046460: 6563 2e64 6576 6963 6529 0d0a 2020 2020  ec.device)..    
+00046470: 2020 2020 6163 7469 6f6e 5f73 7065 632e      action_spec.
+00046480: 7570 6461 7465 5f6d 6173 6b28 6d61 736b  update_mask(mask
+00046490: 290d 0a0d 0a20 2020 2020 2020 2023 2054  )....        # T
+000464a0: 4f44 4f3a 2043 6865 636b 2074 6861 7420  ODO: Check that 
+000464b0: 7468 6973 206d 616b 6573 2073 656e 7365  this makes sense
+000464c0: 0d0a 2020 2020 2020 2020 7769 7468 205f  ..        with _
+000464d0: 7365 745f 6d69 7373 696e 675f 746f 6c65  set_missing_tole
+000464e0: 7261 6e63 6528 7365 6c66 2c20 5472 7565  rance(self, True
+000464f0: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
+00046500: 7465 6e73 6f72 6469 6374 5f72 6573 6574  tensordict_reset
+00046510: 203d 2073 656c 662e 5f63 616c 6c28 7465   = self._call(te
+00046520: 6e73 6f72 6469 6374 5f72 6573 6574 290d  nsordict_reset).
+00046530: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00046540: 7465 6e73 6f72 6469 6374 5f72 6573 6574  tensordict_reset
+00046550: 0d0a 0d0a 0d0a 636c 6173 7320 5665 6347  ......class VecG
+00046560: 796d 456e 7654 7261 6e73 666f 726d 2854  ymEnvTransform(T
+00046570: 7261 6e73 666f 726d 293a 0d0a 2020 2020  ransform):..    
+00046580: 2222 2241 2074 7261 6e73 666f 726d 2066  """A transform f
+00046590: 6f72 2047 796d 5772 6170 7065 7220 7375  or GymWrapper su
+000465a0: 6263 6c61 7373 6573 2074 6861 7420 6861  bclasses that ha
+000465b0: 6e64 6c65 7320 7468 6520 6175 746f 2d72  ndles the auto-r
+000465c0: 6573 6574 2069 6e20 6120 636f 6e73 6973  eset in a consis
+000465d0: 7465 6e74 2077 6179 2e0d 0a0d 0a20 2020  tent way.....   
+000465e0: 2047 796d 2c20 6779 6d6e 6173 6975 6d20   Gym, gymnasium 
+000465f0: 616e 6420 5342 3320 7072 6f76 6964 6520  and SB3 provide 
+00046600: 7665 6374 6f72 697a 6564 2028 7265 6164  vectorized (read
+00046610: 2c20 7061 7261 6c6c 656c 206f 7220 6261  , parallel or ba
+00046620: 7463 6865 6429 2065 6e76 6972 6f6e 6d65  tched) environme
+00046630: 6e74 730d 0a20 2020 2074 6861 7420 6172  nts..    that ar
+00046640: 6520 6175 746f 6d61 7469 6361 6c6c 7920  e automatically 
+00046650: 7265 7365 742e 2057 6865 6e20 7468 6973  reset. When this
+00046660: 206f 6363 7572 732c 2074 6865 2061 6374   occurs, the act
+00046670: 7561 6c20 6f62 7365 7276 6174 696f 6e20  ual observation 
+00046680: 7265 7375 6c74 696e 670d 0a20 2020 2066  resulting..    f
+00046690: 726f 6d20 7468 6520 6163 7469 6f6e 2069  rom the action i
+000466a0: 7320 7361 7665 6420 7769 7468 696e 2061  s saved within a
+000466b0: 206b 6579 2069 6e20 7468 6520 696e 666f   key in the info
+000466c0: 2e0d 0a20 2020 2054 6865 2063 6c61 7373  ...    The class
+000466d0: 203a 636c 6173 733a 6074 6f72 6368 726c   :class:`torchrl
+000466e0: 2e65 6e76 732e 6c69 6273 2e67 796d 2e74  .envs.libs.gym.t
+000466f0: 6572 6d69 6e61 6c5f 6f62 735f 7265 6164  erminal_obs_read
+00046700: 6572 6020 7265 6164 7320 7468 6174 206f  er` reads that o
+00046710: 6273 6572 7661 7469 6f6e 0d0a 2020 2020  bservation..    
+00046720: 616e 6420 7374 6f72 6573 2069 7420 696e  and stores it in
+00046730: 2061 2060 6022 6669 6e61 6c22 6060 206b   a ``"final"`` k
+00046740: 6579 2077 6974 6869 6e20 7468 6520 6f75  ey within the ou
+00046750: 7470 7574 2074 656e 736f 7264 6963 742e  tput tensordict.
+00046760: 0d0a 2020 2020 496e 2074 7572 6e2c 2074  ..    In turn, t
+00046770: 6869 7320 7472 616e 7366 6f72 6d20 7265  his transform re
+00046780: 6164 7320 7468 6174 2066 696e 616c 2064  ads that final d
+00046790: 6174 612c 2073 7761 7073 2069 7420 7769  ata, swaps it wi
+000467a0: 7468 2074 6865 206f 6273 6572 7661 7469  th the observati
+000467b0: 6f6e 0d0a 2020 2020 7772 6974 7465 6e20  on..    written 
+000467c0: 696e 2069 7473 2070 6c61 6365 2074 6861  in its place tha
+000467d0: 7420 7265 7375 6c74 7320 6672 6f6d 2074  t results from t
+000467e0: 6865 2061 6374 7561 6c20 7265 7365 742c  he actual reset,
+000467f0: 2061 6e64 2073 6176 6573 2074 6865 0d0a   and saves the..
+00046800: 2020 2020 7265 7365 7420 6f75 7470 7574      reset output
+00046810: 2069 6e20 6120 7072 6976 6174 6520 636f   in a private co
+00046820: 6e74 6169 6e65 722e 2054 6865 2072 6573  ntainer. The res
+00046830: 756c 7469 6e67 2064 6174 6120 7472 756c  ulting data trul
+00046840: 7920 7265 666c 6563 7473 0d0a 2020 2020  y reflects..    
+00046850: 7468 6520 6f75 7470 7574 206f 6620 7468  the output of th
+00046860: 6520 7374 6570 2e0d 0a0d 0a20 2020 2054  e step.....    T
+00046870: 6869 7320 636c 6173 7320 776f 726b 7320  his class works 
+00046880: 6672 6f6d 2067 796d 2030 2e31 3320 7469  from gym 0.13 ti
+00046890: 6c6c 2074 6865 206d 6f73 7420 7265 6365  ll the most rece
+000468a0: 6e74 2067 796d 6e61 7369 756d 2076 6572  nt gymnasium ver
+000468b0: 7369 6f6e 2e0d 0a0d 0a20 2020 202e 2e20  sion.....    .. 
+000468c0: 6e6f 7465 3a3a 2047 796d 2076 6572 7369  note:: Gym versi
+000468d0: 6f6e 7320 3c20 302e 3232 2064 6964 206e  ons < 0.22 did n
+000468e0: 6f74 2072 6574 7572 6e20 7468 6520 6669  ot return the fi
+000468f0: 6e61 6c20 6f62 7365 7276 6174 696f 6e73  nal observations
+00046900: 2e20 466f 7220 7468 6573 652c 0d0a 2020  . For these,..  
+00046910: 2020 2020 2020 7765 2073 696d 706c 7920        we simply 
+00046920: 6669 6c6c 2074 6865 206e 6578 7420 6f62  fill the next ob
+00046930: 7365 7276 6174 696f 6e73 2077 6974 6820  servations with 
+00046940: 4e61 4e20 2862 6563 6175 7365 2069 7420  NaN (because it 
+00046950: 6973 206c 6f73 7429 2061 6e64 0d0a 2020  is lost) and..  
+00046960: 2020 2020 2020 646f 2074 6865 2073 7761        do the swa
+00046970: 7020 6174 2074 6865 206e 6578 7420 7374  p at the next st
+00046980: 6570 2e0d 0a0d 0a20 2020 2054 6865 6e2c  ep.....    Then,
+00046990: 2077 6865 6e20 6361 6c6c 696e 6720 6065   when calling `e
+000469a0: 6e76 2e72 6573 6574 602c 2074 6865 2073  nv.reset`, the s
+000469b0: 6176 6564 2064 6174 6120 6973 2077 7269  aved data is wri
+000469c0: 7474 656e 2062 6163 6b20 7768 6572 6520  tten back where 
+000469d0: 6974 2062 656c 6f6e 6773 0d0a 2020 2020  it belongs..    
+000469e0: 2861 6e64 2074 6865 2060 7265 7365 7460  (and the `reset`
+000469f0: 2069 7320 6120 6e6f 2d6f 7029 2e0d 0a0d   is a no-op)....
+00046a00: 0a20 2020 2054 6869 7320 7472 616e 7366  .    This transf
+00046a10: 6f72 6d20 6973 2061 7574 6f6d 6174 6963  orm is automatic
+00046a20: 616c 6c79 2061 7070 656e 6465 6420 746f  ally appended to
+00046a30: 2074 6865 2067 796d 2065 6e76 2077 6865   the gym env whe
+00046a40: 6e65 7665 7220 7468 6520 7772 6170 7065  never the wrappe
+00046a50: 720d 0a20 2020 2069 7320 6372 6561 7465  r..    is create
+00046a60: 6420 7769 7468 2061 6e20 6173 796e 6320  d with an async 
+00046a70: 656e 762e 0d0a 0d0a 2020 2020 4172 6773  env.....    Args
+00046a80: 3a0d 0a20 2020 2020 2020 2066 696e 616c  :..        final
+00046a90: 5f6e 616d 6520 2873 7472 2c20 6f70 7469  _name (str, opti
+00046aa0: 6f6e 616c 293a 2074 6865 206e 616d 6520  onal): the name 
+00046ab0: 6f66 2074 6865 2066 696e 616c 206f 6273  of the final obs
+00046ac0: 6572 7661 7469 6f6e 2069 6e20 7468 6520  ervation in the 
+00046ad0: 6469 6374 2e0d 0a20 2020 2020 2020 2020  dict...         
+00046ae0: 2020 2044 6566 6175 6c74 7320 746f 2060     Defaults to `
+00046af0: 2266 696e 616c 2260 2e0d 0a0d 0a20 2020  "final"`.....   
+00046b00: 202e 2e20 6e6f 7465 3a3a 2049 6e20 6765   .. note:: In ge
+00046b10: 6e65 7261 6c2c 2074 6869 7320 636c 6173  neral, this clas
+00046b20: 7320 7368 6f75 6c64 206e 6f74 2062 6520  s should not be 
+00046b30: 6861 6e64 6c65 6420 6469 7265 6374 6c79  handled directly
+00046b40: 2e20 4974 2069 730d 0a20 2020 2020 2020  . It is..       
+00046b50: 2063 7265 6174 6564 2077 6865 6e65 7665   created wheneve
+00046b60: 7220 6120 7665 6374 6f72 697a 6564 2065  r a vectorized e
+00046b70: 6e76 6972 6f6e 6d65 6e74 2069 7320 706c  nvironment is pl
+00046b80: 6163 6564 2077 6974 6869 6e20 6120 3a63  aced within a :c
+00046b90: 6c61 7373 3a60 4779 6d57 7261 7070 6572  lass:`GymWrapper
+00046ba0: 602e 0d0a 0d0a 2020 2020 2222 220d 0a0d  `.....    """...
+00046bb0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00046bc0: 5f28 7365 6c66 2c20 6669 6e61 6c5f 6e61  _(self, final_na
+00046bd0: 6d65 3d22 6669 6e61 6c22 293a 0d0a 2020  me="final"):..  
+00046be0: 2020 2020 2020 7365 6c66 2e66 696e 616c        self.final
+00046bf0: 5f6e 616d 6520 3d20 6669 6e61 6c5f 6e61  _name = final_na
+00046c00: 6d65 0d0a 2020 2020 2020 2020 7375 7065  me..        supe
+00046c10: 7228 292e 5f5f 696e 6974 5f5f 2829 0d0a  r().__init__()..
+00046c20: 2020 2020 2020 2020 7365 6c66 2e5f 6d65          self._me
+00046c30: 6d6f 203d 207b 7d0d 0a0d 0a20 2020 2064  mo = {}....    d
+00046c40: 6566 2073 6574 5f63 6f6e 7461 696e 6572  ef set_container
+00046c50: 2873 656c 662c 2063 6f6e 7461 696e 6572  (self, container
+00046c60: 3a20 556e 696f 6e5b 5472 616e 7366 6f72  : Union[Transfor
+00046c70: 6d2c 2045 6e76 4261 7365 5d29 202d 3e20  m, EnvBase]) -> 
+00046c80: 4e6f 6e65 3a0d 0a20 2020 2020 2020 206f  None:..        o
+00046c90: 7574 203d 2073 7570 6572 2829 2e73 6574  ut = super().set
+00046ca0: 5f63 6f6e 7461 696e 6572 2863 6f6e 7461  _container(conta
+00046cb0: 696e 6572 290d 0a20 2020 2020 2020 2073  iner)..        s
+00046cc0: 656c 662e 5f64 6f6e 655f 6b65 7973 203d  elf._done_keys =
+00046cd0: 204e 6f6e 650d 0a20 2020 2020 2020 2073   None..        s
+00046ce0: 656c 662e 5f6f 6273 5f6b 6579 7320 3d20  elf._obs_keys = 
+00046cf0: 4e6f 6e65 0d0a 2020 2020 2020 2020 7265  None..        re
+00046d00: 7475 726e 206f 7574 0d0a 0d0a 2020 2020  turn out....    
+00046d10: 6465 6620 5f73 7465 7028 0d0a 2020 2020  def _step(..    
+00046d20: 2020 2020 7365 6c66 2c20 7465 6e73 6f72      self, tensor
+00046d30: 6469 6374 3a20 5465 6e73 6f72 4469 6374  dict: TensorDict
+00046d40: 4261 7365 2c20 6e65 7874 5f74 656e 736f  Base, next_tenso
+00046d50: 7264 6963 743a 2054 656e 736f 7244 6963  rdict: TensorDic
+00046d60: 7442 6173 650d 0a20 2020 2029 202d 3e20  tBase..    ) -> 
+00046d70: 5465 6e73 6f72 4469 6374 4261 7365 3a0d  TensorDictBase:.
+00046d80: 0a20 2020 2020 2020 2023 2073 6176 6520  .        # save 
+00046d90: 7468 6520 6669 6e61 6c20 696e 666f 0d0a  the final info..
+00046da0: 2020 2020 2020 2020 646f 6e65 203d 2046          done = F
+00046db0: 616c 7365 0d0a 2020 2020 2020 2020 666f  alse..        fo
+00046dc0: 7220 646f 6e65 5f6b 6579 2069 6e20 7365  r done_key in se
+00046dd0: 6c66 2e64 6f6e 655f 6b65 7973 3a0d 0a20  lf.done_keys:.. 
+00046de0: 2020 2020 2020 2020 2020 2023 2077 6520             # we 
+00046df0: 6173 7375 6d65 2064 6f6e 6573 2063 616e  assume dones can
+00046e00: 2062 6520 6272 6f61 6463 6173 740d 0a20   be broadcast.. 
+00046e10: 2020 2020 2020 2020 2020 2064 6f6e 6520             done 
+00046e20: 3d20 646f 6e65 207c 206e 6578 745f 7465  = done | next_te
+00046e30: 6e73 6f72 6469 6374 2e67 6574 2864 6f6e  nsordict.get(don
+00046e40: 655f 6b65 7929 0d0a 2020 2020 2020 2020  e_key)..        
+00046e50: 6966 2064 6f6e 6520 6973 2046 616c 7365  if done is False
+00046e60: 3a0d 0a20 2020 2020 2020 2020 2020 2072  :..            r
+00046e70: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
+00046e80: 7228 0d0a 2020 2020 2020 2020 2020 2020  r(..            
+00046e90: 2020 2020 6622 436f 756c 6420 6e6f 7420      f"Could not 
+00046ea0: 6669 6e64 2061 6e79 2064 6f6e 6520 7369  find any done si
+00046eb0: 676e 616c 2069 6e20 7465 6e73 6f72 6469  gnal in tensordi
+00046ec0: 6374 3a5c 6e7b 7465 6e73 6f72 6469 6374  ct:\n{tensordict
+00046ed0: 7d22 0d0a 2020 2020 2020 2020 2020 2020  }"..            
+00046ee0: 290d 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00046ef0: 5f6d 656d 6f5b 2264 6f6e 6522 5d20 3d20  _memo["done"] = 
+00046f00: 646f 6e65 0d0a 2020 2020 2020 2020 6669  done..        fi
+00046f10: 6e61 6c20 3d20 6e65 7874 5f74 656e 736f  nal = next_tenso
+00046f20: 7264 6963 742e 706f 7028 7365 6c66 2e66  rdict.pop(self.f
+00046f30: 696e 616c 5f6e 616d 652c 204e 6f6e 6529  inal_name, None)
+00046f40: 0d0a 2020 2020 2020 2020 2320 6966 2061  ..        # if a
+00046f50: 6e79 7468 696e 6727 7320 646f 6e65 2c20  nything's done, 
+00046f60: 7765 206e 6565 6420 746f 2073 7761 7020  we need to swap 
+00046f70: 7468 6520 6669 6e61 6c20 6f62 730d 0a20  the final obs.. 
+00046f80: 2020 2020 2020 2069 6620 646f 6e65 2e61         if done.a
+00046f90: 6e79 2829 3a0d 0a20 2020 2020 2020 2020  ny():..         
+00046fa0: 2020 2064 6f6e 6520 3d20 646f 6e65 2e73     done = done.s
+00046fb0: 7175 6565 7a65 282d 3129 0d0a 2020 2020  queeze(-1)..    
+00046fc0: 2020 2020 2020 2020 6966 2066 696e 616c          if final
+00046fd0: 2069 7320 6e6f 7420 4e6f 6e65 3a0d 0a20   is not None:.. 
+00046fe0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00046ff0: 6176 6564 5f6e 6578 7420 3d20 6e65 7874  aved_next = next
+00047000: 5f74 656e 736f 7264 6963 742e 7365 6c65  _tensordict.sele
+00047010: 6374 282a 6669 6e61 6c2e 6b65 7973 2854  ct(*final.keys(T
+00047020: 7275 652c 2054 7275 6529 292e 636c 6f6e  rue, True)).clon
+00047030: 6528 290d 0a20 2020 2020 2020 2020 2020  e()..           
+00047040: 2020 2020 206e 6578 745f 7465 6e73 6f72       next_tensor
+00047050: 6469 6374 5b64 6f6e 655d 203d 2066 696e  dict[done] = fin
+00047060: 616c 5b64 6f6e 655d 0d0a 2020 2020 2020  al[done]..      
+00047070: 2020 2020 2020 656c 7365 3a0d 0a20 2020        else:..   
+00047080: 2020 2020 2020 2020 2020 2020 2073 6176               sav
+00047090: 6564 5f6e 6578 7420 3d20 6e65 7874 5f74  ed_next = next_t
+000470a0: 656e 736f 7264 6963 742e 7365 6c65 6374  ensordict.select
+000470b0: 282a 7365 6c66 2e6f 6273 5f6b 6579 7329  (*self.obs_keys)
+000470c0: 2e63 6c6f 6e65 2829 0d0a 2020 2020 2020  .clone()..      
+000470d0: 2020 2020 2020 2020 2020 666f 7220 6f62            for ob
+000470e0: 735f 6b65 7920 696e 2073 656c 662e 6f62  s_key in self.ob
+000470f0: 735f 6b65 7973 3a0d 0a20 2020 2020 2020  s_keys:..       
+00047100: 2020 2020 2020 2020 2020 2020 206e 6578               nex
+00047110: 745f 7465 6e73 6f72 6469 6374 5b6f 6273  t_tensordict[obs
+00047120: 5f6b 6579 5d5b 646f 6e65 5d20 3d20 746f  _key][done] = to
+00047130: 7263 682e 7465 6e73 6f72 286e 702e 6e61  rch.tensor(np.na
+00047140: 6e29 0d0a 0d0a 2020 2020 2020 2020 2020  n)....          
+00047150: 2020 7365 6c66 2e5f 6d65 6d6f 5b22 7361    self._memo["sa
+00047160: 7665 645f 6e65 7874 225d 203d 2073 6176  ved_next"] = sav
+00047170: 6564 5f6e 6578 740d 0a20 2020 2020 2020  ed_next..       
+00047180: 2065 6c73 653a 0d0a 2020 2020 2020 2020   else:..        
+00047190: 2020 2020 7365 6c66 2e5f 6d65 6d6f 5b22      self._memo["
+000471a0: 7361 7665 645f 6e65 7874 225d 203d 204e  saved_next"] = N
+000471b0: 6f6e 650d 0a20 2020 2020 2020 2072 6574  one..        ret
+000471c0: 7572 6e20 6e65 7874 5f74 656e 736f 7264  urn next_tensord
+000471d0: 6963 740d 0a0d 0a20 2020 2064 6566 205f  ict....    def _
+000471e0: 7265 7365 7428 0d0a 2020 2020 2020 2020  reset(..        
+000471f0: 7365 6c66 2c20 7465 6e73 6f72 6469 6374  self, tensordict
+00047200: 3a20 5465 6e73 6f72 4469 6374 4261 7365  : TensorDictBase
+00047210: 2c20 7465 6e73 6f72 6469 6374 5f72 6573  , tensordict_res
+00047220: 6574 3a20 5465 6e73 6f72 4469 6374 4261  et: TensorDictBa
+00047230: 7365 0d0a 2020 2020 2920 2d3e 2054 656e  se..    ) -> Ten
+00047240: 736f 7244 6963 7442 6173 653a 0d0a 2020  sorDictBase:..  
+00047250: 2020 2020 2020 646f 6e65 203d 2073 656c        done = sel
+00047260: 662e 5f6d 656d 6f2e 6765 7428 2264 6f6e  f._memo.get("don
+00047270: 6522 2c20 4e6f 6e65 290d 0a20 2020 2020  e", None)..     
+00047280: 2020 2072 6573 6574 203d 2074 656e 736f     reset = tenso
+00047290: 7264 6963 742e 6765 7428 225f 7265 7365  rdict.get("_rese
+000472a0: 7422 2c20 646f 6e65 290d 0a20 2020 2020  t", done)..     
+000472b0: 2020 2069 6620 646f 6e65 2069 7320 6e6f     if done is no
+000472c0: 7420 4e6f 6e65 3a0d 0a20 2020 2020 2020  t None:..       
+000472d0: 2020 2020 2064 6f6e 6520 3d20 646f 6e65       done = done
+000472e0: 2e76 6965 775f 6173 2872 6573 6574 290d  .view_as(reset).
+000472f0: 0a20 2020 2020 2020 2069 6620 280d 0a20  .        if (.. 
+00047300: 2020 2020 2020 2020 2020 2072 6573 6574             reset
+00047310: 2069 7320 6e6f 7420 646f 6e65 0d0a 2020   is not done..  
+00047320: 2020 2020 2020 2020 2020 616e 6420 2872            and (r
+00047330: 6573 6574 2021 3d20 646f 6e65 292e 616e  eset != done).an
+00047340: 7928 290d 0a20 2020 2020 2020 2020 2020  y()..           
+00047350: 2023 2069 7420 6361 6e20 6861 7070 656e   # it can happen
+00047360: 2074 6861 7420 616c 6c20 6172 6520 7265   that all are re
+00047370: 7365 742c 2069 6e20 7768 6963 6820 6361  set, in which ca
+00047380: 7365 0d0a 2020 2020 2020 2020 2020 2020  se..            
+00047390: 2320 6974 2773 2066 696e 6520 2864 6f65  # it's fine (doe
+000473a0: 736e 2774 206e 6565 6420 746f 206d 6174  sn't need to mat
+000473b0: 6368 2064 6f6e 6529 0d0a 2020 2020 2020  ch done)..      
+000473c0: 2020 2020 2020 616e 6420 6e6f 7420 7265        and not re
+000473d0: 7365 742e 616c 6c28 290d 0a20 2020 2020  set.all()..     
+000473e0: 2020 2029 3a0d 0a20 2020 2020 2020 2020     ):..         
+000473f0: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
+00047400: 4572 726f 7228 0d0a 2020 2020 2020 2020  Error(..        
+00047410: 2020 2020 2020 2020 2243 616e 6e6f 7420          "Cannot 
+00047420: 7061 7274 6961 6c6c 7920 7265 7365 7420  partially reset 
+00047430: 6120 6779 6d28 6e61 7369 756d 2920 6173  a gym(nasium) as
+00047440: 796e 6320 656e 7620 7769 7468 2061 2022  ync env with a "
+00047450: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00047460: 2020 2272 6573 6574 206d 6173 6b20 7468    "reset mask th
+00047470: 6174 2064 6f65 7320 6e6f 7420 6d61 7463  at does not matc
+00047480: 6820 7468 6520 646f 6e65 206d 6173 6b2e  h the done mask.
+00047490: 2022 0d0a 2020 2020 2020 2020 2020 2020   "..            
+000474a0: 2020 2020 6622 476f 7420 7265 7365 743d      f"Got reset=
+000474b0: 7b72 6573 6574 7d5c 6e61 6e64 2064 6f6e  {reset}\nand don
+000474c0: 653d 7b64 6f6e 657d 220d 0a20 2020 2020  e={done}"..     
+000474d0: 2020 2020 2020 2029 0d0a 2020 2020 2020         )..      
+000474e0: 2020 2320 6966 206e 6f74 2072 6573 6574    # if not reset
+000474f0: 2e61 6e79 2829 2c20 7765 2064 6f6e 2774  .any(), we don't
+00047500: 206e 6565 6420 746f 2064 6f20 616e 7974   need to do anyt
+00047510: 6869 6e67 2e0d 0a20 2020 2020 2020 2023  hing...        #
+00047520: 2069 6620 7265 7365 742e 616c 6c28 292c   if reset.all(),
+00047530: 2077 6520 646f 6e27 7420 6569 7468 6572   we don't either
+00047540: 2028 6263 2047 796d 5772 6170 7065 7220   (bc GymWrapper 
+00047550: 7769 6c6c 2063 616c 6c20 6120 706c 6169  will call a plai
+00047560: 6e20 7265 7365 7429 2e0d 0a20 2020 2020  n reset)...     
+00047570: 2020 2069 6620 7265 7365 7420 6973 206e     if reset is n
+00047580: 6f74 204e 6f6e 6520 616e 6420 7265 7365  ot None and rese
+00047590: 742e 616e 7928 293a 0d0a 2020 2020 2020  t.any():..      
+000475a0: 2020 2020 2020 6966 2072 6573 6574 2e61        if reset.a
+000475b0: 6c6c 2829 3a0d 0a20 2020 2020 2020 2020  ll():..         
+000475c0: 2020 2020 2020 2023 2057 6527 7265 2066         # We're f
+000475d0: 696e 653a 2074 6869 7320 6d65 616e 7320  ine: this means 
+000475e0: 7468 6174 2061 2066 756c 6c20 7265 7365  that a full rese
+000475f0: 7420 7761 7320 7061 7373 6564 2061 6e64  t was passed and
+00047600: 2074 6865 0d0a 2020 2020 2020 2020 2020   the..          
+00047610: 2020 2020 2020 2320 656e 7620 7761 7320        # env was 
+00047620: 6d61 6e75 616c 6c79 2072 6573 6574 0d0a  manually reset..
+00047630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047640: 7465 6e73 6f72 6469 6374 5f72 6573 6574  tensordict_reset
+00047650: 2e70 6f70 2873 656c 662e 6669 6e61 6c5f  .pop(self.final_
+00047660: 6e61 6d65 2c20 4e6f 6e65 290d 0a20 2020  name, None)..   
+00047670: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00047680: 7572 6e20 7465 6e73 6f72 6469 6374 5f72  urn tensordict_r
+00047690: 6573 6574 0d0a 2020 2020 2020 2020 2020  eset..          
+000476a0: 2020 7361 7665 645f 6e65 7874 203d 2073    saved_next = s
+000476b0: 656c 662e 5f6d 656d 6f5b 2273 6176 6564  elf._memo["saved
+000476c0: 5f6e 6578 7422 5d0d 0a20 2020 2020 2020  _next"]..       
+000476d0: 2020 2020 2069 6620 7361 7665 645f 6e65       if saved_ne
+000476e0: 7874 2069 7320 4e6f 6e65 3a0d 0a20 2020  xt is None:..   
+000476f0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00047700: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
+00047710: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00047720: 2020 2020 2020 2244 6964 206e 6f74 2066        "Did not f
+00047730: 696e 6420 6120 7361 7665 6420 7465 6e73  ind a saved tens
+00047740: 6f72 6469 6374 2077 6869 6c65 2074 6865  ordict while the
+00047750: 2072 6573 6574 206d 6173 6b20 7761 7320   reset mask was 
+00047760: 220d 0a20 2020 2020 2020 2020 2020 2020  "..             
+00047770: 2020 2020 2020 2066 226e 6f74 2065 6d70         f"not emp
+00047780: 7479 3a20 7265 7365 743d 7b72 6573 6574  ty: reset={reset
+00047790: 7d2e 2044 6f6e 6520 7761 7320 7b64 6f6e  }. Done was {don
+000477a0: 657d 2e22 0d0a 2020 2020 2020 2020 2020  e}."..          
+000477b0: 2020 2020 2020 290d 0a20 2020 2020 2020        )..       
+000477c0: 2020 2020 2023 2072 6573 6574 203d 2072       # reset = r
+000477d0: 6573 6574 2e76 6965 7728 7465 6e73 6f72  eset.view(tensor
+000477e0: 6469 6374 2e73 6861 7065 290d 0a20 2020  dict.shape)..   
+000477f0: 2020 2020 2020 2020 2023 2077 6520 6861           # we ha
+00047800: 7665 2061 2064 6174 6120 636f 6e74 6169  ve a data contai
+00047810: 6e65 7220 6672 6f6d 2074 6865 2070 7265  ner from the pre
+00047820: 7669 6f75 7320 6361 6c6c 2074 6f20 7374  vious call to st
+00047830: 6570 0d0a 2020 2020 2020 2020 2020 2020  ep..            
+00047840: 2320 7468 6174 2063 6f6e 7461 696e 7320  # that contains 
+00047850: 7061 7274 206f 6620 7468 6520 6f62 7365  part of the obse
+00047860: 7276 6174 696f 6e20 7765 206e 6565 642e  rvation we need.
+00047870: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00047880: 5765 2063 616e 2073 6166 656c 7920 706c  We can safely pl
+00047890: 6163 6520 7468 656d 2062 6163 6b20 696e  ace them back in
+000478a0: 2074 6865 2072 6573 6574 2072 6573 756c   the reset resul
+000478b0: 7420 7465 6e73 6f72 6469 6374 3a0d 0a20  t tensordict:.. 
+000478c0: 2020 2020 2020 2020 2020 2023 2069 6e20             # in 
+000478d0: 656e 762e 726f 6c6c 6f75 7428 292c 2074  env.rollout(), t
+000478e0: 6865 2072 6573 756c 7420 6f66 2072 6573  he result of res
+000478f0: 6574 2829 2069 7320 6173 7375 6d65 6420  et() is assumed 
+00047900: 746f 2062 6520 6a75 7374 0d0a 2020 2020  to be just..    
+00047910: 2020 2020 2020 2020 2320 7468 6520 7464          # the td
+00047920: 2066 726f 6d20 7072 6576 696f 7573 2073   from previous s
+00047930: 7465 7020 7769 7468 2075 7064 6174 6564  tep with updated
+00047940: 2076 616c 7565 7320 6672 6f6d 2072 6573   values from res
+00047950: 6574 2e0d 0a20 2020 2020 2020 2020 2020  et...           
+00047960: 2023 2049 6e20 6f75 7220 6361 7365 2c20   # In our case, 
+00047970: 6974 2077 696c 6c20 616c 7761 7973 2062  it will always b
+00047980: 6520 7468 6520 6361 7365 2074 6861 7420  e the case that 
+00047990: 616c 6c20 7468 6573 6520 7661 6c75 6573  all these values
+000479a0: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+000479b0: 6172 6520 7072 6f70 6572 6c79 2073 6574  are properly set
+000479c0: 2e0d 0a20 2020 2020 2020 2020 2020 2023  ...            #
+000479d0: 2063 6f6c 6c65 6374 6f72 7320 6576 656e   collectors even
+000479e0: 2074 616b 6520 6361 7265 206f 6620 646f   take care of do
+000479f0: 696e 6720 616e 2065 7874 7261 206d 6173  ing an extra mas
+00047a00: 6b69 6e67 2073 6f20 6974 2773 2065 7665  king so it's eve
+00047a10: 6e0d 0a20 2020 2020 2020 2020 2020 2023  n..            #
+00047a20: 2073 6166 6572 2e0d 0a20 2020 2020 2020   safer...       
+00047a30: 2020 2020 2074 656e 736f 7264 6963 745f       tensordict_
+00047a40: 7265 7365 742e 7570 6461 7465 2873 6176  reset.update(sav
+00047a50: 6564 5f6e 6578 7429 0d0a 2020 2020 2020  ed_next)..      
+00047a60: 2020 2020 2020 666f 7220 646f 6e65 5f6b        for done_k
+00047a70: 6579 2069 6e20 7365 6c66 2e64 6f6e 655f  ey in self.done_
+00047a80: 6b65 7973 3a0d 0a20 2020 2020 2020 2020  keys:..         
+00047a90: 2020 2020 2020 2023 204d 616b 6520 7375         # Make su
+00047aa0: 7265 2074 6861 7420 616c 6c20 646f 6e65  re that all done
+00047ab0: 2061 7265 2046 616c 7365 0d0a 2020 2020   are False..    
+00047ac0: 2020 2020 2020 2020 2020 2020 646f 6e65              done
+00047ad0: 203d 2074 656e 736f 7264 6963 742e 6765   = tensordict.ge
+00047ae0: 7428 646f 6e65 5f6b 6579 2c20 4e6f 6e65  t(done_key, None
+00047af0: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+00047b00: 2020 2069 6620 646f 6e65 2069 7320 6e6f     if done is no
+00047b10: 7420 4e6f 6e65 3a0d 0a20 2020 2020 2020  t None:..       
+00047b20: 2020 2020 2020 2020 2020 2020 2064 6f6e               don
+00047b30: 6520 3d20 646f 6e65 2e63 6c6f 6e65 2829  e = done.clone()
+00047b40: 2e66 696c 6c5f 2830 290d 0a20 2020 2020  .fill_(0)..     
+00047b50: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00047b60: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00047b70: 2020 2020 2020 646f 6e65 203d 2074 6f72        done = tor
+00047b80: 6368 2e7a 6572 6f73 280d 0a20 2020 2020  ch.zeros(..     
+00047b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047ba0: 2020 2028 2a74 656e 736f 7264 6963 742e     (*tensordict.
+00047bb0: 6261 7463 685f 7369 7a65 2c20 3129 2c0d  batch_size, 1),.
+00047bc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00047bd0: 2020 2020 2020 2020 2064 6576 6963 653d           device=
+00047be0: 7465 6e73 6f72 6469 6374 2e64 6576 6963  tensordict.devic
+00047bf0: 652c 0d0a 2020 2020 2020 2020 2020 2020  e,..            
+00047c00: 2020 2020 2020 2020 2020 2020 6474 7970              dtyp
+00047c10: 653d 746f 7263 682e 626f 6f6c 2c0d 0a20  e=torch.bool,.. 
+00047c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047c30: 2020 2029 0d0a 2020 2020 2020 2020 2020     )..          
+00047c40: 2020 2020 2020 7465 6e73 6f72 6469 6374        tensordict
+00047c50: 2e73 6574 2864 6f6e 655f 6b65 792c 2064  .set(done_key, d
+00047c60: 6f6e 6529 0d0a 2020 2020 2020 2020 7465  one)..        te
+00047c70: 6e73 6f72 6469 6374 5f72 6573 6574 2e70  nsordict_reset.p
+00047c80: 6f70 2873 656c 662e 6669 6e61 6c5f 6e61  op(self.final_na
+00047c90: 6d65 2c20 4e6f 6e65 290d 0a20 2020 2020  me, None)..     
+00047ca0: 2020 2072 6574 7572 6e20 7465 6e73 6f72     return tensor
+00047cb0: 6469 6374 5f72 6573 6574 0d0a 0d0a 2020  dict_reset....  
+00047cc0: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
+00047cd0: 2064 6566 2064 6f6e 655f 6b65 7973 2873   def done_keys(s
+00047ce0: 656c 6629 202d 3e20 4c69 7374 5b4e 6573  elf) -> List[Nes
+00047cf0: 7465 644b 6579 5d3a 0d0a 2020 2020 2020  tedKey]:..      
+00047d00: 2020 6b65 7973 203d 2073 656c 662e 5f5f    keys = self.__
+00047d10: 6469 6374 5f5f 2e67 6574 2822 5f64 6f6e  dict__.get("_don
+00047d20: 655f 6b65 7973 222c 204e 6f6e 6529 0d0a  e_keys", None)..
+00047d30: 2020 2020 2020 2020 6966 206b 6579 7320          if keys 
+00047d40: 6973 204e 6f6e 653a 0d0a 2020 2020 2020  is None:..      
+00047d50: 2020 2020 2020 6b65 7973 203d 2073 656c        keys = sel
+00047d60: 662e 7061 7265 6e74 2e64 6f6e 655f 6b65  f.parent.done_ke
+00047d70: 7973 0d0a 2020 2020 2020 2020 2020 2020  ys..            
+00047d80: 2320 7765 206a 7573 7420 7761 6e74 2074  # we just want t
+00047d90: 6865 2022 646f 6e65 2220 6b65 790d 0a20  he "done" key.. 
+00047da0: 2020 2020 2020 2020 2020 205f 646f 6e65             _done
+00047db0: 5f6b 6579 7320 3d20 5b5d 0d0a 2020 2020  _keys = []..    
+00047dc0: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
+00047dd0: 696e 206b 6579 733a 0d0a 2020 2020 2020  in keys:..      
+00047de0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00047df0: 2069 7369 6e73 7461 6e63 6528 6b65 792c   isinstance(key,
+00047e00: 2074 7570 6c65 293a 0d0a 2020 2020 2020   tuple):..      
+00047e10: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
+00047e20: 7920 3d20 286b 6579 2c29 0d0a 2020 2020  y = (key,)..    
+00047e30: 2020 2020 2020 2020 2020 2020 6966 206b              if k
+00047e40: 6579 5b2d 315d 203d 3d20 2264 6f6e 6522  ey[-1] == "done"
+00047e50: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+00047e60: 2020 2020 2020 205f 646f 6e65 5f6b 6579         _done_key
+00047e70: 732e 6170 7065 6e64 2875 6e72 6176 656c  s.append(unravel
+00047e80: 5f6b 6579 286b 6579 2929 0d0a 2020 2020  _key(key))..    
+00047e90: 2020 2020 2020 2020 6966 206e 6f74 206c          if not l
+00047ea0: 656e 285f 646f 6e65 5f6b 6579 7329 3a0d  en(_done_keys):.
+00047eb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00047ec0: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
+00047ed0: 726f 7228 2243 6f75 6c64 206e 6f74 2066  ror("Could not f
+00047ee0: 696e 6420 6120 2764 6f6e 6527 206b 6579  ind a 'done' key
+00047ef0: 2069 6e20 7468 6520 656e 7620 7370 6563   in the env spec
+00047f00: 732e 2229 0d0a 2020 2020 2020 2020 2020  s.")..          
+00047f10: 2020 7365 6c66 2e5f 646f 6e65 5f6b 6579    self._done_key
+00047f20: 7320 3d20 5f64 6f6e 655f 6b65 7973 0d0a  s = _done_keys..
+00047f30: 2020 2020 2020 2020 7265 7475 726e 206b          return k
+00047f40: 6579 730d 0a0d 0a20 2020 2040 7072 6f70  eys....    @prop
+00047f50: 6572 7479 0d0a 2020 2020 6465 6620 6f62  erty..    def ob
+00047f60: 735f 6b65 7973 2873 656c 6629 202d 3e20  s_keys(self) -> 
+00047f70: 4c69 7374 5b4e 6573 7465 644b 6579 5d3a  List[NestedKey]:
+00047f80: 0d0a 2020 2020 2020 2020 6b65 7973 203d  ..        keys =
+00047f90: 2073 656c 662e 5f5f 6469 6374 5f5f 2e67   self.__dict__.g
+00047fa0: 6574 2822 5f6f 6273 5f6b 6579 7322 2c20  et("_obs_keys", 
+00047fb0: 4e6f 6e65 290d 0a20 2020 2020 2020 2069  None)..        i
+00047fc0: 6620 6b65 7973 2069 7320 4e6f 6e65 3a0d  f keys is None:.
+00047fd0: 0a20 2020 2020 2020 2020 2020 206b 6579  .            key
+00047fe0: 7320 3d20 6c69 7374 2873 656c 662e 7061  s = list(self.pa
+00047ff0: 7265 6e74 2e6f 6273 6572 7661 7469 6f6e  rent.observation
+00048000: 5f73 7065 632e 6b65 7973 2854 7275 652c  _spec.keys(True,
+00048010: 2054 7275 6529 290d 0a20 2020 2020 2020   True))..       
+00048020: 2020 2020 2073 656c 662e 5f6f 6273 5f6b       self._obs_k
+00048030: 6579 7320 3d20 6b65 7973 0d0a 2020 2020  eys = keys..    
+00048040: 2020 2020 7265 7475 726e 206b 6579 730d      return keys.
+00048050: 0a0d 0a20 2020 2064 6566 2074 7261 6e73  ...    def trans
+00048060: 666f 726d 5f6f 6273 6572 7661 7469 6f6e  form_observation
+00048070: 5f73 7065 6328 7365 6c66 2c20 6f62 7365  _spec(self, obse
+00048080: 7276 6174 696f 6e5f 7370 6563 3a20 5465  rvation_spec: Te
+00048090: 6e73 6f72 5370 6563 2920 2d3e 2054 656e  nsorSpec) -> Ten
+000480a0: 736f 7253 7065 633a 0d0a 2020 2020 2020  sorSpec:..      
+000480b0: 2020 6966 2073 656c 662e 6669 6e61 6c5f    if self.final_
+000480c0: 6e61 6d65 2069 6e20 6f62 7365 7276 6174  name in observat
+000480d0: 696f 6e5f 7370 6563 2e6b 6579 7328 5472  ion_spec.keys(Tr
+000480e0: 7565 293a 0d0a 2020 2020 2020 2020 2020  ue):..          
+000480f0: 2020 6465 6c20 6f62 7365 7276 6174 696f    del observatio
+00048100: 6e5f 7370 6563 5b73 656c 662e 6669 6e61  n_spec[self.fina
+00048110: 6c5f 6e61 6d65 5d0d 0a20 2020 2020 2020  l_name]..       
+00048120: 2072 6574 7572 6e20 6f62 7365 7276 6174   return observat
+00048130: 696f 6e5f 7370 6563 0d0a 0d0a 2020 2020  ion_spec....    
+00048140: 6465 6620 666f 7277 6172 6428 7365 6c66  def forward(self
+00048150: 2c20 7465 6e73 6f72 6469 6374 3a20 5465  , tensordict: Te
+00048160: 6e73 6f72 4469 6374 4261 7365 2920 2d3e  nsorDictBase) ->
+00048170: 2054 656e 736f 7244 6963 7442 6173 653a   TensorDictBase:
+00048180: 0d0a 2020 2020 2020 2020 7261 6973 6520  ..        raise 
+00048190: 5275 6e74 696d 6545 7272 6f72 2846 4f52  RuntimeError(FOR
+000481a0: 5741 5244 5f4e 4f54 5f49 4d50 4c45 4d45  WARD_NOT_IMPLEME
+000481b0: 4e54 4544 2e66 6f72 6d61 7428 7479 7065  NTED.format(type
+000481c0: 2873 656c 6629 2929 0d0a 0d0a 0d0a 636c  (self)))......cl
+000481d0: 6173 7320 4275 726e 496e 5472 616e 7366  ass BurnInTransf
+000481e0: 6f72 6d28 5472 616e 7366 6f72 6d29 3a0d  orm(Transform):.
+000481f0: 0a20 2020 2022 2222 5472 616e 7366 6f72  .    """Transfor
+00048200: 6d20 746f 2070 6172 7469 616c 6c79 2062  m to partially b
+00048210: 7572 6e2d 696e 2064 6174 6120 7365 7175  urn-in data sequ
+00048220: 656e 6365 732e 0d0a 0d0a 2020 2020 5468  ences.....    Th
+00048230: 6973 2074 7261 6e73 666f 726d 2069 7320  is transform is 
+00048240: 7573 6566 756c 2074 6f20 6f62 7461 696e  useful to obtain
+00048250: 2075 702d 746f 2d64 6174 6520 7265 6375   up-to-date recu
+00048260: 7272 656e 7420 7374 6174 6573 2077 6865  rrent states whe
+00048270: 6e0d 0a20 2020 2074 6865 7920 6172 6520  n..    they are 
+00048280: 6e6f 7420 6176 6169 6c61 626c 652e 2049  not available. I
+00048290: 7420 6275 726e 732d 696e 2061 206e 756d  t burns-in a num
+000482a0: 6265 7220 6f66 2073 7465 7073 2061 6c6f  ber of steps alo
+000482b0: 6e67 2074 6865 2074 696d 6520 6469 6d65  ng the time dime
+000482c0: 6e73 696f 6e0d 0a20 2020 2066 726f 6d20  nsion..    from 
+000482d0: 7361 6d70 6c65 6420 7365 7175 656e 7469  sampled sequenti
+000482e0: 616c 2064 6174 6120 736c 6963 6573 2061  al data slices a
+000482f0: 6e64 2072 6574 7572 7320 7468 6520 7265  nd returs the re
+00048300: 6d61 696e 696e 6720 6461 7461 2073 6571  maining data seq
+00048310: 7565 6e63 6520 7769 7468 0d0a 2020 2020  uence with..    
+00048320: 7468 6520 6275 726e 742d 696e 2064 6174  the burnt-in dat
+00048330: 6120 696e 2069 7473 2069 6e69 7469 616c  a in its initial
+00048340: 2074 696d 6520 7374 6570 2e20 5468 6973   time step. This
+00048350: 2074 7261 6e73 666f 726d 2069 7320 696e   transform is in
+00048360: 7465 6e64 6564 2074 6f20 6265 2075 7365  tended to be use
+00048370: 6420 6173 2061 0d0a 2020 2020 7265 706c  d as a..    repl
+00048380: 6179 2062 7566 6665 7220 7472 616e 7366  ay buffer transf
+00048390: 6f72 6d2c 206e 6f74 2061 7320 616e 2065  orm, not as an e
+000483a0: 6e76 6972 6f6e 6d65 6e74 2074 7261 6e73  nvironment trans
+000483b0: 666f 726d 2e0d 0a0d 0a20 2020 2041 7267  form.....    Arg
+000483c0: 733a 0d0a 2020 2020 2020 2020 6d6f 6475  s:..        modu
+000483d0: 6c65 7320 2873 6571 7565 6e63 6520 6f66  les (sequence of
+000483e0: 2054 656e 736f 7244 6963 744d 6f64 756c   TensorDictModul
+000483f0: 6529 3a20 4120 6c69 7374 206f 6620 6d6f  e): A list of mo
+00048400: 6475 6c65 7320 7573 6564 2074 6f20 6275  dules used to bu
+00048410: 726e 2d69 6e20 6461 7461 2073 6571 7565  rn-in data seque
+00048420: 6e63 6573 2e0d 0a20 2020 2020 2020 2062  nces...        b
+00048430: 7572 6e5f 696e 2028 696e 7429 3a20 5468  urn_in (int): Th
+00048440: 6520 6e75 6d62 6572 206f 6620 7469 6d65  e number of time
+00048450: 2073 7465 7073 2074 6f20 6275 726e 2069   steps to burn i
+00048460: 6e2e 0d0a 2020 2020 2020 2020 6f75 745f  n...        out_
+00048470: 6b65 7973 2028 7365 7175 656e 6365 206f  keys (sequence o
+00048480: 6620 4e65 7374 6564 4b65 792c 206f 7074  f NestedKey, opt
+00048490: 696f 6e61 6c29 3a20 6465 7374 696e 6174  ional): destinat
+000484a0: 696f 6e20 6b65 7973 2e20 4465 6661 756c  ion keys. Defaul
+000484b0: 7473 2074 6f0d 0a20 2020 2020 2020 2061  ts to..        a
+000484c0: 6c6c 2074 6865 206d 6f64 756c 6573 2060  ll the modules `
+000484d0: 6f75 745f 6b65 7973 6020 7468 6174 2070  out_keys` that p
+000484e0: 6f69 6e74 2074 6f20 7468 6520 6e65 7874  oint to the next
+000484f0: 2074 696d 6520 7374 6570 2028 652e 672e   time step (e.g.
+00048500: 2060 2268 6964 6465 6e22 6020 6966 2060   `"hidden"` if `
+00048510: 0d0a 2020 2020 2020 2020 2822 6e65 7874  ..        ("next
+00048520: 222c 2022 6869 6464 656e 2229 6020 6973  ", "hidden")` is
+00048530: 2070 6172 7420 6f66 2074 6865 2060 6f75   part of the `ou
+00048540: 745f 6b65 7973 6020 6f66 2061 206d 6f64  t_keys` of a mod
+00048550: 756c 6529 2e0d 0a0d 0a20 2020 202e 2e20  ule).....    .. 
+00048560: 6e6f 7465 3a3a 0d0a 2020 2020 2020 2020  note::..        
+00048570: 5468 6973 2074 7261 6e73 666f 726d 2065  This transform e
+00048580: 7870 6563 7473 2061 7320 696e 7075 7473  xpects as inputs
+00048590: 2054 656e 736f 7244 6963 7473 2077 6974   TensorDicts wit
+000485a0: 6820 6974 7320 6c61 7374 2064 696d 656e  h its last dimen
+000485b0: 7369 6f6e 2062 6569 6e67 2074 6865 0d0a  sion being the..
+000485c0: 2020 2020 2020 2020 7469 6d65 2064 696d          time dim
+000485d0: 656e 7369 6f6e 2e20 4974 2061 6c73 6f20  ension. It also 
+000485e0: 2061 7373 756d 6573 2074 6861 7420 616c   assumes that al
+000485f0: 6c20 7072 6f76 6964 6564 206d 6f64 756c  l provided modul
+00048600: 6573 2063 616e 2070 726f 6365 7373 0d0a  es can process..
+00048610: 2020 2020 2020 2020 7365 7175 656e 7469          sequenti
+00048620: 616c 2064 6174 612e 0d0a 0d0a 2020 2020  al data.....    
+00048630: 4578 616d 706c 6573 3a0d 0a20 2020 2020  Examples:..     
+00048640: 2020 203e 3e3e 2069 6d70 6f72 7420 746f     >>> import to
+00048650: 7263 680d 0a20 2020 2020 2020 203e 3e3e  rch..        >>>
+00048660: 2066 726f 6d20 7465 6e73 6f72 6469 6374   from tensordict
+00048670: 2069 6d70 6f72 7420 5465 6e73 6f72 4469   import TensorDi
+00048680: 6374 0d0a 2020 2020 2020 2020 3e3e 3e20  ct..        >>> 
+00048690: 6672 6f6d 2074 6f72 6368 726c 2e65 6e76  from torchrl.env
+000486a0: 732e 7472 616e 7366 6f72 6d73 2069 6d70  s.transforms imp
+000486b0: 6f72 7420 4275 726e 496e 5472 616e 7366  ort BurnInTransf
+000486c0: 6f72 6d0d 0a20 2020 2020 2020 203e 3e3e  orm..        >>>
+000486d0: 2066 726f 6d20 746f 7263 6872 6c2e 6d6f   from torchrl.mo
+000486e0: 6475 6c65 7320 696d 706f 7274 2047 5255  dules import GRU
+000486f0: 4d6f 6475 6c65 0d0a 2020 2020 2020 2020  Module..        
+00048700: 3e3e 3e20 6772 755f 6d6f 6475 6c65 203d  >>> gru_module =
+00048710: 2047 5255 4d6f 6475 6c65 280d 0a20 2020   GRUModule(..   
+00048720: 2020 2020 202e 2e2e 2020 2020 2069 6e70       ...     inp
+00048730: 7574 5f73 697a 653d 3130 2c0d 0a20 2020  ut_size=10,..   
+00048740: 2020 2020 202e 2e2e 2020 2020 2068 6964       ...     hid
+00048750: 6465 6e5f 7369 7a65 3d31 302c 0d0a 2020  den_size=10,..  
+00048760: 2020 2020 2020 2e2e 2e20 2020 2020 696e        ...     in
+00048770: 5f6b 6579 733d 5b22 6f62 7365 7276 6174  _keys=["observat
+00048780: 696f 6e22 2c20 2268 6964 6465 6e22 5d2c  ion", "hidden"],
+00048790: 0d0a 2020 2020 2020 2020 2e2e 2e20 2020  ..        ...   
+000487a0: 2020 6f75 745f 6b65 7973 3d5b 2269 6e74    out_keys=["int
+000487b0: 6572 6d65 6469 6174 6522 2c20 2822 6e65  ermediate", ("ne
+000487c0: 7874 222c 2022 6869 6464 656e 2229 5d2c  xt", "hidden")],
+000487d0: 0d0a 2020 2020 2020 2020 2e2e 2e20 292e  ..        ... ).
+000487e0: 7365 745f 7265 6375 7272 656e 745f 6d6f  set_recurrent_mo
+000487f0: 6465 2854 7275 6529 0d0a 2020 2020 2020  de(True)..      
+00048800: 2020 3e3e 3e20 6275 726e 5f69 6e5f 7472    >>> burn_in_tr
+00048810: 616e 7366 6f72 6d20 3d20 4275 726e 496e  ansform = BurnIn
+00048820: 5472 616e 7366 6f72 6d28 0d0a 2020 2020  Transform(..    
+00048830: 2020 2020 2e2e 2e20 2020 2020 6d6f 6475      ...     modu
+00048840: 6c65 733d 5b67 7275 5f6d 6f64 756c 655d  les=[gru_module]
+00048850: 2c0d 0a20 2020 2020 2020 202e 2e2e 2020  ,..        ...  
+00048860: 2020 2062 7572 6e5f 696e 3d35 2c0d 0a20     burn_in=5,.. 
+00048870: 2020 2020 2020 202e 2e2e 2029 0d0a 2020         ... )..  
+00048880: 2020 2020 2020 3e3e 3e20 7464 203d 2054        >>> td = T
+00048890: 656e 736f 7244 6963 7428 7b0d 0a20 2020  ensorDict({..   
+000488a0: 2020 2020 202e 2e2e 2020 2020 2022 6f62       ...     "ob
+000488b0: 7365 7276 6174 696f 6e22 3a20 746f 7263  servation": torc
+000488c0: 682e 7261 6e64 6e28 322c 2031 302c 2031  h.randn(2, 10, 1
+000488d0: 3029 2c0d 0a20 2020 2020 2020 202e 2e2e  0),..        ...
+000488e0: 2020 2020 2020 2268 6964 6465 6e22 3a20        "hidden": 
+000488f0: 746f 7263 682e 7261 6e64 6e28 322c 2031  torch.randn(2, 1
+00048900: 302c 2067 7275 5f6d 6f64 756c 652e 6772  0, gru_module.gr
+00048910: 752e 6e75 6d5f 6c61 7965 7273 2c20 3130  u.num_layers, 10
+00048920: 292c 0d0a 2020 2020 2020 2020 2e2e 2e20  ),..        ... 
+00048930: 2020 2020 2022 6973 5f69 6e69 7422 3a20       "is_init": 
+00048940: 746f 7263 682e 7a65 726f 7328 322c 2031  torch.zeros(2, 1
+00048950: 302c 2031 292c 0d0a 2020 2020 2020 2020  0, 1),..        
+00048960: 2e2e 2e20 7d2c 2062 6174 6368 5f73 697a  ... }, batch_siz
+00048970: 653d 5b32 2c20 3130 5d29 0d0a 2020 2020  e=[2, 10])..    
+00048980: 2020 2020 3e3e 3e20 7464 203d 2062 7572      >>> td = bur
+00048990: 6e5f 696e 5f74 7261 6e73 666f 726d 2874  n_in_transform(t
+000489a0: 6429 0d0a 2020 2020 2020 2020 3e3e 3e20  d)..        >>> 
+000489b0: 7464 2e73 6861 7065 0d0a 2020 2020 2020  td.shape..      
+000489c0: 2020 746f 7263 682e 5369 7a65 285b 322c    torch.Size([2,
+000489d0: 2035 5d29 0d0a 2020 2020 2020 2020 3e3e   5])..        >>
+000489e0: 3e20 7464 2e67 6574 2822 6869 6464 656e  > td.get("hidden
+000489f0: 2229 2e61 6273 2829 2e73 756d 2829 0d0a  ").abs().sum()..
+00048a00: 2020 2020 2020 2020 7465 6e73 6f72 2838          tensor(8
+00048a10: 362e 3330 3038 290d 0a0d 0a20 2020 2020  6.3008)....     
+00048a20: 2020 203e 3e3e 2066 726f 6d20 746f 7263     >>> from torc
+00048a30: 6872 6c2e 6461 7461 2069 6d70 6f72 7420  hrl.data import 
+00048a40: 4c61 7a79 4d65 6d6d 6170 5374 6f72 6167  LazyMemmapStorag
+00048a50: 652c 2054 656e 736f 7244 6963 7452 6570  e, TensorDictRep
+00048a60: 6c61 7942 7566 6665 720d 0a20 2020 2020  layBuffer..     
+00048a70: 2020 203e 3e3e 2062 7566 6665 7220 3d20     >>> buffer = 
+00048a80: 5465 6e73 6f72 4469 6374 5265 706c 6179  TensorDictReplay
+00048a90: 4275 6666 6572 280d 0a20 2020 2020 2020  Buffer(..       
+00048aa0: 202e 2e2e 2020 2020 2073 746f 7261 6765   ...     storage
+00048ab0: 3d4c 617a 794d 656d 6d61 7053 746f 7261  =LazyMemmapStora
+00048ac0: 6765 2832 292c 0d0a 2020 2020 2020 2020  ge(2),..        
+00048ad0: 2e2e 2e20 2020 2020 6261 7463 685f 7369  ...     batch_si
+00048ae0: 7a65 3d31 2c0d 0a20 2020 2020 2020 202e  ze=1,..        .
+00048af0: 2e2e 2029 0d0a 2020 2020 2020 2020 3e3e  .. )..        >>
+00048b00: 3e20 6275 6666 6572 2e61 7070 656e 645f  > buffer.append_
+00048b10: 7472 616e 7366 6f72 6d28 6275 726e 5f69  transform(burn_i
+00048b20: 6e5f 7472 616e 7366 6f72 6d29 0d0a 2020  n_transform)..  
+00048b30: 2020 2020 2020 3e3e 3e20 7464 203d 2054        >>> td = T
+00048b40: 656e 736f 7244 6963 7428 7b0d 0a20 2020  ensorDict({..   
+00048b50: 2020 2020 202e 2e2e 2020 2020 2022 6f62       ...     "ob
+00048b60: 7365 7276 6174 696f 6e22 3a20 746f 7263  servation": torc
+00048b70: 682e 7261 6e64 6e28 322c 2031 302c 2031  h.randn(2, 10, 1
+00048b80: 3029 2c0d 0a20 2020 2020 2020 202e 2e2e  0),..        ...
+00048b90: 2020 2020 2020 2268 6964 6465 6e22 3a20        "hidden": 
+00048ba0: 746f 7263 682e 7261 6e64 6e28 322c 2031  torch.randn(2, 1
+00048bb0: 302c 2067 7275 5f6d 6f64 756c 652e 6772  0, gru_module.gr
+00048bc0: 752e 6e75 6d5f 6c61 7965 7273 2c20 3130  u.num_layers, 10
+00048bd0: 292c 0d0a 2020 2020 2020 2020 2e2e 2e20  ),..        ... 
+00048be0: 2020 2020 2022 6973 5f69 6e69 7422 3a20       "is_init": 
+00048bf0: 746f 7263 682e 7a65 726f 7328 322c 2031  torch.zeros(2, 1
+00048c00: 302c 2031 292c 0d0a 2020 2020 2020 2020  0, 1),..        
+00048c10: 2e2e 2e20 7d2c 2062 6174 6368 5f73 697a  ... }, batch_siz
+00048c20: 653d 5b32 2c20 3130 5d29 0d0a 2020 2020  e=[2, 10])..    
+00048c30: 2020 2020 3e3e 3e20 6275 6666 6572 2e65      >>> buffer.e
+00048c40: 7874 656e 6428 7464 290d 0a20 2020 2020  xtend(td)..     
+00048c50: 2020 203e 3e3e 2074 6420 3d20 6275 6666     >>> td = buff
+00048c60: 6572 2e73 616d 706c 6528 3129 0d0a 2020  er.sample(1)..  
+00048c70: 2020 2020 2020 3e3e 3e20 7464 2e73 6861        >>> td.sha
+00048c80: 7065 0d0a 2020 2020 2020 2020 746f 7263  pe..        torc
+00048c90: 682e 5369 7a65 285b 312c 2035 5d29 0d0a  h.Size([1, 5])..
+00048ca0: 2020 2020 2020 2020 3e3e 3e20 7464 2e67          >>> td.g
+00048cb0: 6574 2822 6869 6464 656e 2229 2e61 6273  et("hidden").abs
+00048cc0: 2829 2e73 756d 2829 0d0a 2020 2020 2020  ().sum()..      
+00048cd0: 2020 7465 6e73 6f72 2833 372e 3033 3434    tensor(37.0344
+00048ce0: 290d 0a20 2020 2022 2222 0d0a 0d0a 2020  )..    """....  
+00048cf0: 2020 696e 7665 7274 6962 6c65 203d 2046    invertible = F
+00048d00: 616c 7365 0d0a 0d0a 2020 2020 6465 6620  alse....    def 
+00048d10: 5f5f 696e 6974 5f5f 280d 0a20 2020 2020  __init__(..     
+00048d20: 2020 2073 656c 662c 0d0a 2020 2020 2020     self,..      
+00048d30: 2020 6d6f 6475 6c65 733a 2053 6571 7565    modules: Seque
+00048d40: 6e63 655b 5465 6e73 6f72 4469 6374 4d6f  nce[TensorDictMo
+00048d50: 6475 6c65 4261 7365 5d2c 0d0a 2020 2020  duleBase],..    
+00048d60: 2020 2020 6275 726e 5f69 6e3a 2069 6e74      burn_in: int
+00048d70: 2c0d 0a20 2020 2020 2020 206f 7574 5f6b  ,..        out_k
+00048d80: 6579 733a 2053 6571 7565 6e63 655b 4e65  eys: Sequence[Ne
+00048d90: 7374 6564 4b65 795d 207c 204e 6f6e 6520  stedKey] | None 
+00048da0: 3d20 4e6f 6e65 2c0d 0a20 2020 2029 3a0d  = None,..    ):.
+00048db0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00048dc0: 6973 696e 7374 616e 6365 286d 6f64 756c  isinstance(modul
+00048dd0: 6573 2c20 5365 7175 656e 6365 293a 0d0a  es, Sequence):..
+00048de0: 2020 2020 2020 2020 2020 2020 6d6f 6475              modu
+00048df0: 6c65 7320 3d20 5b6d 6f64 756c 6573 5d0d  les = [modules].
+00048e00: 0a0d 0a20 2020 2020 2020 2066 6f72 206d  ...        for m
+00048e10: 6f64 756c 6520 696e 206d 6f64 756c 6573  odule in modules
+00048e20: 3a0d 0a20 2020 2020 2020 2020 2020 2069  :..            i
+00048e30: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
+00048e40: 286d 6f64 756c 652c 2054 656e 736f 7244  (module, TensorD
+00048e50: 6963 744d 6f64 756c 6542 6173 6529 3a0d  ictModuleBase):.
+00048e60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00048e70: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00048e80: 7228 0d0a 2020 2020 2020 2020 2020 2020  r(..            
+00048e90: 2020 2020 2020 2020 6622 416c 6c20 6d6f          f"All mo
+00048ea0: 6475 6c65 7320 6d75 7374 2062 6520 5465  dules must be Te
+00048eb0: 6e73 6f72 4469 6374 4d6f 6475 6c65 732c  nsorDictModules,
+00048ec0: 2062 7574 2061 207b 7479 7065 286d 6f64   but a {type(mod
+00048ed0: 756c 6529 7d20 7761 7320 7072 6f76 6964  ule)} was provid
+00048ee0: 6564 2e22 0d0a 2020 2020 2020 2020 2020  ed."..          
+00048ef0: 2020 2020 2020 290d 0a0d 0a20 2020 2020        )....     
+00048f00: 2020 2069 6e5f 6b65 7973 203d 2073 6574     in_keys = set
+00048f10: 2829 0d0a 2020 2020 2020 2020 666f 7220  ()..        for 
+00048f20: 6d6f 6475 6c65 2069 6e20 6d6f 6475 6c65  module in module
+00048f30: 733a 0d0a 2020 2020 2020 2020 2020 2020  s:..            
+00048f40: 696e 5f6b 6579 732e 7570 6461 7465 286d  in_keys.update(m
+00048f50: 6f64 756c 652e 696e 5f6b 6579 7329 0d0a  odule.in_keys)..
+00048f60: 0d0a 2020 2020 2020 2020 6966 206f 7574  ..        if out
+00048f70: 5f6b 6579 7320 6973 204e 6f6e 653a 0d0a  _keys is None:..
+00048f80: 2020 2020 2020 2020 2020 2020 6f75 745f              out_
+00048f90: 6b65 7973 203d 2073 6574 2829 0d0a 2020  keys = set()..  
+00048fa0: 2020 2020 2020 2020 2020 666f 7220 6d6f            for mo
+00048fb0: 6475 6c65 2069 6e20 6d6f 6475 6c65 733a  dule in modules:
+00048fc0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00048fd0: 2020 666f 7220 6b65 7920 696e 206d 6f64    for key in mod
+00048fe0: 756c 652e 6f75 745f 6b65 7973 3a0d 0a20  ule.out_keys:.. 
+00048ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049000: 2020 2069 6620 6b65 795b 305d 203d 3d20     if key[0] == 
+00049010: 226e 6578 7422 3a0d 0a20 2020 2020 2020  "next":..       
+00049020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049030: 206f 7574 5f6b 6579 732e 6164 6428 6b65   out_keys.add(ke
+00049040: 795b 315d 290d 0a20 2020 2020 2020 2065  y[1])..        e
+00049050: 6c73 653a 0d0a 2020 2020 2020 2020 2020  lse:..          
+00049060: 2020 6f75 745f 6b65 7973 5f20 3d20 7365    out_keys_ = se
+00049070: 7428 290d 0a20 2020 2020 2020 2020 2020  t()..           
+00049080: 2066 6f72 206b 6579 2069 6e20 6f75 745f   for key in out_
+00049090: 6b65 7973 3a0d 0a20 2020 2020 2020 2020  keys:..         
+000490a0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+000490b0: 616e 6365 286b 6579 2c20 7475 706c 6529  ance(key, tuple)
+000490c0: 2061 6e64 206b 6579 5b30 5d20 3d3d 2022   and key[0] == "
+000490d0: 6e65 7874 223a 0d0a 2020 2020 2020 2020  next":..        
+000490e0: 2020 2020 2020 2020 2020 2020 6b65 7920              key 
+000490f0: 3d20 6b65 795b 315d 0d0a 2020 2020 2020  = key[1]..      
+00049100: 2020 2020 2020 2020 2020 2020 2020 7761                wa
+00049110: 726e 696e 6773 2e77 6172 6e28 0d0a 2020  rnings.warn(..  
+00049120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049130: 2020 2020 2020 6622 5468 6520 276e 6578        f"The 'nex
+00049140: 7427 206b 6579 2069 7320 6e6f 7420 6e65  t' key is not ne
+00049150: 6564 6564 2069 6e20 7468 6520 4275 726e  eded in the Burn
+00049160: 496e 5472 616e 7366 6f72 6d20 606f 7574  InTransform `out
+00049170: 5f6b 6579 6020 7b6b 6579 7d20 616e 6420  _key` {key} and 
+00049180: 220d 0a20 2020 2020 2020 2020 2020 2020  "..             
+00049190: 2020 2020 2020 2020 2020 2066 2277 696c             f"wil
+000491a0: 6c20 6265 2069 676e 6f72 6564 2e20 5468  l be ignored. Th
+000491b0: 6973 2074 7261 6e73 666f 726d 2061 6c72  is transform alr
+000491c0: 6561 6479 2061 7373 756d 6573 2074 6861  eady assumes tha
+000491d0: 7420 606f 7574 5f6b 6579 7360 2077 696c  t `out_keys` wil
+000491e0: 6c20 6265 2022 0d0a 2020 2020 2020 2020  l be "..        
+000491f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049200: 6622 7265 7472 6965 7665 6420 6672 6f6d  f"retrieved from
+00049210: 2074 6865 206e 6578 7420 7469 6d65 2073   the next time s
+00049220: 7465 7020 6f66 2074 6865 2062 7572 6e74  tep of the burnt
+00049230: 2d69 6e20 6461 7461 2e22 0d0a 2020 2020  -in data."..    
+00049240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049250: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+00049260: 2020 206f 7574 5f6b 6579 735f 2e61 6464     out_keys_.add
+00049270: 286b 6579 290d 0a20 2020 2020 2020 2020  (key)..         
+00049280: 2020 206f 7574 5f6b 6579 7320 3d20 6f75     out_keys = ou
+00049290: 745f 6b65 7973 5f0d 0a0d 0a20 2020 2020  t_keys_....     
+000492a0: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
+000492b0: 745f 5f28 696e 5f6b 6579 733d 696e 5f6b  t__(in_keys=in_k
+000492c0: 6579 732c 206f 7574 5f6b 6579 733d 6f75  eys, out_keys=ou
+000492d0: 745f 6b65 7973 290d 0a20 2020 2020 2020  t_keys)..       
+000492e0: 2073 656c 662e 6d6f 6475 6c65 7320 3d20   self.modules = 
+000492f0: 6d6f 6475 6c65 730d 0a20 2020 2020 2020  modules..       
+00049300: 2073 656c 662e 6275 726e 5f69 6e20 3d20   self.burn_in = 
+00049310: 6275 726e 5f69 6e0d 0a0d 0a20 2020 2064  burn_in....    d
+00049320: 6566 205f 6361 6c6c 2873 656c 662c 2074  ef _call(self, t
+00049330: 656e 736f 7264 6963 743a 2054 656e 736f  ensordict: Tenso
+00049340: 7244 6963 7442 6173 6529 202d 3e20 5465  rDictBase) -> Te
+00049350: 6e73 6f72 4469 6374 4261 7365 3a0d 0a20  nsorDictBase:.. 
+00049360: 2020 2020 2020 2072 6169 7365 2052 756e         raise Run
+00049370: 7469 6d65 4572 726f 7228 2242 7572 6e49  timeError("BurnI
+00049380: 6e54 7261 6e73 666f 726d 2063 616e 206f  nTransform can o
+00049390: 6e6c 7920 6265 2061 7070 656e 6465 6420  nly be appended 
+000493a0: 746f 2061 2052 6570 6c61 7942 7566 6665  to a ReplayBuffe
+000493b0: 7222 290d 0a0d 0a20 2020 2064 6566 205f  r")....    def _
+000493c0: 7374 6570 280d 0a20 2020 2020 2020 2073  step(..        s
+000493d0: 656c 662c 2074 656e 736f 7264 6963 743a  elf, tensordict:
+000493e0: 2054 656e 736f 7244 6963 7442 6173 652c   TensorDictBase,
+000493f0: 206e 6578 745f 7465 6e73 6f72 6469 6374   next_tensordict
+00049400: 3a20 5465 6e73 6f72 4469 6374 4261 7365  : TensorDictBase
+00049410: 0d0a 2020 2020 2920 2d3e 2054 656e 736f  ..    ) -> Tenso
+00049420: 7244 6963 7442 6173 653a 0d0a 2020 2020  rDictBase:..    
+00049430: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
+00049440: 6545 7272 6f72 2822 4275 726e 496e 5472  eError("BurnInTr
+00049450: 616e 7366 6f72 6d20 6361 6e20 6f6e 6c79  ansform can only
+00049460: 2062 6520 6170 7065 6e64 6564 2074 6f20   be appended to 
+00049470: 6120 5265 706c 6179 4275 6666 6572 2e22  a ReplayBuffer."
+00049480: 290d 0a0d 0a20 2020 2064 6566 2066 6f72  )....    def for
+00049490: 7761 7264 2873 656c 662c 2074 656e 736f  ward(self, tenso
+000494a0: 7264 6963 743a 2054 656e 736f 7244 6963  rdict: TensorDic
+000494b0: 7442 6173 6529 202d 3e20 5465 6e73 6f72  tBase) -> Tensor
+000494c0: 4469 6374 4261 7365 3a0d 0a0d 0a20 2020  DictBase:....   
+000494d0: 2020 2020 2069 6620 7365 6c66 2e62 7572       if self.bur
+000494e0: 6e5f 696e 203d 3d20 303a 0d0a 2020 2020  n_in == 0:..    
+000494f0: 2020 2020 2020 2020 7265 7475 726e 2074          return t
+00049500: 656e 736f 7264 6963 740d 0a0d 0a20 2020  ensordict....   
+00049510: 2020 2020 2074 645f 6465 7669 6365 203d       td_device =
+00049520: 2074 656e 736f 7264 6963 742e 6465 7669   tensordict.devi
+00049530: 6365 0d0a 2020 2020 2020 2020 422c 2054  ce..        B, T
+00049540: 2c20 2a65 7874 7261 5f64 696d 7320 3d20  , *extra_dims = 
+00049550: 7465 6e73 6f72 6469 6374 2e62 6174 6368  tensordict.batch
+00049560: 5f73 697a 650d 0a0d 0a20 2020 2020 2020  _size....       
+00049570: 2023 2053 706c 6974 2074 6865 2074 656e   # Split the ten
+00049580: 736f 7220 6469 6374 2069 6e74 6f20 6275  sor dict into bu
+00049590: 726e 2d69 6e20 6461 7461 2061 6e64 2074  rn-in data and t
+000495a0: 6865 2072 6573 742e 0d0a 2020 2020 2020  he rest...      
+000495b0: 2020 7464 5f62 7572 6e5f 696e 203d 2074    td_burn_in = t
+000495c0: 656e 736f 7264 6963 745b 2e2e 2e2c 203a  ensordict[..., :
+000495d0: 2073 656c 662e 6275 726e 5f69 6e5d 0d0a   self.burn_in]..
+000495e0: 2020 2020 2020 2020 7464 5f6f 7574 203d          td_out =
+000495f0: 2074 656e 736f 7264 6963 745b 2e2e 2e2c   tensordict[...,
+00049600: 2073 656c 662e 6275 726e 5f69 6e20 3a5d   self.burn_in :]
+00049610: 0d0a 0d0a 2020 2020 2020 2020 2320 4275  ....        # Bu
+00049620: 726e 2069 6e20 7468 6520 7265 6375 7272  rn in the recurr
+00049630: 656e 7420 7374 6174 652e 0d0a 2020 2020  ent state...    
+00049640: 2020 2020 7769 7468 2074 6f72 6368 2e6e      with torch.n
+00049650: 6f5f 6772 6164 2829 3a0d 0a20 2020 2020  o_grad():..     
+00049660: 2020 2020 2020 2066 6f72 206d 6f64 756c         for modul
+00049670: 6520 696e 2073 656c 662e 6d6f 6475 6c65  e in self.module
+00049680: 733a 0d0a 2020 2020 2020 2020 2020 2020  s:..            
+00049690: 2020 2020 6d6f 6475 6c65 5f64 6576 6963      module_devic
+000496a0: 6520 3d20 6e65 7874 286d 6f64 756c 652e  e = next(module.
+000496b0: 7061 7261 6d65 7465 7273 2829 292e 6465  parameters()).de
+000496c0: 7669 6365 206f 7220 4e6f 6e65 0d0a 2020  vice or None..  
+000496d0: 2020 2020 2020 2020 2020 2020 2020 7464                td
+000496e0: 5f62 7572 6e5f 696e 203d 2074 645f 6275  _burn_in = td_bu
+000496f0: 726e 5f69 6e2e 746f 286d 6f64 756c 655f  rn_in.to(module_
+00049700: 6465 7669 6365 290d 0a20 2020 2020 2020  device)..       
+00049710: 2020 2020 2020 2020 2074 645f 6275 726e           td_burn
+00049720: 5f69 6e20 3d20 6d6f 6475 6c65 2874 645f  _in = module(td_
+00049730: 6275 726e 5f69 6e29 0d0a 2020 2020 2020  burn_in)..      
+00049740: 2020 7464 5f62 7572 6e5f 696e 203d 2074    td_burn_in = t
+00049750: 645f 6275 726e 5f69 6e2e 746f 2874 645f  d_burn_in.to(td_
+00049760: 6465 7669 6365 290d 0a0d 0a20 2020 2020  device)....     
+00049770: 2020 2023 2055 7064 6174 6520 6f75 7420     # Update out 
+00049780: 5465 6e73 6f72 4469 6374 2077 6974 6820  TensorDict with 
+00049790: 7468 6520 6275 726e 742d 696e 2064 6174  the burnt-in dat
+000497a0: 612e 0d0a 2020 2020 2020 2020 666f 7220  a...        for 
+000497b0: 6f75 745f 6b65 7920 696e 2073 656c 662e  out_key in self.
+000497c0: 6f75 745f 6b65 7973 3a0d 0a20 2020 2020  out_keys:..     
+000497d0: 2020 2020 2020 2069 6620 6f75 745f 6b65         if out_ke
+000497e0: 7920 6e6f 7420 696e 2074 645f 6f75 742e  y not in td_out.
+000497f0: 6b65 7973 2869 6e63 6c75 6465 5f6e 6573  keys(include_nes
+00049800: 7465 643d 5472 7565 293a 0d0a 2020 2020  ted=True):..    
+00049810: 2020 2020 2020 2020 2020 2020 7464 5f6f              td_o
+00049820: 7574 2e73 6574 280d 0a20 2020 2020 2020  ut.set(..       
+00049830: 2020 2020 2020 2020 2020 2020 206f 7574               out
+00049840: 5f6b 6579 2c0d 0a20 2020 2020 2020 2020  _key,..         
+00049850: 2020 2020 2020 2020 2020 2074 6f72 6368             torch
+00049860: 2e7a 6572 6f73 280d 0a20 2020 2020 2020  .zeros(..       
+00049870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049880: 2042 2c20 5420 2d20 7365 6c66 2e62 7572   B, T - self.bur
+00049890: 6e5f 696e 2c20 2a74 656e 736f 7264 6963  n_in, *tensordic
+000498a0: 742e 6765 7428 6f75 745f 6b65 7929 2e73  t.get(out_key).s
+000498b0: 6861 7065 5b32 3a5d 0d0a 2020 2020 2020  hape[2:]..      
+000498c0: 2020 2020 2020 2020 2020 2020 2020 292c                ),
+000498d0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000498e0: 2020 290d 0a20 2020 2020 2020 2020 2020    )..           
+000498f0: 2074 645f 6f75 745b 2e2e 2e2c 2030 5d5b   td_out[..., 0][
+00049900: 6f75 745f 6b65 795d 2e63 6f70 795f 2874  out_key].copy_(t
+00049910: 645f 6275 726e 5f69 6e5b 226e 6578 7422  d_burn_in["next"
+00049920: 5d5b 2e2e 2e2c 202d 315d 5b6f 7574 5f6b  ][..., -1][out_k
+00049930: 6579 5d29 0d0a 0d0a 2020 2020 2020 2020  ey])....        
+00049940: 7265 7475 726e 2074 645f 6f75 740d 0a0d  return td_out...
+00049950: 0a20 2020 2064 6566 205f 5f72 6570 725f  .    def __repr_
+00049960: 5f28 7365 6c66 2920 2d3e 2073 7472 3a0d  _(self) -> str:.
+00049970: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00049980: 6622 7b73 656c 662e 5f5f 636c 6173 735f  f"{self.__class_
+00049990: 5f2e 5f5f 6e61 6d65 5f5f 7d28 6275 726e  _.__name__}(burn
+000499a0: 5f69 6e3d 7b73 656c 662e 6275 726e 5f69  _in={self.burn_i
+000499b0: 6e7d 2c20 696e 5f6b 6579 733d 7b73 656c  n}, in_keys={sel
+000499c0: 662e 696e 5f6b 6579 737d 2c20 6f75 745f  f.in_keys}, out_
+000499d0: 6b65 7973 3d7b 7365 6c66 2e6f 7574 5f6b  keys={self.out_k
+000499e0: 6579 737d 2922 0d0a 0d0a 0d0a 636c 6173  eys})"......clas
+000499f0: 7320 5369 676e 5472 616e 7366 6f72 6d28  s SignTransform(
+00049a00: 5472 616e 7366 6f72 6d29 3a0d 0a20 2020  Transform):..   
+00049a10: 2022 2222 4120 7472 616e 7366 6f72 6d20   """A transform 
+00049a20: 746f 2063 6f6d 7075 7465 2074 6865 2073  to compute the s
+00049a30: 6967 6e73 206f 6620 5465 6e73 6f72 4469  igns of TensorDi
+00049a40: 6374 2076 616c 7565 732e 0d0a 0d0a 2020  ct values.....  
+00049a50: 2020 5468 6973 2074 7261 6e73 666f 726d    This transform
+00049a60: 2072 6561 6473 2074 6865 2074 656e 736f   reads the tenso
+00049a70: 7273 2069 6e20 6060 696e 5f6b 6579 7360  rs in ``in_keys`
+00049a80: 6020 616e 6420 6060 696e 5f6b 6579 735f  ` and ``in_keys_
+00049a90: 696e 7660 602c 2063 6f6d 7075 7465 7320  inv``, computes 
+00049aa0: 7468 650d 0a20 2020 2073 6967 6e73 206f  the..    signs o
+00049ab0: 6620 7468 6569 7220 656c 656d 656e 7473  f their elements
+00049ac0: 2061 6e64 2077 7269 7465 7320 7468 6520   and writes the 
+00049ad0: 7265 7375 6c74 696e 6720 7369 676e 2074  resulting sign t
+00049ae0: 656e 736f 7273 2074 6f20 6060 6f75 745f  ensors to ``out_
+00049af0: 6b65 7973 6060 2061 6e64 0d0a 2020 2020  keys`` and..    
+00049b00: 6060 6f75 745f 6b65 7973 5f69 6e76 6060  ``out_keys_inv``
+00049b10: 2072 6573 7065 6374 6976 656c 792e 0d0a   respectively...
+00049b20: 0d0a 2020 2020 4172 6773 3a0d 0a20 2020  ..    Args:..   
+00049b30: 2020 2020 2069 6e5f 6b65 7973 2028 6c69       in_keys (li
+00049b40: 7374 206f 6620 4e65 7374 6564 4b65 7973  st of NestedKeys
+00049b50: 293a 2069 6e70 7574 2065 6e74 7269 6573  ): input entries
+00049b60: 2028 7265 6164 290d 0a20 2020 2020 2020   (read)..       
+00049b70: 206f 7574 5f6b 6579 7320 286c 6973 7420   out_keys (list 
+00049b80: 6f66 204e 6573 7465 644b 6579 7329 3a20  of NestedKeys): 
+00049b90: 696e 7075 7420 656e 7472 6965 7320 2877  input entries (w
+00049ba0: 7269 7465 290d 0a20 2020 2020 2020 2069  rite)..        i
+00049bb0: 6e5f 6b65 7973 5f69 6e76 2028 6c69 7374  n_keys_inv (list
+00049bc0: 206f 6620 4e65 7374 6564 4b65 7973 293a   of NestedKeys):
+00049bd0: 2069 6e70 7574 2065 6e74 7269 6573 2028   input entries (
+00049be0: 7265 6164 2920 6475 7269 6e67 203a 6d65  read) during :me
+00049bf0: 7468 3a60 7e2e 696e 7660 2063 616c 6c73  th:`~.inv` calls
+00049c00: 2e0d 0a20 2020 2020 2020 206f 7574 5f6b  ...        out_k
+00049c10: 6579 735f 696e 7620 286c 6973 7420 6f66  eys_inv (list of
+00049c20: 204e 6573 7465 644b 6579 7329 3a20 696e   NestedKeys): in
+00049c30: 7075 7420 656e 7472 6965 7320 2877 7269  put entries (wri
+00049c40: 7465 2920 6475 7269 6e67 203a 6d65 7468  te) during :meth
+00049c50: 3a60 7e2e 696e 7660 2063 616c 6c73 2e0d  :`~.inv` calls..
+00049c60: 0a0d 0a20 2020 2045 7861 6d70 6c65 733a  ...    Examples:
+00049c70: 0d0a 2020 2020 2020 2020 3e3e 3e20 6672  ..        >>> fr
+00049c80: 6f6d 2074 6f72 6368 726c 2e65 6e76 7320  om torchrl.envs 
+00049c90: 696d 706f 7274 2047 796d 456e 762c 2054  import GymEnv, T
+00049ca0: 7261 6e73 666f 726d 6564 456e 762c 2053  ransformedEnv, S
+00049cb0: 6967 6e54 7261 6e73 666f 726d 0d0a 2020  ignTransform..  
+00049cc0: 2020 2020 2020 3e3e 3e20 6261 7365 5f65        >>> base_e
+00049cd0: 6e76 203d 2047 796d 456e 7628 2250 656e  nv = GymEnv("Pen
+00049ce0: 6475 6c75 6d2d 7631 2229 0d0a 2020 2020  dulum-v1")..    
+00049cf0: 2020 2020 3e3e 3e20 656e 7620 3d20 5472      >>> env = Tr
+00049d00: 616e 7366 6f72 6d65 6445 6e76 2862 6173  ansformedEnv(bas
+00049d10: 655f 656e 762c 2053 6967 6e54 7261 6e73  e_env, SignTrans
+00049d20: 666f 726d 2869 6e5f 6b65 7973 3d5b 276f  form(in_keys=['o
+00049d30: 6273 6572 7661 7469 6f6e 275d 2929 0d0a  bservation']))..
+00049d40: 2020 2020 2020 2020 3e3e 3e20 7220 3d20          >>> r = 
+00049d50: 656e 762e 726f 6c6c 6f75 7428 3130 3029  env.rollout(100)
+00049d60: 0d0a 2020 2020 2020 2020 3e3e 3e20 6f62  ..        >>> ob
+00049d70: 7320 3d20 725b 226f 6273 6572 7661 7469  s = r["observati
+00049d80: 6f6e 225d 0d0a 2020 2020 2020 2020 3e3e  on"]..        >>
+00049d90: 3e20 6173 7365 7274 2028 746f 7263 682e  > assert (torch.
+00049da0: 6c6f 6769 6361 6c5f 6f72 2874 6f72 6368  logical_or(torch
+00049db0: 2e6c 6f67 6963 616c 5f6f 7228 6f62 7320  .logical_or(obs 
+00049dc0: 3d3d 202d 312c 206f 6273 203d 3d20 3129  == -1, obs == 1)
+00049dd0: 2c20 6f62 7320 3d3d 2030 2e30 2929 2e61  , obs == 0.0)).a
+00049de0: 6c6c 2829 0d0a 2020 2020 2222 220d 0a0d  ll()..    """...
+00049df0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00049e00: 5f28 0d0a 2020 2020 2020 2020 7365 6c66  _(..        self
+00049e10: 2c0d 0a20 2020 2020 2020 2069 6e5f 6b65  ,..        in_ke
+00049e20: 7973 3d4e 6f6e 652c 0d0a 2020 2020 2020  ys=None,..      
+00049e30: 2020 6f75 745f 6b65 7973 3d4e 6f6e 652c    out_keys=None,
+00049e40: 0d0a 2020 2020 2020 2020 696e 5f6b 6579  ..        in_key
+00049e50: 735f 696e 763d 4e6f 6e65 2c0d 0a20 2020  s_inv=None,..   
+00049e60: 2020 2020 206f 7574 5f6b 6579 735f 696e       out_keys_in
+00049e70: 763d 4e6f 6e65 2c0d 0a20 2020 2029 3a0d  v=None,..    ):.
+00049e80: 0a20 2020 2020 2020 2069 6620 696e 5f6b  .        if in_k
+00049e90: 6579 7320 6973 204e 6f6e 653a 0d0a 2020  eys is None:..  
+00049ea0: 2020 2020 2020 2020 2020 696e 5f6b 6579            in_key
+00049eb0: 7320 3d20 5b5d 0d0a 2020 2020 2020 2020  s = []..        
+00049ec0: 6966 206f 7574 5f6b 6579 7320 6973 204e  if out_keys is N
+00049ed0: 6f6e 653a 0d0a 2020 2020 2020 2020 2020  one:..          
+00049ee0: 2020 6f75 745f 6b65 7973 203d 2063 6f70    out_keys = cop
+00049ef0: 7928 696e 5f6b 6579 7329 0d0a 2020 2020  y(in_keys)..    
+00049f00: 2020 2020 6966 2069 6e5f 6b65 7973 5f69      if in_keys_i
+00049f10: 6e76 2069 7320 4e6f 6e65 3a0d 0a20 2020  nv is None:..   
+00049f20: 2020 2020 2020 2020 2069 6e5f 6b65 7973           in_keys
+00049f30: 5f69 6e76 203d 205b 5d0d 0a20 2020 2020  _inv = []..     
+00049f40: 2020 2069 6620 6f75 745f 6b65 7973 5f69     if out_keys_i
+00049f50: 6e76 2069 7320 4e6f 6e65 3a0d 0a20 2020  nv is None:..   
+00049f60: 2020 2020 2020 2020 206f 7574 5f6b 6579           out_key
+00049f70: 735f 696e 7620 3d20 636f 7079 2869 6e5f  s_inv = copy(in_
+00049f80: 6b65 7973 5f69 6e76 290d 0a20 2020 2020  keys_inv)..     
+00049f90: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
+00049fa0: 745f 5f28 696e 5f6b 6579 732c 206f 7574  t__(in_keys, out
+00049fb0: 5f6b 6579 732c 2069 6e5f 6b65 7973 5f69  _keys, in_keys_i
+00049fc0: 6e76 2c20 6f75 745f 6b65 7973 5f69 6e76  nv, out_keys_inv
+00049fd0: 290d 0a0d 0a20 2020 2064 6566 205f 6170  )....    def _ap
+00049fe0: 706c 795f 7472 616e 7366 6f72 6d28 7365  ply_transform(se
+00049ff0: 6c66 2c20 6f62 733a 2074 6f72 6368 2e54  lf, obs: torch.T
+0004a000: 656e 736f 7229 202d 3e20 746f 7263 682e  ensor) -> torch.
+0004a010: 5465 6e73 6f72 3a0d 0a20 2020 2020 2020  Tensor:..       
+0004a020: 2072 6574 7572 6e20 6f62 732e 7369 676e   return obs.sign
+0004a030: 2829 0d0a 0d0a 2020 2020 6465 6620 5f69  ()....    def _i
+0004a040: 6e76 5f61 7070 6c79 5f74 7261 6e73 666f  nv_apply_transfo
+0004a050: 726d 2873 656c 662c 2073 7461 7465 3a20  rm(self, state: 
+0004a060: 746f 7263 682e 5465 6e73 6f72 2920 2d3e  torch.Tensor) ->
+0004a070: 2074 6f72 6368 2e54 656e 736f 723a 0d0a   torch.Tensor:..
+0004a080: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0004a090: 7461 7465 2e73 6967 6e28 290d 0a0d 0a20  tate.sign().... 
+0004a0a0: 2020 2040 5f61 7070 6c79 5f74 6f5f 636f     @_apply_to_co
+0004a0b0: 6d70 6f73 6974 650d 0a20 2020 2064 6566  mposite..    def
+0004a0c0: 2074 7261 6e73 666f 726d 5f6f 6273 6572   transform_obser
+0004a0d0: 7661 7469 6f6e 5f73 7065 6328 7365 6c66  vation_spec(self
+0004a0e0: 2c20 6f62 7365 7276 6174 696f 6e5f 7370  , observation_sp
+0004a0f0: 6563 3a20 5465 6e73 6f72 5370 6563 2920  ec: TensorSpec) 
+0004a100: 2d3e 2054 656e 736f 7253 7065 633a 0d0a  -> TensorSpec:..
+0004a110: 2020 2020 2020 2020 7265 7475 726e 2042          return B
+0004a120: 6f75 6e64 6564 5465 6e73 6f72 5370 6563  oundedTensorSpec
+0004a130: 280d 0a20 2020 2020 2020 2020 2020 2073  (..            s
+0004a140: 6861 7065 3d6f 6273 6572 7661 7469 6f6e  hape=observation
+0004a150: 5f73 7065 632e 7368 6170 652c 0d0a 2020  _spec.shape,..  
+0004a160: 2020 2020 2020 2020 2020 6465 7669 6365            device
+0004a170: 3d6f 6273 6572 7661 7469 6f6e 5f73 7065  =observation_spe
+0004a180: 632e 6465 7669 6365 2c0d 0a20 2020 2020  c.device,..     
+0004a190: 2020 2020 2020 2064 7479 7065 3d6f 6273         dtype=obs
+0004a1a0: 6572 7661 7469 6f6e 5f73 7065 632e 6474  ervation_spec.dt
+0004a1b0: 7970 652c 0d0a 2020 2020 2020 2020 2020  ype,..          
+0004a1c0: 2020 6869 6768 3d31 2e30 2c0d 0a20 2020    high=1.0,..   
+0004a1d0: 2020 2020 2020 2020 206c 6f77 3d2d 312e           low=-1.
+0004a1e0: 302c 0d0a 2020 2020 2020 2020 290d 0a0d  0,..        )...
+0004a1f0: 0a20 2020 2064 6566 2074 7261 6e73 666f  .    def transfo
+0004a200: 726d 5f72 6577 6172 645f 7370 6563 2873  rm_reward_spec(s
+0004a210: 656c 662c 2072 6577 6172 645f 7370 6563  elf, reward_spec
+0004a220: 3a20 5465 6e73 6f72 5370 6563 2920 2d3e  : TensorSpec) ->
+0004a230: 2054 656e 736f 7253 7065 633a 0d0a 2020   TensorSpec:..  
+0004a240: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
+0004a250: 2073 656c 662e 696e 5f6b 6579 733a 0d0a   self.in_keys:..
+0004a260: 2020 2020 2020 2020 2020 2020 6966 206b              if k
+0004a270: 6579 2069 6e20 7365 6c66 2e70 6172 656e  ey in self.paren
+0004a280: 742e 7265 7761 7264 5f6b 6579 733a 0d0a  t.reward_keys:..
+0004a290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a2a0: 7370 6563 203d 2073 656c 662e 7061 7265  spec = self.pare
+0004a2b0: 6e74 2e6f 7574 7075 745f 7370 6563 5b22  nt.output_spec["
+0004a2c0: 6675 6c6c 5f72 6577 6172 645f 7370 6563  full_reward_spec
+0004a2d0: 225d 5b6b 6579 5d0d 0a20 2020 2020 2020  "][key]..       
+0004a2e0: 2020 2020 2020 2020 2073 656c 662e 7061           self.pa
+0004a2f0: 7265 6e74 2e6f 7574 7075 745f 7370 6563  rent.output_spec
+0004a300: 5b22 6675 6c6c 5f72 6577 6172 645f 7370  ["full_reward_sp
+0004a310: 6563 225d 5b6b 6579 5d20 3d20 426f 756e  ec"][key] = Boun
+0004a320: 6465 6454 656e 736f 7253 7065 6328 0d0a  dedTensorSpec(..
+0004a330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a340: 2020 2020 7368 6170 653d 7370 6563 2e73      shape=spec.s
+0004a350: 6861 7065 2c0d 0a20 2020 2020 2020 2020  hape,..         
+0004a360: 2020 2020 2020 2020 2020 2064 6576 6963             devic
+0004a370: 653d 7370 6563 2e64 6576 6963 652c 0d0a  e=spec.device,..
+0004a380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a390: 2020 2020 6474 7970 653d 7370 6563 2e64      dtype=spec.d
+0004a3a0: 7479 7065 2c0d 0a20 2020 2020 2020 2020  type,..         
+0004a3b0: 2020 2020 2020 2020 2020 2068 6967 683d             high=
+0004a3c0: 312e 302c 0d0a 2020 2020 2020 2020 2020  1.0,..          
+0004a3d0: 2020 2020 2020 2020 2020 6c6f 773d 2d31            low=-1
+0004a3e0: 2e30 2c0d 0a20 2020 2020 2020 2020 2020  .0,..           
+0004a3f0: 2020 2020 2029 0d0a 2020 2020 2020 2020       )..        
+0004a400: 7265 7475 726e 2073 656c 662e 7061 7265  return self.pare
+0004a410: 6e74 2e6f 7574 7075 745f 7370 6563 5b22  nt.output_spec["
+0004a420: 6675 6c6c 5f72 6577 6172 645f 7370 6563  full_reward_spec
+0004a430: 225d 0d0a 0d0a 2020 2020 6465 6620 5f72  "]....    def _r
+0004a440: 6573 6574 280d 0a20 2020 2020 2020 2073  eset(..        s
+0004a450: 656c 662c 2074 656e 736f 7264 6963 743a  elf, tensordict:
+0004a460: 2054 656e 736f 7244 6963 7442 6173 652c   TensorDictBase,
+0004a470: 2074 656e 736f 7264 6963 745f 7265 7365   tensordict_rese
+0004a480: 743a 2054 656e 736f 7244 6963 7442 6173  t: TensorDictBas
+0004a490: 650d 0a20 2020 2029 202d 3e20 5465 6e73  e..    ) -> Tens
+0004a4a0: 6f72 4469 6374 4261 7365 3a0d 0a20 2020  orDictBase:..   
+0004a4b0: 2020 2020 2077 6974 6820 5f73 6574 5f6d       with _set_m
+0004a4c0: 6973 7369 6e67 5f74 6f6c 6572 616e 6365  issing_tolerance
+0004a4d0: 2873 656c 662c 2054 7275 6529 3a0d 0a20  (self, True):.. 
+0004a4e0: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
+0004a4f0: 7264 6963 745f 7265 7365 7420 3d20 7365  rdict_reset = se
+0004a500: 6c66 2e5f 6361 6c6c 2874 656e 736f 7264  lf._call(tensord
+0004a510: 6963 745f 7265 7365 7429 0d0a 2020 2020  ict_reset)..    
+0004a520: 2020 2020 7265 7475 726e 2074 656e 736f      return tenso
+0004a530: 7264 6963 745f 7265 7365 740d 0a0d 0a0d  rdict_reset.....
+0004a540: 0a63 6c61 7373 2052 656d 6f76 6545 6d70  .class RemoveEmp
+0004a550: 7479 5370 6563 7328 5472 616e 7366 6f72  tySpecs(Transfor
+0004a560: 6d29 3a0d 0a20 2020 2022 2222 5265 6d6f  m):..    """Remo
+0004a570: 7665 7320 656d 7074 7920 7370 6563 7320  ves empty specs 
+0004a580: 616e 6420 636f 6e74 656e 7420 6672 6f6d  and content from
+0004a590: 2061 6e20 656e 7669 726f 6e6d 656e 742e   an environment.
+0004a5a0: 0d0a 0d0a 2020 2020 4578 616d 706c 6573  ....    Examples
+0004a5b0: 3a0d 0a20 2020 2020 2020 203e 3e3e 2069  :..        >>> i
+0004a5c0: 6d70 6f72 7420 746f 7263 680d 0a20 2020  mport torch..   
+0004a5d0: 2020 2020 203e 3e3e 2066 726f 6d20 7465       >>> from te
+0004a5e0: 6e73 6f72 6469 6374 2069 6d70 6f72 7420  nsordict import 
+0004a5f0: 5465 6e73 6f72 4469 6374 0d0a 2020 2020  TensorDict..    
+0004a600: 2020 2020 3e3e 3e20 6672 6f6d 2074 6f72      >>> from tor
+0004a610: 6368 726c 2e64 6174 6120 696d 706f 7274  chrl.data import
+0004a620: 2055 6e62 6f75 6e64 6564 436f 6e74 696e   UnboundedContin
+0004a630: 756f 7573 5465 6e73 6f72 5370 6563 2c20  uousTensorSpec, 
+0004a640: 436f 6d70 6f73 6974 6553 7065 632c 205c  CompositeSpec, \
+0004a650: 0d0a 2020 2020 2020 2020 2e2e 2e20 2020  ..        ...   
+0004a660: 2020 4469 7363 7265 7465 5465 6e73 6f72    DiscreteTensor
+0004a670: 5370 6563 0d0a 2020 2020 2020 2020 3e3e  Spec..        >>
+0004a680: 3e20 6672 6f6d 2074 6f72 6368 726c 2e65  > from torchrl.e
+0004a690: 6e76 7320 696d 706f 7274 2045 6e76 4261  nvs import EnvBa
+0004a6a0: 7365 2c20 5472 616e 7366 6f72 6d65 6445  se, TransformedE
+0004a6b0: 6e76 2c20 5265 6d6f 7665 456d 7074 7953  nv, RemoveEmptyS
+0004a6c0: 7065 6373 0d0a 2020 2020 2020 2020 3e3e  pecs..        >>
+0004a6d0: 3e0d 0a20 2020 2020 2020 203e 3e3e 0d0a  >..        >>>..
+0004a6e0: 2020 2020 2020 2020 3e3e 3e20 636c 6173          >>> clas
+0004a6f0: 7320 4475 6d6d 7945 6e76 2845 6e76 4261  s DummyEnv(EnvBa
+0004a700: 7365 293a 0d0a 2020 2020 2020 2020 2e2e  se):..        ..
+0004a710: 2e20 2020 2020 6465 6620 5f5f 696e 6974  .     def __init
+0004a720: 5f5f 2873 656c 662c 202a 6172 6773 2c20  __(self, *args, 
+0004a730: 2a2a 6b77 6172 6773 293a 0d0a 2020 2020  **kwargs):..    
+0004a740: 2020 2020 2e2e 2e20 2020 2020 2020 2020      ...         
+0004a750: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
+0004a760: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
 0004a770: 290d 0a20 2020 2020 2020 202e 2e2e 2020  )..        ...  
-0004a780: 2020 2020 2020 2073 656c 662e 6675 6c6c         self.full
-0004a790: 5f64 6f6e 655f 7370 6563 5b22 7472 756e  _done_spec["trun
-0004a7a0: 6361 7465 6422 5d20 3d20 7365 6c66 2e66  cated"] = self.f
-0004a7b0: 756c 6c5f 646f 6e65 5f73 7065 635b 0d0a  ull_done_spec[..
-0004a7c0: 2020 2020 2020 2020 2e2e 2e20 2020 2020          ...     
-0004a7d0: 2020 2020 2020 2020 2274 6572 6d69 6e61          "termina
-0004a7e0: 7465 6422 5d2e 636c 6f6e 6528 290d 0a20  ted"].clone().. 
-0004a7f0: 2020 2020 2020 202e 2e2e 2020 2020 2020         ...      
-0004a800: 2020 2073 656c 662e 7265 7761 7264 5f73     self.reward_s
-0004a810: 7065 6320 3d20 436f 6d70 6f73 6974 6553  pec = CompositeS
-0004a820: 7065 6328 0d0a 2020 2020 2020 2020 2e2e  pec(..        ..
-0004a830: 2e20 2020 2020 2020 2020 2020 2020 7265  .             re
-0004a840: 7761 7264 3d55 6e62 6f75 6e64 6564 436f  ward=UnboundedCo
-0004a850: 6e74 696e 756f 7573 5465 6e73 6f72 5370  ntinuousTensorSp
-0004a860: 6563 282a 7365 6c66 2e62 6174 6368 5f73  ec(*self.batch_s
-0004a870: 697a 652c 2031 292c 0d0a 2020 2020 2020  ize, 1),..      
-0004a880: 2020 2e2e 2e20 2020 2020 2020 2020 2020    ...           
-0004a890: 2020 6f74 6865 725f 7265 7761 7264 3d43    other_reward=C
-0004a8a0: 6f6d 706f 7369 7465 5370 6563 2873 6861  ompositeSpec(sha
-0004a8b0: 7065 3d73 656c 662e 6261 7463 685f 7369  pe=self.batch_si
-0004a8c0: 7a65 292c 0d0a 2020 2020 2020 2020 2e2e  ze),..        ..
-0004a8d0: 2e20 2020 2020 2020 2020 2020 2020 7368  .             sh
-0004a8e0: 6170 653d 7365 6c66 2e62 6174 6368 5f73  ape=self.batch_s
-0004a8f0: 697a 650d 0a20 2020 2020 2020 202e 2e2e  ize..        ...
-0004a900: 2020 2020 2020 2020 2020 2020 2029 0d0a               )..
-0004a910: 2020 2020 2020 2020 2e2e 2e0d 0a20 2020          .....   
-0004a920: 2020 2020 202e 2e2e 2020 2020 2064 6566       ...     def
-0004a930: 205f 7265 7365 7428 7365 6c66 2c20 7465   _reset(self, te
-0004a940: 6e73 6f72 6469 6374 293a 0d0a 2020 2020  nsordict):..    
-0004a950: 2020 2020 2e2e 2e20 2020 2020 2020 2020      ...         
-0004a960: 7265 7475 726e 2073 656c 662e 6f62 7365  return self.obse
-0004a970: 7276 6174 696f 6e5f 7370 6563 2e72 616e  rvation_spec.ran
-0004a980: 6428 292e 7570 6461 7465 2873 656c 662e  d().update(self.
-0004a990: 6675 6c6c 5f64 6f6e 655f 7370 6563 2e7a  full_done_spec.z
-0004a9a0: 6572 6f28 2929 0d0a 2020 2020 2020 2020  ero())..        
-0004a9b0: 2e2e 2e0d 0a20 2020 2020 2020 202e 2e2e  .....        ...
-0004a9c0: 2020 2020 2064 6566 205f 7374 6570 2873       def _step(s
-0004a9d0: 656c 662c 2074 656e 736f 7264 6963 7429  elf, tensordict)
-0004a9e0: 3a0d 0a20 2020 2020 2020 202e 2e2e 2020  :..        ...  
-0004a9f0: 2020 2020 2020 2072 6574 7572 6e20 5465         return Te
-0004aa00: 6e73 6f72 4469 6374 280d 0a20 2020 2020  nsorDict(..     
-0004aa10: 2020 202e 2e2e 2020 2020 2020 2020 2020     ...          
-0004aa20: 2020 207b 7d2c 0d0a 2020 2020 2020 2020     {},..        
-0004aa30: 2e2e 2e20 2020 2020 2020 2020 2020 2020  ...             
-0004aa40: 6261 7463 685f 7369 7a65 3d5b 5d0d 0a20  batch_size=[].. 
-0004aa50: 2020 2020 2020 202e 2e2e 2020 2020 2020         ...      
-0004aa60: 2020 2029 2e75 7064 6174 6528 7365 6c66     ).update(self
-0004aa70: 2e6f 6273 6572 7661 7469 6f6e 5f73 7065  .observation_spe
-0004aa80: 632e 7261 6e64 2829 292e 7570 6461 7465  c.rand()).update
-0004aa90: 280d 0a20 2020 2020 2020 202e 2e2e 2020  (..        ...  
-0004aaa0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0004aab0: 6675 6c6c 5f64 6f6e 655f 7370 6563 2e7a  full_done_spec.z
-0004aac0: 6572 6f28 290d 0a20 2020 2020 2020 202e  ero()..        .
-0004aad0: 2e2e 2020 2020 2020 2020 2020 2020 2029  ..             )
-0004aae0: 2e75 7064 6174 6528 7365 6c66 2e66 756c  .update(self.ful
-0004aaf0: 6c5f 7265 7761 7264 5f73 7065 632e 7261  l_reward_spec.ra
-0004ab00: 6e64 2829 290d 0a20 2020 2020 2020 202e  nd())..        .
-0004ab10: 2e2e 0d0a 2020 2020 2020 2020 2e2e 2e20  ....        ... 
-0004ab20: 2020 2020 6465 6620 5f73 6574 5f73 6565      def _set_see
-0004ab30: 6428 7365 6c66 2c20 7365 6564 293a 0d0a  d(self, seed):..
-0004ab40: 2020 2020 2020 2020 2e2e 2e20 2020 2020          ...     
-0004ab50: 2020 2020 7265 7475 726e 2073 6565 6420      return seed 
-0004ab60: 2b20 310d 0a20 2020 2020 2020 203e 3e3e  + 1..        >>>
-0004ab70: 0d0a 2020 2020 2020 2020 3e3e 3e0d 0a20  ..        >>>.. 
-0004ab80: 2020 2020 2020 203e 3e3e 2062 6173 655f         >>> base_
-0004ab90: 656e 7620 3d20 4475 6d6d 7945 6e76 2829  env = DummyEnv()
-0004aba0: 0d0a 2020 2020 2020 2020 3e3e 3e20 7072  ..        >>> pr
-0004abb0: 696e 7428 6261 7365 5f65 6e76 2e72 6f6c  int(base_env.rol
-0004abc0: 6c6f 7574 2832 2929 0d0a 2020 2020 2020  lout(2))..      
-0004abd0: 2020 5465 6e73 6f72 4469 6374 280d 0a20    TensorDict(.. 
-0004abe0: 2020 2020 2020 2020 2020 2066 6965 6c64             field
-0004abf0: 733d 7b0d 0a20 2020 2020 2020 2020 2020  s={..           
-0004ac00: 2020 2020 2061 6374 696f 6e3a 2054 656e       action: Ten
-0004ac10: 736f 7228 7368 6170 653d 746f 7263 682e  sor(shape=torch.
-0004ac20: 5369 7a65 285b 322c 2033 5d29 2c20 6465  Size([2, 3]), de
-0004ac30: 7669 6365 3d63 7075 2c20 6474 7970 653d  vice=cpu, dtype=
-0004ac40: 746f 7263 682e 666c 6f61 7433 322c 2069  torch.float32, i
-0004ac50: 735f 7368 6172 6564 3d46 616c 7365 292c  s_shared=False),
-0004ac60: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0004ac70: 2020 646f 6e65 3a20 5465 6e73 6f72 2873    done: Tensor(s
-0004ac80: 6861 7065 3d74 6f72 6368 2e53 697a 6528  hape=torch.Size(
-0004ac90: 5b32 2c20 315d 292c 2064 6576 6963 653d  [2, 1]), device=
-0004aca0: 6370 752c 2064 7479 7065 3d74 6f72 6368  cpu, dtype=torch
-0004acb0: 2e62 6f6f 6c2c 2069 735f 7368 6172 6564  .bool, is_shared
-0004acc0: 3d46 616c 7365 292c 0d0a 2020 2020 2020  =False),..      
-0004acd0: 2020 2020 2020 2020 2020 6e65 7874 3a20            next: 
-0004ace0: 5465 6e73 6f72 4469 6374 280d 0a20 2020  TensorDict(..   
-0004acf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ad00: 2066 6965 6c64 733d 7b0d 0a20 2020 2020   fields={..     
-0004ad10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ad20: 2020 2064 6f6e 653a 2054 656e 736f 7228     done: Tensor(
-0004ad30: 7368 6170 653d 746f 7263 682e 5369 7a65  shape=torch.Size
-0004ad40: 285b 322c 2031 5d29 2c20 6465 7669 6365  ([2, 1]), device
-0004ad50: 3d63 7075 2c20 6474 7970 653d 746f 7263  =cpu, dtype=torc
-0004ad60: 682e 626f 6f6c 2c20 6973 5f73 6861 7265  h.bool, is_share
-0004ad70: 643d 4661 6c73 6529 2c0d 0a20 2020 2020  d=False),..     
-0004ad80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ad90: 2020 206f 6273 6572 7661 7469 6f6e 3a20     observation: 
-0004ada0: 5465 6e73 6f72 2873 6861 7065 3d74 6f72  Tensor(shape=tor
-0004adb0: 6368 2e53 697a 6528 5b32 2c20 335d 292c  ch.Size([2, 3]),
-0004adc0: 2064 6576 6963 653d 6370 752c 2064 7479   device=cpu, dty
-0004add0: 7065 3d74 6f72 6368 2e66 6c6f 6174 3332  pe=torch.float32
-0004ade0: 2c20 6973 5f73 6861 7265 643d 4661 6c73  , is_shared=Fals
-0004adf0: 6529 2c0d 0a20 2020 2020 2020 2020 2020  e),..           
-0004ae00: 2020 2020 2020 2020 2020 2020 206f 7468               oth
-0004ae10: 6572 3a20 5465 6e73 6f72 4469 6374 280d  er: TensorDict(.
-0004ae20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004ae30: 2020 2020 2020 2020 2020 2020 2066 6965               fie
-0004ae40: 6c64 733d 7b0d 0a20 2020 2020 2020 2020  lds={..         
-0004ae50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ae60: 2020 2020 2020 2061 6e6f 7468 6572 5f6f         another_o
-0004ae70: 7468 6572 3a20 5465 6e73 6f72 4469 6374  ther: TensorDict
-0004ae80: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
-0004ae90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004aea0: 2020 2020 2020 2066 6965 6c64 733d 7b0d         fields={.
-0004aeb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004aec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004aed0: 2020 2020 207d 2c0d 0a20 2020 2020 2020       },..       
-0004aee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004aef0: 2020 2020 2020 2020 2020 2020 2062 6174               bat
-0004af00: 6368 5f73 697a 653d 746f 7263 682e 5369  ch_size=torch.Si
-0004af10: 7a65 285b 325d 292c 0d0a 2020 2020 2020  ze([2]),..      
-0004af20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004af30: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0004af40: 7669 6365 3d63 7075 2c0d 0a20 2020 2020  vice=cpu,..     
-0004af50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004af60: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0004af70: 735f 7368 6172 6564 3d46 616c 7365 297d  s_shared=False)}
-0004af80: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
-0004af90: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0004afa0: 6174 6368 5f73 697a 653d 746f 7263 682e  atch_size=torch.
-0004afb0: 5369 7a65 285b 325d 292c 0d0a 2020 2020  Size([2]),..    
-0004afc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004afd0: 2020 2020 2020 2020 6465 7669 6365 3d63          device=c
-0004afe0: 7075 2c0d 0a20 2020 2020 2020 2020 2020  pu,..           
-0004aff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b000: 2069 735f 7368 6172 6564 3d46 616c 7365   is_shared=False
-0004b010: 292c 0d0a 2020 2020 2020 2020 2020 2020  ),..            
-0004b020: 2020 2020 2020 2020 2020 2020 6f74 6865              othe
-0004b030: 725f 7265 7761 7264 3a20 5465 6e73 6f72  r_reward: Tensor
-0004b040: 4469 6374 280d 0a20 2020 2020 2020 2020  Dict(..         
-0004b050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b060: 2020 2066 6965 6c64 733d 7b0d 0a20 2020     fields={..   
-0004b070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b080: 2020 2020 2020 2020 207d 2c0d 0a20 2020           },..   
-0004b090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b0a0: 2020 2020 2020 2020 2062 6174 6368 5f73           batch_s
-0004b0b0: 697a 653d 746f 7263 682e 5369 7a65 285b  ize=torch.Size([
-0004b0c0: 325d 292c 0d0a 2020 2020 2020 2020 2020  2]),..          
-0004b0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b0e0: 2020 6465 7669 6365 3d63 7075 2c0d 0a20    device=cpu,.. 
+0004a780: 2020 2020 2020 2073 656c 662e 6f62 7365         self.obse
+0004a790: 7276 6174 696f 6e5f 7370 6563 203d 2043  rvation_spec = C
+0004a7a0: 6f6d 706f 7369 7465 5370 6563 280d 0a20  ompositeSpec(.. 
+0004a7b0: 2020 2020 2020 202e 2e2e 2020 2020 2020         ...      
+0004a7c0: 2020 2020 2020 206f 6273 6572 7661 7469         observati
+0004a7d0: 6f6e 3d55 6e62 6f75 6e64 6564 436f 6e74  on=UnboundedCont
+0004a7e0: 696e 756f 7573 5465 6e73 6f72 5370 6563  inuousTensorSpec
+0004a7f0: 2828 2a73 656c 662e 6261 7463 685f 7369  ((*self.batch_si
+0004a800: 7a65 2c20 3329 292c 0d0a 2020 2020 2020  ze, 3)),..      
+0004a810: 2020 2e2e 2e20 2020 2020 2020 2020 2020    ...           
+0004a820: 2020 6f74 6865 723d 436f 6d70 6f73 6974    other=Composit
+0004a830: 6553 7065 6328 0d0a 2020 2020 2020 2020  eSpec(..        
+0004a840: 2e2e 2e20 2020 2020 2020 2020 2020 2020  ...             
+0004a850: 2020 2020 616e 6f74 6865 725f 6f74 6865      another_othe
+0004a860: 723d 436f 6d70 6f73 6974 6553 7065 6328  r=CompositeSpec(
+0004a870: 7368 6170 653d 7365 6c66 2e62 6174 6368  shape=self.batch
+0004a880: 5f73 697a 6529 2c0d 0a20 2020 2020 2020  _size),..       
+0004a890: 202e 2e2e 2020 2020 2020 2020 2020 2020   ...            
+0004a8a0: 2020 2020 2073 6861 7065 3d73 656c 662e       shape=self.
+0004a8b0: 6261 7463 685f 7369 7a65 2c0d 0a20 2020  batch_size,..   
+0004a8c0: 2020 2020 202e 2e2e 2020 2020 2020 2020       ...        
+0004a8d0: 2020 2020 2029 2c0d 0a20 2020 2020 2020       ),..       
+0004a8e0: 202e 2e2e 2020 2020 2020 2020 2020 2020   ...            
+0004a8f0: 2073 6861 7065 3d73 656c 662e 6261 7463   shape=self.batc
+0004a900: 685f 7369 7a65 2c0d 0a20 2020 2020 2020  h_size,..       
+0004a910: 202e 2e2e 2020 2020 2020 2020 2029 0d0a   ...         )..
+0004a920: 2020 2020 2020 2020 2e2e 2e20 2020 2020          ...     
+0004a930: 2020 2020 7365 6c66 2e61 6374 696f 6e5f      self.action_
+0004a940: 7370 6563 203d 2055 6e62 6f75 6e64 6564  spec = Unbounded
+0004a950: 436f 6e74 696e 756f 7573 5465 6e73 6f72  ContinuousTensor
+0004a960: 5370 6563 2828 2a73 656c 662e 6261 7463  Spec((*self.batc
+0004a970: 685f 7369 7a65 2c20 3329 290d 0a20 2020  h_size, 3))..   
+0004a980: 2020 2020 202e 2e2e 2020 2020 2020 2020       ...        
+0004a990: 2073 656c 662e 646f 6e65 5f73 7065 6320   self.done_spec 
+0004a9a0: 3d20 4469 7363 7265 7465 5465 6e73 6f72  = DiscreteTensor
+0004a9b0: 5370 6563 280d 0a20 2020 2020 2020 202e  Spec(..        .
+0004a9c0: 2e2e 2020 2020 2020 2020 2020 2020 2032  ..             2
+0004a9d0: 2c20 282a 7365 6c66 2e62 6174 6368 5f73  , (*self.batch_s
+0004a9e0: 697a 652c 2031 292c 2064 7479 7065 3d74  ize, 1), dtype=t
+0004a9f0: 6f72 6368 2e62 6f6f 6c0d 0a20 2020 2020  orch.bool..     
+0004aa00: 2020 202e 2e2e 2020 2020 2020 2020 2029     ...         )
+0004aa10: 0d0a 2020 2020 2020 2020 2e2e 2e20 2020  ..        ...   
+0004aa20: 2020 2020 2020 7365 6c66 2e66 756c 6c5f        self.full_
+0004aa30: 646f 6e65 5f73 7065 635b 2274 7275 6e63  done_spec["trunc
+0004aa40: 6174 6564 225d 203d 2073 656c 662e 6675  ated"] = self.fu
+0004aa50: 6c6c 5f64 6f6e 655f 7370 6563 5b0d 0a20  ll_done_spec[.. 
+0004aa60: 2020 2020 2020 202e 2e2e 2020 2020 2020         ...      
+0004aa70: 2020 2020 2020 2022 7465 726d 696e 6174         "terminat
+0004aa80: 6564 225d 2e63 6c6f 6e65 2829 0d0a 2020  ed"].clone()..  
+0004aa90: 2020 2020 2020 2e2e 2e20 2020 2020 2020        ...       
+0004aaa0: 2020 7365 6c66 2e72 6577 6172 645f 7370    self.reward_sp
+0004aab0: 6563 203d 2043 6f6d 706f 7369 7465 5370  ec = CompositeSp
+0004aac0: 6563 280d 0a20 2020 2020 2020 202e 2e2e  ec(..        ...
+0004aad0: 2020 2020 2020 2020 2020 2020 2072 6577               rew
+0004aae0: 6172 643d 556e 626f 756e 6465 6443 6f6e  ard=UnboundedCon
+0004aaf0: 7469 6e75 6f75 7354 656e 736f 7253 7065  tinuousTensorSpe
+0004ab00: 6328 2a73 656c 662e 6261 7463 685f 7369  c(*self.batch_si
+0004ab10: 7a65 2c20 3129 2c0d 0a20 2020 2020 2020  ze, 1),..       
+0004ab20: 202e 2e2e 2020 2020 2020 2020 2020 2020   ...            
+0004ab30: 206f 7468 6572 5f72 6577 6172 643d 436f   other_reward=Co
+0004ab40: 6d70 6f73 6974 6553 7065 6328 7368 6170  mpositeSpec(shap
+0004ab50: 653d 7365 6c66 2e62 6174 6368 5f73 697a  e=self.batch_siz
+0004ab60: 6529 2c0d 0a20 2020 2020 2020 202e 2e2e  e),..        ...
+0004ab70: 2020 2020 2020 2020 2020 2020 2073 6861               sha
+0004ab80: 7065 3d73 656c 662e 6261 7463 685f 7369  pe=self.batch_si
+0004ab90: 7a65 0d0a 2020 2020 2020 2020 2e2e 2e20  ze..        ... 
+0004aba0: 2020 2020 2020 2020 2020 2020 290d 0a20              ).. 
+0004abb0: 2020 2020 2020 202e 2e2e 0d0a 2020 2020         .....    
+0004abc0: 2020 2020 2e2e 2e20 2020 2020 6465 6620      ...     def 
+0004abd0: 5f72 6573 6574 2873 656c 662c 2074 656e  _reset(self, ten
+0004abe0: 736f 7264 6963 7429 3a0d 0a20 2020 2020  sordict):..     
+0004abf0: 2020 202e 2e2e 2020 2020 2020 2020 2072     ...         r
+0004ac00: 6574 7572 6e20 7365 6c66 2e6f 6273 6572  eturn self.obser
+0004ac10: 7661 7469 6f6e 5f73 7065 632e 7261 6e64  vation_spec.rand
+0004ac20: 2829 2e75 7064 6174 6528 7365 6c66 2e66  ().update(self.f
+0004ac30: 756c 6c5f 646f 6e65 5f73 7065 632e 7a65  ull_done_spec.ze
+0004ac40: 726f 2829 290d 0a20 2020 2020 2020 202e  ro())..        .
+0004ac50: 2e2e 0d0a 2020 2020 2020 2020 2e2e 2e20  ....        ... 
+0004ac60: 2020 2020 6465 6620 5f73 7465 7028 7365      def _step(se
+0004ac70: 6c66 2c20 7465 6e73 6f72 6469 6374 293a  lf, tensordict):
+0004ac80: 0d0a 2020 2020 2020 2020 2e2e 2e20 2020  ..        ...   
+0004ac90: 2020 2020 2020 7265 7475 726e 2054 656e        return Ten
+0004aca0: 736f 7244 6963 7428 0d0a 2020 2020 2020  sorDict(..      
+0004acb0: 2020 2e2e 2e20 2020 2020 2020 2020 2020    ...           
+0004acc0: 2020 7b7d 2c0d 0a20 2020 2020 2020 202e    {},..        .
+0004acd0: 2e2e 2020 2020 2020 2020 2020 2020 2062  ..             b
+0004ace0: 6174 6368 5f73 697a 653d 5b5d 0d0a 2020  atch_size=[]..  
+0004acf0: 2020 2020 2020 2e2e 2e20 2020 2020 2020        ...       
+0004ad00: 2020 292e 7570 6461 7465 2873 656c 662e    ).update(self.
+0004ad10: 6f62 7365 7276 6174 696f 6e5f 7370 6563  observation_spec
+0004ad20: 2e72 616e 6428 2929 2e75 7064 6174 6528  .rand()).update(
+0004ad30: 0d0a 2020 2020 2020 2020 2e2e 2e20 2020  ..        ...   
+0004ad40: 2020 2020 2020 2020 2020 7365 6c66 2e66            self.f
+0004ad50: 756c 6c5f 646f 6e65 5f73 7065 632e 7a65  ull_done_spec.ze
+0004ad60: 726f 2829 0d0a 2020 2020 2020 2020 2e2e  ro()..        ..
+0004ad70: 2e20 2020 2020 2020 2020 2020 2020 292e  .             ).
+0004ad80: 7570 6461 7465 2873 656c 662e 6675 6c6c  update(self.full
+0004ad90: 5f72 6577 6172 645f 7370 6563 2e72 616e  _reward_spec.ran
+0004ada0: 6428 2929 0d0a 2020 2020 2020 2020 2e2e  d())..        ..
+0004adb0: 2e0d 0a20 2020 2020 2020 202e 2e2e 2020  ...        ...  
+0004adc0: 2020 2064 6566 205f 7365 745f 7365 6564     def _set_seed
+0004add0: 2873 656c 662c 2073 6565 6429 3a0d 0a20  (self, seed):.. 
+0004ade0: 2020 2020 2020 202e 2e2e 2020 2020 2020         ...      
+0004adf0: 2020 2072 6574 7572 6e20 7365 6564 202b     return seed +
+0004ae00: 2031 0d0a 2020 2020 2020 2020 3e3e 3e0d   1..        >>>.
+0004ae10: 0a20 2020 2020 2020 203e 3e3e 0d0a 2020  .        >>>..  
+0004ae20: 2020 2020 2020 3e3e 3e20 6261 7365 5f65        >>> base_e
+0004ae30: 6e76 203d 2044 756d 6d79 456e 7628 290d  nv = DummyEnv().
+0004ae40: 0a20 2020 2020 2020 203e 3e3e 2070 7269  .        >>> pri
+0004ae50: 6e74 2862 6173 655f 656e 762e 726f 6c6c  nt(base_env.roll
+0004ae60: 6f75 7428 3229 290d 0a20 2020 2020 2020  out(2))..       
+0004ae70: 2054 656e 736f 7244 6963 7428 0d0a 2020   TensorDict(..  
+0004ae80: 2020 2020 2020 2020 2020 6669 656c 6473            fields
+0004ae90: 3d7b 0d0a 2020 2020 2020 2020 2020 2020  ={..            
+0004aea0: 2020 2020 6163 7469 6f6e 3a20 5465 6e73      action: Tens
+0004aeb0: 6f72 2873 6861 7065 3d74 6f72 6368 2e53  or(shape=torch.S
+0004aec0: 697a 6528 5b32 2c20 335d 292c 2064 6576  ize([2, 3]), dev
+0004aed0: 6963 653d 6370 752c 2064 7479 7065 3d74  ice=cpu, dtype=t
+0004aee0: 6f72 6368 2e66 6c6f 6174 3332 2c20 6973  orch.float32, is
+0004aef0: 5f73 6861 7265 643d 4661 6c73 6529 2c0d  _shared=False),.
+0004af00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004af10: 2064 6f6e 653a 2054 656e 736f 7228 7368   done: Tensor(sh
+0004af20: 6170 653d 746f 7263 682e 5369 7a65 285b  ape=torch.Size([
+0004af30: 322c 2031 5d29 2c20 6465 7669 6365 3d63  2, 1]), device=c
+0004af40: 7075 2c20 6474 7970 653d 746f 7263 682e  pu, dtype=torch.
+0004af50: 626f 6f6c 2c20 6973 5f73 6861 7265 643d  bool, is_shared=
+0004af60: 4661 6c73 6529 2c0d 0a20 2020 2020 2020  False),..       
+0004af70: 2020 2020 2020 2020 206e 6578 743a 2054           next: T
+0004af80: 656e 736f 7244 6963 7428 0d0a 2020 2020  ensorDict(..    
+0004af90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004afa0: 6669 656c 6473 3d7b 0d0a 2020 2020 2020  fields={..      
+0004afb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004afc0: 2020 646f 6e65 3a20 5465 6e73 6f72 2873    done: Tensor(s
+0004afd0: 6861 7065 3d74 6f72 6368 2e53 697a 6528  hape=torch.Size(
+0004afe0: 5b32 2c20 315d 292c 2064 6576 6963 653d  [2, 1]), device=
+0004aff0: 6370 752c 2064 7479 7065 3d74 6f72 6368  cpu, dtype=torch
+0004b000: 2e62 6f6f 6c2c 2069 735f 7368 6172 6564  .bool, is_shared
+0004b010: 3d46 616c 7365 292c 0d0a 2020 2020 2020  =False),..      
+0004b020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b030: 2020 6f62 7365 7276 6174 696f 6e3a 2054    observation: T
+0004b040: 656e 736f 7228 7368 6170 653d 746f 7263  ensor(shape=torc
+0004b050: 682e 5369 7a65 285b 322c 2033 5d29 2c20  h.Size([2, 3]), 
+0004b060: 6465 7669 6365 3d63 7075 2c20 6474 7970  device=cpu, dtyp
+0004b070: 653d 746f 7263 682e 666c 6f61 7433 322c  e=torch.float32,
+0004b080: 2069 735f 7368 6172 6564 3d46 616c 7365   is_shared=False
+0004b090: 292c 0d0a 2020 2020 2020 2020 2020 2020  ),..            
+0004b0a0: 2020 2020 2020 2020 2020 2020 6f74 6865              othe
+0004b0b0: 723a 2054 656e 736f 7244 6963 7428 0d0a  r: TensorDict(..
+0004b0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b0d0: 2020 2020 2020 2020 2020 2020 6669 656c              fiel
+0004b0e0: 6473 3d7b 0d0a 2020 2020 2020 2020 2020  ds={..          
 0004b0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b100: 2020 2020 2020 2020 2020 2069 735f 7368             is_sh
-0004b110: 6172 6564 3d46 616c 7365 292c 0d0a 2020  ared=False),..  
-0004b120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b130: 2020 2020 2020 7265 7761 7264 3a20 5465        reward: Te
-0004b140: 6e73 6f72 2873 6861 7065 3d74 6f72 6368  nsor(shape=torch
-0004b150: 2e53 697a 6528 5b32 2c20 315d 292c 2064  .Size([2, 1]), d
-0004b160: 6576 6963 653d 6370 752c 2064 7479 7065  evice=cpu, dtype
-0004b170: 3d74 6f72 6368 2e66 6c6f 6174 3332 2c20  =torch.float32, 
-0004b180: 6973 5f73 6861 7265 643d 4661 6c73 6529  is_shared=False)
-0004b190: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
-0004b1a0: 2020 2020 2020 2020 2020 2074 6572 6d69             termi
-0004b1b0: 6e61 7465 643a 2054 656e 736f 7228 7368  nated: Tensor(sh
-0004b1c0: 6170 653d 746f 7263 682e 5369 7a65 285b  ape=torch.Size([
-0004b1d0: 322c 2031 5d29 2c20 6465 7669 6365 3d63  2, 1]), device=c
-0004b1e0: 7075 2c20 6474 7970 653d 746f 7263 682e  pu, dtype=torch.
-0004b1f0: 626f 6f6c 2c20 6973 5f73 6861 7265 643d  bool, is_shared=
-0004b200: 4661 6c73 6529 2c0d 0a20 2020 2020 2020  False),..       
-0004b210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b220: 2074 7275 6e63 6174 6564 3a20 5465 6e73   truncated: Tens
-0004b230: 6f72 2873 6861 7065 3d74 6f72 6368 2e53  or(shape=torch.S
-0004b240: 697a 6528 5b32 2c20 315d 292c 2064 6576  ize([2, 1]), dev
-0004b250: 6963 653d 6370 752c 2064 7479 7065 3d74  ice=cpu, dtype=t
-0004b260: 6f72 6368 2e62 6f6f 6c2c 2069 735f 7368  orch.bool, is_sh
-0004b270: 6172 6564 3d46 616c 7365 297d 2c0d 0a20  ared=False)},.. 
-0004b280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b290: 2020 2062 6174 6368 5f73 697a 653d 746f     batch_size=to
-0004b2a0: 7263 682e 5369 7a65 285b 325d 292c 0d0a  rch.Size([2]),..
-0004b2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b2c0: 2020 2020 6465 7669 6365 3d63 7075 2c0d      device=cpu,.
-0004b2d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004b2e0: 2020 2020 2069 735f 7368 6172 6564 3d46       is_shared=F
-0004b2f0: 616c 7365 292c 0d0a 2020 2020 2020 2020  alse),..        
-0004b300: 2020 2020 2020 2020 6f62 7365 7276 6174          observat
-0004b310: 696f 6e3a 2054 656e 736f 7228 7368 6170  ion: Tensor(shap
-0004b320: 653d 746f 7263 682e 5369 7a65 285b 322c  e=torch.Size([2,
-0004b330: 2033 5d29 2c20 6465 7669 6365 3d63 7075   3]), device=cpu
-0004b340: 2c20 6474 7970 653d 746f 7263 682e 666c  , dtype=torch.fl
-0004b350: 6f61 7433 322c 2069 735f 7368 6172 6564  oat32, is_shared
-0004b360: 3d46 616c 7365 292c 0d0a 2020 2020 2020  =False),..      
-0004b370: 2020 2020 2020 2020 2020 7465 726d 696e            termin
-0004b380: 6174 6564 3a20 5465 6e73 6f72 2873 6861  ated: Tensor(sha
-0004b390: 7065 3d74 6f72 6368 2e53 697a 6528 5b32  pe=torch.Size([2
-0004b3a0: 2c20 315d 292c 2064 6576 6963 653d 6370  , 1]), device=cp
-0004b3b0: 752c 2064 7479 7065 3d74 6f72 6368 2e62  u, dtype=torch.b
-0004b3c0: 6f6f 6c2c 2069 735f 7368 6172 6564 3d46  ool, is_shared=F
-0004b3d0: 616c 7365 292c 0d0a 2020 2020 2020 2020  alse),..        
-0004b3e0: 2020 2020 2020 2020 7472 756e 6361 7465          truncate
-0004b3f0: 643a 2054 656e 736f 7228 7368 6170 653d  d: Tensor(shape=
-0004b400: 746f 7263 682e 5369 7a65 285b 322c 2031  torch.Size([2, 1
-0004b410: 5d29 2c20 6465 7669 6365 3d63 7075 2c20  ]), device=cpu, 
-0004b420: 6474 7970 653d 746f 7263 682e 626f 6f6c  dtype=torch.bool
-0004b430: 2c20 6973 5f73 6861 7265 643d 4661 6c73  , is_shared=Fals
-0004b440: 6529 7d2c 0d0a 2020 2020 2020 2020 2020  e)},..          
-0004b450: 2020 6261 7463 685f 7369 7a65 3d74 6f72    batch_size=tor
-0004b460: 6368 2e53 697a 6528 5b32 5d29 2c0d 0a20  ch.Size([2]),.. 
-0004b470: 2020 2020 2020 2020 2020 2064 6576 6963             devic
-0004b480: 653d 6370 752c 0d0a 2020 2020 2020 2020  e=cpu,..        
-0004b490: 2020 2020 6973 5f73 6861 7265 643d 4661      is_shared=Fa
-0004b4a0: 6c73 6529 0d0a 2020 2020 2020 2020 3e3e  lse)..        >>
-0004b4b0: 3e20 6368 6563 6b5f 656e 765f 7370 6563  > check_env_spec
-0004b4c0: 7328 6261 7365 5f65 6e76 290d 0a20 2020  s(base_env)..   
-0004b4d0: 2020 2020 203e 3e3e 2065 6e76 203d 2054       >>> env = T
-0004b4e0: 7261 6e73 666f 726d 6564 456e 7628 6261  ransformedEnv(ba
-0004b4f0: 7365 5f65 6e76 2c20 5265 6d6f 7665 456d  se_env, RemoveEm
-0004b500: 7074 7953 7065 6373 2829 290d 0a20 2020  ptySpecs())..   
-0004b510: 2020 2020 203e 3e3e 2070 7269 6e74 2865       >>> print(e
-0004b520: 6e76 2e72 6f6c 6c6f 7574 2832 2929 0d0a  nv.rollout(2))..
-0004b530: 2020 2020 2020 2020 5465 6e73 6f72 4469          TensorDi
-0004b540: 6374 280d 0a20 2020 2020 2020 2020 2020  ct(..           
-0004b550: 2066 6965 6c64 733d 7b0d 0a20 2020 2020   fields={..     
-0004b560: 2020 2020 2020 2020 2020 2061 6374 696f             actio
-0004b570: 6e3a 2054 656e 736f 7228 7368 6170 653d  n: Tensor(shape=
-0004b580: 746f 7263 682e 5369 7a65 285b 322c 2033  torch.Size([2, 3
-0004b590: 5d29 2c20 6465 7669 6365 3d63 7075 2c20  ]), device=cpu, 
-0004b5a0: 6474 7970 653d 746f 7263 682e 666c 6f61  dtype=torch.floa
-0004b5b0: 7433 322c 2069 735f 7368 6172 6564 3d46  t32, is_shared=F
-0004b5c0: 616c 7365 292c 0d0a 2020 2020 2020 2020  alse),..        
-0004b5d0: 2020 2020 2020 2020 646f 6e65 3a20 5465          done: Te
-0004b5e0: 6e73 6f72 2873 6861 7065 3d74 6f72 6368  nsor(shape=torch
-0004b5f0: 2e53 697a 6528 5b32 2c20 315d 292c 2064  .Size([2, 1]), d
-0004b600: 6576 6963 653d 6370 752c 2064 7479 7065  evice=cpu, dtype
-0004b610: 3d74 6f72 6368 2e62 6f6f 6c2c 2069 735f  =torch.bool, is_
-0004b620: 7368 6172 6564 3d46 616c 7365 292c 0d0a  shared=False),..
-0004b630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b640: 6e65 7874 3a20 5465 6e73 6f72 4469 6374  next: TensorDict
-0004b650: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
-0004b660: 2020 2020 2020 2066 6965 6c64 733d 7b0d         fields={.
-0004b670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004b680: 2020 2020 2020 2020 2064 6f6e 653a 2054           done: T
-0004b690: 656e 736f 7228 7368 6170 653d 746f 7263  ensor(shape=torc
-0004b6a0: 682e 5369 7a65 285b 322c 2031 5d29 2c20  h.Size([2, 1]), 
-0004b6b0: 6465 7669 6365 3d63 7075 2c20 6474 7970  device=cpu, dtyp
-0004b6c0: 653d 746f 7263 682e 626f 6f6c 2c20 6973  e=torch.bool, is
-0004b6d0: 5f73 6861 7265 643d 4661 6c73 6529 2c0d  _shared=False),.
-0004b6e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004b6f0: 2020 2020 2020 2020 206f 6273 6572 7661           observa
-0004b700: 7469 6f6e 3a20 5465 6e73 6f72 2873 6861  tion: Tensor(sha
-0004b710: 7065 3d74 6f72 6368 2e53 697a 6528 5b32  pe=torch.Size([2
-0004b720: 2c20 335d 292c 2064 6576 6963 653d 6370  , 3]), device=cp
-0004b730: 752c 2064 7479 7065 3d74 6f72 6368 2e66  u, dtype=torch.f
-0004b740: 6c6f 6174 3332 2c20 6973 5f73 6861 7265  loat32, is_share
-0004b750: 643d 4661 6c73 6529 2c0d 0a20 2020 2020  d=False),..     
-0004b760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b770: 2020 2072 6577 6172 643a 2054 656e 736f     reward: Tenso
-0004b780: 7228 7368 6170 653d 746f 7263 682e 5369  r(shape=torch.Si
-0004b790: 7a65 285b 322c 2031 5d29 2c20 6465 7669  ze([2, 1]), devi
-0004b7a0: 6365 3d63 7075 2c20 6474 7970 653d 746f  ce=cpu, dtype=to
-0004b7b0: 7263 682e 666c 6f61 7433 322c 2069 735f  rch.float32, is_
-0004b7c0: 7368 6172 6564 3d46 616c 7365 292c 0d0a  shared=False),..
-0004b7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b7e0: 2020 2020 2020 2020 7465 726d 696e 6174          terminat
-0004b7f0: 6564 3a20 5465 6e73 6f72 2873 6861 7065  ed: Tensor(shape
-0004b800: 3d74 6f72 6368 2e53 697a 6528 5b32 2c20  =torch.Size([2, 
-0004b810: 315d 292c 2064 6576 6963 653d 6370 752c  1]), device=cpu,
-0004b820: 2064 7479 7065 3d74 6f72 6368 2e62 6f6f   dtype=torch.boo
-0004b830: 6c2c 2069 735f 7368 6172 6564 3d46 616c  l, is_shared=Fal
-0004b840: 7365 292c 0d0a 2020 2020 2020 2020 2020  se),..          
-0004b850: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-0004b860: 756e 6361 7465 643a 2054 656e 736f 7228  uncated: Tensor(
-0004b870: 7368 6170 653d 746f 7263 682e 5369 7a65  shape=torch.Size
-0004b880: 285b 322c 2031 5d29 2c20 6465 7669 6365  ([2, 1]), device
-0004b890: 3d63 7075 2c20 6474 7970 653d 746f 7263  =cpu, dtype=torc
-0004b8a0: 682e 626f 6f6c 2c20 6973 5f73 6861 7265  h.bool, is_share
-0004b8b0: 643d 4661 6c73 6529 7d2c 0d0a 2020 2020  d=False)},..    
-0004b8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b8d0: 6261 7463 685f 7369 7a65 3d74 6f72 6368  batch_size=torch
-0004b8e0: 2e53 697a 6528 5b32 5d29 2c0d 0a20 2020  .Size([2]),..   
-0004b8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b900: 2064 6576 6963 653d 6370 752c 0d0a 2020   device=cpu,..  
+0004b100: 2020 2020 2020 616e 6f74 6865 725f 6f74        another_ot
+0004b110: 6865 723a 2054 656e 736f 7244 6963 7428  her: TensorDict(
+0004b120: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0004b130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b140: 2020 2020 2020 6669 656c 6473 3d7b 0d0a        fields={..
+0004b150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b170: 2020 2020 7d2c 0d0a 2020 2020 2020 2020      },..        
+0004b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b190: 2020 2020 2020 2020 2020 2020 6261 7463              batc
+0004b1a0: 685f 7369 7a65 3d74 6f72 6368 2e53 697a  h_size=torch.Siz
+0004b1b0: 6528 5b32 5d29 2c0d 0a20 2020 2020 2020  e([2]),..       
+0004b1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b1d0: 2020 2020 2020 2020 2020 2020 2064 6576               dev
+0004b1e0: 6963 653d 6370 752c 0d0a 2020 2020 2020  ice=cpu,..      
+0004b1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b200: 2020 2020 2020 2020 2020 2020 2020 6973                is
+0004b210: 5f73 6861 7265 643d 4661 6c73 6529 7d2c  _shared=False)},
+0004b220: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0004b230: 2020 2020 2020 2020 2020 2020 2020 6261                ba
+0004b240: 7463 685f 7369 7a65 3d74 6f72 6368 2e53  tch_size=torch.S
+0004b250: 697a 6528 5b32 5d29 2c0d 0a20 2020 2020  ize([2]),..     
+0004b260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b270: 2020 2020 2020 2064 6576 6963 653d 6370         device=cp
+0004b280: 752c 0d0a 2020 2020 2020 2020 2020 2020  u,..            
+0004b290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b2a0: 6973 5f73 6861 7265 643d 4661 6c73 6529  is_shared=False)
+0004b2b0: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+0004b2c0: 2020 2020 2020 2020 2020 206f 7468 6572             other
+0004b2d0: 5f72 6577 6172 643a 2054 656e 736f 7244  _reward: TensorD
+0004b2e0: 6963 7428 0d0a 2020 2020 2020 2020 2020  ict(..          
+0004b2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b300: 2020 6669 656c 6473 3d7b 0d0a 2020 2020    fields={..    
+0004b310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b320: 2020 2020 2020 2020 7d2c 0d0a 2020 2020          },..    
+0004b330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b340: 2020 2020 2020 2020 6261 7463 685f 7369          batch_si
+0004b350: 7a65 3d74 6f72 6368 2e53 697a 6528 5b32  ze=torch.Size([2
+0004b360: 5d29 2c0d 0a20 2020 2020 2020 2020 2020  ]),..           
+0004b370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b380: 2064 6576 6963 653d 6370 752c 0d0a 2020   device=cpu,..  
+0004b390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b3a0: 2020 2020 2020 2020 2020 6973 5f73 6861            is_sha
+0004b3b0: 7265 643d 4661 6c73 6529 2c0d 0a20 2020  red=False),..   
+0004b3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b3d0: 2020 2020 2072 6577 6172 643a 2054 656e       reward: Ten
+0004b3e0: 736f 7228 7368 6170 653d 746f 7263 682e  sor(shape=torch.
+0004b3f0: 5369 7a65 285b 322c 2031 5d29 2c20 6465  Size([2, 1]), de
+0004b400: 7669 6365 3d63 7075 2c20 6474 7970 653d  vice=cpu, dtype=
+0004b410: 746f 7263 682e 666c 6f61 7433 322c 2069  torch.float32, i
+0004b420: 735f 7368 6172 6564 3d46 616c 7365 292c  s_shared=False),
+0004b430: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0004b440: 2020 2020 2020 2020 2020 7465 726d 696e            termin
+0004b450: 6174 6564 3a20 5465 6e73 6f72 2873 6861  ated: Tensor(sha
+0004b460: 7065 3d74 6f72 6368 2e53 697a 6528 5b32  pe=torch.Size([2
+0004b470: 2c20 315d 292c 2064 6576 6963 653d 6370  , 1]), device=cp
+0004b480: 752c 2064 7479 7065 3d74 6f72 6368 2e62  u, dtype=torch.b
+0004b490: 6f6f 6c2c 2069 735f 7368 6172 6564 3d46  ool, is_shared=F
+0004b4a0: 616c 7365 292c 0d0a 2020 2020 2020 2020  alse),..        
+0004b4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b4c0: 7472 756e 6361 7465 643a 2054 656e 736f  truncated: Tenso
+0004b4d0: 7228 7368 6170 653d 746f 7263 682e 5369  r(shape=torch.Si
+0004b4e0: 7a65 285b 322c 2031 5d29 2c20 6465 7669  ze([2, 1]), devi
+0004b4f0: 6365 3d63 7075 2c20 6474 7970 653d 746f  ce=cpu, dtype=to
+0004b500: 7263 682e 626f 6f6c 2c20 6973 5f73 6861  rch.bool, is_sha
+0004b510: 7265 643d 4661 6c73 6529 7d2c 0d0a 2020  red=False)},..  
+0004b520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b530: 2020 6261 7463 685f 7369 7a65 3d74 6f72    batch_size=tor
+0004b540: 6368 2e53 697a 6528 5b32 5d29 2c0d 0a20  ch.Size([2]),.. 
+0004b550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b560: 2020 2064 6576 6963 653d 6370 752c 0d0a     device=cpu,..
+0004b570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b580: 2020 2020 6973 5f73 6861 7265 643d 4661      is_shared=Fa
+0004b590: 6c73 6529 2c0d 0a20 2020 2020 2020 2020  lse),..         
+0004b5a0: 2020 2020 2020 206f 6273 6572 7661 7469         observati
+0004b5b0: 6f6e 3a20 5465 6e73 6f72 2873 6861 7065  on: Tensor(shape
+0004b5c0: 3d74 6f72 6368 2e53 697a 6528 5b32 2c20  =torch.Size([2, 
+0004b5d0: 335d 292c 2064 6576 6963 653d 6370 752c  3]), device=cpu,
+0004b5e0: 2064 7479 7065 3d74 6f72 6368 2e66 6c6f   dtype=torch.flo
+0004b5f0: 6174 3332 2c20 6973 5f73 6861 7265 643d  at32, is_shared=
+0004b600: 4661 6c73 6529 2c0d 0a20 2020 2020 2020  False),..       
+0004b610: 2020 2020 2020 2020 2074 6572 6d69 6e61           termina
+0004b620: 7465 643a 2054 656e 736f 7228 7368 6170  ted: Tensor(shap
+0004b630: 653d 746f 7263 682e 5369 7a65 285b 322c  e=torch.Size([2,
+0004b640: 2031 5d29 2c20 6465 7669 6365 3d63 7075   1]), device=cpu
+0004b650: 2c20 6474 7970 653d 746f 7263 682e 626f  , dtype=torch.bo
+0004b660: 6f6c 2c20 6973 5f73 6861 7265 643d 4661  ol, is_shared=Fa
+0004b670: 6c73 6529 2c0d 0a20 2020 2020 2020 2020  lse),..         
+0004b680: 2020 2020 2020 2074 7275 6e63 6174 6564         truncated
+0004b690: 3a20 5465 6e73 6f72 2873 6861 7065 3d74  : Tensor(shape=t
+0004b6a0: 6f72 6368 2e53 697a 6528 5b32 2c20 315d  orch.Size([2, 1]
+0004b6b0: 292c 2064 6576 6963 653d 6370 752c 2064  ), device=cpu, d
+0004b6c0: 7479 7065 3d74 6f72 6368 2e62 6f6f 6c2c  type=torch.bool,
+0004b6d0: 2069 735f 7368 6172 6564 3d46 616c 7365   is_shared=False
+0004b6e0: 297d 2c0d 0a20 2020 2020 2020 2020 2020  )},..           
+0004b6f0: 2062 6174 6368 5f73 697a 653d 746f 7263   batch_size=torc
+0004b700: 682e 5369 7a65 285b 325d 292c 0d0a 2020  h.Size([2]),..  
+0004b710: 2020 2020 2020 2020 2020 6465 7669 6365            device
+0004b720: 3d63 7075 2c0d 0a20 2020 2020 2020 2020  =cpu,..         
+0004b730: 2020 2069 735f 7368 6172 6564 3d46 616c     is_shared=Fal
+0004b740: 7365 290d 0a20 2020 2020 2020 203e 3e3e  se)..        >>>
+0004b750: 2063 6865 636b 5f65 6e76 5f73 7065 6373   check_env_specs
+0004b760: 2862 6173 655f 656e 7629 0d0a 2020 2020  (base_env)..    
+0004b770: 2020 2020 3e3e 3e20 656e 7620 3d20 5472      >>> env = Tr
+0004b780: 616e 7366 6f72 6d65 6445 6e76 2862 6173  ansformedEnv(bas
+0004b790: 655f 656e 762c 2052 656d 6f76 6545 6d70  e_env, RemoveEmp
+0004b7a0: 7479 5370 6563 7328 2929 0d0a 2020 2020  tySpecs())..    
+0004b7b0: 2020 2020 3e3e 3e20 7072 696e 7428 656e      >>> print(en
+0004b7c0: 762e 726f 6c6c 6f75 7428 3229 290d 0a20  v.rollout(2)).. 
+0004b7d0: 2020 2020 2020 2054 656e 736f 7244 6963         TensorDic
+0004b7e0: 7428 0d0a 2020 2020 2020 2020 2020 2020  t(..            
+0004b7f0: 6669 656c 6473 3d7b 0d0a 2020 2020 2020  fields={..      
+0004b800: 2020 2020 2020 2020 2020 6163 7469 6f6e            action
+0004b810: 3a20 5465 6e73 6f72 2873 6861 7065 3d74  : Tensor(shape=t
+0004b820: 6f72 6368 2e53 697a 6528 5b32 2c20 335d  orch.Size([2, 3]
+0004b830: 292c 2064 6576 6963 653d 6370 752c 2064  ), device=cpu, d
+0004b840: 7479 7065 3d74 6f72 6368 2e66 6c6f 6174  type=torch.float
+0004b850: 3332 2c20 6973 5f73 6861 7265 643d 4661  32, is_shared=Fa
+0004b860: 6c73 6529 2c0d 0a20 2020 2020 2020 2020  lse),..         
+0004b870: 2020 2020 2020 2064 6f6e 653a 2054 656e         done: Ten
+0004b880: 736f 7228 7368 6170 653d 746f 7263 682e  sor(shape=torch.
+0004b890: 5369 7a65 285b 322c 2031 5d29 2c20 6465  Size([2, 1]), de
+0004b8a0: 7669 6365 3d63 7075 2c20 6474 7970 653d  vice=cpu, dtype=
+0004b8b0: 746f 7263 682e 626f 6f6c 2c20 6973 5f73  torch.bool, is_s
+0004b8c0: 6861 7265 643d 4661 6c73 6529 2c0d 0a20  hared=False),.. 
+0004b8d0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0004b8e0: 6578 743a 2054 656e 736f 7244 6963 7428  ext: TensorDict(
+0004b8f0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0004b900: 2020 2020 2020 6669 656c 6473 3d7b 0d0a        fields={..
 0004b910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b920: 2020 6973 5f73 6861 7265 643d 4661 6c73    is_shared=Fals
-0004b930: 6529 2c0d 0a20 2020 2020 2020 2020 2020  e),..           
-0004b940: 2020 2020 206f 6273 6572 7661 7469 6f6e       observation
-0004b950: 3a20 5465 6e73 6f72 2873 6861 7065 3d74  : Tensor(shape=t
-0004b960: 6f72 6368 2e53 697a 6528 5b32 2c20 335d  orch.Size([2, 3]
-0004b970: 292c 2064 6576 6963 653d 6370 752c 2064  ), device=cpu, d
-0004b980: 7479 7065 3d74 6f72 6368 2e66 6c6f 6174  type=torch.float
-0004b990: 3332 2c20 6973 5f73 6861 7265 643d 4661  32, is_shared=Fa
-0004b9a0: 6c73 6529 2c0d 0a20 2020 2020 2020 2020  lse),..         
-0004b9b0: 2020 2020 2020 2074 6572 6d69 6e61 7465         terminate
-0004b9c0: 643a 2054 656e 736f 7228 7368 6170 653d  d: Tensor(shape=
-0004b9d0: 746f 7263 682e 5369 7a65 285b 322c 2031  torch.Size([2, 1
-0004b9e0: 5d29 2c20 6465 7669 6365 3d63 7075 2c20  ]), device=cpu, 
-0004b9f0: 6474 7970 653d 746f 7263 682e 626f 6f6c  dtype=torch.bool
-0004ba00: 2c20 6973 5f73 6861 7265 643d 4661 6c73  , is_shared=Fals
-0004ba10: 6529 2c0d 0a20 2020 2020 2020 2020 2020  e),..           
-0004ba20: 2020 2020 2074 7275 6e63 6174 6564 3a20       truncated: 
-0004ba30: 5465 6e73 6f72 2873 6861 7065 3d74 6f72  Tensor(shape=tor
-0004ba40: 6368 2e53 697a 6528 5b32 2c20 315d 292c  ch.Size([2, 1]),
-0004ba50: 2064 6576 6963 653d 6370 752c 2064 7479   device=cpu, dty
-0004ba60: 7065 3d74 6f72 6368 2e62 6f6f 6c2c 2069  pe=torch.bool, i
-0004ba70: 735f 7368 6172 6564 3d46 616c 7365 297d  s_shared=False)}
-0004ba80: 2c0d 0a20 2020 2020 2020 2020 2020 2062  ,..            b
-0004ba90: 6174 6368 5f73 697a 653d 746f 7263 682e  atch_size=torch.
-0004baa0: 5369 7a65 285b 325d 292c 0d0a 2020 2020  Size([2]),..    
-0004bab0: 2020 2020 2020 2020 6465 7669 6365 3d63          device=c
-0004bac0: 7075 2c0d 0a20 2020 2020 2020 2020 2020  pu,..           
-0004bad0: 2069 735f 7368 6172 6564 3d46 616c 7365   is_shared=False
-0004bae0: 290d 0a20 2020 2020 2020 2063 6865 636b  )..        check
-0004baf0: 5f65 6e76 5f73 7065 6373 2865 6e76 290d  _env_specs(env).
-0004bb00: 0a20 2020 2022 2222 0d0a 0d0a 2020 2020  .    """....    
-0004bb10: 5f68 6173 5f65 6d70 7479 5f69 6e70 7574  _has_empty_input
-0004bb20: 203d 2054 7275 650d 0a0d 0a20 2020 2040   = True....    @
-0004bb30: 7374 6174 6963 6d65 7468 6f64 0d0a 2020  staticmethod..  
-0004bb40: 2020 6465 6620 5f73 6f72 7465 7228 6b65    def _sorter(ke
-0004bb50: 795f 7661 6c29 3a0d 0a20 2020 2020 2020  y_val):..       
-0004bb60: 206b 6579 2c20 5f20 3d20 6b65 795f 7661   key, _ = key_va
-0004bb70: 6c0d 0a20 2020 2020 2020 2069 6620 6973  l..        if is
-0004bb80: 696e 7374 616e 6365 286b 6579 2c20 7374  instance(key, st
-0004bb90: 7229 3a0d 0a20 2020 2020 2020 2020 2020  r):..           
-0004bba0: 2072 6574 7572 6e20 300d 0a20 2020 2020   return 0..     
-0004bbb0: 2020 2072 6574 7572 6e20 6c65 6e28 6b65     return len(ke
-0004bbc0: 7929 0d0a 0d0a 2020 2020 6465 6620 7472  y)....    def tr
-0004bbd0: 616e 7366 6f72 6d5f 6f75 7470 7574 5f73  ansform_output_s
-0004bbe0: 7065 6328 7365 6c66 2c20 6f75 7470 7574  pec(self, output
-0004bbf0: 5f73 7065 633a 2043 6f6d 706f 7369 7465  _spec: Composite
-0004bc00: 5370 6563 2920 2d3e 2043 6f6d 706f 7369  Spec) -> Composi
-0004bc10: 7465 5370 6563 3a0d 0a20 2020 2020 2020  teSpec:..       
-0004bc20: 2066 756c 6c5f 646f 6e65 5f73 7065 6320   full_done_spec 
-0004bc30: 3d20 6f75 7470 7574 5f73 7065 635b 2266  = output_spec["f
-0004bc40: 756c 6c5f 646f 6e65 5f73 7065 6322 5d0d  ull_done_spec"].
-0004bc50: 0a20 2020 2020 2020 2066 756c 6c5f 7265  .        full_re
-0004bc60: 7761 7264 5f73 7065 6320 3d20 6f75 7470  ward_spec = outp
-0004bc70: 7574 5f73 7065 635b 2266 756c 6c5f 7265  ut_spec["full_re
-0004bc80: 7761 7264 5f73 7065 6322 5d0d 0a20 2020  ward_spec"]..   
-0004bc90: 2020 2020 2066 756c 6c5f 6f62 7365 7276       full_observ
-0004bca0: 6174 696f 6e5f 7370 6563 203d 206f 7574  ation_spec = out
-0004bcb0: 7075 745f 7370 6563 5b22 6675 6c6c 5f6f  put_spec["full_o
-0004bcc0: 6273 6572 7661 7469 6f6e 5f73 7065 6322  bservation_spec"
-0004bcd0: 5d0d 0a20 2020 2020 2020 2023 2077 6520  ]..        # we 
-0004bce0: 7265 7665 7273 6520 7468 696e 6773 2074  reverse things t
-0004bcf0: 6f20 6d61 6b65 2073 7572 6520 7765 2064  o make sure we d
-0004bd00: 656c 6574 6520 7468 696e 6773 2066 726f  elete things fro
-0004bd10: 6d20 7468 6520 6261 636b 0d0a 2020 2020  m the back..    
-0004bd20: 2020 2020 666f 7220 6b65 792c 2073 7065      for key, spe
-0004bd30: 6320 696e 2073 6f72 7465 6428 0d0a 2020  c in sorted(..  
-0004bd40: 2020 2020 2020 2020 2020 6675 6c6c 5f64            full_d
-0004bd50: 6f6e 655f 7370 6563 2e69 7465 6d73 2854  one_spec.items(T
-0004bd60: 7275 6529 2c20 6b65 793d 7365 6c66 2e5f  rue), key=self._
-0004bd70: 736f 7274 6572 2c20 7265 7665 7273 653d  sorter, reverse=
-0004bd80: 5472 7565 0d0a 2020 2020 2020 2020 293a  True..        ):
-0004bd90: 0d0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-0004bda0: 2069 7369 6e73 7461 6e63 6528 7370 6563   isinstance(spec
-0004bdb0: 2c20 436f 6d70 6f73 6974 6553 7065 6329  , CompositeSpec)
-0004bdc0: 2061 6e64 2073 7065 632e 6973 5f65 6d70   and spec.is_emp
-0004bdd0: 7479 2829 3a0d 0a20 2020 2020 2020 2020  ty():..         
-0004bde0: 2020 2020 2020 2064 656c 2066 756c 6c5f         del full_
-0004bdf0: 646f 6e65 5f73 7065 635b 6b65 795d 0d0a  done_spec[key]..
-0004be00: 0d0a 2020 2020 2020 2020 666f 7220 6b65  ..        for ke
-0004be10: 792c 2073 7065 6320 696e 2073 6f72 7465  y, spec in sorte
-0004be20: 6428 0d0a 2020 2020 2020 2020 2020 2020  d(..            
-0004be30: 6675 6c6c 5f6f 6273 6572 7661 7469 6f6e  full_observation
-0004be40: 5f73 7065 632e 6974 656d 7328 5472 7565  _spec.items(True
-0004be50: 292c 206b 6579 3d73 656c 662e 5f73 6f72  ), key=self._sor
-0004be60: 7465 722c 2072 6576 6572 7365 3d54 7275  ter, reverse=Tru
-0004be70: 650d 0a20 2020 2020 2020 2029 3a0d 0a20  e..        ):.. 
-0004be80: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-0004be90: 696e 7374 616e 6365 2873 7065 632c 2043  instance(spec, C
-0004bea0: 6f6d 706f 7369 7465 5370 6563 2920 616e  ompositeSpec) an
-0004beb0: 6420 7370 6563 2e69 735f 656d 7074 7928  d spec.is_empty(
-0004bec0: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
-0004bed0: 2020 2020 6465 6c20 6675 6c6c 5f6f 6273      del full_obs
-0004bee0: 6572 7661 7469 6f6e 5f73 7065 635b 6b65  ervation_spec[ke
-0004bef0: 795d 0d0a 0d0a 2020 2020 2020 2020 666f  y]....        fo
-0004bf00: 7220 6b65 792c 2073 7065 6320 696e 2073  r key, spec in s
-0004bf10: 6f72 7465 6428 0d0a 2020 2020 2020 2020  orted(..        
-0004bf20: 2020 2020 6675 6c6c 5f72 6577 6172 645f      full_reward_
-0004bf30: 7370 6563 2e69 7465 6d73 2854 7275 6529  spec.items(True)
-0004bf40: 2c20 6b65 793d 7365 6c66 2e5f 736f 7274  , key=self._sort
-0004bf50: 6572 2c20 7265 7665 7273 653d 5472 7565  er, reverse=True
-0004bf60: 0d0a 2020 2020 2020 2020 293a 0d0a 2020  ..        ):..  
-0004bf70: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
-0004bf80: 6e73 7461 6e63 6528 7370 6563 2c20 436f  nstance(spec, Co
-0004bf90: 6d70 6f73 6974 6553 7065 6329 2061 6e64  mpositeSpec) and
-0004bfa0: 2073 7065 632e 6973 5f65 6d70 7479 2829   spec.is_empty()
-0004bfb0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-0004bfc0: 2020 2064 656c 2066 756c 6c5f 7265 7761     del full_rewa
-0004bfd0: 7264 5f73 7065 635b 6b65 795d 0d0a 2020  rd_spec[key]..  
-0004bfe0: 2020 2020 2020 7265 7475 726e 206f 7574        return out
-0004bff0: 7075 745f 7370 6563 0d0a 0d0a 2020 2020  put_spec....    
-0004c000: 6465 6620 7472 616e 7366 6f72 6d5f 696e  def transform_in
-0004c010: 7075 745f 7370 6563 2873 656c 662c 2069  put_spec(self, i
-0004c020: 6e70 7574 5f73 7065 633a 2054 656e 736f  nput_spec: Tenso
-0004c030: 7253 7065 6329 202d 3e20 5465 6e73 6f72  rSpec) -> Tensor
-0004c040: 5370 6563 3a0d 0a20 2020 2020 2020 2066  Spec:..        f
-0004c050: 756c 6c5f 6163 7469 6f6e 5f73 7065 6320  ull_action_spec 
-0004c060: 3d20 696e 7075 745f 7370 6563 5b22 6675  = input_spec["fu
-0004c070: 6c6c 5f61 6374 696f 6e5f 7370 6563 225d  ll_action_spec"]
-0004c080: 0d0a 2020 2020 2020 2020 6675 6c6c 5f73  ..        full_s
-0004c090: 7461 7465 5f73 7065 6320 3d20 696e 7075  tate_spec = inpu
-0004c0a0: 745f 7370 6563 5b22 6675 6c6c 5f73 7461  t_spec["full_sta
-0004c0b0: 7465 5f73 7065 6322 5d0d 0a20 2020 2020  te_spec"]..     
-0004c0c0: 2020 2023 2077 6520 7265 7665 7273 6520     # we reverse 
-0004c0d0: 7468 696e 6773 2074 6f20 6d61 6b65 2073  things to make s
-0004c0e0: 7572 6520 7765 2064 656c 6574 6520 7468  ure we delete th
-0004c0f0: 696e 6773 2066 726f 6d20 7468 6520 6261  ings from the ba
-0004c100: 636b 0d0a 0d0a 2020 2020 2020 2020 7365  ck....        se
-0004c110: 6c66 2e5f 6861 735f 656d 7074 795f 696e  lf._has_empty_in
-0004c120: 7075 7420 3d20 4661 6c73 650d 0a20 2020  put = False..   
-0004c130: 2020 2020 2066 6f72 206b 6579 2c20 7370       for key, sp
-0004c140: 6563 2069 6e20 736f 7274 6564 280d 0a20  ec in sorted(.. 
-0004c150: 2020 2020 2020 2020 2020 2066 756c 6c5f             full_
-0004c160: 6163 7469 6f6e 5f73 7065 632e 6974 656d  action_spec.item
-0004c170: 7328 5472 7565 292c 206b 6579 3d73 656c  s(True), key=sel
-0004c180: 662e 5f73 6f72 7465 722c 2072 6576 6572  f._sorter, rever
-0004c190: 7365 3d54 7275 650d 0a20 2020 2020 2020  se=True..       
-0004c1a0: 2029 3a0d 0a20 2020 2020 2020 2020 2020   ):..           
-0004c1b0: 2069 6620 6973 696e 7374 616e 6365 2873   if isinstance(s
-0004c1c0: 7065 632c 2043 6f6d 706f 7369 7465 5370  pec, CompositeSp
-0004c1d0: 6563 2920 616e 6420 7370 6563 2e69 735f  ec) and spec.is_
-0004c1e0: 656d 7074 7928 293a 0d0a 2020 2020 2020  empty():..      
-0004c1f0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-0004c200: 6861 735f 656d 7074 795f 696e 7075 7420  has_empty_input 
-0004c210: 3d20 5472 7565 0d0a 2020 2020 2020 2020  = True..        
-0004c220: 2020 2020 2020 2020 6465 6c20 6675 6c6c          del full
-0004c230: 5f61 6374 696f 6e5f 7370 6563 5b6b 6579  _action_spec[key
-0004c240: 5d0d 0a0d 0a20 2020 2020 2020 2066 6f72  ]....        for
-0004c250: 206b 6579 2c20 7370 6563 2069 6e20 736f   key, spec in so
-0004c260: 7274 6564 280d 0a20 2020 2020 2020 2020  rted(..         
-0004c270: 2020 2066 756c 6c5f 7374 6174 655f 7370     full_state_sp
-0004c280: 6563 2e69 7465 6d73 2854 7275 6529 2c20  ec.items(True), 
-0004c290: 6b65 793d 7365 6c66 2e5f 736f 7274 6572  key=self._sorter
-0004c2a0: 2c20 7265 7665 7273 653d 5472 7565 0d0a  , reverse=True..
-0004c2b0: 2020 2020 2020 2020 293a 0d0a 2020 2020          ):..    
-0004c2c0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0004c2d0: 7461 6e63 6528 7370 6563 2c20 436f 6d70  tance(spec, Comp
-0004c2e0: 6f73 6974 6553 7065 6329 2061 6e64 2073  ositeSpec) and s
-0004c2f0: 7065 632e 6973 5f65 6d70 7479 2829 3a0d  pec.is_empty():.
-0004c300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004c310: 2073 656c 662e 5f68 6173 5f65 6d70 7479   self._has_empty
-0004c320: 5f69 6e70 7574 203d 2054 7275 650d 0a20  _input = True.. 
-0004c330: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0004c340: 656c 2066 756c 6c5f 7374 6174 655f 7370  el full_state_sp
-0004c350: 6563 5b6b 6579 5d0d 0a20 2020 2020 2020  ec[key]..       
-0004c360: 2072 6574 7572 6e20 696e 7075 745f 7370   return input_sp
-0004c370: 6563 0d0a 0d0a 2020 2020 6465 6620 5f69  ec....    def _i
-0004c380: 6e76 5f63 616c 6c28 7365 6c66 2c20 7465  nv_call(self, te
-0004c390: 6e73 6f72 6469 6374 3a20 5465 6e73 6f72  nsordict: Tensor
-0004c3a0: 4469 6374 4261 7365 2920 2d3e 2054 656e  DictBase) -> Ten
-0004c3b0: 736f 7244 6963 7442 6173 653a 0d0a 2020  sorDictBase:..  
-0004c3c0: 2020 2020 2020 6966 2073 656c 662e 5f68        if self._h
-0004c3d0: 6173 5f65 6d70 7479 5f69 6e70 7574 3a0d  as_empty_input:.
-0004c3e0: 0a20 2020 2020 2020 2020 2020 2069 6e70  .            inp
-0004c3f0: 7574 5f73 7065 6320 3d20 6765 7461 7474  ut_spec = getatt
-0004c400: 7228 7365 6c66 2e70 6172 656e 742c 2022  r(self.parent, "
-0004c410: 696e 7075 745f 7370 6563 222c 204e 6f6e  input_spec", Non
-0004c420: 6529 0d0a 2020 2020 2020 2020 2020 2020  e)..            
-0004c430: 6966 2069 6e70 7574 5f73 7065 6320 6973  if input_spec is
-0004c440: 204e 6f6e 653a 0d0a 2020 2020 2020 2020   None:..        
-0004c450: 2020 2020 2020 2020 7265 7475 726e 2074          return t
-0004c460: 656e 736f 7264 6963 740d 0a0d 0a20 2020  ensordict....   
-0004c470: 2020 2020 2020 2020 2066 756c 6c5f 6163           full_ac
-0004c480: 7469 6f6e 5f73 7065 6320 3d20 696e 7075  tion_spec = inpu
-0004c490: 745f 7370 6563 5b22 6675 6c6c 5f61 6374  t_spec["full_act
-0004c4a0: 696f 6e5f 7370 6563 225d 0d0a 2020 2020  ion_spec"]..    
-0004c4b0: 2020 2020 2020 2020 6675 6c6c 5f73 7461          full_sta
-0004c4c0: 7465 5f73 7065 6320 3d20 696e 7075 745f  te_spec = input_
-0004c4d0: 7370 6563 5b22 6675 6c6c 5f73 7461 7465  spec["full_state
-0004c4e0: 5f73 7065 6322 5d0d 0a20 2020 2020 2020  _spec"]..       
-0004c4f0: 2020 2020 2023 2077 6520 7265 7665 7273       # we revers
-0004c500: 6520 7468 696e 6773 2074 6f20 6d61 6b65  e things to make
-0004c510: 2073 7572 6520 7765 2064 656c 6574 6520   sure we delete 
-0004c520: 7468 696e 6773 2066 726f 6d20 7468 6520  things from the 
-0004c530: 6261 636b 0d0a 0d0a 2020 2020 2020 2020  back....        
-0004c540: 2020 2020 666f 7220 6b65 792c 2073 7065      for key, spe
-0004c550: 6320 696e 2073 6f72 7465 6428 0d0a 2020  c in sorted(..  
-0004c560: 2020 2020 2020 2020 2020 2020 2020 6675                fu
-0004c570: 6c6c 5f61 6374 696f 6e5f 7370 6563 2e69  ll_action_spec.i
-0004c580: 7465 6d73 2854 7275 6529 2c20 6b65 793d  tems(True), key=
-0004c590: 7365 6c66 2e5f 736f 7274 6572 2c20 7265  self._sorter, re
-0004c5a0: 7665 7273 653d 5472 7565 0d0a 2020 2020  verse=True..    
-0004c5b0: 2020 2020 2020 2020 293a 0d0a 2020 2020          ):..    
-0004c5c0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0004c5d0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0004c5e0: 2020 2020 2020 6973 696e 7374 616e 6365        isinstance
-0004c5f0: 2873 7065 632c 2043 6f6d 706f 7369 7465  (spec, Composite
-0004c600: 5370 6563 290d 0a20 2020 2020 2020 2020  Spec)..         
-0004c610: 2020 2020 2020 2020 2020 2061 6e64 2073             and s
-0004c620: 7065 632e 6973 5f65 6d70 7479 2829 0d0a  pec.is_empty()..
-0004c630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c640: 2020 2020 616e 6420 6b65 7920 6e6f 7420      and key not 
-0004c650: 696e 2074 656e 736f 7264 6963 742e 6b65  in tensordict.ke
-0004c660: 7973 2854 7275 6529 0d0a 2020 2020 2020  ys(True)..      
-0004c670: 2020 2020 2020 2020 2020 293a 0d0a 2020            ):..  
-0004c680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c690: 2020 7465 6e73 6f72 6469 6374 2e63 7265    tensordict.cre
-0004c6a0: 6174 655f 6e65 7374 6564 286b 6579 290d  ate_nested(key).
-0004c6b0: 0a0d 0a20 2020 2020 2020 2020 2020 2066  ...            f
-0004c6c0: 6f72 206b 6579 2c20 7370 6563 2069 6e20  or key, spec in 
-0004c6d0: 736f 7274 6564 280d 0a20 2020 2020 2020  sorted(..       
-0004c6e0: 2020 2020 2020 2020 2066 756c 6c5f 7374           full_st
-0004c6f0: 6174 655f 7370 6563 2e69 7465 6d73 2854  ate_spec.items(T
-0004c700: 7275 6529 2c20 6b65 793d 7365 6c66 2e5f  rue), key=self._
-0004c710: 736f 7274 6572 2c20 7265 7665 7273 653d  sorter, reverse=
-0004c720: 5472 7565 0d0a 2020 2020 2020 2020 2020  True..          
-0004c730: 2020 293a 0d0a 2020 2020 2020 2020 2020    ):..          
-0004c740: 2020 2020 2020 6966 2028 0d0a 2020 2020        if (..    
-0004c750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c760: 6973 696e 7374 616e 6365 2873 7065 632c  isinstance(spec,
-0004c770: 2043 6f6d 706f 7369 7465 5370 6563 290d   CompositeSpec).
-0004c780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004c790: 2020 2020 2061 6e64 2073 7065 632e 6973       and spec.is
-0004c7a0: 5f65 6d70 7479 2829 0d0a 2020 2020 2020  _empty()..      
-0004c7b0: 2020 2020 2020 2020 2020 2020 2020 616e                an
-0004c7c0: 6420 6b65 7920 6e6f 7420 696e 2074 656e  d key not in ten
-0004c7d0: 736f 7264 6963 742e 6b65 7973 2854 7275  sordict.keys(Tru
-0004c7e0: 6529 0d0a 2020 2020 2020 2020 2020 2020  e)..            
-0004c7f0: 2020 2020 293a 0d0a 2020 2020 2020 2020      ):..        
-0004c800: 2020 2020 2020 2020 2020 2020 7465 6e73              tens
-0004c810: 6f72 6469 6374 2e63 7265 6174 655f 6e65  ordict.create_ne
-0004c820: 7374 6564 286b 6579 290d 0a20 2020 2020  sted(key)..     
-0004c830: 2020 2072 6574 7572 6e20 7465 6e73 6f72     return tensor
-0004c840: 6469 6374 0d0a 0d0a 2020 2020 6465 6620  dict....    def 
-0004c850: 5f63 616c 6c28 7365 6c66 2c20 7465 6e73  _call(self, tens
-0004c860: 6f72 6469 6374 3a20 5465 6e73 6f72 4469  ordict: TensorDi
-0004c870: 6374 4261 7365 2920 2d3e 2054 656e 736f  ctBase) -> Tenso
-0004c880: 7244 6963 7442 6173 653a 0d0a 2020 2020  rDictBase:..    
-0004c890: 2020 2020 666f 7220 6b65 792c 2076 616c      for key, val
-0004c8a0: 7565 2069 6e20 736f 7274 6564 280d 0a20  ue in sorted(.. 
-0004c8b0: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
-0004c8c0: 7264 6963 742e 6974 656d 7328 5472 7565  rdict.items(True
-0004c8d0: 292c 206b 6579 3d73 656c 662e 5f73 6f72  ), key=self._sor
-0004c8e0: 7465 722c 2072 6576 6572 7365 3d54 7275  ter, reverse=Tru
-0004c8f0: 650d 0a20 2020 2020 2020 2029 3a0d 0a20  e..        ):.. 
-0004c900: 2020 2020 2020 2020 2020 2069 6620 280d             if (.
-0004c910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004c920: 2069 735f 7465 6e73 6f72 5f63 6f6c 6c65   is_tensor_colle
-0004c930: 6374 696f 6e28 7661 6c75 6529 0d0a 2020  ction(value)..  
-0004c940: 2020 2020 2020 2020 2020 2020 2020 616e                an
-0004c950: 6420 6e6f 7420 6973 696e 7374 616e 6365  d not isinstance
-0004c960: 2876 616c 7565 2c20 4e6f 6e54 656e 736f  (value, NonTenso
-0004c970: 7244 6174 6129 0d0a 2020 2020 2020 2020  rData)..        
-0004c980: 2020 2020 2020 2020 616e 6420 7661 6c75          and valu
-0004c990: 652e 6973 5f65 6d70 7479 2829 0d0a 2020  e.is_empty()..  
-0004c9a0: 2020 2020 2020 2020 2020 293a 0d0a 2020            ):..  
-0004c9b0: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0004c9c0: 6c20 7465 6e73 6f72 6469 6374 5b6b 6579  l tensordict[key
-0004c9d0: 5d0d 0a20 2020 2020 2020 2072 6574 7572  ]..        retur
-0004c9e0: 6e20 7465 6e73 6f72 6469 6374 0d0a 0d0a  n tensordict....
-0004c9f0: 2020 2020 6465 6620 5f72 6573 6574 280d      def _reset(.
-0004ca00: 0a20 2020 2020 2020 2073 656c 662c 2074  .        self, t
-0004ca10: 656e 736f 7264 6963 743a 2054 656e 736f  ensordict: Tenso
-0004ca20: 7244 6963 7442 6173 652c 2074 656e 736f  rDictBase, tenso
-0004ca30: 7264 6963 745f 7265 7365 743a 2054 656e  rdict_reset: Ten
-0004ca40: 736f 7244 6963 7442 6173 650d 0a20 2020  sorDictBase..   
-0004ca50: 2029 202d 3e20 5465 6e73 6f72 4469 6374   ) -> TensorDict
-0004ca60: 4261 7365 3a0d 0a20 2020 2020 2020 2022  Base:..        "
-0004ca70: 2222 5265 7365 7473 2061 2074 7261 6e73  ""Resets a trans
-0004ca80: 666f 726d 2069 6620 6974 2069 7320 7374  form if it is st
-0004ca90: 6174 6566 756c 2e22 2222 0d0a 2020 2020  ateful."""..    
-0004caa0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0004cab0: 5f63 616c 6c28 7465 6e73 6f72 6469 6374  _call(tensordict
-0004cac0: 5f72 6573 6574 290d 0a0d 0a20 2020 2066  _reset)....    f
-0004cad0: 6f72 7761 7264 203d 205f 6361 6c6c 0d0a  orward = _call..
-0004cae0: 0d0a 0d0a 636c 6173 7320 5f49 6e76 6572  ....class _Inver
-0004caf0: 7454 7261 6e73 666f 726d 2854 7261 6e73  tTransform(Trans
-0004cb00: 666f 726d 293a 0d0a 2020 2020 5f4d 4953  form):..    _MIS
-0004cb10: 5349 4e47 5f54 5241 4e53 464f 524d 5f45  SING_TRANSFORM_E
-0004cb20: 5252 4f52 203d 2028 0d0a 2020 2020 2020  RROR = (..      
-0004cb30: 2020 2254 6865 7265 2069 7320 6e6f 7420    "There is not 
-0004cb40: 6765 6e65 7269 6320 7275 6c65 2074 6f20  generic rule to 
-0004cb50: 696e 7665 7274 2061 2073 7065 6320 7472  invert a spec tr
-0004cb60: 616e 7366 6f72 6d2e 2022 0d0a 2020 2020  ansform. "..    
-0004cb70: 2020 2020 2250 6c65 6173 6520 6669 6c65      "Please file
-0004cb80: 2061 6e20 6973 7375 6520 6f6e 2067 6974   an issue on git
-0004cb90: 6875 6220 746f 2067 6574 2068 656c 702e  hub to get help.
-0004cba0: 220d 0a20 2020 2029 0d0a 0d0a 2020 2020  "..    )....    
-0004cbb0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
-0004cbc0: 662c 2074 7261 6e73 666f 726d 3a20 5472  f, transform: Tr
-0004cbd0: 616e 7366 6f72 6d29 3a0d 0a20 2020 2020  ansform):..     
-0004cbe0: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
-0004cbf0: 745f 5f28 290d 0a20 2020 2020 2020 2073  t__()..        s
-0004cc00: 656c 662e 7472 616e 7366 6f72 6d20 3d20  elf.transform = 
-0004cc10: 7472 616e 7366 6f72 6d0d 0a0d 0a20 2020  transform....   
-0004cc20: 2040 7072 6f70 6572 7479 0d0a 2020 2020   @property..    
-0004cc30: 6465 6620 696e 5f6b 6579 7328 7365 6c66  def in_keys(self
-0004cc40: 293a 0d0a 2020 2020 2020 2020 7265 7475  ):..        retu
-0004cc50: 726e 2073 656c 662e 7472 616e 7366 6f72  rn self.transfor
-0004cc60: 6d2e 696e 5f6b 6579 735f 696e 760d 0a0d  m.in_keys_inv...
-0004cc70: 0a20 2020 2040 696e 5f6b 6579 732e 7365  .    @in_keys.se
-0004cc80: 7474 6572 0d0a 2020 2020 6465 6620 696e  tter..    def in
-0004cc90: 5f6b 6579 7328 7365 6c66 2c20 7661 6c75  _keys(self, valu
-0004cca0: 6529 3a0d 0a20 2020 2020 2020 2069 6620  e):..        if 
-0004ccb0: 7661 6c75 6520 6973 206e 6f74 204e 6f6e  value is not Non
-0004ccc0: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
-0004ccd0: 7261 6973 6520 5275 6e74 696d 6545 7272  raise RuntimeErr
-0004cce0: 6f72 2822 4361 6e6e 6f74 2073 6574 206e  or("Cannot set n
-0004ccf0: 6f6e 2d6e 756c 6c20 7661 6c75 6520 696e  on-null value in
-0004cd00: 2069 6e5f 6b65 7973 2e22 290d 0a0d 0a20   in_keys.").... 
-0004cd10: 2020 2040 7072 6f70 6572 7479 0d0a 2020     @property..  
-0004cd20: 2020 6465 6620 696e 5f6b 6579 735f 696e    def in_keys_in
-0004cd30: 7628 7365 6c66 293a 0d0a 2020 2020 2020  v(self):..      
-0004cd40: 2020 7265 7475 726e 2073 656c 662e 7472    return self.tr
-0004cd50: 616e 7366 6f72 6d2e 696e 5f6b 6579 730d  ansform.in_keys.
-0004cd60: 0a0d 0a20 2020 2040 696e 5f6b 6579 735f  ...    @in_keys_
-0004cd70: 696e 762e 7365 7474 6572 0d0a 2020 2020  inv.setter..    
-0004cd80: 6465 6620 696e 5f6b 6579 735f 696e 7628  def in_keys_inv(
-0004cd90: 7365 6c66 2c20 7661 6c75 6529 3a0d 0a20  self, value):.. 
-0004cda0: 2020 2020 2020 2069 6620 7661 6c75 6520         if value 
-0004cdb0: 6973 206e 6f74 204e 6f6e 653a 0d0a 2020  is not None:..  
-0004cdc0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0004cdd0: 5275 6e74 696d 6545 7272 6f72 2822 4361  RuntimeError("Ca
-0004cde0: 6e6e 6f74 2073 6574 206e 6f6e 2d6e 756c  nnot set non-nul
-0004cdf0: 6c20 7661 6c75 6520 696e 2069 6e5f 6b65  l value in in_ke
-0004ce00: 7973 5f69 6e76 2e22 290d 0a0d 0a20 2020  ys_inv.")....   
-0004ce10: 2040 7072 6f70 6572 7479 0d0a 2020 2020   @property..    
-0004ce20: 6465 6620 6f75 745f 6b65 7973 2873 656c  def out_keys(sel
-0004ce30: 6629 3a0d 0a20 2020 2020 2020 2072 6574  f):..        ret
-0004ce40: 7572 6e20 7365 6c66 2e74 7261 6e73 666f  urn self.transfo
-0004ce50: 726d 2e6f 7574 5f6b 6579 735f 696e 760d  rm.out_keys_inv.
-0004ce60: 0a0d 0a20 2020 2040 6f75 745f 6b65 7973  ...    @out_keys
-0004ce70: 2e73 6574 7465 720d 0a20 2020 2064 6566  .setter..    def
-0004ce80: 206f 7574 5f6b 6579 7328 7365 6c66 2c20   out_keys(self, 
-0004ce90: 7661 6c75 6529 3a0d 0a20 2020 2020 2020  value):..       
-0004cea0: 2069 6620 7661 6c75 6520 6973 206e 6f74   if value is not
-0004ceb0: 204e 6f6e 653a 0d0a 2020 2020 2020 2020   None:..        
-0004cec0: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
-0004ced0: 6545 7272 6f72 2822 4361 6e6e 6f74 2073  eError("Cannot s
-0004cee0: 6574 206e 6f6e 2d6e 756c 6c20 7661 6c75  et non-null valu
-0004cef0: 6520 696e 206f 7574 5f6b 6579 732e 2229  e in out_keys.")
-0004cf00: 0d0a 0d0a 2020 2020 4070 726f 7065 7274  ....    @propert
-0004cf10: 790d 0a20 2020 2064 6566 206f 7574 5f6b  y..    def out_k
-0004cf20: 6579 735f 696e 7628 7365 6c66 293a 0d0a  eys_inv(self):..
-0004cf30: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0004cf40: 656c 662e 7472 616e 7366 6f72 6d2e 6f75  elf.transform.ou
-0004cf50: 745f 6b65 7973 0d0a 0d0a 2020 2020 406f  t_keys....    @o
-0004cf60: 7574 5f6b 6579 735f 696e 762e 7365 7474  ut_keys_inv.sett
-0004cf70: 6572 0d0a 2020 2020 6465 6620 6f75 745f  er..    def out_
-0004cf80: 6b65 7973 5f69 6e76 2873 656c 662c 2076  keys_inv(self, v
-0004cf90: 616c 7565 293a 0d0a 2020 2020 2020 2020  alue):..        
-0004cfa0: 6966 2076 616c 7565 2069 7320 6e6f 7420  if value is not 
-0004cfb0: 4e6f 6e65 3a0d 0a20 2020 2020 2020 2020  None:..         
-0004cfc0: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
-0004cfd0: 4572 726f 7228 2243 616e 6e6f 7420 7365  Error("Cannot se
-0004cfe0: 7420 6e6f 6e2d 6e75 6c6c 2076 616c 7565  t non-null value
-0004cff0: 2069 6e20 6f75 745f 6b65 7973 5f69 6e76   in out_keys_inv
-0004d000: 2e22 290d 0a0d 0a20 2020 2064 6566 2066  .")....    def f
-0004d010: 6f72 7761 7264 2873 656c 662c 2074 656e  orward(self, ten
-0004d020: 736f 7264 6963 743a 2054 656e 736f 7244  sordict: TensorD
-0004d030: 6963 7442 6173 6529 202d 3e20 5465 6e73  ictBase) -> Tens
-0004d040: 6f72 4469 6374 4261 7365 3a0d 0a20 2020  orDictBase:..   
-0004d050: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0004d060: 2e74 7261 6e73 666f 726d 2e69 6e76 2874  .transform.inv(t
-0004d070: 656e 736f 7264 6963 7429 0d0a 0d0a 2020  ensordict)....  
-0004d080: 2020 6465 6620 696e 7628 7365 6c66 2c20    def inv(self, 
-0004d090: 7465 6e73 6f72 6469 6374 3a20 5465 6e73  tensordict: Tens
-0004d0a0: 6f72 4469 6374 4261 7365 2920 2d3e 2054  orDictBase) -> T
-0004d0b0: 656e 736f 7244 6963 7442 6173 653a 0d0a  ensorDictBase:..
-0004d0c0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0004d0d0: 656c 662e 7472 616e 7366 6f72 6d2e 666f  elf.transform.fo
-0004d0e0: 7277 6172 6428 7465 6e73 6f72 6469 6374  rward(tensordict
-0004d0f0: 290d 0a0d 0a20 2020 2064 6566 205f 6361  )....    def _ca
-0004d100: 6c6c 2873 656c 662c 2074 656e 736f 7264  ll(self, tensord
-0004d110: 6963 743a 2054 656e 736f 7244 6963 7442  ict: TensorDictB
-0004d120: 6173 6529 202d 3e20 5465 6e73 6f72 4469  ase) -> TensorDi
-0004d130: 6374 4261 7365 3a0d 0a20 2020 2020 2020  ctBase:..       
-0004d140: 2072 6574 7572 6e20 7365 6c66 2e74 7261   return self.tra
-0004d150: 6e73 666f 726d 2e5f 696e 765f 6361 6c6c  nsform._inv_call
-0004d160: 2874 656e 736f 7264 6963 7429 0d0a 0d0a  (tensordict)....
-0004d170: 2020 2020 6465 6620 5f69 6e76 5f63 616c      def _inv_cal
-0004d180: 6c28 7365 6c66 2c20 7465 6e73 6f72 6469  l(self, tensordi
-0004d190: 6374 3a20 5465 6e73 6f72 4469 6374 4261  ct: TensorDictBa
-0004d1a0: 7365 2920 2d3e 2054 656e 736f 7244 6963  se) -> TensorDic
-0004d1b0: 7442 6173 653a 0d0a 2020 2020 2020 2020  tBase:..        
-0004d1c0: 7265 7475 726e 2073 656c 662e 7472 616e  return self.tran
-0004d1d0: 7366 6f72 6d2e 5f63 616c 6c28 7465 6e73  sform._call(tens
-0004d1e0: 6f72 6469 6374 290d 0a0d 0a20 2020 2064  ordict)....    d
-0004d1f0: 6566 2074 7261 6e73 666f 726d 5f6f 6273  ef transform_obs
-0004d200: 6572 7661 7469 6f6e 5f73 7065 6328 7365  ervation_spec(se
-0004d210: 6c66 2c20 6f62 7365 7276 6174 696f 6e5f  lf, observation_
-0004d220: 7370 6563 3a20 5465 6e73 6f72 5370 6563  spec: TensorSpec
-0004d230: 2920 2d3e 2054 656e 736f 7253 7065 633a  ) -> TensorSpec:
-0004d240: 0d0a 2020 2020 2020 2020 7261 6973 6520  ..        raise 
-0004d250: 5275 6e74 696d 6545 7272 6f72 2873 656c  RuntimeError(sel
-0004d260: 662e 5f4d 4953 5349 4e47 5f54 5241 4e53  f._MISSING_TRANS
-0004d270: 464f 524d 5f45 5252 4f52 290d 0a0d 0a20  FORM_ERROR).... 
-0004d280: 2020 2064 6566 2074 7261 6e73 666f 726d     def transform
-0004d290: 5f73 7461 7465 5f73 7065 6328 7365 6c66  _state_spec(self
-0004d2a0: 2c20 7374 6174 655f 7370 6563 3a20 5465  , state_spec: Te
-0004d2b0: 6e73 6f72 5370 6563 2920 2d3e 2054 656e  nsorSpec) -> Ten
-0004d2c0: 736f 7253 7065 633a 0d0a 2020 2020 2020  sorSpec:..      
-0004d2d0: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
-0004d2e0: 7272 6f72 2873 656c 662e 5f4d 4953 5349  rror(self._MISSI
-0004d2f0: 4e47 5f54 5241 4e53 464f 524d 5f45 5252  NG_TRANSFORM_ERR
-0004d300: 4f52 290d 0a0d 0a20 2020 2064 6566 2074  OR)....    def t
-0004d310: 7261 6e73 666f 726d 5f72 6577 6172 645f  ransform_reward_
-0004d320: 7370 6563 2873 656c 662c 2072 6577 6172  spec(self, rewar
-0004d330: 645f 7370 6563 3a20 5465 6e73 6f72 5370  d_spec: TensorSp
-0004d340: 6563 2920 2d3e 2054 656e 736f 7253 7065  ec) -> TensorSpe
-0004d350: 633a 0d0a 2020 2020 2020 2020 7261 6973  c:..        rais
-0004d360: 6520 5275 6e74 696d 6545 7272 6f72 2873  e RuntimeError(s
-0004d370: 656c 662e 5f4d 4953 5349 4e47 5f54 5241  elf._MISSING_TRA
-0004d380: 4e53 464f 524d 5f45 5252 4f52 290d 0a0d  NSFORM_ERROR)...
-0004d390: 0a20 2020 2064 6566 2074 7261 6e73 666f  .    def transfo
-0004d3a0: 726d 5f61 6374 696f 6e5f 7370 6563 2873  rm_action_spec(s
-0004d3b0: 656c 662c 2061 6374 696f 6e5f 7370 6563  elf, action_spec
-0004d3c0: 3a20 5465 6e73 6f72 5370 6563 2920 2d3e  : TensorSpec) ->
-0004d3d0: 2054 656e 736f 7253 7065 633a 0d0a 2020   TensorSpec:..  
-0004d3e0: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
-0004d3f0: 696d 6545 7272 6f72 2873 656c 662e 5f4d  imeError(self._M
-0004d400: 4953 5349 4e47 5f54 5241 4e53 464f 524d  ISSING_TRANSFORM
-0004d410: 5f45 5252 4f52 290d 0a0d 0a20 2020 2064  _ERROR)....    d
-0004d420: 6566 2074 7261 6e73 666f 726d 5f64 6f6e  ef transform_don
-0004d430: 655f 7370 6563 2873 656c 662c 2064 6f6e  e_spec(self, don
-0004d440: 655f 7370 6563 3a20 5465 6e73 6f72 5370  e_spec: TensorSp
-0004d450: 6563 2920 2d3e 2054 656e 736f 7253 7065  ec) -> TensorSpe
-0004d460: 633a 0d0a 2020 2020 2020 2020 7261 6973  c:..        rais
-0004d470: 6520 5275 6e74 696d 6545 7272 6f72 2873  e RuntimeError(s
-0004d480: 656c 662e 5f4d 4953 5349 4e47 5f54 5241  elf._MISSING_TRA
-0004d490: 4e53 464f 524d 5f45 5252 4f52 290d 0a0d  NSFORM_ERROR)...
-0004d4a0: 0a0d 0a63 6c61 7373 205f 4361 6c6c 6162  ...class _Callab
-0004d4b0: 6c65 5472 616e 7366 6f72 6d28 5472 616e  leTransform(Tran
-0004d4c0: 7366 6f72 6d29 3a0d 0a20 2020 2023 2041  sform):..    # A
-0004d4d0: 2077 7261 7070 6572 2061 726f 756e 6420   wrapper around 
-0004d4e0: 6120 6375 7374 6f6d 2063 616c 6c61 626c  a custom callabl
-0004d4f0: 6520 746f 206d 616b 6520 6974 2070 6f73  e to make it pos
-0004d500: 7369 626c 6520 746f 2074 7261 6e73 666f  sible to transfo
-0004d510: 726d 2061 6e79 2064 6174 6120 7479 7065  rm any data type
-0004d520: 0d0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
-0004d530: 5f5f 2873 656c 662c 2066 756e 6329 3a0d  __(self, func):.
-0004d540: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
-0004d550: 2e5f 5f69 6e69 745f 5f28 290d 0a20 2020  .__init__()..   
-0004d560: 2020 2020 2073 656c 662e 6675 6e63 203d       self.func =
-0004d570: 2066 756e 630d 0a0d 0a20 2020 2064 6566   func....    def
-0004d580: 2066 6f72 7761 7264 2873 656c 662c 202a   forward(self, *
-0004d590: 6172 6773 2c20 2a2a 6b77 6172 6773 293a  args, **kwargs):
-0004d5a0: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-0004d5b0: 2073 656c 662e 6675 6e63 282a 6172 6773   self.func(*args
-0004d5c0: 2c20 2a2a 6b77 6172 6773 290d 0a0d 0a20  , **kwargs).... 
-0004d5d0: 2020 2064 6566 205f 6361 6c6c 2873 656c     def _call(sel
-0004d5e0: 662c 2074 656e 736f 7264 6963 743a 2054  f, tensordict: T
-0004d5f0: 656e 736f 7244 6963 7442 6173 6529 3a0d  ensorDictBase):.
-0004d600: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0004d610: 7365 6c66 2e66 756e 6328 7465 6e73 6f72  self.func(tensor
-0004d620: 6469 6374 290d 0a0d 0a20 2020 2064 6566  dict)....    def
-0004d630: 205f 696e 765f 6361 6c6c 2873 656c 662c   _inv_call(self,
-0004d640: 2074 656e 736f 7264 6963 743a 2054 656e   tensordict: Ten
-0004d650: 736f 7244 6963 7442 6173 6529 202d 3e20  sorDictBase) -> 
-0004d660: 5465 6e73 6f72 4469 6374 4261 7365 3a0d  TensorDictBase:.
-0004d670: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0004d680: 7465 6e73 6f72 6469 6374 0d0a 0d0a 2020  tensordict....  
-0004d690: 2020 6465 6620 5f72 6573 6574 280d 0a20    def _reset(.. 
-0004d6a0: 2020 2020 2020 2073 656c 662c 2074 656e         self, ten
-0004d6b0: 736f 7264 6963 743a 2054 656e 736f 7244  sordict: TensorD
-0004d6c0: 6963 7442 6173 652c 2074 656e 736f 7264  ictBase, tensord
-0004d6d0: 6963 745f 7265 7365 743a 2054 656e 736f  ict_reset: Tenso
-0004d6e0: 7244 6963 7442 6173 650d 0a20 2020 2029  rDictBase..    )
-0004d6f0: 202d 3e20 5465 6e73 6f72 4469 6374 4261   -> TensorDictBa
-0004d700: 7365 3a0d 0a20 2020 2020 2020 2072 6574  se:..        ret
-0004d710: 7572 6e20 7365 6c66 2e5f 6361 6c6c 2874  urn self._call(t
-0004d720: 656e 736f 7264 6963 745f 7265 7365 7429  ensordict_reset)
-0004d730: 0d0a 0d0a 0d0a 636c 6173 7320 4261 7463  ......class Batc
-0004d740: 6853 697a 6554 7261 6e73 666f 726d 2854  hSizeTransform(T
-0004d750: 7261 6e73 666f 726d 293a 0d0a 2020 2020  ransform):..    
-0004d760: 2222 2241 2074 7261 6e73 666f 726d 2074  """A transform t
-0004d770: 6f20 6d6f 6469 6679 2074 6865 2062 6174  o modify the bat
-0004d780: 6368 2d73 697a 6520 6f66 2061 6e20 656e  ch-size of an en
-0004d790: 7669 726f 6e6d 742e 0d0a 0d0a 2020 2020  vironmt.....    
-0004d7a0: 5468 6973 2074 7261 6e73 666f 726d 2068  This transform h
-0004d7b0: 6173 2074 776f 2064 6973 7469 6e63 7420  as two distinct 
-0004d7c0: 7573 6167 6573 3a20 6974 2063 616e 2062  usages: it can b
-0004d7d0: 6520 7573 6564 2074 6f20 7365 7420 7468  e used to set th
-0004d7e0: 650d 0a20 2020 2062 6174 6368 2d73 697a  e..    batch-siz
-0004d7f0: 6520 666f 7220 6e6f 6e2d 6261 7463 682d  e for non-batch-
-0004d800: 6c6f 636b 6564 2028 652e 672e 2073 7461  locked (e.g. sta
-0004d810: 7465 6c65 7373 2920 656e 7669 726f 6e6d  teless) environm
-0004d820: 656e 7473 2074 6f0d 0a20 2020 2065 6e61  ents to..    ena
-0004d830: 626c 6520 6461 7461 2063 6f6c 6c65 6374  ble data collect
-0004d840: 696f 6e20 7573 696e 6720 6461 7461 2063  ion using data c
-0004d850: 6f6c 6c65 6374 6f72 732e 2049 7420 6361  ollectors. It ca
-0004d860: 6e20 616c 736f 2062 6520 7573 6564 0d0a  n also be used..
-0004d870: 2020 2020 746f 206d 6f64 6966 7920 7468      to modify th
-0004d880: 6520 6261 7463 682d 7369 7a65 206f 6620  e batch-size of 
-0004d890: 616e 2065 6e76 6972 6f6e 6d65 6e74 2028  an environment (
-0004d8a0: 652e 672e 2073 7175 6565 7a65 2c20 756e  e.g. squeeze, un
-0004d8b0: 7371 7565 657a 6520 6f72 0d0a 2020 2020  squeeze or..    
-0004d8c0: 7265 7368 6170 6529 2e0d 0a0d 0a20 2020  reshape).....   
-0004d8d0: 2054 6869 7320 7472 616e 7366 6f72 6d20   This transform 
-0004d8e0: 6d6f 6469 6669 6573 2074 6865 2065 6e76  modifies the env
-0004d8f0: 6972 6f6e 6d65 6e74 2062 6174 6368 2d73  ironment batch-s
-0004d900: 697a 6520 746f 206d 6174 6368 2074 6865  ize to match the
-0004d910: 206f 6e65 2070 726f 7669 6465 642e 0d0a   one provided...
-0004d920: 2020 2020 4974 2065 7870 6563 7473 2074      It expects t
-0004d930: 6865 2070 6172 656e 7420 656e 7669 726f  he parent enviro
-0004d940: 6e6d 656e 7420 6261 7463 682d 7369 7a65  nment batch-size
-0004d950: 2074 6f20 6265 2065 7870 616e 6461 626c   to be expandabl
-0004d960: 6520 746f 2074 6865 0d0a 2020 2020 7072  e to the..    pr
-0004d970: 6f76 6964 6564 206f 6e65 2e0d 0a0d 0a20  ovided one..... 
-0004d980: 2020 204b 6579 776f 7264 2041 7267 733a     Keyword Args:
-0004d990: 0d0a 2020 2020 2020 2020 6261 7463 685f  ..        batch_
-0004d9a0: 7369 7a65 2028 746f 7263 682e 5369 7a65  size (torch.Size
-0004d9b0: 206f 7220 6571 7569 7661 6c65 6e74 2c20   or equivalent, 
-0004d9c0: 6f70 7469 6f6e 616c 293a 2074 6865 206e  optional): the n
-0004d9d0: 6577 2062 6174 6368 2d73 697a 6520 6f66  ew batch-size of
-0004d9e0: 2074 6865 2065 6e76 6972 6f6e 6d65 6e74   the environment
-0004d9f0: 2e0d 0a20 2020 2020 2020 2020 2020 2045  ...            E
-0004da00: 7863 6c75 7369 7665 2077 6974 6820 6060  xclusive with ``
-0004da10: 7265 7368 6170 655f 666e 6060 2e0d 0a20  reshape_fn``... 
-0004da20: 2020 2020 2020 2072 6573 6861 7065 5f66         reshape_f
-0004da30: 6e20 2863 616c 6c61 626c 652c 206f 7074  n (callable, opt
-0004da40: 696f 6e61 6c29 3a20 6120 6361 6c6c 6162  ional): a callab
-0004da50: 6c65 2074 6f20 6d6f 6469 6679 2074 6865  le to modify the
-0004da60: 2065 6e76 6972 6f6e 6d65 6e74 2062 6174   environment bat
-0004da70: 6368 2d73 697a 652e 0d0a 2020 2020 2020  ch-size...      
-0004da80: 2020 2020 2020 4578 636c 7573 6976 6520        Exclusive 
-0004da90: 7769 7468 2060 6062 6174 6368 5f73 697a  with ``batch_siz
-0004daa0: 6560 602e 0d0a 0d0a 2020 2020 2020 2020  e``.....        
-0004dab0: 2020 2020 2e2e 206e 6f74 653a 3a20 4375      .. note:: Cu
-0004dac0: 7272 656e 746c 792c 2074 7261 6e73 666f  rrently, transfo
-0004dad0: 726d 6174 696f 6e73 2069 6e76 6f6c 7669  rmations involvi
-0004dae0: 6e67 0d0a 2020 2020 2020 2020 2020 2020  ng..            
-0004daf0: 2020 2020 6060 7265 7368 6170 6560 602c      ``reshape``,
-0004db00: 2060 6066 6c61 7474 656e 6060 2c20 6060   ``flatten``, ``
-0004db10: 756e 666c 6174 7465 6e60 602c 2060 6073  unflatten``, ``s
-0004db20: 7175 6565 7a65 6060 2061 6e64 2060 6075  queeze`` and ``u
-0004db30: 6e73 7175 6565 7a65 6060 0d0a 2020 2020  nsqueeze``..    
-0004db40: 2020 2020 2020 2020 2020 2020 6172 6520              are 
-0004db50: 7375 7070 6f72 7465 642e 2049 6620 616e  supported. If an
-0004db60: 6f74 6865 7220 7265 7368 6170 6520 6f70  other reshape op
-0004db70: 6572 6174 696f 6e20 6973 2072 6571 7569  eration is requi
-0004db80: 7265 642c 2070 6c65 6173 6520 7375 626d  red, please subm
-0004db90: 6974 0d0a 2020 2020 2020 2020 2020 2020  it..            
-0004dba0: 2020 2020 6120 6665 6174 7572 6520 7265      a feature re
-0004dbb0: 7175 6573 7420 6f6e 2054 6f72 6368 524c  quest on TorchRL
-0004dbc0: 2067 6974 6875 622e 0d0a 0d0a 2020 2020   github.....    
-0004dbd0: 2020 2020 7265 7365 745f 6675 6e63 2028      reset_func (
-0004dbe0: 6361 6c6c 6162 6c65 2c20 6f70 7469 6f6e  callable, option
-0004dbf0: 616c 293a 2061 2066 756e 6374 696f 6e20  al): a function 
-0004dc00: 7468 6174 2070 726f 6475 6365 7320 6120  that produces a 
-0004dc10: 7265 7365 7420 7465 6e73 6f72 6469 6374  reset tensordict
-0004dc20: 2e0d 0a20 2020 2020 2020 2020 2020 2054  ...            T
-0004dc30: 6865 2073 6967 6e61 7475 7265 206d 7573  he signature mus
-0004dc40: 7420 6d61 7463 6820 6060 4361 6c6c 6162  t match ``Callab
-0004dc50: 6c65 5b5b 5465 6e73 6f72 4469 6374 4261  le[[TensorDictBa
-0004dc60: 7365 2c20 5465 6e73 6f72 4469 6374 4261  se, TensorDictBa
-0004dc70: 7365 5d2c 2054 656e 736f 7244 6963 7442  se], TensorDictB
-0004dc80: 6173 655d 6060 0d0a 2020 2020 2020 2020  ase]``..        
-0004dc90: 2020 2020 7768 6572 6520 7468 6520 6669      where the fi
-0004dca0: 7273 7420 696e 7075 7420 6172 6775 6d65  rst input argume
-0004dcb0: 6e74 2069 7320 7468 6520 6f70 7469 6f6e  nt is the option
-0004dcc0: 616c 2074 656e 736f 7264 6963 7420 7061  al tensordict pa
-0004dcd0: 7373 6564 2074 6f20 7468 650d 0a20 2020  ssed to the..   
-0004dce0: 2020 2020 2020 2020 2065 6e76 6972 6f6e           environ
-0004dcf0: 6d65 6e74 2064 7572 696e 6720 7468 6520  ment during the 
-0004dd00: 6361 6c6c 2074 6f20 3a6d 6574 683a 607e  call to :meth:`~
-0004dd10: 456e 7642 6173 652e 7265 7365 7460 2061  EnvBase.reset` a
-0004dd20: 6e64 2074 6865 2073 6563 6f6e 640d 0a20  nd the second.. 
-0004dd30: 2020 2020 2020 2020 2020 2069 7320 7468             is th
-0004dd40: 6520 6f75 7470 7574 206f 6620 6060 5472  e output of ``Tr
-0004dd50: 616e 7366 6f72 6d65 6445 6e76 2e62 6173  ansformedEnv.bas
-0004dd60: 655f 656e 762e 7265 7365 7460 602e 2049  e_env.reset``. I
-0004dd70: 7420 6361 6e20 616c 736f 2073 7570 706f  t can also suppo
-0004dd80: 7274 2061 6e0d 0a20 2020 2020 2020 2020  rt an..         
-0004dd90: 2020 206f 7074 696f 6e61 6c20 6060 656e     optional ``en
-0004dda0: 7660 6020 6b65 7977 6f72 6420 6172 6775  v`` keyword argu
-0004ddb0: 6d65 6e74 2069 6620 6060 656e 765f 6b77  ment if ``env_kw
-0004ddc0: 6172 673d 5472 7565 6060 2e0d 0a20 2020  arg=True``...   
-0004ddd0: 2020 2020 2065 6e76 5f6b 7761 7267 2028       env_kwarg (
-0004dde0: 626f 6f6c 2c20 6f70 7469 6f6e 616c 293a  bool, optional):
-0004ddf0: 2069 6620 6060 5472 7565 6060 2c20 6060   if ``True``, ``
-0004de00: 7265 7365 745f 6675 6e63 6060 206d 7573  reset_func`` mus
-0004de10: 7420 7375 7070 6f72 7420 610d 0a20 2020  t support a..   
-0004de20: 2020 2020 2020 2020 2060 6065 6e76 6060           ``env``
-0004de30: 206b 6579 776f 7264 2061 7267 756d 656e   keyword argumen
-0004de40: 742e 2044 6566 6175 6c74 7320 746f 2060  t. Defaults to `
-0004de50: 6046 616c 7365 6060 2e20 5468 6520 656e  `False``. The en
-0004de60: 7620 7061 7373 6564 2077 696c 6c0d 0a20  v passed will.. 
-0004de70: 2020 2020 2020 2020 2020 2062 6520 7468             be th
-0004de80: 6520 656e 7620 6163 636f 6d70 616e 6965  e env accompanie
-0004de90: 6420 6279 2069 7473 2074 7261 6e73 666f  d by its transfo
-0004dea0: 726d 2e0d 0a0d 0a20 2020 2045 7861 6d70  rm.....    Examp
-0004deb0: 6c65 3a0d 0a20 2020 2020 2020 203e 3e3e  le:..        >>>
-0004dec0: 2023 2043 6861 6e67 696e 6720 7468 6520   # Changing the 
-0004ded0: 6261 7463 682d 7369 7a65 2077 6974 6820  batch-size with 
-0004dee0: 6120 6675 6e63 7469 6f6e 0d0a 2020 2020  a function..    
-0004def0: 2020 2020 3e3e 3e20 6672 6f6d 2074 6f72      >>> from tor
-0004df00: 6368 726c 2e65 6e76 7320 696d 706f 7274  chrl.envs import
-0004df10: 2047 796d 456e 760d 0a20 2020 2020 2020   GymEnv..       
-0004df20: 203e 3e3e 2062 6173 655f 656e 7620 3d20   >>> base_env = 
-0004df30: 4779 6d45 6e76 2822 4361 7274 506f 6c65  GymEnv("CartPole
-0004df40: 2d76 3122 290d 0a20 2020 2020 2020 203e  -v1")..        >
-0004df50: 3e3e 2065 6e76 203d 2054 7261 6e73 666f  >> env = Transfo
-0004df60: 726d 6564 456e 7628 6261 7365 5f65 6e76  rmedEnv(base_env
-0004df70: 2c20 4261 7463 6853 697a 6554 7261 6e73  , BatchSizeTrans
-0004df80: 666f 726d 2872 6573 6861 7065 5f66 6e3d  form(reshape_fn=
-0004df90: 6c61 6d62 6461 2064 6174 613a 2064 6174  lambda data: dat
-0004dfa0: 612e 7265 7368 6170 6528 312c 2031 2929  a.reshape(1, 1))
-0004dfb0: 290d 0a20 2020 2020 2020 203e 3e3e 2065  )..        >>> e
-0004dfc0: 6e76 2e72 6f6c 6c6f 7574 2834 290d 0a20  nv.rollout(4).. 
-0004dfd0: 2020 2020 2020 203e 3e3e 2023 2053 6574         >>> # Set
-0004dfe0: 7469 6e67 2074 6865 2073 6861 7065 206f  ting the shape o
-0004dff0: 6620 6120 7374 6174 656c 6573 7320 656e  f a stateless en
-0004e000: 7669 726f 6e6d 656e 740d 0a20 2020 2020  vironment..     
-0004e010: 2020 203e 3e3e 2063 6c61 7373 204d 7945     >>> class MyE
-0004e020: 6e76 2845 6e76 4261 7365 293a 0d0a 2020  nv(EnvBase):..  
-0004e030: 2020 2020 2020 2e2e 2e20 2020 2020 6261        ...     ba
-0004e040: 7463 685f 6c6f 636b 6564 203d 2046 616c  tch_locked = Fal
-0004e050: 7365 0d0a 2020 2020 2020 2020 2e2e 2e20  se..        ... 
-0004e060: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
-0004e070: 2873 656c 6629 3a0d 0a20 2020 2020 2020  (self):..       
-0004e080: 202e 2e2e 2020 2020 2020 2020 2073 7570   ...         sup
-0004e090: 6572 2829 2e5f 5f69 6e69 745f 5f28 290d  er().__init__().
-0004e0a0: 0a20 2020 2020 2020 202e 2e2e 2020 2020  .        ...    
-0004e0b0: 2020 2020 2073 656c 662e 6f62 7365 7276       self.observ
-0004e0c0: 6174 696f 6e5f 7370 6563 203d 2043 6f6d  ation_spec = Com
-0004e0d0: 706f 7369 7465 5370 6563 286f 6273 6572  positeSpec(obser
-0004e0e0: 7661 7469 6f6e 3d55 6e62 6f75 6e64 6564  vation=Unbounded
-0004e0f0: 436f 6e74 696e 756f 7573 5465 6e73 6f72  ContinuousTensor
-0004e100: 5370 6563 2833 2929 0d0a 2020 2020 2020  Spec(3))..      
-0004e110: 2020 2e2e 2e20 2020 2020 2020 2020 7365    ...         se
-0004e120: 6c66 2e72 6577 6172 645f 7370 6563 203d  lf.reward_spec =
-0004e130: 2055 6e62 6f75 6e64 6564 436f 6e74 696e   UnboundedContin
-0004e140: 756f 7573 5465 6e73 6f72 5370 6563 2831  uousTensorSpec(1
-0004e150: 290d 0a20 2020 2020 2020 202e 2e2e 2020  )..        ...  
-0004e160: 2020 2020 2020 2073 656c 662e 6163 7469         self.acti
-0004e170: 6f6e 5f73 7065 6320 3d20 556e 626f 756e  on_spec = Unboun
-0004e180: 6465 6443 6f6e 7469 6e75 6f75 7354 656e  dedContinuousTen
-0004e190: 736f 7253 7065 6328 3129 0d0a 2020 2020  sorSpec(1)..    
-0004e1a0: 2020 2020 2e2e 2e0d 0a20 2020 2020 2020      .....       
-0004e1b0: 202e 2e2e 2020 2020 2064 6566 205f 7265   ...     def _re
-0004e1c0: 7365 7428 7365 6c66 2c20 7465 6e73 6f72  set(self, tensor
-0004e1d0: 6469 6374 3a20 5465 6e73 6f72 4469 6374  dict: TensorDict
-0004e1e0: 4261 7365 2c20 2a2a 6b77 6172 6773 2920  Base, **kwargs) 
-0004e1f0: 2d3e 2054 656e 736f 7244 6963 7442 6173  -> TensorDictBas
-0004e200: 653a 0d0a 2020 2020 2020 2020 2e2e 2e20  e:..        ... 
-0004e210: 2020 2020 2020 2020 7465 6e73 6f72 6469          tensordi
-0004e220: 6374 5f62 6174 6368 5f73 697a 6520 3d20  ct_batch_size = 
-0004e230: 7465 6e73 6f72 6469 6374 2e62 6174 6368  tensordict.batch
-0004e240: 5f73 697a 6520 6966 2074 656e 736f 7264  _size if tensord
-0004e250: 6963 7420 6973 206e 6f74 204e 6f6e 6520  ict is not None 
-0004e260: 656c 7365 2074 6f72 6368 2e53 697a 6528  else torch.Size(
-0004e270: 5b5d 290d 0a20 2020 2020 2020 202e 2e2e  [])..        ...
-0004e280: 2020 2020 2020 2020 2072 6573 756c 7420           result 
-0004e290: 3d20 7365 6c66 2e6f 6273 6572 7661 7469  = self.observati
-0004e2a0: 6f6e 5f73 7065 632e 7261 6e64 2874 656e  on_spec.rand(ten
-0004e2b0: 736f 7264 6963 745f 6261 7463 685f 7369  sordict_batch_si
-0004e2c0: 7a65 290d 0a20 2020 2020 2020 202e 2e2e  ze)..        ...
-0004e2d0: 2020 2020 2020 2020 2072 6573 756c 742e           result.
-0004e2e0: 7570 6461 7465 2873 656c 662e 6675 6c6c  update(self.full
-0004e2f0: 5f64 6f6e 655f 7370 6563 2e7a 6572 6f28  _done_spec.zero(
-0004e300: 7465 6e73 6f72 6469 6374 5f62 6174 6368  tensordict_batch
-0004e310: 5f73 697a 6529 290d 0a20 2020 2020 2020  _size))..       
-0004e320: 202e 2e2e 2020 2020 2020 2020 2072 6574   ...         ret
-0004e330: 7572 6e20 7265 7375 6c74 0d0a 2020 2020  urn result..    
-0004e340: 2020 2020 2e2e 2e0d 0a20 2020 2020 2020      .....       
-0004e350: 202e 2e2e 2020 2020 2064 6566 205f 7374   ...     def _st
-0004e360: 6570 280d 0a20 2020 2020 2020 202e 2e2e  ep(..        ...
-0004e370: 2020 2020 2020 2020 2073 656c 662c 0d0a           self,..
-0004e380: 2020 2020 2020 2020 2e2e 2e20 2020 2020          ...     
-0004e390: 2020 2020 7465 6e73 6f72 6469 6374 3a20      tensordict: 
-0004e3a0: 5465 6e73 6f72 4469 6374 4261 7365 2c0d  TensorDictBase,.
-0004e3b0: 0a20 2020 2020 2020 202e 2e2e 2020 2020  .        ...    
-0004e3c0: 2029 202d 3e20 5465 6e73 6f72 4469 6374   ) -> TensorDict
-0004e3d0: 4261 7365 3a0d 0a20 2020 2020 2020 202e  Base:..        .
-0004e3e0: 2e2e 2020 2020 2020 2020 2072 6573 756c  ..         resul
-0004e3f0: 7420 3d20 7365 6c66 2e6f 6273 6572 7661  t = self.observa
-0004e400: 7469 6f6e 5f73 7065 632e 7261 6e64 2874  tion_spec.rand(t
-0004e410: 656e 736f 7264 6963 742e 6261 7463 685f  ensordict.batch_
-0004e420: 7369 7a65 290d 0a20 2020 2020 2020 202e  size)..        .
-0004e430: 2e2e 2020 2020 2020 2020 2072 6573 756c  ..         resul
-0004e440: 742e 7570 6461 7465 2873 656c 662e 6675  t.update(self.fu
-0004e450: 6c6c 5f64 6f6e 655f 7370 6563 2e7a 6572  ll_done_spec.zer
-0004e460: 6f28 7465 6e73 6f72 6469 6374 2e62 6174  o(tensordict.bat
-0004e470: 6368 5f73 697a 6529 290d 0a20 2020 2020  ch_size))..     
-0004e480: 2020 202e 2e2e 2020 2020 2020 2020 2072     ...         r
-0004e490: 6573 756c 742e 7570 6461 7465 2873 656c  esult.update(sel
-0004e4a0: 662e 6675 6c6c 5f72 6577 6172 645f 7370  f.full_reward_sp
-0004e4b0: 6563 2e7a 6572 6f28 7465 6e73 6f72 6469  ec.zero(tensordi
-0004e4c0: 6374 2e62 6174 6368 5f73 697a 6529 290d  ct.batch_size)).
-0004e4d0: 0a20 2020 2020 2020 202e 2e2e 2020 2020  .        ...    
-0004e4e0: 2020 2020 2072 6574 7572 6e20 7265 7375       return resu
-0004e4f0: 6c74 0d0a 2020 2020 2020 2020 2e2e 2e0d  lt..        ....
-0004e500: 0a20 2020 2020 2020 202e 2e2e 2020 2020  .        ...    
-0004e510: 2064 6566 205f 7365 745f 7365 6564 2873   def _set_seed(s
-0004e520: 656c 662c 2073 6565 643a 204f 7074 696f  elf, seed: Optio
-0004e530: 6e61 6c5b 696e 745d 293a 0d0a 2020 2020  nal[int]):..    
-0004e540: 2020 2020 2e2e 2e20 2020 2020 2020 2020      ...         
-0004e550: 7061 7373 0d0a 2020 2020 2020 2020 2e2e  pass..        ..
-0004e560: 2e0d 0a20 2020 2020 2020 203e 3e3e 2065  ...        >>> e
-0004e570: 6e76 203d 2054 7261 6e73 666f 726d 6564  nv = Transformed
-0004e580: 456e 7628 4d79 456e 7628 292c 2042 6174  Env(MyEnv(), Bat
-0004e590: 6368 5369 7a65 5472 616e 7366 6f72 6d28  chSizeTransform(
-0004e5a0: 5b35 5d29 290d 0a20 2020 2020 2020 203e  [5]))..        >
-0004e5b0: 3e3e 2061 7373 6572 7420 656e 762e 6261  >> assert env.ba
-0004e5c0: 7463 685f 7369 7a65 203d 3d20 746f 7263  tch_size == torc
-0004e5d0: 682e 5369 7a65 285b 355d 290d 0a20 2020  h.Size([5])..   
-0004e5e0: 2020 2020 203e 3e3e 2061 7373 6572 7420       >>> assert 
-0004e5f0: 656e 762e 726f 6c6c 6f75 7428 3130 292e  env.rollout(10).
-0004e600: 7368 6170 6520 3d3d 2074 6f72 6368 2e53  shape == torch.S
-0004e610: 697a 6528 5b35 2c20 3130 5d29 0d0a 0d0a  ize([5, 10])....
-0004e620: 2020 2020 5468 6520 6060 7265 7365 745f      The ``reset_
-0004e630: 6675 6e63 6060 2063 616e 2063 7265 6174  func`` can creat
-0004e640: 6520 6120 7465 6e73 6f72 6469 6374 2077  e a tensordict w
-0004e650: 6974 6820 7468 6520 6465 7369 7265 6420  ith the desired 
-0004e660: 6261 7463 682d 7369 7a65 2c20 616c 6c6f  batch-size, allo
-0004e670: 7769 6e67 2066 6f72 0d0a 2020 2020 6120  wing for..    a 
-0004e680: 6669 6e65 2d67 7261 696e 6564 2072 6573  fine-grained res
-0004e690: 6574 2063 616c 6c3a 0d0a 0d0a 2020 2020  et call:....    
-0004e6a0: 2020 2020 3e3e 3e20 6465 6620 7265 7365      >>> def rese
-0004e6b0: 745f 6675 6e63 2874 656e 736f 7264 6963  t_func(tensordic
-0004e6c0: 742c 2074 656e 736f 7264 6963 745f 7265  t, tensordict_re
-0004e6d0: 7365 742c 2065 6e76 293a 0d0a 2020 2020  set, env):..    
-0004e6e0: 2020 2020 2e2e 2e20 2020 2020 7265 7375      ...     resu
-0004e6f0: 6c74 203d 2065 6e76 2e6f 6273 6572 7661  lt = env.observa
-0004e700: 7469 6f6e 5f73 7065 632e 7261 6e64 2829  tion_spec.rand()
-0004e710: 0d0a 2020 2020 2020 2020 2e2e 2e20 2020  ..        ...   
-0004e720: 2020 7265 7375 6c74 2e75 7064 6174 6528    result.update(
-0004e730: 656e 762e 6675 6c6c 5f64 6f6e 655f 7370  env.full_done_sp
-0004e740: 6563 2e7a 6572 6f28 2929 0d0a 2020 2020  ec.zero())..    
-0004e750: 2020 2020 2e2e 2e20 2020 2020 6173 7365      ...     asse
-0004e760: 7274 2072 6573 756c 742e 6261 7463 685f  rt result.batch_
-0004e770: 7369 7a65 2021 3d20 746f 7263 682e 5369  size != torch.Si
-0004e780: 7a65 285b 5d29 0d0a 2020 2020 2020 2020  ze([])..        
-0004e790: 2e2e 2e20 2020 2020 7265 7475 726e 2072  ...     return r
-0004e7a0: 6573 756c 740d 0a20 2020 2020 2020 203e  esult..        >
-0004e7b0: 3e3e 2065 6e76 203d 2054 7261 6e73 666f  >> env = Transfo
-0004e7c0: 726d 6564 456e 7628 4d79 456e 7628 292c  rmedEnv(MyEnv(),
-0004e7d0: 2042 6174 6368 5369 7a65 5472 616e 7366   BatchSizeTransf
-0004e7e0: 6f72 6d28 5b35 5d2c 2072 6573 6574 5f66  orm([5], reset_f
-0004e7f0: 756e 633d 7265 7365 745f 6675 6e63 2c20  unc=reset_func, 
-0004e800: 656e 765f 6b77 6172 673d 5472 7565 2929  env_kwarg=True))
-0004e810: 0d0a 2020 2020 2020 2020 3e3e 3e20 7072  ..        >>> pr
-0004e820: 696e 7428 656e 762e 726f 6c6c 6f75 7428  int(env.rollout(
-0004e830: 3229 290d 0a20 2020 2020 2020 2054 656e  2))..        Ten
-0004e840: 736f 7244 6963 7428 0d0a 2020 2020 2020  sorDict(..      
-0004e850: 2020 2020 2020 6669 656c 6473 3d7b 0d0a        fields={..
-0004e860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e870: 6163 7469 6f6e 3a20 5465 6e73 6f72 2873  action: Tensor(s
-0004e880: 6861 7065 3d74 6f72 6368 2e53 697a 6528  hape=torch.Size(
-0004e890: 5b35 2c20 322c 2031 5d29 2c20 6465 7669  [5, 2, 1]), devi
-0004e8a0: 6365 3d63 7075 2c20 6474 7970 653d 746f  ce=cpu, dtype=to
-0004e8b0: 7263 682e 666c 6f61 7433 322c 2069 735f  rch.float32, is_
-0004e8c0: 7368 6172 6564 3d46 616c 7365 292c 0d0a  shared=False),..
-0004e8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e8e0: 646f 6e65 3a20 5465 6e73 6f72 2873 6861  done: Tensor(sha
-0004e8f0: 7065 3d74 6f72 6368 2e53 697a 6528 5b35  pe=torch.Size([5
-0004e900: 2c20 322c 2031 5d29 2c20 6465 7669 6365  , 2, 1]), device
-0004e910: 3d63 7075 2c20 6474 7970 653d 746f 7263  =cpu, dtype=torc
-0004e920: 682e 626f 6f6c 2c20 6973 5f73 6861 7265  h.bool, is_share
-0004e930: 643d 4661 6c73 6529 2c0d 0a20 2020 2020  d=False),..     
-0004e940: 2020 2020 2020 2020 2020 206e 6578 743a             next:
-0004e950: 2054 656e 736f 7244 6963 7428 0d0a 2020   TensorDict(..  
-0004e960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e970: 2020 6669 656c 6473 3d7b 0d0a 2020 2020    fields={..    
-0004e980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e990: 2020 2020 646f 6e65 3a20 5465 6e73 6f72      done: Tensor
-0004e9a0: 2873 6861 7065 3d74 6f72 6368 2e53 697a  (shape=torch.Siz
-0004e9b0: 6528 5b35 2c20 322c 2031 5d29 2c20 6465  e([5, 2, 1]), de
-0004e9c0: 7669 6365 3d63 7075 2c20 6474 7970 653d  vice=cpu, dtype=
-0004e9d0: 746f 7263 682e 626f 6f6c 2c20 6973 5f73  torch.bool, is_s
-0004e9e0: 6861 7265 643d 4661 6c73 6529 2c0d 0a20  hared=False),.. 
-0004e9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ea00: 2020 2020 2020 206f 6273 6572 7661 7469         observati
-0004ea10: 6f6e 3a20 5465 6e73 6f72 2873 6861 7065  on: Tensor(shape
-0004ea20: 3d74 6f72 6368 2e53 697a 6528 5b35 2c20  =torch.Size([5, 
-0004ea30: 322c 2033 5d29 2c20 6465 7669 6365 3d63  2, 3]), device=c
-0004ea40: 7075 2c20 6474 7970 653d 746f 7263 682e  pu, dtype=torch.
-0004ea50: 666c 6f61 7433 322c 2069 735f 7368 6172  float32, is_shar
-0004ea60: 6564 3d46 616c 7365 292c 0d0a 2020 2020  ed=False),..    
-0004ea70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ea80: 2020 2020 7265 7761 7264 3a20 5465 6e73      reward: Tens
-0004ea90: 6f72 2873 6861 7065 3d74 6f72 6368 2e53  or(shape=torch.S
-0004eaa0: 697a 6528 5b35 2c20 322c 2031 5d29 2c20  ize([5, 2, 1]), 
-0004eab0: 6465 7669 6365 3d63 7075 2c20 6474 7970  device=cpu, dtyp
-0004eac0: 653d 746f 7263 682e 666c 6f61 7433 322c  e=torch.float32,
-0004ead0: 2069 735f 7368 6172 6564 3d46 616c 7365   is_shared=False
-0004eae0: 292c 0d0a 2020 2020 2020 2020 2020 2020  ),..            
-0004eaf0: 2020 2020 2020 2020 2020 2020 7465 726d              term
-0004eb00: 696e 6174 6564 3a20 5465 6e73 6f72 2873  inated: Tensor(s
-0004eb10: 6861 7065 3d74 6f72 6368 2e53 697a 6528  hape=torch.Size(
-0004eb20: 5b35 2c20 322c 2031 5d29 2c20 6465 7669  [5, 2, 1]), devi
-0004eb30: 6365 3d63 7075 2c20 6474 7970 653d 746f  ce=cpu, dtype=to
-0004eb40: 7263 682e 626f 6f6c 2c20 6973 5f73 6861  rch.bool, is_sha
-0004eb50: 7265 643d 4661 6c73 6529 7d2c 0d0a 2020  red=False)},..  
-0004eb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004eb70: 2020 6261 7463 685f 7369 7a65 3d74 6f72    batch_size=tor
-0004eb80: 6368 2e53 697a 6528 5b35 2c20 325d 292c  ch.Size([5, 2]),
-0004eb90: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0004eba0: 2020 2020 2020 6465 7669 6365 3d4e 6f6e        device=Non
-0004ebb0: 652c 0d0a 2020 2020 2020 2020 2020 2020  e,..            
-0004ebc0: 2020 2020 2020 2020 6973 5f73 6861 7265          is_share
-0004ebd0: 643d 4661 6c73 6529 2c0d 0a20 2020 2020  d=False),..     
-0004ebe0: 2020 2020 2020 2020 2020 206f 6273 6572             obser
-0004ebf0: 7661 7469 6f6e 3a20 5465 6e73 6f72 2873  vation: Tensor(s
-0004ec00: 6861 7065 3d74 6f72 6368 2e53 697a 6528  hape=torch.Size(
-0004ec10: 5b35 2c20 322c 2033 5d29 2c20 6465 7669  [5, 2, 3]), devi
-0004ec20: 6365 3d63 7075 2c20 6474 7970 653d 746f  ce=cpu, dtype=to
-0004ec30: 7263 682e 666c 6f61 7433 322c 2069 735f  rch.float32, is_
-0004ec40: 7368 6172 6564 3d46 616c 7365 292c 0d0a  shared=False),..
-0004ec50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ec60: 7465 726d 696e 6174 6564 3a20 5465 6e73  terminated: Tens
-0004ec70: 6f72 2873 6861 7065 3d74 6f72 6368 2e53  or(shape=torch.S
-0004ec80: 697a 6528 5b35 2c20 322c 2031 5d29 2c20  ize([5, 2, 1]), 
-0004ec90: 6465 7669 6365 3d63 7075 2c20 6474 7970  device=cpu, dtyp
-0004eca0: 653d 746f 7263 682e 626f 6f6c 2c20 6973  e=torch.bool, is
-0004ecb0: 5f73 6861 7265 643d 4661 6c73 6529 7d2c  _shared=False)},
-0004ecc0: 0d0a 2020 2020 2020 2020 2020 2020 6261  ..            ba
-0004ecd0: 7463 685f 7369 7a65 3d74 6f72 6368 2e53  tch_size=torch.S
-0004ece0: 697a 6528 5b35 2c20 325d 292c 0d0a 2020  ize([5, 2]),..  
-0004ecf0: 2020 2020 2020 2020 2020 6465 7669 6365            device
-0004ed00: 3d4e 6f6e 652c 0d0a 2020 2020 2020 2020  =None,..        
-0004ed10: 2020 2020 6973 5f73 6861 7265 643d 4661      is_shared=Fa
-0004ed20: 6c73 6529 0d0a 0d0a 2020 2020 5468 6973  lse)....    This
-0004ed30: 2074 7261 6e73 666f 726d 2063 616e 2062   transform can b
-0004ed40: 6520 7573 6564 2074 6f20 6465 706c 6f79  e used to deploy
-0004ed50: 206e 6f6e 2d62 6174 6368 2d6c 6f63 6b65   non-batch-locke
-0004ed60: 6420 656e 7669 726f 6e6d 656e 7473 2077  d environments w
-0004ed70: 6974 6869 6e20 6461 7461 0d0a 2020 2020  ithin data..    
-0004ed80: 636f 6c6c 6563 746f 7273 3a0d 0a0d 0a20  collectors:.... 
-0004ed90: 2020 2020 2020 203e 3e3e 2066 726f 6d20         >>> from 
-0004eda0: 746f 7263 6872 6c2e 636f 6c6c 6563 746f  torchrl.collecto
-0004edb0: 7273 2069 6d70 6f72 7420 5379 6e63 4461  rs import SyncDa
-0004edc0: 7461 436f 6c6c 6563 746f 720d 0a20 2020  taCollector..   
-0004edd0: 2020 2020 203e 3e3e 2063 6f6c 6c65 6374       >>> collect
-0004ede0: 6f72 203d 2053 796e 6344 6174 6143 6f6c  or = SyncDataCol
-0004edf0: 6c65 6374 6f72 2865 6e76 2c20 6c61 6d62  lector(env, lamb
-0004ee00: 6461 2074 643a 2065 6e76 2e72 616e 645f  da td: env.rand_
-0004ee10: 6163 7469 6f6e 2874 6429 2c20 6672 616d  action(td), fram
-0004ee20: 6573 5f70 6572 5f62 6174 6368 3d31 302c  es_per_batch=10,
-0004ee30: 2074 6f74 616c 5f66 7261 6d65 733d 2d31   total_frames=-1
-0004ee40: 290d 0a20 2020 2020 2020 203e 3e3e 2066  )..        >>> f
-0004ee50: 6f72 2064 6174 6120 696e 2063 6f6c 6c65  or data in colle
-0004ee60: 6374 6f72 3a0d 0a20 2020 2020 2020 202e  ctor:..        .
-0004ee70: 2e2e 2020 2020 2070 7269 6e74 2864 6174  ..     print(dat
-0004ee80: 6129 0d0a 2020 2020 2020 2020 2e2e 2e20  a)..        ... 
-0004ee90: 2020 2020 6272 6561 6b0d 0a20 2020 2020      break..     
-0004eea0: 2020 2054 656e 736f 7244 6963 7428 0d0a     TensorDict(..
-0004eeb0: 2020 2020 2020 2020 2020 2020 6669 656c              fiel
-0004eec0: 6473 3d7b 0d0a 2020 2020 2020 2020 2020  ds={..          
-0004eed0: 2020 2020 2020 6163 7469 6f6e 3a20 5465        action: Te
-0004eee0: 6e73 6f72 2873 6861 7065 3d74 6f72 6368  nsor(shape=torch
-0004eef0: 2e53 697a 6528 5b35 2c20 322c 2031 5d29  .Size([5, 2, 1])
-0004ef00: 2c20 6465 7669 6365 3d63 7075 2c20 6474  , device=cpu, dt
-0004ef10: 7970 653d 746f 7263 682e 666c 6f61 7433  ype=torch.float3
-0004ef20: 322c 2069 735f 7368 6172 6564 3d46 616c  2, is_shared=Fal
-0004ef30: 7365 292c 0d0a 2020 2020 2020 2020 2020  se),..          
-0004ef40: 2020 2020 2020 636f 6c6c 6563 746f 723a        collector:
-0004ef50: 2054 656e 736f 7244 6963 7428 0d0a 2020   TensorDict(..  
-0004ef60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ef70: 2020 6669 656c 6473 3d7b 0d0a 2020 2020    fields={..    
-0004ef80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ef90: 2020 2020 7472 616a 5f69 6473 3a20 5465      traj_ids: Te
-0004efa0: 6e73 6f72 2873 6861 7065 3d74 6f72 6368  nsor(shape=torch
-0004efb0: 2e53 697a 6528 5b35 2c20 325d 292c 2064  .Size([5, 2]), d
-0004efc0: 6576 6963 653d 6370 752c 2064 7479 7065  evice=cpu, dtype
-0004efd0: 3d74 6f72 6368 2e69 6e74 3634 2c20 6973  =torch.int64, is
-0004efe0: 5f73 6861 7265 643d 4661 6c73 6529 7d2c  _shared=False)},
-0004eff0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0004f000: 2020 2020 2020 6261 7463 685f 7369 7a65        batch_size
-0004f010: 3d74 6f72 6368 2e53 697a 6528 5b35 2c20  =torch.Size([5, 
-0004f020: 325d 292c 0d0a 2020 2020 2020 2020 2020  2]),..          
-0004f030: 2020 2020 2020 2020 2020 6465 7669 6365            device
-0004f040: 3d4e 6f6e 652c 0d0a 2020 2020 2020 2020  =None,..        
-0004f050: 2020 2020 2020 2020 2020 2020 6973 5f73              is_s
-0004f060: 6861 7265 643d 4661 6c73 6529 2c0d 0a20  hared=False),.. 
-0004f070: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0004f080: 6f6e 653a 2054 656e 736f 7228 7368 6170  one: Tensor(shap
-0004f090: 653d 746f 7263 682e 5369 7a65 285b 352c  e=torch.Size([5,
-0004f0a0: 2032 2c20 315d 292c 2064 6576 6963 653d   2, 1]), device=
-0004f0b0: 6370 752c 2064 7479 7065 3d74 6f72 6368  cpu, dtype=torch
-0004f0c0: 2e62 6f6f 6c2c 2069 735f 7368 6172 6564  .bool, is_shared
-0004f0d0: 3d46 616c 7365 292c 0d0a 2020 2020 2020  =False),..      
-0004f0e0: 2020 2020 2020 2020 2020 6e65 7874 3a20            next: 
-0004f0f0: 5465 6e73 6f72 4469 6374 280d 0a20 2020  TensorDict(..   
-0004f100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f110: 2066 6965 6c64 733d 7b0d 0a20 2020 2020   fields={..     
-0004f120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f130: 2020 2064 6f6e 653a 2054 656e 736f 7228     done: Tensor(
-0004f140: 7368 6170 653d 746f 7263 682e 5369 7a65  shape=torch.Size
-0004f150: 285b 352c 2032 2c20 315d 292c 2064 6576  ([5, 2, 1]), dev
-0004f160: 6963 653d 6370 752c 2064 7479 7065 3d74  ice=cpu, dtype=t
-0004f170: 6f72 6368 2e62 6f6f 6c2c 2069 735f 7368  orch.bool, is_sh
-0004f180: 6172 6564 3d46 616c 7365 292c 0d0a 2020  ared=False),..  
-0004f190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f1a0: 2020 2020 2020 6f62 7365 7276 6174 696f        observatio
-0004f1b0: 6e3a 2054 656e 736f 7228 7368 6170 653d  n: Tensor(shape=
-0004f1c0: 746f 7263 682e 5369 7a65 285b 352c 2032  torch.Size([5, 2
-0004f1d0: 2c20 335d 292c 2064 6576 6963 653d 6370  , 3]), device=cp
-0004f1e0: 752c 2064 7479 7065 3d74 6f72 6368 2e66  u, dtype=torch.f
-0004f1f0: 6c6f 6174 3332 2c20 6973 5f73 6861 7265  loat32, is_share
-0004f200: 643d 4661 6c73 6529 2c0d 0a20 2020 2020  d=False),..     
-0004f210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f220: 2020 2072 6577 6172 643a 2054 656e 736f     reward: Tenso
-0004f230: 7228 7368 6170 653d 746f 7263 682e 5369  r(shape=torch.Si
-0004f240: 7a65 285b 352c 2032 2c20 315d 292c 2064  ze([5, 2, 1]), d
-0004f250: 6576 6963 653d 6370 752c 2064 7479 7065  evice=cpu, dtype
-0004f260: 3d74 6f72 6368 2e66 6c6f 6174 3332 2c20  =torch.float32, 
-0004f270: 6973 5f73 6861 7265 643d 4661 6c73 6529  is_shared=False)
-0004f280: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
-0004f290: 2020 2020 2020 2020 2020 2074 6572 6d69             termi
-0004f2a0: 6e61 7465 643a 2054 656e 736f 7228 7368  nated: Tensor(sh
-0004f2b0: 6170 653d 746f 7263 682e 5369 7a65 285b  ape=torch.Size([
-0004f2c0: 352c 2032 2c20 315d 292c 2064 6576 6963  5, 2, 1]), devic
-0004f2d0: 653d 6370 752c 2064 7479 7065 3d74 6f72  e=cpu, dtype=tor
-0004f2e0: 6368 2e62 6f6f 6c2c 2069 735f 7368 6172  ch.bool, is_shar
-0004f2f0: 6564 3d46 616c 7365 297d 2c0d 0a20 2020  ed=False)},..   
-0004f300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f310: 2062 6174 6368 5f73 697a 653d 746f 7263   batch_size=torc
-0004f320: 682e 5369 7a65 285b 352c 2032 5d29 2c0d  h.Size([5, 2]),.
-0004f330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004f340: 2020 2020 2064 6576 6963 653d 4e6f 6e65       device=None
-0004f350: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
-0004f360: 2020 2020 2020 2069 735f 7368 6172 6564         is_shared
-0004f370: 3d46 616c 7365 292c 0d0a 2020 2020 2020  =False),..      
-0004f380: 2020 2020 2020 2020 2020 6f62 7365 7276            observ
-0004f390: 6174 696f 6e3a 2054 656e 736f 7228 7368  ation: Tensor(sh
-0004f3a0: 6170 653d 746f 7263 682e 5369 7a65 285b  ape=torch.Size([
-0004f3b0: 352c 2032 2c20 335d 292c 2064 6576 6963  5, 2, 3]), devic
-0004f3c0: 653d 6370 752c 2064 7479 7065 3d74 6f72  e=cpu, dtype=tor
-0004f3d0: 6368 2e66 6c6f 6174 3332 2c20 6973 5f73  ch.float32, is_s
-0004f3e0: 6861 7265 643d 4661 6c73 6529 2c0d 0a20  hared=False),.. 
-0004f3f0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0004f400: 6572 6d69 6e61 7465 643a 2054 656e 736f  erminated: Tenso
-0004f410: 7228 7368 6170 653d 746f 7263 682e 5369  r(shape=torch.Si
-0004f420: 7a65 285b 352c 2032 2c20 315d 292c 2064  ze([5, 2, 1]), d
-0004f430: 6576 6963 653d 6370 752c 2064 7479 7065  evice=cpu, dtype
-0004f440: 3d74 6f72 6368 2e62 6f6f 6c2c 2069 735f  =torch.bool, is_
-0004f450: 7368 6172 6564 3d46 616c 7365 297d 2c0d  shared=False)},.
-0004f460: 0a20 2020 2020 2020 2020 2020 2062 6174  .            bat
-0004f470: 6368 5f73 697a 653d 746f 7263 682e 5369  ch_size=torch.Si
-0004f480: 7a65 285b 352c 2032 5d29 2c0d 0a20 2020  ze([5, 2]),..   
-0004f490: 2020 2020 2020 2020 2064 6576 6963 653d           device=
-0004f4a0: 4e6f 6e65 2c0d 0a20 2020 2020 2020 2020  None,..         
-0004f4b0: 2020 2069 735f 7368 6172 6564 3d46 616c     is_shared=Fal
-0004f4c0: 7365 290d 0a20 2020 2020 2020 203e 3e3e  se)..        >>>
-0004f4d0: 2063 6f6c 6c65 6374 6f72 2e73 6875 7464   collector.shutd
-0004f4e0: 6f77 6e28 290d 0a20 2020 2022 2222 0d0a  own()..    """..
-0004f4f0: 0d0a 2020 2020 5f45 4e56 5f45 5252 203d  ..    _ENV_ERR =
-0004f500: 2022 4261 7463 6853 697a 6554 7261 6e73   "BatchSizeTrans
-0004f510: 666f 726d 2e7b 7d20 7265 7175 6972 6573  form.{} requires
-0004f520: 2061 2070 6172 656e 7420 656e 762e 220d   a parent env.".
-0004f530: 0a0d 0a20 2020 2064 6566 205f 5f69 6e69  ...    def __ini
-0004f540: 745f 5f28 0d0a 2020 2020 2020 2020 7365  t__(..        se
-0004f550: 6c66 2c0d 0a20 2020 2020 2020 202a 2c0d  lf,..        *,.
-0004f560: 0a20 2020 2020 2020 2062 6174 6368 5f73  .        batch_s
-0004f570: 697a 653a 2074 6f72 6368 2e53 697a 6520  ize: torch.Size 
-0004f580: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0d0a  | None = None,..
-0004f590: 2020 2020 2020 2020 7265 7368 6170 655f          reshape_
-0004f5a0: 666e 3a20 4361 6c6c 6162 6c65 5b5b 5465  fn: Callable[[Te
-0004f5b0: 6e73 6f72 4469 6374 4261 7365 5d2c 2054  nsorDictBase], T
-0004f5c0: 656e 736f 7244 6963 7442 6173 655d 207c  ensorDictBase] |
-0004f5d0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0d 0a20   None = None,.. 
-0004f5e0: 2020 2020 2020 2072 6573 6574 5f66 756e         reset_fun
-0004f5f0: 633a 2043 616c 6c61 626c 655b 5b54 656e  c: Callable[[Ten
-0004f600: 736f 7244 6963 7442 6173 652c 2054 656e  sorDictBase, Ten
-0004f610: 736f 7244 6963 7442 6173 655d 2c20 5465  sorDictBase], Te
-0004f620: 6e73 6f72 4469 6374 4261 7365 5d0d 0a20  nsorDictBase].. 
-0004f630: 2020 2020 2020 207c 204e 6f6e 6520 3d20         | None = 
-0004f640: 4e6f 6e65 2c0d 0a20 2020 2020 2020 2065  None,..        e
-0004f650: 6e76 5f6b 7761 7267 3a20 626f 6f6c 203d  nv_kwarg: bool =
-0004f660: 2046 616c 7365 2c0d 0a20 2020 2029 3a0d   False,..    ):.
-0004f670: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
-0004f680: 2e5f 5f69 6e69 745f 5f28 290d 0a20 2020  .__init__()..   
-0004f690: 2020 2020 2069 6620 6e6f 7420 2828 6261       if not ((ba
-0004f6a0: 7463 685f 7369 7a65 2069 7320 4e6f 6e65  tch_size is None
-0004f6b0: 2920 5e20 2872 6573 6861 7065 5f66 6e20  ) ^ (reshape_fn 
-0004f6c0: 6973 204e 6f6e 6529 293a 0d0a 2020 2020  is None)):..    
-0004f6d0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-0004f6e0: 6c75 6545 7272 6f72 280d 0a20 2020 2020  lueError(..     
-0004f6f0: 2020 2020 2020 2020 2020 2022 4f6e 6520             "One 
-0004f700: 616e 6420 6f6e 6c79 206f 6e65 206f 6620  and only one of 
-0004f710: 6261 7463 685f 7369 7a65 204f 5220 7265  batch_size OR re
-0004f720: 7368 6170 655f 666e 206d 7573 7420 6265  shape_fn must be
-0004f730: 2070 726f 7669 6465 642e 220d 0a20 2020   provided."..   
-0004f740: 2020 2020 2020 2020 2029 0d0a 2020 2020           )..    
-0004f750: 2020 2020 6966 2062 6174 6368 5f73 697a      if batch_siz
-0004f760: 6520 6973 206e 6f74 204e 6f6e 653a 0d0a  e is not None:..
-0004f770: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0004f780: 2e62 6174 6368 5f73 697a 6520 3d20 746f  .batch_size = to
-0004f790: 7263 682e 5369 7a65 2862 6174 6368 5f73  rch.Size(batch_s
-0004f7a0: 697a 6529 0d0a 2020 2020 2020 2020 2020  ize)..          
-0004f7b0: 2020 7365 6c66 2e72 6573 6861 7065 5f66    self.reshape_f
-0004f7c0: 6e20 3d20 4e6f 6e65 0d0a 2020 2020 2020  n = None..      
-0004f7d0: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
-0004f7e0: 2020 2020 2073 656c 662e 7265 7368 6170       self.reshap
-0004f7f0: 655f 666e 203d 2072 6573 6861 7065 5f66  e_fn = reshape_f
-0004f800: 6e0d 0a20 2020 2020 2020 2020 2020 2073  n..            s
-0004f810: 656c 662e 6261 7463 685f 7369 7a65 203d  elf.batch_size =
-0004f820: 204e 6f6e 650d 0a20 2020 2020 2020 2073   None..        s
-0004f830: 656c 662e 7265 7368 6170 655f 666e 203d  elf.reshape_fn =
-0004f840: 2072 6573 6861 7065 5f66 6e0d 0a20 2020   reshape_fn..   
-0004f850: 2020 2020 2073 656c 662e 7265 7365 745f       self.reset_
-0004f860: 6675 6e63 203d 2072 6573 6574 5f66 756e  func = reset_fun
-0004f870: 630d 0a20 2020 2020 2020 2073 656c 662e  c..        self.
-0004f880: 656e 765f 6b77 6172 6720 3d20 656e 765f  env_kwarg = env_
-0004f890: 6b77 6172 670d 0a0d 0a20 2020 2064 6566  kwarg....    def
-0004f8a0: 205f 7265 7365 7428 0d0a 2020 2020 2020   _reset(..      
-0004f8b0: 2020 7365 6c66 2c20 7465 6e73 6f72 6469    self, tensordi
-0004f8c0: 6374 3a20 5465 6e73 6f72 4469 6374 4261  ct: TensorDictBa
-0004f8d0: 7365 2c20 7465 6e73 6f72 6469 6374 5f72  se, tensordict_r
-0004f8e0: 6573 6574 3a20 5465 6e73 6f72 4469 6374  eset: TensorDict
-0004f8f0: 4261 7365 0d0a 2020 2020 2920 2d3e 2054  Base..    ) -> T
-0004f900: 656e 736f 7244 6963 7442 6173 653a 0d0a  ensorDictBase:..
-0004f910: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0004f920: 7265 7365 745f 6675 6e63 2069 7320 6e6f  reset_func is no
-0004f930: 7420 4e6f 6e65 3a0d 0a20 2020 2020 2020  t None:..       
-0004f940: 2020 2020 2069 6620 7365 6c66 2e65 6e76       if self.env
-0004f950: 5f6b 7761 7267 3a0d 0a20 2020 2020 2020  _kwarg:..       
-0004f960: 2020 2020 2020 2020 2074 656e 736f 7264           tensord
-0004f970: 6963 745f 7265 7365 7420 3d20 7365 6c66  ict_reset = self
-0004f980: 2e72 6573 6574 5f66 756e 6328 0d0a 2020  .reset_func(..  
-0004f990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f9a0: 2020 7465 6e73 6f72 6469 6374 2c20 7465    tensordict, te
-0004f9b0: 6e73 6f72 6469 6374 5f72 6573 6574 2c20  nsordict_reset, 
-0004f9c0: 656e 763d 7365 6c66 2e63 6f6e 7461 696e  env=self.contain
-0004f9d0: 6572 0d0a 2020 2020 2020 2020 2020 2020  er..            
-0004f9e0: 2020 2020 290d 0a20 2020 2020 2020 2020      )..         
-0004f9f0: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
-0004fa00: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
-0004fa10: 6469 6374 5f72 6573 6574 203d 2073 656c  dict_reset = sel
-0004fa20: 662e 7265 7365 745f 6675 6e63 2874 656e  f.reset_func(ten
-0004fa30: 736f 7264 6963 742c 2074 656e 736f 7264  sordict, tensord
-0004fa40: 6963 745f 7265 7365 7429 0d0a 2020 2020  ict_reset)..    
-0004fa50: 2020 2020 6966 2073 656c 662e 6261 7463      if self.batc
-0004fa60: 685f 7369 7a65 2069 7320 6e6f 7420 4e6f  h_size is not No
-0004fa70: 6e65 3a0d 0a20 2020 2020 2020 2020 2020  ne:..           
-0004fa80: 2072 6574 7572 6e20 7465 6e73 6f72 6469   return tensordi
-0004fa90: 6374 5f72 6573 6574 2e65 7870 616e 6428  ct_reset.expand(
-0004faa0: 7365 6c66 2e62 6174 6368 5f73 697a 6529  self.batch_size)
-0004fab0: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-0004fac0: 2073 656c 662e 7265 7368 6170 655f 666e   self.reshape_fn
-0004fad0: 2874 656e 736f 7264 6963 745f 7265 7365  (tensordict_rese
-0004fae0: 7429 0d0a 0d0a 2020 2020 6465 6620 5f63  t)....    def _c
-0004faf0: 616c 6c28 7365 6c66 2c20 7465 6e73 6f72  all(self, tensor
-0004fb00: 6469 6374 3a20 5465 6e73 6f72 4469 6374  dict: TensorDict
-0004fb10: 4261 7365 2920 2d3e 2054 656e 736f 7244  Base) -> TensorD
-0004fb20: 6963 7442 6173 653a 0d0a 2020 2020 2020  ictBase:..      
-0004fb30: 2020 6966 2073 656c 662e 7265 7368 6170    if self.reshap
-0004fb40: 655f 666e 2069 7320 6e6f 7420 4e6f 6e65  e_fn is not None
-0004fb50: 3a0d 0a20 2020 2020 2020 2020 2020 2074  :..            t
-0004fb60: 656e 736f 7264 6963 7420 3d20 7365 6c66  ensordict = self
-0004fb70: 2e72 6573 6861 7065 5f66 6e28 7465 6e73  .reshape_fn(tens
-0004fb80: 6f72 6469 6374 290d 0a20 2020 2020 2020  ordict)..       
-0004fb90: 2072 6574 7572 6e20 7465 6e73 6f72 6469   return tensordi
-0004fba0: 6374 0d0a 0d0a 2020 2020 666f 7277 6172  ct....    forwar
-0004fbb0: 6420 3d20 5f63 616c 6c0d 0a0d 0a20 2020  d = _call....   
-0004fbc0: 2064 6566 205f 696e 765f 6361 6c6c 2873   def _inv_call(s
-0004fbd0: 656c 662c 2074 656e 736f 7264 6963 743a  elf, tensordict:
-0004fbe0: 2054 656e 736f 7244 6963 7442 6173 6529   TensorDictBase)
-0004fbf0: 202d 3e20 5465 6e73 6f72 4469 6374 4261   -> TensorDictBa
-0004fc00: 7365 3a0d 0a20 2020 2020 2020 2069 6620  se:..        if 
-0004fc10: 7365 6c66 2e72 6573 6861 7065 5f66 6e20  self.reshape_fn 
-0004fc20: 6973 206e 6f74 204e 6f6e 653a 0d0a 2020  is not None:..  
-0004fc30: 2020 2020 2020 2020 2020 7061 7265 6e74            parent
-0004fc40: 203d 2073 656c 662e 7061 7265 6e74 0d0a   = self.parent..
-0004fc50: 2020 2020 2020 2020 2020 2020 6966 2070              if p
-0004fc60: 6172 656e 7420 6973 206e 6f74 204e 6f6e  arent is not Non
-0004fc70: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
-0004fc80: 2020 2020 7061 7265 6e74 5f62 6174 6368      parent_batch
-0004fc90: 5f73 697a 6520 3d20 7061 7265 6e74 2e62  _size = parent.b
-0004fca0: 6174 6368 5f73 697a 650d 0a20 2020 2020  atch_size..     
-0004fcb0: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
-0004fcc0: 7264 6963 7420 3d20 7465 6e73 6f72 6469  rdict = tensordi
-0004fcd0: 6374 2e72 6573 6861 7065 2870 6172 656e  ct.reshape(paren
-0004fce0: 745f 6261 7463 685f 7369 7a65 290d 0a20  t_batch_size).. 
-0004fcf0: 2020 2020 2020 2072 6574 7572 6e20 7465         return te
-0004fd00: 6e73 6f72 6469 6374 0d0a 0d0a 2020 2020  nsordict....    
-0004fd10: 6465 6620 7472 616e 7366 6f72 6d5f 656e  def transform_en
-0004fd20: 765f 6261 7463 685f 7369 7a65 2873 656c  v_batch_size(sel
-0004fd30: 662c 2062 6174 6368 5f73 697a 653a 2074  f, batch_size: t
-0004fd40: 6f72 6368 2e53 697a 6529 3a0d 0a20 2020  orch.Size):..   
-0004fd50: 2020 2020 2069 6620 7365 6c66 2e62 6174       if self.bat
-0004fd60: 6368 5f73 697a 6520 6973 206e 6f74 204e  ch_size is not N
-0004fd70: 6f6e 653a 0d0a 2020 2020 2020 2020 2020  one:..          
-0004fd80: 2020 7265 7475 726e 2073 656c 662e 6261    return self.ba
-0004fd90: 7463 685f 7369 7a65 0d0a 2020 2020 2020  tch_size..      
-0004fda0: 2020 7265 7475 726e 2073 656c 662e 7265    return self.re
-0004fdb0: 7368 6170 655f 666e 2874 6f72 6368 2e7a  shape_fn(torch.z
-0004fdc0: 6572 6f73 2862 6174 6368 5f73 697a 652c  eros(batch_size,
-0004fdd0: 2064 6576 6963 653d 226d 6574 6122 2929   device="meta"))
-0004fde0: 2e73 6861 7065 0d0a 0d0a 2020 2020 6465  .shape....    de
-0004fdf0: 6620 7472 616e 7366 6f72 6d5f 6f75 7470  f transform_outp
-0004fe00: 7574 5f73 7065 6328 7365 6c66 2c20 6f75  ut_spec(self, ou
-0004fe10: 7470 7574 5f73 7065 633a 2043 6f6d 706f  tput_spec: Compo
-0004fe20: 7369 7465 5370 6563 2920 2d3e 2043 6f6d  siteSpec) -> Com
-0004fe30: 706f 7369 7465 5370 6563 3a0d 0a20 2020  positeSpec:..   
-0004fe40: 2020 2020 2069 6620 7365 6c66 2e62 6174       if self.bat
-0004fe50: 6368 5f73 697a 6520 6973 206e 6f74 204e  ch_size is not N
-0004fe60: 6f6e 653a 0d0a 2020 2020 2020 2020 2020  one:..          
-0004fe70: 2020 7265 7475 726e 206f 7574 7075 745f    return output_
-0004fe80: 7370 6563 2e65 7870 616e 6428 7365 6c66  spec.expand(self
-0004fe90: 2e62 6174 6368 5f73 697a 6529 0d0a 2020  .batch_size)..  
-0004fea0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-0004feb0: 662e 7265 7368 6170 655f 666e 286f 7574  f.reshape_fn(out
-0004fec0: 7075 745f 7370 6563 290d 0a0d 0a20 2020  put_spec)....   
-0004fed0: 2064 6566 2074 7261 6e73 666f 726d 5f69   def transform_i
-0004fee0: 6e70 7574 5f73 7065 6328 7365 6c66 2c20  nput_spec(self, 
-0004fef0: 696e 7075 745f 7370 6563 3a20 436f 6d70  input_spec: Comp
-0004ff00: 6f73 6974 6553 7065 6329 202d 3e20 436f  ositeSpec) -> Co
-0004ff10: 6d70 6f73 6974 6553 7065 633a 0d0a 2020  mpositeSpec:..  
-0004ff20: 2020 2020 2020 6966 2073 656c 662e 6261        if self.ba
-0004ff30: 7463 685f 7369 7a65 2069 7320 6e6f 7420  tch_size is not 
-0004ff40: 4e6f 6e65 3a0d 0a20 2020 2020 2020 2020  None:..         
-0004ff50: 2020 2072 6574 7572 6e20 696e 7075 745f     return input_
-0004ff60: 7370 6563 2e65 7870 616e 6428 7365 6c66  spec.expand(self
-0004ff70: 2e62 6174 6368 5f73 697a 6529 0d0a 2020  .batch_size)..  
-0004ff80: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-0004ff90: 662e 7265 7368 6170 655f 666e 2869 6e70  f.reshape_fn(inp
-0004ffa0: 7574 5f73 7065 6329 0d0a 0d0a 0d0a 636c  ut_spec)......cl
-0004ffb0: 6173 7320 4175 746f 5265 7365 7445 6e76  ass AutoResetEnv
-0004ffc0: 2854 7261 6e73 666f 726d 6564 456e 7629  (TransformedEnv)
-0004ffd0: 3a0d 0a20 2020 2022 2222 4120 7375 6263  :..    """A subc
-0004ffe0: 6c61 7373 2066 6f72 2061 7574 6f2d 7265  lass for auto-re
-0004fff0: 7365 7474 696e 6720 656e 7673 2e22 2222  setting envs."""
-00050000: 0d0a 0d0a 2020 2020 6465 6620 5f72 6573  ....    def _res
-00050010: 6574 2873 656c 662c 2074 656e 736f 7264  et(self, tensord
-00050020: 6963 743a 204f 7074 696f 6e61 6c5b 5465  ict: Optional[Te
-00050030: 6e73 6f72 4469 6374 4261 7365 5d20 3d20  nsorDictBase] = 
-00050040: 4e6f 6e65 2c20 2a2a 6b77 6172 6773 293a  None, **kwargs):
-00050050: 0d0a 2020 2020 2020 2020 6966 2074 656e  ..        if ten
-00050060: 736f 7264 6963 7420 6973 206e 6f74 204e  sordict is not N
-00050070: 6f6e 653a 0d0a 2020 2020 2020 2020 2020  one:..          
-00050080: 2020 2320 5765 206d 7573 7420 6176 6f69    # We must avoi
-00050090: 6420 6d6f 6469 6679 696e 6720 7468 6520  d modifying the 
-000500a0: 6f72 6967 696e 616c 2074 656e 736f 7264  original tensord
-000500b0: 6963 7420 736f 2061 2073 6861 6c6c 6f77  ict so a shallow
-000500c0: 2063 6f70 7920 6973 206e 6563 6573 7361   copy is necessa
-000500d0: 7279 2e0d 0a20 2020 2020 2020 2020 2020  ry...           
-000500e0: 2023 2057 6520 6a75 7374 2073 656c 6563   # We just selec
-000500f0: 7420 7468 6520 696e 7075 7420 6461 7461  t the input data
-00050100: 2061 6e64 2072 6573 6574 2073 6967 6e61   and reset signa
-00050110: 6c2c 2077 6869 6368 2069 7320 616c 6c20  l, which is all 
-00050120: 7765 206e 6565 642e 0d0a 2020 2020 2020  we need...      
-00050130: 2020 2020 2020 7465 6e73 6f72 6469 6374        tensordict
-00050140: 203d 2074 656e 736f 7264 6963 742e 7365   = tensordict.se
-00050150: 6c65 6374 280d 0a20 2020 2020 2020 2020  lect(..         
-00050160: 2020 2020 2020 202a 7365 6c66 2e72 6573         *self.res
-00050170: 6574 5f6b 6579 732c 202a 7365 6c66 2e73  et_keys, *self.s
-00050180: 7461 7465 5f73 7065 632e 6b65 7973 2854  tate_spec.keys(T
-00050190: 7275 652c 2054 7275 6529 2c20 7374 7269  rue, True), stri
-000501a0: 6374 3d46 616c 7365 0d0a 2020 2020 2020  ct=False..      
-000501b0: 2020 2020 2020 290d 0a20 2020 2020 2020        )..       
-000501c0: 2066 6f72 2072 6573 6574 5f6b 6579 2069   for reset_key i
-000501d0: 6e20 7365 6c66 2e62 6173 655f 656e 762e  n self.base_env.
-000501e0: 7265 7365 745f 6b65 7973 3a0d 0a20 2020  reset_keys:..   
-000501f0: 2020 2020 2020 2020 2069 6620 7465 6e73           if tens
-00050200: 6f72 6469 6374 2069 7320 6e6f 7420 4e6f  ordict is not No
-00050210: 6e65 2061 6e64 2072 6573 6574 5f6b 6579  ne and reset_key
-00050220: 2069 6e20 7465 6e73 6f72 6469 6374 2e6b   in tensordict.k
-00050230: 6579 7328 5472 7565 293a 0d0a 2020 2020  eys(True):..    
-00050240: 2020 2020 2020 2020 2020 2020 7465 6e73              tens
-00050250: 6f72 6469 6374 5f72 6573 6574 203d 2074  ordict_reset = t
-00050260: 656e 736f 7264 6963 742e 6578 636c 7564  ensordict.exclud
-00050270: 6528 2a73 656c 662e 6261 7365 5f65 6e76  e(*self.base_env
-00050280: 2e72 6573 6574 5f6b 6579 7329 0d0a 2020  .reset_keys)..  
-00050290: 2020 2020 2020 2020 2020 656c 7365 3a0d            else:.
-000502a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000502b0: 2074 656e 736f 7264 6963 745f 7265 7365   tensordict_rese
-000502c0: 7420 3d20 7365 6c66 2e62 6173 655f 656e  t = self.base_en
-000502d0: 762e 5f72 6573 6574 2874 656e 736f 7264  v._reset(tensord
-000502e0: 6963 742c 202a 2a6b 7761 7267 7329 0d0a  ict, **kwargs)..
-000502f0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-00050300: 6b0d 0a20 2020 2020 2020 2069 6620 7465  k..        if te
-00050310: 6e73 6f72 6469 6374 2069 7320 4e6f 6e65  nsordict is None
-00050320: 3a0d 0a20 2020 2020 2020 2020 2020 2023  :..            #
-00050330: 206d 616b 6520 7375 7265 2061 6c6c 2074   make sure all t
-00050340: 7261 6e73 666f 726d 7320 7365 6520 6120  ransforms see a 
-00050350: 736f 7572 6365 2074 656e 736f 7264 6963  source tensordic
-00050360: 740d 0a20 2020 2020 2020 2020 2020 2074  t..            t
-00050370: 656e 736f 7264 6963 7420 3d20 7465 6e73  ensordict = tens
-00050380: 6f72 6469 6374 5f72 6573 6574 2e65 6d70  ordict_reset.emp
-00050390: 7479 2829 0d0a 2020 2020 2020 2020 7365  ty()..        se
-000503a0: 6c66 2e62 6173 655f 656e 762e 5f63 6f6d  lf.base_env._com
-000503b0: 706c 6574 655f 646f 6e65 2873 656c 662e  plete_done(self.
-000503c0: 6261 7365 5f65 6e76 2e66 756c 6c5f 646f  base_env.full_do
-000503d0: 6e65 5f73 7065 632c 2074 656e 736f 7264  ne_spec, tensord
-000503e0: 6963 745f 7265 7365 7429 0d0a 2020 2020  ict_reset)..    
-000503f0: 2020 2020 7465 6e73 6f72 6469 6374 5f72      tensordict_r
-00050400: 6573 6574 203d 2073 656c 662e 7472 616e  eset = self.tran
-00050410: 7366 6f72 6d2e 5f72 6573 6574 2874 656e  sform._reset(ten
-00050420: 736f 7264 6963 742c 2074 656e 736f 7264  sordict, tensord
-00050430: 6963 745f 7265 7365 7429 0d0a 2020 2020  ict_reset)..    
-00050440: 2020 2020 7265 7475 726e 2074 656e 736f      return tenso
-00050450: 7264 6963 745f 7265 7365 740d 0a0d 0a20  rdict_reset.... 
-00050460: 2020 2064 6566 2069 6e73 6572 745f 7472     def insert_tr
-00050470: 616e 7366 6f72 6d28 7365 6c66 2c20 696e  ansform(self, in
-00050480: 6465 783a 2069 6e74 2c20 7472 616e 7366  dex: int, transf
-00050490: 6f72 6d3a 2054 7261 6e73 666f 726d 2920  orm: Transform) 
-000504a0: 2d3e 204e 6f6e 653a 0d0a 2020 2020 2020  -> None:..      
-000504b0: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
-000504c0: 7272 6f72 2866 2243 616e 6e6f 7420 696e  rror(f"Cannot in
-000504d0: 7365 7274 2061 2074 7261 6e73 666f 726d  sert a transform
-000504e0: 2069 6e20 7b73 656c 662e 5f5f 636c 6173   in {self.__clas
-000504f0: 735f 2e5f 5f6e 616d 655f 5f7d 2e22 290d  s_.__name__}.").
-00050500: 0a0d 0a0d 0a63 6c61 7373 2041 7574 6f52  .....class AutoR
-00050510: 6573 6574 5472 616e 7366 6f72 6d28 5472  esetTransform(Tr
-00050520: 616e 7366 6f72 6d29 3a0d 0a20 2020 2022  ansform):..    "
-00050530: 2222 4120 7472 616e 7366 6f72 6d20 666f  ""A transform fo
-00050540: 7220 6175 746f 2d72 6573 6574 7469 6e67  r auto-resetting
-00050550: 2065 6e76 6972 6f6e 6d65 6e74 732e 0d0a   environments...
-00050560: 0d0a 2020 2020 5468 6973 2074 7261 6e73  ..    This trans
-00050570: 666f 726d 2063 616e 2062 6520 6170 7065  form can be appe
-00050580: 6e64 6564 2074 6f20 616e 7920 6175 746f  nded to any auto
-00050590: 2d72 6573 6574 7469 6e67 2065 6e76 6972  -resetting envir
-000505a0: 6f6e 6d65 6e74 2c20 6f72 2061 7574 6f6d  onment, or autom
-000505b0: 6174 6963 616c 6c79 0d0a 2020 2020 6170  atically..    ap
-000505c0: 7065 6e64 6564 2075 7369 6e67 2060 6065  pended using ``e
-000505d0: 6e76 203d 2053 6f6d 6545 6e76 436c 6173  nv = SomeEnvClas
-000505e0: 7328 2e2e 2e2c 2061 7574 6f5f 7265 7365  s(..., auto_rese
-000505f0: 743d 5472 7565 2960 602e 2049 6620 7468  t=True)``. If th
-00050600: 6520 7472 616e 7366 6f72 6d20 6973 2065  e transform is e
-00050610: 7870 6c69 6369 746c 790d 0a20 2020 2061  xplicitly..    a
-00050620: 7070 656e 6465 6420 746f 2061 6e20 656e  ppended to an en
-00050630: 762c 2061 203a 636c 6173 733a 607e 746f  v, a :class:`~to
-00050640: 7263 6872 6c2e 656e 7673 2e74 7261 6e73  rchrl.envs.trans
-00050650: 666f 726d 732e 4175 746f 5265 7365 7445  forms.AutoResetE
-00050660: 6e76 6020 6d75 7374 2062 6520 7573 6564  nv` must be used
-00050670: 2e0d 0a0d 0a20 2020 2041 6e20 6175 746f  .....    An auto
-00050680: 2d72 6573 6574 2065 6e76 6972 6f6e 6d65  -reset environme
-00050690: 6e74 206d 7573 7420 6861 7665 2074 6865  nt must have the
-000506a0: 2066 6f6c 6c6f 7769 6e67 2070 726f 7065   following prope
-000506b0: 7274 6965 7320 2864 6966 6665 7265 6e63  rties (differenc
-000506c0: 6573 2066 726f 6d20 7468 6973 0d0a 2020  es from this..  
-000506d0: 2020 6465 7363 7269 7074 696f 6e20 7368    description sh
-000506e0: 6f75 6c64 2062 6520 6163 636f 756e 7465  ould be accounte
-000506f0: 6420 666f 7220 6279 2073 7562 636c 6173  d for by subclas
-00050700: 7369 6e67 2074 6869 7320 636c 6173 7329  sing this class)
-00050710: 3a0d 0a0d 0a20 2020 2020 202d 2074 6865  :....      - the
-00050720: 2072 6573 6574 2066 756e 6374 696f 6e20   reset function 
-00050730: 6361 6e20 6265 2063 616c 6c65 6420 6f6e  can be called on
-00050740: 6365 2061 7420 7468 6520 6265 6769 6e6e  ce at the beginn
-00050750: 696e 6720 2861 6674 6572 2069 6e73 7461  ing (after insta
-00050760: 6e74 6961 7469 6f6e 2920 7769 7468 0d0a  ntiation) with..
-00050770: 2020 2020 2020 2020 6f72 2077 6974 686f          or witho
-00050780: 7574 2065 6666 6563 742e 2057 6865 7468  ut effect. Wheth
-00050790: 6572 2063 616c 6c73 2074 6f20 6072 6573  er calls to `res
-000507a0: 6574 6020 6172 6520 616c 6c6f 7765 6420  et` are allowed 
-000507b0: 6166 7465 7220 7468 6174 2069 7320 7570  after that is up
-000507c0: 2074 6f20 7468 650d 0a20 2020 2020 2020   to the..       
-000507d0: 2065 6e76 6972 6f6e 6d65 6e74 2069 7473   environment its
-000507e0: 656c 662e 0d0a 2020 2020 2020 2d20 4475  elf...      - Du
-000507f0: 7269 6e67 2061 2072 6f6c 6c6f 7574 2c20  ring a rollout, 
-00050800: 616e 7920 6060 646f 6e65 6060 2073 7461  any ``done`` sta
-00050810: 7465 2077 696c 6c20 7265 7375 6c74 2069  te will result i
-00050820: 6e20 6120 7265 7365 7420 616e 6420 7072  n a reset and pr
-00050830: 6f64 7563 6520 616e 206f 6273 6572 7661  oduce an observa
-00050840: 7469 6f6e 0d0a 2020 2020 2020 2020 7468  tion..        th
-00050850: 6174 2069 736e 2774 2074 6865 206c 6173  at isn't the las
-00050860: 7420 6f62 7365 7276 6174 696f 6e20 6f66  t observation of
-00050870: 2074 6865 2063 7572 7265 6e74 2065 7069   the current epi
-00050880: 736f 6465 2c20 6275 7420 7468 6520 6669  sode, but the fi
-00050890: 7273 7420 6f62 7365 7276 6174 696f 6e0d  rst observation.
-000508a0: 0a20 2020 2020 2020 206f 6620 7468 6520  .        of the 
-000508b0: 6e65 7874 2065 7069 736f 6465 2028 7468  next episode (th
-000508c0: 6973 2074 7261 6e73 666f 726d 2077 696c  is transform wil
-000508d0: 6c20 6578 7472 6163 7420 616e 6420 6361  l extract and ca
-000508e0: 6368 6520 7468 6973 206f 6273 6572 7661  che this observa
-000508f0: 7469 6f6e 0d0a 2020 2020 2020 2020 616e  tion..        an
-00050900: 6420 6669 6c6c 2074 6865 206f 6273 2077  d fill the obs w
-00050910: 6974 6820 736f 6d65 2061 7262 6974 7261  ith some arbitra
-00050920: 7279 2076 616c 7565 292e 0d0a 0d0a 2020  ry value).....  
-00050930: 2020 4b65 7977 6f72 6420 4172 6773 3a0d    Keyword Args:.
-00050940: 0a20 2020 2020 2020 2072 6570 6c61 6365  .        replace
-00050950: 2028 626f 6f6c 2c20 6f70 7469 6f6e 616c   (bool, optional
-00050960: 293a 2069 6620 6060 4661 6c73 6560 602c  ): if ``False``,
-00050970: 2076 616c 7565 7320 6172 6520 6a75 7374   values are just
-00050980: 2070 6c61 6365 6420 6173 2074 6865 7920   placed as they 
-00050990: 6172 6520 696e 2074 6865 0d0a 2020 2020  are in the..    
-000509a0: 2020 2020 2020 2020 6060 226e 6578 7422          ``"next"
-000509b0: 6060 2065 6e74 7279 2065 7665 6e20 6966  `` entry even if
-000509c0: 2074 6865 7920 6172 6520 6e6f 7420 7661   they are not va
-000509d0: 6c69 642e 2044 6566 6175 6c74 7320 746f  lid. Defaults to
-000509e0: 2060 6054 7275 6560 602e 2041 2076 616c   ``True``. A val
-000509f0: 7565 206f 660d 0a20 2020 2020 2020 2020  ue of..         
-00050a00: 2020 2060 6046 616c 7365 6060 206f 7665     ``False`` ove
-00050a10: 7272 6964 6573 2061 6e79 2073 7562 7365  rrides any subse
-00050a20: 7175 656e 7420 6669 6c6c 696e 6720 6b65  quent filling ke
-00050a30: 7977 6f72 6420 6172 6775 6d65 6e74 2e0d  yword argument..
-00050a40: 0a20 2020 2020 2020 2020 2020 2054 6869  .            Thi
-00050a50: 7320 6172 6775 6d65 7420 6361 6e20 616c  s argumet can al
-00050a60: 736f 2062 6520 7061 7373 6564 2077 6974  so be passed wit
-00050a70: 6820 7468 6520 636f 6e73 7472 7563 746f  h the constructo
-00050a80: 7220 6d65 7468 6f64 2062 7920 7061 7373  r method by pass
-00050a90: 696e 6720 610d 0a20 2020 2020 2020 2020  ing a..         
-00050aa0: 2020 2060 6061 7574 6f5f 7265 7365 745f     ``auto_reset_
-00050ab0: 7265 706c 6163 6560 6020 6172 6775 6d65  replace`` argume
-00050ac0: 6e74 3a20 6060 656e 7620 3d20 466f 6f45  nt: ``env = FooE
-00050ad0: 6e76 282e 2e2e 2c20 6175 746f 5f72 6573  nv(..., auto_res
-00050ae0: 6574 3d54 7275 652c 2061 7574 6f5f 7265  et=True, auto_re
-00050af0: 7365 745f 7265 706c 6163 653d 4661 6c73  set_replace=Fals
-00050b00: 6529 6060 2e0d 0a20 2020 2020 2020 2066  e)``...        f
-00050b10: 696c 6c5f 666c 6f61 7420 2866 6c6f 6174  ill_float (float
-00050b20: 206f 7220 7374 722c 206f 7074 696f 6e61   or str, optiona
-00050b30: 6c29 3a20 5468 6520 6669 6c6c 696e 6720  l): The filling 
-00050b40: 7661 6c75 6520 666f 7220 666c 6f61 7469  value for floati
-00050b50: 6e67 2070 6f69 6e74 2074 656e 736f 7273  ng point tensors
-00050b60: 0d0a 2020 2020 2020 2020 2020 2020 7468  ..            th
-00050b70: 6174 2074 6572 6d69 6e61 7465 2061 6e20  at terminate an 
-00050b80: 6570 6973 6f64 652e 2041 2076 616c 7565  episode. A value
-00050b90: 206f 6620 6060 4e6f 6e65 6060 206d 6561   of ``None`` mea
-00050ba0: 6e73 206e 6f20 7265 706c 6163 656d 656e  ns no replacemen
-00050bb0: 7420 2876 616c 7565 7320 6172 6520 6a75  t (values are ju
-00050bc0: 7374 0d0a 2020 2020 2020 2020 2020 2020  st..            
-00050bd0: 706c 6163 6564 2061 7320 7468 6579 2061  placed as they a
-00050be0: 7265 2069 6e20 7468 6520 6060 226e 6578  re in the ``"nex
-00050bf0: 7422 6060 2065 6e74 7279 2065 7665 6e20  t"`` entry even 
-00050c00: 6966 2074 6865 7920 6172 6520 6e6f 7420  if they are not 
-00050c10: 7661 6c69 6429 2e0d 0a20 2020 2020 2020  valid)...       
-00050c20: 2066 696c 6c5f 696e 7420 2869 6e74 2c20   fill_int (int, 
-00050c30: 6f70 7469 6f6e 616c 293a 2054 6865 2066  optional): The f
-00050c40: 696c 6c69 6e67 2076 616c 7565 2066 6f72  illing value for
-00050c50: 2073 6967 6e65 6420 696e 7465 6765 7220   signed integer 
-00050c60: 7465 6e73 6f72 730d 0a20 2020 2020 2020  tensors..       
-00050c70: 2020 2020 2074 6861 7420 7465 726d 696e       that termin
-00050c80: 6174 6520 616e 2065 7069 736f 6465 2e20  ate an episode. 
-00050c90: 2041 2076 616c 7565 206f 6620 6060 4e6f   A value of ``No
-00050ca0: 6e65 6060 206d 6561 6e73 206e 6f20 7265  ne`` means no re
-00050cb0: 706c 6163 656d 656e 7420 2876 616c 7565  placement (value
-00050cc0: 7320 6172 6520 6a75 7374 0d0a 2020 2020  s are just..    
-00050cd0: 2020 2020 2020 2020 706c 6163 6564 2061          placed a
-00050ce0: 7320 7468 6579 2061 7265 2069 6e20 7468  s they are in th
-00050cf0: 6520 6060 226e 6578 7422 6060 2065 6e74  e ``"next"`` ent
-00050d00: 7279 2065 7665 6e20 6966 2074 6865 7920  ry even if they 
-00050d10: 6172 6520 6e6f 7420 7661 6c69 6429 2e0d  are not valid)..
-00050d20: 0a20 2020 2020 2020 2066 696c 6c5f 626f  .        fill_bo
-00050d30: 6f6c 2028 626f 6f6c 2c20 6f70 7469 6f6e  ol (bool, option
-00050d40: 616c 293a 2054 6865 2066 696c 6c69 6e67  al): The filling
-00050d50: 2076 616c 7565 2066 6f72 2062 6f6f 6c65   value for boole
-00050d60: 616e 2074 656e 736f 7273 0d0a 2020 2020  an tensors..    
-00050d70: 2020 2020 2020 2020 7468 6174 2074 6572          that ter
-00050d80: 6d69 6e61 7465 2061 6e20 6570 6973 6f64  minate an episod
-00050d90: 652e 2020 4120 7661 6c75 6520 6f66 2060  e.  A value of `
-00050da0: 604e 6f6e 6560 6020 6d65 616e 7320 6e6f  `None`` means no
-00050db0: 2072 6570 6c61 6365 6d65 6e74 2028 7661   replacement (va
-00050dc0: 6c75 6573 2061 7265 206a 7573 740d 0a20  lues are just.. 
-00050dd0: 2020 2020 2020 2020 2020 2070 6c61 6365             place
-00050de0: 6420 6173 2074 6865 7920 6172 6520 696e  d as they are in
-00050df0: 2074 6865 2060 6022 6e65 7874 2260 6020   the ``"next"`` 
-00050e00: 656e 7472 7920 6576 656e 2069 6620 7468  entry even if th
-00050e10: 6579 2061 7265 206e 6f74 2076 616c 6964  ey are not valid
-00050e20: 292e 0d0a 0d0a 2020 2020 4172 6775 6d65  ).....    Argume
-00050e30: 6e74 7320 6172 6520 6f6e 6c79 2061 7661  nts are only ava
-00050e40: 696c 6162 6c65 2077 6865 6e20 7468 6520  ilable when the 
-00050e50: 7472 616e 7366 6f72 6d20 6973 2065 7870  transform is exp
-00050e60: 6c69 6369 746c 7920 696e 7374 616e 7469  licitly instanti
-00050e70: 6174 6564 2028 6e6f 7420 7468 726f 7567  ated (not throug
-00050e80: 6820 6045 6e76 5479 7065 282e 2e2e 2c20  h `EnvType(..., 
-00050e90: 6175 746f 5f72 6573 6574 3d54 7275 6529  auto_reset=True)
-00050ea0: 6029 2e0d 0a0d 0a20 2020 2045 7861 6d70  `).....    Examp
-00050eb0: 6c65 733a 0d0a 2020 2020 2020 2020 3e3e  les:..        >>
-00050ec0: 3e20 6672 6f6d 2074 6f72 6368 726c 2e65  > from torchrl.e
-00050ed0: 6e76 7320 696d 706f 7274 2047 796d 456e  nvs import GymEn
-00050ee0: 760d 0a20 2020 2020 2020 203e 3e3e 2066  v..        >>> f
-00050ef0: 726f 6d20 746f 7263 6872 6c2e 656e 7673  rom torchrl.envs
-00050f00: 2069 6d70 6f72 7420 7365 745f 6779 6d5f   import set_gym_
-00050f10: 6261 636b 656e 640d 0a20 2020 2020 2020  backend..       
-00050f20: 203e 3e3e 2069 6d70 6f72 7420 746f 7263   >>> import torc
-00050f30: 680d 0a20 2020 2020 2020 203e 3e3e 2074  h..        >>> t
-00050f40: 6f72 6368 2e6d 616e 7561 6c5f 7365 6564  orch.manual_seed
-00050f50: 2830 290d 0a20 2020 2020 2020 203e 3e3e  (0)..        >>>
-00050f60: 0d0a 2020 2020 2020 2020 3e3e 3e20 636c  ..        >>> cl
-00050f70: 6173 7320 4175 746f 5265 7365 7474 696e  ass AutoResettin
-00050f80: 6747 796d 456e 7628 4779 6d45 6e76 293a  gGymEnv(GymEnv):
-00050f90: 0d0a 2020 2020 2020 2020 2e2e 2e20 2020  ..        ...   
-00050fa0: 2020 6465 6620 5f73 7465 7028 7365 6c66    def _step(self
-00050fb0: 2c20 7465 6e73 6f72 6469 6374 293a 0d0a  , tensordict):..
-00050fc0: 2020 2020 2020 2020 2e2e 2e20 2020 2020          ...     
-00050fd0: 2020 2020 7465 6e73 6f72 6469 6374 203d      tensordict =
-00050fe0: 2073 7570 6572 2829 2e5f 7374 6570 2874   super()._step(t
-00050ff0: 656e 736f 7264 6963 7429 0d0a 2020 2020  ensordict)..    
-00051000: 2020 2020 2e2e 2e20 2020 2020 2020 2020      ...         
-00051010: 6966 2074 656e 736f 7264 6963 745b 2264  if tensordict["d
-00051020: 6f6e 6522 5d2e 616e 7928 293a 0d0a 2020  one"].any():..  
-00051030: 2020 2020 2020 2e2e 2e20 2020 2020 2020        ...       
-00051040: 2020 2020 2020 7464 5f72 6573 6574 203d        td_reset =
-00051050: 2073 7570 6572 2829 2e72 6573 6574 2829   super().reset()
-00051060: 0d0a 2020 2020 2020 2020 2e2e 2e20 2020  ..        ...   
-00051070: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
-00051080: 6469 6374 2e75 7064 6174 6528 7464 5f72  dict.update(td_r
-00051090: 6573 6574 2e65 7863 6c75 6465 282a 7365  eset.exclude(*se
-000510a0: 6c66 2e64 6f6e 655f 6b65 7973 2929 0d0a  lf.done_keys))..
-000510b0: 2020 2020 2020 2020 2e2e 2e20 2020 2020          ...     
-000510c0: 2020 2020 7265 7475 726e 2074 656e 736f      return tenso
-000510d0: 7264 6963 740d 0a20 2020 2020 2020 202e  rdict..        .
-000510e0: 2e2e 0d0a 2020 2020 2020 2020 2e2e 2e20  ....        ... 
-000510f0: 2020 2020 6465 6620 5f72 6573 6574 2873      def _reset(s
-00051100: 656c 662c 2074 656e 736f 7264 6963 743d  elf, tensordict=
-00051110: 4e6f 6e65 293a 0d0a 2020 2020 2020 2020  None):..        
-00051120: 2e2e 2e20 2020 2020 2020 2020 6966 2074  ...         if t
-00051130: 656e 736f 7264 6963 7420 6973 206e 6f74  ensordict is not
-00051140: 204e 6f6e 6520 616e 6420 225f 7265 7365   None and "_rese
-00051150: 7422 2069 6e20 7465 6e73 6f72 6469 6374  t" in tensordict
-00051160: 3a0d 0a20 2020 2020 2020 202e 2e2e 2020  :..        ...  
-00051170: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00051180: 6e20 7465 6e73 6f72 6469 6374 2e63 6f70  n tensordict.cop
-00051190: 7928 290d 0a20 2020 2020 2020 202e 2e2e  y()..        ...
-000511a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000511b0: 7375 7065 7228 292e 5f72 6573 6574 2874  super()._reset(t
-000511c0: 656e 736f 7264 6963 7429 0d0a 2020 2020  ensordict)..    
-000511d0: 2020 2020 3e3e 3e0d 0a20 2020 2020 2020      >>>..       
-000511e0: 203e 3e3e 2077 6974 6820 7365 745f 6779   >>> with set_gy
-000511f0: 6d5f 6261 636b 656e 6428 2267 796d 2229  m_backend("gym")
-00051200: 3a0d 0a20 2020 2020 2020 202e 2e2e 2020  :..        ...  
-00051210: 2020 2065 6e76 203d 2041 7574 6f52 6573     env = AutoRes
-00051220: 6574 7469 6e67 4779 6d45 6e76 2822 4361  ettingGymEnv("Ca
-00051230: 7274 506f 6c65 2d76 3122 2c20 6175 746f  rtPole-v1", auto
-00051240: 5f72 6573 6574 3d54 7275 652c 2061 7574  _reset=True, aut
-00051250: 6f5f 7265 7365 745f 7265 706c 6163 653d  o_reset_replace=
-00051260: 5472 7565 290d 0a20 2020 2020 2020 202e  True)..        .
-00051270: 2e2e 2020 2020 2065 6e76 2e73 6574 5f73  ..     env.set_s
-00051280: 6565 6428 3029 0d0a 2020 2020 2020 2020  eed(0)..        
-00051290: 2e2e 2e20 2020 2020 7220 3d20 656e 762e  ...     r = env.
-000512a0: 726f 6c6c 6f75 7428 3330 2c20 6272 6561  rollout(30, brea
-000512b0: 6b5f 7768 656e 5f61 6e79 5f64 6f6e 653d  k_when_any_done=
-000512c0: 4661 6c73 6529 0d0a 2020 2020 2020 2020  False)..        
-000512d0: 3e3e 3e20 7072 696e 7428 725b 226e 6578  >>> print(r["nex
-000512e0: 7422 2c20 2264 6f6e 6522 5d2e 7371 7565  t", "done"].sque
-000512f0: 657a 6528 2929 0d0a 2020 2020 2020 2020  eze())..        
-00051300: 7465 6e73 6f72 285b 4661 6c73 652c 2046  tensor([False, F
-00051310: 616c 7365 2c20 4661 6c73 652c 2046 616c  alse, False, Fal
-00051320: 7365 2c20 4661 6c73 652c 2046 616c 7365  se, False, False
-00051330: 2c20 4661 6c73 652c 2046 616c 7365 2c20  , False, False, 
-00051340: 4661 6c73 652c 2046 616c 7365 2c0d 0a20  False, False,.. 
-00051350: 2020 2020 2020 2020 2020 2020 2020 2046                 F
-00051360: 616c 7365 2c20 4661 6c73 652c 2046 616c  alse, False, Fal
-00051370: 7365 2c20 2054 7275 652c 2046 616c 7365  se,  True, False
-00051380: 2c20 4661 6c73 652c 2046 616c 7365 2c20  , False, False, 
-00051390: 4661 6c73 652c 2046 616c 7365 2c20 4661  False, False, Fa
-000513a0: 6c73 652c 0d0a 2020 2020 2020 2020 2020  lse,..          
-000513b0: 2020 2020 2020 4661 6c73 652c 2046 616c        False, Fal
-000513c0: 7365 2c20 4661 6c73 652c 2046 616c 7365  se, False, False
-000513d0: 2c20 4661 6c73 652c 2020 5472 7565 2c20  , False,  True, 
-000513e0: 4661 6c73 652c 2046 616c 7365 2c20 4661  False, False, Fa
-000513f0: 6c73 652c 2046 616c 7365 5d29 0d0a 2020  lse, False])..  
-00051400: 2020 2020 2020 3e3e 3e20 7072 696e 7428        >>> print(
-00051410: 226f 6273 6572 7661 7469 6f6e 2061 6674  "observation aft
-00051420: 6572 2072 6573 6574 2061 7265 2073 6574  er reset are set
-00051430: 2061 7320 6e61 6e22 2c20 725b 226e 6578   as nan", r["nex
-00051440: 7422 2c20 226f 6273 6572 7661 7469 6f6e  t", "observation
-00051450: 225d 290d 0a20 2020 2020 2020 206f 6273  "])..        obs
-00051460: 6572 7661 7469 6f6e 2061 6674 6572 2072  ervation after r
-00051470: 6573 6574 2061 7265 2073 6574 2061 7320  eset are set as 
-00051480: 6e61 6e20 7465 6e73 6f72 285b 5b2d 342e  nan tensor([[-4.
-00051490: 3336 3333 652d 3032 2c20 2d31 2e34 3837  3633e-02, -1.487
-000514a0: 3765 2d30 312c 2020 312e 3238 3439 652d  7e-01,  1.2849e-
-000514b0: 3032 2c20 2032 2e37 3538 3465 2d30 315d  02,  2.7584e-01]
-000514c0: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
-000514d0: 2020 205b 2d34 2e36 3630 3965 2d30 322c     [-4.6609e-02,
-000514e0: 2020 342e 3631 3636 652d 3032 2c20 2031    4.6166e-02,  1
-000514f0: 2e38 3336 3665 2d30 322c 202d 312e 3237  .8366e-02, -1.27
-00051500: 3631 652d 3032 5d2c 0d0a 2020 2020 2020  61e-02],..      
-00051510: 2020 2020 2020 2020 2020 5b2d 342e 3536            [-4.56
-00051520: 3835 652d 3032 2c20 2032 2e34 3130 3265  85e-02,  2.4102e
-00051530: 2d30 312c 2020 312e 3831 3131 652d 3032  -01,  1.8111e-02
-00051540: 2c20 2d32 2e39 3935 3965 2d30 315d 2c0d  , -2.9959e-01],.
-00051550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00051560: 205b 2d34 2e30 3836 3565 2d30 322c 2020   [-4.0865e-02,  
-00051570: 342e 3536 3434 652d 3032 2c20 2031 2e32  4.5644e-02,  1.2
-00051580: 3131 3965 2d30 322c 202d 312e 3235 3432  119e-02, -1.2542
-00051590: 652d 3033 5d2c 0d0a 2020 2020 2020 2020  e-03],..        
-000515a0: 2020 2020 2020 2020 5b2d 332e 3939 3532          [-3.9952
-000515b0: 652d 3032 2c20 2032 2e34 3035 3965 2d30  e-02,  2.4059e-0
-000515c0: 312c 2020 312e 3230 3934 652d 3032 2c20  1,  1.2094e-02, 
-000515d0: 2d32 2e39 3030 3965 2d30 315d 2c0d 0a20  -2.9009e-01],.. 
-000515e0: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-000515f0: 2d33 2e35 3134 3065 2d30 322c 2020 342e  -3.5140e-02,  4.
-00051600: 3335 3534 652d 3031 2c20 2036 2e32 3932  3554e-01,  6.292
-00051610: 3065 2d30 332c 202d 352e 3738 3933 652d  0e-03, -5.7893e-
-00051620: 3031 5d2c 0d0a 2020 2020 2020 2020 2020  01],..          
-00051630: 2020 2020 2020 5b2d 322e 3634 3239 652d        [-2.6429e-
-00051640: 3032 2c20 2036 2e33 3035 3765 2d30 312c  02,  6.3057e-01,
-00051650: 202d 352e 3238 3637 652d 3033 2c20 2d38   -5.2867e-03, -8
-00051660: 2e36 3936 3365 2d30 315d 2c0d 0a20 2020  .6963e-01],..   
-00051670: 2020 2020 2020 2020 2020 2020 205b 2d31               [-1
-00051680: 2e33 3831 3865 2d30 322c 2020 382e 3235  .3818e-02,  8.25
-00051690: 3736 652d 3031 2c20 2d32 2e32 3637 3965  76e-01, -2.2679e
-000516a0: 2d30 322c 202d 312e 3136 3430 652b 3030  -02, -1.1640e+00
-000516b0: 5d2c 0d0a 2020 2020 2020 2020 2020 2020  ],..            
-000516c0: 2020 2020 5b20 322e 3639 3732 652d 3033      [ 2.6972e-03
-000516d0: 2c20 2031 2e30 3231 3265 2b30 302c 202d  ,  1.0212e+00, -
-000516e0: 342e 3539 3539 652d 3032 2c20 2d31 2e34  4.5959e-02, -1.4
-000516f0: 3633 3765 2b30 305d 2c0d 0a20 2020 2020  637e+00],..     
-00051700: 2020 2020 2020 2020 2020 205b 2032 2e33             [ 2.3
-00051710: 3132 3165 2d30 322c 2020 312e 3231 3638  121e-02,  1.2168
-00051720: 652b 3030 2c20 2d37 2e35 3233 3265 2d30  e+00, -7.5232e-0
-00051730: 322c 202d 312e 3737 3034 652b 3030 5d2c  2, -1.7704e+00],
-00051740: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00051750: 2020 5b20 342e 3734 3537 652d 3032 2c20    [ 4.7457e-02, 
-00051760: 2031 2e34 3132 3765 2b30 302c 202d 312e   1.4127e+00, -1.
-00051770: 3130 3634 652d 3031 2c20 2d32 2e30 3835  1064e-01, -2.085
-00051780: 3465 2b30 305d 2c0d 0a20 2020 2020 2020  4e+00],..       
-00051790: 2020 2020 2020 2020 205b 2037 2e35 3731           [ 7.571
-000517a0: 3265 2d30 322c 2020 312e 3231 3839 652b  2e-02,  1.2189e+
-000517b0: 3030 2c20 2d31 2e35 3233 3565 2d30 312c  00, -1.5235e-01,
-000517c0: 202d 312e 3832 3839 652b 3030 5d2c 0d0a   -1.8289e+00],..
-000517d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000517e0: 5b20 312e 3030 3039 652d 3031 2c20 2031  [ 1.0009e-01,  1
-000517f0: 2e30 3235 3765 2b30 302c 202d 312e 3838  .0257e+00, -1.88
-00051800: 3933 652d 3031 2c20 2d31 2e35 3837 3265  93e-01, -1.5872e
-00051810: 2b30 305d 2c0d 0a20 2020 2020 2020 2020  +00],..         
-00051820: 2020 2020 2020 205b 2020 2020 2020 2020         [        
-00051830: 6e61 6e2c 2020 2020 2020 2020 206e 616e  nan,         nan
-00051840: 2c20 2020 2020 2020 2020 6e61 6e2c 2020  ,         nan,  
-00051850: 2020 2020 2020 206e 616e 5d2c 0d0a 2020         nan],..  
-00051860: 2020 2020 2020 2020 2020 2020 2020 5b2d                [-
-00051870: 332e 3934 3035 652d 3032 2c20 2d31 2e37  3.9405e-02, -1.7
-00051880: 3736 3665 2d30 312c 202d 312e 3034 3033  766e-01, -1.0403
-00051890: 652d 3032 2c20 2033 2e30 3632 3665 2d30  e-02,  3.0626e-0
-000518a0: 315d 2c0d 0a20 2020 2020 2020 2020 2020  1],..           
-000518b0: 2020 2020 205b 2d34 2e32 3935 3965 2d30       [-4.2959e-0
-000518c0: 322c 202d 332e 3732 3633 652d 3031 2c20  2, -3.7263e-01, 
-000518d0: 2d34 2e32 3737 3565 2d30 332c 2020 352e  -4.2775e-03,  5.
-000518e0: 3935 3634 652d 3031 5d2c 0d0a 2020 2020  9564e-01],..    
-000518f0: 2020 2020 2020 2020 2020 2020 5b2d 352e              [-5.
-00051900: 3034 3131 652d 3032 2c20 2d35 2e36 3736  0411e-02, -5.676
-00051910: 3965 2d30 312c 2020 372e 3633 3534 652d  9e-01,  7.6354e-
-00051920: 3033 2c20 2038 2e38 3639 3865 2d30 315d  03,  8.8698e-01]
-00051930: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
-00051940: 2020 205b 2d36 2e31 3736 3565 2d30 322c     [-6.1765e-02,
-00051950: 202d 372e 3632 3932 652d 3031 2c20 2032   -7.6292e-01,  2
-00051960: 2e35 3337 3565 2d30 322c 2020 312e 3138  .5375e-02,  1.18
-00051970: 3230 652b 3030 5d2c 0d0a 2020 2020 2020  20e+00],..      
-00051980: 2020 2020 2020 2020 2020 5b2d 372e 3730            [-7.70
-00051990: 3233 652d 3032 2c20 2d39 2e35 3833 3665  23e-02, -9.5836e
-000519a0: 2d30 312c 2020 342e 3930 3136 652d 3032  -01,  4.9016e-02
-000519b0: 2c20 2031 2e34 3832 3665 2b30 305d 2c0d  ,  1.4826e+00],.
-000519c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000519d0: 205b 2d39 2e36 3139 3165 2d30 322c 202d   [-9.6191e-02, -
-000519e0: 372e 3633 3837 652d 3031 2c20 2037 2e38  7.6387e-01,  7.8
-000519f0: 3636 3765 2d30 322c 2020 312e 3230 3536  667e-02,  1.2056
-00051a00: 652b 3030 5d2c 0d0a 2020 2020 2020 2020  e+00],..        
-00051a10: 2020 2020 2020 2020 5b2d 312e 3131 3437          [-1.1147
-00051a20: 652d 3031 2c20 2d39 2e35 3939 3165 2d30  e-01, -9.5991e-0
-00051a30: 312c 2020 312e 3032 3738 652d 3031 2c20  1,  1.0278e-01, 
-00051a40: 2031 2e35 3231 3965 2b30 305d 2c0d 0a20   1.5219e+00],.. 
-00051a50: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-00051a60: 2d31 2e33 3036 3765 2d30 312c 202d 372e  -1.3067e-01, -7.
-00051a70: 3636 3137 652d 3031 2c20 2031 2e33 3332  6617e-01,  1.332
-00051a80: 3265 2d30 312c 2020 312e 3236 3239 652b  2e-01,  1.2629e+
-00051a90: 3030 5d2c 0d0a 2020 2020 2020 2020 2020  00],..          
-00051aa0: 2020 2020 2020 5b2d 312e 3435 3939 652d        [-1.4599e-
-00051ab0: 3031 2c20 2d35 2e37 3239 3865 2d30 312c  01, -5.7298e-01,
-00051ac0: 2020 312e 3538 3438 652d 3031 2c20 2031    1.5848e-01,  1
-00051ad0: 2e30 3134 3865 2b30 305d 2c0d 0a20 2020  .0148e+00],..   
-00051ae0: 2020 2020 2020 2020 2020 2020 205b 2d31               [-1
-00051af0: 2e35 3734 3565 2d30 312c 202d 372e 3639  .5745e-01, -7.69
-00051b00: 3832 652d 3031 2c20 2031 2e37 3837 3765  82e-01,  1.7877e
-00051b10: 2d30 312c 2020 312e 3335 3237 652b 3030  -01,  1.3527e+00
-00051b20: 5d2c 0d0a 2020 2020 2020 2020 2020 2020  ],..            
-00051b30: 2020 2020 5b2d 312e 3732 3835 652d 3031      [-1.7285e-01
-00051b40: 2c20 2d39 2e36 3636 3865 2d30 312c 2020  , -9.6668e-01,  
-00051b50: 322e 3035 3833 652d 3031 2c20 2031 2e36  2.0583e-01,  1.6
-00051b60: 3935 3665 2b30 305d 2c0d 0a20 2020 2020  956e+00],..     
-00051b70: 2020 2020 2020 2020 2020 205b 2020 2020             [    
-00051b80: 2020 2020 6e61 6e2c 2020 2020 2020 2020      nan,        
-00051b90: 206e 616e 2c20 2020 2020 2020 2020 6e61   nan,         na
-00051ba0: 6e2c 2020 2020 2020 2020 206e 616e 5d2c  n,         nan],
-00051bb0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00051bc0: 2020 5b2d 342e 3339 3632 652d 3032 2c20    [-4.3962e-02, 
-00051bd0: 2031 2e39 3834 3565 2d30 312c 202d 342e   1.9845e-01, -4.
-00051be0: 3530 3135 652d 3032 2c20 2d32 2e35 3930  5015e-02, -2.590
-00051bf0: 3365 2d30 315d 2c0d 0a20 2020 2020 2020  3e-01],..       
-00051c00: 2020 2020 2020 2020 205b 2d33 2e39 3939           [-3.999
-00051c10: 3365 2d30 322c 2020 332e 3934 3138 652d  3e-02,  3.9418e-
-00051c20: 3031 2c20 2d35 2e30 3139 3665 2d30 322c  01, -5.0196e-02,
-00051c30: 202d 352e 3635 3537 652d 3031 5d2c 0d0a   -5.6557e-01],..
-00051c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051c50: 5b2d 332e 3231 3039 652d 3032 2c20 2035  [-3.2109e-02,  5
-00051c60: 2e38 3939 3765 2d30 312c 202d 362e 3135  .8997e-01, -6.15
-00051c70: 3037 652d 3032 2c20 2d38 2e37 3336 3365  07e-02, -8.7363e
-00051c80: 2d30 315d 2c0d 0a20 2020 2020 2020 2020  -01],..         
-00051c90: 2020 2020 2020 205b 2d32 2e30 3331 3065         [-2.0310e
-00051ca0: 2d30 322c 2020 332e 3935 3734 652d 3031  -02,  3.9574e-01
-00051cb0: 2c20 2d37 2e38 3938 3065 2d30 322c 202d  , -7.8980e-02, -
-00051cc0: 362e 3030 3930 652d 3031 5d5d 290d 0a0d  6.0090e-01]])...
-00051cd0: 0a20 2020 2022 2222 0d0a 0d0a 2020 2020  .    """....    
-00051ce0: 6465 6620 5f5f 696e 6974 5f5f 280d 0a20  def __init__(.. 
-00051cf0: 2020 2020 2020 2073 656c 662c 0d0a 2020         self,..  
-00051d00: 2020 2020 2020 2a2c 0d0a 2020 2020 2020        *,..      
-00051d10: 2020 7265 706c 6163 653a 2062 6f6f 6c20    replace: bool 
-00051d20: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0d0a  | None = None,..
-00051d30: 2020 2020 2020 2020 6669 6c6c 5f66 6c6f          fill_flo
-00051d40: 6174 3d22 6e61 6e22 2c0d 0a20 2020 2020  at="nan",..     
-00051d50: 2020 2066 696c 6c5f 696e 743d 2d31 2c0d     fill_int=-1,.
-00051d60: 0a20 2020 2020 2020 2066 696c 6c5f 626f  .        fill_bo
-00051d70: 6f6c 3d46 616c 7365 2c0d 0a20 2020 2029  ol=False,..    )
-00051d80: 3a0d 0a20 2020 2020 2020 2073 7570 6572  :..        super
-00051d90: 2829 2e5f 5f69 6e69 745f 5f28 290d 0a20  ().__init__().. 
-00051da0: 2020 2020 2020 2069 6620 7265 706c 6163         if replac
-00051db0: 6520 6973 2046 616c 7365 3a0d 0a20 2020  e is False:..   
-00051dc0: 2020 2020 2020 2020 2066 696c 6c5f 666c           fill_fl
-00051dd0: 6f61 7420 3d20 6669 6c6c 5f69 6e74 203d  oat = fill_int =
-00051de0: 2066 696c 6c5f 626f 6f6c 203d 204e 6f6e   fill_bool = Non
-00051df0: 650d 0a20 2020 2020 2020 2069 6620 6669  e..        if fi
-00051e00: 6c6c 5f66 6c6f 6174 203d 3d20 226e 616e  ll_float == "nan
-00051e10: 223a 0d0a 2020 2020 2020 2020 2020 2020  ":..            
-00051e20: 6669 6c6c 5f66 6c6f 6174 203d 2066 6c6f  fill_float = flo
-00051e30: 6174 2822 6e61 6e22 290d 0a20 2020 2020  at("nan")..     
-00051e40: 2020 2073 656c 662e 6669 6c6c 5f66 6c6f     self.fill_flo
-00051e50: 6174 203d 2066 696c 6c5f 666c 6f61 740d  at = fill_float.
-00051e60: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
-00051e70: 6c6c 5f69 6e74 203d 2066 696c 6c5f 696e  ll_int = fill_in
-00051e80: 740d 0a20 2020 2020 2020 2073 656c 662e  t..        self.
-00051e90: 6669 6c6c 5f62 6f6f 6c20 3d20 6669 6c6c  fill_bool = fill
-00051ea0: 5f62 6f6f 6c0d 0a20 2020 2020 2020 2073  _bool..        s
-00051eb0: 656c 662e 5f76 616c 6964 6174 6564 203d  elf._validated =
-00051ec0: 2046 616c 7365 0d0a 0d0a 2020 2020 6465   False....    de
-00051ed0: 6620 5f76 616c 6964 6174 655f 636f 6e74  f _validate_cont
-00051ee0: 6169 6e65 7228 7365 6c66 293a 0d0a 2020  ainer(self):..  
-00051ef0: 2020 2020 2020 6966 2073 656c 662e 5f76        if self._v
-00051f00: 616c 6964 6174 6564 3a0d 0a20 2020 2020  alidated:..     
-00051f10: 2020 2020 2020 2072 6574 7572 6e0d 0a20         return.. 
-00051f20: 2020 2020 2020 2069 6620 7479 7065 2873         if type(s
-00051f30: 656c 662e 636f 6e74 6169 6e65 7229 2069  elf.container) i
-00051f40: 7320 6e6f 7420 4175 746f 5265 7365 7445  s not AutoResetE
-00051f50: 6e76 3a0d 0a20 2020 2020 2020 2020 2020  nv:..           
-00051f60: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
-00051f70: 726f 7228 0d0a 2020 2020 2020 2020 2020  ror(..          
-00051f80: 2020 2020 2020 6622 5468 6520 7b73 656c        f"The {sel
-00051f90: 662e 5f5f 636c 6173 735f 5f2e 5f5f 6e61  f.__class__.__na
-00051fa0: 6d65 5f5f 7d20 636f 6e74 6169 6e65 7220  me__} container 
-00051fb0: 6d75 7374 2062 6520 6f66 2074 7970 6520  must be of type 
-00051fc0: 4175 746f 5265 7365 7445 6e76 2e22 0d0a  AutoResetEnv."..
-00051fd0: 2020 2020 2020 2020 2020 2020 290d 0a20              ).. 
-00051fe0: 2020 2020 2020 2073 656c 662e 5f76 616c         self._val
-00051ff0: 6964 6174 6564 203d 2054 7275 650d 0a0d  idated = True...
-00052000: 0a20 2020 2064 6566 205f 7265 7365 7428  .    def _reset(
-00052010: 0d0a 2020 2020 2020 2020 7365 6c66 2c20  ..        self, 
-00052020: 7465 6e73 6f72 6469 6374 3a20 5465 6e73  tensordict: Tens
-00052030: 6f72 4469 6374 4261 7365 2c20 7465 6e73  orDictBase, tens
-00052040: 6f72 6469 6374 5f72 6573 6574 3a20 5465  ordict_reset: Te
-00052050: 6e73 6f72 4469 6374 4261 7365 0d0a 2020  nsorDictBase..  
-00052060: 2020 2920 2d3e 2054 656e 736f 7244 6963    ) -> TensorDic
-00052070: 7442 6173 653a 0d0a 2020 2020 2020 2020  tBase:..        
-00052080: 7365 6c66 2e5f 7661 6c69 6461 7465 5f63  self._validate_c
-00052090: 6f6e 7461 696e 6572 2829 0d0a 2020 2020  ontainer()..    
-000520a0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-000520b0: 5f72 6570 6c61 6365 5f61 7574 6f5f 7265  _replace_auto_re
-000520c0: 7365 745f 7661 6c73 2874 656e 736f 7264  set_vals(tensord
-000520d0: 6963 745f 7265 7365 743d 7465 6e73 6f72  ict_reset=tensor
-000520e0: 6469 6374 5f72 6573 6574 290d 0a0d 0a20  dict_reset).... 
-000520f0: 2020 2064 6566 205f 7374 6570 280d 0a20     def _step(.. 
-00052100: 2020 2020 2020 2073 656c 662c 2074 656e         self, ten
-00052110: 736f 7264 6963 743a 2054 656e 736f 7244  sordict: TensorD
-00052120: 6963 7442 6173 652c 206e 6578 745f 7465  ictBase, next_te
-00052130: 6e73 6f72 6469 6374 3a20 5465 6e73 6f72  nsordict: Tensor
-00052140: 4469 6374 4261 7365 0d0a 2020 2020 2920  DictBase..    ) 
-00052150: 2d3e 2054 656e 736f 7244 6963 7442 6173  -> TensorDictBas
-00052160: 653a 0d0a 2020 2020 2020 2020 7265 7475  e:..        retu
-00052170: 726e 2073 656c 662e 5f63 6f72 7265 6374  rn self._correct
-00052180: 5f61 7574 6f5f 7265 7365 745f 7661 6c73  _auto_reset_vals
-00052190: 286e 6578 745f 7465 6e73 6f72 6469 6374  (next_tensordict
-000521a0: 290d 0a0d 0a20 2020 2064 6566 2066 6f72  )....    def for
-000521b0: 7761 7264 2873 656c 662c 2074 656e 736f  ward(self, tenso
-000521c0: 7264 6963 743a 2054 656e 736f 7244 6963  rdict: TensorDic
-000521d0: 7442 6173 6529 202d 3e20 5465 6e73 6f72  tBase) -> Tensor
-000521e0: 4469 6374 4261 7365 3a0d 0a20 2020 2020  DictBase:..     
-000521f0: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
-00052200: 4572 726f 720d 0a0d 0a20 2020 2040 7072  Error....    @pr
-00052210: 6f70 6572 7479 0d0a 2020 2020 6465 6620  operty..    def 
-00052220: 5f73 696d 706c 655f 646f 6e65 2873 656c  _simple_done(sel
-00052230: 6629 3a0d 0a20 2020 2020 2020 2072 6574  f):..        ret
-00052240: 7572 6e20 7365 6c66 2e70 6172 656e 742e  urn self.parent.
-00052250: 5f73 696d 706c 655f 646f 6e65 0d0a 0d0a  _simple_done....
-00052260: 2020 2020 6465 6620 5f63 6f72 7265 6374      def _correct
-00052270: 5f61 7574 6f5f 7265 7365 745f 7661 6c73  _auto_reset_vals
-00052280: 2873 656c 662c 2074 656e 736f 7264 6963  (self, tensordic
-00052290: 7429 3a0d 0a20 2020 2020 2020 2023 2077  t):..        # w
-000522a0: 6520 6e65 6564 2074 6f20 6d6f 7665 2074  e need to move t
-000522b0: 6865 2064 6174 6120 6672 6f6d 2074 656e  he data from ten
-000522c0: 736f 7264 6963 7420 746f 2074 656e 736f  sordict to tenso
-000522d0: 7264 6963 745f 0d0a 2020 2020 2020 2020  rdict_..        
-000522e0: 6465 6620 7265 706c 6163 655f 616e 645f  def replace_and_
-000522f0: 7365 7428 6b65 792c 2076 616c 2c20 6d61  set(key, val, ma
-00052300: 736b 2c20 7361 7665 645f 7464 5f61 7574  sk, saved_td_aut
-00052310: 6f72 6573 6574 2c20 6167 656e 743d 7465  oreset, agent=te
-00052320: 6e73 6f72 6469 6374 293a 0d0a 2020 2020  nsordict):..    
-00052330: 2020 2020 2020 2020 7361 7665 645f 7464          saved_td
-00052340: 5f61 7574 6f72 6573 6574 2e73 6574 286b  _autoreset.set(k
-00052350: 6579 2c20 7661 6c29 0d0a 2020 2020 2020  ey, val)..      
-00052360: 2020 2020 2020 6966 2076 616c 2e64 7479        if val.dty
-00052370: 7065 2e69 735f 666c 6f61 7469 6e67 5f70  pe.is_floating_p
-00052380: 6f69 6e74 3a0d 0a20 2020 2020 2020 2020  oint:..         
-00052390: 2020 2020 2020 2069 6620 7365 6c66 2e66         if self.f
-000523a0: 696c 6c5f 666c 6f61 7420 6973 204e 6f6e  ill_float is Non
-000523b0: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
-000523c0: 2020 2020 2020 2020 7661 6c5f 7365 745f          val_set_
-000523d0: 6e61 6e20 3d20 7661 6c2e 636c 6f6e 6528  nan = val.clone(
-000523e0: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
-000523f0: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
-00052400: 2020 2020 2020 2020 2020 2020 2020 7661                va
-00052410: 6c5f 7365 745f 6e61 6e20 3d20 746f 7263  l_set_nan = torc
-00052420: 682e 7768 6572 6528 0d0a 2020 2020 2020  h.where(..      
-00052430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052440: 2020 6578 7061 6e64 5f61 735f 7269 6768    expand_as_righ
-00052450: 7428 6d61 736b 2c20 7661 6c29 2c0d 0a20  t(mask, val),.. 
-00052460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052470: 2020 2020 2020 2074 6f72 6368 2e66 756c         torch.ful
-00052480: 6c5f 6c69 6b65 2876 616c 2c20 7365 6c66  l_like(val, self
-00052490: 2e66 696c 6c5f 666c 6f61 7429 2c0d 0a20  .fill_float),.. 
-000524a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000524b0: 2020 2020 2020 2076 616c 2c0d 0a20 2020         val,..   
-000524c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000524d0: 2029 0d0a 2020 2020 2020 2020 2020 2020   )..            
-000524e0: 656c 6966 2076 616c 2e64 7479 7065 2e69  elif val.dtype.i
-000524f0: 735f 7369 676e 6564 3a0d 0a20 2020 2020  s_signed:..     
-00052500: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00052510: 6c66 2e66 696c 6c5f 696e 7420 6973 204e  lf.fill_int is N
-00052520: 6f6e 653a 0d0a 2020 2020 2020 2020 2020  one:..          
-00052530: 2020 2020 2020 2020 2020 7661 6c5f 7365            val_se
-00052540: 745f 6e61 6e20 3d20 7661 6c2e 636c 6f6e  t_nan = val.clon
-00052550: 6528 290d 0a20 2020 2020 2020 2020 2020  e()..           
-00052560: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
-00052570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052580: 7661 6c5f 7365 745f 6e61 6e20 3d20 746f  val_set_nan = to
-00052590: 7263 682e 7768 6572 6528 0d0a 2020 2020  rch.where(..    
-000525a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000525b0: 2020 2020 6578 7061 6e64 5f61 735f 7269      expand_as_ri
-000525c0: 6768 7428 6d61 736b 2c20 7661 6c29 2c0d  ght(mask, val),.
-000525d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000525e0: 2020 2020 2020 2020 2074 6f72 6368 2e66           torch.f
-000525f0: 756c 6c5f 6c69 6b65 2876 616c 2c20 7365  ull_like(val, se
-00052600: 6c66 2e66 696c 6c5f 696e 7429 2c0d 0a20  lf.fill_int),.. 
-00052610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052620: 2020 2020 2020 2076 616c 2c0d 0a20 2020         val,..   
-00052630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052640: 2029 0d0a 2020 2020 2020 2020 2020 2020   )..            
-00052650: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
-00052660: 2020 2020 2020 2069 6620 7365 6c66 2e66         if self.f
-00052670: 696c 6c5f 626f 6f6c 2069 7320 4e6f 6e65  ill_bool is None
-00052680: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-00052690: 2020 2020 2020 2076 616c 5f73 6574 5f6e         val_set_n
-000526a0: 616e 203d 2076 616c 2e63 6c6f 6e65 2829  an = val.clone()
-000526b0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000526c0: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
-000526d0: 2020 2020 2020 2020 2020 2020 2076 616c               val
-000526e0: 5f73 6574 5f6e 616e 203d 2074 6f72 6368  _set_nan = torch
-000526f0: 2e77 6865 7265 280d 0a20 2020 2020 2020  .where(..       
+0004b920: 2020 2020 2020 2020 646f 6e65 3a20 5465          done: Te
+0004b930: 6e73 6f72 2873 6861 7065 3d74 6f72 6368  nsor(shape=torch
+0004b940: 2e53 697a 6528 5b32 2c20 315d 292c 2064  .Size([2, 1]), d
+0004b950: 6576 6963 653d 6370 752c 2064 7479 7065  evice=cpu, dtype
+0004b960: 3d74 6f72 6368 2e62 6f6f 6c2c 2069 735f  =torch.bool, is_
+0004b970: 7368 6172 6564 3d46 616c 7365 292c 0d0a  shared=False),..
+0004b980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b990: 2020 2020 2020 2020 6f62 7365 7276 6174          observat
+0004b9a0: 696f 6e3a 2054 656e 736f 7228 7368 6170  ion: Tensor(shap
+0004b9b0: 653d 746f 7263 682e 5369 7a65 285b 322c  e=torch.Size([2,
+0004b9c0: 2033 5d29 2c20 6465 7669 6365 3d63 7075   3]), device=cpu
+0004b9d0: 2c20 6474 7970 653d 746f 7263 682e 666c  , dtype=torch.fl
+0004b9e0: 6f61 7433 322c 2069 735f 7368 6172 6564  oat32, is_shared
+0004b9f0: 3d46 616c 7365 292c 0d0a 2020 2020 2020  =False),..      
+0004ba00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ba10: 2020 7265 7761 7264 3a20 5465 6e73 6f72    reward: Tensor
+0004ba20: 2873 6861 7065 3d74 6f72 6368 2e53 697a  (shape=torch.Siz
+0004ba30: 6528 5b32 2c20 315d 292c 2064 6576 6963  e([2, 1]), devic
+0004ba40: 653d 6370 752c 2064 7479 7065 3d74 6f72  e=cpu, dtype=tor
+0004ba50: 6368 2e66 6c6f 6174 3332 2c20 6973 5f73  ch.float32, is_s
+0004ba60: 6861 7265 643d 4661 6c73 6529 2c0d 0a20  hared=False),.. 
+0004ba70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ba80: 2020 2020 2020 2074 6572 6d69 6e61 7465         terminate
+0004ba90: 643a 2054 656e 736f 7228 7368 6170 653d  d: Tensor(shape=
+0004baa0: 746f 7263 682e 5369 7a65 285b 322c 2031  torch.Size([2, 1
+0004bab0: 5d29 2c20 6465 7669 6365 3d63 7075 2c20  ]), device=cpu, 
+0004bac0: 6474 7970 653d 746f 7263 682e 626f 6f6c  dtype=torch.bool
+0004bad0: 2c20 6973 5f73 6861 7265 643d 4661 6c73  , is_shared=Fals
+0004bae0: 6529 2c0d 0a20 2020 2020 2020 2020 2020  e),..           
+0004baf0: 2020 2020 2020 2020 2020 2020 2074 7275               tru
+0004bb00: 6e63 6174 6564 3a20 5465 6e73 6f72 2873  ncated: Tensor(s
+0004bb10: 6861 7065 3d74 6f72 6368 2e53 697a 6528  hape=torch.Size(
+0004bb20: 5b32 2c20 315d 292c 2064 6576 6963 653d  [2, 1]), device=
+0004bb30: 6370 752c 2064 7479 7065 3d74 6f72 6368  cpu, dtype=torch
+0004bb40: 2e62 6f6f 6c2c 2069 735f 7368 6172 6564  .bool, is_shared
+0004bb50: 3d46 616c 7365 297d 2c0d 0a20 2020 2020  =False)},..     
+0004bb60: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0004bb70: 6174 6368 5f73 697a 653d 746f 7263 682e  atch_size=torch.
+0004bb80: 5369 7a65 285b 325d 292c 0d0a 2020 2020  Size([2]),..    
+0004bb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bba0: 6465 7669 6365 3d63 7075 2c0d 0a20 2020  device=cpu,..   
+0004bbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bbc0: 2069 735f 7368 6172 6564 3d46 616c 7365   is_shared=False
+0004bbd0: 292c 0d0a 2020 2020 2020 2020 2020 2020  ),..            
+0004bbe0: 2020 2020 6f62 7365 7276 6174 696f 6e3a      observation:
+0004bbf0: 2054 656e 736f 7228 7368 6170 653d 746f   Tensor(shape=to
+0004bc00: 7263 682e 5369 7a65 285b 322c 2033 5d29  rch.Size([2, 3])
+0004bc10: 2c20 6465 7669 6365 3d63 7075 2c20 6474  , device=cpu, dt
+0004bc20: 7970 653d 746f 7263 682e 666c 6f61 7433  ype=torch.float3
+0004bc30: 322c 2069 735f 7368 6172 6564 3d46 616c  2, is_shared=Fal
+0004bc40: 7365 292c 0d0a 2020 2020 2020 2020 2020  se),..          
+0004bc50: 2020 2020 2020 7465 726d 696e 6174 6564        terminated
+0004bc60: 3a20 5465 6e73 6f72 2873 6861 7065 3d74  : Tensor(shape=t
+0004bc70: 6f72 6368 2e53 697a 6528 5b32 2c20 315d  orch.Size([2, 1]
+0004bc80: 292c 2064 6576 6963 653d 6370 752c 2064  ), device=cpu, d
+0004bc90: 7479 7065 3d74 6f72 6368 2e62 6f6f 6c2c  type=torch.bool,
+0004bca0: 2069 735f 7368 6172 6564 3d46 616c 7365   is_shared=False
+0004bcb0: 292c 0d0a 2020 2020 2020 2020 2020 2020  ),..            
+0004bcc0: 2020 2020 7472 756e 6361 7465 643a 2054      truncated: T
+0004bcd0: 656e 736f 7228 7368 6170 653d 746f 7263  ensor(shape=torc
+0004bce0: 682e 5369 7a65 285b 322c 2031 5d29 2c20  h.Size([2, 1]), 
+0004bcf0: 6465 7669 6365 3d63 7075 2c20 6474 7970  device=cpu, dtyp
+0004bd00: 653d 746f 7263 682e 626f 6f6c 2c20 6973  e=torch.bool, is
+0004bd10: 5f73 6861 7265 643d 4661 6c73 6529 7d2c  _shared=False)},
+0004bd20: 0d0a 2020 2020 2020 2020 2020 2020 6261  ..            ba
+0004bd30: 7463 685f 7369 7a65 3d74 6f72 6368 2e53  tch_size=torch.S
+0004bd40: 697a 6528 5b32 5d29 2c0d 0a20 2020 2020  ize([2]),..     
+0004bd50: 2020 2020 2020 2064 6576 6963 653d 6370         device=cp
+0004bd60: 752c 0d0a 2020 2020 2020 2020 2020 2020  u,..            
+0004bd70: 6973 5f73 6861 7265 643d 4661 6c73 6529  is_shared=False)
+0004bd80: 0d0a 2020 2020 2020 2020 6368 6563 6b5f  ..        check_
+0004bd90: 656e 765f 7370 6563 7328 656e 7629 0d0a  env_specs(env)..
+0004bda0: 2020 2020 2222 220d 0a0d 0a20 2020 205f      """....    _
+0004bdb0: 6861 735f 656d 7074 795f 696e 7075 7420  has_empty_input 
+0004bdc0: 3d20 5472 7565 0d0a 0d0a 2020 2020 4073  = True....    @s
+0004bdd0: 7461 7469 636d 6574 686f 640d 0a20 2020  taticmethod..   
+0004bde0: 2064 6566 205f 736f 7274 6572 286b 6579   def _sorter(key
+0004bdf0: 5f76 616c 293a 0d0a 2020 2020 2020 2020  _val):..        
+0004be00: 6b65 792c 205f 203d 206b 6579 5f76 616c  key, _ = key_val
+0004be10: 0d0a 2020 2020 2020 2020 6966 2069 7369  ..        if isi
+0004be20: 6e73 7461 6e63 6528 6b65 792c 2073 7472  nstance(key, str
+0004be30: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
+0004be40: 7265 7475 726e 2030 0d0a 2020 2020 2020  return 0..      
+0004be50: 2020 7265 7475 726e 206c 656e 286b 6579    return len(key
+0004be60: 290d 0a0d 0a20 2020 2064 6566 2074 7261  )....    def tra
+0004be70: 6e73 666f 726d 5f6f 7574 7075 745f 7370  nsform_output_sp
+0004be80: 6563 2873 656c 662c 206f 7574 7075 745f  ec(self, output_
+0004be90: 7370 6563 3a20 436f 6d70 6f73 6974 6553  spec: CompositeS
+0004bea0: 7065 6329 202d 3e20 436f 6d70 6f73 6974  pec) -> Composit
+0004beb0: 6553 7065 633a 0d0a 2020 2020 2020 2020  eSpec:..        
+0004bec0: 6675 6c6c 5f64 6f6e 655f 7370 6563 203d  full_done_spec =
+0004bed0: 206f 7574 7075 745f 7370 6563 5b22 6675   output_spec["fu
+0004bee0: 6c6c 5f64 6f6e 655f 7370 6563 225d 0d0a  ll_done_spec"]..
+0004bef0: 2020 2020 2020 2020 6675 6c6c 5f72 6577          full_rew
+0004bf00: 6172 645f 7370 6563 203d 206f 7574 7075  ard_spec = outpu
+0004bf10: 745f 7370 6563 5b22 6675 6c6c 5f72 6577  t_spec["full_rew
+0004bf20: 6172 645f 7370 6563 225d 0d0a 2020 2020  ard_spec"]..    
+0004bf30: 2020 2020 6675 6c6c 5f6f 6273 6572 7661      full_observa
+0004bf40: 7469 6f6e 5f73 7065 6320 3d20 6f75 7470  tion_spec = outp
+0004bf50: 7574 5f73 7065 635b 2266 756c 6c5f 6f62  ut_spec["full_ob
+0004bf60: 7365 7276 6174 696f 6e5f 7370 6563 225d  servation_spec"]
+0004bf70: 0d0a 2020 2020 2020 2020 2320 7765 2072  ..        # we r
+0004bf80: 6576 6572 7365 2074 6869 6e67 7320 746f  everse things to
+0004bf90: 206d 616b 6520 7375 7265 2077 6520 6465   make sure we de
+0004bfa0: 6c65 7465 2074 6869 6e67 7320 6672 6f6d  lete things from
+0004bfb0: 2074 6865 2062 6163 6b0d 0a20 2020 2020   the back..     
+0004bfc0: 2020 2066 6f72 206b 6579 2c20 7370 6563     for key, spec
+0004bfd0: 2069 6e20 736f 7274 6564 280d 0a20 2020   in sorted(..   
+0004bfe0: 2020 2020 2020 2020 2066 756c 6c5f 646f           full_do
+0004bff0: 6e65 5f73 7065 632e 6974 656d 7328 5472  ne_spec.items(Tr
+0004c000: 7565 292c 206b 6579 3d73 656c 662e 5f73  ue), key=self._s
+0004c010: 6f72 7465 722c 2072 6576 6572 7365 3d54  orter, reverse=T
+0004c020: 7275 650d 0a20 2020 2020 2020 2029 3a0d  rue..        ):.
+0004c030: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0004c040: 6973 696e 7374 616e 6365 2873 7065 632c  isinstance(spec,
+0004c050: 2043 6f6d 706f 7369 7465 5370 6563 2920   CompositeSpec) 
+0004c060: 616e 6420 7370 6563 2e69 735f 656d 7074  and spec.is_empt
+0004c070: 7928 293a 0d0a 2020 2020 2020 2020 2020  y():..          
+0004c080: 2020 2020 2020 6465 6c20 6675 6c6c 5f64        del full_d
+0004c090: 6f6e 655f 7370 6563 5b6b 6579 5d0d 0a0d  one_spec[key]...
+0004c0a0: 0a20 2020 2020 2020 2066 6f72 206b 6579  .        for key
+0004c0b0: 2c20 7370 6563 2069 6e20 736f 7274 6564  , spec in sorted
+0004c0c0: 280d 0a20 2020 2020 2020 2020 2020 2066  (..            f
+0004c0d0: 756c 6c5f 6f62 7365 7276 6174 696f 6e5f  ull_observation_
+0004c0e0: 7370 6563 2e69 7465 6d73 2854 7275 6529  spec.items(True)
+0004c0f0: 2c20 6b65 793d 7365 6c66 2e5f 736f 7274  , key=self._sort
+0004c100: 6572 2c20 7265 7665 7273 653d 5472 7565  er, reverse=True
+0004c110: 0d0a 2020 2020 2020 2020 293a 0d0a 2020  ..        ):..  
+0004c120: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
+0004c130: 6e73 7461 6e63 6528 7370 6563 2c20 436f  nstance(spec, Co
+0004c140: 6d70 6f73 6974 6553 7065 6329 2061 6e64  mpositeSpec) and
+0004c150: 2073 7065 632e 6973 5f65 6d70 7479 2829   spec.is_empty()
+0004c160: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+0004c170: 2020 2064 656c 2066 756c 6c5f 6f62 7365     del full_obse
+0004c180: 7276 6174 696f 6e5f 7370 6563 5b6b 6579  rvation_spec[key
+0004c190: 5d0d 0a0d 0a20 2020 2020 2020 2066 6f72  ]....        for
+0004c1a0: 206b 6579 2c20 7370 6563 2069 6e20 736f   key, spec in so
+0004c1b0: 7274 6564 280d 0a20 2020 2020 2020 2020  rted(..         
+0004c1c0: 2020 2066 756c 6c5f 7265 7761 7264 5f73     full_reward_s
+0004c1d0: 7065 632e 6974 656d 7328 5472 7565 292c  pec.items(True),
+0004c1e0: 206b 6579 3d73 656c 662e 5f73 6f72 7465   key=self._sorte
+0004c1f0: 722c 2072 6576 6572 7365 3d54 7275 650d  r, reverse=True.
+0004c200: 0a20 2020 2020 2020 2029 3a0d 0a20 2020  .        ):..   
+0004c210: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
+0004c220: 7374 616e 6365 2873 7065 632c 2043 6f6d  stance(spec, Com
+0004c230: 706f 7369 7465 5370 6563 2920 616e 6420  positeSpec) and 
+0004c240: 7370 6563 2e69 735f 656d 7074 7928 293a  spec.is_empty():
+0004c250: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0004c260: 2020 6465 6c20 6675 6c6c 5f72 6577 6172    del full_rewar
+0004c270: 645f 7370 6563 5b6b 6579 5d0d 0a20 2020  d_spec[key]..   
+0004c280: 2020 2020 2072 6574 7572 6e20 6f75 7470       return outp
+0004c290: 7574 5f73 7065 630d 0a0d 0a20 2020 2064  ut_spec....    d
+0004c2a0: 6566 2074 7261 6e73 666f 726d 5f69 6e70  ef transform_inp
+0004c2b0: 7574 5f73 7065 6328 7365 6c66 2c20 696e  ut_spec(self, in
+0004c2c0: 7075 745f 7370 6563 3a20 5465 6e73 6f72  put_spec: Tensor
+0004c2d0: 5370 6563 2920 2d3e 2054 656e 736f 7253  Spec) -> TensorS
+0004c2e0: 7065 633a 0d0a 2020 2020 2020 2020 6675  pec:..        fu
+0004c2f0: 6c6c 5f61 6374 696f 6e5f 7370 6563 203d  ll_action_spec =
+0004c300: 2069 6e70 7574 5f73 7065 635b 2266 756c   input_spec["ful
+0004c310: 6c5f 6163 7469 6f6e 5f73 7065 6322 5d0d  l_action_spec"].
+0004c320: 0a20 2020 2020 2020 2066 756c 6c5f 7374  .        full_st
+0004c330: 6174 655f 7370 6563 203d 2069 6e70 7574  ate_spec = input
+0004c340: 5f73 7065 635b 2266 756c 6c5f 7374 6174  _spec["full_stat
+0004c350: 655f 7370 6563 225d 0d0a 2020 2020 2020  e_spec"]..      
+0004c360: 2020 2320 7765 2072 6576 6572 7365 2074    # we reverse t
+0004c370: 6869 6e67 7320 746f 206d 616b 6520 7375  hings to make su
+0004c380: 7265 2077 6520 6465 6c65 7465 2074 6869  re we delete thi
+0004c390: 6e67 7320 6672 6f6d 2074 6865 2062 6163  ngs from the bac
+0004c3a0: 6b0d 0a0d 0a20 2020 2020 2020 2073 656c  k....        sel
+0004c3b0: 662e 5f68 6173 5f65 6d70 7479 5f69 6e70  f._has_empty_inp
+0004c3c0: 7574 203d 2046 616c 7365 0d0a 2020 2020  ut = False..    
+0004c3d0: 2020 2020 666f 7220 6b65 792c 2073 7065      for key, spe
+0004c3e0: 6320 696e 2073 6f72 7465 6428 0d0a 2020  c in sorted(..  
+0004c3f0: 2020 2020 2020 2020 2020 6675 6c6c 5f61            full_a
+0004c400: 6374 696f 6e5f 7370 6563 2e69 7465 6d73  ction_spec.items
+0004c410: 2854 7275 6529 2c20 6b65 793d 7365 6c66  (True), key=self
+0004c420: 2e5f 736f 7274 6572 2c20 7265 7665 7273  ._sorter, revers
+0004c430: 653d 5472 7565 0d0a 2020 2020 2020 2020  e=True..        
+0004c440: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
+0004c450: 6966 2069 7369 6e73 7461 6e63 6528 7370  if isinstance(sp
+0004c460: 6563 2c20 436f 6d70 6f73 6974 6553 7065  ec, CompositeSpe
+0004c470: 6329 2061 6e64 2073 7065 632e 6973 5f65  c) and spec.is_e
+0004c480: 6d70 7479 2829 3a0d 0a20 2020 2020 2020  mpty():..       
+0004c490: 2020 2020 2020 2020 2073 656c 662e 5f68           self._h
+0004c4a0: 6173 5f65 6d70 7479 5f69 6e70 7574 203d  as_empty_input =
+0004c4b0: 2054 7275 650d 0a20 2020 2020 2020 2020   True..         
+0004c4c0: 2020 2020 2020 2064 656c 2066 756c 6c5f         del full_
+0004c4d0: 6163 7469 6f6e 5f73 7065 635b 6b65 795d  action_spec[key]
+0004c4e0: 0d0a 0d0a 2020 2020 2020 2020 666f 7220  ....        for 
+0004c4f0: 6b65 792c 2073 7065 6320 696e 2073 6f72  key, spec in sor
+0004c500: 7465 6428 0d0a 2020 2020 2020 2020 2020  ted(..          
+0004c510: 2020 6675 6c6c 5f73 7461 7465 5f73 7065    full_state_spe
+0004c520: 632e 6974 656d 7328 5472 7565 292c 206b  c.items(True), k
+0004c530: 6579 3d73 656c 662e 5f73 6f72 7465 722c  ey=self._sorter,
+0004c540: 2072 6576 6572 7365 3d54 7275 650d 0a20   reverse=True.. 
+0004c550: 2020 2020 2020 2029 3a0d 0a20 2020 2020         ):..     
+0004c560: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+0004c570: 616e 6365 2873 7065 632c 2043 6f6d 706f  ance(spec, Compo
+0004c580: 7369 7465 5370 6563 2920 616e 6420 7370  siteSpec) and sp
+0004c590: 6563 2e69 735f 656d 7074 7928 293a 0d0a  ec.is_empty():..
+0004c5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c5b0: 7365 6c66 2e5f 6861 735f 656d 7074 795f  self._has_empty_
+0004c5c0: 696e 7075 7420 3d20 5472 7565 0d0a 2020  input = True..  
+0004c5d0: 2020 2020 2020 2020 2020 2020 2020 6465                de
+0004c5e0: 6c20 6675 6c6c 5f73 7461 7465 5f73 7065  l full_state_spe
+0004c5f0: 635b 6b65 795d 0d0a 2020 2020 2020 2020  c[key]..        
+0004c600: 7265 7475 726e 2069 6e70 7574 5f73 7065  return input_spe
+0004c610: 630d 0a0d 0a20 2020 2064 6566 205f 696e  c....    def _in
+0004c620: 765f 6361 6c6c 2873 656c 662c 2074 656e  v_call(self, ten
+0004c630: 736f 7264 6963 743a 2054 656e 736f 7244  sordict: TensorD
+0004c640: 6963 7442 6173 6529 202d 3e20 5465 6e73  ictBase) -> Tens
+0004c650: 6f72 4469 6374 4261 7365 3a0d 0a20 2020  orDictBase:..   
+0004c660: 2020 2020 2069 6620 7365 6c66 2e5f 6861       if self._ha
+0004c670: 735f 656d 7074 795f 696e 7075 743a 0d0a  s_empty_input:..
+0004c680: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+0004c690: 745f 7370 6563 203d 2067 6574 6174 7472  t_spec = getattr
+0004c6a0: 2873 656c 662e 7061 7265 6e74 2c20 2269  (self.parent, "i
+0004c6b0: 6e70 7574 5f73 7065 6322 2c20 4e6f 6e65  nput_spec", None
+0004c6c0: 290d 0a20 2020 2020 2020 2020 2020 2069  )..            i
+0004c6d0: 6620 696e 7075 745f 7370 6563 2069 7320  f input_spec is 
+0004c6e0: 4e6f 6e65 3a0d 0a20 2020 2020 2020 2020  None:..         
+0004c6f0: 2020 2020 2020 2072 6574 7572 6e20 7465         return te
+0004c700: 6e73 6f72 6469 6374 0d0a 0d0a 2020 2020  nsordict....    
+0004c710: 2020 2020 2020 2020 6675 6c6c 5f61 6374          full_act
+0004c720: 696f 6e5f 7370 6563 203d 2069 6e70 7574  ion_spec = input
+0004c730: 5f73 7065 635b 2266 756c 6c5f 6163 7469  _spec["full_acti
+0004c740: 6f6e 5f73 7065 6322 5d0d 0a20 2020 2020  on_spec"]..     
+0004c750: 2020 2020 2020 2066 756c 6c5f 7374 6174         full_stat
+0004c760: 655f 7370 6563 203d 2069 6e70 7574 5f73  e_spec = input_s
+0004c770: 7065 635b 2266 756c 6c5f 7374 6174 655f  pec["full_state_
+0004c780: 7370 6563 225d 0d0a 2020 2020 2020 2020  spec"]..        
+0004c790: 2020 2020 2320 7765 2072 6576 6572 7365      # we reverse
+0004c7a0: 2074 6869 6e67 7320 746f 206d 616b 6520   things to make 
+0004c7b0: 7375 7265 2077 6520 6465 6c65 7465 2074  sure we delete t
+0004c7c0: 6869 6e67 7320 6672 6f6d 2074 6865 2062  hings from the b
+0004c7d0: 6163 6b0d 0a0d 0a20 2020 2020 2020 2020  ack....         
+0004c7e0: 2020 2066 6f72 206b 6579 2c20 7370 6563     for key, spec
+0004c7f0: 2069 6e20 736f 7274 6564 280d 0a20 2020   in sorted(..   
+0004c800: 2020 2020 2020 2020 2020 2020 2066 756c               ful
+0004c810: 6c5f 6163 7469 6f6e 5f73 7065 632e 6974  l_action_spec.it
+0004c820: 656d 7328 5472 7565 292c 206b 6579 3d73  ems(True), key=s
+0004c830: 656c 662e 5f73 6f72 7465 722c 2072 6576  elf._sorter, rev
+0004c840: 6572 7365 3d54 7275 650d 0a20 2020 2020  erse=True..     
+0004c850: 2020 2020 2020 2029 3a0d 0a20 2020 2020         ):..     
+0004c860: 2020 2020 2020 2020 2020 2069 6620 280d             if (.
+0004c870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004c880: 2020 2020 2069 7369 6e73 7461 6e63 6528       isinstance(
+0004c890: 7370 6563 2c20 436f 6d70 6f73 6974 6553  spec, CompositeS
+0004c8a0: 7065 6329 0d0a 2020 2020 2020 2020 2020  pec)..          
+0004c8b0: 2020 2020 2020 2020 2020 616e 6420 7370            and sp
+0004c8c0: 6563 2e69 735f 656d 7074 7928 290d 0a20  ec.is_empty().. 
+0004c8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c8e0: 2020 2061 6e64 206b 6579 206e 6f74 2069     and key not i
+0004c8f0: 6e20 7465 6e73 6f72 6469 6374 2e6b 6579  n tensordict.key
+0004c900: 7328 5472 7565 290d 0a20 2020 2020 2020  s(True)..       
+0004c910: 2020 2020 2020 2020 2029 3a0d 0a20 2020           ):..   
+0004c920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c930: 2074 656e 736f 7264 6963 742e 6372 6561   tensordict.crea
+0004c940: 7465 5f6e 6573 7465 6428 6b65 7929 0d0a  te_nested(key)..
+0004c950: 0d0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+0004c960: 7220 6b65 792c 2073 7065 6320 696e 2073  r key, spec in s
+0004c970: 6f72 7465 6428 0d0a 2020 2020 2020 2020  orted(..        
+0004c980: 2020 2020 2020 2020 6675 6c6c 5f73 7461          full_sta
+0004c990: 7465 5f73 7065 632e 6974 656d 7328 5472  te_spec.items(Tr
+0004c9a0: 7565 292c 206b 6579 3d73 656c 662e 5f73  ue), key=self._s
+0004c9b0: 6f72 7465 722c 2072 6576 6572 7365 3d54  orter, reverse=T
+0004c9c0: 7275 650d 0a20 2020 2020 2020 2020 2020  rue..           
+0004c9d0: 2029 3a0d 0a20 2020 2020 2020 2020 2020   ):..           
+0004c9e0: 2020 2020 2069 6620 280d 0a20 2020 2020       if (..     
+0004c9f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0004ca00: 7369 6e73 7461 6e63 6528 7370 6563 2c20  sinstance(spec, 
+0004ca10: 436f 6d70 6f73 6974 6553 7065 6329 0d0a  CompositeSpec)..
+0004ca20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ca30: 2020 2020 616e 6420 7370 6563 2e69 735f      and spec.is_
+0004ca40: 656d 7074 7928 290d 0a20 2020 2020 2020  empty()..       
+0004ca50: 2020 2020 2020 2020 2020 2020 2061 6e64               and
+0004ca60: 206b 6579 206e 6f74 2069 6e20 7465 6e73   key not in tens
+0004ca70: 6f72 6469 6374 2e6b 6579 7328 5472 7565  ordict.keys(True
+0004ca80: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+0004ca90: 2020 2029 3a0d 0a20 2020 2020 2020 2020     ):..         
+0004caa0: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
+0004cab0: 7264 6963 742e 6372 6561 7465 5f6e 6573  rdict.create_nes
+0004cac0: 7465 6428 6b65 7929 0d0a 2020 2020 2020  ted(key)..      
+0004cad0: 2020 7265 7475 726e 2074 656e 736f 7264    return tensord
+0004cae0: 6963 740d 0a0d 0a20 2020 2064 6566 205f  ict....    def _
+0004caf0: 6361 6c6c 2873 656c 662c 2074 656e 736f  call(self, tenso
+0004cb00: 7264 6963 743a 2054 656e 736f 7244 6963  rdict: TensorDic
+0004cb10: 7442 6173 6529 202d 3e20 5465 6e73 6f72  tBase) -> Tensor
+0004cb20: 4469 6374 4261 7365 3a0d 0a20 2020 2020  DictBase:..     
+0004cb30: 2020 2066 6f72 206b 6579 2c20 7661 6c75     for key, valu
+0004cb40: 6520 696e 2073 6f72 7465 6428 0d0a 2020  e in sorted(..  
+0004cb50: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
+0004cb60: 6469 6374 2e69 7465 6d73 2854 7275 6529  dict.items(True)
+0004cb70: 2c20 6b65 793d 7365 6c66 2e5f 736f 7274  , key=self._sort
+0004cb80: 6572 2c20 7265 7665 7273 653d 5472 7565  er, reverse=True
+0004cb90: 0d0a 2020 2020 2020 2020 293a 0d0a 2020  ..        ):..  
+0004cba0: 2020 2020 2020 2020 2020 6966 2028 0d0a            if (..
+0004cbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cbc0: 6973 5f74 656e 736f 725f 636f 6c6c 6563  is_tensor_collec
+0004cbd0: 7469 6f6e 2876 616c 7565 290d 0a20 2020  tion(value)..   
+0004cbe0: 2020 2020 2020 2020 2020 2020 2061 6e64               and
+0004cbf0: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+0004cc00: 7661 6c75 652c 204e 6f6e 5465 6e73 6f72  value, NonTensor
+0004cc10: 4461 7461 290d 0a20 2020 2020 2020 2020  Data)..         
+0004cc20: 2020 2020 2020 2061 6e64 2076 616c 7565         and value
+0004cc30: 2e69 735f 656d 7074 7928 290d 0a20 2020  .is_empty()..   
+0004cc40: 2020 2020 2020 2020 2029 3a0d 0a20 2020           ):..   
+0004cc50: 2020 2020 2020 2020 2020 2020 2064 656c               del
+0004cc60: 2074 656e 736f 7264 6963 745b 6b65 795d   tensordict[key]
+0004cc70: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0004cc80: 2074 656e 736f 7264 6963 740d 0a0d 0a20   tensordict.... 
+0004cc90: 2020 2064 6566 205f 7265 7365 7428 0d0a     def _reset(..
+0004cca0: 2020 2020 2020 2020 7365 6c66 2c20 7465          self, te
+0004ccb0: 6e73 6f72 6469 6374 3a20 5465 6e73 6f72  nsordict: Tensor
+0004ccc0: 4469 6374 4261 7365 2c20 7465 6e73 6f72  DictBase, tensor
+0004ccd0: 6469 6374 5f72 6573 6574 3a20 5465 6e73  dict_reset: Tens
+0004cce0: 6f72 4469 6374 4261 7365 0d0a 2020 2020  orDictBase..    
+0004ccf0: 2920 2d3e 2054 656e 736f 7244 6963 7442  ) -> TensorDictB
+0004cd00: 6173 653a 0d0a 2020 2020 2020 2020 2222  ase:..        ""
+0004cd10: 2252 6573 6574 7320 6120 7472 616e 7366  "Resets a transf
+0004cd20: 6f72 6d20 6966 2069 7420 6973 2073 7461  orm if it is sta
+0004cd30: 7465 6675 6c2e 2222 220d 0a20 2020 2020  teful."""..     
+0004cd40: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+0004cd50: 6361 6c6c 2874 656e 736f 7264 6963 745f  call(tensordict_
+0004cd60: 7265 7365 7429 0d0a 0d0a 2020 2020 666f  reset)....    fo
+0004cd70: 7277 6172 6420 3d20 5f63 616c 6c0d 0a0d  rward = _call...
+0004cd80: 0a0d 0a63 6c61 7373 205f 496e 7665 7274  ...class _Invert
+0004cd90: 5472 616e 7366 6f72 6d28 5472 616e 7366  Transform(Transf
+0004cda0: 6f72 6d29 3a0d 0a20 2020 205f 4d49 5353  orm):..    _MISS
+0004cdb0: 494e 475f 5452 414e 5346 4f52 4d5f 4552  ING_TRANSFORM_ER
+0004cdc0: 524f 5220 3d20 280d 0a20 2020 2020 2020  ROR = (..       
+0004cdd0: 2022 5468 6572 6520 6973 206e 6f74 2067   "There is not g
+0004cde0: 656e 6572 6963 2072 756c 6520 746f 2069  eneric rule to i
+0004cdf0: 6e76 6572 7420 6120 7370 6563 2074 7261  nvert a spec tra
+0004ce00: 6e73 666f 726d 2e20 220d 0a20 2020 2020  nsform. "..     
+0004ce10: 2020 2022 506c 6561 7365 2066 696c 6520     "Please file 
+0004ce20: 616e 2069 7373 7565 206f 6e20 6769 7468  an issue on gith
+0004ce30: 7562 2074 6f20 6765 7420 6865 6c70 2e22  ub to get help."
+0004ce40: 0d0a 2020 2020 290d 0a0d 0a20 2020 2064  ..    )....    d
+0004ce50: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+0004ce60: 2c20 7472 616e 7366 6f72 6d3a 2054 7261  , transform: Tra
+0004ce70: 6e73 666f 726d 293a 0d0a 2020 2020 2020  nsform):..      
+0004ce80: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+0004ce90: 5f5f 2829 0d0a 2020 2020 2020 2020 7365  __()..        se
+0004cea0: 6c66 2e74 7261 6e73 666f 726d 203d 2074  lf.transform = t
+0004ceb0: 7261 6e73 666f 726d 0d0a 0d0a 2020 2020  ransform....    
+0004cec0: 4070 726f 7065 7274 790d 0a20 2020 2064  @property..    d
+0004ced0: 6566 2069 6e5f 6b65 7973 2873 656c 6629  ef in_keys(self)
+0004cee0: 3a0d 0a20 2020 2020 2020 2072 6574 7572  :..        retur
+0004cef0: 6e20 7365 6c66 2e74 7261 6e73 666f 726d  n self.transform
+0004cf00: 2e69 6e5f 6b65 7973 5f69 6e76 0d0a 0d0a  .in_keys_inv....
+0004cf10: 2020 2020 4069 6e5f 6b65 7973 2e73 6574      @in_keys.set
+0004cf20: 7465 720d 0a20 2020 2064 6566 2069 6e5f  ter..    def in_
+0004cf30: 6b65 7973 2873 656c 662c 2076 616c 7565  keys(self, value
+0004cf40: 293a 0d0a 2020 2020 2020 2020 6966 2076  ):..        if v
+0004cf50: 616c 7565 2069 7320 6e6f 7420 4e6f 6e65  alue is not None
+0004cf60: 3a0d 0a20 2020 2020 2020 2020 2020 2072  :..            r
+0004cf70: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
+0004cf80: 7228 2243 616e 6e6f 7420 7365 7420 6e6f  r("Cannot set no
+0004cf90: 6e2d 6e75 6c6c 2076 616c 7565 2069 6e20  n-null value in 
+0004cfa0: 696e 5f6b 6579 732e 2229 0d0a 0d0a 2020  in_keys.")....  
+0004cfb0: 2020 4070 726f 7065 7274 790d 0a20 2020    @property..   
+0004cfc0: 2064 6566 2069 6e5f 6b65 7973 5f69 6e76   def in_keys_inv
+0004cfd0: 2873 656c 6629 3a0d 0a20 2020 2020 2020  (self):..       
+0004cfe0: 2072 6574 7572 6e20 7365 6c66 2e74 7261   return self.tra
+0004cff0: 6e73 666f 726d 2e69 6e5f 6b65 7973 0d0a  nsform.in_keys..
+0004d000: 0d0a 2020 2020 4069 6e5f 6b65 7973 5f69  ..    @in_keys_i
+0004d010: 6e76 2e73 6574 7465 720d 0a20 2020 2064  nv.setter..    d
+0004d020: 6566 2069 6e5f 6b65 7973 5f69 6e76 2873  ef in_keys_inv(s
+0004d030: 656c 662c 2076 616c 7565 293a 0d0a 2020  elf, value):..  
+0004d040: 2020 2020 2020 6966 2076 616c 7565 2069        if value i
+0004d050: 7320 6e6f 7420 4e6f 6e65 3a0d 0a20 2020  s not None:..   
+0004d060: 2020 2020 2020 2020 2072 6169 7365 2052           raise R
+0004d070: 756e 7469 6d65 4572 726f 7228 2243 616e  untimeError("Can
+0004d080: 6e6f 7420 7365 7420 6e6f 6e2d 6e75 6c6c  not set non-null
+0004d090: 2076 616c 7565 2069 6e20 696e 5f6b 6579   value in in_key
+0004d0a0: 735f 696e 762e 2229 0d0a 0d0a 2020 2020  s_inv.")....    
+0004d0b0: 4070 726f 7065 7274 790d 0a20 2020 2064  @property..    d
+0004d0c0: 6566 206f 7574 5f6b 6579 7328 7365 6c66  ef out_keys(self
+0004d0d0: 293a 0d0a 2020 2020 2020 2020 7265 7475  ):..        retu
+0004d0e0: 726e 2073 656c 662e 7472 616e 7366 6f72  rn self.transfor
+0004d0f0: 6d2e 6f75 745f 6b65 7973 5f69 6e76 0d0a  m.out_keys_inv..
+0004d100: 0d0a 2020 2020 406f 7574 5f6b 6579 732e  ..    @out_keys.
+0004d110: 7365 7474 6572 0d0a 2020 2020 6465 6620  setter..    def 
+0004d120: 6f75 745f 6b65 7973 2873 656c 662c 2076  out_keys(self, v
+0004d130: 616c 7565 293a 0d0a 2020 2020 2020 2020  alue):..        
+0004d140: 6966 2076 616c 7565 2069 7320 6e6f 7420  if value is not 
+0004d150: 4e6f 6e65 3a0d 0a20 2020 2020 2020 2020  None:..         
+0004d160: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
+0004d170: 4572 726f 7228 2243 616e 6e6f 7420 7365  Error("Cannot se
+0004d180: 7420 6e6f 6e2d 6e75 6c6c 2076 616c 7565  t non-null value
+0004d190: 2069 6e20 6f75 745f 6b65 7973 2e22 290d   in out_keys.").
+0004d1a0: 0a0d 0a20 2020 2040 7072 6f70 6572 7479  ...    @property
+0004d1b0: 0d0a 2020 2020 6465 6620 6f75 745f 6b65  ..    def out_ke
+0004d1c0: 7973 5f69 6e76 2873 656c 6629 3a0d 0a20  ys_inv(self):.. 
+0004d1d0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0004d1e0: 6c66 2e74 7261 6e73 666f 726d 2e6f 7574  lf.transform.out
+0004d1f0: 5f6b 6579 730d 0a0d 0a20 2020 2040 6f75  _keys....    @ou
+0004d200: 745f 6b65 7973 5f69 6e76 2e73 6574 7465  t_keys_inv.sette
+0004d210: 720d 0a20 2020 2064 6566 206f 7574 5f6b  r..    def out_k
+0004d220: 6579 735f 696e 7628 7365 6c66 2c20 7661  eys_inv(self, va
+0004d230: 6c75 6529 3a0d 0a20 2020 2020 2020 2069  lue):..        i
+0004d240: 6620 7661 6c75 6520 6973 206e 6f74 204e  f value is not N
+0004d250: 6f6e 653a 0d0a 2020 2020 2020 2020 2020  one:..          
+0004d260: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
+0004d270: 7272 6f72 2822 4361 6e6e 6f74 2073 6574  rror("Cannot set
+0004d280: 206e 6f6e 2d6e 756c 6c20 7661 6c75 6520   non-null value 
+0004d290: 696e 206f 7574 5f6b 6579 735f 696e 762e  in out_keys_inv.
+0004d2a0: 2229 0d0a 0d0a 2020 2020 6465 6620 666f  ")....    def fo
+0004d2b0: 7277 6172 6428 7365 6c66 2c20 7465 6e73  rward(self, tens
+0004d2c0: 6f72 6469 6374 3a20 5465 6e73 6f72 4469  ordict: TensorDi
+0004d2d0: 6374 4261 7365 2920 2d3e 2054 656e 736f  ctBase) -> Tenso
+0004d2e0: 7244 6963 7442 6173 653a 0d0a 2020 2020  rDictBase:..    
+0004d2f0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0004d300: 7472 616e 7366 6f72 6d2e 696e 7628 7465  transform.inv(te
+0004d310: 6e73 6f72 6469 6374 290d 0a0d 0a20 2020  nsordict)....   
+0004d320: 2064 6566 2069 6e76 2873 656c 662c 2074   def inv(self, t
+0004d330: 656e 736f 7264 6963 743a 2054 656e 736f  ensordict: Tenso
+0004d340: 7244 6963 7442 6173 6529 202d 3e20 5465  rDictBase) -> Te
+0004d350: 6e73 6f72 4469 6374 4261 7365 3a0d 0a20  nsorDictBase:.. 
+0004d360: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0004d370: 6c66 2e74 7261 6e73 666f 726d 2e66 6f72  lf.transform.for
+0004d380: 7761 7264 2874 656e 736f 7264 6963 7429  ward(tensordict)
+0004d390: 0d0a 0d0a 2020 2020 6465 6620 5f63 616c  ....    def _cal
+0004d3a0: 6c28 7365 6c66 2c20 7465 6e73 6f72 6469  l(self, tensordi
+0004d3b0: 6374 3a20 5465 6e73 6f72 4469 6374 4261  ct: TensorDictBa
+0004d3c0: 7365 2920 2d3e 2054 656e 736f 7244 6963  se) -> TensorDic
+0004d3d0: 7442 6173 653a 0d0a 2020 2020 2020 2020  tBase:..        
+0004d3e0: 7265 7475 726e 2073 656c 662e 7472 616e  return self.tran
+0004d3f0: 7366 6f72 6d2e 5f69 6e76 5f63 616c 6c28  sform._inv_call(
+0004d400: 7465 6e73 6f72 6469 6374 290d 0a0d 0a20  tensordict).... 
+0004d410: 2020 2064 6566 205f 696e 765f 6361 6c6c     def _inv_call
+0004d420: 2873 656c 662c 2074 656e 736f 7264 6963  (self, tensordic
+0004d430: 743a 2054 656e 736f 7244 6963 7442 6173  t: TensorDictBas
+0004d440: 6529 202d 3e20 5465 6e73 6f72 4469 6374  e) -> TensorDict
+0004d450: 4261 7365 3a0d 0a20 2020 2020 2020 2072  Base:..        r
+0004d460: 6574 7572 6e20 7365 6c66 2e74 7261 6e73  eturn self.trans
+0004d470: 666f 726d 2e5f 6361 6c6c 2874 656e 736f  form._call(tenso
+0004d480: 7264 6963 7429 0d0a 0d0a 2020 2020 6465  rdict)....    de
+0004d490: 6620 7472 616e 7366 6f72 6d5f 6f62 7365  f transform_obse
+0004d4a0: 7276 6174 696f 6e5f 7370 6563 2873 656c  rvation_spec(sel
+0004d4b0: 662c 206f 6273 6572 7661 7469 6f6e 5f73  f, observation_s
+0004d4c0: 7065 633a 2054 656e 736f 7253 7065 6329  pec: TensorSpec)
+0004d4d0: 202d 3e20 5465 6e73 6f72 5370 6563 3a0d   -> TensorSpec:.
+0004d4e0: 0a20 2020 2020 2020 2072 6169 7365 2052  .        raise R
+0004d4f0: 756e 7469 6d65 4572 726f 7228 7365 6c66  untimeError(self
+0004d500: 2e5f 4d49 5353 494e 475f 5452 414e 5346  ._MISSING_TRANSF
+0004d510: 4f52 4d5f 4552 524f 5229 0d0a 0d0a 2020  ORM_ERROR)....  
+0004d520: 2020 6465 6620 7472 616e 7366 6f72 6d5f    def transform_
+0004d530: 7374 6174 655f 7370 6563 2873 656c 662c  state_spec(self,
+0004d540: 2073 7461 7465 5f73 7065 633a 2054 656e   state_spec: Ten
+0004d550: 736f 7253 7065 6329 202d 3e20 5465 6e73  sorSpec) -> Tens
+0004d560: 6f72 5370 6563 3a0d 0a20 2020 2020 2020  orSpec:..       
+0004d570: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
+0004d580: 726f 7228 7365 6c66 2e5f 4d49 5353 494e  ror(self._MISSIN
+0004d590: 475f 5452 414e 5346 4f52 4d5f 4552 524f  G_TRANSFORM_ERRO
+0004d5a0: 5229 0d0a 0d0a 2020 2020 6465 6620 7472  R)....    def tr
+0004d5b0: 616e 7366 6f72 6d5f 7265 7761 7264 5f73  ansform_reward_s
+0004d5c0: 7065 6328 7365 6c66 2c20 7265 7761 7264  pec(self, reward
+0004d5d0: 5f73 7065 633a 2054 656e 736f 7253 7065  _spec: TensorSpe
+0004d5e0: 6329 202d 3e20 5465 6e73 6f72 5370 6563  c) -> TensorSpec
+0004d5f0: 3a0d 0a20 2020 2020 2020 2072 6169 7365  :..        raise
+0004d600: 2052 756e 7469 6d65 4572 726f 7228 7365   RuntimeError(se
+0004d610: 6c66 2e5f 4d49 5353 494e 475f 5452 414e  lf._MISSING_TRAN
+0004d620: 5346 4f52 4d5f 4552 524f 5229 0d0a 0d0a  SFORM_ERROR)....
+0004d630: 2020 2020 6465 6620 7472 616e 7366 6f72      def transfor
+0004d640: 6d5f 6163 7469 6f6e 5f73 7065 6328 7365  m_action_spec(se
+0004d650: 6c66 2c20 6163 7469 6f6e 5f73 7065 633a  lf, action_spec:
+0004d660: 2054 656e 736f 7253 7065 6329 202d 3e20   TensorSpec) -> 
+0004d670: 5465 6e73 6f72 5370 6563 3a0d 0a20 2020  TensorSpec:..   
+0004d680: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
+0004d690: 6d65 4572 726f 7228 7365 6c66 2e5f 4d49  meError(self._MI
+0004d6a0: 5353 494e 475f 5452 414e 5346 4f52 4d5f  SSING_TRANSFORM_
+0004d6b0: 4552 524f 5229 0d0a 0d0a 2020 2020 6465  ERROR)....    de
+0004d6c0: 6620 7472 616e 7366 6f72 6d5f 646f 6e65  f transform_done
+0004d6d0: 5f73 7065 6328 7365 6c66 2c20 646f 6e65  _spec(self, done
+0004d6e0: 5f73 7065 633a 2054 656e 736f 7253 7065  _spec: TensorSpe
+0004d6f0: 6329 202d 3e20 5465 6e73 6f72 5370 6563  c) -> TensorSpec
+0004d700: 3a0d 0a20 2020 2020 2020 2072 6169 7365  :..        raise
+0004d710: 2052 756e 7469 6d65 4572 726f 7228 7365   RuntimeError(se
+0004d720: 6c66 2e5f 4d49 5353 494e 475f 5452 414e  lf._MISSING_TRAN
+0004d730: 5346 4f52 4d5f 4552 524f 5229 0d0a 0d0a  SFORM_ERROR)....
+0004d740: 0d0a 636c 6173 7320 5f43 616c 6c61 626c  ..class _Callabl
+0004d750: 6554 7261 6e73 666f 726d 2854 7261 6e73  eTransform(Trans
+0004d760: 666f 726d 293a 0d0a 2020 2020 2320 4120  form):..    # A 
+0004d770: 7772 6170 7065 7220 6172 6f75 6e64 2061  wrapper around a
+0004d780: 2063 7573 746f 6d20 6361 6c6c 6162 6c65   custom callable
+0004d790: 2074 6f20 6d61 6b65 2069 7420 706f 7373   to make it poss
+0004d7a0: 6962 6c65 2074 6f20 7472 616e 7366 6f72  ible to transfor
+0004d7b0: 6d20 616e 7920 6461 7461 2074 7970 650d  m any data type.
+0004d7c0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+0004d7d0: 5f28 7365 6c66 2c20 6675 6e63 293a 0d0a  _(self, func):..
+0004d7e0: 2020 2020 2020 2020 7375 7065 7228 292e          super().
+0004d7f0: 5f5f 696e 6974 5f5f 2829 0d0a 2020 2020  __init__()..    
+0004d800: 2020 2020 7365 6c66 2e66 756e 6320 3d20      self.func = 
+0004d810: 6675 6e63 0d0a 0d0a 2020 2020 6465 6620  func....    def 
+0004d820: 666f 7277 6172 6428 7365 6c66 2c20 2a61  forward(self, *a
+0004d830: 7267 732c 202a 2a6b 7761 7267 7329 3a0d  rgs, **kwargs):.
+0004d840: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0004d850: 7365 6c66 2e66 756e 6328 2a61 7267 732c  self.func(*args,
+0004d860: 202a 2a6b 7761 7267 7329 0d0a 0d0a 2020   **kwargs)....  
+0004d870: 2020 6465 6620 5f63 616c 6c28 7365 6c66    def _call(self
+0004d880: 2c20 7465 6e73 6f72 6469 6374 3a20 5465  , tensordict: Te
+0004d890: 6e73 6f72 4469 6374 4261 7365 293a 0d0a  nsorDictBase):..
+0004d8a0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0004d8b0: 656c 662e 6675 6e63 2874 656e 736f 7264  elf.func(tensord
+0004d8c0: 6963 7429 0d0a 0d0a 2020 2020 6465 6620  ict)....    def 
+0004d8d0: 5f69 6e76 5f63 616c 6c28 7365 6c66 2c20  _inv_call(self, 
+0004d8e0: 7465 6e73 6f72 6469 6374 3a20 5465 6e73  tensordict: Tens
+0004d8f0: 6f72 4469 6374 4261 7365 2920 2d3e 2054  orDictBase) -> T
+0004d900: 656e 736f 7244 6963 7442 6173 653a 0d0a  ensorDictBase:..
+0004d910: 2020 2020 2020 2020 7265 7475 726e 2074          return t
+0004d920: 656e 736f 7264 6963 740d 0a0d 0a20 2020  ensordict....   
+0004d930: 2064 6566 205f 7265 7365 7428 0d0a 2020   def _reset(..  
+0004d940: 2020 2020 2020 7365 6c66 2c20 7465 6e73        self, tens
+0004d950: 6f72 6469 6374 3a20 5465 6e73 6f72 4469  ordict: TensorDi
+0004d960: 6374 4261 7365 2c20 7465 6e73 6f72 6469  ctBase, tensordi
+0004d970: 6374 5f72 6573 6574 3a20 5465 6e73 6f72  ct_reset: Tensor
+0004d980: 4469 6374 4261 7365 0d0a 2020 2020 2920  DictBase..    ) 
+0004d990: 2d3e 2054 656e 736f 7244 6963 7442 6173  -> TensorDictBas
+0004d9a0: 653a 0d0a 2020 2020 2020 2020 7265 7475  e:..        retu
+0004d9b0: 726e 2073 656c 662e 5f63 616c 6c28 7465  rn self._call(te
+0004d9c0: 6e73 6f72 6469 6374 5f72 6573 6574 290d  nsordict_reset).
+0004d9d0: 0a0d 0a0d 0a63 6c61 7373 2042 6174 6368  .....class Batch
+0004d9e0: 5369 7a65 5472 616e 7366 6f72 6d28 5472  SizeTransform(Tr
+0004d9f0: 616e 7366 6f72 6d29 3a0d 0a20 2020 2022  ansform):..    "
+0004da00: 2222 4120 7472 616e 7366 6f72 6d20 746f  ""A transform to
+0004da10: 206d 6f64 6966 7920 7468 6520 6261 7463   modify the batc
+0004da20: 682d 7369 7a65 206f 6620 616e 2065 6e76  h-size of an env
+0004da30: 6972 6f6e 6d74 2e0d 0a0d 0a20 2020 2054  ironmt.....    T
+0004da40: 6869 7320 7472 616e 7366 6f72 6d20 6861  his transform ha
+0004da50: 7320 7477 6f20 6469 7374 696e 6374 2075  s two distinct u
+0004da60: 7361 6765 733a 2069 7420 6361 6e20 6265  sages: it can be
+0004da70: 2075 7365 6420 746f 2073 6574 2074 6865   used to set the
+0004da80: 0d0a 2020 2020 6261 7463 682d 7369 7a65  ..    batch-size
+0004da90: 2066 6f72 206e 6f6e 2d62 6174 6368 2d6c   for non-batch-l
+0004daa0: 6f63 6b65 6420 2865 2e67 2e20 7374 6174  ocked (e.g. stat
+0004dab0: 656c 6573 7329 2065 6e76 6972 6f6e 6d65  eless) environme
+0004dac0: 6e74 7320 746f 0d0a 2020 2020 656e 6162  nts to..    enab
+0004dad0: 6c65 2064 6174 6120 636f 6c6c 6563 7469  le data collecti
+0004dae0: 6f6e 2075 7369 6e67 2064 6174 6120 636f  on using data co
+0004daf0: 6c6c 6563 746f 7273 2e20 4974 2063 616e  llectors. It can
+0004db00: 2061 6c73 6f20 6265 2075 7365 640d 0a20   also be used.. 
+0004db10: 2020 2074 6f20 6d6f 6469 6679 2074 6865     to modify the
+0004db20: 2062 6174 6368 2d73 697a 6520 6f66 2061   batch-size of a
+0004db30: 6e20 656e 7669 726f 6e6d 656e 7420 2865  n environment (e
+0004db40: 2e67 2e20 7371 7565 657a 652c 2075 6e73  .g. squeeze, uns
+0004db50: 7175 6565 7a65 206f 720d 0a20 2020 2072  queeze or..    r
+0004db60: 6573 6861 7065 292e 0d0a 0d0a 2020 2020  eshape).....    
+0004db70: 5468 6973 2074 7261 6e73 666f 726d 206d  This transform m
+0004db80: 6f64 6966 6965 7320 7468 6520 656e 7669  odifies the envi
+0004db90: 726f 6e6d 656e 7420 6261 7463 682d 7369  ronment batch-si
+0004dba0: 7a65 2074 6f20 6d61 7463 6820 7468 6520  ze to match the 
+0004dbb0: 6f6e 6520 7072 6f76 6964 6564 2e0d 0a20  one provided... 
+0004dbc0: 2020 2049 7420 6578 7065 6374 7320 7468     It expects th
+0004dbd0: 6520 7061 7265 6e74 2065 6e76 6972 6f6e  e parent environ
+0004dbe0: 6d65 6e74 2062 6174 6368 2d73 697a 6520  ment batch-size 
+0004dbf0: 746f 2062 6520 6578 7061 6e64 6162 6c65  to be expandable
+0004dc00: 2074 6f20 7468 650d 0a20 2020 2070 726f   to the..    pro
+0004dc10: 7669 6465 6420 6f6e 652e 0d0a 0d0a 2020  vided one.....  
+0004dc20: 2020 4b65 7977 6f72 6420 4172 6773 3a0d    Keyword Args:.
+0004dc30: 0a20 2020 2020 2020 2062 6174 6368 5f73  .        batch_s
+0004dc40: 697a 6520 2874 6f72 6368 2e53 697a 6520  ize (torch.Size 
+0004dc50: 6f72 2065 7175 6976 616c 656e 742c 206f  or equivalent, o
+0004dc60: 7074 696f 6e61 6c29 3a20 7468 6520 6e65  ptional): the ne
+0004dc70: 7720 6261 7463 682d 7369 7a65 206f 6620  w batch-size of 
+0004dc80: 7468 6520 656e 7669 726f 6e6d 656e 742e  the environment.
+0004dc90: 0d0a 2020 2020 2020 2020 2020 2020 4578  ..            Ex
+0004dca0: 636c 7573 6976 6520 7769 7468 2060 6072  clusive with ``r
+0004dcb0: 6573 6861 7065 5f66 6e60 602e 0d0a 2020  eshape_fn``...  
+0004dcc0: 2020 2020 2020 7265 7368 6170 655f 666e        reshape_fn
+0004dcd0: 2028 6361 6c6c 6162 6c65 2c20 6f70 7469   (callable, opti
+0004dce0: 6f6e 616c 293a 2061 2063 616c 6c61 626c  onal): a callabl
+0004dcf0: 6520 746f 206d 6f64 6966 7920 7468 6520  e to modify the 
+0004dd00: 656e 7669 726f 6e6d 656e 7420 6261 7463  environment batc
+0004dd10: 682d 7369 7a65 2e0d 0a20 2020 2020 2020  h-size...       
+0004dd20: 2020 2020 2045 7863 6c75 7369 7665 2077       Exclusive w
+0004dd30: 6974 6820 6060 6261 7463 685f 7369 7a65  ith ``batch_size
+0004dd40: 6060 2e0d 0a0d 0a20 2020 2020 2020 2020  ``.....         
+0004dd50: 2020 202e 2e20 6e6f 7465 3a3a 2043 7572     .. note:: Cur
+0004dd60: 7265 6e74 6c79 2c20 7472 616e 7366 6f72  rently, transfor
+0004dd70: 6d61 7469 6f6e 7320 696e 766f 6c76 696e  mations involvin
+0004dd80: 670d 0a20 2020 2020 2020 2020 2020 2020  g..             
+0004dd90: 2020 2060 6072 6573 6861 7065 6060 2c20     ``reshape``, 
+0004dda0: 6060 666c 6174 7465 6e60 602c 2060 6075  ``flatten``, ``u
+0004ddb0: 6e66 6c61 7474 656e 6060 2c20 6060 7371  nflatten``, ``sq
+0004ddc0: 7565 657a 6560 6020 616e 6420 6060 756e  ueeze`` and ``un
+0004ddd0: 7371 7565 657a 6560 600d 0a20 2020 2020  squeeze``..     
+0004dde0: 2020 2020 2020 2020 2020 2061 7265 2073             are s
+0004ddf0: 7570 706f 7274 6564 2e20 4966 2061 6e6f  upported. If ano
+0004de00: 7468 6572 2072 6573 6861 7065 206f 7065  ther reshape ope
+0004de10: 7261 7469 6f6e 2069 7320 7265 7175 6972  ration is requir
+0004de20: 6564 2c20 706c 6561 7365 2073 7562 6d69  ed, please submi
+0004de30: 740d 0a20 2020 2020 2020 2020 2020 2020  t..             
+0004de40: 2020 2061 2066 6561 7475 7265 2072 6571     a feature req
+0004de50: 7565 7374 206f 6e20 546f 7263 6852 4c20  uest on TorchRL 
+0004de60: 6769 7468 7562 2e0d 0a0d 0a20 2020 2020  github.....     
+0004de70: 2020 2072 6573 6574 5f66 756e 6320 2863     reset_func (c
+0004de80: 616c 6c61 626c 652c 206f 7074 696f 6e61  allable, optiona
+0004de90: 6c29 3a20 6120 6675 6e63 7469 6f6e 2074  l): a function t
+0004dea0: 6861 7420 7072 6f64 7563 6573 2061 2072  hat produces a r
+0004deb0: 6573 6574 2074 656e 736f 7264 6963 742e  eset tensordict.
+0004dec0: 0d0a 2020 2020 2020 2020 2020 2020 5468  ..            Th
+0004ded0: 6520 7369 676e 6174 7572 6520 6d75 7374  e signature must
+0004dee0: 206d 6174 6368 2060 6043 616c 6c61 626c   match ``Callabl
+0004def0: 655b 5b54 656e 736f 7244 6963 7442 6173  e[[TensorDictBas
+0004df00: 652c 2054 656e 736f 7244 6963 7442 6173  e, TensorDictBas
+0004df10: 655d 2c20 5465 6e73 6f72 4469 6374 4261  e], TensorDictBa
+0004df20: 7365 5d60 600d 0a20 2020 2020 2020 2020  se]``..         
+0004df30: 2020 2077 6865 7265 2074 6865 2066 6972     where the fir
+0004df40: 7374 2069 6e70 7574 2061 7267 756d 656e  st input argumen
+0004df50: 7420 6973 2074 6865 206f 7074 696f 6e61  t is the optiona
+0004df60: 6c20 7465 6e73 6f72 6469 6374 2070 6173  l tensordict pas
+0004df70: 7365 6420 746f 2074 6865 0d0a 2020 2020  sed to the..    
+0004df80: 2020 2020 2020 2020 656e 7669 726f 6e6d          environm
+0004df90: 656e 7420 6475 7269 6e67 2074 6865 2063  ent during the c
+0004dfa0: 616c 6c20 746f 203a 6d65 7468 3a60 7e45  all to :meth:`~E
+0004dfb0: 6e76 4261 7365 2e72 6573 6574 6020 616e  nvBase.reset` an
+0004dfc0: 6420 7468 6520 7365 636f 6e64 0d0a 2020  d the second..  
+0004dfd0: 2020 2020 2020 2020 2020 6973 2074 6865            is the
+0004dfe0: 206f 7574 7075 7420 6f66 2060 6054 7261   output of ``Tra
+0004dff0: 6e73 666f 726d 6564 456e 762e 6261 7365  nsformedEnv.base
+0004e000: 5f65 6e76 2e72 6573 6574 6060 2e20 4974  _env.reset``. It
+0004e010: 2063 616e 2061 6c73 6f20 7375 7070 6f72   can also suppor
+0004e020: 7420 616e 0d0a 2020 2020 2020 2020 2020  t an..          
+0004e030: 2020 6f70 7469 6f6e 616c 2060 6065 6e76    optional ``env
+0004e040: 6060 206b 6579 776f 7264 2061 7267 756d  `` keyword argum
+0004e050: 656e 7420 6966 2060 6065 6e76 5f6b 7761  ent if ``env_kwa
+0004e060: 7267 3d54 7275 6560 602e 0d0a 2020 2020  rg=True``...    
+0004e070: 2020 2020 656e 765f 6b77 6172 6720 2862      env_kwarg (b
+0004e080: 6f6f 6c2c 206f 7074 696f 6e61 6c29 3a20  ool, optional): 
+0004e090: 6966 2060 6054 7275 6560 602c 2060 6072  if ``True``, ``r
+0004e0a0: 6573 6574 5f66 756e 6360 6020 6d75 7374  eset_func`` must
+0004e0b0: 2073 7570 706f 7274 2061 0d0a 2020 2020   support a..    
+0004e0c0: 2020 2020 2020 2020 6060 656e 7660 6020          ``env`` 
+0004e0d0: 6b65 7977 6f72 6420 6172 6775 6d65 6e74  keyword argument
+0004e0e0: 2e20 4465 6661 756c 7473 2074 6f20 6060  . Defaults to ``
+0004e0f0: 4661 6c73 6560 602e 2054 6865 2065 6e76  False``. The env
+0004e100: 2070 6173 7365 6420 7769 6c6c 0d0a 2020   passed will..  
+0004e110: 2020 2020 2020 2020 2020 6265 2074 6865            be the
+0004e120: 2065 6e76 2061 6363 6f6d 7061 6e69 6564   env accompanied
+0004e130: 2062 7920 6974 7320 7472 616e 7366 6f72   by its transfor
+0004e140: 6d2e 0d0a 0d0a 2020 2020 4578 616d 706c  m.....    Exampl
+0004e150: 653a 0d0a 2020 2020 2020 2020 3e3e 3e20  e:..        >>> 
+0004e160: 2320 4368 616e 6769 6e67 2074 6865 2062  # Changing the b
+0004e170: 6174 6368 2d73 697a 6520 7769 7468 2061  atch-size with a
+0004e180: 2066 756e 6374 696f 6e0d 0a20 2020 2020   function..     
+0004e190: 2020 203e 3e3e 2066 726f 6d20 746f 7263     >>> from torc
+0004e1a0: 6872 6c2e 656e 7673 2069 6d70 6f72 7420  hrl.envs import 
+0004e1b0: 4779 6d45 6e76 0d0a 2020 2020 2020 2020  GymEnv..        
+0004e1c0: 3e3e 3e20 6261 7365 5f65 6e76 203d 2047  >>> base_env = G
+0004e1d0: 796d 456e 7628 2243 6172 7450 6f6c 652d  ymEnv("CartPole-
+0004e1e0: 7631 2229 0d0a 2020 2020 2020 2020 3e3e  v1")..        >>
+0004e1f0: 3e20 656e 7620 3d20 5472 616e 7366 6f72  > env = Transfor
+0004e200: 6d65 6445 6e76 2862 6173 655f 656e 762c  medEnv(base_env,
+0004e210: 2042 6174 6368 5369 7a65 5472 616e 7366   BatchSizeTransf
+0004e220: 6f72 6d28 7265 7368 6170 655f 666e 3d6c  orm(reshape_fn=l
+0004e230: 616d 6264 6120 6461 7461 3a20 6461 7461  ambda data: data
+0004e240: 2e72 6573 6861 7065 2831 2c20 3129 2929  .reshape(1, 1)))
+0004e250: 0d0a 2020 2020 2020 2020 3e3e 3e20 656e  ..        >>> en
+0004e260: 762e 726f 6c6c 6f75 7428 3429 0d0a 2020  v.rollout(4)..  
+0004e270: 2020 2020 2020 3e3e 3e20 2320 5365 7474        >>> # Sett
+0004e280: 696e 6720 7468 6520 7368 6170 6520 6f66  ing the shape of
+0004e290: 2061 2073 7461 7465 6c65 7373 2065 6e76   a stateless env
+0004e2a0: 6972 6f6e 6d65 6e74 0d0a 2020 2020 2020  ironment..      
+0004e2b0: 2020 3e3e 3e20 636c 6173 7320 4d79 456e    >>> class MyEn
+0004e2c0: 7628 456e 7642 6173 6529 3a0d 0a20 2020  v(EnvBase):..   
+0004e2d0: 2020 2020 202e 2e2e 2020 2020 2062 6174       ...     bat
+0004e2e0: 6368 5f6c 6f63 6b65 6420 3d20 4661 6c73  ch_locked = Fals
+0004e2f0: 650d 0a20 2020 2020 2020 202e 2e2e 2020  e..        ...  
+0004e300: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+0004e310: 7365 6c66 293a 0d0a 2020 2020 2020 2020  self):..        
+0004e320: 2e2e 2e20 2020 2020 2020 2020 7375 7065  ...         supe
+0004e330: 7228 292e 5f5f 696e 6974 5f5f 2829 0d0a  r().__init__()..
+0004e340: 2020 2020 2020 2020 2e2e 2e20 2020 2020          ...     
+0004e350: 2020 2020 7365 6c66 2e6f 6273 6572 7661      self.observa
+0004e360: 7469 6f6e 5f73 7065 6320 3d20 436f 6d70  tion_spec = Comp
+0004e370: 6f73 6974 6553 7065 6328 6f62 7365 7276  ositeSpec(observ
+0004e380: 6174 696f 6e3d 556e 626f 756e 6465 6443  ation=UnboundedC
+0004e390: 6f6e 7469 6e75 6f75 7354 656e 736f 7253  ontinuousTensorS
+0004e3a0: 7065 6328 3329 290d 0a20 2020 2020 2020  pec(3))..       
+0004e3b0: 202e 2e2e 2020 2020 2020 2020 2073 656c   ...         sel
+0004e3c0: 662e 7265 7761 7264 5f73 7065 6320 3d20  f.reward_spec = 
+0004e3d0: 556e 626f 756e 6465 6443 6f6e 7469 6e75  UnboundedContinu
+0004e3e0: 6f75 7354 656e 736f 7253 7065 6328 3129  ousTensorSpec(1)
+0004e3f0: 0d0a 2020 2020 2020 2020 2e2e 2e20 2020  ..        ...   
+0004e400: 2020 2020 2020 7365 6c66 2e61 6374 696f        self.actio
+0004e410: 6e5f 7370 6563 203d 2055 6e62 6f75 6e64  n_spec = Unbound
+0004e420: 6564 436f 6e74 696e 756f 7573 5465 6e73  edContinuousTens
+0004e430: 6f72 5370 6563 2831 290d 0a20 2020 2020  orSpec(1)..     
+0004e440: 2020 202e 2e2e 0d0a 2020 2020 2020 2020     .....        
+0004e450: 2e2e 2e20 2020 2020 6465 6620 5f72 6573  ...     def _res
+0004e460: 6574 2873 656c 662c 2074 656e 736f 7264  et(self, tensord
+0004e470: 6963 743a 2054 656e 736f 7244 6963 7442  ict: TensorDictB
+0004e480: 6173 652c 202a 2a6b 7761 7267 7329 202d  ase, **kwargs) -
+0004e490: 3e20 5465 6e73 6f72 4469 6374 4261 7365  > TensorDictBase
+0004e4a0: 3a0d 0a20 2020 2020 2020 202e 2e2e 2020  :..        ...  
+0004e4b0: 2020 2020 2020 2074 656e 736f 7264 6963         tensordic
+0004e4c0: 745f 6261 7463 685f 7369 7a65 203d 2074  t_batch_size = t
+0004e4d0: 656e 736f 7264 6963 742e 6261 7463 685f  ensordict.batch_
+0004e4e0: 7369 7a65 2069 6620 7465 6e73 6f72 6469  size if tensordi
+0004e4f0: 6374 2069 7320 6e6f 7420 4e6f 6e65 2065  ct is not None e
+0004e500: 6c73 6520 746f 7263 682e 5369 7a65 285b  lse torch.Size([
+0004e510: 5d29 0d0a 2020 2020 2020 2020 2e2e 2e20  ])..        ... 
+0004e520: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+0004e530: 2073 656c 662e 6f62 7365 7276 6174 696f   self.observatio
+0004e540: 6e5f 7370 6563 2e72 616e 6428 7465 6e73  n_spec.rand(tens
+0004e550: 6f72 6469 6374 5f62 6174 6368 5f73 697a  ordict_batch_siz
+0004e560: 6529 0d0a 2020 2020 2020 2020 2e2e 2e20  e)..        ... 
+0004e570: 2020 2020 2020 2020 7265 7375 6c74 2e75          result.u
+0004e580: 7064 6174 6528 7365 6c66 2e66 756c 6c5f  pdate(self.full_
+0004e590: 646f 6e65 5f73 7065 632e 7a65 726f 2874  done_spec.zero(t
+0004e5a0: 656e 736f 7264 6963 745f 6261 7463 685f  ensordict_batch_
+0004e5b0: 7369 7a65 2929 0d0a 2020 2020 2020 2020  size))..        
+0004e5c0: 2e2e 2e20 2020 2020 2020 2020 7265 7475  ...         retu
+0004e5d0: 726e 2072 6573 756c 740d 0a20 2020 2020  rn result..     
+0004e5e0: 2020 202e 2e2e 0d0a 2020 2020 2020 2020     .....        
+0004e5f0: 2e2e 2e20 2020 2020 6465 6620 5f73 7465  ...     def _ste
+0004e600: 7028 0d0a 2020 2020 2020 2020 2e2e 2e20  p(..        ... 
+0004e610: 2020 2020 2020 2020 7365 6c66 2c0d 0a20          self,.. 
+0004e620: 2020 2020 2020 202e 2e2e 2020 2020 2020         ...      
+0004e630: 2020 2074 656e 736f 7264 6963 743a 2054     tensordict: T
+0004e640: 656e 736f 7244 6963 7442 6173 652c 0d0a  ensorDictBase,..
+0004e650: 2020 2020 2020 2020 2e2e 2e20 2020 2020          ...     
+0004e660: 2920 2d3e 2054 656e 736f 7244 6963 7442  ) -> TensorDictB
+0004e670: 6173 653a 0d0a 2020 2020 2020 2020 2e2e  ase:..        ..
+0004e680: 2e20 2020 2020 2020 2020 7265 7375 6c74  .         result
+0004e690: 203d 2073 656c 662e 6f62 7365 7276 6174   = self.observat
+0004e6a0: 696f 6e5f 7370 6563 2e72 616e 6428 7465  ion_spec.rand(te
+0004e6b0: 6e73 6f72 6469 6374 2e62 6174 6368 5f73  nsordict.batch_s
+0004e6c0: 697a 6529 0d0a 2020 2020 2020 2020 2e2e  ize)..        ..
+0004e6d0: 2e20 2020 2020 2020 2020 7265 7375 6c74  .         result
+0004e6e0: 2e75 7064 6174 6528 7365 6c66 2e66 756c  .update(self.ful
+0004e6f0: 6c5f 646f 6e65 5f73 7065 632e 7a65 726f  l_done_spec.zero
+0004e700: 2874 656e 736f 7264 6963 742e 6261 7463  (tensordict.batc
+0004e710: 685f 7369 7a65 2929 0d0a 2020 2020 2020  h_size))..      
+0004e720: 2020 2e2e 2e20 2020 2020 2020 2020 7265    ...         re
+0004e730: 7375 6c74 2e75 7064 6174 6528 7365 6c66  sult.update(self
+0004e740: 2e66 756c 6c5f 7265 7761 7264 5f73 7065  .full_reward_spe
+0004e750: 632e 7a65 726f 2874 656e 736f 7264 6963  c.zero(tensordic
+0004e760: 742e 6261 7463 685f 7369 7a65 2929 0d0a  t.batch_size))..
+0004e770: 2020 2020 2020 2020 2e2e 2e20 2020 2020          ...     
+0004e780: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+0004e790: 740d 0a20 2020 2020 2020 202e 2e2e 0d0a  t..        .....
+0004e7a0: 2020 2020 2020 2020 2e2e 2e20 2020 2020          ...     
+0004e7b0: 6465 6620 5f73 6574 5f73 6565 6428 7365  def _set_seed(se
+0004e7c0: 6c66 2c20 7365 6564 3a20 4f70 7469 6f6e  lf, seed: Option
+0004e7d0: 616c 5b69 6e74 5d29 3a0d 0a20 2020 2020  al[int]):..     
+0004e7e0: 2020 202e 2e2e 2020 2020 2020 2020 2070     ...         p
+0004e7f0: 6173 730d 0a20 2020 2020 2020 202e 2e2e  ass..        ...
+0004e800: 0d0a 2020 2020 2020 2020 3e3e 3e20 656e  ..        >>> en
+0004e810: 7620 3d20 5472 616e 7366 6f72 6d65 6445  v = TransformedE
+0004e820: 6e76 284d 7945 6e76 2829 2c20 4261 7463  nv(MyEnv(), Batc
+0004e830: 6853 697a 6554 7261 6e73 666f 726d 285b  hSizeTransform([
+0004e840: 355d 2929 0d0a 2020 2020 2020 2020 3e3e  5]))..        >>
+0004e850: 3e20 6173 7365 7274 2065 6e76 2e62 6174  > assert env.bat
+0004e860: 6368 5f73 697a 6520 3d3d 2074 6f72 6368  ch_size == torch
+0004e870: 2e53 697a 6528 5b35 5d29 0d0a 2020 2020  .Size([5])..    
+0004e880: 2020 2020 3e3e 3e20 6173 7365 7274 2065      >>> assert e
+0004e890: 6e76 2e72 6f6c 6c6f 7574 2831 3029 2e73  nv.rollout(10).s
+0004e8a0: 6861 7065 203d 3d20 746f 7263 682e 5369  hape == torch.Si
+0004e8b0: 7a65 285b 352c 2031 305d 290d 0a0d 0a20  ze([5, 10]).... 
+0004e8c0: 2020 2054 6865 2060 6072 6573 6574 5f66     The ``reset_f
+0004e8d0: 756e 6360 6020 6361 6e20 6372 6561 7465  unc`` can create
+0004e8e0: 2061 2074 656e 736f 7264 6963 7420 7769   a tensordict wi
+0004e8f0: 7468 2074 6865 2064 6573 6972 6564 2062  th the desired b
+0004e900: 6174 6368 2d73 697a 652c 2061 6c6c 6f77  atch-size, allow
+0004e910: 696e 6720 666f 720d 0a20 2020 2061 2066  ing for..    a f
+0004e920: 696e 652d 6772 6169 6e65 6420 7265 7365  ine-grained rese
+0004e930: 7420 6361 6c6c 3a0d 0a0d 0a20 2020 2020  t call:....     
+0004e940: 2020 203e 3e3e 2064 6566 2072 6573 6574     >>> def reset
+0004e950: 5f66 756e 6328 7465 6e73 6f72 6469 6374  _func(tensordict
+0004e960: 2c20 7465 6e73 6f72 6469 6374 5f72 6573  , tensordict_res
+0004e970: 6574 2c20 656e 7629 3a0d 0a20 2020 2020  et, env):..     
+0004e980: 2020 202e 2e2e 2020 2020 2072 6573 756c     ...     resul
+0004e990: 7420 3d20 656e 762e 6f62 7365 7276 6174  t = env.observat
+0004e9a0: 696f 6e5f 7370 6563 2e72 616e 6428 290d  ion_spec.rand().
+0004e9b0: 0a20 2020 2020 2020 202e 2e2e 2020 2020  .        ...    
+0004e9c0: 2072 6573 756c 742e 7570 6461 7465 2865   result.update(e
+0004e9d0: 6e76 2e66 756c 6c5f 646f 6e65 5f73 7065  nv.full_done_spe
+0004e9e0: 632e 7a65 726f 2829 290d 0a20 2020 2020  c.zero())..     
+0004e9f0: 2020 202e 2e2e 2020 2020 2061 7373 6572     ...     asser
+0004ea00: 7420 7265 7375 6c74 2e62 6174 6368 5f73  t result.batch_s
+0004ea10: 697a 6520 213d 2074 6f72 6368 2e53 697a  ize != torch.Siz
+0004ea20: 6528 5b5d 290d 0a20 2020 2020 2020 202e  e([])..        .
+0004ea30: 2e2e 2020 2020 2072 6574 7572 6e20 7265  ..     return re
+0004ea40: 7375 6c74 0d0a 2020 2020 2020 2020 3e3e  sult..        >>
+0004ea50: 3e20 656e 7620 3d20 5472 616e 7366 6f72  > env = Transfor
+0004ea60: 6d65 6445 6e76 284d 7945 6e76 2829 2c20  medEnv(MyEnv(), 
+0004ea70: 4261 7463 6853 697a 6554 7261 6e73 666f  BatchSizeTransfo
+0004ea80: 726d 285b 355d 2c20 7265 7365 745f 6675  rm([5], reset_fu
+0004ea90: 6e63 3d72 6573 6574 5f66 756e 632c 2065  nc=reset_func, e
+0004eaa0: 6e76 5f6b 7761 7267 3d54 7275 6529 290d  nv_kwarg=True)).
+0004eab0: 0a20 2020 2020 2020 203e 3e3e 2070 7269  .        >>> pri
+0004eac0: 6e74 2865 6e76 2e72 6f6c 6c6f 7574 2832  nt(env.rollout(2
+0004ead0: 2929 0d0a 2020 2020 2020 2020 5465 6e73  ))..        Tens
+0004eae0: 6f72 4469 6374 280d 0a20 2020 2020 2020  orDict(..       
+0004eaf0: 2020 2020 2066 6965 6c64 733d 7b0d 0a20       fields={.. 
+0004eb00: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0004eb10: 6374 696f 6e3a 2054 656e 736f 7228 7368  ction: Tensor(sh
+0004eb20: 6170 653d 746f 7263 682e 5369 7a65 285b  ape=torch.Size([
+0004eb30: 352c 2032 2c20 315d 292c 2064 6576 6963  5, 2, 1]), devic
+0004eb40: 653d 6370 752c 2064 7479 7065 3d74 6f72  e=cpu, dtype=tor
+0004eb50: 6368 2e66 6c6f 6174 3332 2c20 6973 5f73  ch.float32, is_s
+0004eb60: 6861 7265 643d 4661 6c73 6529 2c0d 0a20  hared=False),.. 
+0004eb70: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0004eb80: 6f6e 653a 2054 656e 736f 7228 7368 6170  one: Tensor(shap
+0004eb90: 653d 746f 7263 682e 5369 7a65 285b 352c  e=torch.Size([5,
+0004eba0: 2032 2c20 315d 292c 2064 6576 6963 653d   2, 1]), device=
+0004ebb0: 6370 752c 2064 7479 7065 3d74 6f72 6368  cpu, dtype=torch
+0004ebc0: 2e62 6f6f 6c2c 2069 735f 7368 6172 6564  .bool, is_shared
+0004ebd0: 3d46 616c 7365 292c 0d0a 2020 2020 2020  =False),..      
+0004ebe0: 2020 2020 2020 2020 2020 6e65 7874 3a20            next: 
+0004ebf0: 5465 6e73 6f72 4469 6374 280d 0a20 2020  TensorDict(..   
+0004ec00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ec10: 2066 6965 6c64 733d 7b0d 0a20 2020 2020   fields={..     
+0004ec20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ec30: 2020 2064 6f6e 653a 2054 656e 736f 7228     done: Tensor(
+0004ec40: 7368 6170 653d 746f 7263 682e 5369 7a65  shape=torch.Size
+0004ec50: 285b 352c 2032 2c20 315d 292c 2064 6576  ([5, 2, 1]), dev
+0004ec60: 6963 653d 6370 752c 2064 7479 7065 3d74  ice=cpu, dtype=t
+0004ec70: 6f72 6368 2e62 6f6f 6c2c 2069 735f 7368  orch.bool, is_sh
+0004ec80: 6172 6564 3d46 616c 7365 292c 0d0a 2020  ared=False),..  
+0004ec90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004eca0: 2020 2020 2020 6f62 7365 7276 6174 696f        observatio
+0004ecb0: 6e3a 2054 656e 736f 7228 7368 6170 653d  n: Tensor(shape=
+0004ecc0: 746f 7263 682e 5369 7a65 285b 352c 2032  torch.Size([5, 2
+0004ecd0: 2c20 335d 292c 2064 6576 6963 653d 6370  , 3]), device=cp
+0004ece0: 752c 2064 7479 7065 3d74 6f72 6368 2e66  u, dtype=torch.f
+0004ecf0: 6c6f 6174 3332 2c20 6973 5f73 6861 7265  loat32, is_share
+0004ed00: 643d 4661 6c73 6529 2c0d 0a20 2020 2020  d=False),..     
+0004ed10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ed20: 2020 2072 6577 6172 643a 2054 656e 736f     reward: Tenso
+0004ed30: 7228 7368 6170 653d 746f 7263 682e 5369  r(shape=torch.Si
+0004ed40: 7a65 285b 352c 2032 2c20 315d 292c 2064  ze([5, 2, 1]), d
+0004ed50: 6576 6963 653d 6370 752c 2064 7479 7065  evice=cpu, dtype
+0004ed60: 3d74 6f72 6368 2e66 6c6f 6174 3332 2c20  =torch.float32, 
+0004ed70: 6973 5f73 6861 7265 643d 4661 6c73 6529  is_shared=False)
+0004ed80: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+0004ed90: 2020 2020 2020 2020 2020 2074 6572 6d69             termi
+0004eda0: 6e61 7465 643a 2054 656e 736f 7228 7368  nated: Tensor(sh
+0004edb0: 6170 653d 746f 7263 682e 5369 7a65 285b  ape=torch.Size([
+0004edc0: 352c 2032 2c20 315d 292c 2064 6576 6963  5, 2, 1]), devic
+0004edd0: 653d 6370 752c 2064 7479 7065 3d74 6f72  e=cpu, dtype=tor
+0004ede0: 6368 2e62 6f6f 6c2c 2069 735f 7368 6172  ch.bool, is_shar
+0004edf0: 6564 3d46 616c 7365 297d 2c0d 0a20 2020  ed=False)},..   
+0004ee00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ee10: 2062 6174 6368 5f73 697a 653d 746f 7263   batch_size=torc
+0004ee20: 682e 5369 7a65 285b 352c 2032 5d29 2c0d  h.Size([5, 2]),.
+0004ee30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004ee40: 2020 2020 2064 6576 6963 653d 4e6f 6e65       device=None
+0004ee50: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+0004ee60: 2020 2020 2020 2069 735f 7368 6172 6564         is_shared
+0004ee70: 3d46 616c 7365 292c 0d0a 2020 2020 2020  =False),..      
+0004ee80: 2020 2020 2020 2020 2020 6f62 7365 7276            observ
+0004ee90: 6174 696f 6e3a 2054 656e 736f 7228 7368  ation: Tensor(sh
+0004eea0: 6170 653d 746f 7263 682e 5369 7a65 285b  ape=torch.Size([
+0004eeb0: 352c 2032 2c20 335d 292c 2064 6576 6963  5, 2, 3]), devic
+0004eec0: 653d 6370 752c 2064 7479 7065 3d74 6f72  e=cpu, dtype=tor
+0004eed0: 6368 2e66 6c6f 6174 3332 2c20 6973 5f73  ch.float32, is_s
+0004eee0: 6861 7265 643d 4661 6c73 6529 2c0d 0a20  hared=False),.. 
+0004eef0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0004ef00: 6572 6d69 6e61 7465 643a 2054 656e 736f  erminated: Tenso
+0004ef10: 7228 7368 6170 653d 746f 7263 682e 5369  r(shape=torch.Si
+0004ef20: 7a65 285b 352c 2032 2c20 315d 292c 2064  ze([5, 2, 1]), d
+0004ef30: 6576 6963 653d 6370 752c 2064 7479 7065  evice=cpu, dtype
+0004ef40: 3d74 6f72 6368 2e62 6f6f 6c2c 2069 735f  =torch.bool, is_
+0004ef50: 7368 6172 6564 3d46 616c 7365 297d 2c0d  shared=False)},.
+0004ef60: 0a20 2020 2020 2020 2020 2020 2062 6174  .            bat
+0004ef70: 6368 5f73 697a 653d 746f 7263 682e 5369  ch_size=torch.Si
+0004ef80: 7a65 285b 352c 2032 5d29 2c0d 0a20 2020  ze([5, 2]),..   
+0004ef90: 2020 2020 2020 2020 2064 6576 6963 653d           device=
+0004efa0: 4e6f 6e65 2c0d 0a20 2020 2020 2020 2020  None,..         
+0004efb0: 2020 2069 735f 7368 6172 6564 3d46 616c     is_shared=Fal
+0004efc0: 7365 290d 0a0d 0a20 2020 2054 6869 7320  se)....    This 
+0004efd0: 7472 616e 7366 6f72 6d20 6361 6e20 6265  transform can be
+0004efe0: 2075 7365 6420 746f 2064 6570 6c6f 7920   used to deploy 
+0004eff0: 6e6f 6e2d 6261 7463 682d 6c6f 636b 6564  non-batch-locked
+0004f000: 2065 6e76 6972 6f6e 6d65 6e74 7320 7769   environments wi
+0004f010: 7468 696e 2064 6174 610d 0a20 2020 2063  thin data..    c
+0004f020: 6f6c 6c65 6374 6f72 733a 0d0a 0d0a 2020  ollectors:....  
+0004f030: 2020 2020 2020 3e3e 3e20 6672 6f6d 2074        >>> from t
+0004f040: 6f72 6368 726c 2e63 6f6c 6c65 6374 6f72  orchrl.collector
+0004f050: 7320 696d 706f 7274 2053 796e 6344 6174  s import SyncDat
+0004f060: 6143 6f6c 6c65 6374 6f72 0d0a 2020 2020  aCollector..    
+0004f070: 2020 2020 3e3e 3e20 636f 6c6c 6563 746f      >>> collecto
+0004f080: 7220 3d20 5379 6e63 4461 7461 436f 6c6c  r = SyncDataColl
+0004f090: 6563 746f 7228 656e 762c 206c 616d 6264  ector(env, lambd
+0004f0a0: 6120 7464 3a20 656e 762e 7261 6e64 5f61  a td: env.rand_a
+0004f0b0: 6374 696f 6e28 7464 292c 2066 7261 6d65  ction(td), frame
+0004f0c0: 735f 7065 725f 6261 7463 683d 3130 2c20  s_per_batch=10, 
+0004f0d0: 746f 7461 6c5f 6672 616d 6573 3d2d 3129  total_frames=-1)
+0004f0e0: 0d0a 2020 2020 2020 2020 3e3e 3e20 666f  ..        >>> fo
+0004f0f0: 7220 6461 7461 2069 6e20 636f 6c6c 6563  r data in collec
+0004f100: 746f 723a 0d0a 2020 2020 2020 2020 2e2e  tor:..        ..
+0004f110: 2e20 2020 2020 7072 696e 7428 6461 7461  .     print(data
+0004f120: 290d 0a20 2020 2020 2020 202e 2e2e 2020  )..        ...  
+0004f130: 2020 2062 7265 616b 0d0a 2020 2020 2020     break..      
+0004f140: 2020 5465 6e73 6f72 4469 6374 280d 0a20    TensorDict(.. 
+0004f150: 2020 2020 2020 2020 2020 2066 6965 6c64             field
+0004f160: 733d 7b0d 0a20 2020 2020 2020 2020 2020  s={..           
+0004f170: 2020 2020 2061 6374 696f 6e3a 2054 656e       action: Ten
+0004f180: 736f 7228 7368 6170 653d 746f 7263 682e  sor(shape=torch.
+0004f190: 5369 7a65 285b 352c 2032 2c20 315d 292c  Size([5, 2, 1]),
+0004f1a0: 2064 6576 6963 653d 6370 752c 2064 7479   device=cpu, dty
+0004f1b0: 7065 3d74 6f72 6368 2e66 6c6f 6174 3332  pe=torch.float32
+0004f1c0: 2c20 6973 5f73 6861 7265 643d 4661 6c73  , is_shared=Fals
+0004f1d0: 6529 2c0d 0a20 2020 2020 2020 2020 2020  e),..           
+0004f1e0: 2020 2020 2063 6f6c 6c65 6374 6f72 3a20       collector: 
+0004f1f0: 5465 6e73 6f72 4469 6374 280d 0a20 2020  TensorDict(..   
+0004f200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f210: 2066 6965 6c64 733d 7b0d 0a20 2020 2020   fields={..     
+0004f220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f230: 2020 2074 7261 6a5f 6964 733a 2054 656e     traj_ids: Ten
+0004f240: 736f 7228 7368 6170 653d 746f 7263 682e  sor(shape=torch.
+0004f250: 5369 7a65 285b 352c 2032 5d29 2c20 6465  Size([5, 2]), de
+0004f260: 7669 6365 3d63 7075 2c20 6474 7970 653d  vice=cpu, dtype=
+0004f270: 746f 7263 682e 696e 7436 342c 2069 735f  torch.int64, is_
+0004f280: 7368 6172 6564 3d46 616c 7365 297d 2c0d  shared=False)},.
+0004f290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004f2a0: 2020 2020 2062 6174 6368 5f73 697a 653d       batch_size=
+0004f2b0: 746f 7263 682e 5369 7a65 285b 352c 2032  torch.Size([5, 2
+0004f2c0: 5d29 2c0d 0a20 2020 2020 2020 2020 2020  ]),..           
+0004f2d0: 2020 2020 2020 2020 2064 6576 6963 653d           device=
+0004f2e0: 4e6f 6e65 2c0d 0a20 2020 2020 2020 2020  None,..         
+0004f2f0: 2020 2020 2020 2020 2020 2069 735f 7368             is_sh
+0004f300: 6172 6564 3d46 616c 7365 292c 0d0a 2020  ared=False),..  
+0004f310: 2020 2020 2020 2020 2020 2020 2020 646f                do
+0004f320: 6e65 3a20 5465 6e73 6f72 2873 6861 7065  ne: Tensor(shape
+0004f330: 3d74 6f72 6368 2e53 697a 6528 5b35 2c20  =torch.Size([5, 
+0004f340: 322c 2031 5d29 2c20 6465 7669 6365 3d63  2, 1]), device=c
+0004f350: 7075 2c20 6474 7970 653d 746f 7263 682e  pu, dtype=torch.
+0004f360: 626f 6f6c 2c20 6973 5f73 6861 7265 643d  bool, is_shared=
+0004f370: 4661 6c73 6529 2c0d 0a20 2020 2020 2020  False),..       
+0004f380: 2020 2020 2020 2020 206e 6578 743a 2054           next: T
+0004f390: 656e 736f 7244 6963 7428 0d0a 2020 2020  ensorDict(..    
+0004f3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f3b0: 6669 656c 6473 3d7b 0d0a 2020 2020 2020  fields={..      
+0004f3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f3d0: 2020 646f 6e65 3a20 5465 6e73 6f72 2873    done: Tensor(s
+0004f3e0: 6861 7065 3d74 6f72 6368 2e53 697a 6528  hape=torch.Size(
+0004f3f0: 5b35 2c20 322c 2031 5d29 2c20 6465 7669  [5, 2, 1]), devi
+0004f400: 6365 3d63 7075 2c20 6474 7970 653d 746f  ce=cpu, dtype=to
+0004f410: 7263 682e 626f 6f6c 2c20 6973 5f73 6861  rch.bool, is_sha
+0004f420: 7265 643d 4661 6c73 6529 2c0d 0a20 2020  red=False),..   
+0004f430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f440: 2020 2020 206f 6273 6572 7661 7469 6f6e       observation
+0004f450: 3a20 5465 6e73 6f72 2873 6861 7065 3d74  : Tensor(shape=t
+0004f460: 6f72 6368 2e53 697a 6528 5b35 2c20 322c  orch.Size([5, 2,
+0004f470: 2033 5d29 2c20 6465 7669 6365 3d63 7075   3]), device=cpu
+0004f480: 2c20 6474 7970 653d 746f 7263 682e 666c  , dtype=torch.fl
+0004f490: 6f61 7433 322c 2069 735f 7368 6172 6564  oat32, is_shared
+0004f4a0: 3d46 616c 7365 292c 0d0a 2020 2020 2020  =False),..      
+0004f4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f4c0: 2020 7265 7761 7264 3a20 5465 6e73 6f72    reward: Tensor
+0004f4d0: 2873 6861 7065 3d74 6f72 6368 2e53 697a  (shape=torch.Siz
+0004f4e0: 6528 5b35 2c20 322c 2031 5d29 2c20 6465  e([5, 2, 1]), de
+0004f4f0: 7669 6365 3d63 7075 2c20 6474 7970 653d  vice=cpu, dtype=
+0004f500: 746f 7263 682e 666c 6f61 7433 322c 2069  torch.float32, i
+0004f510: 735f 7368 6172 6564 3d46 616c 7365 292c  s_shared=False),
+0004f520: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0004f530: 2020 2020 2020 2020 2020 7465 726d 696e            termin
+0004f540: 6174 6564 3a20 5465 6e73 6f72 2873 6861  ated: Tensor(sha
+0004f550: 7065 3d74 6f72 6368 2e53 697a 6528 5b35  pe=torch.Size([5
+0004f560: 2c20 322c 2031 5d29 2c20 6465 7669 6365  , 2, 1]), device
+0004f570: 3d63 7075 2c20 6474 7970 653d 746f 7263  =cpu, dtype=torc
+0004f580: 682e 626f 6f6c 2c20 6973 5f73 6861 7265  h.bool, is_share
+0004f590: 643d 4661 6c73 6529 7d2c 0d0a 2020 2020  d=False)},..    
+0004f5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f5b0: 6261 7463 685f 7369 7a65 3d74 6f72 6368  batch_size=torch
+0004f5c0: 2e53 697a 6528 5b35 2c20 325d 292c 0d0a  .Size([5, 2]),..
+0004f5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f5e0: 2020 2020 6465 7669 6365 3d4e 6f6e 652c      device=None,
+0004f5f0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0004f600: 2020 2020 2020 6973 5f73 6861 7265 643d        is_shared=
+0004f610: 4661 6c73 6529 2c0d 0a20 2020 2020 2020  False),..       
+0004f620: 2020 2020 2020 2020 206f 6273 6572 7661           observa
+0004f630: 7469 6f6e 3a20 5465 6e73 6f72 2873 6861  tion: Tensor(sha
+0004f640: 7065 3d74 6f72 6368 2e53 697a 6528 5b35  pe=torch.Size([5
+0004f650: 2c20 322c 2033 5d29 2c20 6465 7669 6365  , 2, 3]), device
+0004f660: 3d63 7075 2c20 6474 7970 653d 746f 7263  =cpu, dtype=torc
+0004f670: 682e 666c 6f61 7433 322c 2069 735f 7368  h.float32, is_sh
+0004f680: 6172 6564 3d46 616c 7365 292c 0d0a 2020  ared=False),..  
+0004f690: 2020 2020 2020 2020 2020 2020 2020 7465                te
+0004f6a0: 726d 696e 6174 6564 3a20 5465 6e73 6f72  rminated: Tensor
+0004f6b0: 2873 6861 7065 3d74 6f72 6368 2e53 697a  (shape=torch.Siz
+0004f6c0: 6528 5b35 2c20 322c 2031 5d29 2c20 6465  e([5, 2, 1]), de
+0004f6d0: 7669 6365 3d63 7075 2c20 6474 7970 653d  vice=cpu, dtype=
+0004f6e0: 746f 7263 682e 626f 6f6c 2c20 6973 5f73  torch.bool, is_s
+0004f6f0: 6861 7265 643d 4661 6c73 6529 7d2c 0d0a  hared=False)},..
+0004f700: 2020 2020 2020 2020 2020 2020 6261 7463              batc
+0004f710: 685f 7369 7a65 3d74 6f72 6368 2e53 697a  h_size=torch.Siz
+0004f720: 6528 5b35 2c20 325d 292c 0d0a 2020 2020  e([5, 2]),..    
+0004f730: 2020 2020 2020 2020 6465 7669 6365 3d4e          device=N
+0004f740: 6f6e 652c 0d0a 2020 2020 2020 2020 2020  one,..          
+0004f750: 2020 6973 5f73 6861 7265 643d 4661 6c73    is_shared=Fals
+0004f760: 6529 0d0a 2020 2020 2020 2020 3e3e 3e20  e)..        >>> 
+0004f770: 636f 6c6c 6563 746f 722e 7368 7574 646f  collector.shutdo
+0004f780: 776e 2829 0d0a 2020 2020 2222 220d 0a0d  wn()..    """...
+0004f790: 0a20 2020 205f 454e 565f 4552 5220 3d20  .    _ENV_ERR = 
+0004f7a0: 2242 6174 6368 5369 7a65 5472 616e 7366  "BatchSizeTransf
+0004f7b0: 6f72 6d2e 7b7d 2072 6571 7569 7265 7320  orm.{} requires 
+0004f7c0: 6120 7061 7265 6e74 2065 6e76 2e22 0d0a  a parent env."..
+0004f7d0: 0d0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+0004f7e0: 5f5f 280d 0a20 2020 2020 2020 2073 656c  __(..        sel
+0004f7f0: 662c 0d0a 2020 2020 2020 2020 2a2c 0d0a  f,..        *,..
+0004f800: 2020 2020 2020 2020 6261 7463 685f 7369          batch_si
+0004f810: 7a65 3a20 746f 7263 682e 5369 7a65 207c  ze: torch.Size |
+0004f820: 204e 6f6e 6520 3d20 4e6f 6e65 2c0d 0a20   None = None,.. 
+0004f830: 2020 2020 2020 2072 6573 6861 7065 5f66         reshape_f
+0004f840: 6e3a 2043 616c 6c61 626c 655b 5b54 656e  n: Callable[[Ten
+0004f850: 736f 7244 6963 7442 6173 655d 2c20 5465  sorDictBase], Te
+0004f860: 6e73 6f72 4469 6374 4261 7365 5d20 7c20  nsorDictBase] | 
+0004f870: 4e6f 6e65 203d 204e 6f6e 652c 0d0a 2020  None = None,..  
+0004f880: 2020 2020 2020 7265 7365 745f 6675 6e63        reset_func
+0004f890: 3a20 4361 6c6c 6162 6c65 5b5b 5465 6e73  : Callable[[Tens
+0004f8a0: 6f72 4469 6374 4261 7365 2c20 5465 6e73  orDictBase, Tens
+0004f8b0: 6f72 4469 6374 4261 7365 5d2c 2054 656e  orDictBase], Ten
+0004f8c0: 736f 7244 6963 7442 6173 655d 0d0a 2020  sorDictBase]..  
+0004f8d0: 2020 2020 2020 7c20 4e6f 6e65 203d 204e        | None = N
+0004f8e0: 6f6e 652c 0d0a 2020 2020 2020 2020 656e  one,..        en
+0004f8f0: 765f 6b77 6172 673a 2062 6f6f 6c20 3d20  v_kwarg: bool = 
+0004f900: 4661 6c73 652c 0d0a 2020 2020 293a 0d0a  False,..    ):..
+0004f910: 2020 2020 2020 2020 7375 7065 7228 292e          super().
+0004f920: 5f5f 696e 6974 5f5f 2829 0d0a 2020 2020  __init__()..    
+0004f930: 2020 2020 6966 206e 6f74 2028 2862 6174      if not ((bat
+0004f940: 6368 5f73 697a 6520 6973 204e 6f6e 6529  ch_size is None)
+0004f950: 205e 2028 7265 7368 6170 655f 666e 2069   ^ (reshape_fn i
+0004f960: 7320 4e6f 6e65 2929 3a0d 0a20 2020 2020  s None)):..     
+0004f970: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+0004f980: 7565 4572 726f 7228 0d0a 2020 2020 2020  ueError(..      
+0004f990: 2020 2020 2020 2020 2020 224f 6e65 2061            "One a
+0004f9a0: 6e64 206f 6e6c 7920 6f6e 6520 6f66 2062  nd only one of b
+0004f9b0: 6174 6368 5f73 697a 6520 4f52 2072 6573  atch_size OR res
+0004f9c0: 6861 7065 5f66 6e20 6d75 7374 2062 6520  hape_fn must be 
+0004f9d0: 7072 6f76 6964 6564 2e22 0d0a 2020 2020  provided."..    
+0004f9e0: 2020 2020 2020 2020 290d 0a20 2020 2020          )..     
+0004f9f0: 2020 2069 6620 6261 7463 685f 7369 7a65     if batch_size
+0004fa00: 2069 7320 6e6f 7420 4e6f 6e65 3a0d 0a20   is not None:.. 
+0004fa10: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0004fa20: 6261 7463 685f 7369 7a65 203d 2074 6f72  batch_size = tor
+0004fa30: 6368 2e53 697a 6528 6261 7463 685f 7369  ch.Size(batch_si
+0004fa40: 7a65 290d 0a20 2020 2020 2020 2020 2020  ze)..           
+0004fa50: 2073 656c 662e 7265 7368 6170 655f 666e   self.reshape_fn
+0004fa60: 203d 204e 6f6e 650d 0a20 2020 2020 2020   = None..       
+0004fa70: 2065 6c73 653a 0d0a 2020 2020 2020 2020   else:..        
+0004fa80: 2020 2020 7365 6c66 2e72 6573 6861 7065      self.reshape
+0004fa90: 5f66 6e20 3d20 7265 7368 6170 655f 666e  _fn = reshape_fn
+0004faa0: 0d0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+0004fab0: 6c66 2e62 6174 6368 5f73 697a 6520 3d20  lf.batch_size = 
+0004fac0: 4e6f 6e65 0d0a 2020 2020 2020 2020 7365  None..        se
+0004fad0: 6c66 2e72 6573 6861 7065 5f66 6e20 3d20  lf.reshape_fn = 
+0004fae0: 7265 7368 6170 655f 666e 0d0a 2020 2020  reshape_fn..    
+0004faf0: 2020 2020 7365 6c66 2e72 6573 6574 5f66      self.reset_f
+0004fb00: 756e 6320 3d20 7265 7365 745f 6675 6e63  unc = reset_func
+0004fb10: 0d0a 2020 2020 2020 2020 7365 6c66 2e65  ..        self.e
+0004fb20: 6e76 5f6b 7761 7267 203d 2065 6e76 5f6b  nv_kwarg = env_k
+0004fb30: 7761 7267 0d0a 0d0a 2020 2020 6465 6620  warg....    def 
+0004fb40: 5f72 6573 6574 280d 0a20 2020 2020 2020  _reset(..       
+0004fb50: 2073 656c 662c 2074 656e 736f 7264 6963   self, tensordic
+0004fb60: 743a 2054 656e 736f 7244 6963 7442 6173  t: TensorDictBas
+0004fb70: 652c 2074 656e 736f 7264 6963 745f 7265  e, tensordict_re
+0004fb80: 7365 743a 2054 656e 736f 7244 6963 7442  set: TensorDictB
+0004fb90: 6173 650d 0a20 2020 2029 202d 3e20 5465  ase..    ) -> Te
+0004fba0: 6e73 6f72 4469 6374 4261 7365 3a0d 0a20  nsorDictBase:.. 
+0004fbb0: 2020 2020 2020 2069 6620 7365 6c66 2e72         if self.r
+0004fbc0: 6573 6574 5f66 756e 6320 6973 206e 6f74  eset_func is not
+0004fbd0: 204e 6f6e 653a 0d0a 2020 2020 2020 2020   None:..        
+0004fbe0: 2020 2020 6966 2073 656c 662e 656e 765f      if self.env_
+0004fbf0: 6b77 6172 673a 0d0a 2020 2020 2020 2020  kwarg:..        
+0004fc00: 2020 2020 2020 2020 7465 6e73 6f72 6469          tensordi
+0004fc10: 6374 5f72 6573 6574 203d 2073 656c 662e  ct_reset = self.
+0004fc20: 7265 7365 745f 6675 6e63 280d 0a20 2020  reset_func(..   
+0004fc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004fc40: 2074 656e 736f 7264 6963 742c 2074 656e   tensordict, ten
+0004fc50: 736f 7264 6963 745f 7265 7365 742c 2065  sordict_reset, e
+0004fc60: 6e76 3d73 656c 662e 636f 6e74 6169 6e65  nv=self.containe
+0004fc70: 720d 0a20 2020 2020 2020 2020 2020 2020  r..             
+0004fc80: 2020 2029 0d0a 2020 2020 2020 2020 2020     )..          
+0004fc90: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
+0004fca0: 2020 2020 2020 2020 2074 656e 736f 7264           tensord
+0004fcb0: 6963 745f 7265 7365 7420 3d20 7365 6c66  ict_reset = self
+0004fcc0: 2e72 6573 6574 5f66 756e 6328 7465 6e73  .reset_func(tens
+0004fcd0: 6f72 6469 6374 2c20 7465 6e73 6f72 6469  ordict, tensordi
+0004fce0: 6374 5f72 6573 6574 290d 0a20 2020 2020  ct_reset)..     
+0004fcf0: 2020 2069 6620 7365 6c66 2e62 6174 6368     if self.batch
+0004fd00: 5f73 697a 6520 6973 206e 6f74 204e 6f6e  _size is not Non
+0004fd10: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+0004fd20: 7265 7475 726e 2074 656e 736f 7264 6963  return tensordic
+0004fd30: 745f 7265 7365 742e 6578 7061 6e64 2873  t_reset.expand(s
+0004fd40: 656c 662e 6261 7463 685f 7369 7a65 290d  elf.batch_size).
+0004fd50: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0004fd60: 7365 6c66 2e72 6573 6861 7065 5f66 6e28  self.reshape_fn(
+0004fd70: 7465 6e73 6f72 6469 6374 5f72 6573 6574  tensordict_reset
+0004fd80: 290d 0a0d 0a20 2020 2064 6566 205f 6361  )....    def _ca
+0004fd90: 6c6c 2873 656c 662c 2074 656e 736f 7264  ll(self, tensord
+0004fda0: 6963 743a 2054 656e 736f 7244 6963 7442  ict: TensorDictB
+0004fdb0: 6173 6529 202d 3e20 5465 6e73 6f72 4469  ase) -> TensorDi
+0004fdc0: 6374 4261 7365 3a0d 0a20 2020 2020 2020  ctBase:..       
+0004fdd0: 2069 6620 7365 6c66 2e72 6573 6861 7065   if self.reshape
+0004fde0: 5f66 6e20 6973 206e 6f74 204e 6f6e 653a  _fn is not None:
+0004fdf0: 0d0a 2020 2020 2020 2020 2020 2020 7465  ..            te
+0004fe00: 6e73 6f72 6469 6374 203d 2073 656c 662e  nsordict = self.
+0004fe10: 7265 7368 6170 655f 666e 2874 656e 736f  reshape_fn(tenso
+0004fe20: 7264 6963 7429 0d0a 2020 2020 2020 2020  rdict)..        
+0004fe30: 7265 7475 726e 2074 656e 736f 7264 6963  return tensordic
+0004fe40: 740d 0a0d 0a20 2020 2066 6f72 7761 7264  t....    forward
+0004fe50: 203d 205f 6361 6c6c 0d0a 0d0a 2020 2020   = _call....    
+0004fe60: 6465 6620 5f69 6e76 5f63 616c 6c28 7365  def _inv_call(se
+0004fe70: 6c66 2c20 7465 6e73 6f72 6469 6374 3a20  lf, tensordict: 
+0004fe80: 5465 6e73 6f72 4469 6374 4261 7365 2920  TensorDictBase) 
+0004fe90: 2d3e 2054 656e 736f 7244 6963 7442 6173  -> TensorDictBas
+0004fea0: 653a 0d0a 2020 2020 2020 2020 6966 2073  e:..        if s
+0004feb0: 656c 662e 7265 7368 6170 655f 666e 2069  elf.reshape_fn i
+0004fec0: 7320 6e6f 7420 4e6f 6e65 3a0d 0a20 2020  s not None:..   
+0004fed0: 2020 2020 2020 2020 2070 6172 656e 7420           parent 
+0004fee0: 3d20 7365 6c66 2e70 6172 656e 740d 0a20  = self.parent.. 
+0004fef0: 2020 2020 2020 2020 2020 2069 6620 7061             if pa
+0004ff00: 7265 6e74 2069 7320 6e6f 7420 4e6f 6e65  rent is not None
+0004ff10: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+0004ff20: 2020 2070 6172 656e 745f 6261 7463 685f     parent_batch_
+0004ff30: 7369 7a65 203d 2070 6172 656e 742e 6261  size = parent.ba
+0004ff40: 7463 685f 7369 7a65 0d0a 2020 2020 2020  tch_size..      
+0004ff50: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
+0004ff60: 6469 6374 203d 2074 656e 736f 7264 6963  dict = tensordic
+0004ff70: 742e 7265 7368 6170 6528 7061 7265 6e74  t.reshape(parent
+0004ff80: 5f62 6174 6368 5f73 697a 6529 0d0a 2020  _batch_size)..  
+0004ff90: 2020 2020 2020 7265 7475 726e 2074 656e        return ten
+0004ffa0: 736f 7264 6963 740d 0a0d 0a20 2020 2064  sordict....    d
+0004ffb0: 6566 2074 7261 6e73 666f 726d 5f65 6e76  ef transform_env
+0004ffc0: 5f62 6174 6368 5f73 697a 6528 7365 6c66  _batch_size(self
+0004ffd0: 2c20 6261 7463 685f 7369 7a65 3a20 746f  , batch_size: to
+0004ffe0: 7263 682e 5369 7a65 293a 0d0a 2020 2020  rch.Size):..    
+0004fff0: 2020 2020 6966 2073 656c 662e 6261 7463      if self.batc
+00050000: 685f 7369 7a65 2069 7320 6e6f 7420 4e6f  h_size is not No
+00050010: 6e65 3a0d 0a20 2020 2020 2020 2020 2020  ne:..           
+00050020: 2072 6574 7572 6e20 7365 6c66 2e62 6174   return self.bat
+00050030: 6368 5f73 697a 650d 0a20 2020 2020 2020  ch_size..       
+00050040: 2072 6574 7572 6e20 7365 6c66 2e72 6573   return self.res
+00050050: 6861 7065 5f66 6e28 746f 7263 682e 7a65  hape_fn(torch.ze
+00050060: 726f 7328 6261 7463 685f 7369 7a65 2c20  ros(batch_size, 
+00050070: 6465 7669 6365 3d22 6d65 7461 2229 292e  device="meta")).
+00050080: 7368 6170 650d 0a0d 0a20 2020 2064 6566  shape....    def
+00050090: 2074 7261 6e73 666f 726d 5f6f 7574 7075   transform_outpu
+000500a0: 745f 7370 6563 2873 656c 662c 206f 7574  t_spec(self, out
+000500b0: 7075 745f 7370 6563 3a20 436f 6d70 6f73  put_spec: Compos
+000500c0: 6974 6553 7065 6329 202d 3e20 436f 6d70  iteSpec) -> Comp
+000500d0: 6f73 6974 6553 7065 633a 0d0a 2020 2020  ositeSpec:..    
+000500e0: 2020 2020 6966 2073 656c 662e 6261 7463      if self.batc
+000500f0: 685f 7369 7a65 2069 7320 6e6f 7420 4e6f  h_size is not No
+00050100: 6e65 3a0d 0a20 2020 2020 2020 2020 2020  ne:..           
+00050110: 2072 6574 7572 6e20 6f75 7470 7574 5f73   return output_s
+00050120: 7065 632e 6578 7061 6e64 2873 656c 662e  pec.expand(self.
+00050130: 6261 7463 685f 7369 7a65 290d 0a20 2020  batch_size)..   
+00050140: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00050150: 2e72 6573 6861 7065 5f66 6e28 6f75 7470  .reshape_fn(outp
+00050160: 7574 5f73 7065 6329 0d0a 0d0a 2020 2020  ut_spec)....    
+00050170: 6465 6620 7472 616e 7366 6f72 6d5f 696e  def transform_in
+00050180: 7075 745f 7370 6563 2873 656c 662c 2069  put_spec(self, i
+00050190: 6e70 7574 5f73 7065 633a 2043 6f6d 706f  nput_spec: Compo
+000501a0: 7369 7465 5370 6563 2920 2d3e 2043 6f6d  siteSpec) -> Com
+000501b0: 706f 7369 7465 5370 6563 3a0d 0a20 2020  positeSpec:..   
+000501c0: 2020 2020 2069 6620 7365 6c66 2e62 6174       if self.bat
+000501d0: 6368 5f73 697a 6520 6973 206e 6f74 204e  ch_size is not N
+000501e0: 6f6e 653a 0d0a 2020 2020 2020 2020 2020  one:..          
+000501f0: 2020 7265 7475 726e 2069 6e70 7574 5f73    return input_s
+00050200: 7065 632e 6578 7061 6e64 2873 656c 662e  pec.expand(self.
+00050210: 6261 7463 685f 7369 7a65 290d 0a20 2020  batch_size)..   
+00050220: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00050230: 2e72 6573 6861 7065 5f66 6e28 696e 7075  .reshape_fn(inpu
+00050240: 745f 7370 6563 290d 0a0d 0a0d 0a63 6c61  t_spec)......cla
+00050250: 7373 2041 7574 6f52 6573 6574 456e 7628  ss AutoResetEnv(
+00050260: 5472 616e 7366 6f72 6d65 6445 6e76 293a  TransformedEnv):
+00050270: 0d0a 2020 2020 2222 2241 2073 7562 636c  ..    """A subcl
+00050280: 6173 7320 666f 7220 6175 746f 2d72 6573  ass for auto-res
+00050290: 6574 7469 6e67 2065 6e76 732e 2222 220d  etting envs.""".
+000502a0: 0a0d 0a20 2020 2064 6566 205f 7265 7365  ...    def _rese
+000502b0: 7428 7365 6c66 2c20 7465 6e73 6f72 6469  t(self, tensordi
+000502c0: 6374 3a20 4f70 7469 6f6e 616c 5b54 656e  ct: Optional[Ten
+000502d0: 736f 7244 6963 7442 6173 655d 203d 204e  sorDictBase] = N
+000502e0: 6f6e 652c 202a 2a6b 7761 7267 7329 3a0d  one, **kwargs):.
+000502f0: 0a20 2020 2020 2020 2069 6620 7465 6e73  .        if tens
+00050300: 6f72 6469 6374 2069 7320 6e6f 7420 4e6f  ordict is not No
+00050310: 6e65 3a0d 0a20 2020 2020 2020 2020 2020  ne:..           
+00050320: 2023 2057 6520 6d75 7374 2061 766f 6964   # We must avoid
+00050330: 206d 6f64 6966 7969 6e67 2074 6865 206f   modifying the o
+00050340: 7269 6769 6e61 6c20 7465 6e73 6f72 6469  riginal tensordi
+00050350: 6374 2073 6f20 6120 7368 616c 6c6f 7720  ct so a shallow 
+00050360: 636f 7079 2069 7320 6e65 6365 7373 6172  copy is necessar
+00050370: 792e 0d0a 2020 2020 2020 2020 2020 2020  y...            
+00050380: 2320 5765 206a 7573 7420 7365 6c65 6374  # We just select
+00050390: 2074 6865 2069 6e70 7574 2064 6174 6120   the input data 
+000503a0: 616e 6420 7265 7365 7420 7369 676e 616c  and reset signal
+000503b0: 2c20 7768 6963 6820 6973 2061 6c6c 2077  , which is all w
+000503c0: 6520 6e65 6564 2e0d 0a20 2020 2020 2020  e need...       
+000503d0: 2020 2020 2074 656e 736f 7264 6963 7420       tensordict 
+000503e0: 3d20 7465 6e73 6f72 6469 6374 2e73 656c  = tensordict.sel
+000503f0: 6563 7428 0d0a 2020 2020 2020 2020 2020  ect(..          
+00050400: 2020 2020 2020 2a73 656c 662e 7265 7365        *self.rese
+00050410: 745f 6b65 7973 2c20 2a73 656c 662e 7374  t_keys, *self.st
+00050420: 6174 655f 7370 6563 2e6b 6579 7328 5472  ate_spec.keys(Tr
+00050430: 7565 2c20 5472 7565 292c 2073 7472 6963  ue, True), stric
+00050440: 743d 4661 6c73 650d 0a20 2020 2020 2020  t=False..       
+00050450: 2020 2020 2029 0d0a 2020 2020 2020 2020       )..        
+00050460: 666f 7220 7265 7365 745f 6b65 7920 696e  for reset_key in
+00050470: 2073 656c 662e 6261 7365 5f65 6e76 2e72   self.base_env.r
+00050480: 6573 6574 5f6b 6579 733a 0d0a 2020 2020  eset_keys:..    
+00050490: 2020 2020 2020 2020 6966 2074 656e 736f          if tenso
+000504a0: 7264 6963 7420 6973 206e 6f74 204e 6f6e  rdict is not Non
+000504b0: 6520 616e 6420 7265 7365 745f 6b65 7920  e and reset_key 
+000504c0: 696e 2074 656e 736f 7264 6963 742e 6b65  in tensordict.ke
+000504d0: 7973 2854 7275 6529 3a0d 0a20 2020 2020  ys(True):..     
+000504e0: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
+000504f0: 7264 6963 745f 7265 7365 7420 3d20 7465  rdict_reset = te
+00050500: 6e73 6f72 6469 6374 2e65 7863 6c75 6465  nsordict.exclude
+00050510: 282a 7365 6c66 2e62 6173 655f 656e 762e  (*self.base_env.
+00050520: 7265 7365 745f 6b65 7973 290d 0a20 2020  reset_keys)..   
+00050530: 2020 2020 2020 2020 2065 6c73 653a 0d0a           else:..
+00050540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050550: 7465 6e73 6f72 6469 6374 5f72 6573 6574  tensordict_reset
+00050560: 203d 2073 656c 662e 6261 7365 5f65 6e76   = self.base_env
+00050570: 2e5f 7265 7365 7428 7465 6e73 6f72 6469  ._reset(tensordi
+00050580: 6374 2c20 2a2a 6b77 6172 6773 290d 0a20  ct, **kwargs).. 
+00050590: 2020 2020 2020 2020 2020 2062 7265 616b             break
+000505a0: 0d0a 2020 2020 2020 2020 6966 2074 656e  ..        if ten
+000505b0: 736f 7264 6963 7420 6973 204e 6f6e 653a  sordict is None:
+000505c0: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+000505d0: 6d61 6b65 2073 7572 6520 616c 6c20 7472  make sure all tr
+000505e0: 616e 7366 6f72 6d73 2073 6565 2061 2073  ansforms see a s
+000505f0: 6f75 7263 6520 7465 6e73 6f72 6469 6374  ource tensordict
+00050600: 0d0a 2020 2020 2020 2020 2020 2020 7465  ..            te
+00050610: 6e73 6f72 6469 6374 203d 2074 656e 736f  nsordict = tenso
+00050620: 7264 6963 745f 7265 7365 742e 656d 7074  rdict_reset.empt
+00050630: 7928 290d 0a20 2020 2020 2020 2073 656c  y()..        sel
+00050640: 662e 6261 7365 5f65 6e76 2e5f 636f 6d70  f.base_env._comp
+00050650: 6c65 7465 5f64 6f6e 6528 7365 6c66 2e62  lete_done(self.b
+00050660: 6173 655f 656e 762e 6675 6c6c 5f64 6f6e  ase_env.full_don
+00050670: 655f 7370 6563 2c20 7465 6e73 6f72 6469  e_spec, tensordi
+00050680: 6374 5f72 6573 6574 290d 0a20 2020 2020  ct_reset)..     
+00050690: 2020 2074 656e 736f 7264 6963 745f 7265     tensordict_re
+000506a0: 7365 7420 3d20 7365 6c66 2e74 7261 6e73  set = self.trans
+000506b0: 666f 726d 2e5f 7265 7365 7428 7465 6e73  form._reset(tens
+000506c0: 6f72 6469 6374 2c20 7465 6e73 6f72 6469  ordict, tensordi
+000506d0: 6374 5f72 6573 6574 290d 0a20 2020 2020  ct_reset)..     
+000506e0: 2020 2072 6574 7572 6e20 7465 6e73 6f72     return tensor
+000506f0: 6469 6374 5f72 6573 6574 0d0a 0d0a 2020  dict_reset....  
+00050700: 2020 6465 6620 696e 7365 7274 5f74 7261    def insert_tra
+00050710: 6e73 666f 726d 2873 656c 662c 2069 6e64  nsform(self, ind
+00050720: 6578 3a20 696e 742c 2074 7261 6e73 666f  ex: int, transfo
+00050730: 726d 3a20 5472 616e 7366 6f72 6d29 202d  rm: Transform) -
+00050740: 3e20 4e6f 6e65 3a0d 0a20 2020 2020 2020  > None:..       
+00050750: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
+00050760: 726f 7228 6622 4361 6e6e 6f74 2069 6e73  ror(f"Cannot ins
+00050770: 6572 7420 6120 7472 616e 7366 6f72 6d20  ert a transform 
+00050780: 696e 207b 7365 6c66 2e5f 5f63 6c61 7373  in {self.__class
+00050790: 5f2e 5f5f 6e61 6d65 5f5f 7d2e 2229 0d0a  _.__name__}.")..
+000507a0: 0d0a 0d0a 636c 6173 7320 4175 746f 5265  ....class AutoRe
+000507b0: 7365 7454 7261 6e73 666f 726d 2854 7261  setTransform(Tra
+000507c0: 6e73 666f 726d 293a 0d0a 2020 2020 2222  nsform):..    ""
+000507d0: 2241 2074 7261 6e73 666f 726d 2066 6f72  "A transform for
+000507e0: 2061 7574 6f2d 7265 7365 7474 696e 6720   auto-resetting 
+000507f0: 656e 7669 726f 6e6d 656e 7473 2e0d 0a0d  environments....
+00050800: 0a20 2020 2054 6869 7320 7472 616e 7366  .    This transf
+00050810: 6f72 6d20 6361 6e20 6265 2061 7070 656e  orm can be appen
+00050820: 6465 6420 746f 2061 6e79 2061 7574 6f2d  ded to any auto-
+00050830: 7265 7365 7474 696e 6720 656e 7669 726f  resetting enviro
+00050840: 6e6d 656e 742c 206f 7220 6175 746f 6d61  nment, or automa
+00050850: 7469 6361 6c6c 790d 0a20 2020 2061 7070  tically..    app
+00050860: 656e 6465 6420 7573 696e 6720 6060 656e  ended using ``en
+00050870: 7620 3d20 536f 6d65 456e 7643 6c61 7373  v = SomeEnvClass
+00050880: 282e 2e2e 2c20 6175 746f 5f72 6573 6574  (..., auto_reset
+00050890: 3d54 7275 6529 6060 2e20 4966 2074 6865  =True)``. If the
+000508a0: 2074 7261 6e73 666f 726d 2069 7320 6578   transform is ex
+000508b0: 706c 6963 6974 6c79 0d0a 2020 2020 6170  plicitly..    ap
+000508c0: 7065 6e64 6564 2074 6f20 616e 2065 6e76  pended to an env
+000508d0: 2c20 6120 3a63 6c61 7373 3a60 7e74 6f72  , a :class:`~tor
+000508e0: 6368 726c 2e65 6e76 732e 7472 616e 7366  chrl.envs.transf
+000508f0: 6f72 6d73 2e41 7574 6f52 6573 6574 456e  orms.AutoResetEn
+00050900: 7660 206d 7573 7420 6265 2075 7365 642e  v` must be used.
+00050910: 0d0a 0d0a 2020 2020 416e 2061 7574 6f2d  ....    An auto-
+00050920: 7265 7365 7420 656e 7669 726f 6e6d 656e  reset environmen
+00050930: 7420 6d75 7374 2068 6176 6520 7468 6520  t must have the 
+00050940: 666f 6c6c 6f77 696e 6720 7072 6f70 6572  following proper
+00050950: 7469 6573 2028 6469 6666 6572 656e 6365  ties (difference
+00050960: 7320 6672 6f6d 2074 6869 730d 0a20 2020  s from this..   
+00050970: 2064 6573 6372 6970 7469 6f6e 2073 686f   description sho
+00050980: 756c 6420 6265 2061 6363 6f75 6e74 6564  uld be accounted
+00050990: 2066 6f72 2062 7920 7375 6263 6c61 7373   for by subclass
+000509a0: 696e 6720 7468 6973 2063 6c61 7373 293a  ing this class):
+000509b0: 0d0a 0d0a 2020 2020 2020 2d20 7468 6520  ....      - the 
+000509c0: 7265 7365 7420 6675 6e63 7469 6f6e 2063  reset function c
+000509d0: 616e 2062 6520 6361 6c6c 6564 206f 6e63  an be called onc
+000509e0: 6520 6174 2074 6865 2062 6567 696e 6e69  e at the beginni
+000509f0: 6e67 2028 6166 7465 7220 696e 7374 616e  ng (after instan
+00050a00: 7469 6174 696f 6e29 2077 6974 680d 0a20  tiation) with.. 
+00050a10: 2020 2020 2020 206f 7220 7769 7468 6f75         or withou
+00050a20: 7420 6566 6665 6374 2e20 5768 6574 6865  t effect. Whethe
+00050a30: 7220 6361 6c6c 7320 746f 2060 7265 7365  r calls to `rese
+00050a40: 7460 2061 7265 2061 6c6c 6f77 6564 2061  t` are allowed a
+00050a50: 6674 6572 2074 6861 7420 6973 2075 7020  fter that is up 
+00050a60: 746f 2074 6865 0d0a 2020 2020 2020 2020  to the..        
+00050a70: 656e 7669 726f 6e6d 656e 7420 6974 7365  environment itse
+00050a80: 6c66 2e0d 0a20 2020 2020 202d 2044 7572  lf...      - Dur
+00050a90: 696e 6720 6120 726f 6c6c 6f75 742c 2061  ing a rollout, a
+00050aa0: 6e79 2060 6064 6f6e 6560 6020 7374 6174  ny ``done`` stat
+00050ab0: 6520 7769 6c6c 2072 6573 756c 7420 696e  e will result in
+00050ac0: 2061 2072 6573 6574 2061 6e64 2070 726f   a reset and pro
+00050ad0: 6475 6365 2061 6e20 6f62 7365 7276 6174  duce an observat
+00050ae0: 696f 6e0d 0a20 2020 2020 2020 2074 6861  ion..        tha
+00050af0: 7420 6973 6e27 7420 7468 6520 6c61 7374  t isn't the last
+00050b00: 206f 6273 6572 7661 7469 6f6e 206f 6620   observation of 
+00050b10: 7468 6520 6375 7272 656e 7420 6570 6973  the current epis
+00050b20: 6f64 652c 2062 7574 2074 6865 2066 6972  ode, but the fir
+00050b30: 7374 206f 6273 6572 7661 7469 6f6e 0d0a  st observation..
+00050b40: 2020 2020 2020 2020 6f66 2074 6865 206e          of the n
+00050b50: 6578 7420 6570 6973 6f64 6520 2874 6869  ext episode (thi
+00050b60: 7320 7472 616e 7366 6f72 6d20 7769 6c6c  s transform will
+00050b70: 2065 7874 7261 6374 2061 6e64 2063 6163   extract and cac
+00050b80: 6865 2074 6869 7320 6f62 7365 7276 6174  he this observat
+00050b90: 696f 6e0d 0a20 2020 2020 2020 2061 6e64  ion..        and
+00050ba0: 2066 696c 6c20 7468 6520 6f62 7320 7769   fill the obs wi
+00050bb0: 7468 2073 6f6d 6520 6172 6269 7472 6172  th some arbitrar
+00050bc0: 7920 7661 6c75 6529 2e0d 0a0d 0a20 2020  y value).....   
+00050bd0: 204b 6579 776f 7264 2041 7267 733a 0d0a   Keyword Args:..
+00050be0: 2020 2020 2020 2020 7265 706c 6163 6520          replace 
+00050bf0: 2862 6f6f 6c2c 206f 7074 696f 6e61 6c29  (bool, optional)
+00050c00: 3a20 6966 2060 6046 616c 7365 6060 2c20  : if ``False``, 
+00050c10: 7661 6c75 6573 2061 7265 206a 7573 7420  values are just 
+00050c20: 706c 6163 6564 2061 7320 7468 6579 2061  placed as they a
+00050c30: 7265 2069 6e20 7468 650d 0a20 2020 2020  re in the..     
+00050c40: 2020 2020 2020 2060 6022 6e65 7874 2260         ``"next"`
+00050c50: 6020 656e 7472 7920 6576 656e 2069 6620  ` entry even if 
+00050c60: 7468 6579 2061 7265 206e 6f74 2076 616c  they are not val
+00050c70: 6964 2e20 4465 6661 756c 7473 2074 6f20  id. Defaults to 
+00050c80: 6060 5472 7565 6060 2e20 4120 7661 6c75  ``True``. A valu
+00050c90: 6520 6f66 0d0a 2020 2020 2020 2020 2020  e of..          
+00050ca0: 2020 6060 4661 6c73 6560 6020 6f76 6572    ``False`` over
+00050cb0: 7269 6465 7320 616e 7920 7375 6273 6571  rides any subseq
+00050cc0: 7565 6e74 2066 696c 6c69 6e67 206b 6579  uent filling key
+00050cd0: 776f 7264 2061 7267 756d 656e 742e 0d0a  word argument...
+00050ce0: 2020 2020 2020 2020 2020 2020 5468 6973              This
+00050cf0: 2061 7267 756d 6574 2063 616e 2061 6c73   argumet can als
+00050d00: 6f20 6265 2070 6173 7365 6420 7769 7468  o be passed with
+00050d10: 2074 6865 2063 6f6e 7374 7275 6374 6f72   the constructor
+00050d20: 206d 6574 686f 6420 6279 2070 6173 7369   method by passi
+00050d30: 6e67 2061 0d0a 2020 2020 2020 2020 2020  ng a..          
+00050d40: 2020 6060 6175 746f 5f72 6573 6574 5f72    ``auto_reset_r
+00050d50: 6570 6c61 6365 6060 2061 7267 756d 656e  eplace`` argumen
+00050d60: 743a 2060 6065 6e76 203d 2046 6f6f 456e  t: ``env = FooEn
+00050d70: 7628 2e2e 2e2c 2061 7574 6f5f 7265 7365  v(..., auto_rese
+00050d80: 743d 5472 7565 2c20 6175 746f 5f72 6573  t=True, auto_res
+00050d90: 6574 5f72 6570 6c61 6365 3d46 616c 7365  et_replace=False
+00050da0: 2960 602e 0d0a 2020 2020 2020 2020 6669  )``...        fi
+00050db0: 6c6c 5f66 6c6f 6174 2028 666c 6f61 7420  ll_float (float 
+00050dc0: 6f72 2073 7472 2c20 6f70 7469 6f6e 616c  or str, optional
+00050dd0: 293a 2054 6865 2066 696c 6c69 6e67 2076  ): The filling v
+00050de0: 616c 7565 2066 6f72 2066 6c6f 6174 696e  alue for floatin
+00050df0: 6720 706f 696e 7420 7465 6e73 6f72 730d  g point tensors.
+00050e00: 0a20 2020 2020 2020 2020 2020 2074 6861  .            tha
+00050e10: 7420 7465 726d 696e 6174 6520 616e 2065  t terminate an e
+00050e20: 7069 736f 6465 2e20 4120 7661 6c75 6520  pisode. A value 
+00050e30: 6f66 2060 604e 6f6e 6560 6020 6d65 616e  of ``None`` mean
+00050e40: 7320 6e6f 2072 6570 6c61 6365 6d65 6e74  s no replacement
+00050e50: 2028 7661 6c75 6573 2061 7265 206a 7573   (values are jus
+00050e60: 740d 0a20 2020 2020 2020 2020 2020 2070  t..            p
+00050e70: 6c61 6365 6420 6173 2074 6865 7920 6172  laced as they ar
+00050e80: 6520 696e 2074 6865 2060 6022 6e65 7874  e in the ``"next
+00050e90: 2260 6020 656e 7472 7920 6576 656e 2069  "`` entry even i
+00050ea0: 6620 7468 6579 2061 7265 206e 6f74 2076  f they are not v
+00050eb0: 616c 6964 292e 0d0a 2020 2020 2020 2020  alid)...        
+00050ec0: 6669 6c6c 5f69 6e74 2028 696e 742c 206f  fill_int (int, o
+00050ed0: 7074 696f 6e61 6c29 3a20 5468 6520 6669  ptional): The fi
+00050ee0: 6c6c 696e 6720 7661 6c75 6520 666f 7220  lling value for 
+00050ef0: 7369 676e 6564 2069 6e74 6567 6572 2074  signed integer t
+00050f00: 656e 736f 7273 0d0a 2020 2020 2020 2020  ensors..        
+00050f10: 2020 2020 7468 6174 2074 6572 6d69 6e61      that termina
+00050f20: 7465 2061 6e20 6570 6973 6f64 652e 2020  te an episode.  
+00050f30: 4120 7661 6c75 6520 6f66 2060 604e 6f6e  A value of ``Non
+00050f40: 6560 6020 6d65 616e 7320 6e6f 2072 6570  e`` means no rep
+00050f50: 6c61 6365 6d65 6e74 2028 7661 6c75 6573  lacement (values
+00050f60: 2061 7265 206a 7573 740d 0a20 2020 2020   are just..     
+00050f70: 2020 2020 2020 2070 6c61 6365 6420 6173         placed as
+00050f80: 2074 6865 7920 6172 6520 696e 2074 6865   they are in the
+00050f90: 2060 6022 6e65 7874 2260 6020 656e 7472   ``"next"`` entr
+00050fa0: 7920 6576 656e 2069 6620 7468 6579 2061  y even if they a
+00050fb0: 7265 206e 6f74 2076 616c 6964 292e 0d0a  re not valid)...
+00050fc0: 2020 2020 2020 2020 6669 6c6c 5f62 6f6f          fill_boo
+00050fd0: 6c20 2862 6f6f 6c2c 206f 7074 696f 6e61  l (bool, optiona
+00050fe0: 6c29 3a20 5468 6520 6669 6c6c 696e 6720  l): The filling 
+00050ff0: 7661 6c75 6520 666f 7220 626f 6f6c 6561  value for boolea
+00051000: 6e20 7465 6e73 6f72 730d 0a20 2020 2020  n tensors..     
+00051010: 2020 2020 2020 2074 6861 7420 7465 726d         that term
+00051020: 696e 6174 6520 616e 2065 7069 736f 6465  inate an episode
+00051030: 2e20 2041 2076 616c 7565 206f 6620 6060  .  A value of ``
+00051040: 4e6f 6e65 6060 206d 6561 6e73 206e 6f20  None`` means no 
+00051050: 7265 706c 6163 656d 656e 7420 2876 616c  replacement (val
+00051060: 7565 7320 6172 6520 6a75 7374 0d0a 2020  ues are just..  
+00051070: 2020 2020 2020 2020 2020 706c 6163 6564            placed
+00051080: 2061 7320 7468 6579 2061 7265 2069 6e20   as they are in 
+00051090: 7468 6520 6060 226e 6578 7422 6060 2065  the ``"next"`` e
+000510a0: 6e74 7279 2065 7665 6e20 6966 2074 6865  ntry even if the
+000510b0: 7920 6172 6520 6e6f 7420 7661 6c69 6429  y are not valid)
+000510c0: 2e0d 0a0d 0a20 2020 2041 7267 756d 656e  .....    Argumen
+000510d0: 7473 2061 7265 206f 6e6c 7920 6176 6169  ts are only avai
+000510e0: 6c61 626c 6520 7768 656e 2074 6865 2074  lable when the t
+000510f0: 7261 6e73 666f 726d 2069 7320 6578 706c  ransform is expl
+00051100: 6963 6974 6c79 2069 6e73 7461 6e74 6961  icitly instantia
+00051110: 7465 6420 286e 6f74 2074 6872 6f75 6768  ted (not through
+00051120: 2060 456e 7654 7970 6528 2e2e 2e2c 2061   `EnvType(..., a
+00051130: 7574 6f5f 7265 7365 743d 5472 7565 2960  uto_reset=True)`
+00051140: 292e 0d0a 0d0a 2020 2020 4578 616d 706c  ).....    Exampl
+00051150: 6573 3a0d 0a20 2020 2020 2020 203e 3e3e  es:..        >>>
+00051160: 2066 726f 6d20 746f 7263 6872 6c2e 656e   from torchrl.en
+00051170: 7673 2069 6d70 6f72 7420 4779 6d45 6e76  vs import GymEnv
+00051180: 0d0a 2020 2020 2020 2020 3e3e 3e20 6672  ..        >>> fr
+00051190: 6f6d 2074 6f72 6368 726c 2e65 6e76 7320  om torchrl.envs 
+000511a0: 696d 706f 7274 2073 6574 5f67 796d 5f62  import set_gym_b
+000511b0: 6163 6b65 6e64 0d0a 2020 2020 2020 2020  ackend..        
+000511c0: 3e3e 3e20 696d 706f 7274 2074 6f72 6368  >>> import torch
+000511d0: 0d0a 2020 2020 2020 2020 3e3e 3e20 746f  ..        >>> to
+000511e0: 7263 682e 6d61 6e75 616c 5f73 6565 6428  rch.manual_seed(
+000511f0: 3029 0d0a 2020 2020 2020 2020 3e3e 3e0d  0)..        >>>.
+00051200: 0a20 2020 2020 2020 203e 3e3e 2063 6c61  .        >>> cla
+00051210: 7373 2041 7574 6f52 6573 6574 7469 6e67  ss AutoResetting
+00051220: 4779 6d45 6e76 2847 796d 456e 7629 3a0d  GymEnv(GymEnv):.
+00051230: 0a20 2020 2020 2020 202e 2e2e 2020 2020  .        ...    
+00051240: 2064 6566 205f 7374 6570 2873 656c 662c   def _step(self,
+00051250: 2074 656e 736f 7264 6963 7429 3a0d 0a20   tensordict):.. 
+00051260: 2020 2020 2020 202e 2e2e 2020 2020 2020         ...      
+00051270: 2020 2074 656e 736f 7264 6963 7420 3d20     tensordict = 
+00051280: 7375 7065 7228 292e 5f73 7465 7028 7465  super()._step(te
+00051290: 6e73 6f72 6469 6374 290d 0a20 2020 2020  nsordict)..     
+000512a0: 2020 202e 2e2e 2020 2020 2020 2020 2069     ...         i
+000512b0: 6620 7465 6e73 6f72 6469 6374 5b22 646f  f tensordict["do
+000512c0: 6e65 225d 2e61 6e79 2829 3a0d 0a20 2020  ne"].any():..   
+000512d0: 2020 2020 202e 2e2e 2020 2020 2020 2020       ...        
+000512e0: 2020 2020 2074 645f 7265 7365 7420 3d20       td_reset = 
+000512f0: 7375 7065 7228 292e 7265 7365 7428 290d  super().reset().
+00051300: 0a20 2020 2020 2020 202e 2e2e 2020 2020  .        ...    
+00051310: 2020 2020 2020 2020 2074 656e 736f 7264           tensord
+00051320: 6963 742e 7570 6461 7465 2874 645f 7265  ict.update(td_re
+00051330: 7365 742e 6578 636c 7564 6528 2a73 656c  set.exclude(*sel
+00051340: 662e 646f 6e65 5f6b 6579 7329 290d 0a20  f.done_keys)).. 
+00051350: 2020 2020 2020 202e 2e2e 2020 2020 2020         ...      
+00051360: 2020 2072 6574 7572 6e20 7465 6e73 6f72     return tensor
+00051370: 6469 6374 0d0a 2020 2020 2020 2020 2e2e  dict..        ..
+00051380: 2e0d 0a20 2020 2020 2020 202e 2e2e 2020  ...        ...  
+00051390: 2020 2064 6566 205f 7265 7365 7428 7365     def _reset(se
+000513a0: 6c66 2c20 7465 6e73 6f72 6469 6374 3d4e  lf, tensordict=N
+000513b0: 6f6e 6529 3a0d 0a20 2020 2020 2020 202e  one):..        .
+000513c0: 2e2e 2020 2020 2020 2020 2069 6620 7465  ..         if te
+000513d0: 6e73 6f72 6469 6374 2069 7320 6e6f 7420  nsordict is not 
+000513e0: 4e6f 6e65 2061 6e64 2022 5f72 6573 6574  None and "_reset
+000513f0: 2220 696e 2074 656e 736f 7264 6963 743a  " in tensordict:
+00051400: 0d0a 2020 2020 2020 2020 2e2e 2e20 2020  ..        ...   
+00051410: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00051420: 2074 656e 736f 7264 6963 742e 636f 7079   tensordict.copy
+00051430: 2829 0d0a 2020 2020 2020 2020 2e2e 2e20  ()..        ... 
+00051440: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00051450: 7570 6572 2829 2e5f 7265 7365 7428 7465  uper()._reset(te
+00051460: 6e73 6f72 6469 6374 290d 0a20 2020 2020  nsordict)..     
+00051470: 2020 203e 3e3e 0d0a 2020 2020 2020 2020     >>>..        
+00051480: 3e3e 3e20 7769 7468 2073 6574 5f67 796d  >>> with set_gym
+00051490: 5f62 6163 6b65 6e64 2822 6779 6d22 293a  _backend("gym"):
+000514a0: 0d0a 2020 2020 2020 2020 2e2e 2e20 2020  ..        ...   
+000514b0: 2020 656e 7620 3d20 4175 746f 5265 7365    env = AutoRese
+000514c0: 7474 696e 6747 796d 456e 7628 2243 6172  ttingGymEnv("Car
+000514d0: 7450 6f6c 652d 7631 222c 2061 7574 6f5f  tPole-v1", auto_
+000514e0: 7265 7365 743d 5472 7565 2c20 6175 746f  reset=True, auto
+000514f0: 5f72 6573 6574 5f72 6570 6c61 6365 3d54  _reset_replace=T
+00051500: 7275 6529 0d0a 2020 2020 2020 2020 2e2e  rue)..        ..
+00051510: 2e20 2020 2020 656e 762e 7365 745f 7365  .     env.set_se
+00051520: 6564 2830 290d 0a20 2020 2020 2020 202e  ed(0)..        .
+00051530: 2e2e 2020 2020 2072 203d 2065 6e76 2e72  ..     r = env.r
+00051540: 6f6c 6c6f 7574 2833 302c 2062 7265 616b  ollout(30, break
+00051550: 5f77 6865 6e5f 616e 795f 646f 6e65 3d46  _when_any_done=F
+00051560: 616c 7365 290d 0a20 2020 2020 2020 203e  alse)..        >
+00051570: 3e3e 2070 7269 6e74 2872 5b22 6e65 7874  >> print(r["next
+00051580: 222c 2022 646f 6e65 225d 2e73 7175 6565  ", "done"].squee
+00051590: 7a65 2829 290d 0a20 2020 2020 2020 2074  ze())..        t
+000515a0: 656e 736f 7228 5b46 616c 7365 2c20 4661  ensor([False, Fa
+000515b0: 6c73 652c 2046 616c 7365 2c20 4661 6c73  lse, False, Fals
+000515c0: 652c 2046 616c 7365 2c20 4661 6c73 652c  e, False, False,
+000515d0: 2046 616c 7365 2c20 4661 6c73 652c 2046   False, False, F
+000515e0: 616c 7365 2c20 4661 6c73 652c 0d0a 2020  alse, False,..  
+000515f0: 2020 2020 2020 2020 2020 2020 2020 4661                Fa
+00051600: 6c73 652c 2046 616c 7365 2c20 4661 6c73  lse, False, Fals
+00051610: 652c 2020 5472 7565 2c20 4661 6c73 652c  e,  True, False,
+00051620: 2046 616c 7365 2c20 4661 6c73 652c 2046   False, False, F
+00051630: 616c 7365 2c20 4661 6c73 652c 2046 616c  alse, False, Fal
+00051640: 7365 2c0d 0a20 2020 2020 2020 2020 2020  se,..           
+00051650: 2020 2020 2046 616c 7365 2c20 4661 6c73       False, Fals
+00051660: 652c 2046 616c 7365 2c20 4661 6c73 652c  e, False, False,
+00051670: 2046 616c 7365 2c20 2054 7275 652c 2046   False,  True, F
+00051680: 616c 7365 2c20 4661 6c73 652c 2046 616c  alse, False, Fal
+00051690: 7365 2c20 4661 6c73 655d 290d 0a20 2020  se, False])..   
+000516a0: 2020 2020 203e 3e3e 2070 7269 6e74 2822       >>> print("
+000516b0: 6f62 7365 7276 6174 696f 6e20 6166 7465  observation afte
+000516c0: 7220 7265 7365 7420 6172 6520 7365 7420  r reset are set 
+000516d0: 6173 206e 616e 222c 2072 5b22 6e65 7874  as nan", r["next
+000516e0: 222c 2022 6f62 7365 7276 6174 696f 6e22  ", "observation"
+000516f0: 5d29 0d0a 2020 2020 2020 2020 6f62 7365  ])..        obse
+00051700: 7276 6174 696f 6e20 6166 7465 7220 7265  rvation after re
+00051710: 7365 7420 6172 6520 7365 7420 6173 206e  set are set as n
+00051720: 616e 2074 656e 736f 7228 5b5b 2d34 2e33  an tensor([[-4.3
+00051730: 3633 3365 2d30 322c 202d 312e 3438 3737  633e-02, -1.4877
+00051740: 652d 3031 2c20 2031 2e32 3834 3965 2d30  e-01,  1.2849e-0
+00051750: 322c 2020 322e 3735 3834 652d 3031 5d2c  2,  2.7584e-01],
+00051760: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00051770: 2020 5b2d 342e 3636 3039 652d 3032 2c20    [-4.6609e-02, 
+00051780: 2034 2e36 3136 3665 2d30 322c 2020 312e   4.6166e-02,  1.
+00051790: 3833 3636 652d 3032 2c20 2d31 2e32 3736  8366e-02, -1.276
+000517a0: 3165 2d30 325d 2c0d 0a20 2020 2020 2020  1e-02],..       
+000517b0: 2020 2020 2020 2020 205b 2d34 2e35 3638           [-4.568
+000517c0: 3565 2d30 322c 2020 322e 3431 3032 652d  5e-02,  2.4102e-
+000517d0: 3031 2c20 2031 2e38 3131 3165 2d30 322c  01,  1.8111e-02,
+000517e0: 202d 322e 3939 3539 652d 3031 5d2c 0d0a   -2.9959e-01],..
+000517f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051800: 5b2d 342e 3038 3635 652d 3032 2c20 2034  [-4.0865e-02,  4
+00051810: 2e35 3634 3465 2d30 322c 2020 312e 3231  .5644e-02,  1.21
+00051820: 3139 652d 3032 2c20 2d31 2e32 3534 3265  19e-02, -1.2542e
+00051830: 2d30 335d 2c0d 0a20 2020 2020 2020 2020  -03],..         
+00051840: 2020 2020 2020 205b 2d33 2e39 3935 3265         [-3.9952e
+00051850: 2d30 322c 2020 322e 3430 3539 652d 3031  -02,  2.4059e-01
+00051860: 2c20 2031 2e32 3039 3465 2d30 322c 202d  ,  1.2094e-02, -
+00051870: 322e 3930 3039 652d 3031 5d2c 0d0a 2020  2.9009e-01],..  
+00051880: 2020 2020 2020 2020 2020 2020 2020 5b2d                [-
+00051890: 332e 3531 3430 652d 3032 2c20 2034 2e33  3.5140e-02,  4.3
+000518a0: 3535 3465 2d30 312c 2020 362e 3239 3230  554e-01,  6.2920
+000518b0: 652d 3033 2c20 2d35 2e37 3839 3365 2d30  e-03, -5.7893e-0
+000518c0: 315d 2c0d 0a20 2020 2020 2020 2020 2020  1],..           
+000518d0: 2020 2020 205b 2d32 2e36 3432 3965 2d30       [-2.6429e-0
+000518e0: 322c 2020 362e 3330 3537 652d 3031 2c20  2,  6.3057e-01, 
+000518f0: 2d35 2e32 3836 3765 2d30 332c 202d 382e  -5.2867e-03, -8.
+00051900: 3639 3633 652d 3031 5d2c 0d0a 2020 2020  6963e-01],..    
+00051910: 2020 2020 2020 2020 2020 2020 5b2d 312e              [-1.
+00051920: 3338 3138 652d 3032 2c20 2038 2e32 3537  3818e-02,  8.257
+00051930: 3665 2d30 312c 202d 322e 3236 3739 652d  6e-01, -2.2679e-
+00051940: 3032 2c20 2d31 2e31 3634 3065 2b30 305d  02, -1.1640e+00]
+00051950: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+00051960: 2020 205b 2032 2e36 3937 3265 2d30 332c     [ 2.6972e-03,
+00051970: 2020 312e 3032 3132 652b 3030 2c20 2d34    1.0212e+00, -4
+00051980: 2e35 3935 3965 2d30 322c 202d 312e 3436  .5959e-02, -1.46
+00051990: 3337 652b 3030 5d2c 0d0a 2020 2020 2020  37e+00],..      
+000519a0: 2020 2020 2020 2020 2020 5b20 322e 3331            [ 2.31
+000519b0: 3231 652d 3032 2c20 2031 2e32 3136 3865  21e-02,  1.2168e
+000519c0: 2b30 302c 202d 372e 3532 3332 652d 3032  +00, -7.5232e-02
+000519d0: 2c20 2d31 2e37 3730 3465 2b30 305d 2c0d  , -1.7704e+00],.
+000519e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000519f0: 205b 2034 2e37 3435 3765 2d30 322c 2020   [ 4.7457e-02,  
+00051a00: 312e 3431 3237 652b 3030 2c20 2d31 2e31  1.4127e+00, -1.1
+00051a10: 3036 3465 2d30 312c 202d 322e 3038 3534  064e-01, -2.0854
+00051a20: 652b 3030 5d2c 0d0a 2020 2020 2020 2020  e+00],..        
+00051a30: 2020 2020 2020 2020 5b20 372e 3537 3132          [ 7.5712
+00051a40: 652d 3032 2c20 2031 2e32 3138 3965 2b30  e-02,  1.2189e+0
+00051a50: 302c 202d 312e 3532 3335 652d 3031 2c20  0, -1.5235e-01, 
+00051a60: 2d31 2e38 3238 3965 2b30 305d 2c0d 0a20  -1.8289e+00],.. 
+00051a70: 2020 2020 2020 2020 2020 2020 2020 205b                 [
+00051a80: 2031 2e30 3030 3965 2d30 312c 2020 312e   1.0009e-01,  1.
+00051a90: 3032 3537 652b 3030 2c20 2d31 2e38 3839  0257e+00, -1.889
+00051aa0: 3365 2d30 312c 202d 312e 3538 3732 652b  3e-01, -1.5872e+
+00051ab0: 3030 5d2c 0d0a 2020 2020 2020 2020 2020  00],..          
+00051ac0: 2020 2020 2020 5b20 2020 2020 2020 206e        [        n
+00051ad0: 616e 2c20 2020 2020 2020 2020 6e61 6e2c  an,         nan,
+00051ae0: 2020 2020 2020 2020 206e 616e 2c20 2020           nan,   
+00051af0: 2020 2020 2020 6e61 6e5d 2c0d 0a20 2020        nan],..   
+00051b00: 2020 2020 2020 2020 2020 2020 205b 2d33               [-3
+00051b10: 2e39 3430 3565 2d30 322c 202d 312e 3737  .9405e-02, -1.77
+00051b20: 3636 652d 3031 2c20 2d31 2e30 3430 3365  66e-01, -1.0403e
+00051b30: 2d30 322c 2020 332e 3036 3236 652d 3031  -02,  3.0626e-01
+00051b40: 5d2c 0d0a 2020 2020 2020 2020 2020 2020  ],..            
+00051b50: 2020 2020 5b2d 342e 3239 3539 652d 3032      [-4.2959e-02
+00051b60: 2c20 2d33 2e37 3236 3365 2d30 312c 202d  , -3.7263e-01, -
+00051b70: 342e 3237 3735 652d 3033 2c20 2035 2e39  4.2775e-03,  5.9
+00051b80: 3536 3465 2d30 315d 2c0d 0a20 2020 2020  564e-01],..     
+00051b90: 2020 2020 2020 2020 2020 205b 2d35 2e30             [-5.0
+00051ba0: 3431 3165 2d30 322c 202d 352e 3637 3639  411e-02, -5.6769
+00051bb0: 652d 3031 2c20 2037 2e36 3335 3465 2d30  e-01,  7.6354e-0
+00051bc0: 332c 2020 382e 3836 3938 652d 3031 5d2c  3,  8.8698e-01],
+00051bd0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00051be0: 2020 5b2d 362e 3137 3635 652d 3032 2c20    [-6.1765e-02, 
+00051bf0: 2d37 2e36 3239 3265 2d30 312c 2020 322e  -7.6292e-01,  2.
+00051c00: 3533 3735 652d 3032 2c20 2031 2e31 3832  5375e-02,  1.182
+00051c10: 3065 2b30 305d 2c0d 0a20 2020 2020 2020  0e+00],..       
+00051c20: 2020 2020 2020 2020 205b 2d37 2e37 3032           [-7.702
+00051c30: 3365 2d30 322c 202d 392e 3538 3336 652d  3e-02, -9.5836e-
+00051c40: 3031 2c20 2034 2e39 3031 3665 2d30 322c  01,  4.9016e-02,
+00051c50: 2020 312e 3438 3236 652b 3030 5d2c 0d0a    1.4826e+00],..
+00051c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051c70: 5b2d 392e 3631 3931 652d 3032 2c20 2d37  [-9.6191e-02, -7
+00051c80: 2e36 3338 3765 2d30 312c 2020 372e 3836  .6387e-01,  7.86
+00051c90: 3637 652d 3032 2c20 2031 2e32 3035 3665  67e-02,  1.2056e
+00051ca0: 2b30 305d 2c0d 0a20 2020 2020 2020 2020  +00],..         
+00051cb0: 2020 2020 2020 205b 2d31 2e31 3134 3765         [-1.1147e
+00051cc0: 2d30 312c 202d 392e 3539 3931 652d 3031  -01, -9.5991e-01
+00051cd0: 2c20 2031 2e30 3237 3865 2d30 312c 2020  ,  1.0278e-01,  
+00051ce0: 312e 3532 3139 652b 3030 5d2c 0d0a 2020  1.5219e+00],..  
+00051cf0: 2020 2020 2020 2020 2020 2020 2020 5b2d                [-
+00051d00: 312e 3330 3637 652d 3031 2c20 2d37 2e36  1.3067e-01, -7.6
+00051d10: 3631 3765 2d30 312c 2020 312e 3333 3232  617e-01,  1.3322
+00051d20: 652d 3031 2c20 2031 2e32 3632 3965 2b30  e-01,  1.2629e+0
+00051d30: 305d 2c0d 0a20 2020 2020 2020 2020 2020  0],..           
+00051d40: 2020 2020 205b 2d31 2e34 3539 3965 2d30       [-1.4599e-0
+00051d50: 312c 202d 352e 3732 3938 652d 3031 2c20  1, -5.7298e-01, 
+00051d60: 2031 2e35 3834 3865 2d30 312c 2020 312e   1.5848e-01,  1.
+00051d70: 3031 3438 652b 3030 5d2c 0d0a 2020 2020  0148e+00],..    
+00051d80: 2020 2020 2020 2020 2020 2020 5b2d 312e              [-1.
+00051d90: 3537 3435 652d 3031 2c20 2d37 2e36 3938  5745e-01, -7.698
+00051da0: 3265 2d30 312c 2020 312e 3738 3737 652d  2e-01,  1.7877e-
+00051db0: 3031 2c20 2031 2e33 3532 3765 2b30 305d  01,  1.3527e+00]
+00051dc0: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+00051dd0: 2020 205b 2d31 2e37 3238 3565 2d30 312c     [-1.7285e-01,
+00051de0: 202d 392e 3636 3638 652d 3031 2c20 2032   -9.6668e-01,  2
+00051df0: 2e30 3538 3365 2d30 312c 2020 312e 3639  .0583e-01,  1.69
+00051e00: 3536 652b 3030 5d2c 0d0a 2020 2020 2020  56e+00],..      
+00051e10: 2020 2020 2020 2020 2020 5b20 2020 2020            [     
+00051e20: 2020 206e 616e 2c20 2020 2020 2020 2020     nan,         
+00051e30: 6e61 6e2c 2020 2020 2020 2020 206e 616e  nan,         nan
+00051e40: 2c20 2020 2020 2020 2020 6e61 6e5d 2c0d  ,         nan],.
+00051e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00051e60: 205b 2d34 2e33 3936 3265 2d30 322c 2020   [-4.3962e-02,  
+00051e70: 312e 3938 3435 652d 3031 2c20 2d34 2e35  1.9845e-01, -4.5
+00051e80: 3031 3565 2d30 322c 202d 322e 3539 3033  015e-02, -2.5903
+00051e90: 652d 3031 5d2c 0d0a 2020 2020 2020 2020  e-01],..        
+00051ea0: 2020 2020 2020 2020 5b2d 332e 3939 3933          [-3.9993
+00051eb0: 652d 3032 2c20 2033 2e39 3431 3865 2d30  e-02,  3.9418e-0
+00051ec0: 312c 202d 352e 3031 3936 652d 3032 2c20  1, -5.0196e-02, 
+00051ed0: 2d35 2e36 3535 3765 2d30 315d 2c0d 0a20  -5.6557e-01],.. 
+00051ee0: 2020 2020 2020 2020 2020 2020 2020 205b                 [
+00051ef0: 2d33 2e32 3130 3965 2d30 322c 2020 352e  -3.2109e-02,  5.
+00051f00: 3839 3937 652d 3031 2c20 2d36 2e31 3530  8997e-01, -6.150
+00051f10: 3765 2d30 322c 202d 382e 3733 3633 652d  7e-02, -8.7363e-
+00051f20: 3031 5d2c 0d0a 2020 2020 2020 2020 2020  01],..          
+00051f30: 2020 2020 2020 5b2d 322e 3033 3130 652d        [-2.0310e-
+00051f40: 3032 2c20 2033 2e39 3537 3465 2d30 312c  02,  3.9574e-01,
+00051f50: 202d 372e 3839 3830 652d 3032 2c20 2d36   -7.8980e-02, -6
+00051f60: 2e30 3039 3065 2d30 315d 5d29 0d0a 0d0a  .0090e-01]])....
+00051f70: 2020 2020 2222 220d 0a0d 0a20 2020 2064      """....    d
+00051f80: 6566 205f 5f69 6e69 745f 5f28 0d0a 2020  ef __init__(..  
+00051f90: 2020 2020 2020 7365 6c66 2c0d 0a20 2020        self,..   
+00051fa0: 2020 2020 202a 2c0d 0a20 2020 2020 2020       *,..       
+00051fb0: 2072 6570 6c61 6365 3a20 626f 6f6c 207c   replace: bool |
+00051fc0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0d 0a20   None = None,.. 
+00051fd0: 2020 2020 2020 2066 696c 6c5f 666c 6f61         fill_floa
+00051fe0: 743d 226e 616e 222c 0d0a 2020 2020 2020  t="nan",..      
+00051ff0: 2020 6669 6c6c 5f69 6e74 3d2d 312c 0d0a    fill_int=-1,..
+00052000: 2020 2020 2020 2020 6669 6c6c 5f62 6f6f          fill_boo
+00052010: 6c3d 4661 6c73 652c 0d0a 2020 2020 293a  l=False,..    ):
+00052020: 0d0a 2020 2020 2020 2020 7375 7065 7228  ..        super(
+00052030: 292e 5f5f 696e 6974 5f5f 2829 0d0a 2020  ).__init__()..  
+00052040: 2020 2020 2020 6966 2072 6570 6c61 6365        if replace
+00052050: 2069 7320 4661 6c73 653a 0d0a 2020 2020   is False:..    
+00052060: 2020 2020 2020 2020 6669 6c6c 5f66 6c6f          fill_flo
+00052070: 6174 203d 2066 696c 6c5f 696e 7420 3d20  at = fill_int = 
+00052080: 6669 6c6c 5f62 6f6f 6c20 3d20 4e6f 6e65  fill_bool = None
+00052090: 0d0a 2020 2020 2020 2020 6966 2066 696c  ..        if fil
+000520a0: 6c5f 666c 6f61 7420 3d3d 2022 6e61 6e22  l_float == "nan"
+000520b0: 3a0d 0a20 2020 2020 2020 2020 2020 2066  :..            f
+000520c0: 696c 6c5f 666c 6f61 7420 3d20 666c 6f61  ill_float = floa
+000520d0: 7428 226e 616e 2229 0d0a 2020 2020 2020  t("nan")..      
+000520e0: 2020 7365 6c66 2e66 696c 6c5f 666c 6f61    self.fill_floa
+000520f0: 7420 3d20 6669 6c6c 5f66 6c6f 6174 0d0a  t = fill_float..
+00052100: 2020 2020 2020 2020 7365 6c66 2e66 696c          self.fil
+00052110: 6c5f 696e 7420 3d20 6669 6c6c 5f69 6e74  l_int = fill_int
+00052120: 0d0a 2020 2020 2020 2020 7365 6c66 2e66  ..        self.f
+00052130: 696c 6c5f 626f 6f6c 203d 2066 696c 6c5f  ill_bool = fill_
+00052140: 626f 6f6c 0d0a 2020 2020 2020 2020 7365  bool..        se
+00052150: 6c66 2e5f 7661 6c69 6461 7465 6420 3d20  lf._validated = 
+00052160: 4661 6c73 650d 0a0d 0a20 2020 2064 6566  False....    def
+00052170: 205f 7661 6c69 6461 7465 5f63 6f6e 7461   _validate_conta
+00052180: 696e 6572 2873 656c 6629 3a0d 0a20 2020  iner(self):..   
+00052190: 2020 2020 2069 6620 7365 6c66 2e5f 7661       if self._va
+000521a0: 6c69 6461 7465 643a 0d0a 2020 2020 2020  lidated:..      
+000521b0: 2020 2020 2020 7265 7475 726e 0d0a 2020        return..  
+000521c0: 2020 2020 2020 6966 2074 7970 6528 7365        if type(se
+000521d0: 6c66 2e63 6f6e 7461 696e 6572 2920 6973  lf.container) is
+000521e0: 206e 6f74 2041 7574 6f52 6573 6574 456e   not AutoResetEn
+000521f0: 763a 0d0a 2020 2020 2020 2020 2020 2020  v:..            
+00052200: 7261 6973 6520 5275 6e74 696d 6545 7272  raise RuntimeErr
+00052210: 6f72 280d 0a20 2020 2020 2020 2020 2020  or(..           
+00052220: 2020 2020 2066 2254 6865 207b 7365 6c66       f"The {self
+00052230: 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e 616d  .__class__.__nam
+00052240: 655f 5f7d 2063 6f6e 7461 696e 6572 206d  e__} container m
+00052250: 7573 7420 6265 206f 6620 7479 7065 2041  ust be of type A
+00052260: 7574 6f52 6573 6574 456e 762e 220d 0a20  utoResetEnv.".. 
+00052270: 2020 2020 2020 2020 2020 2029 0d0a 2020             )..  
+00052280: 2020 2020 2020 7365 6c66 2e5f 7661 6c69        self._vali
+00052290: 6461 7465 6420 3d20 5472 7565 0d0a 0d0a  dated = True....
+000522a0: 2020 2020 6465 6620 5f72 6573 6574 280d      def _reset(.
+000522b0: 0a20 2020 2020 2020 2073 656c 662c 2074  .        self, t
+000522c0: 656e 736f 7264 6963 743a 2054 656e 736f  ensordict: Tenso
+000522d0: 7244 6963 7442 6173 652c 2074 656e 736f  rDictBase, tenso
+000522e0: 7264 6963 745f 7265 7365 743a 2054 656e  rdict_reset: Ten
+000522f0: 736f 7244 6963 7442 6173 650d 0a20 2020  sorDictBase..   
+00052300: 2029 202d 3e20 5465 6e73 6f72 4469 6374   ) -> TensorDict
+00052310: 4261 7365 3a0d 0a20 2020 2020 2020 2073  Base:..        s
+00052320: 656c 662e 5f76 616c 6964 6174 655f 636f  elf._validate_co
+00052330: 6e74 6169 6e65 7228 290d 0a20 2020 2020  ntainer()..     
+00052340: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+00052350: 7265 706c 6163 655f 6175 746f 5f72 6573  replace_auto_res
+00052360: 6574 5f76 616c 7328 7465 6e73 6f72 6469  et_vals(tensordi
+00052370: 6374 5f72 6573 6574 3d74 656e 736f 7264  ct_reset=tensord
+00052380: 6963 745f 7265 7365 7429 0d0a 0d0a 2020  ict_reset)....  
+00052390: 2020 6465 6620 5f73 7465 7028 0d0a 2020    def _step(..  
+000523a0: 2020 2020 2020 7365 6c66 2c20 7465 6e73        self, tens
+000523b0: 6f72 6469 6374 3a20 5465 6e73 6f72 4469  ordict: TensorDi
+000523c0: 6374 4261 7365 2c20 6e65 7874 5f74 656e  ctBase, next_ten
+000523d0: 736f 7264 6963 743a 2054 656e 736f 7244  sordict: TensorD
+000523e0: 6963 7442 6173 650d 0a20 2020 2029 202d  ictBase..    ) -
+000523f0: 3e20 5465 6e73 6f72 4469 6374 4261 7365  > TensorDictBase
+00052400: 3a0d 0a20 2020 2020 2020 2072 6574 7572  :..        retur
+00052410: 6e20 7365 6c66 2e5f 636f 7272 6563 745f  n self._correct_
+00052420: 6175 746f 5f72 6573 6574 5f76 616c 7328  auto_reset_vals(
+00052430: 6e65 7874 5f74 656e 736f 7264 6963 7429  next_tensordict)
+00052440: 0d0a 0d0a 2020 2020 6465 6620 666f 7277  ....    def forw
+00052450: 6172 6428 7365 6c66 2c20 7465 6e73 6f72  ard(self, tensor
+00052460: 6469 6374 3a20 5465 6e73 6f72 4469 6374  dict: TensorDict
+00052470: 4261 7365 2920 2d3e 2054 656e 736f 7244  Base) -> TensorD
+00052480: 6963 7442 6173 653a 0d0a 2020 2020 2020  ictBase:..      
+00052490: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
+000524a0: 7272 6f72 0d0a 0d0a 2020 2020 4070 726f  rror....    @pro
+000524b0: 7065 7274 790d 0a20 2020 2064 6566 205f  perty..    def _
+000524c0: 7369 6d70 6c65 5f64 6f6e 6528 7365 6c66  simple_done(self
+000524d0: 293a 0d0a 2020 2020 2020 2020 7265 7475  ):..        retu
+000524e0: 726e 2073 656c 662e 7061 7265 6e74 2e5f  rn self.parent._
+000524f0: 7369 6d70 6c65 5f64 6f6e 650d 0a0d 0a20  simple_done.... 
+00052500: 2020 2064 6566 205f 636f 7272 6563 745f     def _correct_
+00052510: 6175 746f 5f72 6573 6574 5f76 616c 7328  auto_reset_vals(
+00052520: 7365 6c66 2c20 7465 6e73 6f72 6469 6374  self, tensordict
+00052530: 293a 0d0a 2020 2020 2020 2020 2320 7765  ):..        # we
+00052540: 206e 6565 6420 746f 206d 6f76 6520 7468   need to move th
+00052550: 6520 6461 7461 2066 726f 6d20 7465 6e73  e data from tens
+00052560: 6f72 6469 6374 2074 6f20 7465 6e73 6f72  ordict to tensor
+00052570: 6469 6374 5f0d 0a20 2020 2020 2020 2064  dict_..        d
+00052580: 6566 2072 6570 6c61 6365 5f61 6e64 5f73  ef replace_and_s
+00052590: 6574 286b 6579 2c20 7661 6c2c 206d 6173  et(key, val, mas
+000525a0: 6b2c 2073 6176 6564 5f74 645f 6175 746f  k, saved_td_auto
+000525b0: 7265 7365 742c 2061 6765 6e74 3d74 656e  reset, agent=ten
+000525c0: 736f 7264 6963 7429 3a0d 0a20 2020 2020  sordict):..     
+000525d0: 2020 2020 2020 2073 6176 6564 5f74 645f         saved_td_
+000525e0: 6175 746f 7265 7365 742e 7365 7428 6b65  autoreset.set(ke
+000525f0: 792c 2076 616c 290d 0a20 2020 2020 2020  y, val)..       
+00052600: 2020 2020 2069 6620 7661 6c2e 6474 7970       if val.dtyp
+00052610: 652e 6973 5f66 6c6f 6174 696e 675f 706f  e.is_floating_po
+00052620: 696e 743a 0d0a 2020 2020 2020 2020 2020  int:..          
+00052630: 2020 2020 2020 6966 2073 656c 662e 6669        if self.fi
+00052640: 6c6c 5f66 6c6f 6174 2069 7320 4e6f 6e65  ll_float is None
+00052650: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+00052660: 2020 2020 2020 2076 616c 5f73 6574 5f6e         val_set_n
+00052670: 616e 203d 2076 616c 2e63 6c6f 6e65 2829  an = val.clone()
+00052680: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00052690: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
+000526a0: 2020 2020 2020 2020 2020 2020 2076 616c               val
+000526b0: 5f73 6574 5f6e 616e 203d 2074 6f72 6368  _set_nan = torch
+000526c0: 2e77 6865 7265 280d 0a20 2020 2020 2020  .where(..       
+000526d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000526e0: 2065 7870 616e 645f 6173 5f72 6967 6874   expand_as_right
+000526f0: 286d 6173 6b2c 2076 616c 292c 0d0a 2020  (mask, val),..  
 00052700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052710: 2065 7870 616e 645f 6173 5f72 6967 6874   expand_as_right
-00052720: 286d 6173 6b2c 2076 616c 292c 0d0a 2020  (mask, val),..  
-00052730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052740: 2020 2020 2020 746f 7263 682e 6675 6c6c        torch.full
-00052750: 5f6c 696b 6528 7661 6c2c 2073 656c 662e  _like(val, self.
-00052760: 6669 6c6c 5f62 6f6f 6c29 2c0d 0a20 2020  fill_bool),..   
-00052770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052780: 2020 2020 2076 616c 2c0d 0a20 2020 2020       val,..     
-00052790: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-000527a0: 0d0a 2020 2020 2020 2020 2020 2020 6167  ..            ag
-000527b0: 656e 742e 7365 7428 6b65 792c 2076 616c  ent.set(key, val
-000527c0: 5f73 6574 5f6e 616e 290d 0a0d 0a20 2020  _set_nan)....   
-000527d0: 2020 2020 2069 6620 7365 6c66 2e5f 7369       if self._si
-000527e0: 6d70 6c65 5f64 6f6e 653a 0d0a 2020 2020  mple_done:..    
-000527f0: 2020 2020 2020 2020 646f 6e65 203d 2074          done = t
-00052800: 656e 736f 7264 6963 742e 6765 7428 2264  ensordict.get("d
-00052810: 6f6e 6522 290d 0a20 2020 2020 2020 2020  one")..         
-00052820: 2020 2069 6620 646f 6e65 2e61 6e79 2829     if done.any()
-00052830: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-00052840: 2020 206d 6173 6b20 3d20 646f 6e65 2e73     mask = done.s
-00052850: 7175 6565 7a65 282d 3129 0d0a 2020 2020  queeze(-1)..    
-00052860: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00052870: 2e5f 7361 7665 645f 7464 5f61 7574 6f72  ._saved_td_autor
-00052880: 6573 7420 3d20 5465 6e73 6f72 4469 6374  est = TensorDict
-00052890: 287b 7d2c 205b 5d29 0d0a 2020 2020 2020  ({}, [])..      
-000528a0: 2020 2020 2020 2020 2020 666f 7220 6b65            for ke
-000528b0: 7920 696e 2073 656c 662e 7061 7265 6e74  y in self.parent
-000528c0: 2e66 756c 6c5f 6f62 7365 7276 6174 696f  .full_observatio
-000528d0: 6e5f 7370 6563 2e6b 6579 7328 5472 7565  n_spec.keys(True
-000528e0: 2c20 5472 7565 293a 0d0a 2020 2020 2020  , True):..      
-000528f0: 2020 2020 2020 2020 2020 2020 2020 7661                va
-00052900: 6c20 3d20 7465 6e73 6f72 6469 6374 2e67  l = tensordict.g
-00052910: 6574 286b 6579 290d 0a20 2020 2020 2020  et(key)..       
-00052920: 2020 2020 2020 2020 2020 2020 2072 6570               rep
-00052930: 6c61 6365 5f61 6e64 5f73 6574 280d 0a20  lace_and_set(.. 
-00052940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052950: 2020 2020 2020 206b 6579 2c20 7661 6c2c         key, val,
-00052960: 206d 6173 6b2c 2073 6176 6564 5f74 645f   mask, saved_td_
-00052970: 6175 746f 7265 7365 743d 7365 6c66 2e5f  autoreset=self._
-00052980: 7361 7665 645f 7464 5f61 7574 6f72 6573  saved_td_autores
-00052990: 740d 0a20 2020 2020 2020 2020 2020 2020  t..             
-000529a0: 2020 2020 2020 2029 0d0a 2020 2020 2020         )..      
-000529b0: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
-000529c0: 2020 2020 2070 6172 656e 7473 203d 205b       parents = [
-000529d0: 5d0d 0a20 2020 2020 2020 2020 2020 2023  ]..            #
-000529e0: 2047 6f20 7468 726f 7567 6820 6561 6368   Go through each
-000529f0: 2022 646f 6e65 2220 6b65 7920 616e 6420   "done" key and 
-00052a00: 6765 7420 7468 6520 636f 7272 6573 706f  get the correspo
-00052a10: 6e64 696e 6720 6167 656e 742e 0d0a 2020  nding agent...  
-00052a20: 2020 2020 2020 2020 2020 5f73 6176 6564            _saved
-00052a30: 5f74 645f 6175 746f 7265 7374 203d 204e  _td_autorest = N
-00052a40: 6f6e 650d 0a20 2020 2020 2020 2020 2020  one..           
-00052a50: 206f 6273 5f6b 6579 7320 3d20 6c69 7374   obs_keys = list
-00052a60: 2873 656c 662e 7061 7265 6e74 2e66 756c  (self.parent.ful
-00052a70: 6c5f 6f62 7365 7276 6174 696f 6e5f 7370  l_observation_sp
-00052a80: 6563 2e6b 6579 7328 5472 7565 2c20 5472  ec.keys(True, Tr
-00052a90: 7565 2929 0d0a 2020 2020 2020 2020 2020  ue))..          
-00052aa0: 2020 666f 7220 646f 6e65 5f6b 6579 2069    for done_key i
-00052ab0: 6e20 7365 6c66 2e70 6172 656e 742e 646f  n self.parent.do
-00052ac0: 6e65 5f6b 6579 733a 0d0a 2020 2020 2020  ne_keys:..      
-00052ad0: 2020 2020 2020 2020 2020 6966 205f 656e            if _en
-00052ae0: 6473 5f77 6974 6828 646f 6e65 5f6b 6579  ds_with(done_key
-00052af0: 2c20 2264 6f6e 6522 293a 0d0a 2020 2020  , "done"):..    
-00052b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052b10: 6966 2069 7369 6e73 7461 6e63 6528 646f  if isinstance(do
-00052b20: 6e65 5f6b 6579 2c20 7374 7229 3a0d 0a20  ne_key, str):.. 
-00052b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052b40: 2020 2020 2020 2072 6169 7365 2054 7970         raise Typ
-00052b50: 6545 7272 6f72 280d 0a20 2020 2020 2020  eError(..       
-00052b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052b70: 2020 2020 2022 4120 2764 6f6e 6527 206b       "A 'done' k
-00052b80: 6579 2077 6173 2061 2073 7472 696e 6720  ey was a string 
-00052b90: 6275 7420 6120 7475 706c 6520 7761 7320  but a tuple was 
-00052ba0: 6578 7065 6374 6564 2e22 0d0a 2020 2020  expected."..    
-00052bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052bc0: 2020 2020 290d 0a20 2020 2020 2020 2020      )..         
-00052bd0: 2020 2020 2020 2020 2020 2061 6765 6e74             agent
-00052be0: 5f6b 6579 203d 2064 6f6e 655f 6b65 795b  _key = done_key[
-00052bf0: 3a2d 315d 0d0a 2020 2020 2020 2020 2020  :-1]..          
-00052c00: 2020 2020 2020 2020 2020 646f 6e65 203d            done =
-00052c10: 2074 656e 736f 7264 6963 742e 6765 7428   tensordict.get(
-00052c20: 646f 6e65 5f6b 6579 290d 0a20 2020 2020  done_key)..     
-00052c30: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00052c40: 6173 6b20 3d20 646f 6e65 2e73 7175 6565  ask = done.squee
-00052c50: 7a65 282d 3129 0d0a 2020 2020 2020 2020  ze(-1)..        
-00052c60: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-00052c70: 6f6e 652e 616e 7928 293a 0d0a 2020 2020  one.any():..    
-00052c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052c90: 2020 2020 6966 205f 7361 7665 645f 7464      if _saved_td
-00052ca0: 5f61 7574 6f72 6573 7420 6973 204e 6f6e  _autorest is Non
-00052cb0: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
-00052cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052cd0: 5f73 6176 6564 5f74 645f 6175 746f 7265  _saved_td_autore
-00052ce0: 7374 203d 2054 656e 736f 7244 6963 7428  st = TensorDict(
-00052cf0: 7b7d 2c20 6261 7463 685f 7369 7a65 3d5b  {}, batch_size=[
-00052d00: 5d29 0d0a 2020 2020 2020 2020 2020 2020  ])..            
-00052d10: 2020 2020 2020 2020 2020 2020 6167 656e              agen
-00052d20: 7420 3d20 7465 6e73 6f72 6469 6374 2e67  t = tensordict.g
-00052d30: 6574 2861 6765 6e74 5f6b 6579 290d 0a20  et(agent_key).. 
-00052d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052d50: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-00052d60: 616e 6365 2861 6765 6e74 2c20 4c61 7a79  ance(agent, Lazy
-00052d70: 5374 6163 6b65 6454 656e 736f 7244 6963  StackedTensorDic
-00052d80: 7429 3a0d 0a20 2020 2020 2020 2020 2020  t):..           
-00052d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052da0: 2061 6765 6e74 7320 3d20 6167 656e 742e   agents = agent.
-00052db0: 7465 6e73 6f72 6469 6374 730d 0a20 2020  tensordicts..   
-00052dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052dd0: 2020 2020 2020 2020 206d 6173 6b73 203d           masks =
-00052de0: 206d 6173 6b2e 756e 6269 6e64 2861 6765   mask.unbind(age
-00052df0: 6e74 2e73 7461 636b 5f64 696d 290d 0a20  nt.stack_dim).. 
+00052710: 2020 2020 2020 746f 7263 682e 6675 6c6c        torch.full
+00052720: 5f6c 696b 6528 7661 6c2c 2073 656c 662e  _like(val, self.
+00052730: 6669 6c6c 5f66 6c6f 6174 292c 0d0a 2020  fill_float),..  
+00052740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052750: 2020 2020 2020 7661 6c2c 0d0a 2020 2020        val,..    
+00052760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052770: 290d 0a20 2020 2020 2020 2020 2020 2065  )..            e
+00052780: 6c69 6620 7661 6c2e 6474 7970 652e 6973  lif val.dtype.is
+00052790: 5f73 6967 6e65 643a 0d0a 2020 2020 2020  _signed:..      
+000527a0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+000527b0: 662e 6669 6c6c 5f69 6e74 2069 7320 4e6f  f.fill_int is No
+000527c0: 6e65 3a0d 0a20 2020 2020 2020 2020 2020  ne:..           
+000527d0: 2020 2020 2020 2020 2076 616c 5f73 6574           val_set
+000527e0: 5f6e 616e 203d 2076 616c 2e63 6c6f 6e65  _nan = val.clone
+000527f0: 2829 0d0a 2020 2020 2020 2020 2020 2020  ()..            
+00052800: 2020 2020 656c 7365 3a0d 0a20 2020 2020      else:..     
+00052810: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+00052820: 616c 5f73 6574 5f6e 616e 203d 2074 6f72  al_set_nan = tor
+00052830: 6368 2e77 6865 7265 280d 0a20 2020 2020  ch.where(..     
+00052840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052850: 2020 2065 7870 616e 645f 6173 5f72 6967     expand_as_rig
+00052860: 6874 286d 6173 6b2c 2076 616c 292c 0d0a  ht(mask, val),..
+00052870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052880: 2020 2020 2020 2020 746f 7263 682e 6675          torch.fu
+00052890: 6c6c 5f6c 696b 6528 7661 6c2c 2073 656c  ll_like(val, sel
+000528a0: 662e 6669 6c6c 5f69 6e74 292c 0d0a 2020  f.fill_int),..  
+000528b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000528c0: 2020 2020 2020 7661 6c2c 0d0a 2020 2020        val,..    
+000528d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000528e0: 290d 0a20 2020 2020 2020 2020 2020 2065  )..            e
+000528f0: 6c73 653a 0d0a 2020 2020 2020 2020 2020  lse:..          
+00052900: 2020 2020 2020 6966 2073 656c 662e 6669        if self.fi
+00052910: 6c6c 5f62 6f6f 6c20 6973 204e 6f6e 653a  ll_bool is None:
+00052920: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00052930: 2020 2020 2020 7661 6c5f 7365 745f 6e61        val_set_na
+00052940: 6e20 3d20 7661 6c2e 636c 6f6e 6528 290d  n = val.clone().
+00052950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00052960: 2065 6c73 653a 0d0a 2020 2020 2020 2020   else:..        
+00052970: 2020 2020 2020 2020 2020 2020 7661 6c5f              val_
+00052980: 7365 745f 6e61 6e20 3d20 746f 7263 682e  set_nan = torch.
+00052990: 7768 6572 6528 0d0a 2020 2020 2020 2020  where(..        
+000529a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000529b0: 6578 7061 6e64 5f61 735f 7269 6768 7428  expand_as_right(
+000529c0: 6d61 736b 2c20 7661 6c29 2c0d 0a20 2020  mask, val),..   
+000529d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000529e0: 2020 2020 2074 6f72 6368 2e66 756c 6c5f       torch.full_
+000529f0: 6c69 6b65 2876 616c 2c20 7365 6c66 2e66  like(val, self.f
+00052a00: 696c 6c5f 626f 6f6c 292c 0d0a 2020 2020  ill_bool),..    
+00052a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052a20: 2020 2020 7661 6c2c 0d0a 2020 2020 2020      val,..      
+00052a30: 2020 2020 2020 2020 2020 2020 2020 290d                ).
+00052a40: 0a20 2020 2020 2020 2020 2020 2061 6765  .            age
+00052a50: 6e74 2e73 6574 286b 6579 2c20 7661 6c5f  nt.set(key, val_
+00052a60: 7365 745f 6e61 6e29 0d0a 0d0a 2020 2020  set_nan)....    
+00052a70: 2020 2020 6966 2073 656c 662e 5f73 696d      if self._sim
+00052a80: 706c 655f 646f 6e65 3a0d 0a20 2020 2020  ple_done:..     
+00052a90: 2020 2020 2020 2064 6f6e 6520 3d20 7465         done = te
+00052aa0: 6e73 6f72 6469 6374 2e67 6574 2822 646f  nsordict.get("do
+00052ab0: 6e65 2229 0d0a 2020 2020 2020 2020 2020  ne")..          
+00052ac0: 2020 6966 2064 6f6e 652e 616e 7928 293a    if done.any():
+00052ad0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00052ae0: 2020 6d61 736b 203d 2064 6f6e 652e 7371    mask = done.sq
+00052af0: 7565 657a 6528 2d31 290d 0a20 2020 2020  ueeze(-1)..     
+00052b00: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00052b10: 5f73 6176 6564 5f74 645f 6175 746f 7265  _saved_td_autore
+00052b20: 7374 203d 2054 656e 736f 7244 6963 7428  st = TensorDict(
+00052b30: 7b7d 2c20 5b5d 290d 0a20 2020 2020 2020  {}, [])..       
+00052b40: 2020 2020 2020 2020 2066 6f72 206b 6579           for key
+00052b50: 2069 6e20 7365 6c66 2e70 6172 656e 742e   in self.parent.
+00052b60: 6675 6c6c 5f6f 6273 6572 7661 7469 6f6e  full_observation
+00052b70: 5f73 7065 632e 6b65 7973 2854 7275 652c  _spec.keys(True,
+00052b80: 2054 7275 6529 3a0d 0a20 2020 2020 2020   True):..       
+00052b90: 2020 2020 2020 2020 2020 2020 2076 616c               val
+00052ba0: 203d 2074 656e 736f 7264 6963 742e 6765   = tensordict.ge
+00052bb0: 7428 6b65 7929 0d0a 2020 2020 2020 2020  t(key)..        
+00052bc0: 2020 2020 2020 2020 2020 2020 7265 706c              repl
+00052bd0: 6163 655f 616e 645f 7365 7428 0d0a 2020  ace_and_set(..  
+00052be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052bf0: 2020 2020 2020 6b65 792c 2076 616c 2c20        key, val, 
+00052c00: 6d61 736b 2c20 7361 7665 645f 7464 5f61  mask, saved_td_a
+00052c10: 7574 6f72 6573 6574 3d73 656c 662e 5f73  utoreset=self._s
+00052c20: 6176 6564 5f74 645f 6175 746f 7265 7374  aved_td_autorest
+00052c30: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00052c40: 2020 2020 2020 290d 0a20 2020 2020 2020        )..       
+00052c50: 2065 6c73 653a 0d0a 2020 2020 2020 2020   else:..        
+00052c60: 2020 2020 7061 7265 6e74 7320 3d20 5b5d      parents = []
+00052c70: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00052c80: 476f 2074 6872 6f75 6768 2065 6163 6820  Go through each 
+00052c90: 2264 6f6e 6522 206b 6579 2061 6e64 2067  "done" key and g
+00052ca0: 6574 2074 6865 2063 6f72 7265 7370 6f6e  et the correspon
+00052cb0: 6469 6e67 2061 6765 6e74 2e0d 0a20 2020  ding agent...   
+00052cc0: 2020 2020 2020 2020 205f 7361 7665 645f           _saved_
+00052cd0: 7464 5f61 7574 6f72 6573 7420 3d20 4e6f  td_autorest = No
+00052ce0: 6e65 0d0a 2020 2020 2020 2020 2020 2020  ne..            
+00052cf0: 6f62 735f 6b65 7973 203d 206c 6973 7428  obs_keys = list(
+00052d00: 7365 6c66 2e70 6172 656e 742e 6675 6c6c  self.parent.full
+00052d10: 5f6f 6273 6572 7661 7469 6f6e 5f73 7065  _observation_spe
+00052d20: 632e 6b65 7973 2854 7275 652c 2054 7275  c.keys(True, Tru
+00052d30: 6529 290d 0a20 2020 2020 2020 2020 2020  e))..           
+00052d40: 2066 6f72 2064 6f6e 655f 6b65 7920 696e   for done_key in
+00052d50: 2073 656c 662e 7061 7265 6e74 2e64 6f6e   self.parent.don
+00052d60: 655f 6b65 7973 3a0d 0a20 2020 2020 2020  e_keys:..       
+00052d70: 2020 2020 2020 2020 2069 6620 5f65 6e64           if _end
+00052d80: 735f 7769 7468 2864 6f6e 655f 6b65 792c  s_with(done_key,
+00052d90: 2022 646f 6e65 2229 3a0d 0a20 2020 2020   "done"):..     
+00052da0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00052db0: 6620 6973 696e 7374 616e 6365 2864 6f6e  f isinstance(don
+00052dc0: 655f 6b65 792c 2073 7472 293a 0d0a 2020  e_key, str):..  
+00052dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052de0: 2020 2020 2020 7261 6973 6520 5479 7065        raise Type
+00052df0: 4572 726f 7228 0d0a 2020 2020 2020 2020  Error(..        
 00052e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052e10: 2020 2020 2020 2020 2020 2073 6176 6564             saved
-00052e20: 5f74 645f 6175 746f 7265 7374 5f61 6765  _td_autorest_age
-00052e30: 6e74 203d 204c 617a 7953 7461 636b 6564  nt = LazyStacked
-00052e40: 5465 6e73 6f72 4469 6374 280d 0a20 2020  TensorDict(..   
+00052e10: 2020 2020 2241 2027 646f 6e65 2720 6b65      "A 'done' ke
+00052e20: 7920 7761 7320 6120 7374 7269 6e67 2062  y was a string b
+00052e30: 7574 2061 2074 7570 6c65 2077 6173 2065  ut a tuple was e
+00052e40: 7870 6563 7465 642e 220d 0a20 2020 2020  xpected."..     
 00052e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052e60: 2020 2020 2020 2020 2020 2020 202a 5b74               *[t
-00052e70: 642e 656d 7074 7928 2920 666f 7220 7464  d.empty() for td
-00052e80: 2069 6e20 6167 656e 7473 5d2c 0d0a 2020   in agents],..  
-00052e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052ea0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00052eb0: 6163 6b5f 6469 6d3d 6167 656e 742e 7374  ack_dim=agent.st
-00052ec0: 6163 6b5f 6469 6d2c 0d0a 2020 2020 2020  ack_dim,..      
-00052ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052ee0: 2020 2020 2020 290d 0a20 2020 2020 2020        )..       
-00052ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052f00: 2020 2020 2073 6176 6564 5f74 645f 6175       saved_td_au
-00052f10: 746f 7265 7374 5f61 6765 6e74 7320 3d20  torest_agents = 
-00052f20: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
-00052f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052f40: 2020 2073 6176 6564 5f74 645f 6175 746f     saved_td_auto
-00052f50: 7265 7374 5f61 6765 6e74 2e74 656e 736f  rest_agent.tenso
-00052f60: 7264 6963 7473 0d0a 2020 2020 2020 2020  rdicts..        
-00052f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052f80: 2020 2020 290d 0a20 2020 2020 2020 2020      )..         
-00052f90: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00052fa0: 6c73 653a 0d0a 2020 2020 2020 2020 2020  lse:..          
-00052fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052fc0: 2020 6167 656e 7473 203d 205b 6167 656e    agents = [agen
-00052fd0: 745d 0d0a 2020 2020 2020 2020 2020 2020  t]..            
+00052e60: 2020 2029 0d0a 2020 2020 2020 2020 2020     )..          
+00052e70: 2020 2020 2020 2020 2020 6167 656e 745f            agent_
+00052e80: 6b65 7920 3d20 646f 6e65 5f6b 6579 5b3a  key = done_key[:
+00052e90: 2d31 5d0d 0a20 2020 2020 2020 2020 2020  -1]..           
+00052ea0: 2020 2020 2020 2020 2064 6f6e 6520 3d20           done = 
+00052eb0: 7465 6e73 6f72 6469 6374 2e67 6574 2864  tensordict.get(d
+00052ec0: 6f6e 655f 6b65 7929 0d0a 2020 2020 2020  one_key)..      
+00052ed0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00052ee0: 736b 203d 2064 6f6e 652e 7371 7565 657a  sk = done.squeez
+00052ef0: 6528 2d31 290d 0a20 2020 2020 2020 2020  e(-1)..         
+00052f00: 2020 2020 2020 2020 2020 2069 6620 646f             if do
+00052f10: 6e65 2e61 6e79 2829 3a0d 0a20 2020 2020  ne.any():..     
+00052f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052f30: 2020 2069 6620 5f73 6176 6564 5f74 645f     if _saved_td_
+00052f40: 6175 746f 7265 7374 2069 7320 4e6f 6e65  autorest is None
+00052f50: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+00052f60: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+00052f70: 7361 7665 645f 7464 5f61 7574 6f72 6573  saved_td_autores
+00052f80: 7420 3d20 5465 6e73 6f72 4469 6374 287b  t = TensorDict({
+00052f90: 7d2c 2062 6174 6368 5f73 697a 653d 5b5d  }, batch_size=[]
+00052fa0: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+00052fb0: 2020 2020 2020 2020 2020 2061 6765 6e74             agent
+00052fc0: 203d 2074 656e 736f 7264 6963 742e 6765   = tensordict.ge
+00052fd0: 7428 6167 656e 745f 6b65 7929 0d0a 2020  t(agent_key)..  
 00052fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052ff0: 6d61 736b 7320 3d20 5b6d 6173 6b5d 0d0a  masks = [mask]..
-00053000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053010: 2020 2020 2020 2020 2020 2020 7361 7665              save
-00053020: 645f 7464 5f61 7574 6f72 6573 745f 6167  d_td_autorest_ag
-00053030: 656e 7420 3d20 5f73 6176 6564 5f74 645f  ent = _saved_td_
-00053040: 6175 746f 7265 7374 2e73 6574 6465 6661  autorest.setdefa
-00053050: 756c 7428 0d0a 2020 2020 2020 2020 2020  ult(..          
+00052ff0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00053000: 6e63 6528 6167 656e 742c 204c 617a 7953  nce(agent, LazyS
+00053010: 7461 636b 6564 5465 6e73 6f72 4469 6374  tackedTensorDict
+00053020: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
+00053030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053040: 6167 656e 7473 203d 2061 6765 6e74 2e74  agents = agent.t
+00053050: 656e 736f 7264 6963 7473 0d0a 2020 2020  ensordicts..    
 00053060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053070: 2020 2020 2020 6167 656e 745f 6b65 792c        agent_key,
-00053080: 2061 6765 6e74 2e65 6d70 7479 2829 0d0a   agent.empty()..
-00053090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000530a0: 2020 2020 2020 2020 2020 2020 290d 0a20              ).. 
-000530b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000530c0: 2020 2020 2020 2020 2020 2073 6176 6564             saved
-000530d0: 5f74 645f 6175 746f 7265 7374 5f61 6765  _td_autorest_age
-000530e0: 6e74 7320 3d20 5b73 6176 6564 5f74 645f  nts = [saved_td_
-000530f0: 6175 746f 7265 7374 5f61 6765 6e74 5d0d  autorest_agent].
-00053100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00053110: 2020 2020 2020 2020 2066 6f72 206b 6579           for key
-00053120: 2069 6e20 6f62 735f 6b65 7973 3a0d 0a20   in obs_keys:.. 
+00053070: 2020 2020 2020 2020 6d61 736b 7320 3d20          masks = 
+00053080: 6d61 736b 2e75 6e62 696e 6428 6167 656e  mask.unbind(agen
+00053090: 742e 7374 6163 6b5f 6469 6d29 0d0a 2020  t.stack_dim)..  
+000530a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000530b0: 2020 2020 2020 2020 2020 7361 7665 645f            saved_
+000530c0: 7464 5f61 7574 6f72 6573 745f 6167 656e  td_autorest_agen
+000530d0: 7420 3d20 4c61 7a79 5374 6163 6b65 6454  t = LazyStackedT
+000530e0: 656e 736f 7244 6963 7428 0d0a 2020 2020  ensorDict(..    
+000530f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053100: 2020 2020 2020 2020 2020 2020 2a5b 7464              *[td
+00053110: 2e65 6d70 7479 2829 2066 6f72 2074 6420  .empty() for td 
+00053120: 696e 2061 6765 6e74 735d 2c0d 0a20 2020  in agents],..   
 00053130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053140: 2020 2020 2020 2020 2020 2069 6620 280d             if (.
-00053150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00053160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053170: 2069 7369 6e73 7461 6e63 6528 6b65 792c   isinstance(key,
-00053180: 2074 7570 6c65 290d 0a20 2020 2020 2020   tuple)..       
+00053140: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+00053150: 636b 5f64 696d 3d61 6765 6e74 2e73 7461  ck_dim=agent.sta
+00053160: 636b 5f64 696d 2c0d 0a20 2020 2020 2020  ck_dim,..       
+00053170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053180: 2020 2020 2029 0d0a 2020 2020 2020 2020       )..        
 00053190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000531a0: 2020 2020 2020 2020 2061 6e64 206b 6579           and key
-000531b0: 5b3a 206c 656e 2861 6765 6e74 5f6b 6579  [: len(agent_key
-000531c0: 295d 203d 3d20 6167 656e 745f 6b65 790d  )] == agent_key.
-000531d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000531e0: 2020 2020 2020 2020 2020 2020 2029 3a0d               ):.
-000531f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00053200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053210: 2066 6f72 205f 6167 656e 742c 205f 6d61   for _agent, _ma
-00053220: 736b 2c20 5f73 6176 6564 5f74 645f 6175  sk, _saved_td_au
-00053230: 746f 7265 7374 5f61 6765 6e74 2069 6e20  torest_agent in 
-00053240: 7a69 7028 0d0a 2020 2020 2020 2020 2020  zip(..          
+000531a0: 2020 2020 7361 7665 645f 7464 5f61 7574      saved_td_aut
+000531b0: 6f72 6573 745f 6167 656e 7473 203d 2028  orest_agents = (
+000531c0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000531d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000531e0: 2020 7361 7665 645f 7464 5f61 7574 6f72    saved_td_autor
+000531f0: 6573 745f 6167 656e 742e 7465 6e73 6f72  est_agent.tensor
+00053200: 6469 6374 730d 0a20 2020 2020 2020 2020  dicts..         
+00053210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053220: 2020 2029 0d0a 2020 2020 2020 2020 2020     )..          
+00053230: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00053240: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
 00053250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053260: 2020 2020 2020 2020 2020 6167 656e 7473            agents
-00053270: 2c20 6d61 736b 732c 2073 6176 6564 5f74  , masks, saved_t
-00053280: 645f 6175 746f 7265 7374 5f61 6765 6e74  d_autorest_agent
-00053290: 730d 0a20 2020 2020 2020 2020 2020 2020  s..             
+00053260: 2061 6765 6e74 7320 3d20 5b61 6765 6e74   agents = [agent
+00053270: 5d0d 0a20 2020 2020 2020 2020 2020 2020  ]..             
+00053280: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00053290: 6173 6b73 203d 205b 6d61 736b 5d0d 0a20  asks = [mask].. 
 000532a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000532b0: 2020 2029 3a0d 0a20 2020 2020 2020 2020     ):..         
-000532c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000532d0: 2020 2020 2020 2020 2020 2076 616c 203d             val =
-000532e0: 205f 6167 656e 742e 6765 7428 6b65 795b   _agent.get(key[
-000532f0: 6c65 6e28 6167 656e 745f 6b65 7929 203a  len(agent_key) :
-00053300: 5d29 0d0a 2020 2020 2020 2020 2020 2020  ])..            
-00053310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053320: 2020 2020 2020 2020 7265 706c 6163 655f          replace_
-00053330: 616e 645f 7365 7428 0d0a 2020 2020 2020  and_set(..      
-00053340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000532b0: 2020 2020 2020 2020 2020 2073 6176 6564             saved
+000532c0: 5f74 645f 6175 746f 7265 7374 5f61 6765  _td_autorest_age
+000532d0: 6e74 203d 205f 7361 7665 645f 7464 5f61  nt = _saved_td_a
+000532e0: 7574 6f72 6573 742e 7365 7464 6566 6175  utorest.setdefau
+000532f0: 6c74 280d 0a20 2020 2020 2020 2020 2020  lt(..           
+00053300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053310: 2020 2020 2061 6765 6e74 5f6b 6579 2c20       agent_key, 
+00053320: 6167 656e 742e 656d 7074 7928 290d 0a20  agent.empty().. 
+00053330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053340: 2020 2020 2020 2020 2020 2029 0d0a 2020             )..  
 00053350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053360: 2020 6b65 795b 6c65 6e28 6167 656e 745f    key[len(agent_
-00053370: 6b65 7929 203a 5d2c 0d0a 2020 2020 2020  key) :],..      
-00053380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000533a0: 2020 7661 6c2c 0d0a 2020 2020 2020 2020    val,..        
-000533b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000533c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000533d0: 5f6d 6173 6b2c 0d0a 2020 2020 2020 2020  _mask,..        
-000533e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053360: 2020 2020 2020 2020 2020 7361 7665 645f            saved_
+00053370: 7464 5f61 7574 6f72 6573 745f 6167 656e  td_autorest_agen
+00053380: 7473 203d 205b 7361 7665 645f 7464 5f61  ts = [saved_td_a
+00053390: 7574 6f72 6573 745f 6167 656e 745d 0d0a  utorest_agent]..
+000533a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000533b0: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
+000533c0: 696e 206f 6273 5f6b 6579 733a 0d0a 2020  in obs_keys:..  
+000533d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000533e0: 2020 2020 2020 2020 2020 6966 2028 0d0a            if (..
 000533f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053400: 7361 7665 645f 7464 5f61 7574 6f72 6573  saved_td_autores
-00053410: 6574 3d5f 7361 7665 645f 7464 5f61 7574  et=_saved_td_aut
-00053420: 6f72 6573 745f 6167 656e 742c 0d0a 2020  orest_agent,..  
+00053400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053410: 6973 696e 7374 616e 6365 286b 6579 2c20  isinstance(key, 
+00053420: 7475 706c 6529 0d0a 2020 2020 2020 2020  tuple)..        
 00053430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053450: 2020 2020 2020 6167 656e 743d 5f61 6765        agent=_age
-00053460: 6e74 2c0d 0a20 2020 2020 2020 2020 2020  nt,..           
+00053440: 2020 2020 2020 2020 616e 6420 6b65 795b          and key[
+00053450: 3a20 6c65 6e28 6167 656e 745f 6b65 7929  : len(agent_key)
+00053460: 5d20 3d3d 2061 6765 6e74 5f6b 6579 0d0a  ] == agent_key..
 00053470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053480: 2020 2020 2020 2020 2029 0d0a 2020 2020           )..    
+00053480: 2020 2020 2020 2020 2020 2020 293a 0d0a              ):..
 00053490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000534a0: 7061 7265 6e74 732e 6170 7065 6e64 2864  parents.append(d
-000534b0: 6f6e 655f 6b65 795b 3a2d 315d 290d 0a20  one_key[:-1]).. 
-000534c0: 2020 2020 2020 2020 2020 2069 6620 5f73             if _s
-000534d0: 6176 6564 5f74 645f 6175 746f 7265 7374  aved_td_autorest
-000534e0: 2069 7320 6e6f 7420 4e6f 6e65 3a0d 0a20   is not None:.. 
-000534f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00053500: 656c 662e 5f5f 6469 6374 5f5f 5b22 5f73  elf.__dict__["_s
-00053510: 6176 6564 5f74 645f 6175 746f 7265 7374  aved_td_autorest
-00053520: 225d 203d 205f 7361 7665 645f 7464 5f61  "] = _saved_td_a
-00053530: 7574 6f72 6573 740d 0a0d 0a20 2020 2020  utorest....     
-00053540: 2020 2072 6574 7572 6e20 7465 6e73 6f72     return tensor
-00053550: 6469 6374 0d0a 0d0a 2020 2020 6465 6620  dict....    def 
-00053560: 5f72 6570 6c61 6365 5f61 7574 6f5f 7265  _replace_auto_re
-00053570: 7365 745f 7661 6c73 2873 656c 662c 202a  set_vals(self, *
-00053580: 2c20 7465 6e73 6f72 6469 6374 5f72 6573  , tensordict_res
-00053590: 6574 293a 0d0a 2020 2020 2020 2020 5f73  et):..        _s
-000535a0: 6176 6564 5f74 645f 6175 746f 7265 7374  aved_td_autorest
-000535b0: 203d 2073 656c 662e 5f5f 6469 6374 5f5f   = self.__dict__
-000535c0: 2e67 6574 2822 5f73 6176 6564 5f74 645f  .get("_saved_td_
-000535d0: 6175 746f 7265 7374 222c 204e 6f6e 6529  autorest", None)
-000535e0: 0d0a 2020 2020 2020 2020 6966 205f 7361  ..        if _sa
-000535f0: 7665 645f 7464 5f61 7574 6f72 6573 7420  ved_td_autorest 
-00053600: 6973 204e 6f6e 653a 0d0a 2020 2020 2020  is None:..      
-00053610: 2020 2020 2020 7265 7475 726e 2074 656e        return ten
-00053620: 736f 7264 6963 745f 7265 7365 740d 0a20  sordict_reset.. 
-00053630: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
-00053640: 7369 6d70 6c65 5f64 6f6e 653a 0d0a 2020  simple_done:..  
-00053650: 2020 2020 2020 2020 2020 666f 7220 6b65            for ke
-00053660: 792c 2076 616c 2069 6e20 7365 6c66 2e5f  y, val in self._
-00053670: 7361 7665 645f 7464 5f61 7574 6f72 6573  saved_td_autores
-00053680: 742e 6974 656d 7328 5472 7565 2c20 5472  t.items(True, Tr
-00053690: 7565 293a 0d0a 2020 2020 2020 2020 2020  ue):..          
-000536a0: 2020 2020 2020 6966 205f 656e 6473 5f77        if _ends_w
-000536b0: 6974 6828 6b65 792c 2022 5f72 6573 6574  ith(key, "_reset
-000536c0: 2229 3a0d 0a20 2020 2020 2020 2020 2020  "):..           
-000536d0: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
-000536e0: 650d 0a20 2020 2020 2020 2020 2020 2020  e..             
-000536f0: 2020 2076 616c 5f73 6574 5f72 6567 203d     val_set_reg =
-00053700: 2076 616c 0d0a 2020 2020 2020 2020 2020   val..          
-00053710: 2020 2020 2020 7465 6e73 6f72 6469 6374        tensordict
-00053720: 5f72 6573 6574 2e73 6574 286b 6579 2c20  _reset.set(key, 
-00053730: 7661 6c5f 7365 745f 7265 6729 0d0a 2020  val_set_reg)..  
-00053740: 2020 2020 2020 656c 7365 3a0d 0a20 2020        else:..   
-00053750: 2020 2020 2020 2020 2066 6f72 2064 6f6e           for don
-00053760: 655f 6b65 7920 696e 2073 656c 662e 7061  e_key in self.pa
-00053770: 7265 6e74 2e64 6f6e 655f 6b65 7973 3a0d  rent.done_keys:.
-00053780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00053790: 2069 6620 5f65 6e64 735f 7769 7468 2864   if _ends_with(d
-000537a0: 6f6e 655f 6b65 792c 2022 646f 6e65 2229  one_key, "done")
-000537b0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-000537c0: 2020 2020 2020 2061 6765 6e74 5f6b 6579         agent_key
-000537d0: 203d 2064 6f6e 655f 6b65 795b 3a2d 315d   = done_key[:-1]
-000537e0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000537f0: 2020 2020 2020 6d61 736b 203d 2073 656c        mask = sel
-00053800: 662e 5f73 6176 6564 5f74 645f 6175 746f  f._saved_td_auto
-00053810: 7265 7374 2e70 6f70 280d 0a20 2020 2020  rest.pop(..     
-00053820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053830: 2020 205f 7265 706c 6163 655f 6c61 7374     _replace_last
-00053840: 2864 6f6e 655f 6b65 792c 2022 5f5f 6d61  (done_key, "__ma
-00053850: 736b 5f5f 2229 2c20 4e6f 6e65 0d0a 2020  sk__"), None..  
-00053860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053870: 2020 290d 0a20 2020 2020 2020 2020 2020    )..           
-00053880: 2020 2020 2020 2020 2069 6620 6d61 736b           if mask
-00053890: 2069 7320 6e6f 7420 4e6f 6e65 3a0d 0a20   is not None:.. 
-000538a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000538b0: 2020 2020 2020 2061 6765 6e74 203d 2073         agent = s
-000538c0: 656c 662e 5f73 6176 6564 5f74 645f 6175  elf._saved_td_au
-000538d0: 746f 7265 7374 2e67 6574 2861 6765 6e74  torest.get(agent
-000538e0: 5f6b 6579 290d 0a0d 0a20 2020 2020 2020  _key)....       
-000538f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053900: 2069 6620 6973 696e 7374 616e 6365 2861   if isinstance(a
-00053910: 6765 6e74 2c20 4c61 7a79 5374 6163 6b65  gent, LazyStacke
-00053920: 6454 656e 736f 7244 6963 7429 3a0d 0a20  dTensorDict):.. 
-00053930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053940: 2020 2020 2020 2020 2020 2061 6765 6e74             agent
-00053950: 7320 3d20 6167 656e 742e 7465 6e73 6f72  s = agent.tensor
-00053960: 6469 6374 730d 0a20 2020 2020 2020 2020  dicts..         
-00053970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053980: 2020 206d 6173 6b73 203d 206d 6173 6b2e     masks = mask.
-00053990: 756e 6269 6e64 2861 6765 6e74 2e73 7461  unbind(agent.sta
-000539a0: 636b 5f64 696d 290d 0a20 2020 2020 2020  ck_dim)..       
-000539b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000539c0: 2020 2020 2064 6573 7473 203d 2074 656e       dests = ten
-000539d0: 736f 7264 6963 745f 7265 7365 742e 7365  sordict_reset.se
-000539e0: 7464 6566 6175 6c74 280d 0a20 2020 2020  tdefault(..     
-000539f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053a00: 2020 2020 2020 2020 2020 2061 6765 6e74             agent
-00053a10: 5f6b 6579 2c0d 0a20 2020 2020 2020 2020  _key,..         
+000534a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000534b0: 666f 7220 5f61 6765 6e74 2c20 5f6d 6173  for _agent, _mas
+000534c0: 6b2c 205f 7361 7665 645f 7464 5f61 7574  k, _saved_td_aut
+000534d0: 6f72 6573 745f 6167 656e 7420 696e 207a  orest_agent in z
+000534e0: 6970 280d 0a20 2020 2020 2020 2020 2020  ip(..           
+000534f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053500: 2020 2020 2020 2020 2061 6765 6e74 732c           agents,
+00053510: 206d 6173 6b73 2c20 7361 7665 645f 7464   masks, saved_td
+00053520: 5f61 7574 6f72 6573 745f 6167 656e 7473  _autorest_agents
+00053530: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00053540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053550: 2020 293a 0d0a 2020 2020 2020 2020 2020    ):..          
+00053560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053570: 2020 2020 2020 2020 2020 7661 6c20 3d20            val = 
+00053580: 5f61 6765 6e74 2e67 6574 286b 6579 5b6c  _agent.get(key[l
+00053590: 656e 2861 6765 6e74 5f6b 6579 2920 3a5d  en(agent_key) :]
+000535a0: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+000535b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000535c0: 2020 2020 2020 2072 6570 6c61 6365 5f61         replace_a
+000535d0: 6e64 5f73 6574 280d 0a20 2020 2020 2020  nd_set(..       
+000535e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000535f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053600: 206b 6579 5b6c 656e 2861 6765 6e74 5f6b   key[len(agent_k
+00053610: 6579 2920 3a5d 2c0d 0a20 2020 2020 2020  ey) :],..       
+00053620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053640: 2076 616c 2c0d 0a20 2020 2020 2020 2020   val,..         
+00053650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053660: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+00053670: 6d61 736b 2c0d 0a20 2020 2020 2020 2020  mask,..         
+00053680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053690: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000536a0: 6176 6564 5f74 645f 6175 746f 7265 7365  aved_td_autorese
+000536b0: 743d 5f73 6176 6564 5f74 645f 6175 746f  t=_saved_td_auto
+000536c0: 7265 7374 5f61 6765 6e74 2c0d 0a20 2020  rest_agent,..   
+000536d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000536e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000536f0: 2020 2020 2061 6765 6e74 3d5f 6167 656e       agent=_agen
+00053700: 742c 0d0a 2020 2020 2020 2020 2020 2020  t,..            
+00053710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053720: 2020 2020 2020 2020 290d 0a20 2020 2020          )..     
+00053730: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00053740: 6172 656e 7473 2e61 7070 656e 6428 646f  arents.append(do
+00053750: 6e65 5f6b 6579 5b3a 2d31 5d29 0d0a 2020  ne_key[:-1])..  
+00053760: 2020 2020 2020 2020 2020 6966 205f 7361            if _sa
+00053770: 7665 645f 7464 5f61 7574 6f72 6573 7420  ved_td_autorest 
+00053780: 6973 206e 6f74 204e 6f6e 653a 0d0a 2020  is not None:..  
+00053790: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000537a0: 6c66 2e5f 5f64 6963 745f 5f5b 225f 7361  lf.__dict__["_sa
+000537b0: 7665 645f 7464 5f61 7574 6f72 6573 7422  ved_td_autorest"
+000537c0: 5d20 3d20 5f73 6176 6564 5f74 645f 6175  ] = _saved_td_au
+000537d0: 746f 7265 7374 0d0a 0d0a 2020 2020 2020  torest....      
+000537e0: 2020 7265 7475 726e 2074 656e 736f 7264    return tensord
+000537f0: 6963 740d 0a0d 0a20 2020 2064 6566 205f  ict....    def _
+00053800: 7265 706c 6163 655f 6175 746f 5f72 6573  replace_auto_res
+00053810: 6574 5f76 616c 7328 7365 6c66 2c20 2a2c  et_vals(self, *,
+00053820: 2074 656e 736f 7264 6963 745f 7265 7365   tensordict_rese
+00053830: 7429 3a0d 0a20 2020 2020 2020 205f 7361  t):..        _sa
+00053840: 7665 645f 7464 5f61 7574 6f72 6573 7420  ved_td_autorest 
+00053850: 3d20 7365 6c66 2e5f 5f64 6963 745f 5f2e  = self.__dict__.
+00053860: 6765 7428 225f 7361 7665 645f 7464 5f61  get("_saved_td_a
+00053870: 7574 6f72 6573 7422 2c20 4e6f 6e65 290d  utorest", None).
+00053880: 0a20 2020 2020 2020 2069 6620 5f73 6176  .        if _sav
+00053890: 6564 5f74 645f 6175 746f 7265 7374 2069  ed_td_autorest i
+000538a0: 7320 4e6f 6e65 3a0d 0a20 2020 2020 2020  s None:..       
+000538b0: 2020 2020 2072 6574 7572 6e20 7465 6e73       return tens
+000538c0: 6f72 6469 6374 5f72 6573 6574 0d0a 2020  ordict_reset..  
+000538d0: 2020 2020 2020 6966 2073 656c 662e 5f73        if self._s
+000538e0: 696d 706c 655f 646f 6e65 3a0d 0a20 2020  imple_done:..   
+000538f0: 2020 2020 2020 2020 2066 6f72 206b 6579           for key
+00053900: 2c20 7661 6c20 696e 2073 656c 662e 5f73  , val in self._s
+00053910: 6176 6564 5f74 645f 6175 746f 7265 7374  aved_td_autorest
+00053920: 2e69 7465 6d73 2854 7275 652c 2054 7275  .items(True, Tru
+00053930: 6529 3a0d 0a20 2020 2020 2020 2020 2020  e):..           
+00053940: 2020 2020 2069 6620 5f65 6e64 735f 7769       if _ends_wi
+00053950: 7468 286b 6579 2c20 225f 7265 7365 7422  th(key, "_reset"
+00053960: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
+00053970: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+00053980: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00053990: 2020 7661 6c5f 7365 745f 7265 6720 3d20    val_set_reg = 
+000539a0: 7661 6c0d 0a20 2020 2020 2020 2020 2020  val..           
+000539b0: 2020 2020 2074 656e 736f 7264 6963 745f       tensordict_
+000539c0: 7265 7365 742e 7365 7428 6b65 792c 2076  reset.set(key, v
+000539d0: 616c 5f73 6574 5f72 6567 290d 0a20 2020  al_set_reg)..   
+000539e0: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
+000539f0: 2020 2020 2020 2020 666f 7220 646f 6e65          for done
+00053a00: 5f6b 6579 2069 6e20 7365 6c66 2e70 6172  _key in self.par
+00053a10: 656e 742e 646f 6e65 5f6b 6579 733a 0d0a  ent.done_keys:..
 00053a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053a30: 2020 2020 2020 204c 617a 7953 7461 636b         LazyStack
-00053a40: 6564 5465 6e73 6f72 4469 6374 280d 0a20  edTensorDict(.. 
-00053a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053a70: 2020 202a 5b74 642e 656d 7074 7928 2920     *[td.empty() 
-00053a80: 666f 7220 7464 2069 6e20 6167 656e 7473  for td in agents
-00053a90: 5d2c 0d0a 2020 2020 2020 2020 2020 2020  ],..            
-00053aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053ab0: 2020 2020 2020 2020 7374 6163 6b5f 6469          stack_di
-00053ac0: 6d3d 6167 656e 742e 7374 6163 6b5f 6469  m=agent.stack_di
-00053ad0: 6d2c 0d0a 2020 2020 2020 2020 2020 2020  m,..            
-00053ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053af0: 2020 2020 292c 0d0a 2020 2020 2020 2020      ),..        
+00053a30: 6966 205f 656e 6473 5f77 6974 6828 646f  if _ends_with(do
+00053a40: 6e65 5f6b 6579 2c20 2264 6f6e 6522 293a  ne_key, "done"):
+00053a50: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00053a60: 2020 2020 2020 6167 656e 745f 6b65 7920        agent_key 
+00053a70: 3d20 646f 6e65 5f6b 6579 5b3a 2d31 5d0d  = done_key[:-1].
+00053a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00053a90: 2020 2020 206d 6173 6b20 3d20 7365 6c66       mask = self
+00053aa0: 2e5f 7361 7665 645f 7464 5f61 7574 6f72  ._saved_td_autor
+00053ab0: 6573 742e 706f 7028 0d0a 2020 2020 2020  est.pop(..      
+00053ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053ad0: 2020 5f72 6570 6c61 6365 5f6c 6173 7428    _replace_last(
+00053ae0: 646f 6e65 5f6b 6579 2c20 225f 5f6d 6173  done_key, "__mas
+00053af0: 6b5f 5f22 292c 204e 6f6e 650d 0a20 2020  k__"), None..   
 00053b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053b10: 2020 2020 290d 0a20 2020 2020 2020 2020      )..         
-00053b20: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00053b30: 6c73 653a 0d0a 2020 2020 2020 2020 2020  lse:..          
+00053b10: 2029 0d0a 2020 2020 2020 2020 2020 2020   )..            
+00053b20: 2020 2020 2020 2020 6966 206d 6173 6b20          if mask 
+00053b30: 6973 206e 6f74 204e 6f6e 653a 0d0a 2020  is not None:..  
 00053b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053b50: 2020 6167 656e 7473 203d 205b 6167 656e    agents = [agen
-00053b60: 745d 0d0a 2020 2020 2020 2020 2020 2020  t]..            
-00053b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053b80: 6d61 736b 7320 3d20 5b6d 6173 6b5d 0d0a  masks = [mask]..
+00053b50: 2020 2020 2020 6167 656e 7420 3d20 7365        agent = se
+00053b60: 6c66 2e5f 7361 7665 645f 7464 5f61 7574  lf._saved_td_aut
+00053b70: 6f72 6573 742e 6765 7428 6167 656e 745f  orest.get(agent_
+00053b80: 6b65 7929 0d0a 0d0a 2020 2020 2020 2020  key)....        
 00053b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053ba0: 2020 2020 2020 2020 2020 2020 6465 7374              dest
-00053bb0: 7320 3d20 5b0d 0a20 2020 2020 2020 2020  s = [..         
-00053bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053bd0: 2020 2020 2020 2074 656e 736f 7264 6963         tensordic
-00053be0: 745f 7265 7365 742e 7365 7464 6566 6175  t_reset.setdefau
-00053bf0: 6c74 2861 6765 6e74 5f6b 6579 2c20 6167  lt(agent_key, ag
-00053c00: 656e 742e 656d 7074 7928 2929 0d0a 2020  ent.empty())..  
+00053ba0: 6966 2069 7369 6e73 7461 6e63 6528 6167  if isinstance(ag
+00053bb0: 656e 742c 204c 617a 7953 7461 636b 6564  ent, LazyStacked
+00053bc0: 5465 6e73 6f72 4469 6374 293a 0d0a 2020  TensorDict):..  
+00053bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053be0: 2020 2020 2020 2020 2020 6167 656e 7473            agents
+00053bf0: 203d 2061 6765 6e74 2e74 656e 736f 7264   = agent.tensord
+00053c00: 6963 7473 0d0a 2020 2020 2020 2020 2020  icts..          
 00053c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053c20: 2020 2020 2020 2020 2020 5d0d 0a20 2020            ]..   
-00053c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053c40: 2020 2020 2066 6f72 205f 6167 656e 742c       for _agent,
-00053c50: 205f 6d61 736b 2c20 5f64 6573 7420 696e   _mask, _dest in
-00053c60: 207a 6970 2861 6765 6e74 732c 206d 6173   zip(agents, mas
-00053c70: 6b73 2c20 6465 7374 7329 3a0d 0a20 2020  ks, dests):..   
-00053c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053c90: 2020 2020 2020 2020 2066 6f72 206b 6579           for key
-00053ca0: 2c20 7661 6c20 696e 205f 6167 656e 742e  , val in _agent.
-00053cb0: 6974 656d 7328 5472 7565 2c20 5472 7565  items(True, True
-00053cc0: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
-00053cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053ce0: 2020 2020 6966 205f 656e 6473 5f77 6974      if _ends_wit
-00053cf0: 6828 6b65 792c 2022 5f72 6573 6574 2229  h(key, "_reset")
-00053d00: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-00053d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053d20: 2020 2020 2020 2063 6f6e 7469 6e75 650d         continue.
-00053d30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00053c20: 2020 6d61 736b 7320 3d20 6d61 736b 2e75    masks = mask.u
+00053c30: 6e62 696e 6428 6167 656e 742e 7374 6163  nbind(agent.stac
+00053c40: 6b5f 6469 6d29 0d0a 2020 2020 2020 2020  k_dim)..        
+00053c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053c60: 2020 2020 6465 7374 7320 3d20 7465 6e73      dests = tens
+00053c70: 6f72 6469 6374 5f72 6573 6574 2e73 6574  ordict_reset.set
+00053c80: 6465 6661 756c 7428 0d0a 2020 2020 2020  default(..      
+00053c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053ca0: 2020 2020 2020 2020 2020 6167 656e 745f            agent_
+00053cb0: 6b65 792c 0d0a 2020 2020 2020 2020 2020  key,..          
+00053cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053cd0: 2020 2020 2020 4c61 7a79 5374 6163 6b65        LazyStacke
+00053ce0: 6454 656e 736f 7244 6963 7428 0d0a 2020  dTensorDict(..  
+00053cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053d10: 2020 2a5b 7464 2e65 6d70 7479 2829 2066    *[td.empty() f
+00053d20: 6f72 2074 6420 696e 2061 6765 6e74 735d  or td in agents]
+00053d30: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
 00053d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053d50: 2069 6620 6e6f 7420 5f6d 6173 6b2e 616c   if not _mask.al
-00053d60: 6c28 293a 0d0a 2020 2020 2020 2020 2020  l():..          
-00053d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053d80: 2020 2020 2020 2020 2020 7661 6c5f 6e6f            val_no
-00053d90: 745f 7265 7365 7420 3d20 5f64 6573 742e  t_reset = _dest.
-00053da0: 6765 7428 6b65 7929 0d0a 2020 2020 2020  get(key)..      
-00053db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053dc0: 2020 2020 2020 2020 2020 2020 2020 7661                va
-00053dd0: 6c5f 7365 745f 7265 6720 3d20 746f 7263  l_set_reg = torc
-00053de0: 682e 7768 6572 6528 0d0a 2020 2020 2020  h.where(..      
-00053df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053e10: 2020 6578 7061 6e64 5f61 735f 7269 6768    expand_as_righ
-00053e20: 7428 6d61 736b 2c20 7661 6c29 2c20 7661  t(mask, val), va
-00053e30: 6c2c 2076 616c 5f6e 6f74 5f72 6573 6574  l, val_not_reset
-00053e40: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00053e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053e60: 2020 2020 2020 290d 0a20 2020 2020 2020        )..       
-00053e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053e80: 2020 2020 2020 2020 2065 6c73 653a 0d0a           else:..
-00053e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053eb0: 2020 2020 7661 6c5f 7365 745f 7265 6720      val_set_reg 
-00053ec0: 3d20 7661 6c0d 0a20 2020 2020 2020 2020  = val..         
+00053d50: 2020 2020 2020 2073 7461 636b 5f64 696d         stack_dim
+00053d60: 3d61 6765 6e74 2e73 7461 636b 5f64 696d  =agent.stack_dim
+00053d70: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+00053d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053d90: 2020 2029 2c0d 0a20 2020 2020 2020 2020     ),..         
+00053da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053db0: 2020 2029 0d0a 2020 2020 2020 2020 2020     )..          
+00053dc0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00053dd0: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
+00053de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053df0: 2061 6765 6e74 7320 3d20 5b61 6765 6e74   agents = [agent
+00053e00: 5d0d 0a20 2020 2020 2020 2020 2020 2020  ]..             
+00053e10: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00053e20: 6173 6b73 203d 205b 6d61 736b 5d0d 0a20  asks = [mask].. 
+00053e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053e40: 2020 2020 2020 2020 2020 2064 6573 7473             dests
+00053e50: 203d 205b 0d0a 2020 2020 2020 2020 2020   = [..          
+00053e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053e70: 2020 2020 2020 7465 6e73 6f72 6469 6374        tensordict
+00053e80: 5f72 6573 6574 2e73 6574 6465 6661 756c  _reset.setdefaul
+00053e90: 7428 6167 656e 745f 6b65 792c 2061 6765  t(agent_key, age
+00053ea0: 6e74 2e65 6d70 7479 2829 290d 0a20 2020  nt.empty())..   
+00053eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053ec0: 2020 2020 2020 2020 205d 0d0a 2020 2020           ]..    
 00053ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053ee0: 2020 2020 2020 205f 6465 7374 2e73 6574         _dest.set
-00053ef0: 286b 6579 2c20 7661 6c5f 7365 745f 7265  (key, val_set_re
-00053f00: 6729 0d0a 2020 2020 2020 2020 6465 6c61  g)..        dela
-00053f10: 7474 7228 7365 6c66 2c20 225f 7361 7665  ttr(self, "_save
-00053f20: 645f 7464 5f61 7574 6f72 6573 7422 290d  d_td_autorest").
-00053f30: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00053f40: 7465 6e73 6f72 6469 6374 5f72 6573 6574  tensordict_reset
-00053f50: 0d0a                                     ..
+00053ee0: 2020 2020 666f 7220 5f61 6765 6e74 2c20      for _agent, 
+00053ef0: 5f6d 6173 6b2c 205f 6465 7374 2069 6e20  _mask, _dest in 
+00053f00: 7a69 7028 6167 656e 7473 2c20 6d61 736b  zip(agents, mask
+00053f10: 732c 2064 6573 7473 293a 0d0a 2020 2020  s, dests):..    
+00053f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053f30: 2020 2020 2020 2020 666f 7220 6b65 792c          for key,
+00053f40: 2076 616c 2069 6e20 5f61 6765 6e74 2e69   val in _agent.i
+00053f50: 7465 6d73 2854 7275 652c 2054 7275 6529  tems(True, True)
+00053f60: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+00053f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053f80: 2020 2069 6620 5f65 6e64 735f 7769 7468     if _ends_with
+00053f90: 286b 6579 2c20 225f 7265 7365 7422 293a  (key, "_reset"):
+00053fa0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00053fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053fc0: 2020 2020 2020 636f 6e74 696e 7565 0d0a        continue..
+00053fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053ff0: 6966 206e 6f74 205f 6d61 736b 2e61 6c6c  if not _mask.all
+00054000: 2829 3a0d 0a20 2020 2020 2020 2020 2020  ():..           
+00054010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054020: 2020 2020 2020 2020 2076 616c 5f6e 6f74           val_not
+00054030: 5f72 6573 6574 203d 205f 6465 7374 2e67  _reset = _dest.g
+00054040: 6574 286b 6579 290d 0a20 2020 2020 2020  et(key)..       
+00054050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054060: 2020 2020 2020 2020 2020 2020 2076 616c               val
+00054070: 5f73 6574 5f72 6567 203d 2074 6f72 6368  _set_reg = torch
+00054080: 2e77 6865 7265 280d 0a20 2020 2020 2020  .where(..       
+00054090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000540a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000540b0: 2065 7870 616e 645f 6173 5f72 6967 6874   expand_as_right
+000540c0: 286d 6173 6b2c 2076 616c 292c 2076 616c  (mask, val), val
+000540d0: 2c20 7661 6c5f 6e6f 745f 7265 7365 740d  , val_not_reset.
+000540e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000540f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054100: 2020 2020 2029 0d0a 2020 2020 2020 2020       )..        
+00054110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054120: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
+00054130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054150: 2020 2076 616c 5f73 6574 5f72 6567 203d     val_set_reg =
+00054160: 2076 616c 0d0a 2020 2020 2020 2020 2020   val..          
+00054170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054180: 2020 2020 2020 5f64 6573 742e 7365 7428        _dest.set(
+00054190: 6b65 792c 2076 616c 5f73 6574 5f72 6567  key, val_set_reg
+000541a0: 290d 0a20 2020 2020 2020 2064 656c 6174  )..        delat
+000541b0: 7472 2873 656c 662c 2022 5f73 6176 6564  tr(self, "_saved
+000541c0: 5f74 645f 6175 746f 7265 7374 2229 0d0a  _td_autorest")..
+000541d0: 2020 2020 2020 2020 7265 7475 726e 2074          return t
+000541e0: 656e 736f 7264 6963 745f 7265 7365 740d  ensordict_reset.
+000541f0: 0a                                       .
```

## torchrl/modules/tensordict_module/rnn.py

```diff
@@ -378,14 +378,21 @@
     Attributes:
         recurrent_mode: Returns the recurrent mode of the module.
 
     Methods:
         set_recurrent_mode: controls whether the module should be executed in
             recurrent mode.
 
+    .. note:: This module relies on specific ``recurrent_state`` keys being present in the input
+        TensorDicts. To generate a :class:`~torchrl.envs.transforms.TensorDictPrimer` transform that will automatically
+        add hidden states to the environment TensorDicts, use the method :func:`~torchrl.modules.rnn.LSTMModule.make_tensordict_primer`.
+        If this class is a submodule in a larger module, the method :func:`~torchrl.models.utils.get_primers_from_module` can be called
+        on the parent module to automatically generate the primer transforms required for all submodules, including this one.
+
+
     Examples:
         >>> from torchrl.envs import TransformedEnv, InitTracker
         >>> from torchrl.envs import GymEnv
         >>> from torchrl.modules import MLP
         >>> from torch import nn
         >>> from tensordict.nn import TensorDictSequential as Seq, TensorDictModule as Mod
         >>> env = TransformedEnv(GymEnv("Pendulum-v1"), InitTracker())
@@ -1055,14 +1062,20 @@
     Attributes:
         recurrent_mode: Returns the recurrent mode of the module.
 
     Methods:
         set_recurrent_mode: controls whether the module should be executed in
             recurrent mode.
 
+    .. note:: This module relies on specific ``recurrent_state`` keys being present in the input
+        TensorDicts. To generate a :class:`~torchrl.envs.transforms.TensorDictPrimer` transform that will automatically
+        add hidden states to the environment TensorDicts, use the method :func:`~torchrl.modules.rnn.GRUModule.make_tensordict_primer`.
+        If this class is a submodule in a larger module, the method :func:`~torchrl.models.utils.get_primers_from_module` can be called
+        on the parent module to automatically generate the primer transforms required for all submodules, including this one.
+
     Examples:
         >>> from torchrl.envs import TransformedEnv, InitTracker
         >>> from torchrl.envs import GymEnv
         >>> from torchrl.modules import MLP
         >>> from torch import nn
         >>> from tensordict.nn import TensorDictSequential as Seq, TensorDictModule as Mod
         >>> env = TransformedEnv(GymEnv("Pendulum-v1"), InitTracker())
```

## torchrl/modules/utils/__init__.py

```diff
@@ -21,7 +21,8 @@
             return super().__instancecheck__(instance) or (
                 isinstance(instance, torch.Tensor)
                 and getattr(instance, "_is_param", False)
             )
 
 
 from .mappings import biased_softplus, inv_softplus, mappings
+from .utils import get_primers_from_module
```

## torchrl/modules/utils/utils.py

```diff
@@ -0,0 +1,157 @@
+00000000: 2320 436f 7079 7269 6768 7420 2863 2920  # Copyright (c) 
+00000010: 4d65 7461 2050 6c61 7466 6f72 6d73 2c20  Meta Platforms, 
+00000020: 496e 632e 2061 6e64 2061 6666 696c 6961  Inc. and affilia
+00000030: 7465 732e 0d0a 230d 0a23 2054 6869 7320  tes...#..# This 
+00000040: 736f 7572 6365 2063 6f64 6520 6973 206c  source code is l
+00000050: 6963 656e 7365 6420 756e 6465 7220 7468  icensed under th
+00000060: 6520 4d49 5420 6c69 6365 6e73 6520 666f  e MIT license fo
+00000070: 756e 6420 696e 2074 6865 0d0a 2320 4c49  und in the..# LI
+00000080: 4345 4e53 4520 6669 6c65 2069 6e20 7468  CENSE file in th
+00000090: 6520 726f 6f74 2064 6972 6563 746f 7279  e root directory
+000000a0: 206f 6620 7468 6973 2073 6f75 7263 6520   of this source 
+000000b0: 7472 6565 2e0d 0a0d 0a69 6d70 6f72 7420  tree.....import 
+000000c0: 7761 726e 696e 6773 0d0a 0d0a 0d0a 6465  warnings......de
+000000d0: 6620 6765 745f 7072 696d 6572 735f 6672  f get_primers_fr
+000000e0: 6f6d 5f6d 6f64 756c 6528 6d6f 6475 6c65  om_module(module
+000000f0: 293a 0d0a 2020 2020 2222 2247 6574 2061  ):..    """Get a
+00000100: 6c6c 2074 656e 736f 7264 6963 7420 7072  ll tensordict pr
+00000110: 696d 6572 7320 6672 6f6d 2061 6c6c 2073  imers from all s
+00000120: 7562 6d6f 6475 6c65 7320 6f66 2061 206d  ubmodules of a m
+00000130: 6f64 756c 652e 0d0a 0d0a 2020 2020 5468  odule.....    Th
+00000140: 6973 206d 6574 686f 6420 6973 2075 7365  is method is use
+00000150: 6675 6c20 666f 7220 7265 7472 6965 7669  ful for retrievi
+00000160: 6e67 2070 7269 6d65 7273 2066 726f 6d20  ng primers from 
+00000170: 6d6f 6475 6c65 7320 7468 6174 2061 7265  modules that are
+00000180: 2063 6f6e 7461 696e 6564 2077 6974 6869   contained withi
+00000190: 6e20 610d 0a20 2020 2070 6172 656e 7420  n a..    parent 
+000001a0: 6d6f 6475 6c65 2e0d 0a0d 0a20 2020 2041  module.....    A
+000001b0: 7267 733a 0d0a 2020 2020 2020 2020 6d6f  rgs:..        mo
+000001c0: 6475 6c65 2028 746f 7263 682e 6e6e 2e4d  dule (torch.nn.M
+000001d0: 6f64 756c 6529 3a20 5468 6520 7061 7265  odule): The pare
+000001e0: 6e74 206d 6f64 756c 652e 0d0a 0d0a 2020  nt module.....  
+000001f0: 2020 5265 7475 726e 733a 0d0a 2020 2020    Returns:..    
+00000200: 2020 2020 5465 6e73 6f72 4469 6374 5072      TensorDictPr
+00000210: 696d 6572 3a20 4120 5465 6e73 6f72 4469  imer: A TensorDi
+00000220: 6374 5072 696d 6572 2054 7261 6e73 666f  ctPrimer Transfo
+00000230: 726d 2e0d 0a0d 0a20 2020 2045 7861 6d70  rm.....    Examp
+00000240: 6c65 3a0d 0a20 2020 2020 2020 203e 3e3e  le:..        >>>
+00000250: 2066 726f 6d20 746f 7263 6872 6c2e 6d6f   from torchrl.mo
+00000260: 6475 6c65 732e 7574 696c 7320 696d 706f  dules.utils impo
+00000270: 7274 2067 6574 5f70 7269 6d65 7273 5f66  rt get_primers_f
+00000280: 726f 6d5f 6d6f 6475 6c65 0d0a 2020 2020  rom_module..    
+00000290: 2020 2020 3e3e 3e20 6672 6f6d 2074 6f72      >>> from tor
+000002a0: 6368 726c 2e6d 6f64 756c 6573 2069 6d70  chrl.modules imp
+000002b0: 6f72 7420 4752 554d 6f64 756c 652c 204d  ort GRUModule, M
+000002c0: 4c50 0d0a 2020 2020 2020 2020 3e3e 3e20  LP..        >>> 
+000002d0: 6672 6f6d 2074 656e 736f 7264 6963 742e  from tensordict.
+000002e0: 6e6e 2069 6d70 6f72 7420 5465 6e73 6f72  nn import Tensor
+000002f0: 4469 6374 4d6f 6475 6c65 2c20 5465 6e73  DictModule, Tens
+00000300: 6f72 4469 6374 5365 7175 656e 7469 616c  orDictSequential
+00000310: 0d0a 2020 2020 2020 2020 3e3e 3e20 2320  ..        >>> # 
+00000320: 4465 6669 6e65 2061 2047 5255 206d 6f64  Define a GRU mod
+00000330: 756c 650d 0a20 2020 2020 2020 203e 3e3e  ule..        >>>
+00000340: 2067 7275 5f6d 6f64 756c 6520 3d20 4752   gru_module = GR
+00000350: 554d 6f64 756c 6528 0d0a 2020 2020 2020  UModule(..      
+00000360: 2020 2e2e 2e20 2020 2020 696e 7075 745f    ...     input_
+00000370: 7369 7a65 3d31 302c 0d0a 2020 2020 2020  size=10,..      
+00000380: 2020 2e2e 2e20 2020 2020 6869 6464 656e    ...     hidden
+00000390: 5f73 697a 653d 3130 2c0d 0a20 2020 2020  _size=10,..     
+000003a0: 2020 202e 2e2e 2020 2020 206e 756d 5f6c     ...     num_l
+000003b0: 6179 6572 733d 312c 0d0a 2020 2020 2020  ayers=1,..      
+000003c0: 2020 2e2e 2e20 2020 2020 696e 5f6b 6579    ...     in_key
+000003d0: 733d 5b22 696e 7075 7422 2c20 2272 6563  s=["input", "rec
+000003e0: 7572 7265 6e74 5f73 7461 7465 222c 2022  urrent_state", "
+000003f0: 6973 5f69 6e69 7422 5d2c 0d0a 2020 2020  is_init"],..    
+00000400: 2020 2020 2e2e 2e20 2020 2020 6f75 745f      ...     out_
+00000410: 6b65 7973 3d5b 2266 6561 7475 7265 7322  keys=["features"
+00000420: 2c20 2822 6e65 7874 222c 2022 7265 6375  , ("next", "recu
+00000430: 7272 656e 745f 7374 6174 6522 295d 2c0d  rrent_state")],.
+00000440: 0a20 2020 2020 2020 202e 2e2e 2029 0d0a  .        ... )..
+00000450: 2020 2020 2020 2020 3e3e 3e20 2320 4465          >>> # De
+00000460: 6669 6e65 2061 2068 6561 6420 6d6f 6475  fine a head modu
+00000470: 6c65 0d0a 2020 2020 2020 2020 3e3e 3e20  le..        >>> 
+00000480: 6865 6164 203d 2054 656e 736f 7244 6963  head = TensorDic
+00000490: 744d 6f64 756c 6528 0d0a 2020 2020 2020  tModule(..      
+000004a0: 2020 2e2e 2e20 2020 2020 4d4c 5028 0d0a    ...     MLP(..
+000004b0: 2020 2020 2020 2020 2e2e 2e20 2020 2020          ...     
+000004c0: 2020 2020 696e 5f66 6561 7475 7265 733d      in_features=
+000004d0: 3130 2c0d 0a20 2020 2020 2020 202e 2e2e  10,..        ...
+000004e0: 2020 2020 2020 2020 206f 7574 5f66 6561           out_fea
+000004f0: 7475 7265 733d 3130 2c0d 0a20 2020 2020  tures=10,..     
+00000500: 2020 202e 2e2e 2020 2020 2020 2020 206e     ...         n
+00000510: 756d 5f63 656c 6c73 3d5b 5d2c 0d0a 2020  um_cells=[],..  
+00000520: 2020 2020 2020 2e2e 2e20 2020 2020 292c        ...     ),
+00000530: 0d0a 2020 2020 2020 2020 2e2e 2e20 2020  ..        ...   
+00000540: 2020 696e 5f6b 6579 733d 5b22 6665 6174    in_keys=["feat
+00000550: 7572 6573 225d 2c0d 0a20 2020 2020 2020  ures"],..       
+00000560: 202e 2e2e 2020 2020 206f 7574 5f6b 6579   ...     out_key
+00000570: 733d 5b22 6f75 7470 7574 225d 2c0d 0a20  s=["output"],.. 
+00000580: 2020 2020 2020 202e 2e2e 2029 0d0a 2020         ... )..  
+00000590: 2020 2020 2020 3e3e 3e20 2320 4372 6561        >>> # Crea
+000005a0: 7465 2061 2073 6571 7565 6e74 6961 6c20  te a sequential 
+000005b0: 6d6f 6465 6c0d 0a20 2020 2020 2020 203e  model..        >
+000005c0: 3e3e 206d 6f64 656c 203d 2054 656e 736f  >> model = Tenso
+000005d0: 7244 6963 7453 6571 7565 6e74 6961 6c28  rDictSequential(
+000005e0: 6772 755f 6d6f 6475 6c65 2c20 6865 6164  gru_module, head
+000005f0: 290d 0a20 2020 2020 2020 203e 3e3e 2023  )..        >>> #
+00000600: 2052 6574 7269 6576 6520 7072 696d 6572   Retrieve primer
+00000610: 7320 6672 6f6d 2074 6865 206d 6f64 656c  s from the model
+00000620: 0d0a 2020 2020 2020 2020 3e3e 3e20 7072  ..        >>> pr
+00000630: 696d 6572 7320 3d20 6765 745f 7072 696d  imers = get_prim
+00000640: 6572 735f 6672 6f6d 5f6d 6f64 756c 6528  ers_from_module(
+00000650: 6d6f 6465 6c29 0d0a 2020 2020 2020 2020  model)..        
+00000660: 3e3e 3e20 7072 696e 7428 7072 696d 6572  >>> print(primer
+00000670: 7329 0d0a 0d0a 2020 2020 2020 2020 5465  s)....        Te
+00000680: 6e73 6f72 4469 6374 5072 696d 6572 2870  nsorDictPrimer(p
+00000690: 7269 6d65 7273 3d43 6f6d 706f 7369 7465  rimers=Composite
+000006a0: 5370 6563 280d 0a20 2020 2020 2020 2020  Spec(..         
+000006b0: 2020 2072 6563 7572 7265 6e74 5f73 7461     recurrent_sta
+000006c0: 7465 3a20 556e 626f 756e 6465 6443 6f6e  te: UnboundedCon
+000006d0: 7469 6e75 6f75 7354 656e 736f 7253 7065  tinuousTensorSpe
+000006e0: 6328 0d0a 2020 2020 2020 2020 2020 2020  c(..            
+000006f0: 2020 2020 7368 6170 653d 746f 7263 682e      shape=torch.
+00000700: 5369 7a65 285b 312c 2031 305d 292c 0d0a  Size([1, 10]),..
+00000710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000720: 7370 6163 653d 4e6f 6e65 2c0d 0a20 2020  space=None,..   
+00000730: 2020 2020 2020 2020 2020 2020 2064 6576               dev
+00000740: 6963 653d 6370 752c 0d0a 2020 2020 2020  ice=cpu,..      
+00000750: 2020 2020 2020 2020 2020 6474 7970 653d            dtype=
+00000760: 746f 7263 682e 666c 6f61 7433 322c 0d0a  torch.float32,..
+00000770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000780: 646f 6d61 696e 3d63 6f6e 7469 6e75 6f75  domain=continuou
+00000790: 7329 2c20 6465 7669 6365 3d4e 6f6e 652c  s), device=None,
+000007a0: 2073 6861 7065 3d74 6f72 6368 2e53 697a   shape=torch.Siz
+000007b0: 6528 5b5d 2929 2c20 6465 6661 756c 745f  e([])), default_
+000007c0: 7661 6c75 653d 7b27 7265 6375 7272 656e  value={'recurren
+000007d0: 745f 7374 6174 6527 3a20 302e 307d 2c20  t_state': 0.0}, 
+000007e0: 7261 6e64 6f6d 3d4e 6f6e 6529 0d0a 0d0a  random=None)....
+000007f0: 2020 2020 2222 220d 0a20 2020 2070 7269      """..    pri
+00000800: 6d65 7273 203d 205b 5d0d 0a0d 0a20 2020  mers = []....   
+00000810: 2064 6566 206d 616b 655f 7072 696d 6572   def make_primer
+00000820: 7328 7375 626d 6f64 756c 6529 3a0d 0a20  s(submodule):.. 
+00000830: 2020 2020 2020 2069 6620 6861 7361 7474         if hasatt
+00000840: 7228 7375 626d 6f64 756c 652c 2022 6d61  r(submodule, "ma
+00000850: 6b65 5f74 656e 736f 7264 6963 745f 7072  ke_tensordict_pr
+00000860: 696d 6572 2229 3a0d 0a20 2020 2020 2020  imer"):..       
+00000870: 2020 2020 2070 7269 6d65 7273 2e61 7070       primers.app
+00000880: 656e 6428 7375 626d 6f64 756c 652e 6d61  end(submodule.ma
+00000890: 6b65 5f74 656e 736f 7264 6963 745f 7072  ke_tensordict_pr
+000008a0: 696d 6572 2829 290d 0a0d 0a20 2020 206d  imer())....    m
+000008b0: 6f64 756c 652e 6170 706c 7928 6d61 6b65  odule.apply(make
+000008c0: 5f70 7269 6d65 7273 290d 0a20 2020 2069  _primers)..    i
+000008d0: 6620 6e6f 7420 7072 696d 6572 733a 0d0a  f not primers:..
+000008e0: 2020 2020 2020 2020 7761 726e 696e 6773          warnings
+000008f0: 2e77 6172 6e28 224e 6f20 7072 696d 6572  .warn("No primer
+00000900: 7320 666f 756e 6420 696e 2074 6865 206d  s found in the m
+00000910: 6f64 756c 652e 2229 0d0a 2020 2020 2020  odule.")..      
+00000920: 2020 7265 7475 726e 0d0a 2020 2020 656c    return..    el
+00000930: 6966 206c 656e 2870 7269 6d65 7273 2920  if len(primers) 
+00000940: 3d3d 2031 3a0d 0a20 2020 2020 2020 2072  == 1:..        r
+00000950: 6574 7572 6e20 7072 696d 6572 735b 305d  eturn primers[0]
+00000960: 0d0a 2020 2020 656c 7365 3a0d 0a20 2020  ..    else:..   
+00000970: 2020 2020 2066 726f 6d20 746f 7263 6872       from torchr
+00000980: 6c2e 656e 7673 2e74 7261 6e73 666f 726d  l.envs.transform
+00000990: 7320 696d 706f 7274 2043 6f6d 706f 7365  s import Compose
+000009a0: 0d0a 0d0a 2020 2020 2020 2020 7265 7475  ....        retu
+000009b0: 726e 2043 6f6d 706f 7365 282a 7072 696d  rn Compose(*prim
+000009c0: 6572 7329 0d0a                           ers)..
```

## torchrl/objectives/a2c.py

```diff
@@ -6,15 +6,15 @@
 
 import contextlib
 from copy import deepcopy
 from dataclasses import dataclass
 from typing import Tuple
 
 import torch
-from tensordict import TensorDict, TensorDictBase
+from tensordict import TensorDict, TensorDictBase, TensorDictParams
 from tensordict.nn import dispatch, ProbabilisticTensorDictSequential, TensorDictModule
 from tensordict.utils import NestedKey
 from torch import distributions as d
 
 from torchrl.objectives.common import LossModule
 
 from torchrl.objectives.utils import (
@@ -226,14 +226,21 @@
         done: NestedKey = "done"
         terminated: NestedKey = "terminated"
         sample_log_prob: NestedKey = "sample_log_prob"
 
     default_keys = _AcceptedKeys()
     default_value_estimator: ValueEstimators = ValueEstimators.GAE
 
+    actor_network: TensorDictModule
+    critic_network: TensorDictModule
+    actor_network_params: TensorDictParams
+    critic_network_params: TensorDictParams
+    target_actor_network_params: TensorDictParams
+    target_critic_network_params: TensorDictParams
+
     def __init__(
         self,
         actor_network: ProbabilisticTensorDictSequential = None,
         critic_network: TensorDictModule = None,
         *,
         entropy_bonus: bool = True,
         samples_mc_entropy: int = 1,
```

## torchrl/objectives/common.py

```diff
@@ -3,15 +3,14 @@
 # This source code is licensed under the MIT license found in the
 # LICENSE file in the root directory of this source tree.
 
 from __future__ import annotations
 
 import abc
 import warnings
-from copy import deepcopy
 from dataclasses import dataclass
 from typing import Iterator, List, Optional, Tuple
 
 import torch
 from tensordict import is_tensor_collection, TensorDict, TensorDictBase
 
 from tensordict.nn import TensorDictModule, TensorDictModuleBase, TensorDictParams
@@ -213,14 +212,24 @@
                 (``expand_dim > 0``), the resulting parameters for the module
                 will be a simple expansion of the original parameter. Otherwise,
                 the resulting parameters will be a detached version of the
                 original parameters. If ``None``, the resulting parameters
                 will carry gradients as expected.
 
         """
+        for name in (
+            module_name,
+            module_name + "_params",
+            "target_" + module_name + "_params",
+        ):
+            if name not in self.__class__.__annotations__.keys():
+                warnings.warn(
+                    f"The name {name} wasn't part of the annotations ({self.__class__.__annotations__.keys()}). Make sure it is present in the definition class."
+                )
+
         if kwargs:
             raise TypeError(f"Unrecognised keyword arguments {list(kwargs.keys())}")
         # To make it robust to device casting, we must register list of
         # tensors as lazy calls to `getattr(self, name_of_tensor)`.
         # Otherwise, casting the module to a device will keep old references
         # to uncast tensors
         sep = self.SEP
@@ -285,21 +294,17 @@
             if parameter not in prev_set_params:
                 pass
             elif compare_against is not None and parameter in compare_against:
                 params.set(key, parameter.data)
 
         setattr(self, param_name, params)
 
-        # set the functional module: we need to convert the params to non-differentiable params
-        # otherwise they will appear twice in parameters
-        with params.apply(
-            self._make_meta_params, device=torch.device("meta"), filter_empty=False
-        ).to_module(module):
-            # avoid buffers and params being exposed
-            self.__dict__[module_name] = deepcopy(module)
+        # Set the module in the __dict__ directly to avoid listing its params
+        # A deepcopy with meta device could be used but that assumes that the model is copyable!
+        self.__dict__[module_name] = module
 
         name_params_target = "target_" + module_name
         if create_target_params:
             # if create_target_params:
             # we create a TensorDictParams to keep the target params as Buffer instances
             target_params = TensorDictParams(
                 params.apply(
```

## torchrl/objectives/cql.py

```diff
@@ -10,15 +10,15 @@
 from dataclasses import dataclass
 
 from typing import Optional, Tuple, Union
 
 import numpy as np
 import torch
 import torch.nn as nn
-from tensordict import TensorDict, TensorDictBase
+from tensordict import TensorDict, TensorDictBase, TensorDictParams
 from tensordict.nn import dispatch, TensorDictModule
 from tensordict.utils import NestedKey, unravel_key
 from torch import Tensor
 
 from torchrl.data.tensor_specs import CompositeSpec
 from torchrl.data.utils import _find_action_space
 from torchrl.envs.utils import ExplorationType, set_exploration_type
@@ -252,14 +252,21 @@
         reward: NestedKey = "reward"
         done: NestedKey = "done"
         terminated: NestedKey = "terminated"
 
     default_keys = _AcceptedKeys()
     default_value_estimator = ValueEstimators.TD0
 
+    actor_network: TensorDictModule
+    qvalue_network: TensorDictModule
+    actor_network_params: TensorDictParams
+    qvalue_network_params: TensorDictParams
+    target_actor_network_params: TensorDictParams
+    target_qvalue_network_params: TensorDictParams
+
     def __init__(
         self,
         actor_network: ProbabilisticActor,
         qvalue_network: TensorDictModule,
         *,
         loss_function: str = "smooth_l1",
         alpha_init: float = 1.0,
@@ -1022,14 +1029,18 @@
     default_keys = _AcceptedKeys()
     default_value_estimator = ValueEstimators.TD0
     out_keys = [
         "loss_qvalue",
         "loss_cql",
     ]
 
+    value_network: TensorDictModule
+    value_network_params: TensorDictParams
+    target_value_network_params: TensorDictParams
+
     def __init__(
         self,
         value_network: Union[QValueActor, nn.Module],
         *,
         loss_function: Optional[str] = "l2",
         delay_value: bool = True,
         gamma: float = None,
```

## torchrl/objectives/ddpg.py

```diff
@@ -6,15 +6,15 @@
 from __future__ import annotations
 
 from copy import deepcopy
 from dataclasses import dataclass
 from typing import Tuple
 
 import torch
-from tensordict import TensorDict, TensorDictBase
+from tensordict import TensorDict, TensorDictBase, TensorDictParams
 from tensordict.nn import dispatch, TensorDictModule
 
 from tensordict.utils import NestedKey, unravel_key
 from torchrl.modules.tensordict_module.actors import ActorCriticWrapper
 from torchrl.objectives.common import LossModule
 from torchrl.objectives.utils import (
     _cache_values,
@@ -180,14 +180,21 @@
         "loss_value",
         "pred_value",
         "target_value",
         "pred_value_max",
         "target_value_max",
     ]
 
+    actor_network: TensorDictModule
+    value_network: actor_network
+    actor_network_params: TensorDictParams
+    value_network_params: TensorDictParams
+    target_actor_network_params: TensorDictParams
+    target_value_network_params: TensorDictParams
+
     def __init__(
         self,
         actor_network: TensorDictModule,
         value_network: TensorDictModule,
         *,
         loss_function: str = "l2",
         delay_actor: bool = False,
```

## torchrl/objectives/decision_transformer.py

```diff
@@ -5,16 +5,16 @@
 from __future__ import annotations
 
 import math
 from dataclasses import dataclass
 from typing import Union
 
 import torch
-from tensordict import TensorDict, TensorDictBase
-from tensordict.nn import dispatch
+from tensordict import TensorDict, TensorDictBase, TensorDictParams
+from tensordict.nn import dispatch, TensorDictModule
 from tensordict.utils import NestedKey
 
 from torch import distributions as d
 from torchrl.modules import ProbabilisticActor
 
 from torchrl.objectives.common import LossModule
 from torchrl.objectives.utils import _reduce, distance_loss
@@ -68,14 +68,18 @@
         # the "action" contained in the dataset
         action_target: NestedKey = "action"
         # the "action" output from the model
         action_pred: NestedKey = "action"
 
     default_keys = _AcceptedKeys()
 
+    actor_network: TensorDictModule
+    actor_network_params: TensorDictParams
+    target_actor_network_params: TensorDictParams
+
     def __init__(
         self,
         actor_network: ProbabilisticActor,
         *,
         alpha_init: float = 1.0,
         min_alpha: float = None,
         max_alpha: float = None,
@@ -274,14 +278,18 @@
         # the "action" contained in the dataset
         action_target: NestedKey = "action"
         # the "action" output from the model
         action_pred: NestedKey = "action"
 
     default_keys = _AcceptedKeys()
 
+    actor_network: TensorDictModule
+    actor_network_params: TensorDictParams
+    target_actor_network_params: TensorDictParams
+
     def __init__(
         self,
         actor_network: ProbabilisticActor,
         *,
         loss_function: str = "l2",
         reduction: str = None,
     ) -> None:
```

## torchrl/objectives/deprecated.py

```diff
@@ -8,15 +8,15 @@
 from dataclasses import dataclass
 from numbers import Number
 from typing import Tuple, Union
 
 import numpy as np
 import torch
 
-from tensordict import TensorDict, TensorDictBase
+from tensordict import TensorDict, TensorDictBase, TensorDictParams
 from tensordict.nn import dispatch, TensorDictModule
 from tensordict.utils import NestedKey
 from torch import Tensor
 
 from torchrl.data.tensor_specs import CompositeSpec
 from torchrl.envs.utils import ExplorationType, set_exploration_type, step_mdp
 from torchrl.objectives import default_value_kwargs, distance_loss, ValueEstimators
@@ -120,14 +120,21 @@
         done: NestedKey = "done"
         terminated: NestedKey = "terminated"
 
     default_keys = _AcceptedKeys()
     delay_actor: bool = False
     default_value_estimator = ValueEstimators.TD0
 
+    actor_network: TensorDictModule
+    qvalue_network: TensorDictModule
+    actor_network_params: TensorDictParams
+    qvalue_network_params: TensorDictParams
+    target_actor_network_params: TensorDictParams
+    target_qvalue_network_params: TensorDictParams
+
     def __init__(
         self,
         actor_network: TensorDictModule,
         qvalue_network: TensorDictModule,
         *,
         num_qvalue_nets: int = 10,
         sub_sample_len: int = 2,
@@ -448,7 +455,14 @@
         self._value_estimator.set_keys(**tensor_keys)
 
 
 class DoubleREDQLoss_deprecated(REDQLoss_deprecated):
     """[Deprecated] Class for delayed target-REDQ (which should be the default behaviour)."""
 
     delay_qvalue: bool = True
+
+    actor_network: TensorDictModule
+    qvalue_network: TensorDictModule
+    actor_network_params: TensorDictParams
+    qvalue_network_params: TensorDictParams
+    target_actor_network_params: TensorDictParams
+    target_qvalue_network_params: TensorDictParams
```

## torchrl/objectives/dqn.py

```diff
@@ -5,16 +5,16 @@
 from __future__ import annotations
 
 import warnings
 from dataclasses import dataclass
 from typing import Optional, Union
 
 import torch
-from tensordict import TensorDict, TensorDictBase
-from tensordict.nn import dispatch
+from tensordict import TensorDict, TensorDictBase, TensorDictParams
+from tensordict.nn import dispatch, TensorDictModule
 from tensordict.utils import NestedKey
 from torch import nn
 from torchrl.data.tensor_specs import TensorSpec
 
 from torchrl.data.utils import _find_action_space
 
 from torchrl.envs.utils import step_mdp
@@ -164,14 +164,18 @@
         done: NestedKey = "done"
         terminated: NestedKey = "terminated"
 
     default_keys = _AcceptedKeys()
     default_value_estimator = ValueEstimators.TD0
     out_keys = ["loss"]
 
+    value_network: TensorDictModule
+    value_network_params: TensorDictParams
+    target_value_network_params: TensorDictParams
+
     def __init__(
         self,
         value_network: Union[QValueActor, nn.Module],
         *,
         loss_function: Optional[str] = "l2",
         delay_value: bool = True,
         double_dqn: bool = False,
@@ -430,14 +434,18 @@
         done: NestedKey = "done"
         terminated: NestedKey = "terminated"
         steps_to_next_obs: NestedKey = "steps_to_next_obs"
 
     default_keys = _AcceptedKeys()
     default_value_estimator = ValueEstimators.TD0
 
+    value_network: TensorDictModule
+    value_network_params: TensorDictParams
+    target_value_network_params: TensorDictParams
+
     def __init__(
         self,
         value_network: Union[DistributionalQValueActor, nn.Module],
         *,
         gamma: float,
         delay_value: bool = True,
         priority_key: str = None,
```

## torchrl/objectives/iql.py

```diff
@@ -5,15 +5,15 @@
 from __future__ import annotations
 
 import warnings
 from dataclasses import dataclass
 from typing import Optional, Tuple, Union
 
 import torch
-from tensordict import TensorDict, TensorDictBase
+from tensordict import TensorDict, TensorDictBase, TensorDictParams
 from tensordict.nn import dispatch, TensorDictModule
 from tensordict.utils import NestedKey
 from torch import Tensor
 from torchrl.data.tensor_specs import TensorSpec
 from torchrl.data.utils import _find_action_space
 
 from torchrl.modules import ProbabilisticActor
@@ -230,14 +230,24 @@
     out_keys = [
         "loss_actor",
         "loss_qvalue",
         "loss_value",
         "entropy",
     ]
 
+    actor_network: TensorDictModule
+    actor_network_params: TensorDictParams
+    target_actor_network_params: TensorDictParams
+    qvalue_network: TensorDictModule
+    qvalue_network_params: TensorDictParams
+    target_qvalue_network_params: TensorDictParams
+    value_network: TensorDictModule | None
+    value_network_params: TensorDictParams | None
+    target_value_network_params: TensorDictParams | None
+
     def __init__(
         self,
         actor_network: ProbabilisticActor,
         qvalue_network: TensorDictModule,
         value_network: Optional[TensorDictModule],
         *,
         num_qvalue_nets: int = 2,
@@ -702,14 +712,24 @@
     out_keys = [
         "loss_actor",
         "loss_qvalue",
         "loss_value",
         "entropy",
     ]
 
+    actor_network: TensorDictModule
+    actor_network_params: TensorDictParams
+    target_actor_network_params: TensorDictParams
+    qvalue_network: TensorDictModule
+    qvalue_network_params: TensorDictParams
+    target_qvalue_network_params: TensorDictParams
+    value_network: TensorDictModule | None
+    value_network_params: TensorDictParams | None
+    target_value_network_params: TensorDictParams | None
+
     def __init__(
         self,
         actor_network: ProbabilisticActor,
         qvalue_network: TensorDictModule,
         value_network: Optional[TensorDictModule],
         *,
         action_space: Union[str, TensorSpec] = None,
```

## torchrl/objectives/ppo.py

```diff
@@ -8,15 +8,15 @@
 
 import math
 from copy import deepcopy
 from dataclasses import dataclass
 from typing import Tuple
 
 import torch
-from tensordict import TensorDict, TensorDictBase
+from tensordict import TensorDict, TensorDictBase, TensorDictParams
 from tensordict.nn import (
     dispatch,
     ProbabilisticTensorDictModule,
     ProbabilisticTensorDictSequential,
     TensorDictModule,
 )
 from tensordict.utils import NestedKey
@@ -276,14 +276,21 @@
         reward: NestedKey = "reward"
         done: NestedKey = "done"
         terminated: NestedKey = "terminated"
 
     default_keys = _AcceptedKeys()
     default_value_estimator = ValueEstimators.GAE
 
+    actor_network: TensorDictModule
+    critic_network: TensorDictModule
+    actor_network_params: TensorDictParams
+    critic_network_params: TensorDictParams
+    target_actor_network_params: TensorDictParams
+    target_critic_network_params: TensorDictParams
+
     def __init__(
         self,
         actor_network: ProbabilisticTensorDictSequential | None = None,
         critic_network: TensorDictModule | None = None,
         *,
         entropy_bonus: bool = True,
         samples_mc_entropy: int = 1,
@@ -713,14 +720,21 @@
         >>> # second option, with a single call to the common module
         >>> loss_module = PPOLoss(ProbabilisticTensorDictSequential(model, actor_head), value_head)
 
       This will work regardless of whether separate_losses is activated or not.
 
     """
 
+    actor_network: TensorDictModule
+    critic_network: TensorDictModule
+    actor_network_params: TensorDictParams
+    critic_network_params: TensorDictParams
+    target_actor_network_params: TensorDictParams
+    target_critic_network_params: TensorDictParams
+
     def __init__(
         self,
         actor_network: ProbabilisticTensorDictSequential | None = None,
         critic_network: TensorDictModule | None = None,
         *,
         clip_epsilon: float = 0.2,
         entropy_bonus: bool = True,
@@ -942,14 +956,21 @@
         >>> # second option, with a single call to the common module
         >>> loss_module = PPOLoss(ProbabilisticTensorDictSequential(model, actor_head), value_head)
 
       This will work regardless of whether separate_losses is activated or not.
 
     """
 
+    actor_network: TensorDictModule
+    critic_network: TensorDictModule
+    actor_network_params: TensorDictParams
+    critic_network_params: TensorDictParams
+    target_actor_network_params: TensorDictParams
+    target_critic_network_params: TensorDictParams
+
     def __init__(
         self,
         actor_network: ProbabilisticTensorDictSequential | None = None,
         critic_network: TensorDictModule | None = None,
         *,
         dtarg: float = 0.01,
         beta: float = 1.0,
```

## torchrl/objectives/redq.py

```diff
@@ -6,15 +6,15 @@
 
 import math
 from dataclasses import dataclass
 from numbers import Number
 from typing import Union
 
 import torch
-from tensordict import TensorDict, TensorDictBase
+from tensordict import TensorDict, TensorDictBase, TensorDictParams
 
 from tensordict.nn import dispatch, TensorDictModule, TensorDictSequential
 from tensordict.utils import NestedKey
 from torch import Tensor
 
 from torchrl.data.tensor_specs import CompositeSpec
 from torchrl.envs.utils import ExplorationType, set_exploration_type, step_mdp
@@ -236,14 +236,21 @@
         "entropy",
         "state_action_value_actor",
         "action_log_prob_actor",
         "next.state_value",
         "target_value",
     ]
 
+    actor_network: TensorDictModule
+    qvalue_network: TensorDictModule
+    actor_network_params: TensorDictParams
+    qvalue_network_params: TensorDictParams
+    target_actor_network_params: TensorDictParams
+    target_qvalue_network_params: TensorDictParams
+
     def __init__(
         self,
         actor_network: TensorDictModule,
         qvalue_network: TensorDictModule,
         *,
         num_qvalue_nets: int = 10,
         sub_sample_len: int = 2,
```

## torchrl/objectives/reinforce.py

```diff
@@ -5,15 +5,15 @@
 from __future__ import annotations
 
 import contextlib
 from copy import deepcopy
 from dataclasses import dataclass
 
 import torch
-from tensordict import TensorDict, TensorDictBase
+from tensordict import TensorDict, TensorDictBase, TensorDictParams
 
 from tensordict.nn import dispatch, ProbabilisticTensorDictSequential, TensorDictModule
 from tensordict.utils import NestedKey
 from torchrl.objectives.common import LossModule
 
 from torchrl.objectives.utils import (
     _clip_value_loss,
@@ -211,14 +211,21 @@
         done: NestedKey = "done"
         terminated: NestedKey = "terminated"
 
     default_keys = _AcceptedKeys()
     default_value_estimator = ValueEstimators.GAE
     out_keys = ["loss_actor", "loss_value"]
 
+    actor_network: TensorDictModule
+    critic_network: TensorDictModule
+    actor_network_params: TensorDictParams
+    critic_network_params: TensorDictParams
+    target_actor_network_params: TensorDictParams
+    target_critic_network_params: TensorDictParams
+
     @classmethod
     def __new__(cls, *args, **kwargs):
         cls._tensor_keys = cls._AcceptedKeys()
         return super().__new__(cls)
 
     def __init__(
         self,
```

## torchrl/objectives/sac.py

```diff
@@ -9,15 +9,15 @@
 from dataclasses import dataclass
 from functools import wraps
 from numbers import Number
 from typing import Dict, Optional, Tuple, Union
 
 import numpy as np
 import torch
-from tensordict import TensorDict, TensorDictBase
+from tensordict import TensorDict, TensorDictBase, TensorDictParams
 
 from tensordict.nn import dispatch, TensorDictModule
 from tensordict.utils import NestedKey
 from torch import Tensor
 from torchrl.data.tensor_specs import CompositeSpec, TensorSpec
 from torchrl.data.utils import _find_action_space
 from torchrl.envs.utils import ExplorationType, set_exploration_type
@@ -263,14 +263,24 @@
         reward: NestedKey = "reward"
         done: NestedKey = "done"
         terminated: NestedKey = "terminated"
 
     default_keys = _AcceptedKeys()
     default_value_estimator = ValueEstimators.TD0
 
+    actor_network: TensorDictModule
+    qvalue_network: TensorDictModule
+    value_network: TensorDictModule | None
+    actor_network_params: TensorDictParams
+    qvalue_network_params: TensorDictParams
+    value_network_params: TensorDictParams | None
+    target_actor_network_params: TensorDictParams
+    target_qvalue_network_params: TensorDictParams
+    target_value_network_params: TensorDictParams | None
+
     def __init__(
         self,
         actor_network: ProbabilisticActor,
         qvalue_network: TensorDictModule,
         value_network: Optional[TensorDictModule] = None,
         *,
         num_qvalue_nets: int = 2,
@@ -798,15 +808,15 @@
         action_space (str or TensorSpec): Action space. Must be one of
             ``"one-hot"``, ``"mult_one_hot"``, ``"binary"`` or ``"categorical"``,
             or an instance of the corresponding specs (:class:`torchrl.data.OneHotDiscreteTensorSpec`,
             :class:`torchrl.data.MultiOneHotDiscreteTensorSpec`,
             :class:`torchrl.data.BinaryDiscreteTensorSpec` or :class:`torchrl.data.DiscreteTensorSpec`).
         num_actions (int, optional): number of actions in the action space.
             To be provided if target_entropy is set to "auto".
-        num_qvalue_nets (int, optional): Number of Q-value networks to be trained. Default is 10.
+        num_qvalue_nets (int, optional): Number of Q-value networks to be trained. Default is 2.
         loss_function (str, optional): loss function to be used for the Q-value. Can be one of `"smooth_l1"`, "l2",
             "l1", Default is "smooth_l1".
         alpha_init (float, optional): initial entropy multiplier.
             Default is 1.0.
         min_alpha (float, optional): min value of alpha.
             Default is None (no minimum value).
         max_alpha (float, optional): max value of alpha.
@@ -970,14 +980,24 @@
         "loss_actor",
         "loss_qvalue",
         "loss_alpha",
         "alpha",
         "entropy",
     ]
 
+    actor_network: TensorDictModule
+    qvalue_network: TensorDictModule
+    value_network: TensorDictModule | None
+    actor_network_params: TensorDictParams
+    qvalue_network_params: TensorDictParams
+    value_network_params: TensorDictParams | None
+    target_actor_network_params: TensorDictParams
+    target_qvalue_network_params: TensorDictParams
+    target_value_network_params: TensorDictParams | None
+
     def __init__(
         self,
         actor_network: ProbabilisticActor,
         qvalue_network: TensorDictModule,
         *,
         action_space: Union[str, TensorSpec] = None,
         num_actions: Optional[int] = None,
```

## torchrl/objectives/td3.py

```diff
@@ -5,15 +5,15 @@
 from __future__ import annotations
 
 from dataclasses import dataclass
 from typing import Optional, Tuple
 
 import torch
 
-from tensordict import TensorDict, TensorDictBase
+from tensordict import TensorDict, TensorDictBase, TensorDictParams
 from tensordict.nn import dispatch, TensorDictModule
 from tensordict.utils import NestedKey
 from torchrl.data.tensor_specs import BoundedTensorSpec, CompositeSpec, TensorSpec
 
 from torchrl.envs.utils import step_mdp
 from torchrl.objectives.common import LossModule
 
@@ -204,14 +204,21 @@
         "loss_qvalue",
         "pred_value",
         "state_action_value_actor",
         "next_state_value",
         "target_value",
     ]
 
+    actor_network: TensorDictModule
+    qvalue_network: TensorDictModule
+    actor_network_params: TensorDictParams
+    qvalue_network_params: TensorDictParams
+    target_actor_network_params: TensorDictParams
+    target_qvalue_network_params: TensorDictParams
+
     def __init__(
         self,
         actor_network: TensorDictModule,
         qvalue_network: TensorDictModule,
         *,
         action_spec: TensorSpec = None,
         bounds: Optional[Tuple[float]] = None,
```

## torchrl/objectives/multiagent/qmixer.py

```diff
@@ -7,15 +7,15 @@
 
 import warnings
 from copy import deepcopy
 from dataclasses import dataclass
 from typing import Optional, Union
 
 import torch
-from tensordict import TensorDict, TensorDictBase
+from tensordict import TensorDict, TensorDictBase, TensorDictParams
 from tensordict.nn import dispatch, TensorDictModule
 from tensordict.utils import NestedKey
 from torch import nn
 
 from torchrl.data.tensor_specs import TensorSpec
 
 from torchrl.data.utils import _find_action_space
@@ -179,14 +179,21 @@
         done: NestedKey = "done"
         terminated: NestedKey = "terminated"
 
     default_keys = _AcceptedKeys()
     default_value_estimator = ValueEstimators.TD0
     out_keys = ["loss"]
 
+    local_value_network: TensorDictModule
+    local_value_network_params: TensorDictParams
+    target_local_value_network_params: TensorDictParams
+    mixer_network: TensorDictModule
+    mixer_network_params: TensorDictParams
+    target_mixer_network_params: TensorDictParams
+
     def __init__(
         self,
         local_value_network: Union[QValueActor, nn.Module],
         mixer_network: Union[TensorDictModule, nn.Module],
         *,
         loss_function: Optional[str] = "l2",
         delay_value: bool = True,
```

## torchrl/record/loggers/mlflow.py

```diff
@@ -50,15 +50,21 @@
         """Creates an mlflow experiment.
 
         Returns:
             mlflow.ActiveRun: The mlflow experiment object.
         """
         if not _has_mlflow:
             raise ImportError("MLFlow is not installed")
-        self.id = mlflow.create_experiment(**self._mlflow_kwargs)
+
+        # Only create experiment if it doesnt exist
+        experiment = mlflow.get_experiment_by_name(self._mlflow_kwargs["name"])
+        if experiment is None:
+            self.id = mlflow.create_experiment(**self._mlflow_kwargs)
+        else:
+            self.id = experiment.experiment_id
         return mlflow.start_run(experiment_id=self.id)
 
     def log_scalar(self, name: str, value: float, step: Optional[int] = None) -> None:
         """Logs a scalar value to mlflow.
 
         Args:
             name (str): The name of the scalar.
```

## Comparing `torchrl_nightly-2024.5.2.dist-info/LICENSE` & `torchrl_nightly-2024.5.3.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `torchrl_nightly-2024.5.2.dist-info/METADATA` & `torchrl_nightly-2024.5.3.dist-info/METADATA`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: torchrl-nightly
-Version: 2024.5.2
+Version: 2024.5.3
 Summary: UNKNOWN
 Home-page: https://github.com/pytorch/rl
 Author: torchrl contributors
 Author-email: vmoens@fb.com
 License: MIT
 Platform: UNKNOWN
 Classifier: Programming Language :: Python :: 3.8
```

## Comparing `torchrl_nightly-2024.5.2.dist-info/RECORD` & `torchrl_nightly-2024.5.3.dist-info/RECORD`

 * *Files 4% similar despite different names*

```diff
@@ -1,15 +1,15 @@
 build_tools/__init__.py,sha256=5xRGSM4YMr794wxfVj_SQly2cyHNyhXTdXdWUZJoM2M,183
 build_tools/setup_helpers/__init__.py,sha256=uwhUMyZq6dm1J5T_rjItc0aZb8-WSJFYd81pU3aJQsE,245
 build_tools/setup_helpers/extension.py,sha256=8u0VrdMo3WzXp1V9KrB_tq2EfkGkWncQ6G8yzW8gcyo,6085
 torchrl/__init__.py,sha256=Oqfb3ofEysouMJgCXiRDO8O8lXmSx8WnUGeHuGOFLEk,1452
 torchrl/_extension.py,sha256=WFFGPKmxcvSqa24P00NIJKP12nnNl7TRGpOQexWeb3E,1240
-torchrl/_torchrl.pyd,sha256=OpSznb9rRwKG9pj-OTvWjyh3bnhA9Jd_yB7TS2fFoLM,373760
+torchrl/_torchrl.pyd,sha256=5Icl_LyF4ismQoWx6hptYe5j2M_NVEjCM6N27LGW7Qs,373760
 torchrl/_utils.py,sha256=Lb2Z7yJVGZfJl7P_6UHVcjgwxI7dEAlbcHzadMZBENY,26867
-torchrl/version.py,sha256=eWNV7fwNnzfCnS8Vaco81oRzZhbQPLPQC70pXIcukUk,84
+torchrl/version.py,sha256=O8wB4M3LFjUFYZYMnvJCsQy_4IHTpNAEpnPH4DlY8a8,84
 torchrl/collectors/__init__.py,sha256=goQsshbO1p0ecv1SFwyNuiKrIjmzZxCYFW0UFL_ybSI,394
 torchrl/collectors/collectors.py,sha256=twOr2KJqi3vs7xp8d2MC3CJvOdlFnPjVD3QOKM4-lLM,134396
 torchrl/collectors/utils.py,sha256=CE-eM-iI0eP8dHkOBK00HvEyWuF4kRnNu70J6TMUTjI,8610
 torchrl/collectors/distributed/__init__.py,sha256=5qoBlS2wvrEFc9SRGwNMDcvCJ_XukVLyyvX7MwN9slU,412
 torchrl/collectors/distributed/default_configs.py,sha256=RkY8hmAzDttCXAjfoqdvAsCSwaXdtN4AGWJ70hSUmic,674
 torchrl/collectors/distributed/generic.py,sha256=kfu8AN1pUHNnCJxn5LT9xr8wXbOTavVn1YD3mZIxQoU,40438
 torchrl/collectors/distributed/ray.py,sha256=np6BA5QUFgI8Zsnefh2iH4wbMaKVXvKML43ZwMlAwww,33423
@@ -44,23 +44,23 @@
 torchrl/data/rlhf/prompt.py,sha256=8vaIb8QEjyEZI47eGNWCKPcOOGq2WdH9qPPwvfvkoUk,8617
 torchrl/data/rlhf/reward.py,sha256=3rSc7YDFNbj0Je6rtDj-8RSz2wCzwzU4qKT-2soNBbU,8668
 torchrl/data/rlhf/utils.py,sha256=-OgnD0T7PWbyNXSDunaPqFrfy2GVrXQYO_fl-mo9m6k,24134
 torchrl/envs/__init__.py,sha256=LX8Jkv5tzTJ8cbnO4O3Ht27eRivfAmWQrx8RM5RtCb0,2482
 torchrl/envs/batched_envs.py,sha256=H5IbVr-RUHnmYWF9y3w0gXsvIC0loBNSNI6_PVi4MKY,85060
 torchrl/envs/common.py,sha256=PHUCycItC5YGHtFW57BY6o2MzzeNnNkVluIdk2OFumA,134853
 torchrl/envs/env_creator.py,sha256=dM3w14pVZPE00zqZFgZAp0Z0Hn6G74qaeX8c-72EJbg,7661
-torchrl/envs/gym_like.py,sha256=NB8sLFAChHq4hDC7Y5Q6W9qx0LMM8SHyMC2rSldcJsw,21850
+torchrl/envs/gym_like.py,sha256=PgRUux5KFugGC90_qnWaE0H5RvIwyYQ8h8mUkMj6Y-g,23228
 torchrl/envs/utils.py,sha256=OdIIpFue87iBiHEGlEoA1Tyfzt6g8HumZDI9mJo_eak,68344
 torchrl/envs/vec_envs.py,sha256=dwl_s9wFRaybjFL1l6OYXu3p0qlNvWZnDppqMt5PbNw,339
 torchrl/envs/libs/__init__.py,sha256=lkasVqgsmo3f-fNmYT1Nz2ME7LOThVDUT8HzjdTLfAU,874
 torchrl/envs/libs/_gym_utils.py,sha256=I-pbJbhUg6kgKTuyMYBoPATsbdP6nXP6PQcyDbvS_Ac,10400
 torchrl/envs/libs/brax.py,sha256=-JYHn-BrmFshaBkuMxnFwlG_4TNWi3s-wuSoquwdzyw,24078
 torchrl/envs/libs/dm_control.py,sha256=rVZcio8HPgQ47jJK0scoE_oHu9rHpOEJV35hLPO2wnw,20968
 torchrl/envs/libs/envpool.py,sha256=ZoWReQEuoslEOMN588S8l239HGv5V4HLfZN3f7aYEyE,16723
-torchrl/envs/libs/gym.py,sha256=DFngbWuUDtR8695bnSmOQoxesQQPAXH7WeQbXq-eLXE,62823
+torchrl/envs/libs/gym.py,sha256=fN6T-TK2NII8-RA0bPAZrRFy3kFJ1dBM5Lp0cYQMM1M,64005
 torchrl/envs/libs/habitat.py,sha256=_7sH1VW1800-whGChi5ixwdm886_c7iwCO1FxmX7EXs,5437
 torchrl/envs/libs/isaacgym.py,sha256=bOoxcou0Tb1vosaZFPWpCiEiyhdB0wvIeBilPCSntNQ,6954
 torchrl/envs/libs/jax_utils.py,sha256=cU-M1fJUNEAXaHVLjFbxtXwukb8OVV740b2F6uOASeQ,5333
 torchrl/envs/libs/jumanji.py,sha256=ofK0MnbFTQtMkLOCwdkPis8h8ulrG3NMmYs8Su18Hro,38178
 torchrl/envs/libs/meltingpot.py,sha256=X67z_4RH1PgmhyYOvhFhywzhaller7_MY7TBlyFMzic,26778
 torchrl/envs/libs/openml.py,sha256=mrlZdadYF2CocGLHQWFC6KodQZDkknvSdyQi_Po2vk4,6019
 torchrl/envs/libs/pettingzoo.py,sha256=DClexiLo3-laatPRvjeivirSp5ocM-PPa6DXjT8Skxs,47103
@@ -73,15 +73,15 @@
 torchrl/envs/model_based/dreamer.py,sha256=oLlhoDLNq94NUANrwEWF1TW0VZPgox8ZmAJHi6Z_bTo,3487
 torchrl/envs/transforms/__init__.py,sha256=FC77waW5YJI_e7ZVX5VPYiO_Y1PHqwms7cEH566j9dY,1473
 torchrl/envs/transforms/functional.py,sha256=yyLZRk246UEUEXjdbzfLNY0tDR9O32QsoqoQ_tAxkPU,1485
 torchrl/envs/transforms/gym_transforms.py,sha256=rWcN35teiGtPrMP_Pe3nRufgF4pcO4mNp8XBCsyKdWQ,10062
 torchrl/envs/transforms/r3m.py,sha256=I6XArEwibW-7df8untO-QG6aW3yTdzUuC7tHJvHTqnw,13933
 torchrl/envs/transforms/rb_transforms.py,sha256=abe85Xr_Aoea7RdvqefxqgzHvD8YScY2824G-gtQILw,7684
 torchrl/envs/transforms/rlhf.py,sha256=mqV5p4919CDOdBSFqWKR_EZGuxTDBkeiOKjjVcnEfPw,10085
-torchrl/envs/transforms/transforms.py,sha256=_Wg1tJz6iM4bi6_94xK6bhZOszY2C3scD1kZbJuYTY0,343890
+torchrl/envs/transforms/transforms.py,sha256=eycPFmwZGyxLM2Qo-9ibpLY6QbJBPZsC_M09mVFH-xk,344561
 torchrl/envs/transforms/utils.py,sha256=xvrC9HjSXGW3mMgFgaFOtXZL_F5eR5CDb9E2XM1fsOc,2094
 torchrl/envs/transforms/vc1.py,sha256=tfmoCrZeME2oRC-G3D0560h5NAm5AsptBfUKfHLFEjY,10883
 torchrl/envs/transforms/vip.py,sha256=jIZFxWHaVkPfPrGPDN9KuR50gLr1xGbeRADh_hl9ZjY,15290
 torchrl/modules/__init__.py,sha256=_x_dM4y9IuxDntUNN2J7WNazEQZcSHtqkwovz0okZw8,1903
 torchrl/modules/distributions/__init__.py,sha256=yNx8ZiNT-tlyaspv8K7KiTBiUPuRelo2aFiWfyVyVX4,681
 torchrl/modules/distributions/continuous.py,sha256=SPo0UpKMRrycur3sPfiD7pOHZGXapuepe-4a04I6PCE,21427
 torchrl/modules/distributions/discrete.py,sha256=ZoTEqTGXUqfZCz3jeq51FBSB3vFT7Lr52nEAZeCKzSQ,17803
@@ -100,61 +100,61 @@
 torchrl/modules/planners/common.py,sha256=bAub51g0FeeT6KCpYxe6j9F10L64UQNR6xf4fPo8rr8,2451
 torchrl/modules/planners/mppi.py,sha256=1hkkD1NoAQDg-oqROHNpcuhGC3ctVg1ZP7IW-s8xp4o,11047
 torchrl/modules/tensordict_module/__init__.py,sha256=__h5ee1CTGSyP1wxius1xKuWLsg0s4uBy5k0Gu0Im5o,1056
 torchrl/modules/tensordict_module/actors.py,sha256=tB6QTVBzRXqxD2pNwlTmhCLVwU4m_TqWDhl3xtdNKqo,105738
 torchrl/modules/tensordict_module/common.py,sha256=r3Ok-rctJajS0muY1tXw50tE2p-2sq8FtPjehkf4_H0,21933
 torchrl/modules/tensordict_module/exploration.py,sha256=dUeRMK_WVKNFpR12z58JRUUoIO2z_llFFUEpdg6bxCU,30492
 torchrl/modules/tensordict_module/probabilistic.py,sha256=IQdEyQad16tapv1SHITjwU0SSfQf9bohLPQH3cbUGXs,12045
-torchrl/modules/tensordict_module/rnn.py,sha256=vRoAJWXJPkxi6OUflRT2tIBkK9jPmxlJdQ384pYDWCw,57588
+torchrl/modules/tensordict_module/rnn.py,sha256=JU73R1MZerEfcU_GDBxpi9R-yVgGu23sTTYBQyYvkj4,58835
 torchrl/modules/tensordict_module/sequence.py,sha256=xLFaYvUkMv3l7kVi36vPkYLH6vNSnsaWUZduljd0KA0,5804
 torchrl/modules/tensordict_module/world_models.py,sha256=9qlJKd1GDKeVtkTNRg9eUpx6AGzKCiABOVX40jxUnqU,1360
-torchrl/modules/utils/__init__.py,sha256=4BNnto-1pdNzaWdshwXPYd5KTfO-xsECU21N7yjXE5Q,1046
+torchrl/modules/utils/__init__.py,sha256=BcQtYu-TT7PiEHdGbS5GgcDjobqC3eQmInnmDtX7i6c,1090
 torchrl/modules/utils/mappings.py,sha256=ZurH7TLCDroHVzRTFcBajy6btc-dECLNh_pP1iM0ne4,2435
-torchrl/modules/utils/utils.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+torchrl/modules/utils/utils.py,sha256=QyppV37HKHdYJwwu4wcMk9J5vHXe6KJ7teQDnWVM5qw,2502
 torchrl/objectives/__init__.py,sha256=GHyweU9ZAryxccjnr6_Cx1dm2UQiI8vF3PUBYw1BVHk,1047
-torchrl/objectives/a2c.py,sha256=bGZEpWfr8Lx3Lb28W0tXH9l31HfJcowN8AnPl5NAlJk,24345
-torchrl/objectives/common.py,sha256=BlIlpbuS5Yk4Pfe_V4EoZ2HcVol0cTXCgkZ8cxL6jOg,20668
-torchrl/objectives/cql.py,sha256=hGbs78z8BBe3sFY7eP63_QKIUKDwWwy4mKjJU1naTl4,53644
-torchrl/objectives/ddpg.py,sha256=5IxE4OpgyQF4iq-b8IJExIlx-mwoaYgjVgdrKMbRqw0,17227
-torchrl/objectives/decision_transformer.py,sha256=FD0vLgT5kEeGUqtEY15ZPZz6rw9jAgyl_keSyA3BejA,12662
-torchrl/objectives/deprecated.py,sha256=EVO65zRh-e8KRwHFIENV2O8y1g-0SEb_vrsKEoUAH6s,19010
-torchrl/objectives/dqn.py,sha256=HD9y_eqY4ijNLH2zjsWM3g7UPhvMxqAZRDEVTUv3apA,28303
+torchrl/objectives/a2c.py,sha256=tiDo8moTEbeIVynVQ2c17riC2S0b85wIzN5EdKsAqiA,24632
+torchrl/objectives/common.py,sha256=pXMmisOo1wpk-vPWCzEP0-UA9B1Bn3morwl_LTItu7E,20884
+torchrl/objectives/cql.py,sha256=Dz-SG8ymPRGMaINwY8Tga713oOHQpsgmGG-KNXbnLFc,54065
+torchrl/objectives/ddpg.py,sha256=xWV6Zlp-h2AUc2RlsVhu60KcRyG2qZvsd3FZLEpV66c,17508
+torchrl/objectives/decision_transformer.py,sha256=d5Ti_VJDFffsphVjuBpoSi2uigWzqSXkejMhps3_OlU,12966
+torchrl/objectives/deprecated.py,sha256=oHqIxDqZrYH-s3V0a2B_lI0H27dyrhb8rD9FevXbBh4,19566
+torchrl/objectives/dqn.py,sha256=jqrbbUbJO3pdOMb8G2iWdUbF7dtpVTLI4ado9rQEp6E,28607
 torchrl/objectives/dreamer.py,sha256=6w2q_bU7zUTTrUGuv9IGbqklxBW1xgCOGJke_KMBbEc,18156
 torchrl/objectives/functional.py,sha256=Uw_GWTCnr5B2NPzzql1_yCtRVb8wxIJomi4kFWUE9GQ,2155
-torchrl/objectives/iql.py,sha256=D7S3AYwUb4gMw-hpJC_0hL6vRJ3K-JauVbgAwk5p-Ms,39036
-torchrl/objectives/ppo.py,sha256=HbBUE5FJwX3v6wInsZUJemXd0eAtnWPHJH0m2IZbmps,51682
-torchrl/objectives/redq.py,sha256=OJu3gW7GgqIGFMvNt45W8omCLEBDbSrhMISZ2A7KCDI,27125
-torchrl/objectives/reinforce.py,sha256=zePGieWJMlIFUCunFq15z3XFy-1p-qt9UKQeWxt8TV0,21557
-torchrl/objectives/sac.py,sha256=DzMKcGFQoitavVn4f2jmYS8lgtY4z-hEekcRNP9A6dM,56606
-torchrl/objectives/td3.py,sha256=uY9bxKURNVyEl6hS8HSzUewGncm_99q3LNzE7ik7l30,21944
+torchrl/objectives/iql.py,sha256=HikJGyseGilOX8eucd1Cc6f28J-g_uK5povmJP44GY8,39898
+torchrl/objectives/ppo.py,sha256=vZrLzzXhMcPt9X4LdaW8Et-qt4bR1bidlZVqWBMrsRg,52507
+torchrl/objectives/redq.py,sha256=_vOpr0J4dOAs3-mWQ5sM6pP28c9eU1XXtyhC8EWBkEU,27412
+torchrl/objectives/reinforce.py,sha256=qUUG6HxSIL3lNAU9mg2q_tHBYklVpQ6ImR_12Rr6mN4,21844
+torchrl/objectives/sac.py,sha256=qMvgi2RS66J_xX2ztoUNasQ_N4baE4Uy2CdpR2rqNfw,57467
+torchrl/objectives/td3.py,sha256=Xg9D_IcoQJuvgivyhuREUpO5SwhdW2hcdH9TCeBtPhY,22231
 torchrl/objectives/utils.py,sha256=U1KzyJzL1mDygZICmI6VNPW8S6UU55vMV1ZQYGHGB5g,19336
 torchrl/objectives/multiagent/__init__.py,sha256=iB837k_azDWuRJ0cx-kCJ9jDmjoYDJSjvHfXYzB0LSM,217
-torchrl/objectives/multiagent/qmixer.py,sha256=jQTOD3rTqsO2J7VlTUJKeOmjdqxePxbH93BmRHBbTZ8,17154
+torchrl/objectives/multiagent/qmixer.py,sha256=oMsS-JtqKfJTJ2vGZoYVM9GPpWzpVCt7t3pahqBlhmk,17456
 torchrl/objectives/value/__init__.py,sha256=g8J5GLmb8dTq0E4AjwiW0_TjBQV8adLbOHASsVn13KY,384
 torchrl/objectives/value/advantages.py,sha256=jyZ8aZ-00xlk_tUK3sZjlkFQnjUtkbf2JV8VltZon4s,77377
 torchrl/objectives/value/functional.py,sha256=Hj1_SrWpP8f7wLjaTUkV5mN0Con15Er5PIdcuP54ECk,50043
 torchrl/objectives/value/pg.py,sha256=fM3XbHBkiT1FTfENSF8RkkZ3ZTJOLaaXTA99E74KQlU,317
 torchrl/objectives/value/utils.py,sha256=XKyaNYGUqmbXNtuU1EzrKITbEAv3mQQ7KBfdsiy15bU,13444
 torchrl/record/__init__.py,sha256=JN-Gw_JHPZ_0e-gCH1FR5pMt8RmMMWPycHRF1xRuits,342
 torchrl/record/recorder.py,sha256=mKTBylTOhZ5aX95TsFYl-WkfWhcRfK7MOJkHbZyxIp4,22236
 torchrl/record/loggers/__init__.py,sha256=x-u4EOLJmzxhStuFkYXwrsol2MskPMM7sZoPi2OCH9U,405
 torchrl/record/loggers/common.py,sha256=spfenemZ0IYBSSoPta3EC3D46Sni9KTm2lVGRv9KDjc,1182
 torchrl/record/loggers/csv.py,sha256=6hFRDiL98O9teVCC7KT8_kbJ29mtObZJg8Uup_qhAIw,8232
-torchrl/record/loggers/mlflow.py,sha256=8wIP1BZtc2IFyMh6uJlVb7rNh7UMbNMF4Yjw_oesejs,4600
+torchrl/record/loggers/mlflow.py,sha256=wT5PaQUQfF9uv9OmqSaogz1_kB5fVl7VbH_KTOh1-zM,4835
 torchrl/record/loggers/tensorboard.py,sha256=fkiwbKZMUzbCMB2a4AlJqqIkQF21Vg2ujPHwSC1Qyv4,4944
 torchrl/record/loggers/utils.py,sha256=xl60ySAi_0EDBF1fUsaz8hvbSXtDURR_lgHUZSQtwSs,2398
 torchrl/record/loggers/wandb.py,sha256=IRe7MxpJc6V73Mmk1o28IAFmNQ5z-EVhY6QVWiQoWAI,7974
 torchrl/trainers/__init__.py,sha256=f9u3CLeSN-LpSsS709rahhHGm4G1KK2bqB2l0F7NxME,467
 torchrl/trainers/trainers.py,sha256=zhtTholjjhMIlvIZ4tkQAYsf6OY4i4dazW-RE0f0FuM,51838
 torchrl/trainers/helpers/__init__.py,sha256=BDSRgShIPar1Yy8cb2EilckElEC6bvwP2xJC5a98aCA,701
 torchrl/trainers/helpers/collectors.py,sha256=ogz7u_5BouixtF-DfTUN30AOFPNALnrjrymyxgqdyXM,19326
 torchrl/trainers/helpers/envs.py,sha256=Ee5BrAKApgfJXLySPw8Hik7yAwWJYonjCq8nhJ1bsrc,22336
 torchrl/trainers/helpers/logger.py,sha256=hLSo1MUl490z9-0GuZ2MS1WDSFqpLl1-oMGGA4Ubtgk,1275
 torchrl/trainers/helpers/losses.py,sha256=a8H2f0uarBZ2EqeOOh3LCu5SVcKf8hRVk9KNKrm5l-A,5389
 torchrl/trainers/helpers/models.py,sha256=60g7XXYmukgRzJsGr6BbzB8LPx9gSyx30pmyiFr9x9M,22664
 torchrl/trainers/helpers/replay_buffer.py,sha256=Wnmxx8TZqqb27ulRRE1opPaukrHEtsuN2f1or5uie_k,1985
 torchrl/trainers/helpers/trainers.py,sha256=bpH8SBtSUsltmHWsZiXgH5LoDIHpkBGwjhTQXhRFMrA,12385
-torchrl_nightly-2024.5.2.dist-info/LICENSE,sha256=PGO-oZsq4EzhE1-WQS2xGiEF3UCVb9YawfQ09cIMV_8,1119
-torchrl_nightly-2024.5.2.dist-info/METADATA,sha256=tW_aw9aIFQQPEDWPD92gT4rWMr1RX1pjpscDSBMQCUk,32621
-torchrl_nightly-2024.5.2.dist-info/WHEEL,sha256=Z6c-bE0pUM47a70GvqO_SvH_XXU0lm62gEAKtoNJ08A,100
-torchrl_nightly-2024.5.2.dist-info/top_level.txt,sha256=JeTJ1jV7QJwLcUS1nr21aPn_wb-XlAZ9c-z_EH472JA,20
-torchrl_nightly-2024.5.2.dist-info/RECORD,,
+torchrl_nightly-2024.5.3.dist-info/LICENSE,sha256=PGO-oZsq4EzhE1-WQS2xGiEF3UCVb9YawfQ09cIMV_8,1119
+torchrl_nightly-2024.5.3.dist-info/METADATA,sha256=HVrFbwYkoHWtJ7zah6_ibD2s-xC5gk1GF_2hRdUR22s,32621
+torchrl_nightly-2024.5.3.dist-info/WHEEL,sha256=Z6c-bE0pUM47a70GvqO_SvH_XXU0lm62gEAKtoNJ08A,100
+torchrl_nightly-2024.5.3.dist-info/top_level.txt,sha256=JeTJ1jV7QJwLcUS1nr21aPn_wb-XlAZ9c-z_EH472JA,20
+torchrl_nightly-2024.5.3.dist-info/RECORD,,
```

